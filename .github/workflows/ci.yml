name: ðŸš€ Mathakine CI/CD Pipeline

# DÃ‰SACTIVÃ‰ : Ce workflow entre en conflit avec tests.yml
# Utiliser tests.yml pour les tests automatisÃ©s
on:
  workflow_dispatch:  # Seulement manuel pour Ã©viter les conflits
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/mathakine_test

jobs:
  # ==========================================
  # ðŸ” TESTS CRITIQUES (BLOQUANTS)
  # ==========================================
  critical-tests:
    name: ðŸ”´ Tests Critiques (Bloquants)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mathakine_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-xdist pytest-json-report

    - name: ðŸ—ƒï¸ Setup database
      run: |
        python mathakine_cli.py init --force
        
    - name: Sauvegarder l'utilisateur ObiWan
      run: |
        echo "ðŸ” Sauvegarde de l'utilisateur permanent ObiWan..."
        python scripts/keep_obiwan_user.py save --file .obiwan_user_hash
        echo "âœ… Hash ObiWan sauvegardÃ©"
      
    - name: ExÃ©cuter les tests
      run: |
        echo "ðŸ§ª ExÃ©cution des tests..."
        python -m pytest tests/ -v --tb=short
        echo "âœ… Tests terminÃ©s"
      
    - name: Restaurer l'utilisateur ObiWan
      if: always()  # Toujours exÃ©cuter mÃªme si les tests Ã©chouent
      run: |
        echo "ðŸ”„ Restauration de l'utilisateur permanent ObiWan..."
        python scripts/keep_obiwan_user.py restore --file .obiwan_user_hash
        echo "âœ… Utilisateur ObiWan restaurÃ©"
        
    - name: VÃ©rifier l'utilisateur ObiWan
      if: always()
      run: |
        echo "ðŸ” VÃ©rification de l'utilisateur ObiWan..."
        python scripts/keep_obiwan_user.py ensure
        echo "âœ… Utilisateur ObiWan vÃ©rifiÃ©"

    - name: ðŸ”´ Run Critical Tests
      id: critical_tests
      run: |
        python -m pytest \
          tests/functional/ \
          tests/unit/test_user_service.py \
          tests/unit/test_exercise_service.py \
          tests/unit/test_logic_challenge_service.py \
          tests/unit/test_auth_service.py \
          tests/api/test_auth.py \
          tests/api/test_exercises.py \
          --maxfail=1 \
          --tb=short \
          --json-report \
          --json-report-file=critical_tests_report.json \
          -v
          
    - name: ðŸ“Š Upload Critical Test Results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: critical-tests-report
        path: critical_tests_report.json

    - name: âŒ Fail if Critical Tests Failed
      if: failure()
      run: |
        echo "ðŸš¨ Ã‰CHEC CRITIQUE : Les tests critiques ont Ã©chouÃ© !"
        echo "âŒ Le dÃ©ploiement est BLOQUÃ‰ jusqu'Ã  rÃ©solution"
        exit 1

  # ==========================================
  # ðŸŸ¡ TESTS IMPORTANTS (NON-BLOQUANTS)
  # ==========================================
  important-tests:
    name: ðŸŸ¡ Tests Importants (Non-bloquants)
    runs-on: ubuntu-latest
    needs: critical-tests
    continue-on-error: true
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mathakine_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ—ƒï¸ Setup database
      run: |
        python mathakine_cli.py init --force

    - name: ðŸŸ¡ Run Important Tests
      run: |
        python -m pytest \
          tests/integration/ \
          tests/unit/test_models.py \
          tests/unit/test_db_adapter.py \
          tests/unit/test_enhanced_server_adapter.py \
          tests/api/test_users.py \
          tests/api/test_challenges.py \
          --tb=short \
          --json-report \
          --json-report-file=important_tests_report.json \
          -v || echo "âš ï¸ Certains tests importants ont Ã©chouÃ© (non-bloquant)"

    - name: ðŸ“Š Upload Important Test Results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: important-tests-report
        path: important_tests_report.json

  # ==========================================
  # ðŸŸ¢ TESTS COMPLÃ‰MENTAIRES (INFORMATIFS)
  # ==========================================
  supplementary-tests:
    name: ðŸŸ¢ Tests ComplÃ©mentaires (Informatifs)
    runs-on: ubuntu-latest
    needs: critical-tests
    continue-on-error: true

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸŸ¢ Run Supplementary Tests
      run: |
        python -m pytest \
          tests/unit/test_cli.py \
          tests/unit/test_db_init_service.py \
          tests/unit/test_recommendation_service.py \
          --tb=short \
          --json-report \
          --json-report-file=supplementary_tests_report.json \
          -v || echo "â„¹ï¸ Certains tests complÃ©mentaires ont Ã©chouÃ© (informatif)"

    - name: ðŸ“Š Upload Supplementary Test Results
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: supplementary-tests-report
        path: supplementary_tests_report.json

  # ==========================================
  # ðŸ“Š ANALYSE DE COUVERTURE
  # ==========================================
  coverage-analysis:
    name: ðŸ“Š Analyse de Couverture
    runs-on: ubuntu-latest
    needs: critical-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mathakine_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage[toml]

    - name: ðŸ—ƒï¸ Setup database
      run: |
        python mathakine_cli.py init --force

    - name: ðŸ“Š Run Coverage Analysis
      run: |
        coverage run -m pytest tests/unit/ tests/functional/ --tb=short
        coverage report --format=markdown > coverage_report.md
        coverage html -d coverage_html

    - name: ðŸ“ˆ Upload Coverage Report
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: |
          coverage_report.md
          coverage_html/

  # ==========================================
  # ðŸ” QUALITÃ‰ DU CODE
  # ==========================================
  code-quality:
    name: ðŸ” QualitÃ© du Code
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy bandit safety

    - name: ðŸŽ¨ Check Code Formatting (Black)
      run: black --check --diff .

    - name: ðŸ“‹ Check Import Sorting (isort)
      run: isort --check-only --diff .

    - name: ðŸ” Lint Code (Flake8)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: ðŸ”’ Security Check (Bandit)
      run: bandit -r app/ -f json -o bandit_report.json || true

    - name: ðŸ›¡ï¸ Dependency Security (Safety)
      run: safety check --json --output safety_report.json || true

    - name: ðŸ“Š Upload Quality Reports
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: quality-reports
        path: |
          bandit_report.json
          safety_report.json

  # ==========================================
  # ðŸ“‹ RAPPORT FINAL
  # ==========================================
  final-report:
    name: ðŸ“‹ Rapport Final
    runs-on: ubuntu-latest
    needs: [critical-tests, important-tests, supplementary-tests, coverage-analysis, code-quality]
    if: always()

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v6

    - name: ðŸ“Š Download All Reports
      uses: actions/download-artifact@v7

    - name: ðŸ“‹ Generate Final Report
      run: |
        echo "# ðŸš€ Rapport CI/CD Mathakine" > final_report.md
        echo "" >> final_report.md
        echo "## ðŸ“Š RÃ©sumÃ© des Tests" >> final_report.md
        echo "" >> final_report.md
        
        if [ -f critical-tests-report/critical_tests_report.json ]; then
          echo "### ðŸ”´ Tests Critiques" >> final_report.md
          echo "âœ… **PASSÃ‰S** - DÃ©ploiement autorisÃ©" >> final_report.md
        else
          echo "### ðŸ”´ Tests Critiques" >> final_report.md
          echo "âŒ **Ã‰CHEC** - DÃ©ploiement bloquÃ©" >> final_report.md
        fi
        
        echo "" >> final_report.md
        echo "### ðŸŸ¡ Tests Importants" >> final_report.md
        echo "â„¹ï¸ Voir rapport dÃ©taillÃ©" >> final_report.md
        echo "" >> final_report.md
        echo "### ðŸŸ¢ Tests ComplÃ©mentaires" >> final_report.md
        echo "â„¹ï¸ Voir rapport dÃ©taillÃ©" >> final_report.md
        echo "" >> final_report.md
        
        echo "## ðŸ“ˆ Couverture de Code" >> final_report.md
        if [ -f coverage-report/coverage_report.md ]; then
          cat coverage-report/coverage_report.md >> final_report.md
        fi

    - name: ðŸ“¤ Upload Final Report
      uses: actions/upload-artifact@v6
      with:
        name: final-ci-report
        path: final_report.md

    - name: ðŸ’¬ Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('final_report.md')) {
            const report = fs.readFileSync('final_report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } 