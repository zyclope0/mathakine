2026-02-20T22:09:09.9542550Z ##[group]Run black app/ server/ --check --diff
2026-02-20T22:09:09.9542912Z [36;1mblack app/ server/ --check --diff[0m
2026-02-20T22:09:09.9575207Z shell: /usr/bin/bash -e {0}
2026-02-20T22:09:09.9575439Z env:
2026-02-20T22:09:09.9575674Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9576081Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib/pkgconfig
2026-02-20T22:09:09.9576489Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9576838Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9577196Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9577555Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib
2026-02-20T22:09:09.9577847Z ##[endgroup]
2026-02-20T22:09:10.6581325Z --- /home/runner/work/mathakine/mathakine/app/core/logging_config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.6586642Z +++ /home/runner/work/mathakine/mathakine/app/core/logging_config.py	2026-02-20 22:09:10.655743+00:00
2026-02-20T22:09:10.6591285Z @@ -27,11 +27,10 @@
2026-02-20T22:09:10.6595391Z  }
2026-02-20T22:09:10.6596920Z  
2026-02-20T22:09:10.6600518Z  # Format des logs
2026-02-20T22:09:10.6601632Z  LOG_FORMAT = "<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{line}</cyan>\
2026-02-20T22:09:10.6603457Z      - <level>{message}</level>"
2026-02-20T22:09:10.6627042Z would reformat /home/runner/work/mathakine/mathakine/app/core/logging_config.py
2026-02-20T22:09:10.6627766Z -
2026-02-20T22:09:10.6628668Z  
2026-02-20T22:09:10.6628977Z  
2026-02-20T22:09:10.6629400Z  def configure_logging(remove_existing_handlers=True):
2026-02-20T22:09:10.6630156Z      """
2026-02-20T22:09:10.6630592Z      Configure la journalisation pour l'application.
2026-02-20T22:09:10.6631131Z @@ -93,10 +92,11 @@
2026-02-20T22:09:10.6631447Z          )
2026-02-20T22:09:10.6631719Z  
2026-02-20T22:09:10.6632448Z      logger.info("Journalisation configurée avec succès")
2026-02-20T22:09:10.6633322Z      logger.debug(f"Dossier des logs: {LOGS_DIR}")
2026-02-20T22:09:10.6633806Z  
2026-02-20T22:09:10.6634073Z +
2026-02-20T22:09:10.6634486Z  # Configuration automatique lors de l'importation du module
2026-02-20T22:09:10.6635063Z  configure_logging()
2026-02-20T22:09:10.6635398Z  
2026-02-20T22:09:10.6635867Z  # Fonction d'assistance pour obtenir un logger nommé
2026-02-20T22:09:10.6636377Z  
2026-02-20T22:09:10.7418734Z --- /home/runner/work/mathakine/mathakine/app/core/config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.7419882Z +++ /home/runner/work/mathakine/mathakine/app/core/config.py	2026-02-20 22:09:10.738085+00:00
2026-02-20T22:09:10.7420751Z @@ -17,139 +17,162 @@
2026-02-20T22:09:10.7421146Z  if os.getenv("ENVIRONMENT") != "production":
2026-02-20T22:09:10.7421639Z      load_dotenv(override=False)
2026-02-20T22:09:10.7422116Z  logger.info("Chargement de la configuration...")
2026-02-20T22:09:10.7422602Z  
2026-02-20T22:09:10.7423322Z  # Base de données
2026-02-20T22:09:10.7431738Z -DATABASE_URL = os.getenv("DATABASE_URL", "***localhost/mathakine")
2026-02-20T22:09:10.7432465Z +DATABASE_URL = os.getenv(
2026-02-20T22:09:10.7433503Z +    "DATABASE_URL", "***localhost/mathakine"
2026-02-20T22:09:10.7433994Z +)
2026-02-20T22:09:10.7434254Z  
2026-02-20T22:09:10.7434927Z  # Fichier temporaire supprimé, utilisation exclusive de PostgreSQL
2026-02-20T22:09:10.7435885Z  # SQLALCHEMY_DATABASE_URL = DATABASE_URL if "test" not in DATABASE_URL else DATABASE_URL
2026-02-20T22:09:10.7436655Z  
2026-02-20T22:09:10.7437139Z  # Pour les tests, utiliser une URL spécifique
2026-02-20T22:09:10.7438309Z -TEST_DATABASE_URL = os.getenv("TEST_DATABASE_URL", "***localhost/test_mathakine")
2026-02-20T22:09:10.7439410Z +TEST_DATABASE_URL = os.getenv(
2026-02-20T22:09:10.7440219Z +    "TEST_DATABASE_URL", "***localhost/test_mathakine"
2026-02-20T22:09:10.7440742Z +)
2026-02-20T22:09:10.7441013Z +
2026-02-20T22:09:10.7441266Z  
2026-02-20T22:09:10.7441559Z  # Classe de configuration
2026-02-20T22:09:10.7442303Z  class Settings:
2026-02-20T22:09:10.7442611Z      """
2026-02-20T22:09:10.7443466Z      Classe contenant les paramètres de configuration de l'application.
2026-02-20T22:09:10.7444090Z      """
2026-02-20T22:09:10.7444341Z +
2026-02-20T22:09:10.7444635Z      PROJECT_NAME: str = "Mathakine"
2026-02-20T22:09:10.7445067Z      PROJECT_VERSION: str = "1.5.0"
2026-02-20T22:09:10.7445459Z -    
2026-02-20T22:09:10.7445707Z +
2026-02-20T22:09:10.7445968Z      API_V1_STR: str = "/api"
2026-02-20T22:09:10.7446595Z would reformat /home/runner/work/mathakine/mathakine/app/core/config.py
2026-02-20T22:09:10.7447271Z      SECRET_KEY: str = os.getenv("SECRET_KEY", "")
2026-02-20T22:09:10.7447745Z      if not SECRET_KEY:
2026-02-20T22:09:10.7448061Z          if (
2026-02-20T22:09:10.7448396Z              os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7449030Z              and os.getenv("TESTING", "false").lower() != "true"
2026-02-20T22:09:10.7449512Z          ):
2026-02-20T22:09:10.7449801Z              raise ValueError(
2026-02-20T22:09:10.7450370Z                  "SECRET_KEY doit être définie en production. "
2026-02-20T22:09:10.7451255Z -                "Générer avec: python -c \"import secrets; print(secrets.token_urlsafe(32))\""
2026-02-20T22:09:10.7452305Z +                'Générer avec: python -c "import secrets; print(secrets.token_urlsafe(32))"'
2026-02-20T22:09:10.7452956Z              )
2026-02-20T22:09:10.7468755Z          SECRET_KEY = secrets.token_urlsafe(32)
2026-02-20T22:09:10.7469681Z -        logger.warning("SECRET_KEY non définie, génération automatique (DEV uniquement)")
2026-02-20T22:09:10.7470401Z -    
2026-02-20T22:09:10.7470708Z +        logger.warning(
2026-02-20T22:09:10.7471396Z +            "SECRET_KEY non définie, génération automatique (DEV uniquement)"
2026-02-20T22:09:10.7471997Z +        )
2026-02-20T22:09:10.7472260Z +
2026-02-20T22:09:10.7472837Z      # 15 minutes (best-practice: court pour limiter la fenêtre si volé)
2026-02-20T22:09:10.7473808Z      # Le refresh automatique prolonge la session sans re-login
2026-02-20T22:09:10.7474401Z      ACCESS_TOKEN_EXPIRE_MINUTES: int = 15
2026-02-20T22:09:10.7475275Z      # 7 jours (best-practice: refresh token plus long mais rotation à chaque utilisation)
2026-02-20T22:09:10.7476038Z      REFRESH_TOKEN_EXPIRE_DAYS: int = 7
2026-02-20T22:09:10.7476512Z      # Algorithme de chiffrement pour JWT
2026-02-20T22:09:10.7476961Z      ALGORITHM: str = "HS256"
2026-02-20T22:09:10.7477324Z -    
2026-02-20T22:09:10.7477582Z +
2026-02-20T22:09:10.7477982Z      # Configuration de la base de données
2026-02-20T22:09:10.7478581Z      POSTGRES_SERVER: str = os.getenv("POSTGRES_SERVER", "localhost")
2026-02-20T22:09:10.7479355Z      POSTGRES_USER: str = os.getenv("POSTGRES_USER", "postgres")
2026-02-20T22:09:10.7480121Z      POSTGRES_PASSWORD: str = os.getenv("POSTGRES_PASSWORD", "postgres")
2026-02-20T22:09:10.7480911Z      POSTGRES_DB: str = os.getenv("POSTGRES_DB", "mathakine")
2026-02-20T22:09:10.7482016Z -    DATABASE_URL: str = os.getenv("DATABASE_URL", f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@{POSTGRES_SERVER}/{POSTGRES_DB}")
2026-02-20T22:09:10.7483186Z -    
2026-02-20T22:09:10.7483490Z +    DATABASE_URL: str = os.getenv(
2026-02-20T22:09:10.7483906Z +        "DATABASE_URL",
2026-02-20T22:09:10.7484540Z +        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@{POSTGRES_SERVER}/{POSTGRES_DB}",
2026-02-20T22:09:10.7485264Z +    )
2026-02-20T22:09:10.7485519Z +
2026-02-20T22:09:10.7485796Z      # URL pour les tests
2026-02-20T22:09:10.7486766Z -    TEST_DATABASE_URL: str = os.getenv("TEST_DATABASE_URL", "***localhost/test_mathakine")
2026-02-20T22:09:10.7487752Z -    
2026-02-20T22:09:10.7488060Z +    TEST_DATABASE_URL: str = os.getenv(
2026-02-20T22:09:10.7488856Z +        "TEST_DATABASE_URL", "***localhost/test_mathakine"
2026-02-20T22:09:10.7489366Z +    )
2026-02-20T22:09:10.7489642Z +
2026-02-20T22:09:10.7489906Z      # Mode de test
2026-02-20T22:09:10.7490378Z      TESTING: bool = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:10.7491177Z -    
2026-02-20T22:09:10.7491440Z +
2026-02-20T22:09:10.7491731Z      # Utilisez cette URL pour les tests
2026-02-20T22:09:10.7492399Z      SQLALCHEMY_DATABASE_URL: str = TEST_DATABASE_URL if TESTING else DATABASE_URL
2026-02-20T22:09:10.7493245Z -    
2026-02-20T22:09:10.7493513Z +
2026-02-20T22:09:10.7493902Z      # Utilisateurs par défaut
2026-02-20T22:09:10.7494544Z      DEFAULT_ADMIN_EMAIL: str = os.getenv("DEFAULT_ADMIN_EMAIL", "admin@mathakine.com")
2026-02-20T22:09:10.7495448Z      DEFAULT_ADMIN_PASSWORD: str = os.getenv("DEFAULT_ADMIN_PASSWORD", "admin")
2026-02-20T22:09:10.7496084Z -    
2026-02-20T22:09:10.7496361Z +
2026-02-20T22:09:10.7496695Z      # Paramètres CORS
2026-02-20T22:09:10.7497061Z      BACKEND_CORS_ORIGINS: List[str] = [
2026-02-20T22:09:10.7497522Z          "http://localhost:8000",
2026-02-20T22:09:10.7497957Z          "http://localhost:3000",
2026-02-20T22:09:10.7498374Z          "http://localhost:5173",
2026-02-20T22:09:10.7498795Z          "http://127.0.0.1:8000",
2026-02-20T22:09:10.7499183Z          "http://127.0.0.1:3000",
2026-02-20T22:09:10.7499577Z          "http://127.0.0.1:5173",
2026-02-20T22:09:10.7499977Z          os.getenv("FRONTEND_URL", ""),
2026-02-20T22:09:10.7500380Z      ]
2026-02-20T22:09:10.7500636Z -    
2026-02-20T22:09:10.7500883Z +
2026-02-20T22:09:10.7501162Z      # Configuration de logging
2026-02-20T22:09:10.7501611Z      LOG_LEVEL: str = os.getenv("LOG_LEVEL", "INFO")
2026-02-20T22:09:10.7502222Z      LOG_FILE: str = os.getenv("LOG_FILE", "logs/mathakine.log")
2026-02-20T22:09:10.7502937Z      LOG_FORMAT: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
2026-02-20T22:09:10.7503709Z -    
2026-02-20T22:09:10.7503962Z +
2026-02-20T22:09:10.7504251Z      # Nombre d'exercices par page
2026-02-20T22:09:10.7504670Z      EXERCISES_PER_PAGE: int = 10
2026-02-20T22:09:10.7505054Z -    
2026-02-20T22:09:10.7505310Z +
2026-02-20T22:09:10.7505744Z      # Nombre d'exercices générés automatiquement
2026-02-20T22:09:10.7506266Z      AUTO_GENERATE_EXERCISES: int = 50
2026-02-20T22:09:10.7506667Z -    
2026-02-20T22:09:10.7506926Z +
2026-02-20T22:09:10.7507329Z      # Pourcentage d'exercices générés par IA
2026-02-20T22:09:10.7507813Z      AI_GENERATED_PERCENT: int = 20
2026-02-20T22:09:10.7508193Z -    
2026-02-20T22:09:10.7508451Z +
2026-02-20T22:09:10.7508774Z      # Configuration d'optimisation performance
2026-02-20T22:09:10.7509505Z      ENABLE_QUERY_CACHE: bool = os.getenv("ENABLE_QUERY_CACHE", "true").lower() == "true"
2026-02-20T22:09:10.7510420Z      CACHE_TTL_SECONDS: int = int(os.getenv("CACHE_TTL_SECONDS", "300"))  # 5 minutes
2026-02-20T22:09:10.7511295Z      MAX_CONNECTIONS_POOL: int = int(os.getenv("MAX_CONNECTIONS_POOL", "20"))
2026-02-20T22:09:10.7512187Z -    POOL_RECYCLE_SECONDS: int = int(os.getenv("POOL_RECYCLE_SECONDS", "3600"))  # 1 heure
2026-02-20T22:09:10.7512864Z -    
2026-02-20T22:09:10.7513357Z +    POOL_RECYCLE_SECONDS: int = int(
2026-02-20T22:09:10.7513835Z +        os.getenv("POOL_RECYCLE_SECONDS", "3600")
2026-02-20T22:09:10.7514309Z +    )  # 1 heure
2026-02-20T22:09:10.7514602Z +
2026-02-20T22:09:10.7514966Z      # Configuration sécurité
2026-02-20T22:09:10.7515534Z      RATE_LIMIT_PER_MINUTE: int = int(os.getenv("RATE_LIMIT_PER_MINUTE", "60"))
2026-02-20T22:09:10.7516382Z      MAX_CONTENT_LENGTH: int = int(os.getenv("MAX_CONTENT_LENGTH", "16777216"))  # 16MB
2026-02-20T22:09:10.7517265Z      SECURE_HEADERS: bool = os.getenv("SECURE_HEADERS", "true").lower() == "true"
2026-02-20T22:09:10.7517886Z -    
2026-02-20T22:09:10.7518144Z +
2026-02-20T22:09:10.7518420Z      # Configuration monitoring
2026-02-20T22:09:10.7519013Z      ENABLE_METRICS: bool = os.getenv("ENABLE_METRICS", "true").lower() == "true"
2026-02-20T22:09:10.7520004Z      METRICS_PORT: int = int(os.getenv("METRICS_PORT", "9090"))
2026-02-20T22:09:10.7520528Z -    
2026-02-20T22:09:10.7520787Z +
2026-02-20T22:09:10.7521061Z      # Configuration compression
2026-02-20T22:09:10.7521634Z      ENABLE_GZIP: bool = os.getenv("ENABLE_GZIP", "true").lower() == "true"
2026-02-20T22:09:10.7522645Z      GZIP_MINIMUM_SIZE: int = int(os.getenv("GZIP_MINIMUM_SIZE", "1024"))  # 1KB
2026-02-20T22:09:10.7524698Z -    
2026-02-20T22:09:10.7525596Z +
2026-02-20T22:09:10.7527958Z      # Configuration OpenAI pour génération IA
2026-02-20T22:09:10.7541777Z      OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY", "")
2026-02-20T22:09:10.7542881Z -    OPENAI_MODEL: str = os.getenv("OPENAI_MODEL", "gpt-4o-mini")  # Modèle par défaut (exercices)
2026-02-20T22:09:10.7543904Z +    OPENAI_MODEL: str = os.getenv(
2026-02-20T22:09:10.7544339Z +        "OPENAI_MODEL", "gpt-4o-mini"
2026-02-20T22:09:10.7544907Z +    )  # Modèle par défaut (exercices)
2026-02-20T22:09:10.7545628Z      # Modèle o1/o1-mini pour raisonnement mathématique - MÊME CLÉ API
2026-02-20T22:09:10.7546861Z      # Si défini : défis logiques (séquences, patterns) + exercices fractions. o1-mini = moins cher, o1 = plus capable.
2026-02-20T22:09:10.7548068Z -    OPENAI_MODEL_REASONING: str = os.getenv("OPENAI_MODEL_REASONING", "")  # ex: "o3", "o1-mini"
2026-02-20T22:09:10.7548907Z -    
2026-02-20T22:09:10.7549249Z +    OPENAI_MODEL_REASONING: str = os.getenv(
2026-02-20T22:09:10.7549726Z +        "OPENAI_MODEL_REASONING", ""
2026-02-20T22:09:10.7550157Z +    )  # ex: "o3", "o1-mini"
2026-02-20T22:09:10.7550506Z +
2026-02-20T22:09:10.7550764Z      class Config:
2026-02-20T22:09:10.7551084Z          case_sensitive = True
2026-02-20T22:09:10.7551444Z  
2026-02-20T22:09:10.7551700Z +
2026-02-20T22:09:10.7551964Z  settings = Settings()
2026-02-20T22:09:10.7552278Z +
2026-02-20T22:09:10.7552520Z  
2026-02-20T22:09:10.7553271Z  # Validation post-initialisation pour la sécurité en production
2026-02-20T22:09:10.7561565Z  def validate_production_settings():
2026-02-20T22:09:10.7562479Z      """Valide les paramètres de sécurité en production après initialisation"""
2026-02-20T22:09:10.7563414Z      is_production = (
2026-02-20T22:09:10.7563829Z -        os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:10.7564394Z -        os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:10.7564947Z -        os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:10.7565486Z +        os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:10.7565995Z +        or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7566547Z +        or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:10.7567008Z      )
2026-02-20T22:09:10.7567270Z -    
2026-02-20T22:09:10.7567525Z +
2026-02-20T22:09:10.7567796Z      if is_production:
2026-02-20T22:09:10.7568337Z          # Forcer LOG_LEVEL à INFO minimum en production
2026-02-20T22:09:10.7568897Z          if settings.LOG_LEVEL.upper() == "DEBUG":
2026-02-20T22:09:10.7569814Z -            logger.warning("LOG_LEVEL=DEBUG détecté en production - Forcé à INFO pour sécurité")
2026-02-20T22:09:10.7570554Z +            logger.warning(
2026-02-20T22:09:10.7571269Z +                "LOG_LEVEL=DEBUG détecté en production - Forcé à INFO pour sécurité"
2026-02-20T22:09:10.7571903Z +            )
2026-02-20T22:09:10.7572229Z              settings.LOG_LEVEL = "INFO"
2026-02-20T22:09:10.7572631Z -        
2026-02-20T22:09:10.7572920Z +
2026-02-20T22:09:10.7573718Z          # SECRET_KEY : blocage au démarrage si vide (voir init Settings)
2026-02-20T22:09:10.7577137Z          # 3.3 DEFAULT_ADMIN_PASSWORD : bloquer si faible en prod (évite compte admin exploitable)
2026-02-20T22:09:10.7604613Z          # Uniquement si ENVIRONMENT=production (Render), pas MATH_TRAINER_PROFILE (peut être prod en local)
2026-02-20T22:09:10.7605471Z          if (
2026-02-20T22:09:10.7605832Z              os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7606577Z @@ -162,12 +185,15 @@
2026-02-20T22:09:10.7606913Z              raise ValueError(
2026-02-20T22:09:10.7607792Z                  "DEFAULT_ADMIN_PASSWORD doit être définie et différente de 'admin' en production. "
2026-02-20T22:09:10.7608910Z                  "Définir une valeur forte dans les variables d'environnement Render."
2026-02-20T22:09:10.7609765Z              )
2026-02-20T22:09:10.7610052Z  
2026-02-20T22:09:10.7610296Z +
2026-02-20T22:09:10.7610738Z  # Valider les paramètres au chargement du module
2026-02-20T22:09:10.7611252Z  validate_production_settings()
2026-02-20T22:09:10.7611635Z  
2026-02-20T22:09:10.7611921Z  # Configuration pour les tests
2026-02-20T22:09:10.7612341Z  if settings.TESTING:
2026-02-20T22:09:10.7613535Z -    logger.info(f"Mode test détecté, utilisation de l'URL de base de données: {settings.SQLALCHEMY_DATABASE_URL}")
2026-02-20T22:09:10.7614439Z +    logger.info(
2026-02-20T22:09:10.7615284Z +        f"Mode test détecté, utilisation de l'URL de base de données: {settings.SQLALCHEMY_DATABASE_URL}"
2026-02-20T22:09:10.7616077Z +    )
2026-02-20T22:09:10.7616528Z      # Autres configurations spécifiques aux tests
2026-02-20T22:09:10.7617339Z would reformat /home/runner/work/mathakine/mathakine/app/core/ai_config.py
2026-02-20T22:09:10.7618356Z --- /home/runner/work/mathakine/mathakine/app/core/ai_config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.7619480Z +++ /home/runner/work/mathakine/mathakine/app/core/ai_config.py	2026-02-20 22:09:10.744641+00:00
2026-02-20T22:09:10.7620241Z @@ -5,10 +5,11 @@
2026-02-20T22:09:10.7620708Z  GPT-5.2 utilise de nouveaux paramètres :
2026-02-20T22:09:10.7621614Z  - reasoning.effort : none, low, medium, high, xhigh (contrôle la profondeur de raisonnement)
2026-02-20T22:09:10.7622698Z  - text.verbosity : low, medium, high (contrôle la longueur de réponse)
2026-02-20T22:09:10.7623767Z  - temperature n'est supporté QUE si reasoning.effort = none
2026-02-20T22:09:10.7624317Z  """
2026-02-20T22:09:10.7624586Z +
2026-02-20T22:09:10.7624885Z  from typing import Dict, Optional
2026-02-20T22:09:10.7625280Z  
2026-02-20T22:09:10.7625618Z  from app.core.logging_config import get_logger
2026-02-20T22:09:10.7626086Z  
2026-02-20T22:09:10.7626360Z  logger = get_logger(__name__)
2026-02-20T22:09:10.7626733Z @@ -16,104 +17,104 @@
2026-02-20T22:09:10.7627093Z  from app.core.config import settings
2026-02-20T22:09:10.7627517Z  
2026-02-20T22:09:10.7627749Z  
2026-02-20T22:09:10.7628006Z  class AIConfig:
2026-02-20T22:09:10.7628546Z      """Configuration centralisée pour la génération IA."""
2026-02-20T22:09:10.7629065Z -    
2026-02-20T22:09:10.7629328Z +
2026-02-20T22:09:10.7629941Z      # Modèle plus capable pour défis nécessitant du raisonnement logique/spatial
2026-02-20T22:09:10.7630693Z      # GPT-5.1 : bon raisonnement logique, 400K contexte
2026-02-20T22:09:10.7631420Z      # GPT-5-mini : bon rapport qualité/prix pour tâches simples
2026-02-20T22:09:10.7632286Z -    ADVANCED_MODEL: str = "gpt-5.1"      # Modèle avancé pour défis complexes
2026-02-20T22:09:10.7663585Z -    BASIC_MODEL: str = "gpt-5-mini"       # Modèle économique pour tâches simples
2026-02-20T22:09:10.7664259Z -    
2026-02-20T22:09:10.7664884Z +    ADVANCED_MODEL: str = "gpt-5.1"  # Modèle avancé pour défis complexes
2026-02-20T22:09:10.7665811Z +    BASIC_MODEL: str = "gpt-5-mini"  # Modèle économique pour tâches simples
2026-02-20T22:09:10.7666443Z +
2026-02-20T22:09:10.7666813Z      # Modèles par type de challenge
2026-02-20T22:09:10.7667373Z      # Note: SPATIAL a été fusionné dans VISUAL
2026-02-20T22:09:10.7667845Z      MODEL_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7668625Z -        'pattern': ADVANCED_MODEL,             # Patterns nécessitent raisonnement logique
2026-02-20T22:09:10.7669613Z -        'sequence': BASIC_MODEL,               # Séquences simples OK avec mini
2026-02-20T22:09:10.7670435Z -        'puzzle': BASIC_MODEL,                 # Puzzles OK avec mini + bonne validation
2026-02-20T22:09:10.7671407Z -        'graph': ADVANCED_MODEL,               # Graphes nécessitent cohérence stricte
2026-02-20T22:09:10.7672743Z -        'visual': ADVANCED_MODEL,              # Visual (inclut spatial) NÉCESSITE raisonnement avancé
2026-02-20T22:09:10.7673958Z -        'riddle': BASIC_MODEL,                 # Énigmes textuelles OK avec mini
2026-02-20T22:09:10.7674908Z -        'deduction': ADVANCED_MODEL,           # Déduction nécessite logique stricte
2026-02-20T22:09:10.7676240Z -        'coding': ADVANCED_MODEL,              # Cryptographie nécessite raisonnement pour cohérence
2026-02-20T22:09:10.7677305Z -        'chess': ADVANCED_MODEL,               # Échecs : positions tactiques complexes
2026-02-20T22:09:10.7678278Z -        'probability': BASIC_MODEL,             # Probabilités simples OK avec mini
2026-02-20T22:09:10.7678919Z -    }
2026-02-20T22:09:10.7679181Z -    
2026-02-20T22:09:10.7679790Z +        "pattern": ADVANCED_MODEL,  # Patterns nécessitent raisonnement logique
2026-02-20T22:09:10.7680665Z +        "sequence": BASIC_MODEL,  # Séquences simples OK avec mini
2026-02-20T22:09:10.7681393Z +        "puzzle": BASIC_MODEL,  # Puzzles OK avec mini + bonne validation
2026-02-20T22:09:10.7682259Z +        "graph": ADVANCED_MODEL,  # Graphes nécessitent cohérence stricte
2026-02-20T22:09:10.7683401Z +        "visual": ADVANCED_MODEL,  # Visual (inclut spatial) NÉCESSITE raisonnement avancé
2026-02-20T22:09:10.7684353Z +        "riddle": BASIC_MODEL,  # Énigmes textuelles OK avec mini
2026-02-20T22:09:10.7685181Z +        "deduction": ADVANCED_MODEL,  # Déduction nécessite logique stricte
2026-02-20T22:09:10.7686175Z +        "coding": ADVANCED_MODEL,  # Cryptographie nécessite raisonnement pour cohérence
2026-02-20T22:09:10.7687140Z +        "chess": ADVANCED_MODEL,  # Échecs : positions tactiques complexes
2026-02-20T22:09:10.7688028Z +        "probability": BASIC_MODEL,  # Probabilités simples OK avec mini
2026-02-20T22:09:10.7688612Z +    }
2026-02-20T22:09:10.7688861Z +
2026-02-20T22:09:10.7689371Z      # Reasoning Effort : contrôle la profondeur (o3, GPT-5.2)
2026-02-20T22:09:10.7690260Z      # low = rapide/économique, medium = équilibré, high = raisonnement profond
2026-02-20T22:09:10.7691196Z      # Pas de high partout : sequence/puzzle/riddle/graph/coding suffisent avec low/medium
2026-02-20T22:09:10.7691956Z      REASONING_EFFORT_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7692540Z -        'pattern': 'high',       # Patterns logiques complexes
2026-02-20T22:09:10.7723533Z -        'sequence': 'low',       # Séquences simples
2026-02-20T22:09:10.7724113Z -        'puzzle': 'low',         # Puzzles OK en low
2026-02-20T22:09:10.7724687Z -        'graph': 'medium',      # Graphes : medium suffit
2026-02-20T22:09:10.7725512Z -        'visual': 'high',       # Visual (formes/couleurs/symétrie) demande profond
2026-02-20T22:09:10.7726358Z -        'riddle': 'low',        # Énigmes textuelles simples
2026-02-20T22:09:10.7727067Z -        'deduction': 'high',    # Déduction logique stricte
2026-02-20T22:09:10.7727825Z -        'coding': 'medium',     # Cryptographie : medium pour cohérence
2026-02-20T22:09:10.7728751Z -        'chess': 'medium',      # Échecs : medium (o3 consomme beaucoup si high)
2026-02-20T22:09:10.7729568Z -        'probability': 'low',   # Probabilités : low suffit
2026-02-20T22:09:10.7730072Z -    }
2026-02-20T22:09:10.7730334Z -    
2026-02-20T22:09:10.7730715Z +        "pattern": "high",  # Patterns logiques complexes
2026-02-20T22:09:10.7731347Z +        "sequence": "low",  # Séquences simples
2026-02-20T22:09:10.7731856Z +        "puzzle": "low",  # Puzzles OK en low
2026-02-20T22:09:10.7732362Z +        "graph": "medium",  # Graphes : medium suffit
2026-02-20T22:09:10.7733304Z +        "visual": "high",  # Visual (formes/couleurs/symétrie) demande profond
2026-02-20T22:09:10.7734124Z +        "riddle": "low",  # Énigmes textuelles simples
2026-02-20T22:09:10.7734792Z +        "deduction": "high",  # Déduction logique stricte
2026-02-20T22:09:10.7735537Z +        "coding": "medium",  # Cryptographie : medium pour cohérence
2026-02-20T22:09:10.7736640Z +        "chess": "medium",  # Échecs : medium (o3 consomme beaucoup si high)
2026-02-20T22:09:10.7737446Z +        "probability": "low",  # Probabilités : low suffit
2026-02-20T22:09:10.7737948Z +    }
2026-02-20T22:09:10.7738200Z +
2026-02-20T22:09:10.7738680Z      # GPT-5.2 Verbosity : contrôle la longueur de réponse
2026-02-20T22:09:10.7739684Z      # low = concis (bon pour JSON), medium = équilibré, high = détaillé
2026-02-20T22:09:10.7740308Z      VERBOSITY_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7740766Z -        'pattern': 'low',        # JSON concis
2026-02-20T22:09:10.7741249Z -        'sequence': 'low',       # JSON concis
2026-02-20T22:09:10.7741714Z -        'puzzle': 'low',         # JSON concis
2026-02-20T22:09:10.7742184Z -        'graph': 'low',          # JSON concis
2026-02-20T22:09:10.7742642Z -        'visual': 'low',         # JSON concis
2026-02-20T22:09:10.7743335Z -        'riddle': 'medium',      # Un peu plus de contexte
2026-02-20T22:09:10.7744076Z -        'deduction': 'medium',   # Explications détaillées
2026-02-20T22:09:10.7744699Z -        'coding': 'low',         # JSON concis pour cryptographie
2026-02-20T22:09:10.7745289Z -        'chess': 'low',          # JSON concis (board 8x8)
2026-02-20T22:09:10.7745806Z -        'probability': 'low',    # JSON concis
2026-02-20T22:09:10.7746229Z -    }
2026-02-20T22:09:10.7746483Z -    
2026-02-20T22:09:10.7746778Z +        "pattern": "low",  # JSON concis
2026-02-20T22:09:10.7747219Z +        "sequence": "low",  # JSON concis
2026-02-20T22:09:10.7747650Z +        "puzzle": "low",  # JSON concis
2026-02-20T22:09:10.7748151Z +        "graph": "low",  # JSON concis
2026-02-20T22:09:10.7748565Z +        "visual": "low",  # JSON concis
2026-02-20T22:09:10.7749044Z +        "riddle": "medium",  # Un peu plus de contexte
2026-02-20T22:09:10.7749720Z +        "deduction": "medium",  # Explications détaillées
2026-02-20T22:09:10.7750305Z +        "coding": "low",  # JSON concis pour cryptographie
2026-02-20T22:09:10.7750839Z +        "chess": "low",  # JSON concis (board 8x8)
2026-02-20T22:09:10.7751320Z +        "probability": "low",  # JSON concis
2026-02-20T22:09:10.7751734Z +    }
2026-02-20T22:09:10.7751984Z +
2026-02-20T22:09:10.7752551Z      # Températures - UNIQUEMENT utilisées si reasoning.effort = none
2026-02-20T22:09:10.7783732Z      # Pour GPT-5.2 avec reasoning activé, ces valeurs sont ignorées
2026-02-20T22:09:10.7784401Z      TEMPERATURE_MAP: Dict[str, float] = {
2026-02-20T22:09:10.7784856Z -        'pattern': 0.2,
2026-02-20T22:09:10.7785222Z -        'sequence': 0.3,
2026-02-20T22:09:10.7785571Z -        'puzzle': 0.5,
2026-02-20T22:09:10.7785905Z -        'graph': 0.3,
2026-02-20T22:09:10.7786239Z -        'visual': 0.3,
2026-02-20T22:09:10.7786565Z -        'riddle': 0.7,
2026-02-20T22:09:10.7786902Z -        'deduction': 0.3,
2026-02-20T22:09:10.7787584Z -        'coding': 0.3,           # Température basse pour cohérence cryptographique
2026-02-20T22:09:10.7788424Z -        'chess': 0.3,            # Positions tactiques cohérentes
2026-02-20T22:09:10.7789081Z -        'probability': 0.4,     # Légère variété
2026-02-20T22:09:10.7789514Z -    }
2026-02-20T22:09:10.7789764Z -    
2026-02-20T22:09:10.7790041Z +        "pattern": 0.2,
2026-02-20T22:09:10.7790389Z +        "sequence": 0.3,
2026-02-20T22:09:10.7790725Z +        "puzzle": 0.5,
2026-02-20T22:09:10.7791076Z +        "graph": 0.3,
2026-02-20T22:09:10.7791403Z +        "visual": 0.3,
2026-02-20T22:09:10.7791733Z +        "riddle": 0.7,
2026-02-20T22:09:10.7792061Z +        "deduction": 0.3,
2026-02-20T22:09:10.7792744Z +        "coding": 0.3,  # Température basse pour cohérence cryptographique
2026-02-20T22:09:10.7793691Z +        "chess": 0.3,  # Positions tactiques cohérentes
2026-02-20T22:09:10.7794320Z +        "probability": 0.4,  # Légère variété
2026-02-20T22:09:10.7794738Z +    }
2026-02-20T22:09:10.7794992Z +
2026-02-20T22:09:10.7795305Z      # Max tokens adaptatif selon le type
2026-02-20T22:09:10.7796012Z      # GPT-5 avec reasoning peut consommer beaucoup de tokens - augmenter les limites
2026-02-20T22:09:10.7797433Z      # Note: avec reasoning=high, le modèle utilise plus de tokens pour "réfléchir"
2026-02-20T22:09:10.7798174Z      MAX_TOKENS_MAP: Dict[str, int] = {
2026-02-20T22:09:10.7798714Z -        'pattern': 6000,     # Patterns avec visual_data
2026-02-20T22:09:10.7799705Z -        'sequence': 4000,    # Séquences avec visual_data
2026-02-20T22:09:10.7800448Z -        'puzzle': 5000,      # Puzzles avec hints détaillés
2026-02-20T22:09:10.7801223Z -        'graph': 6000,       # Graphes avec visual_data détaillé
2026-02-20T22:09:10.7802120Z -        'visual': 8000,      # Visual (inclut spatial) avec descriptions détaillées
2026-02-20T22:09:10.7803167Z -        'riddle': 5000,      # Énigmes avec contexte
2026-02-20T22:09:10.7804040Z -        'deduction': 8000,   # Déduction avec règles et explications détaillées
2026-02-20T22:09:10.7805001Z -        'coding': 6000,      # Cryptographie avec message encodé et clé
2026-02-20T22:09:10.7805793Z -        'chess': 14000,      # o3 raisonne avant output ; board 8x8 + explication
2026-02-20T22:09:10.7806624Z -        'probability': 4000, # Probabilités simples
2026-02-20T22:09:10.7807110Z -    }
2026-02-20T22:09:10.7807378Z -    
2026-02-20T22:09:10.7807743Z +        "pattern": 6000,  # Patterns avec visual_data
2026-02-20T22:09:10.7808466Z +        "sequence": 4000,  # Séquences avec visual_data
2026-02-20T22:09:10.7809176Z +        "puzzle": 5000,  # Puzzles avec hints détaillés
2026-02-20T22:09:10.7809878Z +        "graph": 6000,  # Graphes avec visual_data détaillé
2026-02-20T22:09:10.7810740Z +        "visual": 8000,  # Visual (inclut spatial) avec descriptions détaillées
2026-02-20T22:09:10.7811527Z +        "riddle": 5000,  # Énigmes avec contexte
2026-02-20T22:09:10.7812344Z +        "deduction": 8000,  # Déduction avec règles et explications détaillées
2026-02-20T22:09:10.7843567Z +        "coding": 6000,  # Cryptographie avec message encodé et clé
2026-02-20T22:09:10.7844380Z +        "chess": 14000,  # o3 raisonne avant output ; board 8x8 + explication
2026-02-20T22:09:10.7845216Z +        "probability": 4000,  # Probabilités simples
2026-02-20T22:09:10.7845705Z +    }
2026-02-20T22:09:10.7845989Z +
2026-02-20T22:09:10.7846356Z      # Timeouts - plus longs pour GPT-5 avec reasoning
2026-02-20T22:09:10.7847124Z -    DEFAULT_TIMEOUT: float = 90.0   # 90 secondes par défaut
2026-02-20T22:09:10.7847842Z -    MAX_TIMEOUT: float = 180.0      # Maximum 3 minutes
2026-02-20T22:09:10.7848317Z -    
2026-02-20T22:09:10.7848844Z +    DEFAULT_TIMEOUT: float = 90.0  # 90 secondes par défaut
2026-02-20T22:09:10.7849430Z +    MAX_TIMEOUT: float = 180.0  # Maximum 3 minutes
2026-02-20T22:09:10.7849880Z +
2026-02-20T22:09:10.7850162Z      # Retry configuration
2026-02-20T22:09:10.7850540Z      MAX_RETRIES: int = 3
2026-02-20T22:09:10.7850923Z      RETRY_BACKOFF_MULTIPLIER: float = 1.0
2026-02-20T22:09:10.7851391Z      RETRY_MIN_WAIT: float = 2.0
2026-02-20T22:09:10.7851810Z      RETRY_MAX_WAIT: float = 10.0
2026-02-20T22:09:10.7852202Z -    
2026-02-20T22:09:10.7852469Z +
2026-02-20T22:09:10.7852720Z      @classmethod
2026-02-20T22:09:10.7853280Z      def is_o1_model(cls, model: str) -> bool:
2026-02-20T22:09:10.7854295Z          """Vérifie si le modèle est o1/o1-mini (pas de response_format JSON, pas de reasoning_effort)."""
2026-02-20T22:09:10.7855203Z          return model and model.lower().startswith("o1")
2026-02-20T22:09:10.7855704Z  
2026-02-20T22:09:10.7855986Z @@ -126,44 +127,51 @@
2026-02-20T22:09:10.7856409Z      def get_model(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7857205Z          """Retourne le modèle à utiliser pour un type de challenge."""
2026-02-20T22:09:10.7857849Z          if settings.OPENAI_MODEL_REASONING:
2026-02-20T22:09:10.7858364Z              return settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:10.7859075Z          return cls.MODEL_MAP.get(challenge_type.lower(), settings.OPENAI_MODEL)
2026-02-20T22:09:10.7859704Z -    
2026-02-20T22:09:10.7860243Z +
2026-02-20T22:09:10.7860507Z      @classmethod
2026-02-20T22:09:10.7860965Z      def get_reasoning_effort(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7861666Z          """Retourne le niveau de raisonnement pour GPT-5.2."""
2026-02-20T22:09:10.7862437Z -        return cls.REASONING_EFFORT_MAP.get(challenge_type.lower(), 'medium')
2026-02-20T22:09:10.7863546Z -    
2026-02-20T22:09:10.7864073Z +        return cls.REASONING_EFFORT_MAP.get(challenge_type.lower(), "medium")
2026-02-20T22:09:10.7864669Z +
2026-02-20T22:09:10.7864888Z      @classmethod
2026-02-20T22:09:10.7865251Z      def get_verbosity(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7865946Z          """Retourne le niveau de verbosité pour GPT-5.2."""
2026-02-20T22:09:10.7866585Z -        return cls.VERBOSITY_MAP.get(challenge_type.lower(), 'low')
2026-02-20T22:09:10.7867126Z -    
2026-02-20T22:09:10.7867515Z +        return cls.VERBOSITY_MAP.get(challenge_type.lower(), "low")
2026-02-20T22:09:10.7867996Z +
2026-02-20T22:09:10.7868243Z      @classmethod
2026-02-20T22:09:10.7868661Z      def get_temperature(cls, challenge_type: str) -> float:
2026-02-20T22:09:10.7869543Z          """Retourne la température (utilisée seulement si reasoning.effort = none)."""
2026-02-20T22:09:10.7870342Z          return cls.TEMPERATURE_MAP.get(challenge_type.lower(), 0.6)
2026-02-20T22:09:10.7870818Z -    
2026-02-20T22:09:10.7871031Z +
2026-02-20T22:09:10.7871233Z      @classmethod
2026-02-20T22:09:10.7871551Z      def get_max_tokens(cls, challenge_type: str) -> int:
2026-02-20T22:09:10.7872269Z          """Retourne le max_tokens à utiliser pour un type de challenge."""
2026-02-20T22:09:10.7883421Z          return cls.MAX_TOKENS_MAP.get(challenge_type.lower(), 2000)
2026-02-20T22:09:10.7884086Z -    
2026-02-20T22:09:10.7884355Z +
2026-02-20T22:09:10.7884622Z      @classmethod
2026-02-20T22:09:10.7885137Z      def get_timeout(cls, challenge_type: Optional[str] = None) -> float:
2026-02-20T22:09:10.7885952Z          """Retourne le timeout à utiliser."""
2026-02-20T22:09:10.7886631Z          # Timeout plus long pour types complexes avec raisonnement profond
2026-02-20T22:09:10.7887528Z -        if challenge_type in ['visual', 'deduction', 'pattern', 'graph', 'coding', 'chess']:
2026-02-20T22:09:10.7888273Z +        if challenge_type in [
2026-02-20T22:09:10.7888669Z +            "visual",
2026-02-20T22:09:10.7889025Z +            "deduction",
2026-02-20T22:09:10.7889375Z +            "pattern",
2026-02-20T22:09:10.7889712Z +            "graph",
2026-02-20T22:09:10.7890026Z +            "coding",
2026-02-20T22:09:10.7890375Z +            "chess",
2026-02-20T22:09:10.7890690Z +        ]:
2026-02-20T22:09:10.7890992Z              return cls.MAX_TIMEOUT
2026-02-20T22:09:10.7891422Z          return cls.DEFAULT_TIMEOUT
2026-02-20T22:09:10.7891809Z -    
2026-02-20T22:09:10.7892077Z +
2026-02-20T22:09:10.7892332Z      @classmethod
2026-02-20T22:09:10.7892715Z      def is_gpt5_model(cls, model: str) -> bool:
2026-02-20T22:09:10.7893590Z          """Vérifie si le modèle est un GPT-5.x."""
2026-02-20T22:09:10.7894144Z -        return model.startswith('gpt-5')
2026-02-20T22:09:10.7894567Z -    
2026-02-20T22:09:10.7894880Z +        return model.startswith("gpt-5")
2026-02-20T22:09:10.7895304Z +
2026-02-20T22:09:10.7895557Z      @classmethod
2026-02-20T22:09:10.7896004Z      def get_openai_params(cls, challenge_type: str) -> Dict:
2026-02-20T22:09:10.7896948Z          """Retourne les paramètres OpenAI complets pour un type de challenge."""
2026-02-20T22:09:10.7897685Z          model = cls.get_model(challenge_type)
2026-02-20T22:09:10.7898301Z          reasoning_effort = cls.get_reasoning_effort(challenge_type)
2026-02-20T22:09:10.7898899Z @@ -189,6 +197,5 @@
2026-02-20T22:09:10.7899398Z                  params["temperature"] = cls.get_temperature(challenge_type)
2026-02-20T22:09:10.7900018Z          else:
2026-02-20T22:09:10.7900498Z              params["temperature"] = cls.get_temperature(challenge_type)
2026-02-20T22:09:10.7901070Z  
2026-02-20T22:09:10.7901348Z          return params
2026-02-20T22:09:10.7901951Z -
2026-02-20T22:09:10.8867140Z --- /home/runner/work/mathakine/mathakine/app/core/security.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.8869022Z +++ /home/runner/work/mathakine/mathakine/app/core/security.py	2026-02-20 22:09:10.883452+00:00
2026-02-20T22:09:10.8870118Z @@ -1,8 +1,9 @@
2026-02-20T22:09:10.8871501Z would reformat /home/runner/work/mathakine/mathakine/app/core/security.py
2026-02-20T22:09:10.8872136Z  """
2026-02-20T22:09:10.8873293Z  Utilitaires de sécurité pour l'authentification
2026-02-20T22:09:10.8874100Z  """
2026-02-20T22:09:10.8874632Z +
2026-02-20T22:09:10.8875105Z  from datetime import UTC, datetime, timedelta, timezone
2026-02-20T22:09:10.8875723Z  from typing import Any, Optional, Union
2026-02-20T22:09:10.8876159Z  
2026-02-20T22:09:10.8876432Z  import bcrypt
2026-02-20T22:09:10.8879382Z  from fastapi import HTTPException
2026-02-20T22:09:10.8879904Z @@ -16,20 +17,21 @@
2026-02-20T22:09:10.8880279Z  logger = get_logger(__name__)
2026-02-20T22:09:10.8880692Z  
2026-02-20T22:09:10.8881582Z  # Clé secrète pour la signature des tokens (à mettre en variable d'environnement en production)
2026-02-20T22:09:10.8882521Z  SECRET_KEY = settings.SECRET_KEY
2026-02-20T22:09:10.8882939Z  
2026-02-20T22:09:10.8883400Z +
2026-02-20T22:09:10.8883717Z  def decode_token(token: str) -> dict:
2026-02-20T22:09:10.8909360Z      """
2026-02-20T22:09:10.8910044Z would reformat /home/runner/work/mathakine/mathakine/app/core/monitoring.py
2026-02-20T22:09:10.8910933Z      Décode et vérifie un token JWT.
2026-02-20T22:09:10.8911380Z -    
2026-02-20T22:09:10.8911649Z +
2026-02-20T22:09:10.8911924Z      Args:
2026-02-20T22:09:10.8912366Z          token: Le token JWT à décoder
2026-02-20T22:09:10.8912807Z -        
2026-02-20T22:09:10.8913433Z +
2026-02-20T22:09:10.8913714Z      Returns:
2026-02-20T22:09:10.8914167Z          Le contenu décodé du token
2026-02-20T22:09:10.8914595Z -        
2026-02-20T22:09:10.8914870Z +
2026-02-20T22:09:10.8915111Z      Raises:
2026-02-20T22:09:10.8915607Z          HTTPException: Si le token est invalide ou expiré
2026-02-20T22:09:10.8916098Z      """
2026-02-20T22:09:10.8916357Z      try:
2026-02-20T22:09:10.8916876Z          payload = jwt.decode(token, SECRET_KEY, algorithms=[SecurityConfig.ALGORITHM])
2026-02-20T22:09:10.8917555Z @@ -39,101 +41,111 @@
2026-02-20T22:09:10.8917938Z          error_msg = str(jwt_decode_error)
2026-02-20T22:09:10.8918466Z          if "Signature verification failed" in error_msg:
2026-02-20T22:09:10.8919329Z              logger.debug(f"Signature verification failed (token invalide ou expiré)")
2026-02-20T22:09:10.8919973Z          else:
2026-02-20T22:09:10.8920547Z              logger.debug(f"Erreur lors du décodage du token: {error_msg}")
2026-02-20T22:09:10.8921232Z -        raise HTTPException(
2026-02-20T22:09:10.8921618Z -            status_code=401,
2026-02-20T22:09:10.8922108Z -            detail="Token invalide ou expiré"
2026-02-20T22:09:10.8922543Z -        )
2026-02-20T22:09:10.8923315Z +        raise HTTPException(status_code=401, detail="Token invalide ou expiré")
2026-02-20T22:09:10.8923992Z +
2026-02-20T22:09:10.8924260Z  
2026-02-20T22:09:10.8924812Z  def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
2026-02-20T22:09:10.8925529Z      """
2026-02-20T22:09:10.8925951Z      Crée un token JWT d'accès
2026-02-20T22:09:10.8926356Z -    
2026-02-20T22:09:10.8926625Z +
2026-02-20T22:09:10.8926886Z      Args:
2026-02-20T22:09:10.8927329Z          data: Données à inclure dans le token
2026-02-20T22:09:10.8927931Z          expires_delta: Délai d'expiration du token
2026-02-20T22:09:10.8928378Z -    
2026-02-20T22:09:10.8928642Z +
2026-02-20T22:09:10.8928912Z      Returns:
2026-02-20T22:09:10.8929269Z          Token encodé
2026-02-20T22:09:10.8929594Z      """
2026-02-20T22:09:10.8929860Z      to_encode = data.copy()
2026-02-20T22:09:10.8930177Z -    
2026-02-20T22:09:10.8930391Z +
2026-02-20T22:09:10.8930784Z      # Convertir les objets enum en valeurs de chaîne
2026-02-20T22:09:10.8931546Z      for key, value in to_encode.items():
2026-02-20T22:09:10.8931966Z -        if hasattr(value, 'value'):
2026-02-20T22:09:10.8932357Z +        if hasattr(value, "value"):
2026-02-20T22:09:10.8932774Z              to_encode[key] = value.value
2026-02-20T22:09:10.8933351Z -    
2026-02-20T22:09:10.8933598Z +
2026-02-20T22:09:10.8934120Z      # Calculer l'expiration
2026-02-20T22:09:10.8934485Z      if expires_delta:
2026-02-20T22:09:10.8934916Z          expire = datetime.now(timezone.utc) + expires_delta
2026-02-20T22:09:10.8935398Z      else:
2026-02-20T22:09:10.8936009Z -        expire = datetime.now(timezone.utc) + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
2026-02-20T22:09:10.8936744Z -    
2026-02-20T22:09:10.8937103Z +        expire = datetime.now(timezone.utc) + timedelta(
2026-02-20T22:09:10.8937671Z +            minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES
2026-02-20T22:09:10.8938151Z +        )
2026-02-20T22:09:10.8938412Z +
2026-02-20T22:09:10.8938721Z      # Ajouter l'expiration et le type de token
2026-02-20T22:09:10.8939304Z      to_encode.update({"exp": expire, "type": "access"})
2026-02-20T22:09:10.8939779Z -    
2026-02-20T22:09:10.8940033Z +
2026-02-20T22:09:10.8940288Z      # Encoder le token
2026-02-20T22:09:10.8940915Z -    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
2026-02-20T22:09:10.8941655Z +    encoded_jwt = jwt.encode(
2026-02-20T22:09:10.8942162Z +        to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM
2026-02-20T22:09:10.8942707Z +    )
2026-02-20T22:09:10.8943130Z      return encoded_jwt
2026-02-20T22:09:10.9003410Z +
2026-02-20T22:09:10.9003702Z  
2026-02-20T22:09:10.9004215Z  def verify_password(plain_password: str, hashed_password: str) -> bool:
2026-02-20T22:09:10.9004846Z      """
2026-02-20T22:09:10.9005498Z      Vérifie si un mot de passe en clair correspond à sa version hachée.
2026-02-20T22:09:10.9006083Z -    
2026-02-20T22:09:10.9006344Z +
2026-02-20T22:09:10.9006587Z      Args:
2026-02-20T22:09:10.9006944Z          plain_password: Mot de passe en clair
2026-02-20T22:09:10.9007602Z          hashed_password: Mot de passe haché à comparer
2026-02-20T22:09:10.9008082Z -    
2026-02-20T22:09:10.9008344Z +
2026-02-20T22:09:10.9008592Z      Returns:
2026-02-20T22:09:10.9009004Z          True si les mots de passe correspondent, False sinon
2026-02-20T22:09:10.9009528Z      """
2026-02-20T22:09:10.9009967Z      logger.debug("Vérification du mot de passe")
2026-02-20T22:09:10.9010427Z -    
2026-02-20T22:09:10.9010685Z +
2026-02-20T22:09:10.9010927Z      try:
2026-02-20T22:09:10.9011463Z          # S'assurer que le mot de passe est une chaîne UTF-8 valide
2026-02-20T22:09:10.9012078Z          if not isinstance(plain_password, str):
2026-02-20T22:09:10.9012587Z              plain_password = str(plain_password)
2026-02-20T22:09:10.9013196Z -        
2026-02-20T22:09:10.9013469Z +
2026-02-20T22:09:10.9013992Z          # Limiter la longueur à 72 bytes pour bcrypt (sécurité)
2026-02-20T22:09:10.9014636Z -        password_bytes = plain_password.encode('utf-8')
2026-02-20T22:09:10.9015247Z +        password_bytes = plain_password.encode("utf-8")
2026-02-20T22:09:10.9015772Z          if len(password_bytes) > 72:
2026-02-20T22:09:10.9016688Z -            logger.warning(f"Mot de passe trop long ({len(password_bytes)} bytes), tronqué à 72 bytes")
2026-02-20T22:09:10.9017680Z -            plain_password = password_bytes[:72].decode('utf-8', errors='ignore')
2026-02-20T22:09:10.9018304Z -        
2026-02-20T22:09:10.9018600Z +            logger.warning(
2026-02-20T22:09:10.9019338Z +                f"Mot de passe trop long ({len(password_bytes)} bytes), tronqué à 72 bytes"
2026-02-20T22:09:10.9019981Z +            )
2026-02-20T22:09:10.9020471Z +            plain_password = password_bytes[:72].decode("utf-8", errors="ignore")
2026-02-20T22:09:10.9049485Z +
2026-02-20T22:09:10.9050313Z          # Utiliser bcrypt directement au lieu de passlib pour éviter les warnings de compatibilité
2026-02-20T22:09:10.9051456Z          # Convertir le hash en bytes si c'est une string
2026-02-20T22:09:10.9052019Z          if isinstance(hashed_password, str):
2026-02-20T22:09:10.9052603Z -            hashed_password_bytes = hashed_password.encode('utf-8')
2026-02-20T22:09:10.9053591Z +            hashed_password_bytes = hashed_password.encode("utf-8")
2026-02-20T22:09:10.9054386Z          else:
2026-02-20T22:09:10.9054754Z              hashed_password_bytes = hashed_password
2026-02-20T22:09:10.9055210Z -        
2026-02-20T22:09:10.9055767Z -        result = bcrypt.checkpw(plain_password.encode('utf-8'), hashed_password_bytes)
2026-02-20T22:09:10.9056436Z +
2026-02-20T22:09:10.9056959Z +        result = bcrypt.checkpw(plain_password.encode("utf-8"), hashed_password_bytes)
2026-02-20T22:09:10.9057899Z          logger.debug(f"Résultat de la vérification: {result}")
2026-02-20T22:09:10.9058436Z          return result
2026-02-20T22:09:10.9058864Z      except Exception as password_verification_error:
2026-02-20T22:09:10.9059911Z -        logger.error(f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}")
2026-02-20T22:09:10.9060737Z +        logger.error(
2026-02-20T22:09:10.9061498Z +            f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}"
2026-02-20T22:09:10.9062207Z +        )
2026-02-20T22:09:10.9062494Z          raise
2026-02-20T22:09:10.9062763Z +
2026-02-20T22:09:10.9063187Z  
2026-02-20T22:09:10.9063518Z  def get_password_hash(password: str) -> str:
2026-02-20T22:09:10.9063981Z      """
2026-02-20T22:09:10.9064403Z      Crée un hash sécurisé d'un mot de passe.
2026-02-20T22:09:10.9064842Z -    
2026-02-20T22:09:10.9065094Z +
2026-02-20T22:09:10.9065347Z      Args:
2026-02-20T22:09:10.9065652Z          password: Mot de passe en clair
2026-02-20T22:09:10.9066073Z -    
2026-02-20T22:09:10.9066321Z +
2026-02-20T22:09:10.9066573Z      Returns:
2026-02-20T22:09:10.9066974Z          Version hachée du mot de passe
2026-02-20T22:09:10.9067375Z      """
2026-02-20T22:09:10.9067899Z      logger.debug(f"Génération du hash pour le mot de passe")
2026-02-20T22:09:10.9068422Z      try:
2026-02-20T22:09:10.9069185Z          # Utiliser bcrypt directement au lieu de passlib pour éviter les warnings de compatibilité
2026-02-20T22:09:10.9070093Z          # Générer un salt et hasher le mot de passe
2026-02-20T22:09:10.9070604Z          salt = bcrypt.gensalt()
2026-02-20T22:09:10.9071144Z -        hashed_bytes = bcrypt.hashpw(password.encode('utf-8'), salt)
2026-02-20T22:09:10.9071768Z -        hashed = hashed_bytes.decode('utf-8')
2026-02-20T22:09:10.9072366Z +        hashed_bytes = bcrypt.hashpw(password.encode("utf-8"), salt)
2026-02-20T22:09:10.9073106Z +        hashed = hashed_bytes.decode("utf-8")
2026-02-20T22:09:10.9073724Z          logger.debug("Hash mot de passe généré")
2026-02-20T22:09:10.9074186Z          return hashed
2026-02-20T22:09:10.9074587Z      except Exception as password_hashing_error:
2026-02-20T22:09:10.9075472Z -        logger.error(f"Erreur lors de la génération du hash: {str(password_hashing_error)}")
2026-02-20T22:09:10.9076187Z -        raise 
2026-02-20T22:09:10.9076515Z \ No newline at end of file
2026-02-20T22:09:10.9076878Z +        logger.error(
2026-02-20T22:09:10.9077534Z +            f"Erreur lors de la génération du hash: {str(password_hashing_error)}"
2026-02-20T22:09:10.9078136Z +        )
2026-02-20T22:09:10.9078419Z +        raise
2026-02-20T22:09:10.9079060Z --- /home/runner/work/mathakine/mathakine/app/core/monitoring.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.9080176Z +++ /home/runner/work/mathakine/mathakine/app/core/monitoring.py	2026-02-20 22:09:10.884585+00:00
2026-02-20T22:09:10.9080936Z @@ -4,10 +4,11 @@
2026-02-20T22:09:10.9081334Z  RÉALITÉ (audit 2026-02):
2026-02-20T22:09:10.9081930Z  - sentry_sdk.init() : appelé au startup si SENTRY_DSN défini
2026-02-20T22:09:10.9082799Z  - Endpoint /metrics : exposé pour Prometheus (p50/p95/p99, taux d'erreur)
2026-02-20T22:09:10.9083704Z  - Désactivé en mode TESTING
2026-02-20T22:09:10.9084307Z  """
2026-02-20T22:09:10.9084562Z +
2026-02-20T22:09:10.9084811Z  import os
2026-02-20T22:09:10.9085094Z  import time
2026-02-20T22:09:10.9085406Z  from typing import Callable
2026-02-20T22:09:10.9085774Z  
2026-02-20T22:09:10.9086107Z  from app.core.logging_config import get_logger
2026-02-20T22:09:10.9086562Z @@ -22,10 +23,11 @@
2026-02-20T22:09:10.9087047Z          Counter,
2026-02-20T22:09:10.9087325Z          Histogram,
2026-02-20T22:09:10.9087634Z          REGISTRY,
2026-02-20T22:09:10.9087946Z          generate_latest,
2026-02-20T22:09:10.9088283Z      )
2026-02-20T22:09:10.9088533Z +
2026-02-20T22:09:10.9088823Z      _prometheus_available = True
2026-02-20T22:09:10.9089231Z  except ImportError:
2026-02-20T22:09:10.9089561Z      pass
2026-02-20T22:09:10.9089820Z  
2026-02-20T22:09:10.9090235Z  # Métriques Prometheus (créées à l'init)
2026-02-20T22:09:10.9090672Z @@ -53,11 +55,13 @@
2026-02-20T22:09:10.9090966Z      """
2026-02-20T22:09:10.9091333Z      global HTTP_REQUESTS_TOTAL, HTTP_REQUEST_DURATION
2026-02-20T22:09:10.9091850Z      initialized = False
2026-02-20T22:09:10.9092189Z  
2026-02-20T22:09:10.9092787Z      # 1. Sentry — erreurs et APM (SENTRY_DSN ou fallback NEXT_PUBLIC_SENTRY_DSN)
2026-02-20T22:09:10.9093904Z -    sentry_dsn = (os.getenv("SENTRY_DSN") or os.getenv("NEXT_PUBLIC_SENTRY_DSN") or "").strip()
2026-02-20T22:09:10.9094637Z +    sentry_dsn = (
2026-02-20T22:09:10.9095138Z +        os.getenv("SENTRY_DSN") or os.getenv("NEXT_PUBLIC_SENTRY_DSN") or ""
2026-02-20T22:09:10.9095740Z +    ).strip()
2026-02-20T22:09:10.9096153Z      testing = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:10.9096669Z  
2026-02-20T22:09:10.9096948Z      if sentry_dsn and not testing:
2026-02-20T22:09:10.9097357Z          try:
2026-02-20T22:09:10.9097657Z              import sentry_sdk
2026-02-20T22:09:10.9098018Z @@ -148,7 +152,9 @@
2026-02-20T22:09:10.9098321Z              status = 500
2026-02-20T22:09:10.9098651Z              raise
2026-02-20T22:09:10.9098970Z          finally:
2026-02-20T22:09:10.9099338Z              duration = time.perf_counter() - start
2026-02-20T22:09:10.9099903Z              if HTTP_REQUESTS_TOTAL and HTTP_REQUEST_DURATION:
2026-02-20T22:09:10.9100684Z -                HTTP_REQUESTS_TOTAL.labels(method=method, path=path, status=str(status)).inc()
2026-02-20T22:09:10.9101436Z +                HTTP_REQUESTS_TOTAL.labels(
2026-02-20T22:09:10.9101965Z +                    method=method, path=path, status=str(status)
2026-02-20T22:09:10.9102483Z +                ).inc()
2026-02-20T22:09:10.9103211Z                  HTTP_REQUEST_DURATION.labels(method=method, path=path).observe(duration)
2026-02-20T22:09:11.0077007Z --- /home/runner/work/mathakine/mathakine/app/db/base.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0082799Z +++ /home/runner/work/mathakine/mathakine/app/db/base.py	2026-02-20 22:09:11.004146+00:00
2026-02-20T22:09:11.0105409Z would reformat /home/runner/work/mathakine/mathakine/app/db/base.py
2026-02-20T22:09:11.0106042Z @@ -10,16 +10,18 @@
2026-02-20T22:09:11.0106435Z  
2026-02-20T22:09:11.0106703Z  try:
2026-02-20T22:09:11.0107511Z      # Configuration pour PostgreSQL avec pool de connexions optimisé
2026-02-20T22:09:11.0108140Z      engine = create_engine(
2026-02-20T22:09:11.0108543Z          settings.SQLALCHEMY_DATABASE_URL,
2026-02-20T22:09:11.0109530Z -        echo=settings.LOG_LEVEL == "DEBUG",  # Affiche les requêtes SQL dans les logs si niveau DEBUG
2026-02-20T22:09:11.0110391Z +        echo=settings.LOG_LEVEL
2026-02-20T22:09:11.0111131Z +        == "DEBUG",  # Affiche les requêtes SQL dans les logs si niveau DEBUG
2026-02-20T22:09:11.0112309Z          pool_pre_ping=True,  # Vérifie les connexions avant utilisation (évite les erreurs de connexion)
2026-02-20T22:09:11.0113620Z          pool_size=settings.MAX_CONNECTIONS_POOL,  # Nombre de connexions dans le pool
2026-02-20T22:09:11.0114893Z -        max_overflow=settings.MAX_CONNECTIONS_POOL * 2,  # Nombre max de connexions supplémentaires
2026-02-20T22:09:11.0115770Z +        max_overflow=settings.MAX_CONNECTIONS_POOL
2026-02-20T22:09:11.0116899Z +        * 2,  # Nombre max de connexions supplémentaires
2026-02-20T22:09:11.0117889Z          pool_recycle=settings.POOL_RECYCLE_SECONDS,  # Recycle les connexions après X secondes
2026-02-20T22:09:11.0118824Z -        pool_timeout=30  # Timeout pour obtenir une connexion du pool
2026-02-20T22:09:11.0119899Z +        pool_timeout=30,  # Timeout pour obtenir une connexion du pool
2026-02-20T22:09:11.0120479Z      )
2026-02-20T22:09:11.0121095Z      logger.success("Moteur SQLAlchemy (PostgreSQL) créé avec succès")
2026-02-20T22:09:11.0121726Z  except Exception as e:
2026-02-20T22:09:11.0122311Z      logger.error(f"Erreur lors de l'initialisation du moteur SQLAlchemy: {e}")
2026-02-20T22:09:11.0123158Z      raise
2026-02-20T22:09:11.0123457Z @@ -27,10 +29,11 @@
2026-02-20T22:09:11.0124008Z  SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
2026-02-20T22:09:11.0124877Z  logger.debug("Session SQLAlchemy configurée")
2026-02-20T22:09:11.0125366Z  
2026-02-20T22:09:11.0125670Z  Base = declarative_base()
2026-02-20T22:09:11.0126217Z  logger.debug("Base déclarative configurée")
2026-02-20T22:09:11.0126669Z +
2026-02-20T22:09:11.0126917Z  
2026-02-20T22:09:11.0127363Z  # Helper pour obtenir une session de base de données
2026-02-20T22:09:11.0127867Z  def get_db():
2026-02-20T22:09:11.0128663Z      """Générateur pour obtenir une session de base de données avec nettoyage automatique."""
2026-02-20T22:09:11.0129732Z      logger.debug("Ouverture d'une nouvelle session de base de données")
2026-02-20T22:09:11.0510697Z --- /home/runner/work/mathakine/mathakine/app/core/constants.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0511860Z +++ /home/runner/work/mathakine/mathakine/app/core/constants.py	2026-02-20 22:09:11.044988+00:00
2026-02-20T22:09:11.0512609Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.0512896Z  """
2026-02-20T22:09:11.0513717Z  Constants centralisées pour l'application Mathakine
2026-02-20T22:09:11.0514555Z  Ce fichier contient toutes les constantes utilisées dans l'application.
2026-02-20T22:09:11.0515220Z  """
2026-02-20T22:09:11.0515473Z +
2026-02-20T22:09:11.0515813Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.0516437Z  from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:11.0517052Z  from app.models.logic_challenge import AgeGroup
2026-02-20T22:09:11.0517535Z  
2026-02-20T22:09:11.0517819Z  logger = get_logger(__name__)
2026-02-20T22:09:11.0518191Z @@ -20,44 +21,85 @@
2026-02-20T22:09:11.0518560Z      GEOMETRIE = ExerciseType.GEOMETRIE.value
2026-02-20T22:09:11.0519039Z      TEXTE = ExerciseType.TEXTE.value
2026-02-20T22:09:11.0519454Z      MIXTE = ExerciseType.MIXTE.value
2026-02-20T22:09:11.0520124Z      MIXED = ExerciseType.MIXTE.value  # Alias pour compatibilité
2026-02-20T22:09:11.0520720Z      DIVERS = ExerciseType.DIVERS.value
2026-02-20T22:09:11.0521144Z -    
2026-02-20T22:09:11.0521853Z -    ALL_TYPES = [ADDITION, SUBTRACTION, MULTIPLICATION, DIVISION, FRACTIONS, GEOMETRIE, TEXTE, MIXTE, DIVERS]
2026-02-20T22:09:11.0522717Z -    
2026-02-20T22:09:11.0523170Z +
2026-02-20T22:09:11.0523441Z +    ALL_TYPES = [
2026-02-20T22:09:11.0523748Z +        ADDITION,
2026-02-20T22:09:11.0524046Z +        SUBTRACTION,
2026-02-20T22:09:11.0524399Z +        MULTIPLICATION,
2026-02-20T22:09:11.0524726Z +        DIVISION,
2026-02-20T22:09:11.0525047Z +        FRACTIONS,
2026-02-20T22:09:11.0525736Z would reformat /home/runner/work/mathakine/mathakine/app/core/constants.py
2026-02-20T22:09:11.0526385Z +        GEOMETRIE,
2026-02-20T22:09:11.0526677Z +        TEXTE,
2026-02-20T22:09:11.0526950Z +        MIXTE,
2026-02-20T22:09:11.0527226Z +        DIVERS,
2026-02-20T22:09:11.0527499Z +    ]
2026-02-20T22:09:11.0527749Z +
2026-02-20T22:09:11.0528051Z      # Mapping pour la normalisation des types
2026-02-20T22:09:11.0528518Z      TYPE_ALIASES = {
2026-02-20T22:09:11.0528947Z          ADDITION: [ADDITION, "addition", "add", "+", "plus"],
2026-02-20T22:09:11.0529718Z          SUBTRACTION: [SUBTRACTION, "soustraction", "subtract", "sub", "-", "minus"],
2026-02-20T22:09:11.0531244Z -        MULTIPLICATION: [MULTIPLICATION, "multiplication", "multiply", "mult", "times", "*", "×"],
2026-02-20T22:09:11.0532045Z +        MULTIPLICATION: [
2026-02-20T22:09:11.0532422Z +            MULTIPLICATION,
2026-02-20T22:09:11.0532802Z +            "multiplication",
2026-02-20T22:09:11.0535325Z +            "multiply",
2026-02-20T22:09:11.0535669Z +            "mult",
2026-02-20T22:09:11.0535992Z +            "times",
2026-02-20T22:09:11.0536294Z +            "*",
2026-02-20T22:09:11.0536669Z +            "×",
2026-02-20T22:09:11.0536963Z +        ],
2026-02-20T22:09:11.0537495Z          DIVISION: [DIVISION, "division", "divide", "div", "/", "÷"],
2026-02-20T22:09:11.0538192Z          FRACTIONS: [FRACTIONS, "fractions", "fraction", "frac"],
2026-02-20T22:09:11.0538845Z          GEOMETRIE: [GEOMETRIE, "geometrie", "geometry", "geo"],
2026-02-20T22:09:11.0539424Z          TEXTE: [TEXTE, "texte", "text", "question"],
2026-02-20T22:09:11.0540144Z          MIXTE: [MIXTE, "mixte", "mixed", "combiné", "combine"],
2026-02-20T22:09:11.0540734Z -        DIVERS: [DIVERS, "divers", "misc", "other"]
2026-02-20T22:09:11.0541263Z +        DIVERS: [DIVERS, "divers", "misc", "other"],
2026-02-20T22:09:11.0541726Z      }
2026-02-20T22:09:11.0541991Z +
2026-02-20T22:09:11.0542246Z  
2026-02-20T22:09:11.0542796Z  # Niveaux de difficulté - compatible avec l'enum DifficultyLevel
2026-02-20T22:09:11.0543637Z  class DifficultyLevels:
2026-02-20T22:09:11.0544059Z      INITIE = DifficultyLevel.INITIE.value
2026-02-20T22:09:11.0544560Z      PADAWAN = DifficultyLevel.PADAWAN.value
2026-02-20T22:09:11.0545111Z      CHEVALIER = DifficultyLevel.CHEVALIER.value
2026-02-20T22:09:11.0545631Z      MAITRE = DifficultyLevel.MAITRE.value
2026-02-20T22:09:11.0546166Z      GRAND_MAITRE = DifficultyLevel.GRAND_MAITRE.value
2026-02-20T22:09:11.0546732Z -    
2026-02-20T22:09:11.0547001Z +
2026-02-20T22:09:11.0547414Z      ALL_LEVELS = [INITIE, PADAWAN, CHEVALIER, MAITRE, GRAND_MAITRE]
2026-02-20T22:09:11.0547992Z -    
2026-02-20T22:09:11.0548257Z +
2026-02-20T22:09:11.0548573Z      # Mapping pour la normalisation des niveaux
2026-02-20T22:09:11.0549047Z      LEVEL_ALIASES = {
2026-02-20T22:09:11.0549749Z          INITIE: [INITIE, "initié", "initie", "easy", "facile", "debutant", "débutant"],
2026-02-20T22:09:11.0550848Z -        PADAWAN: [PADAWAN, "padawan", "medium", "moyen", "intermediaire", "intermédiaire"],
2026-02-20T22:09:11.0551562Z +        PADAWAN: [
2026-02-20T22:09:11.0551874Z +            PADAWAN,
2026-02-20T22:09:11.0552196Z +            "padawan",
2026-02-20T22:09:11.0552512Z +            "medium",
2026-02-20T22:09:11.0552824Z +            "moyen",
2026-02-20T22:09:11.0553437Z +            "intermediaire",
2026-02-20T22:09:11.0553931Z +            "intermédiaire",
2026-02-20T22:09:11.0554287Z +        ],
2026-02-20T22:09:11.0554929Z          CHEVALIER: [CHEVALIER, "chevalier", "hard", "difficile", "avance", "avancé"],
2026-02-20T22:09:11.0556007Z -        MAITRE: [MAITRE, "maitre", "maître", "expert", "très difficile", "tres difficile"],
2026-02-20T22:09:11.0557200Z -        GRAND_MAITRE: [GRAND_MAITRE, "grand maitre", "grand maître", "grandmaitre", "master", "adulte"]
2026-02-20T22:09:11.0557965Z +        MAITRE: [
2026-02-20T22:09:11.0558279Z +            MAITRE,
2026-02-20T22:09:11.0558613Z +            "maitre",
2026-02-20T22:09:11.0558964Z +            "maître",
2026-02-20T22:09:11.0559266Z +            "expert",
2026-02-20T22:09:11.0559667Z +            "très difficile",
2026-02-20T22:09:11.0560036Z +            "tres difficile",
2026-02-20T22:09:11.0560370Z +        ],
2026-02-20T22:09:11.0560651Z +        GRAND_MAITRE: [
2026-02-20T22:09:11.0560989Z +            GRAND_MAITRE,
2026-02-20T22:09:11.0561327Z +            "grand maitre",
2026-02-20T22:09:11.0561735Z +            "grand maître",
2026-02-20T22:09:11.0562077Z +            "grandmaitre",
2026-02-20T22:09:11.0562417Z +            "master",
2026-02-20T22:09:11.0562711Z +            "adulte",
2026-02-20T22:09:11.0563504Z +        ],
2026-02-20T22:09:11.0563762Z      }
2026-02-20T22:09:11.0564016Z +
2026-02-20T22:09:11.0564250Z  
2026-02-20T22:09:11.0564617Z  # Groupes d'âge pour les exercices
2026-02-20T22:09:11.0565433Z  # NOMENCLATURE OFFICIELLE : alignée avec le système scolaire français et le frontend
2026-02-20T22:09:11.0566368Z  # - 6-8 ans : CP-CE2 (cycle 2)
2026-02-20T22:09:11.0566927Z  # - 9-11 ans : CM1-CM2-6e (fin cycle 2, début cycle 3)
2026-02-20T22:09:11.0567392Z @@ -68,63 +110,116 @@
2026-02-20T22:09:11.0567711Z      GROUP_9_11 = "9-11"
2026-02-20T22:09:11.0568041Z      GROUP_12_14 = "12-14"
2026-02-20T22:09:11.0568383Z      GROUP_15_17 = "15-17"
2026-02-20T22:09:11.0568709Z      ADULT = "adulte"
2026-02-20T22:09:11.0569029Z      ALL_AGES = "tous-ages"
2026-02-20T22:09:11.0569355Z -    
2026-02-20T22:09:11.0569605Z +
2026-02-20T22:09:11.0570064Z      ALL_GROUPS = [GROUP_6_8, GROUP_9_11, GROUP_12_14, GROUP_15_17, ADULT, ALL_AGES]
2026-02-20T22:09:11.0570658Z -    
2026-02-20T22:09:11.0570922Z +
2026-02-20T22:09:11.0571358Z      # Mapping pour la normalisation des groupes d'âge
2026-02-20T22:09:11.0572153Z      # Inclut tous les formats possibles du frontend et de l'API (age_*, GROUP_* pour challenges)
2026-02-20T22:09:11.0572873Z      AGE_ALIASES = {
2026-02-20T22:09:11.0573658Z -        GROUP_6_8: ["6-8", "6-8 ans", "6 to 8 ans", "6_8", "group_6_8", "GROUP_6_8", "age_6_8", "6-8ans"],
2026-02-20T22:09:11.0574784Z -        GROUP_9_11: ["9-11", "9-11 ans", "9 to 11 ans", "9_11", "group_9_11", "GROUP_9_12", "GROUP_10_12", "age_9_12", "age_10_12", "9-11ans", "10-12"],
2026-02-20T22:09:11.0576007Z -        GROUP_12_14: ["12-14", "12-14 ans", "12 to 14 ans", "12_14", "group_12_14", "GROUP_13_15", "age_13_15", "12-14ans", "13-15"],
2026-02-20T22:09:11.0577157Z -        GROUP_15_17: ["15-17", "15-17 ans", "15 to 17 ans", "15_17", "group_15_17", "GROUP_16_18", "GROUP_15_17", "age_16_18", "15-17ans"],
2026-02-20T22:09:11.0577944Z +        GROUP_6_8: [
2026-02-20T22:09:11.0578253Z +            "6-8",
2026-02-20T22:09:11.0578554Z +            "6-8 ans",
2026-02-20T22:09:11.0578873Z +            "6 to 8 ans",
2026-02-20T22:09:11.0579194Z +            "6_8",
2026-02-20T22:09:11.0579484Z +            "group_6_8",
2026-02-20T22:09:11.0579818Z +            "GROUP_6_8",
2026-02-20T22:09:11.0580132Z +            "age_6_8",
2026-02-20T22:09:11.0580450Z +            "6-8ans",
2026-02-20T22:09:11.0580746Z +        ],
2026-02-20T22:09:11.0581019Z +        GROUP_9_11: [
2026-02-20T22:09:11.0581317Z +            "9-11",
2026-02-20T22:09:11.0581615Z +            "9-11 ans",
2026-02-20T22:09:11.0581930Z +            "9 to 11 ans",
2026-02-20T22:09:11.0582257Z +            "9_11",
2026-02-20T22:09:11.0582556Z +            "group_9_11",
2026-02-20T22:09:11.0582881Z +            "GROUP_9_12",
2026-02-20T22:09:11.0583384Z +            "GROUP_10_12",
2026-02-20T22:09:11.0583716Z +            "age_9_12",
2026-02-20T22:09:11.0584044Z +            "age_10_12",
2026-02-20T22:09:11.0584361Z +            "9-11ans",
2026-02-20T22:09:11.0584682Z +            "10-12",
2026-02-20T22:09:11.0584968Z +        ],
2026-02-20T22:09:11.0585240Z +        GROUP_12_14: [
2026-02-20T22:09:11.0585541Z +            "12-14",
2026-02-20T22:09:11.0585841Z +            "12-14 ans",
2026-02-20T22:09:11.0586161Z +            "12 to 14 ans",
2026-02-20T22:09:11.0586499Z +            "12_14",
2026-02-20T22:09:11.0586813Z +            "group_12_14",
2026-02-20T22:09:11.0587143Z +            "GROUP_13_15",
2026-02-20T22:09:11.0587476Z +            "age_13_15",
2026-02-20T22:09:11.0587791Z +            "12-14ans",
2026-02-20T22:09:11.0588110Z +            "13-15",
2026-02-20T22:09:11.0588393Z +        ],
2026-02-20T22:09:11.0588666Z +        GROUP_15_17: [
2026-02-20T22:09:11.0588974Z +            "15-17",
2026-02-20T22:09:11.0589272Z +            "15-17 ans",
2026-02-20T22:09:11.0589592Z +            "15 to 17 ans",
2026-02-20T22:09:11.0589924Z +            "15_17",
2026-02-20T22:09:11.0590231Z +            "group_15_17",
2026-02-20T22:09:11.0590825Z +            "GROUP_16_18",
2026-02-20T22:09:11.0591175Z +            "GROUP_15_17",
2026-02-20T22:09:11.0591502Z +            "age_16_18",
2026-02-20T22:09:11.0591826Z +            "15-17ans",
2026-02-20T22:09:11.0592127Z +        ],
2026-02-20T22:09:11.0592544Z          ADULT: ["adulte", "adultes", "adult", "adults", "18+", "majeur"],
2026-02-20T22:09:11.0593849Z -        ALL_AGES: ["tous-ages", "tous ages", "all ages", "all", "tous", "all_ages", "tousages"],
2026-02-20T22:09:11.0594506Z +        ALL_AGES: [
2026-02-20T22:09:11.0594857Z +            "tous-ages",
2026-02-20T22:09:11.0595214Z +            "tous ages",
2026-02-20T22:09:11.0595562Z +            "all ages",
2026-02-20T22:09:11.0595878Z +            "all",
2026-02-20T22:09:11.0596198Z +            "tous",
2026-02-20T22:09:11.0596515Z +            "all_ages",
2026-02-20T22:09:11.0596872Z +            "tousages",
2026-02-20T22:09:11.0597192Z +        ],
2026-02-20T22:09:11.0597461Z      }
2026-02-20T22:09:11.0597714Z  
2026-02-20T22:09:11.0597984Z +
2026-02-20T22:09:11.0598278Z  def normalize_age_group(age_group):
2026-02-20T22:09:11.0598703Z      """
2026-02-20T22:09:11.0599372Z      Normalise le groupe d'âge vers le format standard (6-8, 9-11, etc.)
2026-02-20T22:09:11.0599985Z -    
2026-02-20T22:09:11.0600271Z +
2026-02-20T22:09:11.0600529Z      Args:
2026-02-20T22:09:11.0601201Z          age_group: Le groupe d'âge en entrée (peut être dans différents formats)
2026-02-20T22:09:11.0601866Z -        
2026-02-20T22:09:11.0602153Z +
2026-02-20T22:09:11.0602412Z      Returns:
2026-02-20T22:09:11.0603170Z          Le groupe d'âge normalisé (ex: "6-8", "9-11", etc.)
2026-02-20T22:09:11.0603717Z      """
2026-02-20T22:09:11.0604012Z      if not age_group:
2026-02-20T22:09:11.0604717Z          return AgeGroups.GROUP_9_11  # Défaut : 9-11 ans (milieu de gamme)
2026-02-20T22:09:11.0605327Z  
2026-02-20T22:09:11.0605677Z      age_group_str = str(age_group).lower().strip()
2026-02-20T22:09:11.0606158Z -    
2026-02-20T22:09:11.0606436Z +
2026-02-20T22:09:11.0606918Z      # Nettoyer les espaces et caractères spéciaux
2026-02-20T22:09:11.0607586Z -    age_group_clean = age_group_str.replace(' ', '').replace('_', '-')
2026-02-20T22:09:11.0608339Z +    age_group_clean = age_group_str.replace(" ", "").replace("_", "-")
2026-02-20T22:09:11.0608921Z  
2026-02-20T22:09:11.0609422Z      # Parcourir tous les groupes d'âge et leurs alias
2026-02-20T22:09:11.0610085Z      for group_key, aliases in AgeGroups.AGE_ALIASES.items():
2026-02-20T22:09:11.0610854Z          # Vérifier correspondance exacte ou nettoyée
2026-02-20T22:09:11.0611364Z          for alias in aliases:
2026-02-20T22:09:11.0611910Z -            alias_clean = alias.lower().replace(' ', '').replace('_', '-')
2026-02-20T22:09:11.0612652Z +            alias_clean = alias.lower().replace(" ", "").replace("_", "-")
2026-02-20T22:09:11.0613640Z              if age_group_clean == alias_clean or age_group_str == alias.lower():
2026-02-20T22:09:11.0614299Z                  return group_key
2026-02-20T22:09:11.0614703Z -    
2026-02-20T22:09:11.0614973Z +
2026-02-20T22:09:11.0615526Z      # Tentative de correspondance partielle (ex: "9" → "9-11")
2026-02-20T22:09:11.0616157Z      for group_key in AgeGroups.ALL_GROUPS:
2026-02-20T22:09:11.0616766Z -        if group_key.startswith(age_group_clean.split('-')[0] + '-'):
2026-02-20T22:09:11.0617497Z +        if group_key.startswith(age_group_clean.split("-")[0] + "-"):
2026-02-20T22:09:11.0618092Z              return group_key
2026-02-20T22:09:11.0618452Z -    
2026-02-20T22:09:11.0618738Z +
2026-02-20T22:09:11.0619347Z      # Si aucune correspondance trouvée, retourner le groupe par défaut
2026-02-20T22:09:11.0620590Z -    logger.warning(f"Groupe d'âge non reconnu: '{age_group}', utilisation de {AgeGroups.GROUP_9_11} par défaut")
2026-02-20T22:09:11.0621450Z +    logger.warning(
2026-02-20T22:09:11.0622239Z +        f"Groupe d'âge non reconnu: '{age_group}', utilisation de {AgeGroups.GROUP_9_11} par défaut"
2026-02-20T22:09:11.0623189Z +    )
2026-02-20T22:09:11.0623645Z      return AgeGroups.GROUP_9_11
2026-02-20T22:09:11.0624345Z  
2026-02-20T22:09:11.0624620Z +
2026-02-20T22:09:11.0624991Z  def get_difficulty_from_age_group(age_group: str) -> str:
2026-02-20T22:09:11.0625506Z      """
2026-02-20T22:09:11.0626241Z      Détermine le niveau de difficulté (INITIE, PADAWAN, ...) à partir du groupe d'âge.
2026-02-20T22:09:11.0627219Z -    
2026-02-20T22:09:11.0627504Z +
2026-02-20T22:09:11.0627771Z      Mapping :
2026-02-20T22:09:11.0628233Z      - 6-8 ans → INITIE (débutant)
2026-02-20T22:09:11.0628786Z      - 9-11 ans → PADAWAN (intermédiaire)
2026-02-20T22:09:11.0629369Z      - 12-14 ans → CHEVALIER (avancé)
2026-02-20T22:09:11.0629882Z      - 15-17 ans → MAITRE (expert)
2026-02-20T22:09:11.0630277Z @@ -141,19 +236,21 @@
2026-02-20T22:09:11.0630644Z          return DifficultyLevels.MAITRE
2026-02-20T22:09:11.0631097Z      elif age_group == AgeGroups.ADULT:
2026-02-20T22:09:11.0631578Z          return DifficultyLevels.GRAND_MAITRE
2026-02-20T22:09:11.0632022Z      else:
2026-02-20T22:09:11.0632596Z          # Valeur par défaut si le groupe d'âge n'est pas reconnu
2026-02-20T22:09:11.0634027Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut")
2026-02-20T22:09:11.0634953Z +        logger.info(
2026-02-20T22:09:11.0635885Z +            f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut"
2026-02-20T22:09:11.0636741Z +        )
2026-02-20T22:09:11.0637094Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:11.0637532Z  
2026-02-20T22:09:11.0637791Z  
2026-02-20T22:09:11.0638226Z  def calculate_difficulty_for_age_group(age_group: str) -> float:
2026-02-20T22:09:11.0638804Z      """
2026-02-20T22:09:11.0639508Z      Calcule une note de difficulté numérique (1.0 à 5.0) à partir du groupe d'âge.
2026-02-20T22:09:11.0640575Z      Utilisée pour les challenges qui ont un rating de difficulté numérique.
2026-02-20T22:09:11.0641220Z -    
2026-02-20T22:09:11.0641481Z +
2026-02-20T22:09:11.0641772Z      Mapping :
2026-02-20T22:09:11.0642180Z      - 6-8 ans → 1.5 (facile)
2026-02-20T22:09:11.0642647Z      - 9-11 ans → 2.5 (moyen)
2026-02-20T22:09:11.0643332Z      - 12-14 ans → 3.5 (difficile)
2026-02-20T22:09:11.0643855Z      - 15-17 ans → 4.0 (expert)
2026-02-20T22:09:11.0644302Z @@ -168,29 +265,45 @@
2026-02-20T22:09:11.0644701Z          AgeGroups.ADULT: 4.5,
2026-02-20T22:09:11.0645111Z          AgeGroups.ALL_AGES: 2.5,
2026-02-20T22:09:11.0645592Z      }
2026-02-20T22:09:11.0645961Z      return difficulty_mapping.get(age_group, 2.5)
2026-02-20T22:09:11.0646413Z  
2026-02-20T22:09:11.0646670Z +
2026-02-20T22:09:11.0647049Z  # Rôles d'utilisateurs
2026-02-20T22:09:11.0647407Z  class UserRoles:
2026-02-20T22:09:11.0648105Z      INITIE = "initie"  # Alias pour compatibilité (niveau utilisateur, pas rôle)
2026-02-20T22:09:11.0648780Z      PADAWAN = "padawan"
2026-02-20T22:09:11.0649159Z      CHEVALIER = "chevalier"
2026-02-20T22:09:11.0649553Z      MAITRE = "maitre"
2026-02-20T22:09:11.0649918Z      GARDIEN = "gardien"
2026-02-20T22:09:11.0650304Z      ARCHIVISTE = "archiviste"
2026-02-20T22:09:11.0650683Z -    
2026-02-20T22:09:11.0650951Z +
2026-02-20T22:09:11.0651387Z      ALL_ROLES = [PADAWAN, CHEVALIER, MAITRE, GARDIEN, ARCHIVISTE]
2026-02-20T22:09:11.0651938Z -    
2026-02-20T22:09:11.0652205Z +
2026-02-20T22:09:11.0652694Z      # Mapping des permissions par rôle (hiérarchique)
2026-02-20T22:09:11.0653465Z      ROLE_PERMISSIONS = {
2026-02-20T22:09:11.0653845Z          PADAWAN: ["view_own"],
2026-02-20T22:09:11.0654302Z          CHEVALIER: ["view_own", "create_exercises"],
2026-02-20T22:09:11.0654894Z          MAITRE: ["view_own", "create_exercises", "modify_own"],
2026-02-20T22:09:11.0655673Z -        GARDIEN: ["view_own", "view_all", "create_exercises", "modify_own", "modify_all"],
2026-02-20T22:09:11.0656727Z -        ARCHIVISTE: ["view_own", "view_all", "create_exercises", "modify_own", "modify_all", "delete", "admin"]
2026-02-20T22:09:11.0657552Z +        GARDIEN: [
2026-02-20T22:09:11.0658190Z +            "view_own",
2026-02-20T22:09:11.0658550Z +            "view_all",
2026-02-20T22:09:11.0658921Z +            "create_exercises",
2026-02-20T22:09:11.0659316Z +            "modify_own",
2026-02-20T22:09:11.0659676Z +            "modify_all",
2026-02-20T22:09:11.0660009Z +        ],
2026-02-20T22:09:11.0660307Z +        ARCHIVISTE: [
2026-02-20T22:09:11.0660920Z +            "view_own",
2026-02-20T22:09:11.0661278Z +            "view_all",
2026-02-20T22:09:11.0661640Z +            "create_exercises",
2026-02-20T22:09:11.0662023Z +            "modify_own",
2026-02-20T22:09:11.0662381Z +            "modify_all",
2026-02-20T22:09:11.0662730Z +            "delete",
2026-02-20T22:09:11.0663268Z +            "admin",
2026-02-20T22:09:11.0663582Z +        ],
2026-02-20T22:09:11.0663859Z      }
2026-02-20T22:09:11.0664119Z +
2026-02-20T22:09:11.0664369Z  
2026-02-20T22:09:11.0664694Z  # Noms d'affichage pour les types et niveaux
2026-02-20T22:09:11.0665154Z  DISPLAY_NAMES = {
2026-02-20T22:09:11.0665501Z      # Types d'exercices
2026-02-20T22:09:11.0665901Z      ExerciseTypes.ADDITION: "Addition",
2026-02-20T22:09:11.0666364Z @@ -200,62 +313,97 @@
2026-02-20T22:09:11.0666752Z      ExerciseTypes.FRACTIONS: "Fractions",
2026-02-20T22:09:11.0667395Z      ExerciseTypes.GEOMETRIE: "Géométrie",
2026-02-20T22:09:11.0667934Z      ExerciseTypes.TEXTE: "Question textuelle",
2026-02-20T22:09:11.0668484Z      ExerciseTypes.MIXTE: "Exercice mixte",
2026-02-20T22:09:11.0668939Z      ExerciseTypes.DIVERS: "Divers",
2026-02-20T22:09:11.0669330Z -    
2026-02-20T22:09:11.0669692Z      # Niveaux de difficulté
2026-02-20T22:09:11.0670201Z      DifficultyLevels.INITIE: "Initié",
2026-02-20T22:09:11.0670712Z      DifficultyLevels.PADAWAN: "Padawan",
2026-02-20T22:09:11.0671233Z      DifficultyLevels.CHEVALIER: "Chevalier",
2026-02-20T22:09:11.0671854Z      DifficultyLevels.MAITRE: "Maître",
2026-02-20T22:09:11.0672509Z -    DifficultyLevels.GRAND_MAITRE: "Grand Maître"
2026-02-20T22:09:11.0673446Z +    DifficultyLevels.GRAND_MAITRE: "Grand Maître",
2026-02-20T22:09:11.0673965Z  }
2026-02-20T22:09:11.0674234Z  
2026-02-20T22:09:11.0674758Z  # Limites numériques par difficulté et type d'exercice
2026-02-20T22:09:11.0675301Z  DIFFICULTY_LIMITS = {
2026-02-20T22:09:11.0675691Z      DifficultyLevels.INITIE: {
2026-02-20T22:09:11.0676176Z          ExerciseTypes.ADDITION: {"min": 1, "max": 10},
2026-02-20T22:09:11.0676923Z          ExerciseTypes.SUBTRACTION: {"min1": 5, "max1": 20, "min2": 1, "max2": 5},
2026-02-20T22:09:11.0677708Z          ExerciseTypes.MULTIPLICATION: {"min": 1, "max": 5},
2026-02-20T22:09:11.0678577Z -        ExerciseTypes.DIVISION: {"min_divisor": 2, "max_divisor": 5, "min_result": 1, "max_result": 5},
2026-02-20T22:09:11.0679408Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0679843Z +            "min_divisor": 2,
2026-02-20T22:09:11.0680234Z +            "max_divisor": 5,
2026-02-20T22:09:11.0680615Z +            "min_result": 1,
2026-02-20T22:09:11.0681002Z +            "max_result": 5,
2026-02-20T22:09:11.0681385Z +        },
2026-02-20T22:09:11.0681856Z          ExerciseTypes.MIXTE: {"min": 1, "max": 10, "operations": 2},
2026-02-20T22:09:11.0682471Z -        "default": {"min": 1, "max": 10}
2026-02-20T22:09:11.0682935Z +        "default": {"min": 1, "max": 10},
2026-02-20T22:09:11.0683545Z      },
2026-02-20T22:09:11.0683867Z      DifficultyLevels.PADAWAN: {
2026-02-20T22:09:11.0684384Z          ExerciseTypes.ADDITION: {"min": 10, "max": 50},
2026-02-20T22:09:11.0685119Z          ExerciseTypes.SUBTRACTION: {"min1": 20, "max1": 70, "min2": 10, "max2": 20},
2026-02-20T22:09:11.0685927Z          ExerciseTypes.MULTIPLICATION: {"min": 5, "max": 10},
2026-02-20T22:09:11.0686816Z -        ExerciseTypes.DIVISION: {"min_divisor": 2, "max_divisor": 10, "min_result": 5, "max_result": 10},
2026-02-20T22:09:11.0687651Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0688092Z +            "min_divisor": 2,
2026-02-20T22:09:11.0688502Z +            "max_divisor": 10,
2026-02-20T22:09:11.0688909Z +            "min_result": 5,
2026-02-20T22:09:11.0689593Z +            "max_result": 10,
2026-02-20T22:09:11.0689963Z +        },
2026-02-20T22:09:11.0690408Z          ExerciseTypes.MIXTE: {"min": 5, "max": 20, "operations": 2},
2026-02-20T22:09:11.0691034Z -        "default": {"min": 10, "max": 50}
2026-02-20T22:09:11.0691501Z +        "default": {"min": 10, "max": 50},
2026-02-20T22:09:11.0692186Z      },
2026-02-20T22:09:11.0692506Z      DifficultyLevels.CHEVALIER: {
2026-02-20T22:09:11.0693216Z          ExerciseTypes.ADDITION: {"min": 50, "max": 200},
2026-02-20T22:09:11.0693983Z          ExerciseTypes.SUBTRACTION: {"min1": 100, "max1": 250, "min2": 50, "max2": 100},
2026-02-20T22:09:11.0694808Z          ExerciseTypes.MULTIPLICATION: {"min": 10, "max": 20},
2026-02-20T22:09:11.0695721Z -        ExerciseTypes.DIVISION: {"min_divisor": 5, "max_divisor": 15, "min_result": 8, "max_result": 20},
2026-02-20T22:09:11.0696558Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0697006Z +            "min_divisor": 5,
2026-02-20T22:09:11.0697407Z +            "max_divisor": 15,
2026-02-20T22:09:11.0697808Z +            "min_result": 8,
2026-02-20T22:09:11.0698192Z +            "max_result": 20,
2026-02-20T22:09:11.0698560Z +        },
2026-02-20T22:09:11.0699029Z          ExerciseTypes.MIXTE: {"min": 10, "max": 50, "operations": 3},
2026-02-20T22:09:11.0699648Z -        "default": {"min": 50, "max": 200}
2026-02-20T22:09:11.0700122Z +        "default": {"min": 50, "max": 200},
2026-02-20T22:09:11.0700546Z      },
2026-02-20T22:09:11.0700873Z      DifficultyLevels.MAITRE: {
2026-02-20T22:09:11.0701366Z          ExerciseTypes.ADDITION: {"min": 200, "max": 1000},
2026-02-20T22:09:11.0702148Z -        ExerciseTypes.SUBTRACTION: {"min1": 250, "max1": 1000, "min2": 100, "max2": 500},
2026-02-20T22:09:11.0702908Z +        ExerciseTypes.SUBTRACTION: {
2026-02-20T22:09:11.0703545Z +            "min1": 250,
2026-02-20T22:09:11.0703921Z +            "max1": 1000,
2026-02-20T22:09:11.0704272Z +            "min2": 100,
2026-02-20T22:09:11.0704637Z +            "max2": 500,
2026-02-20T22:09:11.0706247Z +        },
2026-02-20T22:09:11.0706684Z          ExerciseTypes.MULTIPLICATION: {"min": 20, "max": 50},
2026-02-20T22:09:11.0707597Z -        ExerciseTypes.DIVISION: {"min_divisor": 10, "max_divisor": 30, "min_result": 10, "max_result": 50},
2026-02-20T22:09:11.0719348Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0719857Z +            "min_divisor": 10,
2026-02-20T22:09:11.0720267Z +            "max_divisor": 30,
2026-02-20T22:09:11.0720660Z +            "min_result": 10,
2026-02-20T22:09:11.0721049Z +            "max_result": 50,
2026-02-20T22:09:11.0721409Z +        },
2026-02-20T22:09:11.0725728Z          ExerciseTypes.MIXTE: {"min": 20, "max": 100, "operations": 4},
2026-02-20T22:09:11.0726460Z -        "default": {"min": 200, "max": 1000}
2026-02-20T22:09:11.0726954Z +        "default": {"min": 200, "max": 1000},
2026-02-20T22:09:11.0727394Z      },
2026-02-20T22:09:11.0727715Z      DifficultyLevels.GRAND_MAITRE: {
2026-02-20T22:09:11.0728301Z          ExerciseTypes.ADDITION: {"min": 1000, "max": 10000},
2026-02-20T22:09:11.0729125Z -        ExerciseTypes.SUBTRACTION: {"min1": 1000, "max1": 10000, "min2": 500, "max2": 5000},
2026-02-20T22:09:11.0729903Z +        ExerciseTypes.SUBTRACTION: {
2026-02-20T22:09:11.0730343Z +            "min1": 1000,
2026-02-20T22:09:11.0730713Z +            "max1": 10000,
2026-02-20T22:09:11.0731084Z +            "min2": 500,
2026-02-20T22:09:11.0731426Z +            "max2": 5000,
2026-02-20T22:09:11.0731768Z +        },
2026-02-20T22:09:11.0732197Z          ExerciseTypes.MULTIPLICATION: {"min": 50, "max": 200},
2026-02-20T22:09:11.0733353Z -        ExerciseTypes.DIVISION: {"min_divisor": 20, "max_divisor": 100, "min_result": 50, "max_result": 200},
2026-02-20T22:09:11.0734255Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0734700Z +            "min_divisor": 20,
2026-02-20T22:09:11.0735109Z +            "max_divisor": 100,
2026-02-20T22:09:11.0735519Z +            "min_result": 50,
2026-02-20T22:09:11.0736200Z +            "max_result": 200,
2026-02-20T22:09:11.0736569Z +        },
2026-02-20T22:09:11.0737044Z          ExerciseTypes.MIXTE: {"min": 100, "max": 1000, "operations": 5},
2026-02-20T22:09:11.0737713Z -        "default": {"min": 1000, "max": 10000}
2026-02-20T22:09:11.0738163Z -    }
2026-02-20T22:09:11.0738495Z +        "default": {"min": 1000, "max": 10000},
2026-02-20T22:09:11.0739176Z +    },
2026-02-20T22:09:11.0739472Z  }
2026-02-20T22:09:11.0739726Z +
2026-02-20T22:09:11.0739984Z  
2026-02-20T22:09:11.0740268Z  # Tags pour les exercices
2026-02-20T22:09:11.0740640Z  class Tags:
2026-02-20T22:09:11.0740963Z      ALGORITHMIC = "algorithmique"
2026-02-20T22:09:11.0741369Z      AI = "ia"
2026-02-20T22:09:11.0741668Z @@ -267,35 +415,40 @@
2026-02-20T22:09:11.0742025Z      FRACTIONS = "fractions"
2026-02-20T22:09:11.0742417Z      GEOMETRY = "geometrie"
2026-02-20T22:09:11.0742787Z      LOGIC = "logique"
2026-02-20T22:09:11.0743394Z      PROBLEM_SOLVING = "resolution-probleme"
2026-02-20T22:09:11.0743851Z  
2026-02-20T22:09:11.0744112Z +
2026-02-20T22:09:11.0744676Z  # Messages et préfixes spécifiques
2026-02-20T22:09:11.0745135Z  class Messages:
2026-02-20T22:09:11.0745492Z      AI_EXERCISE_PREFIX = "TEST-ZAXXON"
2026-02-20T22:09:11.0745997Z      DEFAULT_ERROR = "Une erreur est survenue."
2026-02-20T22:09:11.0746629Z      DEFAULT_SUCCESS = "Opération réussie."
2026-02-20T22:09:11.0747097Z  
2026-02-20T22:09:11.0747361Z +
2026-02-20T22:09:11.0747776Z  # Paramètres de pagination
2026-02-20T22:09:11.0748179Z  class PaginationConfig:
2026-02-20T22:09:11.0748551Z      DEFAULT_PAGE_SIZE = 10
2026-02-20T22:09:11.0748906Z      MAX_PAGE_SIZE = 50
2026-02-20T22:09:11.0749251Z      DEFAULT_PAGE = 1
2026-02-20T22:09:11.0749581Z +
2026-02-20T22:09:11.0749831Z  
2026-02-20T22:09:11.0750218Z  # Paramètres de journalisation
2026-02-20T22:09:11.0750629Z  class LoggingLevels:
2026-02-20T22:09:11.0750968Z      DEBUG = "DEBUG"
2026-02-20T22:09:11.0751280Z      INFO = "INFO"
2026-02-20T22:09:11.0751624Z      WARNING = "WARNING"
2026-02-20T22:09:11.0751984Z      ERROR = "ERROR"
2026-02-20T22:09:11.0752322Z      CRITICAL = "CRITICAL"
2026-02-20T22:09:11.0752685Z  
2026-02-20T22:09:11.0752936Z +
2026-02-20T22:09:11.0753542Z  # Configuration de sécurité
2026-02-20T22:09:11.0753949Z  class SecurityConfig:
2026-02-20T22:09:11.0756844Z      TOKEN_EXPIRY_MINUTES = 60 * 24 * 7  # 7 jours (pour compatibilité)
2026-02-20T22:09:11.0763596Z      ALGORITHM = "HS256"
2026-02-20T22:09:11.0764008Z -    
2026-02-20T22:09:11.0764285Z +
2026-02-20T22:09:11.0766282Z +
2026-02-20T22:09:11.0766598Z  # Statut des exercices
2026-02-20T22:09:11.0766976Z  class ExerciseStatus:
2026-02-20T22:09:11.0767340Z      ACTIVE = True
2026-02-20T22:09:11.0767670Z      INACTIVE = False
2026-02-20T22:09:11.0768030Z      ARCHIVED = True
2026-02-20T22:09:11.0768363Z @@ -306,67 +459,84 @@
2026-02-20T22:09:11.0769011Z  # CHALLENGES - Constantes centralisées (Phase 3, Nov 2025)
2026-02-20T22:09:11.0769596Z  # ============================================================================
2026-02-20T22:09:11.0770024Z  
2026-02-20T22:09:11.0770278Z  # Types de challenges (PostgreSQL ENUM)
2026-02-20T22:09:11.0770660Z  CHALLENGE_TYPES_DB = [
2026-02-20T22:09:11.0771033Z -    'SEQUENCE', 'PATTERN', 'VISUAL', 'PUZZLE', 'GRAPH', 
2026-02-20T22:09:11.0771551Z -    'RIDDLE', 'DEDUCTION', 'CHESS', 'CODING', 'PROBABILITY'
2026-02-20T22:09:11.0771993Z +    "SEQUENCE",
2026-02-20T22:09:11.0772251Z +    "PATTERN",
2026-02-20T22:09:11.0772510Z +    "VISUAL",
2026-02-20T22:09:11.0772763Z +    "PUZZLE",
2026-02-20T22:09:11.0773240Z +    "GRAPH",
2026-02-20T22:09:11.0773489Z +    "RIDDLE",
2026-02-20T22:09:11.0773753Z +    "DEDUCTION",
2026-02-20T22:09:11.0774026Z +    "CHESS",
2026-02-20T22:09:11.0774279Z +    "CODING",
2026-02-20T22:09:11.0774528Z +    "PROBABILITY",
2026-02-20T22:09:11.0774775Z  ]
2026-02-20T22:09:11.0774992Z  
2026-02-20T22:09:11.0775232Z  CHALLENGE_TYPES_API = [
2026-02-20T22:09:11.0775653Z -    'sequence', 'pattern', 'visual', 'puzzle', 'graph',
2026-02-20T22:09:11.0776499Z -    'riddle', 'deduction', 'chess', 'coding', 'probability'
2026-02-20T22:09:11.0776988Z +    "sequence",
2026-02-20T22:09:11.0777242Z +    "pattern",
2026-02-20T22:09:11.0777485Z +    "visual",
2026-02-20T22:09:11.0777708Z +    "puzzle",
2026-02-20T22:09:11.0777926Z +    "graph",
2026-02-20T22:09:11.0778133Z +    "riddle",
2026-02-20T22:09:11.0778547Z +    "deduction",
2026-02-20T22:09:11.0778820Z +    "chess",
2026-02-20T22:09:11.0779083Z +    "coding",
2026-02-20T22:09:11.0779374Z +    "probability",
2026-02-20T22:09:11.0779675Z  ]
2026-02-20T22:09:11.0779930Z  
2026-02-20T22:09:11.0780308Z  # Mapping pour la normalisation des types de challenge
2026-02-20T22:09:11.0780853Z  CHALLENGE_TYPE_ALIASES = {
2026-02-20T22:09:11.0781458Z -    'SEQUENCE': ['sequence', 'seq', 'suite', 'séquence'],
2026-02-20T22:09:11.0782035Z -    'PATTERN': ['pattern', 'motif', 'grille'],
2026-02-20T22:09:11.0782635Z -    'VISUAL': ['visual', 'visuel', 'spatial', 'forme', 'formes'],
2026-02-20T22:09:11.0783625Z -    'PUZZLE': ['puzzle', 'casse-tete', 'casse-tête'],
2026-02-20T22:09:11.0784375Z -    'GRAPH': ['graph', 'graphe', 'reseau', 'réseau', 'chemin'],
2026-02-20T22:09:11.0785070Z -    'RIDDLE': ['riddle', 'enigme', 'énigme'],
2026-02-20T22:09:11.0785803Z -    'DEDUCTION': ['deduction', 'déduction', 'logique', 'logic'],
2026-02-20T22:09:11.0786679Z -    'CHESS': ['chess', 'echecs', 'échecs', 'echiquier', 'échiquier'],
2026-02-20T22:09:11.0787508Z -    'CODING': ['coding', 'codage', 'crypto', 'cryptographie', 'labyrinthe', 'maze'],
2026-02-20T22:09:11.0793700Z -    'PROBABILITY': ['probability', 'probabilite', 'probabilité', 'proba', 'chance'],
2026-02-20T22:09:11.0794775Z +    "SEQUENCE": ["sequence", "seq", "suite", "séquence"],
2026-02-20T22:09:11.0795365Z +    "PATTERN": ["pattern", "motif", "grille"],
2026-02-20T22:09:11.0795953Z +    "VISUAL": ["visual", "visuel", "spatial", "forme", "formes"],
2026-02-20T22:09:11.0796730Z +    "PUZZLE": ["puzzle", "casse-tete", "casse-tête"],
2026-02-20T22:09:11.0797513Z +    "GRAPH": ["graph", "graphe", "reseau", "réseau", "chemin"],
2026-02-20T22:09:11.0798209Z +    "RIDDLE": ["riddle", "enigme", "énigme"],
2026-02-20T22:09:11.0798914Z +    "DEDUCTION": ["deduction", "déduction", "logique", "logic"],
2026-02-20T22:09:11.0799779Z +    "CHESS": ["chess", "echecs", "échecs", "echiquier", "échiquier"],
2026-02-20T22:09:11.0800612Z +    "CODING": ["coding", "codage", "crypto", "cryptographie", "labyrinthe", "maze"],
2026-02-20T22:09:11.0801701Z +    "PROBABILITY": ["probability", "probabilite", "probabilité", "proba", "chance"],
2026-02-20T22:09:11.0802417Z  }
2026-02-20T22:09:11.0802684Z  
2026-02-20T22:09:11.0802943Z  
2026-02-20T22:09:11.0803647Z  def normalize_challenge_type(challenge_type):
2026-02-20T22:09:11.0804124Z      """
2026-02-20T22:09:11.0804571Z      Normalise le type de challenge vers le format DB (MAJUSCULE).
2026-02-20T22:09:11.0805134Z -    
2026-02-20T22:09:11.0805423Z +
2026-02-20T22:09:11.0805673Z      Args:
2026-02-20T22:09:11.0806439Z          challenge_type: Le type de challenge en entrée (peut être dans différents formats)
2026-02-20T22:09:11.0807188Z -        
2026-02-20T22:09:11.0807488Z +
2026-02-20T22:09:11.0807742Z      Returns:
2026-02-20T22:09:11.0808483Z          Le type de challenge normalisé en majuscule (ex: "SEQUENCE", "PATTERN", etc.)
2026-02-20T22:09:11.0809230Z          ou None si le type n'est pas reconnu
2026-02-20T22:09:11.0809694Z      """
2026-02-20T22:09:11.0810004Z      if not challenge_type:
2026-02-20T22:09:11.0810380Z          return None
2026-02-20T22:09:11.0810703Z  
2026-02-20T22:09:11.0811111Z      challenge_type_str = str(challenge_type).lower().strip()
2026-02-20T22:09:11.0811662Z -    
2026-02-20T22:09:11.0811934Z +
2026-02-20T22:09:11.0812457Z      # Vérifier correspondance directe avec les types API
2026-02-20T22:09:11.0813367Z      if challenge_type_str in CHALLENGE_TYPES_API:
2026-02-20T22:09:11.0815969Z          return challenge_type_str.upper()
2026-02-20T22:09:11.0817623Z -    
2026-02-20T22:09:11.0817984Z +
2026-02-20T22:09:11.0820093Z      # Vérifier correspondance directe avec les types DB
2026-02-20T22:09:11.0822498Z      if challenge_type_str.upper() in CHALLENGE_TYPES_DB:
2026-02-20T22:09:11.0854338Z          return challenge_type_str.upper()
2026-02-20T22:09:11.0854778Z -    
2026-02-20T22:09:11.0855071Z +
2026-02-20T22:09:11.0855371Z      # Parcourir tous les alias
2026-02-20T22:09:11.0856145Z      for type_key, aliases in CHALLENGE_TYPE_ALIASES.items():
2026-02-20T22:09:11.0856704Z          for alias in aliases:
2026-02-20T22:09:11.0857151Z              if challenge_type_str == alias.lower():
2026-02-20T22:09:11.0857627Z                  return type_key
2026-02-20T22:09:11.0857990Z -    
2026-02-20T22:09:11.0858250Z +
2026-02-20T22:09:11.0858500Z      # Type non reconnu
2026-02-20T22:09:11.0859007Z      logger.warning(f"Type de challenge non reconnu: '{challenge_type}'")
2026-02-20T22:09:11.0859570Z      return None
2026-02-20T22:09:11.0859862Z +
2026-02-20T22:09:11.0860100Z  
2026-02-20T22:09:11.0861082Z  # Groupes d'âge pour les challenges (valeurs ENUM PostgreSQL, alignées avec app.models.logic_challenge.AgeGroup)
2026-02-20T22:09:11.0862054Z  AGE_GROUPS_DB = [e.value for e in AgeGroup]
2026-02-20T22:09:11.0862495Z  
2026-02-20T22:09:11.0863228Z  # AGE_GROUP_MAPPING (These are effectively replicated now in AgeGroups.AGE_ALIASES)
2026-02-20T22:09:11.0863935Z @@ -384,6 +554,6 @@
2026-02-20T22:09:11.0864587Z  # DIFFICULTY_BY_AGE_GROUP is still used in generate_ai_challenge_stream in challenge_handlers.py
2026-02-20T22:09:11.0865415Z  # So I should keep it as is, or clarify its role.
2026-02-20T22:09:11.0865873Z  
2026-02-20T22:09:11.0866841Z  # Les fonctions normalize_challenge_type et normalize_age_group sont définies ci-dessus et utilisées pour les challenges
2026-02-20T22:09:11.0867768Z  
2026-02-20T22:09:11.0868217Z -# Remove the import of DifficultyLevel, as it's no longer used here.
2026-02-20T22:09:11.0868833Z \ No newline at end of file
2026-02-20T22:09:11.0869380Z +# Remove the import of DifficultyLevel, as it's no longer used here.
2026-02-20T22:09:11.0870390Z would reformat /home/runner/work/mathakine/mathakine/app/db/init_db.py
2026-02-20T22:09:11.0871229Z would reformat /home/runner/work/mathakine/mathakine/app/core/messages.py
2026-02-20T22:09:11.0872056Z would reformat /home/runner/work/mathakine/mathakine/app/db/adapter.py
2026-02-20T22:09:11.0873184Z --- /home/runner/work/mathakine/mathakine/app/db/init_db.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0874233Z +++ /home/runner/work/mathakine/mathakine/app/db/init_db.py	2026-02-20 22:09:11.069620+00:00
2026-02-20T22:09:11.0874937Z @@ -1,32 +1,34 @@
2026-02-20T22:09:11.0875317Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.0875768Z  
2026-02-20T22:09:11.0876050Z  logger = get_logger(__name__)
2026-02-20T22:09:11.0876404Z  
2026-02-20T22:09:11.0876702Z  from app.db.base import Base, engine
2026-02-20T22:09:11.0877094Z +
2026-02-20T22:09:11.0877724Z  # Importer les modèles pour assurer qu'ils sont enregistrés par SQLAlchemy
2026-02-20T22:09:11.0878563Z  from app.models.all_models import __all__ as models  # Import all models
2026-02-20T22:09:11.0879401Z  from app.services.db_init_service import create_tables, populate_test_data
2026-02-20T22:09:11.0880024Z  
2026-02-20T22:09:11.0880257Z  
2026-02-20T22:09:11.0880538Z  def create_tables_with_test_data():
2026-02-20T22:09:11.0881337Z      """Crée toutes les tables définies dans les modèles et ajoute des données de test.
2026-02-20T22:09:11.0882000Z -    
2026-02-20T22:09:11.0882250Z +
2026-02-20T22:09:11.0882906Z      ATTENTION : Cette fonction ne doit être appelée que dans un contexte de test (CI)
2026-02-20T22:09:11.0883975Z      ou pour initialiser une base de développement vide.
2026-02-20T22:09:11.0884525Z      Ne JAMAIS appeler en production.
2026-02-20T22:09:11.0884926Z      """
2026-02-20T22:09:11.0885186Z      import os
2026-02-20T22:09:11.0885474Z +
2026-02-20T22:09:11.0885927Z      logger.info("Initialisation de la base de données")
2026-02-20T22:09:11.0886767Z      try:
2026-02-20T22:09:11.0887575Z          # Créer les tables
2026-02-20T22:09:11.0888045Z          create_tables()
2026-02-20T22:09:11.0888616Z  
2026-02-20T22:09:11.0889449Z          # Ajouter des données de test UNIQUEMENT si TESTING=true ou base vide en dev
2026-02-20T22:09:11.0890347Z          is_testing = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:11.0891477Z          environment = os.getenv("ENVIRONMENT", "development")
2026-02-20T22:09:11.0892074Z -        
2026-02-20T22:09:11.0892482Z +
2026-02-20T22:09:11.0892889Z          if is_testing:
2026-02-20T22:09:11.0893965Z              logger.info("Mode test détecté : ajout des données de test")
2026-02-20T22:09:11.0894702Z              populate_test_data()
2026-02-20T22:09:11.0895293Z          elif environment != "production":
2026-02-20T22:09:11.0896253Z              logger.info("Mode développement : ajout des données de test si base vide")
2026-02-20T22:09:11.0919100Z --- /home/runner/work/mathakine/mathakine/app/core/messages.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0920271Z +++ /home/runner/work/mathakine/mathakine/app/core/messages.py	2026-02-20 22:09:11.060955+00:00
2026-02-20T22:09:11.0921036Z @@ -16,23 +16,24 @@
2026-02-20T22:09:11.0921597Z      ERROR_PERMISSION_DENIED = "Permission refusée"
2026-02-20T22:09:11.0922252Z      ERROR_INVALID_REQUEST = "Requête invalide"
2026-02-20T22:09:11.0923162Z      ERROR_NOT_IMPLEMENTED = "Fonctionnalité non implémentée"
2026-02-20T22:09:11.0923922Z      ERROR_RESOURCE_NOT_FOUND = "Ressource non trouvée"
2026-02-20T22:09:11.0924561Z      ERROR_DATABASE = "Erreur de base de données"
2026-02-20T22:09:11.0925015Z -    
2026-02-20T22:09:11.0925277Z +
2026-02-20T22:09:11.0925591Z      # Succès
2026-02-20T22:09:11.0926076Z      SUCCESS_OPERATION_COMPLETED = "Opération réussie"
2026-02-20T22:09:11.0926737Z      SUCCESS_CREATED = "Ressource créée avec succès"
2026-02-20T22:09:11.0927421Z      SUCCESS_UPDATED = "Ressource mise à jour avec succès"
2026-02-20T22:09:11.0928121Z      SUCCESS_DELETED = "Ressource supprimée avec succès"
2026-02-20T22:09:11.0928833Z      SUCCESS_ARCHIVED = "Exercice archivé avec succès"
2026-02-20T22:09:11.0929307Z -    
2026-02-20T22:09:11.0929573Z +
2026-02-20T22:09:11.0929840Z      # Messages d'information
2026-02-20T22:09:11.0930550Z      INFO_TRYING_CONNECTION = "Tentative de connexion à la base de données"
2026-02-20T22:09:11.0931379Z      INFO_APP_STARTING = "Démarrage de l'application"
2026-02-20T22:09:11.0931979Z      INFO_APP_READY = "Application prête"
2026-02-20T22:09:11.0932573Z      INFO_APP_STOPPING = "Arrêt de l'application"
2026-02-20T22:09:11.0933260Z +
2026-02-20T22:09:11.0933520Z  
2026-02-20T22:09:11.0933877Z  # Messages liés aux exercices
2026-02-20T22:09:11.0934280Z  class ExerciseMessages:
2026-02-20T22:09:11.0934639Z      # Titres des exercices
2026-02-20T22:09:11.0935038Z      TITLE_ADDITION = "Addition galactique"
2026-02-20T22:09:11.0935459Z @@ -42,75 +43,117 @@
2026-02-20T22:09:11.0935852Z      TITLE_FRACTIONS = "Fractions de l'hyperespace"
2026-02-20T22:09:11.0936534Z      TITLE_GEOMETRIE = "Géométrie des constellations"
2026-02-20T22:09:11.0937126Z      TITLE_DIVERS = "Défi mathématique"
2026-02-20T22:09:11.0937671Z      TITLE_DEFAULT = "Exercice mathématique"
2026-02-20T22:09:11.0938122Z      TITLE_AI_PREFIX = "TEST-ZAXXON"
2026-02-20T22:09:11.0938512Z -    
2026-02-20T22:09:11.0938788Z +
2026-02-20T22:09:11.0939132Z      # Messages de résultats
2026-02-20T22:09:11.0939766Z      RESULT_CORRECT = "Excellent travail ! Ta réponse est correcte."
2026-02-20T22:09:11.0940553Z      RESULT_INCORRECT = "Pas tout à fait ! Essaie encore."
2026-02-20T22:09:11.0941093Z      RESULT_HINT = "Indice: {hint}"
2026-02-20T22:09:11.0941473Z -    
2026-02-20T22:09:11.0941727Z +
2026-02-20T22:09:11.0941983Z      # Questions types
2026-02-20T22:09:11.0942386Z      QUESTION_ADDITION = "Calcule {num1} + {num2}"
2026-02-20T22:09:11.0943235Z      QUESTION_SUBTRACTION = "Calcule {num1} - {num2}"
2026-02-20T22:09:11.0943954Z      QUESTION_MULTIPLICATION = "Calcule {num1} × {num2}"
2026-02-20T22:09:11.0944887Z      QUESTION_DIVISION = "Calcule {num1} ÷ {num2}"
2026-02-20T22:09:11.0945553Z      QUESTION_FRACTIONS = "Calcule {num1}/{num2} {operation} {num3}/{num4}"
2026-02-20T22:09:11.0946579Z      QUESTION_GEOMETRIE = "Calcule le {property} du {shape} avec {parameter1}={value1} et {parameter2}={value2}"
2026-02-20T22:09:11.0947647Z      QUESTION_DIVERS = "{problem}"
2026-02-20T22:09:11.0948031Z -    
2026-02-20T22:09:11.0948281Z +
2026-02-20T22:09:11.0948630Z      # Textes éducatifs
2026-02-20T22:09:11.0949049Z      EXPLANATION_ADDITION = "{num1} + {num2} = {result}"
2026-02-20T22:09:11.0949647Z      EXPLANATION_SUBTRACTION = "{num1} - {num2} = {result}"
2026-02-20T22:09:11.0950338Z      EXPLANATION_MULTIPLICATION = "{num1} × {num2} = {result}"
2026-02-20T22:09:11.0951058Z      EXPLANATION_DIVISION = "{num1} ÷ {num2} = {result}"
2026-02-20T22:09:11.0952225Z      EXPLANATION_FRACTIONS = "Pour calculer {num1}/{num2} {operation} {num3}/{num4}, il faut {steps}. Le résultat est {result}."
2026-02-20T22:09:11.0954170Z      EXPLANATION_GEOMETRIE = "Pour calculer le {property} du {shape}, on utilise la formule: {formula}. Avec {parameter1}={value1} et {parameter2}={value2}, on obtient {result}."
2026-02-20T22:09:11.0955919Z -    EXPLANATION_DIVERS = "Voici comment résoudre ce problème: {steps}. La réponse est {result}."
2026-02-20T22:09:11.0956713Z -    
2026-02-20T22:09:11.0957015Z +    EXPLANATION_DIVERS = (
2026-02-20T22:09:11.0957745Z +        "Voici comment résoudre ce problème: {steps}. La réponse est {result}."
2026-02-20T22:09:11.0958358Z +    )
2026-02-20T22:09:11.0958621Z +
2026-02-20T22:09:11.0958863Z      # Tags
2026-02-20T22:09:11.0959205Z      TAGS_ALGORITHMIC = "algorithmique,simple"
2026-02-20T22:09:11.0959687Z      TAGS_AI = "ia,generatif,starwars"
2026-02-20T22:09:11.0960086Z -    
2026-02-20T22:09:11.0960329Z +
2026-02-20T22:09:11.0960644Z      # Réponses
2026-02-20T22:09:11.0961177Z      SUCCESS_ANSWER_CORRECT = "Bravo ! Ta réponse est correcte."
2026-02-20T22:09:11.0961915Z      ERROR_ANSWER_INCORRECT = "Ce n'est pas correct. Essaie encore !"
2026-02-20T22:09:11.0962475Z -    
2026-02-20T22:09:11.0962720Z +
2026-02-20T22:09:11.0963198Z      # Création
2026-02-20T22:09:11.0963716Z      SUCCESS_EXERCISE_CREATED = "Exercice créé avec succès"
2026-02-20T22:09:11.0964525Z      ERROR_EXERCISE_CREATION = "Erreur lors de la création de l'exercice"
2026-02-20T22:09:11.0965118Z -    
2026-02-20T22:09:11.0965377Z +
2026-02-20T22:09:11.0965633Z      # Autres messages
2026-02-20T22:09:11.0966114Z      INFO_EXERCISE_SUBMITTED = "Réponse soumise"
2026-02-20T22:09:11.0966711Z      INFO_EXERCISE_COMPLETE = "Exercice terminé"
2026-02-20T22:09:11.0967289Z      INFO_EXERCISE_SKIPPED = "Exercice passé"
2026-02-20T22:09:11.0967718Z  
2026-02-20T22:09:11.0967959Z +
2026-02-20T22:09:11.0968488Z  # Éléments narratifs Star Wars pour les exercices générés par IA
2026-02-20T22:09:11.0969068Z  class StarWarsNarratives:
2026-02-20T22:09:11.0969494Z      # Personnages Star Wars pour les contextes
2026-02-20T22:09:11.0969957Z      CHARACTERS = [
2026-02-20T22:09:11.0970622Z -        "Luke Skywalker", "Princesse Leia", "Han Solo", "Chewbacca", "Maître Yoda", 
2026-02-20T22:09:11.0971398Z -        "Obi-Wan Kenobi", "R2-D2", "C-3PO", "Darth Vader", "Rey", 
2026-02-20T22:09:11.0972149Z -        "Kylo Ren", "BB-8", "Finn", "Poe Dameron", "Padmé Amidala", 
2026-02-20T22:09:11.0972887Z -        "Qui-Gon Jinn", "Mace Windu", "Ahsoka Tano", "Boba Fett", "Le Mandalorien"
2026-02-20T22:09:11.0973685Z +        "Luke Skywalker",
2026-02-20T22:09:11.0974051Z +        "Princesse Leia",
2026-02-20T22:09:11.0974387Z +        "Han Solo",
2026-02-20T22:09:11.0974701Z +        "Chewbacca",
2026-02-20T22:09:11.0975076Z +        "Maître Yoda",
2026-02-20T22:09:11.0975405Z +        "Obi-Wan Kenobi",
2026-02-20T22:09:11.0975724Z +        "R2-D2",
2026-02-20T22:09:11.0976001Z +        "C-3PO",
2026-02-20T22:09:11.0976314Z +        "Darth Vader",
2026-02-20T22:09:11.0976634Z +        "Rey",
2026-02-20T22:09:11.0976930Z +        "Kylo Ren",
2026-02-20T22:09:11.0977522Z +        "BB-8",
2026-02-20T22:09:11.0977848Z +        "Finn",
2026-02-20T22:09:11.0978146Z +        "Poe Dameron",
2026-02-20T22:09:11.0978599Z +        "Padmé Amidala",
2026-02-20T22:09:11.0978964Z +        "Qui-Gon Jinn",
2026-02-20T22:09:11.0979307Z +        "Mace Windu",
2026-02-20T22:09:11.0979637Z +        "Ahsoka Tano",
2026-02-20T22:09:11.0980216Z +        "Boba Fett",
2026-02-20T22:09:11.0980541Z +        "Le Mandalorien",
2026-02-20T22:09:11.0980877Z      ]
2026-02-20T22:09:11.0981137Z -    
2026-02-20T22:09:11.0981398Z +
2026-02-20T22:09:11.0981654Z      # Objets Star Wars
2026-02-20T22:09:11.0981993Z      OBJECTS = [
2026-02-20T22:09:11.0982685Z -        "sabres laser", "vaisseaux", "blasters", "droïdes", "cristaux kyber", 
2026-02-20T22:09:11.0984028Z -        "pièces détachées", "crédits galactiques", "hologrammes", "speeders", "chasseurs X-wing", 
2026-02-20T22:09:11.0985057Z -        "chasseurs TIE", "grenades thermiques", "jetpacks", "casques de stormtrooper"
2026-02-20T22:09:11.0985779Z +        "sabres laser",
2026-02-20T22:09:11.0986142Z +        "vaisseaux",
2026-02-20T22:09:11.0986469Z +        "blasters",
2026-02-20T22:09:11.0986874Z +        "droïdes",
2026-02-20T22:09:11.0987211Z +        "cristaux kyber",
2026-02-20T22:09:11.0987671Z +        "pièces détachées",
2026-02-20T22:09:11.0988139Z +        "crédits galactiques",
2026-02-20T22:09:11.0988536Z +        "hologrammes",
2026-02-20T22:09:11.0988877Z +        "speeders",
2026-02-20T22:09:11.0989212Z +        "chasseurs X-wing",
2026-02-20T22:09:11.0989587Z +        "chasseurs TIE",
2026-02-20T22:09:11.0989949Z +        "grenades thermiques",
2026-02-20T22:09:11.0990338Z +        "jetpacks",
2026-02-20T22:09:11.0990678Z +        "casques de stormtrooper",
2026-02-20T22:09:11.0991087Z      ]
2026-02-20T22:09:11.0991359Z -    
2026-02-20T22:09:11.0991640Z +
2026-02-20T22:09:11.0991919Z      # Lieux Star Wars
2026-02-20T22:09:11.0992255Z      LOCATIONS = [
2026-02-20T22:09:11.0992678Z -        "Tatooine", "Coruscant", "Endor", "Hoth", "Dagobah", 
2026-02-20T22:09:11.0993697Z -        "Naboo", "Mustafar", "Alderaan", "Jakku", "Exegol", 
2026-02-20T22:09:11.0994719Z -        "Cantina de Mos Eisley", "Temple Jedi", "l'Étoile de la Mort", "la Base Starkiller", "Geonosis"
2026-02-20T22:09:11.0995462Z +        "Tatooine",
2026-02-20T22:09:11.0995781Z +        "Coruscant",
2026-02-20T22:09:11.0996099Z +        "Endor",
2026-02-20T22:09:11.0996388Z +        "Hoth",
2026-02-20T22:09:11.0996678Z +        "Dagobah",
2026-02-20T22:09:11.0996980Z +        "Naboo",
2026-02-20T22:09:11.0997103Z +        "Mustafar",
2026-02-20T22:09:11.0997231Z +        "Alderaan",
2026-02-20T22:09:11.0997343Z +        "Jakku",
2026-02-20T22:09:11.0997455Z +        "Exegol",
2026-02-20T22:09:11.0997601Z +        "Cantina de Mos Eisley",
2026-02-20T22:09:11.0997733Z +        "Temple Jedi",
2026-02-20T22:09:11.0997969Z +        "l'Étoile de la Mort",
2026-02-20T22:09:11.0998110Z +        "la Base Starkiller",
2026-02-20T22:09:11.0998258Z +        "Geonosis",
2026-02-20T22:09:11.0998366Z      ]
2026-02-20T22:09:11.0998475Z -    
2026-02-20T22:09:11.0998592Z +
2026-02-20T22:09:11.0999022Z      # Préfixes pour les explications - OPTIMISÉS par difficulté
2026-02-20T22:09:11.0999178Z      EXPLANATION_PREFIXES = {
2026-02-20T22:09:11.0999296Z          "INITIE": [
2026-02-20T22:09:11.0999634Z              "Jeune Padawan, comme l'enseigne Maître Yoda :",
2026-02-20T22:09:11.1000012Z              "Dans tes premiers pas vers la maîtrise de la Force :",
2026-02-20T22:09:11.1000139Z @@ -140,13 +183,13 @@
2026-02-20T22:09:11.1000445Z              "Dans la sagesse millénaire de l'Ordre :",
2026-02-20T22:09:11.1000774Z              "Les grands stratèges galactiques enseignent :",
2026-02-20T22:09:11.1001046Z              "Face aux mystères de la Force :",
2026-02-20T22:09:11.1001375Z              "Dans les décisions qui façonnent la galaxie :",
2026-02-20T22:09:11.1001676Z              "Comme l'ont prouvé les anciens Maîtres :",
2026-02-20T22:09:11.1002054Z -        ]
2026-02-20T22:09:11.1002173Z +        ],
2026-02-20T22:09:11.1002289Z      }
2026-02-20T22:09:11.1002395Z -    
2026-02-20T22:09:11.1002501Z +
2026-02-20T22:09:11.1002945Z      # Conclusions pour les explications - OPTIMISÉES par difficulté
2026-02-20T22:09:11.1003370Z      EXPLANATION_SUFFIXES = {
2026-02-20T22:09:11.1003502Z          "INITIE": [
2026-02-20T22:09:11.1003907Z              "Continue ainsi, jeune Padawan !",
2026-02-20T22:09:11.1004119Z              "Tu progresses bien dans ta formation.",
2026-02-20T22:09:11.1004247Z @@ -176,13 +219,13 @@
2026-02-20T22:09:11.1004453Z              "Tu atteins les sommets de la connaissance.",
2026-02-20T22:09:11.1004773Z              "Même Yoda approuverait ta maîtrise.",
2026-02-20T22:09:11.1005104Z              "Ta sagesse éclairera les générations futures.",
2026-02-20T22:09:11.1005304Z              "Tu incarnes l'excellence de l'Ordre Jedi.",
2026-02-20T22:09:11.1005526Z              "Que ta sagesse guide la galaxie vers la paix.",
2026-02-20T22:09:11.1005665Z -        ]
2026-02-20T22:09:11.1005777Z +        ],
2026-02-20T22:09:11.1005884Z      }
2026-02-20T22:09:11.1006001Z -    
2026-02-20T22:09:11.1006107Z +
2026-02-20T22:09:11.1006472Z      # Préfixes génériques (fallback pour compatibilité)
2026-02-20T22:09:11.1006643Z      EXPLANATION_PREFIXES_GENERIC = [
2026-02-20T22:09:11.1007403Z          "Dans l'univers Star Wars, il est important de partager équitablement les ressources, comme les armes laser.",
2026-02-20T22:09:11.1008106Z          "Les Jedi enseignent que la maîtrise des mathématiques est essentielle à l'équilibre de la Force.",
2026-02-20T22:09:11.1008678Z          "Comme le dit souvent Maître Yoda, 'Par les calculs, plus clair l'avenir devient.'",
2026-02-20T22:09:11.1008820Z @@ -190,13 +233,13 @@
2026-02-20T22:09:11.1009271Z          "Pour un futur Jedi, comprendre les nombres est aussi important que manier le sabre laser.",
2026-02-20T22:09:11.1009874Z          "La Résistance utilise quotidiennement ce type de calcul pour planifier ses missions.",
2026-02-20T22:09:11.1010602Z          "L'Ordre Jedi a toujours valorisé les connaissances mathématiques dans la formation des Padawans.",
2026-02-20T22:09:11.1011204Z          "Dans les archives du Temple Jedi, ce genre de problème est considéré comme fondamental.",
2026-02-20T22:09:11.1011859Z          "Qu'on soit du côté lumineux ou obscur de la Force, ces compétences mathématiques sont universelles.",
2026-02-20T22:09:11.1012524Z -        "Même les droïdes comme R2-D2 doivent maîtriser ces calculs pour naviguer dans l'hyperespace."
2026-02-20T22:09:11.1013326Z +        "Même les droïdes comme R2-D2 doivent maîtriser ces calculs pour naviguer dans l'hyperespace.",
2026-02-20T22:09:11.1013440Z      ]
2026-02-20T22:09:11.1013550Z -    
2026-02-20T22:09:11.1013645Z +
2026-02-20T22:09:11.1013964Z      # Suffixes génériques (fallback pour compatibilité)
2026-02-20T22:09:11.1014107Z      EXPLANATION_SUFFIXES_GENERIC = [
2026-02-20T22:09:11.1014471Z          "Cette compétence te rapproche du rang de Maître Jedi.",
2026-02-20T22:09:11.1014946Z          "En maîtrisant ces calculs, tu progresses sur le chemin de la Force.",
2026-02-20T22:09:11.1015355Z          "Que la Force des mathématiques soit avec toi, jeune Padawan.",
2026-02-20T22:09:11.1015492Z @@ -204,94 +247,165 @@
2026-02-20T22:09:11.1015744Z          "Ces connaissances te serviront dans toute la galaxie.",
2026-02-20T22:09:11.1016274Z          "Continue ainsi, et tu pourras bientôt construire ton propre sabre laser.",
2026-02-20T22:09:11.1016788Z          "La maîtrise de ces calculs te distingue des simples recrues de l'Empire.",
2026-02-20T22:09:11.1017272Z          "Même un Seigneur Sith serait impressionné par ta maîtrise des nombres.",
2026-02-20T22:09:11.1017674Z          "La Résistance a besoin de cerveaux brillants comme le tien.",
2026-02-20T22:09:11.1018170Z -        "Avec de telles compétences, même le Conseil Jedi pourrait te remarquer."
2026-02-20T22:09:11.1018670Z +        "Avec de telles compétences, même le Conseil Jedi pourrait te remarquer.",
2026-02-20T22:09:11.1019038Z      ]
2026-02-20T22:09:11.1019156Z  
2026-02-20T22:09:11.1019471Z      # Contextes spécialisés par type d'exercice
2026-02-20T22:09:11.1019619Z      CONTEXTS_BY_TYPE = {
2026-02-20T22:09:11.1019752Z          "ADDITION": {
2026-02-20T22:09:11.1020346Z -            "objects": ["cristaux Kyber", "vaisseaux rebelles", "droïdes", "soldats", "crédits"],
2026-02-20T22:09:11.1021028Z -            "actions": ["rejoignent", "s'allient", "se rassemblent", "fusionnent", "s'unissent"],
2026-02-20T22:09:11.1021441Z -            "locations": ["base rebelle", "cantina", "hangar", "temple Jedi", "station spatiale"]
2026-02-20T22:09:11.1021595Z +            "objects": [
2026-02-20T22:09:11.1021735Z +                "cristaux Kyber",
2026-02-20T22:09:11.1021890Z +                "vaisseaux rebelles",
2026-02-20T22:09:11.1022113Z +                "droïdes",
2026-02-20T22:09:11.1022250Z +                "soldats",
2026-02-20T22:09:11.1022444Z +                "crédits",
2026-02-20T22:09:11.1022581Z +            ],
2026-02-20T22:09:11.1022715Z +            "actions": [
2026-02-20T22:09:11.1022845Z +                "rejoignent",
2026-02-20T22:09:11.1023159Z +                "s'allient",
2026-02-20T22:09:11.1023303Z +                "se rassemblent",
2026-02-20T22:09:11.1023438Z +                "fusionnent",
2026-02-20T22:09:11.1023578Z +                "s'unissent",
2026-02-20T22:09:11.1023693Z +            ],
2026-02-20T22:09:11.1023826Z +            "locations": [
2026-02-20T22:09:11.1023959Z +                "base rebelle",
2026-02-20T22:09:11.1024082Z +                "cantina",
2026-02-20T22:09:11.1024212Z +                "hangar",
2026-02-20T22:09:11.1024350Z +                "temple Jedi",
2026-02-20T22:09:11.1024488Z +                "station spatiale",
2026-02-20T22:09:11.1024599Z +            ],
2026-02-20T22:09:11.1024712Z          },
2026-02-20T22:09:11.1024843Z          "SUBTRACTION": {
2026-02-20T22:09:11.1025257Z -            "objects": ["TIE Fighters", "stormtroopers", "ressources", "munitions", "vaisseaux"],
2026-02-20T22:09:11.1025922Z -            "actions": ["sont détruits", "désertent", "sont perdus", "sont confisqués", "disparaissent"],
2026-02-20T22:09:11.1026532Z -            "locations": ["bataille spatiale", "raid impérial", "mission secrète", "combat", "siège"]
2026-02-20T22:09:11.1026668Z +            "objects": [
2026-02-20T22:09:11.1026816Z +                "TIE Fighters",
2026-02-20T22:09:11.1026962Z +                "stormtroopers",
2026-02-20T22:09:11.1027085Z +                "ressources",
2026-02-20T22:09:11.1027213Z +                "munitions",
2026-02-20T22:09:11.1027342Z +                "vaisseaux",
2026-02-20T22:09:11.1027452Z +            ],
2026-02-20T22:09:11.1027575Z +            "actions": [
2026-02-20T22:09:11.1027803Z +                "sont détruits",
2026-02-20T22:09:11.1027989Z +                "désertent",
2026-02-20T22:09:11.1028120Z +                "sont perdus",
2026-02-20T22:09:11.1028332Z +                "sont confisqués",
2026-02-20T22:09:11.1028489Z +                "disparaissent",
2026-02-20T22:09:11.1028601Z +            ],
2026-02-20T22:09:11.1028731Z +            "locations": [
2026-02-20T22:09:11.1028883Z +                "bataille spatiale",
2026-02-20T22:09:11.1029096Z +                "raid impérial",
2026-02-20T22:09:11.1029311Z +                "mission secrète",
2026-02-20T22:09:11.1029451Z +                "combat",
2026-02-20T22:09:11.1029648Z +                "siège",
2026-02-20T22:09:11.1029766Z +            ],
2026-02-20T22:09:11.1029875Z          },
2026-02-20T22:09:11.1030018Z          "MULTIPLICATION": {
2026-02-20T22:09:11.1030505Z              "objects": ["escadrons", "bataillons", "flottes", "systèmes", "garnisons"],
2026-02-20T22:09:11.1031132Z -            "actions": ["se multiplient", "se déploient", "s'organisent", "se coordonnent", "s'étendent"],
2026-02-20T22:09:11.1031805Z -            "locations": ["secteur galactique", "front de guerre", "territoire", "zone d'influence", "région"]
2026-02-20T22:09:11.1032194Z +            "actions": [
2026-02-20T22:09:11.1032346Z +                "se multiplient",
2026-02-20T22:09:11.1032569Z +                "se déploient",
2026-02-20T22:09:11.1032708Z +                "s'organisent",
2026-02-20T22:09:11.1032839Z +                "se coordonnent",
2026-02-20T22:09:11.1033217Z +                "s'étendent",
2026-02-20T22:09:11.1033567Z +            ],
2026-02-20T22:09:11.1033702Z +            "locations": [
2026-02-20T22:09:11.1033851Z +                "secteur galactique",
2026-02-20T22:09:11.1033990Z +                "front de guerre",
2026-02-20T22:09:11.1034124Z +                "territoire",
2026-02-20T22:09:11.1034258Z +                "zone d'influence",
2026-02-20T22:09:11.1034472Z +                "région",
2026-02-20T22:09:11.1034594Z +            ],
2026-02-20T22:09:11.1034707Z          },
2026-02-20T22:09:11.1034834Z          "DIVISION": {
2026-02-20T22:09:11.1035434Z -            "objects": ["ressources", "troupes", "équipements", "territoires", "responsabilités"],
2026-02-20T22:09:11.1036109Z -            "actions": ["se répartissent", "se divisent", "se distribuent", "se partagent", "s'organisent"],
2026-02-20T22:09:11.1036616Z -            "locations": ["bases", "planètes", "secteurs", "commandements", "divisions"]
2026-02-20T22:09:11.1036742Z -        }
2026-02-20T22:09:11.1036880Z +            "objects": [
2026-02-20T22:09:11.1037020Z +                "ressources",
2026-02-20T22:09:11.1037134Z +                "troupes",
2026-02-20T22:09:11.1037346Z +                "équipements",
2026-02-20T22:09:11.1037480Z +                "territoires",
2026-02-20T22:09:11.1037706Z +                "responsabilités",
2026-02-20T22:09:11.1037822Z +            ],
2026-02-20T22:09:11.1037960Z +            "actions": [
2026-02-20T22:09:11.1038183Z +                "se répartissent",
2026-02-20T22:09:11.1038315Z +                "se divisent",
2026-02-20T22:09:11.1038460Z +                "se distribuent",
2026-02-20T22:09:11.1038594Z +                "se partagent",
2026-02-20T22:09:11.1038736Z +                "s'organisent",
2026-02-20T22:09:11.1038848Z +            ],
2026-02-20T22:09:11.1038988Z +            "locations": [
2026-02-20T22:09:11.1039107Z +                "bases",
2026-02-20T22:09:11.1039321Z +                "planètes",
2026-02-20T22:09:11.1039461Z +                "secteurs",
2026-02-20T22:09:11.1039597Z +                "commandements",
2026-02-20T22:09:11.1039739Z +                "divisions",
2026-02-20T22:09:11.1039861Z +            ],
2026-02-20T22:09:11.1039972Z +        },
2026-02-20T22:09:11.1040085Z      }
2026-02-20T22:09:11.1040194Z  
2026-02-20T22:09:11.1040323Z      @classmethod
2026-02-20T22:09:11.1040577Z      def get_explanation_prefix(cls, difficulty="PADAWAN"):
2026-02-20T22:09:11.1041030Z          """Récupère un préfixe d'explication adapté à la difficulté"""
2026-02-20T22:09:11.1041641Z -        prefixes = cls.EXPLANATION_PREFIXES.get(difficulty.upper(), cls.EXPLANATION_PREFIXES_GENERIC)
2026-02-20T22:09:11.1041846Z +        prefixes = cls.EXPLANATION_PREFIXES.get(
2026-02-20T22:09:11.1042127Z +            difficulty.upper(), cls.EXPLANATION_PREFIXES_GENERIC
2026-02-20T22:09:11.1042244Z +        )
2026-02-20T22:09:11.1042417Z          return random.choice(prefixes)
2026-02-20T22:09:11.1042530Z -    
2026-02-20T22:09:11.1042637Z +
2026-02-20T22:09:11.1042766Z      @classmethod
2026-02-20T22:09:11.1043216Z      def get_explanation_suffix(cls, difficulty="PADAWAN"):
2026-02-20T22:09:11.1043668Z          """Récupère un suffixe d'explication adapté à la difficulté"""
2026-02-20T22:09:11.1044178Z -        suffixes = cls.EXPLANATION_SUFFIXES.get(difficulty.upper(), cls.EXPLANATION_SUFFIXES_GENERIC)
2026-02-20T22:09:11.1044375Z +        suffixes = cls.EXPLANATION_SUFFIXES.get(
2026-02-20T22:09:11.1044625Z +            difficulty.upper(), cls.EXPLANATION_SUFFIXES_GENERIC
2026-02-20T22:09:11.1044740Z +        )
2026-02-20T22:09:11.1044905Z          return random.choice(suffixes)
2026-02-20T22:09:11.1045018Z +
2026-02-20T22:09:11.1045123Z  
2026-02-20T22:09:11.1045511Z  # Textes de l'interface
2026-02-20T22:09:11.1045649Z  class InterfaceTexts:
2026-02-20T22:09:11.1045847Z      # En-tête
2026-02-20T22:09:11.1045997Z      HEADER_TITLE = "Mathakine"
2026-02-20T22:09:11.1046159Z      HEADER_SUBTITLE = "L'API Rebelle"
2026-02-20T22:09:11.1046267Z -    
2026-02-20T22:09:11.1046373Z +
2026-02-20T22:09:11.1046734Z      # Menu principal
2026-02-20T22:09:11.1046873Z      MENU_HOME = "Accueil"
2026-02-20T22:09:11.1047023Z      MENU_EXERCISES = "Exercices"
2026-02-20T22:09:11.1047179Z      MENU_DASHBOARD = "Tableau de bord"
2026-02-20T22:09:11.1047342Z      MENU_NEW_EXERCISE = "Nouvel exercice"
2026-02-20T22:09:11.1047449Z -    
2026-02-20T22:09:11.1047557Z +
2026-02-20T22:09:11.1047687Z      # Page d'accueil
2026-02-20T22:09:11.1047846Z      HOME_TITLE = "Bienvenue sur Mathakine"
2026-02-20T22:09:11.1048382Z      HOME_SUBTITLE = "La plateforme d'entraînement mathématique pour les Padawans"
2026-02-20T22:09:11.1048692Z      HOME_START_BUTTON = "Commencer l'entraînement"
2026-02-20T22:09:11.1049019Z      HOME_DASHBOARD_BUTTON = "Consulter vos progrès"
2026-02-20T22:09:11.1049139Z -    
2026-02-20T22:09:11.1049246Z +
2026-02-20T22:09:11.1049386Z      # Page d'exercices
2026-02-20T22:09:11.1049670Z      EXERCISES_TITLE = "Bibliothèque d'exercices"
2026-02-20T22:09:11.1050076Z      EXERCISES_SUBTITLE = "Sélectionner un exercice pour commencer"
2026-02-20T22:09:11.1050305Z      EXERCISES_EMPTY = "Aucun exercice disponible"
2026-02-20T22:09:11.1050519Z      EXERCISES_FILTER_TITLE = "Filtrer les exercices"
2026-02-20T22:09:11.1050700Z      EXERCISES_FILTER_TYPE = "Type d'exercice"
2026-02-20T22:09:11.1051058Z      EXERCISES_FILTER_DIFFICULTY = "Niveau de difficulté"
2026-02-20T22:09:11.1051283Z      EXERCISES_FILTER_BUTTON = "Appliquer les filtres"
2026-02-20T22:09:11.1051653Z      EXERCISES_GENERATE_BUTTON = "Générer un nouvel exercice"
2026-02-20T22:09:11.1051925Z      EXERCISES_BACK_BUTTON = "Retour à la liste"
2026-02-20T22:09:11.1052044Z -    
2026-02-20T22:09:11.1052152Z +
2026-02-20T22:09:11.1052296Z      # Tableau de bord
2026-02-20T22:09:11.1052450Z      DASHBOARD_TITLE = "Tableau de bord"
2026-02-20T22:09:11.1053196Z      DASHBOARD_SUBTITLE = "Suivez votre progression vers la maîtrise des mathématiques"
2026-02-20T22:09:11.1053532Z      DASHBOARD_TOTAL_EXERCISES = "Exercices réalisés"
2026-02-20T22:09:11.1053844Z      DASHBOARD_CORRECT_ANSWERS = "Réponses correctes"
2026-02-20T22:09:11.1054143Z      DASHBOARD_SUCCESS_RATE = "Taux de réussite"
2026-02-20T22:09:11.1054428Z      DASHBOARD_EXPERIENCE = "Points d'expérience"
2026-02-20T22:09:11.1054610Z      DASHBOARD_PROGRESS_TITLE = "Progression"
2026-02-20T22:09:11.1054910Z      DASHBOARD_RECENT_ACTIVITY = "Activité récente"
2026-02-20T22:09:11.1055240Z      DASHBOARD_ACTIVITY_EMPTY = "Aucune activité récente"
2026-02-20T22:09:11.1055354Z -    
2026-02-20T22:09:11.1055462Z +
2026-02-20T22:09:11.1055595Z      # Pied de page
2026-02-20T22:09:11.1056103Z      FOOTER_TEXT = "Mathakine - Exerce-toi aux mathématiques de façon amusante !"
2026-02-20T22:09:11.1056283Z      FOOTER_GITHUB = "Projet GitHub"
2026-02-20T22:09:11.1056487Z      FOOTER_VERSION = "Version 3.0 - L'API Rebelle"
2026-02-20T22:09:11.1056595Z -    
2026-02-20T22:09:11.1056699Z +
2026-02-20T22:09:11.1056915Z      # Boutons génériques
2026-02-20T22:09:11.1057058Z      BUTTON_SUBMIT = "Valider"
2026-02-20T22:09:11.1057210Z      BUTTON_CANCEL = "Annuler"
2026-02-20T22:09:11.1057349Z      BUTTON_CONFIRM = "Confirmer"
2026-02-20T22:09:11.1057492Z      BUTTON_NEXT = "Suivant"
2026-02-20T22:09:11.1057608Z @@ -303,61 +417,67 @@
2026-02-20T22:09:11.1057739Z      BUTTON_BACK = "Retour"
2026-02-20T22:09:11.1057889Z      BUTTON_REFRESH = "Actualiser"
2026-02-20T22:09:11.1058099Z      BUTTON_RETRY = "Réessayer"
2026-02-20T22:09:11.1058310Z      BUTTON_GENERATE = "Générer"
2026-02-20T22:09:11.1058450Z      BUTTON_ARCHIVE = "Archiver"
2026-02-20T22:09:11.1058570Z -    
2026-02-20T22:09:11.1058677Z +
2026-02-20T22:09:11.1058907Z      # En-têtes et titres de pages
2026-02-20T22:09:11.1059358Z      PAGE_TITLE_HOME = "Accueil | Mathakine"
2026-02-20T22:09:11.1059564Z      PAGE_TITLE_EXERCISES = "Exercices | Mathakine"
2026-02-20T22:09:11.1059786Z      PAGE_TITLE_DASHBOARD = "Tableau de bord | Mathakine"
2026-02-20T22:09:11.1059951Z      PAGE_TITLE_ERROR = "Erreur | Mathakine"
2026-02-20T22:09:11.1060064Z -    
2026-02-20T22:09:11.1060171Z +
2026-02-20T22:09:11.1060569Z      # Boutons
2026-02-20T22:09:11.1060720Z      BUTTON_HOME = "Accueil"
2026-02-20T22:09:11.1060870Z      BUTTON_EXERCISES = "Exercices"
2026-02-20T22:09:11.1061030Z      BUTTON_DASHBOARD = "Tableau de bord"
2026-02-20T22:09:11.1061174Z      BUTTON_LOGIN = "Connexion"
2026-02-20T22:09:11.1061335Z      BUTTON_REGISTER = "Inscription"
2026-02-20T22:09:11.1061588Z      BUTTON_LOGOUT = "Déconnexion"
2026-02-20T22:09:11.1061698Z -    
2026-02-20T22:09:11.1061811Z +
2026-02-20T22:09:11.1061977Z      # Libellés
2026-02-20T22:09:11.1062108Z      LABEL_NAME = "Nom"
2026-02-20T22:09:11.1062240Z      LABEL_EMAIL = "Email"
2026-02-20T22:09:11.1062409Z      LABEL_PASSWORD = "Mot de passe"
2026-02-20T22:09:11.1062640Z      LABEL_CONFIRM_PASSWORD = "Confirmer le mot de passe"
2026-02-20T22:09:11.1062811Z      LABEL_EXERCISE_TYPE = "Type d'exercice"
2026-02-20T22:09:11.1063309Z      LABEL_DIFFICULTY = "Niveau de difficulté"
2026-02-20T22:09:11.1063548Z      LABEL_ANSWER = "Ta réponse"
2026-02-20T22:09:11.1063670Z -    
2026-02-20T22:09:11.1063787Z +
2026-02-20T22:09:11.1063933Z      # Textes de page d'accueil
2026-02-20T22:09:11.1064180Z      HOME_WELCOME = "Bienvenue sur Mathakine - L'API Rebelle"
2026-02-20T22:09:11.1065037Z      HOME_DESCRIPTION = "Rejoins les forces rebelles et entraîne-toi avec des exercices mathématiques amusants et interactifs."
2026-02-20T22:09:11.1065166Z -    
2026-02-20T22:09:11.1065277Z +
2026-02-20T22:09:11.1065443Z      # Messages de connexion/inscription
2026-02-20T22:09:11.1065594Z      LOGIN_TITLE = "Connexion"
2026-02-20T22:09:11.1065985Z      LOGIN_SUBTITLE = "Connecte-toi pour accéder à ton compte"
2026-02-20T22:09:11.1066160Z      REGISTER_TITLE = "Inscription"
2026-02-20T22:09:11.1066491Z      REGISTER_SUBTITLE = "Crée un compte pour commencer"
2026-02-20T22:09:11.1066610Z -    
2026-02-20T22:09:11.1066717Z +
2026-02-20T22:09:11.1066840Z      # Textes du tableau de bord
2026-02-20T22:09:11.1067404Z -    DASHBOARD_NO_DATA = "Pas encore de données disponibles. Commence à résoudre des exercices !"
2026-02-20T22:09:11.1067519Z -    
2026-02-20T22:09:11.1067647Z +    DASHBOARD_NO_DATA = (
2026-02-20T22:09:11.1068115Z +        "Pas encore de données disponibles. Commence à résoudre des exercices !"
2026-02-20T22:09:11.1068232Z +    )
2026-02-20T22:09:11.1068336Z +
2026-02-20T22:09:11.1068467Z      # Messages d'erreur
2026-02-20T22:09:11.1068731Z      ERROR_404_TITLE = "Page non trouvée"
2026-02-20T22:09:11.1069236Z      ERROR_404_MESSAGE = "La page que tu cherches n'existe pas ou a été déplacée."
2026-02-20T22:09:11.1069403Z      ERROR_500_TITLE = "Erreur serveur"
2026-02-20T22:09:11.1070028Z -    ERROR_500_MESSAGE = "Une erreur s'est produite sur le serveur. Veuillez réessayer plus tard."
2026-02-20T22:09:11.1070189Z +    ERROR_500_MESSAGE = (
2026-02-20T22:09:11.1070677Z +        "Une erreur s'est produite sur le serveur. Veuillez réessayer plus tard."
2026-02-20T22:09:11.1070805Z +    )
2026-02-20T22:09:11.1070914Z +
2026-02-20T22:09:11.1071021Z  
2026-02-20T22:09:11.1071162Z  # Notifications
2026-02-20T22:09:11.1071329Z  class NotificationMessages:
2026-02-20T22:09:11.1071579Z      INFO_LOGGED_IN = "Connexion réussie"
2026-02-20T22:09:11.1071816Z      INFO_LOGGED_OUT = "Déconnexion réussie"
2026-02-20T22:09:11.1072080Z      INFO_REGISTERED = "Inscription réussie"
2026-02-20T22:09:11.1072496Z      WARNING_SESSION_EXPIRED = "Ta session a expiré, reconnecte-toi"
2026-02-20T22:09:11.1072787Z      ERROR_INVALID_CREDENTIALS = "Email ou mot de passe incorrect"
2026-02-20T22:09:11.1073314Z      ERROR_EMAIL_EXISTS = "Cet email est déjà utilisé"
2026-02-20T22:09:11.1073445Z +
2026-02-20T22:09:11.1073552Z  
2026-02-20T22:09:11.1074143Z  # Messages spécifiques aux utilisateurs
2026-02-20T22:09:11.1074298Z  class UserMessages:
2026-02-20T22:09:11.1074444Z      # Connexion et inscription
2026-02-20T22:09:11.1074930Z      SUCCESS_REGISTRATION = "Inscription réussie ! Bienvenue dans l'Ordre Jedi."
2026-02-20T22:09:11.1075052Z @@ -366,33 +486,37 @@
2026-02-20T22:09:11.1075458Z      ERROR_INVALID_CREDENTIALS = "Les informations d'identification sont incorrectes."
2026-02-20T22:09:11.1076030Z      ERROR_USERNAME_EXISTS = "Ce nom d'utilisateur est déjà pris."
2026-02-20T22:09:11.1076380Z      ERROR_EMAIL_EXISTS = "Cette adresse email est déjà utilisée."
2026-02-20T22:09:11.1076691Z      ERROR_PASSWORD_MISMATCH = "Les mots de passe ne correspondent pas."
2026-02-20T22:09:11.1077010Z      ERROR_INACTIVE_ACCOUNT = "Ce compte a été désactivé."
2026-02-20T22:09:11.1077119Z -    
2026-02-20T22:09:11.1077223Z +
2026-02-20T22:09:11.1077364Z      # Validation des champs
2026-02-20T22:09:11.1078000Z      ERROR_PASSWORD_WEAK = "Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre."
2026-02-20T22:09:11.1078599Z      ERROR_USERNAME_INVALID = "Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores."
2026-02-20T22:09:11.1078858Z      ERROR_EMAIL_INVALID = "L'adresse email n'est pas valide."
2026-02-20T22:09:11.1078969Z -    
2026-02-20T22:09:11.1079086Z +
2026-02-20T22:09:11.1079235Z      # Profil utilisateur
2026-02-20T22:09:11.1079605Z      SUCCESS_PROFILE_UPDATE = "Profil mis à jour avec succès."
2026-02-20T22:09:11.1080016Z      SUCCESS_PASSWORD_UPDATE = "Mot de passe mis à jour avec succès."
2026-02-20T22:09:11.1080317Z      ERROR_CURRENT_PASSWORD = "Le mot de passe actuel est incorrect."
2026-02-20T22:09:11.1080424Z -    
2026-02-20T22:09:11.1080528Z +
2026-02-20T22:09:11.1080651Z      # Permissions
2026-02-20T22:09:11.1081112Z      ERROR_NOT_AUTHORIZED = "Tu n'es pas autorisé à effectuer cette action."
2026-02-20T22:09:11.1081506Z      ERROR_ADMIN_REQUIRED = "Seuls les administrateurs peuvent effectuer cette action."
2026-02-20T22:09:11.1081981Z -    ERROR_GARDIEN_REQUIRED = "Seuls les Gardiens et Archivistes peuvent effectuer cette action."
2026-02-20T22:09:11.1082649Z -    ERROR_CHEVALIER_REQUIRED = "Seuls les Chevaliers Jedi et supérieurs peuvent effectuer cette action."
2026-02-20T22:09:11.1082759Z -    
2026-02-20T22:09:11.1082900Z +    ERROR_GARDIEN_REQUIRED = (
2026-02-20T22:09:11.1083439Z +        "Seuls les Gardiens et Archivistes peuvent effectuer cette action."
2026-02-20T22:09:11.1083554Z +    )
2026-02-20T22:09:11.1083704Z +    ERROR_CHEVALIER_REQUIRED = (
2026-02-20T22:09:11.1084196Z +        "Seuls les Chevaliers Jedi et supérieurs peuvent effectuer cette action."
2026-02-20T22:09:11.1084318Z +    )
2026-02-20T22:09:11.1084421Z +
2026-02-20T22:09:11.1084540Z      # Progression
2026-02-20T22:09:11.1084960Z      SUCCESS_PROGRESS_RESET = "Ta progression a été réinitialisée."
2026-02-20T22:09:11.1085373Z      INFO_LEVEL_UP = "Félicitations ! Tu as atteint le niveau {level}."
2026-02-20T22:09:11.1085898Z      INFO_ACHIEVEMENT_UNLOCKED = "Nouvel accomplissement débloqué : {achievement}"
2026-02-20T22:09:11.1086018Z -    
2026-02-20T22:09:11.1086122Z +
2026-02-20T22:09:11.1086264Z      # Gestion des utilisateurs
2026-02-20T22:09:11.1086614Z      SUCCESS_USER_CREATED = "Utilisateur créé avec succès."
2026-02-20T22:09:11.1086999Z      SUCCESS_USER_UPDATED = "Utilisateur mis à jour avec succès."
2026-02-20T22:09:11.1087385Z      SUCCESS_USER_DELETED = "Utilisateur supprimé avec succès."
2026-02-20T22:09:11.1087690Z      ERROR_USER_NOT_FOUND = "Utilisateur non trouvé."
2026-02-20T22:09:11.1088069Z -    ERROR_CANNOT_DELETE_SELF = "Vous ne pouvez pas supprimer votre propre compte." 
2026-02-20T22:09:11.1088215Z \ No newline at end of file
2026-02-20T22:09:11.1088574Z +    ERROR_CANNOT_DELETE_SELF = "Vous ne pouvez pas supprimer votre propre compte."
2026-02-20T22:09:11.1089019Z --- /home/runner/work/mathakine/mathakine/app/db/adapter.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.1089454Z +++ /home/runner/work/mathakine/mathakine/app/db/adapter.py	2026-02-20 22:09:11.081802+00:00
2026-02-20T22:09:11.1089795Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.1089904Z  """
2026-02-20T22:09:11.1090214Z  Adaptateur de base de données pour Mathakine.
2026-02-20T22:09:11.1090772Z  Fournit une interface unifiée entre les modèles SQLAlchemy et les requêtes SQL directes.
2026-02-20T22:09:11.1091068Z  """
2026-02-20T22:09:11.1091180Z +
2026-02-20T22:09:11.1091431Z  from typing import Any, Dict, List, Optional, Type, Union
2026-02-20T22:09:11.1091534Z  
2026-02-20T22:09:11.1091723Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.1091820Z  
2026-02-20T22:09:11.1091961Z  logger = get_logger(__name__)
2026-02-20T22:09:11.1092075Z @@ -18,193 +19,221 @@
2026-02-20T22:09:11.1092186Z      """
2026-02-20T22:09:11.1092516Z      Adaptateur pour les opérations de base de données.
2026-02-20T22:09:11.1093173Z      Permet d'utiliser une approche unifiée pour les opérations sur les modèles,
2026-02-20T22:09:11.1093585Z      que ce soit via SQLAlchemy ou via des requêtes SQL directes.
2026-02-20T22:09:11.1093698Z      """
2026-02-20T22:09:11.1093803Z -    
2026-02-20T22:09:11.1093907Z +
2026-02-20T22:09:11.1094033Z      @staticmethod
2026-02-20T22:09:11.1094374Z      def get_by_id(db: Session, model_class: Type[Base], id: int) -> Optional[Base]:
2026-02-20T22:09:11.1094497Z          """
2026-02-20T22:09:11.1094736Z          Récupère un objet par son ID.
2026-02-20T22:09:11.1094846Z -        
2026-02-20T22:09:11.1094951Z +
2026-02-20T22:09:11.1095059Z          Args:
2026-02-20T22:09:11.1095296Z              db: Session de base de données
2026-02-20T22:09:11.1095583Z              model_class: Classe du modèle à récupérer
2026-02-20T22:09:11.1095812Z              id: ID de l'objet à récupérer
2026-02-20T22:09:11.1095930Z -            
2026-02-20T22:09:11.1096033Z +
2026-02-20T22:09:11.1096145Z          Returns:
2026-02-20T22:09:11.1096498Z              L'objet correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:11.1096629Z          """
2026-02-20T22:09:11.1096737Z          try:
2026-02-20T22:09:11.1097030Z              return db.query(model_class).filter(model_class.id == id).first()
2026-02-20T22:09:11.1097178Z          except Exception as e:
2026-02-20T22:09:11.1097780Z -            logger.error(f"Erreur lors de la récupération de {model_class.__name__} avec id={id}: {e}")
2026-02-20T22:09:11.1097930Z +            logger.error(
2026-02-20T22:09:11.1098435Z +                f"Erreur lors de la récupération de {model_class.__name__} avec id={id}: {e}"
2026-02-20T22:09:11.1098544Z +            )
2026-02-20T22:09:11.1098667Z              return None
2026-02-20T22:09:11.1098770Z -    
2026-02-20T22:09:11.1098891Z -    @staticmethod
2026-02-20T22:09:11.1099352Z -    def get_by_field(db: Session, model_class: Type[Base], field_name: str, value: Any) -> List[Base]:
2026-02-20T22:09:11.1099458Z +
2026-02-20T22:09:11.1099583Z +    @staticmethod
2026-02-20T22:09:11.1099707Z +    def get_by_field(
2026-02-20T22:09:11.1100001Z +        db: Session, model_class: Type[Base], field_name: str, value: Any
2026-02-20T22:09:11.1100122Z +    ) -> List[Base]:
2026-02-20T22:09:11.1100235Z          """
2026-02-20T22:09:11.1100538Z          Récupère des objets par la valeur d'un champ.
2026-02-20T22:09:11.1100646Z -        
2026-02-20T22:09:11.1100757Z +
2026-02-20T22:09:11.1100861Z          Args:
2026-02-20T22:09:11.1101108Z              db: Session de base de données
2026-02-20T22:09:11.1101382Z              model_class: Classe du modèle à récupérer
2026-02-20T22:09:11.1101633Z              field_name: Nom du champ à filtrer
2026-02-20T22:09:11.1101846Z              value: Valeur à rechercher
2026-02-20T22:09:11.1101954Z -            
2026-02-20T22:09:11.1102063Z +
2026-02-20T22:09:11.1102172Z          Returns:
2026-02-20T22:09:11.1102339Z              Liste des objets correspondants
2026-02-20T22:09:11.1102453Z          """
2026-02-20T22:09:11.1102558Z          try:
2026-02-20T22:09:11.1103139Z -            return db.query(model_class).filter(getattr(model_class, field_name) == value).all()
2026-02-20T22:09:11.1103498Z -        except Exception as e:
2026-02-20T22:09:11.1104213Z -            logger.error(f"Erreur lors de la récupération de {model_class.__name__} avec {field_name}={value}: {e}")
2026-02-20T22:09:11.1104337Z -            return []
2026-02-20T22:09:11.1104446Z -    
2026-02-20T22:09:11.1104769Z -    @staticmethod
2026-02-20T22:09:11.1105289Z -    def list_active(db: Session, model_class: Type[Base], limit: int = None, offset: int = None) -> List[Base]:
2026-02-20T22:09:11.1105409Z +            return (
2026-02-20T22:09:11.1105559Z +                db.query(model_class)
2026-02-20T22:09:11.1105790Z +                .filter(getattr(model_class, field_name) == value)
2026-02-20T22:09:11.1105904Z +                .all()
2026-02-20T22:09:11.1106012Z +            )
2026-02-20T22:09:11.1106156Z +        except Exception as e:
2026-02-20T22:09:11.1106284Z +            logger.error(
2026-02-20T22:09:11.1106893Z +                f"Erreur lors de la récupération de {model_class.__name__} avec {field_name}={value}: {e}"
2026-02-20T22:09:11.1107025Z +            )
2026-02-20T22:09:11.1107142Z +            return []
2026-02-20T22:09:11.1107246Z +
2026-02-20T22:09:11.1107358Z +    @staticmethod
2026-02-20T22:09:11.1107489Z +    def list_active(
2026-02-20T22:09:11.1107826Z +        db: Session, model_class: Type[Base], limit: int = None, offset: int = None
2026-02-20T22:09:11.1107959Z +    ) -> List[Base]:
2026-02-20T22:09:11.1108072Z          """
2026-02-20T22:09:11.1108394Z          Liste les objets actifs (non archivés) d'un modèle.
2026-02-20T22:09:11.1108503Z -        
2026-02-20T22:09:11.1108604Z +
2026-02-20T22:09:11.1108721Z          Args:
2026-02-20T22:09:11.1108953Z              db: Session de base de données
2026-02-20T22:09:11.1109217Z              model_class: Classe du modèle à lister
2026-02-20T22:09:11.1109500Z              limit: Nombre maximum d'objets à retourner
2026-02-20T22:09:11.1109758Z              offset: Décalage pour la pagination
2026-02-20T22:09:11.1109878Z -            
2026-02-20T22:09:11.1109988Z +
2026-02-20T22:09:11.1110096Z          Returns:
2026-02-20T22:09:11.1110233Z              Liste des objets actifs
2026-02-20T22:09:11.1110341Z          """
2026-02-20T22:09:11.1110453Z          try:
2026-02-20T22:09:11.1110599Z              query = db.query(model_class)
2026-02-20T22:09:11.1110718Z -            
2026-02-20T22:09:11.1110820Z +
2026-02-20T22:09:11.1111169Z              # Filtrer par is_archived si le modèle a cet attribut
2026-02-20T22:09:11.1111349Z -            if hasattr(model_class, 'is_archived'):
2026-02-20T22:09:11.1111659Z -                query = query.filter(getattr(model_class, 'is_archived') == False)
2026-02-20T22:09:11.1111775Z -            
2026-02-20T22:09:11.1111944Z +            if hasattr(model_class, "is_archived"):
2026-02-20T22:09:11.1112236Z +                query = query.filter(getattr(model_class, "is_archived") == False)
2026-02-20T22:09:11.1112350Z +
2026-02-20T22:09:11.1112629Z              # Appliquer limit et offset si spécifiés
2026-02-20T22:09:11.1112776Z              if offset is not None:
2026-02-20T22:09:11.1112925Z                  query = query.offset(offset)
2026-02-20T22:09:11.1113239Z              if limit is not None:
2026-02-20T22:09:11.1113389Z                  query = query.limit(limit)
2026-02-20T22:09:11.1113498Z -                
2026-02-20T22:09:11.1113617Z +
2026-02-20T22:09:11.1113746Z              return query.all()
2026-02-20T22:09:11.1113881Z          except Exception as e:
2026-02-20T22:09:11.1114260Z -            logger.error(f"Erreur lors de la liste des {model_class.__name__} actifs: {e}")
2026-02-20T22:09:11.1114374Z -            return []
2026-02-20T22:09:11.1114479Z -    
2026-02-20T22:09:11.1114596Z -    @staticmethod
2026-02-20T22:09:11.1115021Z -    def create(db: Session, model_class: Type[Base], data: Dict[str, Any]) -> Optional[Base]:
2026-02-20T22:09:11.1115151Z +            logger.error(
2026-02-20T22:09:11.1115443Z +                f"Erreur lors de la liste des {model_class.__name__} actifs: {e}"
2026-02-20T22:09:11.1115767Z +            )
2026-02-20T22:09:11.1115889Z +            return []
2026-02-20T22:09:11.1115994Z +
2026-02-20T22:09:11.1116108Z +    @staticmethod
2026-02-20T22:09:11.1116227Z +    def create(
2026-02-20T22:09:11.1116471Z +        db: Session, model_class: Type[Base], data: Dict[str, Any]
2026-02-20T22:09:11.1116781Z +    ) -> Optional[Base]:
2026-02-20T22:09:11.1116897Z          """
2026-02-20T22:09:11.1117213Z          Crée un nouvel objet dans la base de données.
2026-02-20T22:09:11.1117325Z -        
2026-02-20T22:09:11.1117425Z +
2026-02-20T22:09:11.1117539Z          Args:
2026-02-20T22:09:11.1117771Z              db: Session de base de données
2026-02-20T22:09:11.1118032Z              model_class: Classe du modèle à créer
2026-02-20T22:09:11.1118378Z              data: Dictionnaire contenant les données de l'objet
2026-02-20T22:09:11.1118486Z -            
2026-02-20T22:09:11.1118584Z +
2026-02-20T22:09:11.1118701Z          Returns:
2026-02-20T22:09:11.1118978Z              L'objet créé ou None en cas d'erreur
2026-02-20T22:09:11.1119084Z          """
2026-02-20T22:09:11.1119332Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.1119452Z              try:
2026-02-20T22:09:11.1119596Z                  obj = model_class(**data)
2026-02-20T22:09:11.1119742Z                  session.add(obj)
2026-02-20T22:09:11.1120050Z                  session.flush()  # Pour obtenir l'ID généré
2026-02-20T22:09:11.1120174Z                  return obj
2026-02-20T22:09:11.1120319Z              except Exception as e:
2026-02-20T22:09:11.1120812Z -                logger.error(f"Erreur lors de la création de {model_class.__name__}: {e}")
2026-02-20T22:09:11.1120952Z +                logger.error(
2026-02-20T22:09:11.1121346Z +                    f"Erreur lors de la création de {model_class.__name__}: {e}"
2026-02-20T22:09:11.1121462Z +                )
2026-02-20T22:09:11.1121594Z                  return None
2026-02-20T22:09:11.1121710Z -    
2026-02-20T22:09:11.1121814Z +
2026-02-20T22:09:11.1121932Z      @staticmethod
2026-02-20T22:09:11.1122218Z      def update(db: Session, obj: Base, data: Dict[str, Any]) -> bool:
2026-02-20T22:09:11.1122311Z          """
2026-02-20T22:09:11.1122520Z          Met à jour un objet existant.
2026-02-20T22:09:11.1122631Z -        
2026-02-20T22:09:11.1122740Z +
2026-02-20T22:09:11.1122843Z          Args:
2026-02-20T22:09:11.1123230Z              db: Session de base de données
2026-02-20T22:09:11.1123456Z              obj: Objet à mettre à jour
2026-02-20T22:09:11.1123690Z              data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:11.1123801Z -            
2026-02-20T22:09:11.1123912Z +
2026-02-20T22:09:11.1124020Z          Returns:
2026-02-20T22:09:11.1124319Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:11.1124436Z          """
2026-02-20T22:09:11.1124680Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.1124807Z              try:
2026-02-20T22:09:11.1125134Z                  # S'assurer que l'objet est attaché à la session
2026-02-20T22:09:11.1125285Z                  if obj not in session:
2026-02-20T22:09:11.1125631Z                      # Récupérer l'objet depuis la session si possible
2026-02-20T22:09:11.1125808Z -                    obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.1125995Z +                    obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.1126120Z                      if obj_id:
2026-02-20T22:09:11.1126505Z -                        obj = session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.1126639Z +                        obj = (
2026-02-20T22:09:11.1126812Z +                            session.query(obj.__class__)
2026-02-20T22:09:11.1126991Z +                            .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.1127118Z +                            .first()
2026-02-20T22:09:11.1127240Z +                        )
2026-02-20T22:09:11.1127587Z                          if not obj:
2026-02-20T22:09:11.1128213Z -                            logger.error(f"Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la session")
2026-02-20T22:09:11.1128362Z +                            logger.error(
2026-02-20T22:09:11.1128878Z +                                f"Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la session"
2026-02-20T22:09:11.1129189Z +                            )
2026-02-20T22:09:11.1129346Z                              return False
2026-02-20T22:09:11.1129465Z                      else:
2026-02-20T22:09:11.1129631Z                          # Si pas d'ID, merger l'objet
2026-02-20T22:09:11.1129788Z                          obj = session.merge(obj)
2026-02-20T22:09:11.1129905Z -                
2026-02-20T22:09:11.1130010Z +
2026-02-20T22:09:11.1130260Z                  # Mettre à jour les attributs
2026-02-20T22:09:11.1130427Z                  for key, value in data.items():
2026-02-20T22:09:11.1130572Z                      if hasattr(obj, key):
2026-02-20T22:09:11.1130730Z                          setattr(obj, key, value)
2026-02-20T22:09:11.1130867Z                  session.flush()
2026-02-20T22:09:11.1130992Z                  return True
2026-02-20T22:09:11.1131128Z              except Exception as e:
2026-02-20T22:09:11.1131848Z -                logger.error(f"Erreur lors de la mise à jour de {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}): {e}")
2026-02-20T22:09:11.1132001Z +                logger.error(
2026-02-20T22:09:11.1132622Z +                    f"Erreur lors de la mise à jour de {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}): {e}"
2026-02-20T22:09:11.1132737Z +                )
2026-02-20T22:09:11.1132868Z                  return False
2026-02-20T22:09:11.1133151Z -    
2026-02-20T22:09:11.1133259Z +
2026-02-20T22:09:11.1133381Z      @staticmethod
2026-02-20T22:09:11.1133567Z      def archive(db: Session, obj: Base) -> bool:
2026-02-20T22:09:11.1133673Z          """
2026-02-20T22:09:11.1134127Z          Archive un objet (marque comme supprimé sans suppression physique).
2026-02-20T22:09:11.1134243Z -        
2026-02-20T22:09:11.1134340Z +
2026-02-20T22:09:11.1134447Z          Args:
2026-02-20T22:09:11.1134686Z              db: Session de base de données
2026-02-20T22:09:11.1134883Z              obj: Objet à archiver
2026-02-20T22:09:11.1135003Z -            
2026-02-20T22:09:11.1135105Z +
2026-02-20T22:09:11.1135222Z          Returns:
2026-02-20T22:09:11.1135493Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:11.1135600Z          """
2026-02-20T22:09:11.1135821Z          return TransactionManager.safe_archive(db, obj)
2026-02-20T22:09:11.1135926Z -    
2026-02-20T22:09:11.1136027Z +
2026-02-20T22:09:11.1136141Z      @staticmethod
2026-02-20T22:09:11.1136324Z      def delete(db: Session, obj: Base) -> bool:
2026-02-20T22:09:11.1136429Z          """
2026-02-20T22:09:11.1136778Z          Supprime physiquement un objet de la base de données.
2026-02-20T22:09:11.1137159Z          Les suppressions en cascade sont gérées automatiquement.
2026-02-20T22:09:11.1137270Z -        
2026-02-20T22:09:11.1137375Z +
2026-02-20T22:09:11.1137483Z          Args:
2026-02-20T22:09:11.1137718Z              db: Session de base de données
2026-02-20T22:09:11.1137926Z              obj: Objet à supprimer
2026-02-20T22:09:11.1138032Z -            
2026-02-20T22:09:11.1138151Z +
2026-02-20T22:09:11.1138259Z          Returns:
2026-02-20T22:09:11.1138549Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:11.1138657Z          """
2026-02-20T22:09:11.1138868Z          return TransactionManager.safe_delete(db, obj)
2026-02-20T22:09:11.1138970Z -    
2026-02-20T22:09:11.1139086Z -    @staticmethod
2026-02-20T22:09:11.1139620Z -    def execute_query(db: Session, query: str, params: Optional[Dict[str, Any]] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:11.1139727Z +
2026-02-20T22:09:11.1139844Z +    @staticmethod
2026-02-20T22:09:11.1139973Z +    def execute_query(
2026-02-20T22:09:11.1140546Z +        db: Session, query: str, params: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.1140695Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:11.1140805Z          """
2026-02-20T22:09:11.1141100Z          Exécute une requête SQL personnalisée.
2026-02-20T22:09:11.1141211Z  
2026-02-20T22:09:11.1141691Z          SÉCURITÉ (audit 3.1) : params doit être un dict pour des paramètres nommés.
2026-02-20T22:09:11.1142403Z          Ne jamais concaténer de données utilisateur dans query. Utiliser exclusivement
2026-02-20T22:09:11.1142919Z          des paramètres nommés (ex: SELECT * FROM t WHERE id = :id avec params={"id": 1}).
2026-02-20T22:09:11.1143201Z -        
2026-02-20T22:09:11.1143310Z +
2026-02-20T22:09:11.1143429Z          Args:
2026-02-20T22:09:11.1143671Z              db: Session de base de données
2026-02-20T22:09:11.1144044Z              query: Requête SQL avec paramètres nommés (:param_name)
2026-02-20T22:09:11.1144391Z              params: Dictionnaire de paramètres nommés (ou None)
2026-02-20T22:09:11.1144521Z -            
2026-02-20T22:09:11.1144621Z +
2026-02-20T22:09:11.1144741Z          Returns:
2026-02-20T22:09:11.1145056Z              Liste de dictionnaires contenant les résultats
2026-02-20T22:09:11.1145164Z          """
2026-02-20T22:09:11.1145406Z          if params is not None and not isinstance(params, dict):
2026-02-20T22:09:11.1145574Z              raise TypeError(
2026-02-20T22:09:11.1146051Z                  "execute_query exige params de type dict pour des paramètres nommés. "
2026-02-20T22:09:11.1146545Z -                "Utiliser :param_name dans la requête et params={\"param_name\": value}."
2026-02-20T22:09:11.1147026Z +                'Utiliser :param_name dans la requête et params={"param_name": value}.'
2026-02-20T22:09:11.1147133Z              )
2026-02-20T22:09:11.1147348Z          safe_params = params if params is not None else {}
2026-02-20T22:09:11.1147460Z          try:
2026-02-20T22:09:11.1147656Z              result = db.execute(text(query), safe_params)
2026-02-20T22:09:11.1147811Z              if result.returns_rows:
2026-02-20T22:09:11.1147920Z @@ -212,6 +241,6 @@
2026-02-20T22:09:11.1148240Z                  return [dict(zip(column_names, row)) for row in result.fetchall()]
2026-02-20T22:09:11.1148362Z              return []
2026-02-20T22:09:11.1148503Z          except Exception as e:
2026-02-20T22:09:11.1148960Z              logger.error(f"Erreur lors de l'exécution de la requête SQL: {e}")
2026-02-20T22:09:11.1149090Z              db.rollback()
2026-02-20T22:09:11.1149217Z -            return [] 
2026-02-20T22:09:11.1149353Z \ No newline at end of file
2026-02-20T22:09:11.1149483Z +            return []
2026-02-20T22:09:11.1380891Z --- /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1383141Z +++ /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py	2026-02-20 22:09:11.136648+00:00
2026-02-20T22:09:11.1383305Z @@ -1,23 +1,31 @@
2026-02-20T22:09:11.1383840Z  """
2026-02-20T22:09:11.1384343Z  Modèle pour le journal d'audit des actions admin.
2026-02-20T22:09:11.1384457Z  """
2026-02-20T22:09:11.1384563Z +
2026-02-20T22:09:11.1385764Z  from sqlalchemy import Column, DateTime, ForeignKey, Integer, String, Text
2026-02-20T22:09:11.1385956Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.1386122Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.1386224Z  
2026-02-20T22:09:11.1386366Z  from app.db.base import Base
2026-02-20T22:09:11.1386479Z  
2026-02-20T22:09:11.1386584Z  
2026-02-20T22:09:11.1386716Z  class AdminAuditLog(Base):
2026-02-20T22:09:11.1387152Z      """Journal des actions effectuées par les administrateurs."""
2026-02-20T22:09:11.1387248Z +
2026-02-20T22:09:11.1387376Z      __tablename__ = "admin_audit_logs"
2026-02-20T22:09:11.1387473Z  
2026-02-20T22:09:11.1387673Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1388147Z -    admin_user_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.1388594Z -    action = Column(String(50), nullable=False, index=True)  # user_patch, exercise_create, etc.
2026-02-20T22:09:11.1389007Z -    resource_type = Column(String(30), nullable=True, index=True)  # user, exercise, challenge
2026-02-20T22:09:11.1389138Z +    admin_user_id = Column(
2026-02-20T22:09:11.1389734Z +        Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, index=True
2026-02-20T22:09:11.1389855Z +    )
2026-02-20T22:09:11.1389973Z +    action = Column(
2026-02-20T22:09:11.1390131Z +        String(50), nullable=False, index=True
2026-02-20T22:09:11.1390288Z +    )  # user_patch, exercise_create, etc.
2026-02-20T22:09:11.1390415Z +    resource_type = Column(
2026-02-20T22:09:11.1390565Z +        String(30), nullable=True, index=True
2026-02-20T22:09:11.1390699Z +    )  # user, exercise, challenge
2026-02-20T22:09:11.1390882Z      resource_id = Column(Integer, nullable=True)
2026-02-20T22:09:11.1391389Z      details = Column(Text, nullable=True)  # JSON string avec infos complémentaires
2026-02-20T22:09:11.1391705Z      created_at = Column(DateTime(timezone=True), server_default=func.now())
2026-02-20T22:09:11.1391827Z  
2026-02-20T22:09:11.1392117Z      admin_user = relationship("User", foreign_keys=[admin_user_id])
2026-02-20T22:09:11.1392555Z would reformat /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py
2026-02-20T22:09:11.1473951Z --- /home/runner/work/mathakine/mathakine/app/db/queries.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.1476695Z +++ /home/runner/work/mathakine/mathakine/app/db/queries.py	2026-02-20 22:09:11.136877+00:00
2026-02-20T22:09:11.1477932Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.1478169Z  """
2026-02-20T22:09:11.1478813Z  Requêtes SQL centralisées pour l'application Mathakine
2026-02-20T22:09:11.1479347Z would reformat /home/runner/work/mathakine/mathakine/app/db/queries.py
2026-02-20T22:09:11.1480036Z  Ce fichier contient toutes les requêtes SQL utilisées dans l'application.
2026-02-20T22:09:11.1480349Z  """
2026-02-20T22:09:11.1480464Z +
2026-02-20T22:09:11.1480570Z  
2026-02-20T22:09:11.1480855Z  # Requêtes pour la table 'exercises'
2026-02-20T22:09:11.1480991Z  class ExerciseQueries:
2026-02-20T22:09:11.1481267Z      # Création et modification avec optimisations
2026-02-20T22:09:11.1481398Z      CREATE_TABLE = """
2026-02-20T22:09:11.1481525Z @@ -35,137 +36,138 @@
2026-02-20T22:09:11.1482002Z      CREATE INDEX IF NOT EXISTS idx_exercises_creator ON exercises(creator_id) WHERE is_archived = false;
2026-02-20T22:09:11.1482518Z      CREATE INDEX IF NOT EXISTS idx_exercises_created_at ON exercises(created_at DESC) WHERE is_archived = false;
2026-02-20T22:09:11.1483211Z      CREATE INDEX IF NOT EXISTS idx_exercises_view_count ON exercises(view_count DESC) WHERE is_archived = false;
2026-02-20T22:09:11.1483715Z      CREATE INDEX IF NOT EXISTS idx_exercises_ai_generated ON exercises(ai_generated) WHERE is_archived = false;
2026-02-20T22:09:11.1483827Z      """
2026-02-20T22:09:11.1484180Z -    
2026-02-20T22:09:11.1484282Z +
2026-02-20T22:09:11.1484571Z      # Sélection optimisée avec LIMIT par défaut
2026-02-20T22:09:11.1484692Z      GET_ALL = """
2026-02-20T22:09:11.1484826Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1484960Z      WHERE is_archived = false
2026-02-20T22:09:11.1485098Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1485231Z      LIMIT 100
2026-02-20T22:09:11.1485340Z      """
2026-02-20T22:09:11.1485446Z -    
2026-02-20T22:09:11.1485566Z +
2026-02-20T22:09:11.1485691Z      GET_BY_ID = """
2026-02-20T22:09:11.1485824Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1485984Z      WHERE id = %s AND is_archived = false
2026-02-20T22:09:11.1486099Z      """
2026-02-20T22:09:11.1486202Z -    
2026-02-20T22:09:11.1486301Z +
2026-02-20T22:09:11.1486578Z      # Requêtes optimisées avec index hints
2026-02-20T22:09:11.1486708Z      GET_BY_TYPE = """
2026-02-20T22:09:11.1486844Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1487056Z      WHERE exercise_type = %s AND is_archived = false
2026-02-20T22:09:11.1487289Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1487401Z      LIMIT 50
2026-02-20T22:09:11.1487511Z      """
2026-02-20T22:09:11.1487627Z -    
2026-02-20T22:09:11.1487731Z +
2026-02-20T22:09:11.1487869Z      GET_BY_DIFFICULTY = """
2026-02-20T22:09:11.1488005Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1488453Z      WHERE difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1488594Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1488708Z      LIMIT 50
2026-02-20T22:09:11.1488822Z      """
2026-02-20T22:09:11.1488925Z -    
2026-02-20T22:09:11.1489028Z +
2026-02-20T22:09:11.1489182Z      GET_BY_TYPE_AND_DIFFICULTY = """
2026-02-20T22:09:11.1489308Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1489618Z      WHERE exercise_type = %s AND difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1489755Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1489873Z      LIMIT 50
2026-02-20T22:09:11.1489975Z      """
2026-02-20T22:09:11.1490087Z -    
2026-02-20T22:09:11.1490201Z +
2026-02-20T22:09:11.1490764Z      # Requêtes aléatoires optimisées avec TABLESAMPLE pour de meilleures performances
2026-02-20T22:09:11.1490893Z      GET_RANDOM = """
2026-02-20T22:09:11.1491026Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1491167Z      WHERE is_archived = false
2026-02-20T22:09:11.1491289Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1491406Z      LIMIT 1
2026-02-20T22:09:11.1491512Z      """
2026-02-20T22:09:11.1491600Z -    
2026-02-20T22:09:11.1491685Z +
2026-02-20T22:09:11.1491793Z      GET_RANDOM_BY_TYPE = """
2026-02-20T22:09:11.1491908Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1492072Z      WHERE exercise_type = %s AND is_archived = false
2026-02-20T22:09:11.1492174Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1492269Z      LIMIT 1
2026-02-20T22:09:11.1492355Z      """
2026-02-20T22:09:11.1492438Z -    
2026-02-20T22:09:11.1492525Z +
2026-02-20T22:09:11.1492651Z      GET_RANDOM_BY_DIFFICULTY = """
2026-02-20T22:09:11.1492757Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1492928Z      WHERE difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1493227Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1493317Z      LIMIT 1
2026-02-20T22:09:11.1493407Z      """
2026-02-20T22:09:11.1493495Z -    
2026-02-20T22:09:11.1493583Z +
2026-02-20T22:09:11.1493722Z      GET_RANDOM_BY_TYPE_AND_DIFFICULTY = """
2026-02-20T22:09:11.1493837Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1494094Z      WHERE exercise_type = %s AND difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1494204Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1494297Z      LIMIT 1
2026-02-20T22:09:11.1494383Z      """
2026-02-20T22:09:11.1494471Z -    
2026-02-20T22:09:11.1494554Z +
2026-02-20T22:09:11.1494785Z      # Requête optimisée pour la pagination
2026-02-20T22:09:11.1494905Z      GET_PAGINATED = """
2026-02-20T22:09:11.1495016Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1495135Z      WHERE is_archived = false
2026-02-20T22:09:11.1495250Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1495578Z      LIMIT %s OFFSET %s
2026-02-20T22:09:11.1495671Z      """
2026-02-20T22:09:11.1495764Z -    
2026-02-20T22:09:11.1495859Z +
2026-02-20T22:09:11.1496003Z      # Comptage optimisé
2026-02-20T22:09:11.1496111Z      COUNT_ACTIVE = """
2026-02-20T22:09:11.1496238Z      SELECT COUNT(*) FROM exercises 
2026-02-20T22:09:11.1496381Z      WHERE is_archived = false
2026-02-20T22:09:11.1496476Z      """
2026-02-20T22:09:11.1496573Z -    
2026-02-20T22:09:11.1496672Z +
2026-02-20T22:09:11.1496857Z      # Insertion avec RETURNING optimisé
2026-02-20T22:09:11.1496959Z      INSERT = """
2026-02-20T22:09:11.1497069Z      INSERT INTO exercises 
2026-02-20T22:09:11.1497400Z      (title, creator_id, exercise_type, difficulty, tags, question, correct_answer, 
2026-02-20T22:09:11.1497653Z      choices, explanation, hint, image_url, audio_url, ai_generated) 
2026-02-20T22:09:11.1497860Z      VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
2026-02-20T22:09:11.1497986Z      RETURNING id, created_at
2026-02-20T22:09:11.1498089Z      """
2026-02-20T22:09:11.1498182Z -    
2026-02-20T22:09:11.1498280Z +
2026-02-20T22:09:11.1498440Z      # Mise à jour
2026-02-20T22:09:11.1498547Z      UPDATE = """
2026-02-20T22:09:11.1498657Z      UPDATE exercises 
2026-02-20T22:09:11.1498977Z      SET title = %s, exercise_type = %s, difficulty = %s, tags = %s, question = %s, 
2026-02-20T22:09:11.1499492Z      correct_answer = %s, choices = %s, explanation = %s, hint = %s, image_url = %s, 
2026-02-20T22:09:11.1499682Z      audio_url = %s, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1499799Z      WHERE id = %s
2026-02-20T22:09:11.1499899Z      """
2026-02-20T22:09:11.1499988Z -    
2026-02-20T22:09:11.1500080Z +
2026-02-20T22:09:11.1500185Z      ARCHIVE = """
2026-02-20T22:09:11.1500291Z      UPDATE exercises 
2026-02-20T22:09:11.1500484Z      SET is_archived = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1500591Z      WHERE id = %s
2026-02-20T22:09:11.1500677Z      """
2026-02-20T22:09:11.1500769Z -    
2026-02-20T22:09:11.1500849Z +
2026-02-20T22:09:11.1500945Z      ACTIVATE = """
2026-02-20T22:09:11.1501043Z      UPDATE exercises 
2026-02-20T22:09:11.1501209Z      SET is_active = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1501325Z      WHERE id = %s
2026-02-20T22:09:11.1501435Z      """
2026-02-20T22:09:11.1501528Z -    
2026-02-20T22:09:11.1501617Z +
2026-02-20T22:09:11.1501749Z      DEACTIVATE = """
2026-02-20T22:09:11.1501861Z      UPDATE exercises 
2026-02-20T22:09:11.1502066Z      SET is_active = false, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1502181Z      WHERE id = %s
2026-02-20T22:09:11.1502275Z      """
2026-02-20T22:09:11.1502357Z -    
2026-02-20T22:09:11.1502460Z +
2026-02-20T22:09:11.1502583Z      # Suppression
2026-02-20T22:09:11.1502692Z      DELETE = """
2026-02-20T22:09:11.1502811Z      UPDATE exercises 
2026-02-20T22:09:11.1503206Z      SET is_archived = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1503327Z      WHERE id = %s
2026-02-20T22:09:11.1503440Z      """
2026-02-20T22:09:11.1503544Z -    
2026-02-20T22:09:11.1503654Z +
2026-02-20T22:09:11.1504151Z      # Suppression physique (pour administration avancée ou migrations)
2026-02-20T22:09:11.1504297Z      DELETE_PERMANENT = """
2026-02-20T22:09:11.1504443Z      DELETE FROM exercises 
2026-02-20T22:09:11.1504558Z      WHERE id = %s
2026-02-20T22:09:11.1504675Z      """
2026-02-20T22:09:11.1504779Z +
2026-02-20T22:09:11.1504891Z  
2026-02-20T22:09:11.1505129Z  # Requêtes pour la table 'results'
2026-02-20T22:09:11.1505264Z  class ResultQueries:
2026-02-20T22:09:11.1505485Z      # Création et modification
2026-02-20T22:09:11.1505615Z      CREATE_TABLE = """
2026-02-20T22:09:11.1505731Z @@ -176,38 +178,39 @@
2026-02-20T22:09:11.1505864Z          attempt_count INTEGER,
2026-02-20T22:09:11.1505997Z          time_spent REAL,
2026-02-20T22:09:11.1506210Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1506317Z      )
2026-02-20T22:09:11.1506430Z      """
2026-02-20T22:09:11.1506757Z -    
2026-02-20T22:09:11.1506867Z +
2026-02-20T22:09:11.1507048Z      # Sélection
2026-02-20T22:09:11.1507189Z      GET_BY_USER = """
2026-02-20T22:09:11.1507318Z      SELECT * FROM results 
2026-02-20T22:09:11.1507442Z      WHERE user_id = %s
2026-02-20T22:09:11.1507584Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1507701Z      """
2026-02-20T22:09:11.1507801Z -    
2026-02-20T22:09:11.1507909Z +
2026-02-20T22:09:11.1508047Z      GET_BY_EXERCISE = """
2026-02-20T22:09:11.1508174Z      SELECT * FROM results 
2026-02-20T22:09:11.1508303Z      WHERE exercise_id = %s
2026-02-20T22:09:11.1508447Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1508555Z      """
2026-02-20T22:09:11.1508659Z -    
2026-02-20T22:09:11.1508762Z +
2026-02-20T22:09:11.1508910Z      GET_BY_USER_AND_EXERCISE = """
2026-02-20T22:09:11.1509033Z      SELECT * FROM results 
2026-02-20T22:09:11.1509196Z      WHERE user_id = %s AND exercise_id = %s
2026-02-20T22:09:11.1509336Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1509450Z      """
2026-02-20T22:09:11.1509554Z -    
2026-02-20T22:09:11.1509658Z +
2026-02-20T22:09:11.1509782Z      # Insertion
2026-02-20T22:09:11.1509900Z      INSERT = """
2026-02-20T22:09:11.1510035Z      INSERT INTO results 
2026-02-20T22:09:11.1510270Z      (exercise_id, is_correct, attempt_count, time_spent) 
2026-02-20T22:09:11.1510611Z      VALUES (%s, %s, %s, %s)
2026-02-20T22:09:11.1510732Z      RETURNING id
2026-02-20T22:09:11.1510839Z      """
2026-02-20T22:09:11.1510949Z  
2026-02-20T22:09:11.1511050Z +
2026-02-20T22:09:11.1511287Z  # Requêtes pour les statistiques
2026-02-20T22:09:11.1511434Z  class UserStatsQueries:
2026-02-20T22:09:11.1511604Z      # Statistiques globales par utilisateur
2026-02-20T22:09:11.1511737Z      GET_USER_STATS = """
2026-02-20T22:09:11.1511849Z      SELECT 
2026-02-20T22:09:11.1511969Z @@ -216,11 +219,11 @@
2026-02-20T22:09:11.1512257Z          AVG(CASE WHEN is_correct THEN 1 ELSE 0 END) * 100 as success_rate,
2026-02-20T22:09:11.1512408Z          AVG(time_taken) as avg_time_taken
2026-02-20T22:09:11.1512545Z      FROM results 
2026-02-20T22:09:11.1512668Z      WHERE user_id = %s
2026-02-20T22:09:11.1512771Z      """
2026-02-20T22:09:11.1512877Z -    
2026-02-20T22:09:11.1513190Z +
2026-02-20T22:09:11.1513362Z      # Statistiques par type d'exercice
2026-02-20T22:09:11.1513509Z      GET_USER_STATS_BY_TYPE = """
2026-02-20T22:09:11.1513636Z      SELECT 
2026-02-20T22:09:11.1513763Z          e.exercise_type,
2026-02-20T22:09:11.1513904Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1514019Z @@ -230,11 +233,11 @@
2026-02-20T22:09:11.1514145Z      FROM results r
2026-02-20T22:09:11.1514320Z      JOIN exercises e ON r.exercise_id = e.id
2026-02-20T22:09:11.1514446Z      WHERE r.user_id = %s
2026-02-20T22:09:11.1514591Z      GROUP BY e.exercise_type
2026-02-20T22:09:11.1514701Z      """
2026-02-20T22:09:11.1514805Z -    
2026-02-20T22:09:11.1514910Z +
2026-02-20T22:09:11.1515146Z      # Statistiques par niveau de difficulté
2026-02-20T22:09:11.1515305Z      GET_USER_STATS_BY_DIFFICULTY = """
2026-02-20T22:09:11.1515413Z      SELECT 
2026-02-20T22:09:11.1515544Z          e.difficulty,
2026-02-20T22:09:11.1515685Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1515798Z @@ -244,11 +247,11 @@
2026-02-20T22:09:11.1515920Z      FROM results r
2026-02-20T22:09:11.1516091Z      JOIN exercises e ON r.exercise_id = e.id
2026-02-20T22:09:11.1516226Z      WHERE r.user_id = %s
2026-02-20T22:09:11.1516357Z      GROUP BY e.difficulty
2026-02-20T22:09:11.1516471Z      """
2026-02-20T22:09:11.1516574Z -    
2026-02-20T22:09:11.1516677Z +
2026-02-20T22:09:11.1516854Z      # Progression dans le temps (par jour)
2026-02-20T22:09:11.1517003Z      GET_USER_PROGRESS_BY_DAY = """
2026-02-20T22:09:11.1517113Z      SELECT 
2026-02-20T22:09:11.1517272Z          DATE(r.created_at) as exercise_date,
2026-02-20T22:09:11.1517422Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1517535Z @@ -268,10 +271,11 @@
2026-02-20T22:09:11.1517646Z      FROM results
2026-02-20T22:09:11.1518014Z      GROUP BY DATE(created_at)
2026-02-20T22:09:11.1518163Z      ORDER BY exercise_date DESC
2026-02-20T22:09:11.1518274Z      LIMIT 30
2026-02-20T22:09:11.1518381Z      """
2026-02-20T22:09:11.1518487Z +
2026-02-20T22:09:11.1518590Z  
2026-02-20T22:09:11.1518826Z  # Requêtes pour la table 'users'
2026-02-20T22:09:11.1518954Z  class UserQueries:
2026-02-20T22:09:11.1519167Z      # Création et modification
2026-02-20T22:09:11.1519295Z      CREATE_TABLE = """
2026-02-20T22:09:11.1519410Z @@ -284,62 +288,63 @@
2026-02-20T22:09:11.1519573Z          is_active BOOLEAN DEFAULT TRUE,
2026-02-20T22:09:11.1519716Z          is_admin BOOLEAN DEFAULT FALSE,
2026-02-20T22:09:11.1519936Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1520052Z      )
2026-02-20T22:09:11.1520165Z      """
2026-02-20T22:09:11.1520270Z -    
2026-02-20T22:09:11.1520373Z +
2026-02-20T22:09:11.1520556Z      # Sélection
2026-02-20T22:09:11.1520672Z      GET_ALL = """
2026-02-20T22:09:11.1521003Z      SELECT id, username, email, full_name, is_active, is_admin, created_at
2026-02-20T22:09:11.1521124Z      FROM users
2026-02-20T22:09:11.1521235Z      ORDER BY id
2026-02-20T22:09:11.1521337Z      """
2026-02-20T22:09:11.1521441Z -    
2026-02-20T22:09:11.1521550Z +
2026-02-20T22:09:11.1521672Z      GET_BY_ID = """
2026-02-20T22:09:11.1521982Z      SELECT id, username, email, full_name, is_active, is_admin, created_at
2026-02-20T22:09:11.1522315Z      FROM users
2026-02-20T22:09:11.1522431Z      WHERE id = %s
2026-02-20T22:09:11.1522538Z      """
2026-02-20T22:09:11.1522644Z -    
2026-02-20T22:09:11.1522753Z +
2026-02-20T22:09:11.1522888Z      GET_BY_USERNAME = """
2026-02-20T22:09:11.1523495Z      SELECT id, username, email, full_name, is_active, is_admin, created_at, hashed_password
2026-02-20T22:09:11.1523624Z      FROM users
2026-02-20T22:09:11.1523754Z      WHERE username = %s
2026-02-20T22:09:11.1523862Z      """
2026-02-20T22:09:11.1523966Z -    
2026-02-20T22:09:11.1524076Z +
2026-02-20T22:09:11.1524207Z      GET_BY_EMAIL = """
2026-02-20T22:09:11.1524606Z      SELECT id, username, email, full_name, is_active, is_admin, created_at, hashed_password
2026-02-20T22:09:11.1524723Z      FROM users
2026-02-20T22:09:11.1524846Z      WHERE email = %s
2026-02-20T22:09:11.1524951Z      """
2026-02-20T22:09:11.1525055Z -    
2026-02-20T22:09:11.1525167Z +
2026-02-20T22:09:11.1525286Z      # Insertion
2026-02-20T22:09:11.1525400Z      INSERT = """
2026-02-20T22:09:11.1525528Z      INSERT INTO users 
2026-02-20T22:09:11.1525830Z      (username, email, full_name, hashed_password, is_active, is_admin) 
2026-02-20T22:09:11.1525967Z      VALUES (%s, %s, %s, %s, %s, %s)
2026-02-20T22:09:11.1526080Z      RETURNING id
2026-02-20T22:09:11.1526192Z      """
2026-02-20T22:09:11.1526300Z -    
2026-02-20T22:09:11.1526405Z +
2026-02-20T22:09:11.1526607Z      # Mise à jour
2026-02-20T22:09:11.1526720Z      UPDATE = """
2026-02-20T22:09:11.1526837Z      UPDATE users 
2026-02-20T22:09:11.1527097Z      SET username = %s, email = %s, full_name = %s, is_active = %s
2026-02-20T22:09:11.1527234Z      WHERE id = %s
2026-02-20T22:09:11.1527346Z      """
2026-02-20T22:09:11.1527447Z -    
2026-02-20T22:09:11.1527559Z +
2026-02-20T22:09:11.1527696Z      UPDATE_PASSWORD = """
2026-02-20T22:09:11.1527810Z      UPDATE users 
2026-02-20T22:09:11.1527943Z      SET hashed_password = %s
2026-02-20T22:09:11.1528074Z      WHERE id = %s
2026-02-20T22:09:11.1528180Z      """
2026-02-20T22:09:11.1528285Z -    
2026-02-20T22:09:11.1528399Z +
2026-02-20T22:09:11.1528514Z      # Suppression
2026-02-20T22:09:11.1528631Z      DELETE = """
2026-02-20T22:09:11.1528759Z      DELETE FROM users 
2026-02-20T22:09:11.1528877Z      WHERE id = %s
2026-02-20T22:09:11.1528984Z      """
2026-02-20T22:09:11.1529087Z +
2026-02-20T22:09:11.1529197Z  
2026-02-20T22:09:11.1529435Z  # Requêtes pour la table 'settings'
2026-02-20T22:09:11.1529569Z  class SettingQueries:
2026-02-20T22:09:11.1529771Z      # Création et modification
2026-02-20T22:09:11.1529911Z      CREATE_TABLE = """
2026-02-20T22:09:11.1530239Z @@ -351,23 +356,23 @@
2026-02-20T22:09:11.1530402Z          is_active BOOLEAN DEFAULT TRUE,
2026-02-20T22:09:11.1530625Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
2026-02-20T22:09:11.1530842Z          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1530950Z      )
2026-02-20T22:09:11.1531070Z      """
2026-02-20T22:09:11.1531180Z -    
2026-02-20T22:09:11.1531282Z +
2026-02-20T22:09:11.1531460Z      # Sélection
2026-02-20T22:09:11.1531592Z      GET_ALL = """
2026-02-20T22:09:11.1531724Z      SELECT * FROM settings
2026-02-20T22:09:11.1531854Z      WHERE is_active = true
2026-02-20T22:09:11.1531969Z      ORDER BY key
2026-02-20T22:09:11.1532081Z      """
2026-02-20T22:09:11.1532184Z -    
2026-02-20T22:09:11.1532287Z +
2026-02-20T22:09:11.1532417Z      GET_BY_KEY = """
2026-02-20T22:09:11.1532547Z      SELECT * FROM settings
2026-02-20T22:09:11.1532697Z      WHERE key = %s AND is_active = true
2026-02-20T22:09:11.1532796Z      """
2026-02-20T22:09:11.1532914Z -    
2026-02-20T22:09:11.1533191Z +
2026-02-20T22:09:11.1533311Z      # Insertion
2026-02-20T22:09:11.1533439Z      INSERT = """
2026-02-20T22:09:11.1533577Z      INSERT INTO settings 
2026-02-20T22:09:11.1533733Z      (key, value, description, is_active) 
2026-02-20T22:09:11.1533866Z      VALUES (%s, %s, %s, %s)
2026-02-20T22:09:11.1534188Z @@ -375,18 +380,18 @@
2026-02-20T22:09:11.1534359Z      DO UPDATE SET value = EXCLUDED.value, 
2026-02-20T22:09:11.1534557Z                   description = EXCLUDED.description,
2026-02-20T22:09:11.1534728Z                   updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1534843Z      RETURNING id
2026-02-20T22:09:11.1534948Z      """
2026-02-20T22:09:11.1535052Z -    
2026-02-20T22:09:11.1535162Z +
2026-02-20T22:09:11.1535357Z      # Mise à jour
2026-02-20T22:09:11.1535474Z      UPDATE = """
2026-02-20T22:09:11.1535609Z      UPDATE settings 
2026-02-20T22:09:11.1535886Z      SET value = %s, description = %s, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1536015Z      WHERE key = %s
2026-02-20T22:09:11.1536187Z      """
2026-02-20T22:09:11.1536305Z -    
2026-02-20T22:09:11.1536410Z +
2026-02-20T22:09:11.1536527Z      # Suppression
2026-02-20T22:09:11.1536646Z      DELETE = """
2026-02-20T22:09:11.1536776Z      DELETE FROM settings 
2026-02-20T22:09:11.1536892Z      WHERE key = %s
2026-02-20T22:09:11.1537011Z -    """ 
2026-02-20T22:09:11.1537161Z \ No newline at end of file
2026-02-20T22:09:11.1537266Z +    """
2026-02-20T22:09:11.1727142Z --- /home/runner/work/mathakine/mathakine/app/models/achievement.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1728985Z +++ /home/runner/work/mathakine/mathakine/app/models/achievement.py	2026-02-20 22:09:11.171493+00:00
2026-02-20T22:09:11.1730309Z @@ -1,22 +1,31 @@
2026-02-20T22:09:11.1731588Z  """
2026-02-20T22:09:11.1733415Z  Modèles SQLAlchemy pour le système de badges
2026-02-20T22:09:11.1734787Z  """
2026-02-20T22:09:11.1736441Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.1737844Z -                        Integer, String, Text)
2026-02-20T22:09:11.1758643Z +
2026-02-20T22:09:11.1758820Z +from sqlalchemy import (
2026-02-20T22:09:11.1758943Z +    JSON,
2026-02-20T22:09:11.1759058Z +    Boolean,
2026-02-20T22:09:11.1759172Z +    Column,
2026-02-20T22:09:11.1759286Z +    DateTime,
2026-02-20T22:09:11.1759433Z +    ForeignKey,
2026-02-20T22:09:11.1759547Z +    Index,
2026-02-20T22:09:11.1759660Z +    Integer,
2026-02-20T22:09:11.1759782Z +    String,
2026-02-20T22:09:11.1759897Z +    Text,
2026-02-20T22:09:11.1760002Z +)
2026-02-20T22:09:11.1760180Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.1760339Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.1760442Z  
2026-02-20T22:09:11.1760588Z  from app.db.base import Base
2026-02-20T22:09:11.1760706Z  
2026-02-20T22:09:11.1761399Z  
2026-02-20T22:09:11.1762136Z  class Achievement(Base):
2026-02-20T22:09:11.1762666Z      """Modèle pour les badges/achievements"""
2026-02-20T22:09:11.1763405Z +
2026-02-20T22:09:11.1763556Z      __tablename__ = "achievements"
2026-02-20T22:09:11.1763679Z -    __table_args__ = (
2026-02-20T22:09:11.1763898Z -        Index('idx_achievements_category', 'category'),
2026-02-20T22:09:11.1764010Z -    )
2026-02-20T22:09:11.1764292Z +    __table_args__ = (Index("idx_achievements_category", "category"),)
2026-02-20T22:09:11.1764424Z  
2026-02-20T22:09:11.1764634Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1764929Z      code = Column(String(100), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.1765109Z      name = Column(String(255), nullable=False)
2026-02-20T22:09:11.1765288Z      description = Column(Text, nullable=True)
2026-02-20T22:09:11.1765404Z @@ -29,28 +38,37 @@
2026-02-20T22:09:11.1765616Z      star_wars_title = Column(String(255), nullable=True)
2026-02-20T22:09:11.1765817Z      is_active = Column(Boolean, default=True, index=True)
2026-02-20T22:09:11.1766069Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.1766182Z  
2026-02-20T22:09:11.1766296Z      # Relations
2026-02-20T22:09:11.1766846Z -    user_achievements = relationship("UserAchievement", back_populates="achievement", cascade="all, delete-orphan")
2026-02-20T22:09:11.1767001Z +    user_achievements = relationship(
2026-02-20T22:09:11.1767363Z +        "UserAchievement", back_populates="achievement", cascade="all, delete-orphan"
2026-02-20T22:09:11.1767734Z +    )
2026-02-20T22:09:11.1767841Z  
2026-02-20T22:09:11.1767973Z      def __repr__(self):
2026-02-20T22:09:11.1768285Z          return f"<Achievement {self.code}: {self.name} ({self.difficulty})>"
2026-02-20T22:09:11.1768389Z  
2026-02-20T22:09:11.1768483Z  
2026-02-20T22:09:11.1768621Z  class UserAchievement(Base):
2026-02-20T22:09:11.1769032Z      """Modèle pour les badges obtenus par les utilisateurs"""
2026-02-20T22:09:11.1769135Z +
2026-02-20T22:09:11.1769317Z      __tablename__ = "user_achievements"
2026-02-20T22:09:11.1769424Z  
2026-02-20T22:09:11.1769636Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1770080Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
2026-02-20T22:09:11.1770533Z -    achievement_id = Column(Integer, ForeignKey("achievements.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.1770661Z +    user_id = Column(
2026-02-20T22:09:11.1771001Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True
2026-02-20T22:09:11.1771118Z +    )
2026-02-20T22:09:11.1771251Z +    achievement_id = Column(
2026-02-20T22:09:11.1771586Z +        Integer, ForeignKey("achievements.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.1771698Z +    )
2026-02-20T22:09:11.1772053Z      earned_at = Column(DateTime(timezone=True), default=func.now(), index=True)
2026-02-20T22:09:11.1772228Z      progress_data = Column(JSON, nullable=True)
2026-02-20T22:09:11.1772410Z      is_displayed = Column(Boolean, default=True)
2026-02-20T22:09:11.1772536Z  
2026-02-20T22:09:11.1772652Z      # Relations
2026-02-20T22:09:11.1772925Z      user = relationship("User", back_populates="user_achievements")
2026-02-20T22:09:11.1773478Z      achievement = relationship("Achievement", back_populates="user_achievements")
2026-02-20T22:09:11.1773580Z  
2026-02-20T22:09:11.1773705Z      def __repr__(self):
2026-02-20T22:09:11.1774114Z -        return f"<UserAchievement: User {self.user_id}, Achievement {self.achievement_id}>"
2026-02-20T22:09:11.1774234Z +        return (
2026-02-20T22:09:11.1774570Z +            f"<UserAchievement: User {self.user_id}, Achievement {self.achievement_id}>"
2026-02-20T22:09:11.1774675Z +        )
2026-02-20T22:09:11.1775053Z would reformat /home/runner/work/mathakine/mathakine/app/models/achievement.py
2026-02-20T22:09:11.1965986Z --- /home/runner/work/mathakine/mathakine/app/models/all_models.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1970931Z would reformat /home/runner/work/mathakine/mathakine/app/models/all_models.py
2026-02-20T22:09:11.1971758Z +++ /home/runner/work/mathakine/mathakine/app/models/all_models.py	2026-02-20 22:09:11.192082+00:00
2026-02-20T22:09:11.1971898Z @@ -5,13 +5,16 @@
2026-02-20T22:09:11.1972008Z  
2026-02-20T22:09:11.1972265Z  from app.models.admin_audit_log import AdminAuditLog
2026-02-20T22:09:11.1972559Z  from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:11.1972749Z  from app.models.attempt import Attempt
2026-02-20T22:09:11.1973290Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:11.1973600Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:11.1973788Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:11.1973973Z -                                        LogicChallengeType)
2026-02-20T22:09:11.1974159Z +from app.models.logic_challenge import (
2026-02-20T22:09:11.1974282Z +    AgeGroup,
2026-02-20T22:09:11.1974418Z +    LogicChallenge,
2026-02-20T22:09:11.1974583Z +    LogicChallengeAttempt,
2026-02-20T22:09:11.1974719Z +    LogicChallengeType,
2026-02-20T22:09:11.1974824Z +)
2026-02-20T22:09:11.1975029Z  from app.models.notification import Notification
2026-02-20T22:09:11.1975212Z  from app.models.progress import Progress
2026-02-20T22:09:11.1975432Z  from app.models.recommendation import Recommendation
2026-02-20T22:09:11.1975828Z  from app.models.setting import Setting
2026-02-20T22:09:11.1975998Z  from app.models.user import User, UserRole
2026-02-20T22:09:11.2416000Z --- /home/runner/work/mathakine/mathakine/app/models/attempt.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2424011Z would reformat /home/runner/work/mathakine/mathakine/app/models/attempt.py
2026-02-20T22:09:11.2425015Z +++ /home/runner/work/mathakine/mathakine/app/models/attempt.py	2026-02-20 22:09:11.240426+00:00
2026-02-20T22:09:11.2426498Z @@ -1,45 +1,58 @@
2026-02-20T22:09:11.2428524Z -from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Index, Integer,
2026-02-20T22:09:11.2429279Z -                        String)
2026-02-20T22:09:11.2429663Z +from sqlalchemy import (
2026-02-20T22:09:11.2429999Z +    Boolean,
2026-02-20T22:09:11.2430260Z +    Column,
2026-02-20T22:09:11.2430538Z +    DateTime,
2026-02-20T22:09:11.2430814Z +    Float,
2026-02-20T22:09:11.2431294Z +    ForeignKey,
2026-02-20T22:09:11.2431634Z +    Index,
2026-02-20T22:09:11.2432193Z +    Integer,
2026-02-20T22:09:11.2432573Z +    String,
2026-02-20T22:09:11.2432884Z +)
2026-02-20T22:09:11.2463871Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2464488Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.2464995Z  
2026-02-20T22:09:11.2465470Z  from app.db.base import Base
2026-02-20T22:09:11.2465973Z  
2026-02-20T22:09:11.2466363Z  
2026-02-20T22:09:11.2479345Z  class Attempt(Base):
2026-02-20T22:09:11.2480480Z      """Modèle pour les tentatives de résolution d'exercices (Tentatives d'Accomplissement)"""
2026-02-20T22:09:11.2481224Z +
2026-02-20T22:09:11.2481499Z      __tablename__ = "attempts"
2026-02-20T22:09:11.2481886Z -    
2026-02-20T22:09:11.2482145Z +
2026-02-20T22:09:11.2482598Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.2483308Z      __table_args__ = (
2026-02-20T22:09:11.2483803Z -        Index('ix_attempts_user_exercise', 'user_id', 'exercise_id'),
2026-02-20T22:09:11.2484515Z -        Index('ix_attempts_user_correct', 'user_id', 'is_correct'),
2026-02-20T22:09:11.2485222Z +        Index("ix_attempts_user_exercise", "user_id", "exercise_id"),
2026-02-20T22:09:11.2485901Z +        Index("ix_attempts_user_correct", "user_id", "is_correct"),
2026-02-20T22:09:11.2486417Z      )
2026-02-20T22:09:11.2486677Z  
2026-02-20T22:09:11.2487027Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.2487506Z  
2026-02-20T22:09:11.2487866Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.2488581Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.2489351Z      user = relationship("User", back_populates="attempts")
2026-02-20T22:09:11.2490551Z -    exercise_id = Column(Integer, ForeignKey("exercises.id"), nullable=False, index=True)
2026-02-20T22:09:11.2491298Z +    exercise_id = Column(
2026-02-20T22:09:11.2491832Z +        Integer, ForeignKey("exercises.id"), nullable=False, index=True
2026-02-20T22:09:11.2492421Z +    )
2026-02-20T22:09:11.2492865Z      exercise = relationship("Exercise", back_populates="attempts")
2026-02-20T22:09:11.2493586Z  
2026-02-20T22:09:11.2493976Z      # Données de tentative
2026-02-20T22:09:11.2494405Z      user_answer = Column(String, nullable=False)
2026-02-20T22:09:11.2495244Z      is_correct = Column(Boolean, nullable=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.2496165Z      time_spent = Column(Float, nullable=True)  # Temps passé en secondes
2026-02-20T22:09:11.2496733Z  
2026-02-20T22:09:11.2497026Z      # Métadonnées
2026-02-20T22:09:11.2497863Z -    attempt_number = Column(Integer, default=1)  # Numéro de tentative pour cet exercice et cet utilisateur
2026-02-20T22:09:11.2498722Z +    attempt_number = Column(
2026-02-20T22:09:11.2499117Z +        Integer, default=1
2026-02-20T22:09:11.2499769Z +    )  # Numéro de tentative pour cet exercice et cet utilisateur
2026-02-20T22:09:11.2500633Z      hints_used = Column(Integer, default=0)  # Nombre d'indices utilisés
2026-02-20T22:09:11.2501875Z      device_info = Column(String, nullable=True)  # Information sur l'appareil utilisé
2026-02-20T22:09:11.2502560Z  
2026-02-20T22:09:11.2502829Z      # Horodatage
2026-02-20T22:09:11.2503686Z -    created_at = Column(DateTime(timezone=True), default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.2504478Z -
2026-02-20T22:09:11.2504738Z -
2026-02-20T22:09:11.2505005Z +    created_at = Column(
2026-02-20T22:09:11.2505491Z +        DateTime(timezone=True), default=func.now(), index=True
2026-02-20T22:09:11.2506048Z +    )  # Tri chronologique
2026-02-20T22:09:11.2506398Z  
2026-02-20T22:09:11.2506668Z      def __repr__(self):
2026-02-20T22:09:11.2507267Z          status = "réussie" if self.is_correct else "échouée"
2026-02-20T22:09:11.2508071Z          return f"<Tentative {self.id}: Utilisateur {self.user_id}, Exercice {self.exercise_id}\
2026-02-20T22:09:11.2508782Z              , {status}>"
2026-02-20T22:09:11.2734893Z --- /home/runner/work/mathakine/mathakine/app/db/transaction.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2736632Z +++ /home/runner/work/mathakine/mathakine/app/db/transaction.py	2026-02-20 22:09:11.270721+00:00
2026-02-20T22:09:11.2737622Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.2738081Z  """
2026-02-20T22:09:11.2738730Z  Transaction management utilities for database operations in Mathakine.
2026-02-20T22:09:11.2741117Z  This module provides consistent transaction management across the application.
2026-02-20T22:09:11.2742394Z  """
2026-02-20T22:09:11.2742804Z +
2026-02-20T22:09:11.2743288Z  from contextlib import contextmanager
2026-02-20T22:09:11.2743705Z  
2026-02-20T22:09:11.2744032Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.2744496Z  
2026-02-20T22:09:11.2744761Z  logger = get_logger(__name__)
2026-02-20T22:09:11.2745152Z @@ -15,25 +16,25 @@
2026-02-20T22:09:11.2745465Z      """
2026-02-20T22:09:11.2746182Z      Gère les transactions de base de données de manière unifiée.
2026-02-20T22:09:11.2747137Z      Fournit des méthodes pour démarrer, valider et annuler des transactions,
2026-02-20T22:09:11.2748151Z      ainsi qu'un gestionnaire de contexte pour une utilisation simplifiée.
2026-02-20T22:09:11.2748792Z      """
2026-02-20T22:09:11.2749070Z -    
2026-02-20T22:09:11.2749352Z +
2026-02-20T22:09:11.2749619Z      @staticmethod
2026-02-20T22:09:11.2750029Z      @contextmanager
2026-02-20T22:09:11.2750626Z      def transaction(db_session: Session, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2751300Z          """
2026-02-20T22:09:11.2751971Z          Gestionnaire de contexte pour les transactions de base de données.
2026-02-20T22:09:11.2752619Z -        
2026-02-20T22:09:11.2753448Z +
2026-02-20T22:09:11.2753729Z          Args:
2026-02-20T22:09:11.2754248Z              db_session: Session SQLAlchemy à utiliser
2026-02-20T22:09:11.2755067Z              auto_commit: Si True, commit automatiquement à la fin du bloc
2026-02-20T22:09:11.2755916Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2756501Z -            
2026-02-20T22:09:11.2756818Z +
2026-02-20T22:09:11.2757084Z          Yields:
2026-02-20T22:09:11.2757578Z              Session: La session de base de données
2026-02-20T22:09:11.2758033Z -            
2026-02-20T22:09:11.2758328Z +
2026-02-20T22:09:11.2758586Z          Usage:
2026-02-20T22:09:11.2759034Z              with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.2759734Z                  # Effectuer des opérations
2026-02-20T22:09:11.2760204Z                  session.add(model)
2026-02-20T22:09:11.2760977Z                  # Pas besoin de faire session.commit() - c'est géré automatiquement
2026-02-20T22:09:11.2761642Z @@ -41,157 +42,187 @@
2026-02-20T22:09:11.2762295Z          # Créer un point de sauvegarde pour permettre un rollback partiel
2026-02-20T22:09:11.2763358Z          # même si nous sommes dans une transaction externe
2026-02-20T22:09:11.2763883Z          try:
2026-02-20T22:09:11.2764239Z              savepoint = db_session.begin_nested()
2026-02-20T22:09:11.2765460Z              logger.debug(f"{log_prefix}: Début de la transaction (avec savepoint)")
2026-02-20T22:09:11.2766064Z -            
2026-02-20T22:09:11.2766341Z +
2026-02-20T22:09:11.2766617Z              yield db_session
2026-02-20T22:09:11.2766984Z -            
2026-02-20T22:09:11.2767271Z +
2026-02-20T22:09:11.2767543Z              if auto_commit:
2026-02-20T22:09:11.2767942Z                  # Commit du savepoint
2026-02-20T22:09:11.2768378Z                  savepoint.commit()
2026-02-20T22:09:11.2769138Z                  # Commit de la transaction principale si nous ne sommes pas dans une transaction de test
2026-02-20T22:09:11.2769963Z                  if not savepoint.is_active:
2026-02-20T22:09:11.2770431Z                      db_session.commit()
2026-02-20T22:09:11.2771166Z                  logger.debug(f"{log_prefix}: Transaction validée (commit)")
2026-02-20T22:09:11.2771832Z          except Exception as savepoint_error:
2026-02-20T22:09:11.2772307Z              # Rollback au savepoint
2026-02-20T22:09:11.2772848Z -            if 'savepoint' in locals() and savepoint.is_active:
2026-02-20T22:09:11.2773676Z +            if "savepoint" in locals() and savepoint.is_active:
2026-02-20T22:09:11.2774240Z                  savepoint.rollback()
2026-02-20T22:09:11.2774929Z              # Également rollback de la transaction principale
2026-02-20T22:09:11.2775499Z              db_session.rollback()
2026-02-20T22:09:11.2776506Z -            logger.error(f"{log_prefix}: Transaction annulée (rollback) suite à l'erreur: {savepoint_error}")
2026-02-20T22:09:11.2777356Z +            logger.error(
2026-02-20T22:09:11.2778195Z +                f"{log_prefix}: Transaction annulée (rollback) suite à l'erreur: {savepoint_error}"
2026-02-20T22:09:11.2778946Z +            )
2026-02-20T22:09:11.2779248Z              raise
2026-02-20T22:09:11.2779547Z -    
2026-02-20T22:09:11.2779821Z +
2026-02-20T22:09:11.2780082Z      @staticmethod
2026-02-20T22:09:11.2780499Z      def commit(db_session: Session, log_prefix="DB"):
2026-02-20T22:09:11.2781150Z          """Valide les modifications de la session en cours"""
2026-02-20T22:09:11.2781669Z          try:
2026-02-20T22:09:11.2781972Z              db_session.commit()
2026-02-20T22:09:11.2782682Z              logger.debug(f"{log_prefix}: Transaction validée (commit)")
2026-02-20T22:09:11.2783489Z              return True
2026-02-20T22:09:11.2783871Z          except Exception as commit_error:
2026-02-20T22:09:11.2784324Z              db_session.rollback()
2026-02-20T22:09:11.2785155Z -            logger.error(f"{log_prefix}: Échec de commit, transaction annulée: {commit_error}")
2026-02-20T22:09:11.2786100Z -            return False
2026-02-20T22:09:11.2786436Z -    
2026-02-20T22:09:11.2786698Z +            logger.error(
2026-02-20T22:09:11.2787357Z +                f"{log_prefix}: Échec de commit, transaction annulée: {commit_error}"
2026-02-20T22:09:11.2787939Z +            )
2026-02-20T22:09:11.2788225Z +            return False
2026-02-20T22:09:11.2788547Z +
2026-02-20T22:09:11.2788795Z      @staticmethod
2026-02-20T22:09:11.2789177Z      def rollback(db_session: Session, log_prefix="DB"):
2026-02-20T22:09:11.2789768Z          """Annule les modifications de la session en cours"""
2026-02-20T22:09:11.2790265Z          try:
2026-02-20T22:09:11.2790563Z              db_session.rollback()
2026-02-20T22:09:11.2791238Z              logger.debug(f"{log_prefix}: Transaction annulée (rollback)")
2026-02-20T22:09:11.2791825Z              return True
2026-02-20T22:09:11.2792211Z          except Exception as rollback_error:
2026-02-20T22:09:11.2792945Z              logger.error(f"{log_prefix}: Échec de rollback: {rollback_error}")
2026-02-20T22:09:11.2793751Z              return False
2026-02-20T22:09:11.2794069Z -    
2026-02-20T22:09:11.2794325Z +
2026-02-20T22:09:11.2794572Z      @staticmethod
2026-02-20T22:09:11.2795092Z      def safe_delete(db_session: Session, obj, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2795738Z          """
2026-02-20T22:09:11.2796554Z          Supprime un objet de la base de données en toute sécurité.
2026-02-20T22:09:11.2797570Z          Les suppressions en cascade sont gérées automatiquement grâce aux relations SQLAlchemy.
2026-02-20T22:09:11.2798304Z -        
2026-02-20T22:09:11.2798588Z +
2026-02-20T22:09:11.2798828Z          Args:
2026-02-20T22:09:11.2799132Z              db_session: Session SQLAlchemy
2026-02-20T22:09:11.2799656Z              obj: L'objet à supprimer
2026-02-20T22:09:11.2800291Z              auto_commit: Si True, commit après la suppression
2026-02-20T22:09:11.2801076Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2801597Z -        
2026-02-20T22:09:11.2801848Z +
2026-02-20T22:09:11.2802074Z          Returns:
2026-02-20T22:09:11.2802583Z              bool: True si la suppression a réussi, False sinon
2026-02-20T22:09:11.2803234Z          """
2026-02-20T22:09:11.2803515Z          try:
2026-02-20T22:09:11.2804006Z              # Vérifier que l'objet est attaché à la session
2026-02-20T22:09:11.2804513Z -            obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.2804960Z +            obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.2805407Z              if obj not in db_session:
2026-02-20T22:09:11.2806025Z                  # Essayer de récupérer l'objet depuis la session
2026-02-20T22:09:11.2806543Z                  if obj_id:
2026-02-20T22:09:11.2807167Z -                    obj_from_db = db_session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.2807843Z +                    obj_from_db = (
2026-02-20T22:09:11.2808270Z +                        db_session.query(obj.__class__)
2026-02-20T22:09:11.2808763Z +                        .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.2809195Z +                        .first()
2026-02-20T22:09:11.2809545Z +                    )
2026-02-20T22:09:11.2809874Z                      if not obj_from_db:
2026-02-20T22:09:11.2810902Z -                        logger.error(f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données")
2026-02-20T22:09:11.2811771Z +                        logger.error(
2026-02-20T22:09:11.2812717Z +                            f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données"
2026-02-20T22:09:11.2813721Z +                        )
2026-02-20T22:09:11.2814095Z                          return False
2026-02-20T22:09:11.2814523Z                      obj = obj_from_db
2026-02-20T22:09:11.2814903Z                  else:
2026-02-20T22:09:11.2815527Z -                    logger.error(f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut id")
2026-02-20T22:09:11.2816480Z +                    logger.error(
2026-02-20T22:09:11.2817089Z +                        f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut id"
2026-02-20T22:09:11.2817768Z +                    )
2026-02-20T22:09:11.2817998Z                      return False
2026-02-20T22:09:11.2818223Z -            
2026-02-20T22:09:11.2818383Z +
2026-02-20T22:09:11.2818560Z              # Supprimer directement l'objet
2026-02-20T22:09:11.2818813Z              db_session.delete(obj)
2026-02-20T22:09:11.2819434Z -            logger.debug(f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué pour suppression")
2026-02-20T22:09:11.2819924Z -            
2026-02-20T22:09:11.2820100Z +            logger.debug(
2026-02-20T22:09:11.2820610Z +                f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué pour suppression"
2026-02-20T22:09:11.2821068Z +            )
2026-02-20T22:09:11.2821237Z +
2026-02-20T22:09:11.2821388Z              if auto_commit:
2026-02-20T22:09:11.2821744Z                  # Utiliser un savepoint pour pouvoir faire un rollback partiel en cas d'erreur
2026-02-20T22:09:11.2822126Z                  try:
2026-02-20T22:09:11.2822324Z                      db_session.commit()
2026-02-20T22:09:11.2822728Z                      logger.debug(f"{log_prefix}: Suppression confirmée avec succès")
2026-02-20T22:09:11.2823661Z                      return True
2026-02-20T22:09:11.2824109Z                  except Exception as delete_commit_error:
2026-02-20T22:09:11.2824604Z                      db_session.rollback()
2026-02-20T22:09:11.2825553Z -                    logger.error(f"{log_prefix}: Échec de la suppression lors du commit: {delete_commit_error}")
2026-02-20T22:09:11.2826294Z -                    
2026-02-20T22:09:11.2826625Z +                    logger.error(
2026-02-20T22:09:11.2827455Z +                        f"{log_prefix}: Échec de la suppression lors du commit: {delete_commit_error}"
2026-02-20T22:09:11.2828180Z +                    )
2026-02-20T22:09:11.2828481Z +
2026-02-20T22:09:11.2829193Z                      # Alternative: tenter une suppression sans cascade si la première méthode échoue
2026-02-20T22:09:11.2829902Z                      try:
2026-02-20T22:09:11.2830267Z                          from sqlalchemy import text
2026-02-20T22:09:11.2830747Z  
2026-02-20T22:09:11.2831406Z                          # Suppression directe par ID pour éviter de charger les relations
2026-02-20T22:09:11.2832288Z                          stmt = f"DELETE FROM {obj.__tablename__} WHERE id = :id"
2026-02-20T22:09:11.2832947Z                          db_session.execute(text(stmt), {"id": obj.id})
2026-02-20T22:09:11.2833831Z                          db_session.commit()
2026-02-20T22:09:11.2834966Z -                        logger.info(f"{log_prefix}: Suppression alternative réussie pour {obj.__class__.__name__}(id={obj.id})")
2026-02-20T22:09:11.2835880Z +                        logger.info(
2026-02-20T22:09:11.2836832Z +                            f"{log_prefix}: Suppression alternative réussie pour {obj.__class__.__name__}(id={obj.id})"
2026-02-20T22:09:11.2837645Z +                        )
2026-02-20T22:09:11.2838029Z                          return True
2026-02-20T22:09:11.2838477Z                      except Exception as e2:
2026-02-20T22:09:11.2838991Z                          db_session.rollback()
2026-02-20T22:09:11.2839889Z -                        logger.error(f"{log_prefix}: Échec de la suppression alternative: {e2}")
2026-02-20T22:09:11.2840607Z +                        logger.error(
2026-02-20T22:09:11.2841364Z +                            f"{log_prefix}: Échec de la suppression alternative: {e2}"
2026-02-20T22:09:11.2841954Z +                        )
2026-02-20T22:09:11.2842318Z                          return False
2026-02-20T22:09:11.2842685Z -            
2026-02-20T22:09:11.2843172Z +
2026-02-20T22:09:11.2843448Z              return True
2026-02-20T22:09:11.2843831Z          except Exception as delete_error:
2026-02-20T22:09:11.2844556Z              db_session.rollback()
2026-02-20T22:09:11.2845310Z              logger.error(f"{log_prefix}: Échec de la suppression: {delete_error}")
2026-02-20T22:09:11.2845956Z              return False
2026-02-20T22:09:11.2846290Z -    
2026-02-20T22:09:11.2846555Z +
2026-02-20T22:09:11.2846830Z      @staticmethod
2026-02-20T22:09:11.2847406Z      def safe_archive(db_session: Session, obj, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2848072Z          """
2026-02-20T22:09:11.2848499Z          Archive un objet au lieu de le supprimer physiquement.
2026-02-20T22:09:11.2849024Z -        
2026-02-20T22:09:11.2849287Z +
2026-02-20T22:09:11.2849545Z          Args:
2026-02-20T22:09:11.2849864Z              db_session: Session SQLAlchemy
2026-02-20T22:09:11.2850597Z              obj: L'objet à archiver (doit avoir un attribut is_archived)
2026-02-20T22:09:11.2851375Z              auto_commit: Si True, commit après l'archivage
2026-02-20T22:09:11.2852151Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2852695Z -            
2026-02-20T22:09:11.2853176Z +
2026-02-20T22:09:11.2853450Z          Returns:
2026-02-20T22:09:11.2853972Z              bool: True si l'archivage a réussi, False sinon
2026-02-20T22:09:11.2854466Z          """
2026-02-20T22:09:11.2854988Z          try:
2026-02-20T22:09:11.2855332Z -            if not hasattr(obj, 'is_archived'):
2026-02-20T22:09:11.2856130Z -                logger.error(f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut is_archived")
2026-02-20T22:09:11.2856952Z +            if not hasattr(obj, "is_archived"):
2026-02-20T22:09:11.2857404Z +                logger.error(
2026-02-20T22:09:11.2858029Z +                    f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut is_archived"
2026-02-20T22:09:11.2858683Z +                )
2026-02-20T22:09:11.2858985Z                  return False
2026-02-20T22:09:11.2859335Z -            
2026-02-20T22:09:11.2859612Z +
2026-02-20T22:09:11.2860099Z              # Vérifier que l'objet est attaché à la session
2026-02-20T22:09:11.2860635Z -            obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.2861118Z +            obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.2861569Z              if obj not in db_session:
2026-02-20T22:09:11.2862206Z                  # Essayer de récupérer l'objet depuis la session
2026-02-20T22:09:11.2862718Z                  if obj_id:
2026-02-20T22:09:11.2863556Z -                    obj_from_db = db_session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.2864316Z +                    obj_from_db = (
2026-02-20T22:09:11.2864764Z +                        db_session.query(obj.__class__)
2026-02-20T22:09:11.2865275Z +                        .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.2865732Z +                        .first()
2026-02-20T22:09:11.2866101Z +                    )
2026-02-20T22:09:11.2866430Z                      if not obj_from_db:
2026-02-20T22:09:11.2867494Z -                        logger.error(f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données")
2026-02-20T22:09:11.2868385Z +                        logger.error(
2026-02-20T22:09:11.2869279Z +                            f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données"
2026-02-20T22:09:11.2870068Z +                        )
2026-02-20T22:09:11.2870416Z                          return False
2026-02-20T22:09:11.2870830Z                      obj = obj_from_db
2026-02-20T22:09:11.2871227Z                  else:
2026-02-20T22:09:11.2871607Z                      # Si pas d'ID, merger l'objet
2026-02-20T22:09:11.2872103Z                      obj = db_session.merge(obj)
2026-02-20T22:09:11.2872534Z -                
2026-02-20T22:09:11.2872838Z +
2026-02-20T22:09:11.2873437Z              obj.is_archived = True
2026-02-20T22:09:11.2874544Z -            logger.debug(f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué comme archivé")
2026-02-20T22:09:11.2875727Z -            
2026-02-20T22:09:11.2876042Z +            logger.debug(
2026-02-20T22:09:11.2876930Z +                f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué comme archivé"
2026-02-20T22:09:11.2877720Z +            )
2026-02-20T22:09:11.2878006Z +
2026-02-20T22:09:11.2878273Z              if auto_commit:
2026-02-20T22:09:11.2878649Z                  db_session.commit()
2026-02-20T22:09:11.2879349Z                  logger.debug(f"{log_prefix}: Archivage confirmé avec succès")
2026-02-20T22:09:11.2879936Z -            
2026-02-20T22:09:11.2880212Z +
2026-02-20T22:09:11.2880476Z              return True
2026-02-20T22:09:11.2880825Z          except Exception as e:
2026-02-20T22:09:11.2881232Z              db_session.rollback()
2026-02-20T22:09:11.2881883Z              logger.error(f"{log_prefix}: Échec de l'archivage: {e}")
2026-02-20T22:09:11.2882449Z -            return False 
2026-02-20T22:09:11.2882814Z \ No newline at end of file
2026-02-20T22:09:11.2883369Z +            return False
2026-02-20T22:09:11.2884006Z would reformat /home/runner/work/mathakine/mathakine/app/models/exercise.py
2026-02-20T22:09:11.2884888Z would reformat /home/runner/work/mathakine/mathakine/app/db/transaction.py
2026-02-20T22:09:11.2886107Z --- /home/runner/work/mathakine/mathakine/app/models/exercise.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2887225Z +++ /home/runner/work/mathakine/mathakine/app/models/exercise.py	2026-02-20 22:09:11.278586+00:00
2026-02-20T22:09:11.2887975Z @@ -1,41 +1,51 @@
2026-02-20T22:09:11.2888284Z  import enum
2026-02-20T22:09:11.2888560Z  
2026-02-20T22:09:11.2889037Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Enum, ForeignKey,
2026-02-20T22:09:11.2889711Z -                        Integer, String, Text)
2026-02-20T22:09:11.2890138Z +from sqlalchemy import (
2026-02-20T22:09:11.2890472Z +    JSON,
2026-02-20T22:09:11.2890722Z +    Boolean,
2026-02-20T22:09:11.2890984Z +    Column,
2026-02-20T22:09:11.2891253Z +    DateTime,
2026-02-20T22:09:11.2891533Z +    Enum,
2026-02-20T22:09:11.2891797Z +    ForeignKey,
2026-02-20T22:09:11.2892092Z +    Integer,
2026-02-20T22:09:11.2892356Z +    String,
2026-02-20T22:09:11.2892630Z +    Text,
2026-02-20T22:09:11.2892889Z +)
2026-02-20T22:09:11.2893374Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2893847Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.2894218Z  
2026-02-20T22:09:11.2894503Z  from app.db.base import Base
2026-02-20T22:09:11.2894855Z  
2026-02-20T22:09:11.2895100Z  
2026-02-20T22:09:11.2895387Z  class DifficultyLevel(str, enum.Enum):
2026-02-20T22:09:11.2896057Z      """Niveaux de difficulté des épreuves mathématiques"""
2026-02-20T22:09:11.2896624Z -    INITIE = "INITIE"           # Facile (6-8 ans)
2026-02-20T22:09:11.2897154Z -    PADAWAN = "PADAWAN"         # Moyen (9-11 ans)
2026-02-20T22:09:11.2897703Z -    CHEVALIER = "CHEVALIER"     # Difficile (12-14 ans)
2026-02-20T22:09:11.2898420Z -    MAITRE = "MAITRE"           # Très difficile (15-17 ans)
2026-02-20T22:09:11.2898927Z +
2026-02-20T22:09:11.2899221Z +    INITIE = "INITIE"  # Facile (6-8 ans)
2026-02-20T22:09:11.2899687Z +    PADAWAN = "PADAWAN"  # Moyen (9-11 ans)
2026-02-20T22:09:11.2900197Z +    CHEVALIER = "CHEVALIER"  # Difficile (12-14 ans)
2026-02-20T22:09:11.2900854Z +    MAITRE = "MAITRE"  # Très difficile (15-17 ans)
2026-02-20T22:09:11.2901409Z      GRAND_MAITRE = "GRAND_MAITRE"  # Expert (adultes)
2026-02-20T22:09:11.2901884Z -
2026-02-20T22:09:11.2902133Z  
2026-02-20T22:09:11.2902373Z  
2026-02-20T22:09:11.2902662Z  class ExerciseType(str, enum.Enum):
2026-02-20T22:09:11.2903499Z      """Types d'épreuves mathématiques"""
2026-02-20T22:09:11.2904005Z -    ADDITION = "ADDITION"           # Additions
2026-02-20T22:09:11.2904536Z -    SOUSTRACTION = "SOUSTRACTION"   # Soustractions
2026-02-20T22:09:11.2905124Z -    MULTIPLICATION = "MULTIPLICATION" # Multiplications
2026-02-20T22:09:11.2905910Z -    DIVISION = "DIVISION"           # Divisions
2026-02-20T22:09:11.2906410Z -    FRACTIONS = "FRACTIONS"         # Fractions
2026-02-20T22:09:11.2907006Z -    GEOMETRIE = "GEOMETRIE"         # Géométrie
2026-02-20T22:09:11.2907558Z -    TEXTE = "TEXTE"                 # Questions textuelles
2026-02-20T22:09:11.2908307Z -    MIXTE = "MIXTE"                 # Combinaison de plusieurs opérations
2026-02-20T22:09:11.2909014Z -    DIVERS = "DIVERS"               # Exercices variés
2026-02-20T22:09:11.2909484Z  
2026-02-20T22:09:11.2909771Z +    ADDITION = "ADDITION"  # Additions
2026-02-20T22:09:11.2910262Z +    SOUSTRACTION = "SOUSTRACTION"  # Soustractions
2026-02-20T22:09:11.2910846Z +    MULTIPLICATION = "MULTIPLICATION"  # Multiplications
2026-02-20T22:09:11.2911388Z +    DIVISION = "DIVISION"  # Divisions
2026-02-20T22:09:11.2911835Z +    FRACTIONS = "FRACTIONS"  # Fractions
2026-02-20T22:09:11.2912377Z +    GEOMETRIE = "GEOMETRIE"  # Géométrie
2026-02-20T22:09:11.2912838Z +    TEXTE = "TEXTE"  # Questions textuelles
2026-02-20T22:09:11.2913690Z +    MIXTE = "MIXTE"  # Combinaison de plusieurs opérations
2026-02-20T22:09:11.2914321Z +    DIVERS = "DIVERS"  # Exercices variés
2026-02-20T22:09:11.2914728Z  
2026-02-20T22:09:11.2914974Z  
2026-02-20T22:09:11.2915233Z  class Exercise(Base):
2026-02-20T22:09:11.2915887Z      """Modèle de données pour les exercices mathématiques (Épreuves Jedi)"""
2026-02-20T22:09:11.2916742Z +
2026-02-20T22:09:11.2917019Z      __tablename__ = "exercises"
2026-02-20T22:09:11.2917391Z  
2026-02-20T22:09:11.2917734Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.2918212Z  
2026-02-20T22:09:11.2918533Z      # Métadonnées
2026-02-20T22:09:11.2918845Z @@ -44,21 +54,25 @@
2026-02-20T22:09:11.2919328Z      creator = relationship("User", back_populates="created_exercises")
2026-02-20T22:09:11.2919999Z      exercise_type = Column(String, nullable=False)
2026-02-20T22:09:11.2920938Z      # NOTE: La DB PostgreSQL utilise VARCHAR, pas ENUM. On garde String pour la compatibilité.
2026-02-20T22:09:11.2921745Z      difficulty = Column(String, nullable=False)
2026-02-20T22:09:11.2922534Z      tags = Column(String, nullable=True)  # Tags séparés par des virgules
2026-02-20T22:09:11.2923313Z -    
2026-02-20T22:09:11.2923583Z +
2026-02-20T22:09:11.2923880Z      # Attributs de personnalisation
2026-02-20T22:09:11.2924738Z -    age_group = Column(String, nullable=False)  # Groupe d'âge cible (8-10, 11-13, 14-16)
2026-02-20T22:09:11.2925440Z +    age_group = Column(
2026-02-20T22:09:11.2925804Z +        String, nullable=False
2026-02-20T22:09:11.2926333Z +    )  # Groupe d'âge cible (8-10, 11-13, 14-16)
2026-02-20T22:09:11.2927146Z      context_theme = Column(String, nullable=True)  # Contexte Star Wars spécifique
2026-02-20T22:09:11.2928227Z      complexity = Column(Integer, nullable=True)  # Niveau de complexité cognitive (1-5)
2026-02-20T22:09:11.2929203Z      ai_generated = Column(Boolean, default=False)  # Généré par IA
2026-02-20T22:09:11.2929830Z  
2026-02-20T22:09:11.2930122Z      # Contenu de l'exercice
2026-02-20T22:09:11.2930528Z      question = Column(Text, nullable=False)
2026-02-20T22:09:11.2931043Z      correct_answer = Column(String, nullable=False)
2026-02-20T22:09:11.2931956Z -    choices = Column(JSON, nullable=True)  # Options pour les questions à choix multiples
2026-02-20T22:09:11.2932676Z +    choices = Column(
2026-02-20T22:09:11.2933202Z +        JSON, nullable=True
2026-02-20T22:09:11.2933792Z +    )  # Options pour les questions à choix multiples
2026-02-20T22:09:11.2934470Z      explanation = Column(Text, nullable=True)  # Explication de la solution
2026-02-20T22:09:11.2935397Z      hint = Column(Text, nullable=True)  # Indice pour aider l'élève
2026-02-20T22:09:11.2935945Z  
2026-02-20T22:09:11.2936308Z      # Métadonnées du contenu
2026-02-20T22:09:11.2936993Z      image_url = Column(String, nullable=True)  # URL de l'image associée
2026-02-20T22:09:11.2937592Z @@ -69,14 +83,16 @@
2026-02-20T22:09:11.2937968Z      is_archived = Column(Boolean, default=False)
2026-02-20T22:09:11.2938685Z      view_count = Column(Integer, default=0)
2026-02-20T22:09:11.2939109Z  
2026-02-20T22:09:11.2939357Z      # Horodatage
2026-02-20T22:09:11.2939822Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.2940650Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.2941548Z +    updated_at = Column(
2026-02-20T22:09:11.2942068Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.2942625Z +    )
2026-02-20T22:09:11.2942885Z  
2026-02-20T22:09:11.2943336Z      # Relations
2026-02-20T22:09:11.2943966Z -    attempts = relationship("Attempt", back_populates="exercise", cascade="all, delete-orphan")
2026-02-20T22:09:11.2944688Z -
2026-02-20T22:09:11.2944931Z -
2026-02-20T22:09:11.2945197Z +    attempts = relationship(
2026-02-20T22:09:11.2945746Z +        "Attempt", back_populates="exercise", cascade="all, delete-orphan"
2026-02-20T22:09:11.2946335Z +    )
2026-02-20T22:09:11.2946580Z  
2026-02-20T22:09:11.2946841Z      def __repr__(self):
2026-02-20T22:09:11.2947337Z          return f"<Exercise {self.id}: {self.title} ({self.difficulty})>"
2026-02-20T22:09:11.2948219Z would reformat /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py
2026-02-20T22:09:11.2949268Z --- /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2950413Z +++ /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py	2026-02-20 22:09:11.286606+00:00
2026-02-20T22:09:11.2951166Z @@ -1,67 +1,81 @@
2026-02-20T22:09:11.2951434Z  """
2026-02-20T22:09:11.2952098Z  Modèles SQLAlchemy pour les tables héritées de l'ancienne base de données.
2026-02-20T22:09:11.2953353Z  Ces modèles sont inclus pour la compatibilité avec la base de données existante.
2026-02-20T22:09:11.2954052Z  """
2026-02-20T22:09:11.2954581Z -from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Integer,
2026-02-20T22:09:11.2955304Z -                        String, Text, text)
2026-02-20T22:09:11.2955729Z +
2026-02-20T22:09:11.2956008Z +from sqlalchemy import (
2026-02-20T22:09:11.2956370Z +    Boolean,
2026-02-20T22:09:11.2956649Z +    Column,
2026-02-20T22:09:11.2956929Z +    DateTime,
2026-02-20T22:09:11.2957213Z +    Float,
2026-02-20T22:09:11.2957514Z +    ForeignKey,
2026-02-20T22:09:11.2957810Z +    Integer,
2026-02-20T22:09:11.2958103Z +    String,
2026-02-20T22:09:11.2958384Z +    Text,
2026-02-20T22:09:11.2958649Z +    text,
2026-02-20T22:09:11.2958918Z +)
2026-02-20T22:09:11.2959225Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2959661Z  
2026-02-20T22:09:11.2959953Z  from app.db.base import Base
2026-02-20T22:09:11.2960330Z  
2026-02-20T22:09:11.2960578Z  
2026-02-20T22:09:11.2960860Z  class Results(Base):
2026-02-20T22:09:11.2961489Z      """Modèle pour la table results (résultats d'exercices)."""
2026-02-20T22:09:11.2962074Z -    __tablename__ = 'results'
2026-02-20T22:09:11.2962461Z -    
2026-02-20T22:09:11.2962734Z +
2026-02-20T22:09:11.2963230Z +    __tablename__ = "results"
2026-02-20T22:09:11.2963597Z +
2026-02-20T22:09:11.2963997Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2964632Z      exercise_id = Column(Integer, nullable=False)
2026-02-20T22:09:11.2965192Z      is_correct = Column(Boolean, nullable=False)
2026-02-20T22:09:11.2965830Z -    attempt_count = Column(Integer, server_default=text('1'))
2026-02-20T22:09:11.2966530Z +    attempt_count = Column(Integer, server_default=text("1"))
2026-02-20T22:09:11.2966724Z      time_spent = Column(Float, nullable=True)
2026-02-20T22:09:11.2967056Z -    created_at = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2967181Z -    
2026-02-20T22:09:11.2967500Z +    created_at = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2967614Z +
2026-02-20T22:09:11.2967758Z      def __repr__(self):
2026-02-20T22:09:11.2968206Z          return f"<Result(id={self.id}, exercise_id={self.exercise_id}, correct={self.is_correct})>"
2026-02-20T22:09:11.2968572Z  
2026-02-20T22:09:11.2968693Z  
2026-02-20T22:09:11.2968841Z  class Statistics(Base):
2026-02-20T22:09:11.2969296Z      """Modèle pour la table statistics (statistiques par session)."""
2026-02-20T22:09:11.2969452Z -    __tablename__ = 'statistics'
2026-02-20T22:09:11.2969863Z -    
2026-02-20T22:09:11.2969972Z +
2026-02-20T22:09:11.2970115Z +    __tablename__ = "statistics"
2026-02-20T22:09:11.2970235Z +
2026-02-20T22:09:11.2970500Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2970680Z      user_id = Column(Integer, nullable=True)
2026-02-20T22:09:11.2970892Z      session_id = Column(String(255), nullable=False)
2026-02-20T22:09:11.2971126Z      exercise_type = Column(String(50), nullable=False)
2026-02-20T22:09:11.2971331Z      difficulty = Column(String(50), nullable=False)
2026-02-20T22:09:11.2971679Z -    total_attempts = Column(Integer, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972055Z -    correct_attempts = Column(Integer, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972342Z -    avg_time = Column(Float, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972684Z -    last_updated = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2972817Z -    
2026-02-20T22:09:11.2973356Z +    total_attempts = Column(Integer, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2973717Z +    correct_attempts = Column(Integer, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2974007Z +    avg_time = Column(Float, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2974344Z +    last_updated = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2974458Z +
2026-02-20T22:09:11.2974595Z      def __repr__(self):
2026-02-20T22:09:11.2975107Z          return f"<Statistics(id={self.id}, session_id={self.session_id}, exercise_type={self.exercise_type})>"
2026-02-20T22:09:11.2975231Z  
2026-02-20T22:09:11.2975339Z  
2026-02-20T22:09:11.2975490Z  class UserStats(Base):
2026-02-20T22:09:11.2975933Z      """Modèle pour la table user_stats (statistiques utilisateur)."""
2026-02-20T22:09:11.2976087Z -    __tablename__ = 'user_stats'
2026-02-20T22:09:11.2976192Z -    
2026-02-20T22:09:11.2976321Z +
2026-02-20T22:09:11.2976460Z +    __tablename__ = "user_stats"
2026-02-20T22:09:11.2976568Z +
2026-02-20T22:09:11.2976829Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2977044Z      exercise_type = Column(String(50), nullable=False)
2026-02-20T22:09:11.2977246Z      difficulty = Column(String(50), nullable=False)
2026-02-20T22:09:11.2977512Z -    total_attempts = Column(Integer, server_default=text('0'))
2026-02-20T22:09:11.2977784Z -    correct_attempts = Column(Integer, server_default=text('0'))
2026-02-20T22:09:11.2978127Z -    last_updated = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2978254Z -    
2026-02-20T22:09:11.2978521Z +    total_attempts = Column(Integer, server_default=text("0"))
2026-02-20T22:09:11.2978792Z +    correct_attempts = Column(Integer, server_default=text("0"))
2026-02-20T22:09:11.2979126Z +    last_updated = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2979246Z +
2026-02-20T22:09:11.2979383Z      def __repr__(self):
2026-02-20T22:09:11.2979898Z          return f"<UserStats(id={self.id}, exercise_type={self.exercise_type}, difficulty={self.difficulty})>"
2026-02-20T22:09:11.2980014Z  
2026-02-20T22:09:11.2980122Z  
2026-02-20T22:09:11.2980269Z  class SchemaVersion(Base):
2026-02-20T22:09:11.2980689Z      """Modèle pour la table schema_version (version du schéma)."""
2026-02-20T22:09:11.2980858Z -    __tablename__ = 'schema_version'
2026-02-20T22:09:11.2980969Z -    
2026-02-20T22:09:11.2981079Z +
2026-02-20T22:09:11.2981231Z +    __tablename__ = "schema_version"
2026-02-20T22:09:11.2981336Z +
2026-02-20T22:09:11.2981522Z      version = Column(Integer, primary_key=True)
2026-02-20T22:09:11.2981870Z -    
2026-02-20T22:09:11.2981990Z +
2026-02-20T22:09:11.2982125Z      def __repr__(self):
2026-02-20T22:09:11.2982360Z -        return f"<SchemaVersion(version={self.version})>" 
2026-02-20T22:09:11.2982511Z \ No newline at end of file
2026-02-20T22:09:11.2982741Z +        return f"<SchemaVersion(version={self.version})>"
2026-02-20T22:09:11.3444064Z --- /home/runner/work/mathakine/mathakine/app/models/notification.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3445521Z +++ /home/runner/work/mathakine/mathakine/app/models/notification.py	2026-02-20 22:09:11.343429+00:00
2026-02-20T22:09:11.3446020Z @@ -1,25 +1,36 @@
2026-02-20T22:09:11.3460159Z would reformat /home/runner/work/mathakine/mathakine/app/models/notification.py
2026-02-20T22:09:11.3460297Z  """
2026-02-20T22:09:11.3460734Z  Modèle SQLAlchemy pour les notifications
2026-02-20T22:09:11.3460851Z  """
2026-02-20T22:09:11.3461228Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.3461437Z -                        Integer, String, Text)
2026-02-20T22:09:11.3461551Z +
2026-02-20T22:09:11.3461701Z +from sqlalchemy import (
2026-02-20T22:09:11.3461818Z +    JSON,
2026-02-20T22:09:11.3461942Z +    Boolean,
2026-02-20T22:09:11.3462056Z +    Column,
2026-02-20T22:09:11.3462174Z +    DateTime,
2026-02-20T22:09:11.3462321Z +    ForeignKey,
2026-02-20T22:09:11.3462435Z +    Index,
2026-02-20T22:09:11.3462553Z +    Integer,
2026-02-20T22:09:11.3462667Z +    String,
2026-02-20T22:09:11.3462788Z +    Text,
2026-02-20T22:09:11.3462894Z +)
2026-02-20T22:09:11.3463274Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3463445Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3463556Z  
2026-02-20T22:09:11.3463708Z  from app.db.base import Base
2026-02-20T22:09:11.3463816Z  
2026-02-20T22:09:11.3463930Z  
2026-02-20T22:09:11.3464071Z  class Notification(Base):
2026-02-20T22:09:11.3464425Z      """Modèle pour les notifications utilisateur"""
2026-02-20T22:09:11.3464558Z +
2026-02-20T22:09:11.3464714Z      __tablename__ = "notifications"
2026-02-20T22:09:11.3464848Z -    __table_args__ = (
2026-02-20T22:09:11.3465044Z -        Index('idx_notifications_user', 'user_id'),
2026-02-20T22:09:11.3465162Z -    )
2026-02-20T22:09:11.3465433Z +    __table_args__ = (Index("idx_notifications_user", "user_id"),)
2026-02-20T22:09:11.3465555Z  
2026-02-20T22:09:11.3465786Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3466203Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.3466336Z +    user_id = Column(
2026-02-20T22:09:11.3466660Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.3466786Z +    )
2026-02-20T22:09:11.3467014Z      type = Column(String(50), nullable=False, index=True)
2026-02-20T22:09:11.3467198Z      title = Column(String(255), nullable=False)
2026-02-20T22:09:11.3467369Z      message = Column(Text, nullable=True)
2026-02-20T22:09:11.3467535Z      data = Column(JSON, nullable=True)
2026-02-20T22:09:11.3467741Z      action_url = Column(String(255), nullable=True)
2026-02-20T22:09:11.3467874Z @@ -42,6 +53,7 @@
2026-02-20T22:09:11.3468033Z      def is_expired(self) -> bool:
2026-02-20T22:09:11.3468361Z          """Vérifier si la notification a expiré"""
2026-02-20T22:09:11.3468524Z          if self.expires_at is None:
2026-02-20T22:09:11.3468667Z              return False
2026-02-20T22:09:11.3468850Z          from datetime import datetime, timezone
2026-02-20T22:09:11.3468961Z +
2026-02-20T22:09:11.3469210Z          return datetime.now(timezone.utc) > self.expires_at
2026-02-20T22:09:11.3846288Z would reformat /home/runner/work/mathakine/mathakine/app/models/progress.py
2026-02-20T22:09:11.3846796Z --- /home/runner/work/mathakine/mathakine/app/models/progress.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3848008Z +++ /home/runner/work/mathakine/mathakine/app/models/progress.py	2026-02-20 22:09:11.382712+00:00
2026-02-20T22:09:11.3848466Z @@ -1,76 +1,88 @@
2026-02-20T22:09:11.3848808Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Float, ForeignKey,
2026-02-20T22:09:11.3848968Z -                        Index, Integer, String)
2026-02-20T22:09:11.3849110Z +from sqlalchemy import (
2026-02-20T22:09:11.3849223Z +    JSON,
2026-02-20T22:09:11.3849520Z +    Boolean,
2026-02-20T22:09:11.3849631Z +    Column,
2026-02-20T22:09:11.3849754Z +    DateTime,
2026-02-20T22:09:11.3849869Z +    Float,
2026-02-20T22:09:11.3850052Z +    ForeignKey,
2026-02-20T22:09:11.3854700Z +    Index,
2026-02-20T22:09:11.3854870Z +    Integer,
2026-02-20T22:09:11.3855000Z +    String,
2026-02-20T22:09:11.3855115Z +)
2026-02-20T22:09:11.3855302Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3855462Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3855577Z  
2026-02-20T22:09:11.3855726Z  from app.db.base import Base
2026-02-20T22:09:11.3855925Z  from app.models.exercise import ExerciseType
2026-02-20T22:09:11.3856056Z  
2026-02-20T22:09:11.3856164Z  
2026-02-20T22:09:11.3856306Z  class Progress(Base):
2026-02-20T22:09:11.3856942Z      """Modèle pour suivre la progression des utilisateurs (Chemin vers la Maîtrise)"""
2026-02-20T22:09:11.3857076Z +
2026-02-20T22:09:11.3857227Z      __tablename__ = "progress"
2026-02-20T22:09:11.3857339Z -    
2026-02-20T22:09:11.3857468Z +
2026-02-20T22:09:11.3857817Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.3857958Z      __table_args__ = (
2026-02-20T22:09:11.3858235Z -        Index('ix_progress_user_type', 'user_id', 'exercise_type'),
2026-02-20T22:09:11.3858532Z -        Index('ix_progress_user_difficulty', 'user_id', 'difficulty'),
2026-02-20T22:09:11.3858804Z +        Index("ix_progress_user_type", "user_id", "exercise_type"),
2026-02-20T22:09:11.3859080Z +        Index("ix_progress_user_difficulty", "user_id", "difficulty"),
2026-02-20T22:09:11.3859206Z      )
2026-02-20T22:09:11.3859315Z  
2026-02-20T22:09:11.3859535Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3859660Z  
2026-02-20T22:09:11.3859865Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.3860210Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.3860490Z      user = relationship("User", back_populates="progress_records")
2026-02-20T22:09:11.3860612Z  
2026-02-20T22:09:11.3860955Z      # Données de progression (avec index pour filtrage)
2026-02-20T22:09:11.3861507Z -    exercise_type = Column(String, nullable=False, index=True)  # Type d'exercice (addition, soustraction, etc.)
2026-02-20T22:09:11.3861966Z -    difficulty = Column(String, nullable=False, index=True)     # Niveau de difficulté
2026-02-20T22:09:11.3862322Z -    total_attempts = Column(Integer, default=0)     # Nombre total de tentatives
2026-02-20T22:09:11.3862828Z -    correct_attempts = Column(Integer, default=0)   # Nombre de tentatives réussies
2026-02-20T22:09:11.3863192Z +    exercise_type = Column(
2026-02-20T22:09:11.3863371Z +        String, nullable=False, index=True
2026-02-20T22:09:11.3863594Z +    )  # Type d'exercice (addition, soustraction, etc.)
2026-02-20T22:09:11.3864061Z +    difficulty = Column(String, nullable=False, index=True)  # Niveau de difficulté
2026-02-20T22:09:11.3864404Z +    total_attempts = Column(Integer, default=0)  # Nombre total de tentatives
2026-02-20T22:09:11.3864939Z +    correct_attempts = Column(Integer, default=0)  # Nombre de tentatives réussies
2026-02-20T22:09:11.3865053Z  
2026-02-20T22:09:11.3865310Z      # Métriques de performance
2026-02-20T22:09:11.3865801Z -    average_time = Column(Float, nullable=True)        # Temps moyen pour résoudre
2026-02-20T22:09:11.3866291Z -    completion_rate = Column(Float, nullable=True)     # Taux de complétion (%)
2026-02-20T22:09:11.3866850Z -    streak = Column(Integer, default=0)                # Série actuelle d'exercices réussis
2026-02-20T22:09:11.3867278Z -    highest_streak = Column(Integer, default=0)        # Meilleure série
2026-02-20T22:09:11.3867940Z +    average_time = Column(Float, nullable=True)  # Temps moyen pour résoudre
2026-02-20T22:09:11.3868372Z +    completion_rate = Column(Float, nullable=True)  # Taux de complétion (%)
2026-02-20T22:09:11.3868787Z +    streak = Column(Integer, default=0)  # Série actuelle d'exercices réussis
2026-02-20T22:09:11.3869387Z +    highest_streak = Column(Integer, default=0)  # Meilleure série
2026-02-20T22:09:11.3869511Z  
2026-02-20T22:09:11.3869767Z      # Métriques pédagogiques avancées
2026-02-20T22:09:11.3870376Z -    concept_mastery = Column(JSON, nullable=True)       # Maîtrise fine des concepts mathématiques
2026-02-20T22:09:11.3870783Z -    learning_curve = Column(JSON, nullable=True)        # Courbe d'apprentissage en JSON
2026-02-20T22:09:11.3871404Z -    last_active_date = Column(DateTime(timezone=True), nullable=True)  # Dernière session active
2026-02-20T22:09:11.3871508Z -    
2026-02-20T22:09:11.3871642Z +    concept_mastery = Column(
2026-02-20T22:09:11.3871794Z +        JSON, nullable=True
2026-02-20T22:09:11.3872066Z +    )  # Maîtrise fine des concepts mathématiques
2026-02-20T22:09:11.3872439Z +    learning_curve = Column(JSON, nullable=True)  # Courbe d'apprentissage en JSON
2026-02-20T22:09:11.3872593Z +    last_active_date = Column(
2026-02-20T22:09:11.3872771Z +        DateTime(timezone=True), nullable=True
2026-02-20T22:09:11.3873209Z +    )  # Dernière session active
2026-02-20T22:09:11.3873327Z +
2026-02-20T22:09:11.3873711Z      # Niveau de maîtrise (compatible avec le thème Star Wars)
2026-02-20T22:09:11.3874076Z      # 1: Novice, 2: Initié, 3: Padawan, 4: Chevalier, 5: Maître
2026-02-20T22:09:11.3874259Z      mastery_level = Column(Integer, default=1)
2026-02-20T22:09:11.3874375Z  
2026-02-20T22:09:11.3874639Z      # Médailles et récompenses (format JSON)
2026-02-20T22:09:11.3874792Z      awards = Column(JSON, nullable=True)
2026-02-20T22:09:11.3874906Z  
2026-02-20T22:09:11.3875143Z      # Données analytiques et conseils
2026-02-20T22:09:11.3875640Z -    strengths = Column(String, nullable=True)        # Points forts identifiés
2026-02-20T22:09:11.3876106Z -    areas_to_improve = Column(String, nullable=True) # Domaines à améliorer
2026-02-20T22:09:11.3876546Z +    strengths = Column(String, nullable=True)  # Points forts identifiés
2026-02-20T22:09:11.3877014Z +    areas_to_improve = Column(String, nullable=True)  # Domaines à améliorer
2026-02-20T22:09:11.3877490Z      recommendations = Column(String, nullable=True)  # Exercices recommandés
2026-02-20T22:09:11.3877609Z  
2026-02-20T22:09:11.3877723Z      # Horodatage
2026-02-20T22:09:11.3878117Z -    last_updated = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3878222Z -
2026-02-20T22:09:11.3878321Z -
2026-02-20T22:09:11.3878447Z +    last_updated = Column(
2026-02-20T22:09:11.3878735Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3878858Z +    )
2026-02-20T22:09:11.3878964Z  
2026-02-20T22:09:11.3879093Z      def __repr__(self):
2026-02-20T22:09:11.3879550Z          return f"<Progression: {self.user_id}, {self.exercise_type}, Niveau {self.mastery_level}>"
2026-02-20T22:09:11.3879665Z -
2026-02-20T22:09:11.3879770Z -
2026-02-20T22:09:11.3879871Z  
2026-02-20T22:09:11.3880040Z      def calculate_completion_rate(self):
2026-02-20T22:09:11.3880311Z          """Calcule le taux de complétion"""
2026-02-20T22:09:11.3880466Z          if self.total_attempts == 0:
2026-02-20T22:09:11.3880587Z              return 0
2026-02-20T22:09:11.3880857Z          return (self.correct_attempts / self.total_attempts) * 100
2026-02-20T22:09:11.3880964Z -
2026-02-20T22:09:11.3881069Z -
2026-02-20T22:09:11.3881182Z  
2026-02-20T22:09:11.3881335Z      def update_mastery_level(self):
2026-02-20T22:09:11.3881786Z          """Met à jour le niveau de maîtrise basé sur le taux de complétion"""
2026-02-20T22:09:11.3881988Z          rate = self.calculate_completion_rate()
2026-02-20T22:09:11.3882121Z          if rate >= 95:
2026-02-20T22:09:11.3882889Z --- /home/runner/work/mathakine/mathakine/app/models/recommendation.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3883612Z +++ /home/runner/work/mathakine/mathakine/app/models/recommendation.py	2026-02-20 22:09:11.383024+00:00
2026-02-20T22:09:11.3883746Z @@ -1,59 +1,94 @@
2026-02-20T22:09:11.3884158Z -from sqlalchemy import (Boolean, Column, DateTime, ForeignKey, Index, Integer, String,
2026-02-20T22:09:11.3884534Z -                        Text)
2026-02-20T22:09:11.3884689Z +from sqlalchemy import (
2026-02-20T22:09:11.3884807Z +    Boolean,
2026-02-20T22:09:11.3884921Z +    Column,
2026-02-20T22:09:11.3885050Z +    DateTime,
2026-02-20T22:09:11.3885167Z +    ForeignKey,
2026-02-20T22:09:11.3885278Z +    Index,
2026-02-20T22:09:11.3885390Z +    Integer,
2026-02-20T22:09:11.3885513Z +    String,
2026-02-20T22:09:11.3885627Z +    Text,
2026-02-20T22:09:11.3885737Z +)
2026-02-20T22:09:11.3885926Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3886082Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3886197Z  
2026-02-20T22:09:11.3886343Z  from app.db.base import Base
2026-02-20T22:09:11.3886454Z  
2026-02-20T22:09:11.3886550Z  
2026-02-20T22:09:11.3886691Z  class Recommendation(Base):
2026-02-20T22:09:11.3887335Z      """Modèle pour les recommandations personnalisées d'exercices (Conseils de Maître Jedi)"""
2026-02-20T22:09:11.3887472Z +
2026-02-20T22:09:11.3887634Z      __tablename__ = "recommendations"
2026-02-20T22:09:11.3887743Z -    
2026-02-20T22:09:11.3887860Z +
2026-02-20T22:09:11.3888186Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.3888316Z      __table_args__ = (
2026-02-20T22:09:11.3888658Z -        Index('ix_recommendations_user_completed', 'user_id', 'is_completed'),
2026-02-20T22:09:11.3888947Z -        Index('ix_recommendations_user_priority', 'user_id', 'priority'),
2026-02-20T22:09:11.3889267Z +        Index("ix_recommendations_user_completed", "user_id", "is_completed"),
2026-02-20T22:09:11.3889575Z +        Index("ix_recommendations_user_priority", "user_id", "priority"),
2026-02-20T22:09:11.3889701Z      )
2026-02-20T22:09:11.3889808Z -    
2026-02-20T22:09:11.3889910Z +
2026-02-20T22:09:11.3890136Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3890242Z -    
2026-02-20T22:09:11.3890346Z +
2026-02-20T22:09:11.3890561Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.3891052Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
2026-02-20T22:09:11.3891178Z +    user_id = Column(
2026-02-20T22:09:11.3891545Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True
2026-02-20T22:09:11.3891735Z +    )
2026-02-20T22:09:11.3892019Z      user = relationship("User", back_populates="recommendations")
2026-02-20T22:09:11.3892126Z -    
2026-02-20T22:09:11.3892269Z +
2026-02-20T22:09:11.3892852Z      # Exercice recommandé (optionnel - peut être une recommandation par type)
2026-02-20T22:09:11.3893729Z -    exercise_id = Column(Integer, ForeignKey("exercises.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.3893905Z +    exercise_id = Column(
2026-02-20T22:09:11.3894022Z +        Integer,
2026-02-20T22:09:11.3894237Z +        ForeignKey("exercises.id", ondelete="SET NULL"),
2026-02-20T22:09:11.3894361Z +        nullable=True,
2026-02-20T22:09:11.3894497Z +        index=True,
2026-02-20T22:09:11.3894601Z +    )
2026-02-20T22:09:11.3894887Z      exercise = relationship("Exercise", backref="recommendations")
2026-02-20T22:09:11.3895003Z  
2026-02-20T22:09:11.3895512Z      # Défi logique recommandé (optionnel - recommandations de type "challenge")
2026-02-20T22:09:11.3896112Z -    challenge_id = Column(Integer, ForeignKey("logic_challenges.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.3896259Z +    challenge_id = Column(
2026-02-20T22:09:11.3896376Z +        Integer,
2026-02-20T22:09:11.3896624Z +        ForeignKey("logic_challenges.id", ondelete="SET NULL"),
2026-02-20T22:09:11.3896997Z +        nullable=True,
2026-02-20T22:09:11.3897125Z +        index=True,
2026-02-20T22:09:11.3897230Z +    )
2026-02-20T22:09:11.3897565Z      challenge = relationship("LogicChallenge", backref="recommendations")
2026-02-20T22:09:11.3897682Z  
2026-02-20T22:09:11.3897903Z      # Type de recommandation : "exercise" | "challenge"
2026-02-20T22:09:11.3898535Z -    recommendation_type = Column(String(20), default="exercise", nullable=False, index=True)
2026-02-20T22:09:11.3898649Z -    
2026-02-20T22:09:11.3898806Z +    recommendation_type = Column(
2026-02-20T22:09:11.3899057Z +        String(20), default="exercise", nullable=False, index=True
2026-02-20T22:09:11.3899168Z +    )
2026-02-20T22:09:11.3899285Z +
2026-02-20T22:09:11.3899718Z      # Catégorisation (toujours présent même si exercise_id est NULL)
2026-02-20T22:09:11.3899982Z      exercise_type = Column(String, nullable=False, index=True)
2026-02-20T22:09:11.3900168Z      difficulty = Column(String, nullable=False)
2026-02-20T22:09:11.3900289Z -    
2026-02-20T22:09:11.3900397Z +
2026-02-20T22:09:11.3900636Z      # Méta-données de recommandation
2026-02-20T22:09:11.3901283Z -    priority = Column(Integer, default=5, index=True)  # 1-10 (plus c'est élevé, plus c'est prioritaire)
2026-02-20T22:09:11.3901692Z -    reason = Column(Text, nullable=True)   # Raison de la recommandation en langage naturel
2026-02-20T22:09:11.3902450Z -    is_completed = Column(Boolean, default=False, index=True)  # L'utilisateur a-t-il complété cette recommandation
2026-02-20T22:09:11.3902566Z -    
2026-02-20T22:09:11.3902690Z +    priority = Column(
2026-02-20T22:09:11.3902834Z +        Integer, default=5, index=True
2026-02-20T22:09:11.3903345Z +    )  # 1-10 (plus c'est élevé, plus c'est prioritaire)
2026-02-20T22:09:11.3903486Z +    reason = Column(
2026-02-20T22:09:11.3903618Z +        Text, nullable=True
2026-02-20T22:09:11.3903821Z +    )  # Raison de la recommandation en langage naturel
2026-02-20T22:09:11.3903962Z +    is_completed = Column(
2026-02-20T22:09:11.3904137Z +        Boolean, default=False, index=True
2026-02-20T22:09:11.3904471Z +    )  # L'utilisateur a-t-il complété cette recommandation
2026-02-20T22:09:11.3904587Z +
2026-02-20T22:09:11.3904730Z      # Statistiques d'utilisation
2026-02-20T22:09:11.3905353Z -    shown_count = Column(Integer, default=0)  # Nombre de fois que cette recommandation a été affichée
2026-02-20T22:09:11.3905962Z -    clicked_count = Column(Integer, default=0)  # Nombre de fois que l'utilisateur a cliqué dessus
2026-02-20T22:09:11.3906389Z -    last_clicked_at = Column(DateTime(timezone=True), nullable=True)  # Date du dernier clic
2026-02-20T22:09:11.3906519Z +    shown_count = Column(
2026-02-20T22:09:11.3906648Z +        Integer, default=0
2026-02-20T22:09:11.3907004Z +    )  # Nombre de fois que cette recommandation a été affichée
2026-02-20T22:09:11.3907140Z +    clicked_count = Column(
2026-02-20T22:09:11.3907265Z +        Integer, default=0
2026-02-20T22:09:11.3907580Z +    )  # Nombre de fois que l'utilisateur a cliqué dessus
2026-02-20T22:09:11.3907727Z +    last_clicked_at = Column(
2026-02-20T22:09:11.3907892Z +        DateTime(timezone=True), nullable=True
2026-02-20T22:09:11.3908019Z +    )  # Date du dernier clic
2026-02-20T22:09:11.3908549Z      completed_at = Column(DateTime(timezone=True), nullable=True)  # Date de complétion
2026-02-20T22:09:11.3908672Z -    
2026-02-20T22:09:11.3908777Z +
2026-02-20T22:09:11.3908895Z      # Horodatage
2026-02-20T22:09:11.3909175Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.3909581Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3909688Z -    
2026-02-20T22:09:11.3909795Z -    
2026-02-20T22:09:11.3909899Z -    
2026-02-20T22:09:11.3910025Z +    updated_at = Column(
2026-02-20T22:09:11.3910321Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3910428Z +    )
2026-02-20T22:09:11.3910528Z +
2026-02-20T22:09:11.3910879Z      def __repr__(self):
2026-02-20T22:09:11.3911231Z          exercise_info = f", Exercice {self.exercise_id}" if self.exercise_id else ""
2026-02-20T22:09:11.3911906Z -        return f"<Recommandation: Utilisateur {self.user_id}{exercise_info}, Priorité {self.priority}>" 
2026-02-20T22:09:11.3912050Z \ No newline at end of file
2026-02-20T22:09:11.3912890Z +        return f"<Recommandation: Utilisateur {self.user_id}{exercise_info}, Priorité {self.priority}>"
2026-02-20T22:09:11.3913646Z would reformat /home/runner/work/mathakine/mathakine/app/models/recommendation.py
2026-02-20T22:09:11.3914027Z would reformat /home/runner/work/mathakine/mathakine/app/models/setting.py
2026-02-20T22:09:11.3914561Z --- /home/runner/work/mathakine/mathakine/app/models/setting.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3915027Z +++ /home/runner/work/mathakine/mathakine/app/models/setting.py	2026-02-20 22:09:11.386021+00:00
2026-02-20T22:09:11.3915174Z @@ -4,26 +4,31 @@
2026-02-20T22:09:11.3915336Z  from app.db.base import Base
2026-02-20T22:09:11.3915466Z  
2026-02-20T22:09:11.3915579Z  
2026-02-20T22:09:11.3915721Z  class Setting(Base):
2026-02-20T22:09:11.3916248Z      """Modèle pour la configuration de l'application (Configuration du Temple)"""
2026-02-20T22:09:11.3916358Z +
2026-02-20T22:09:11.3916500Z      __tablename__ = "settings"
2026-02-20T22:09:11.3916618Z  
2026-02-20T22:09:11.3916817Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3917088Z      key = Column(String, unique=True, index=True, nullable=False)
2026-02-20T22:09:11.3917264Z      value = Column(String, nullable=True)
2026-02-20T22:09:11.3917582Z      value_json = Column(JSON, nullable=True)  # Pour les valeurs complexes
2026-02-20T22:09:11.3917695Z  
2026-02-20T22:09:11.3917919Z      # Métadonnées
2026-02-20T22:09:11.3918113Z      description = Column(String, nullable=True)
2026-02-20T22:09:11.3918694Z -    category = Column(String, nullable=True)  # Catégorie: système, interface, exercice, etc.
2026-02-20T22:09:11.3919443Z -    is_system = Column(Boolean, default=False)  # Si c'est un paramètre système (non modifiable par l'utilisateur)
2026-02-20T22:09:11.3919787Z -    is_public = Column(Boolean, default=True)   # Si visible dans l'interface
2026-02-20T22:09:11.3919919Z +    category = Column(
2026-02-20T22:09:11.3920054Z +        String, nullable=True
2026-02-20T22:09:11.3920381Z +    )  # Catégorie: système, interface, exercice, etc.
2026-02-20T22:09:11.3920517Z +    is_system = Column(
2026-02-20T22:09:11.3920648Z +        Boolean, default=False
2026-02-20T22:09:11.3921066Z +    )  # Si c'est un paramètre système (non modifiable par l'utilisateur)
2026-02-20T22:09:11.3921388Z +    is_public = Column(Boolean, default=True)  # Si visible dans l'interface
2026-02-20T22:09:11.3921494Z  
2026-02-20T22:09:11.3921619Z      # Horodatage
2026-02-20T22:09:11.3921901Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.3922306Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3922427Z -
2026-02-20T22:09:11.3922539Z -
2026-02-20T22:09:11.3922671Z +    updated_at = Column(
2026-02-20T22:09:11.3923158Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3923284Z +    )
2026-02-20T22:09:11.3923391Z  
2026-02-20T22:09:11.3923519Z      def __repr__(self):
2026-02-20T22:09:11.3923781Z          return f"<Paramètre: {self.key}>"
2026-02-20T22:09:11.4524678Z --- /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4535267Z +++ /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py	2026-02-20 22:09:11.451011+00:00
2026-02-20T22:09:11.4536243Z @@ -1,60 +1,130 @@
2026-02-20T22:09:11.4536719Z  """
2026-02-20T22:09:11.4537459Z  Module regroupant tous les schémas Pydantic pour la validation de l'API Mathakine.
2026-02-20T22:09:11.4537817Z  À importer pour valider les données entrantes et sortantes.
2026-02-20T22:09:11.4537923Z  """
2026-02-20T22:09:11.4538474Z  
2026-02-20T22:09:11.4538818Z -from app.schemas.attempt import (Attempt, AttemptBase, AttemptBatch,
2026-02-20T22:09:11.4539045Z -                                 AttemptCreate, AttemptInDB, AttemptStats,
2026-02-20T22:09:11.4539194Z -                                 AttemptUpdate)
2026-02-20T22:09:11.4539514Z -from app.schemas.common import (ErrorCode, ErrorResponse, HealthCheck,
2026-02-20T22:09:11.4539986Z -                                ListResponse, PageInfo, Response, StatusCode,
2026-02-20T22:09:11.4540143Z -                                ValidationError)
2026-02-20T22:09:11.4540484Z -from app.schemas.exercise import (Exercise, ExerciseBase, ExerciseCreate,
2026-02-20T22:09:11.4540726Z -                                  ExerciseInDB, ExerciseStats, ExerciseUpdate)
2026-02-20T22:09:11.4541094Z -from app.schemas.logic_challenge import (LogicChallenge, LogicChallengeAttempt,
2026-02-20T22:09:11.4541302Z -                                         LogicChallengeAttemptBase,
2026-02-20T22:09:11.4541532Z -                                         LogicChallengeAttemptCreate,
2026-02-20T22:09:11.4541736Z -                                         LogicChallengeAttemptInDB,
2026-02-20T22:09:11.4541941Z -                                         LogicChallengeAttemptUpdate,
2026-02-20T22:09:11.4542133Z -                                         LogicChallengeBase,
2026-02-20T22:09:11.4542327Z -                                         LogicChallengeCreate,
2026-02-20T22:09:11.4542492Z -                                         LogicChallengeInDB,
2026-02-20T22:09:11.4542665Z -                                         LogicChallengeStats,
2026-02-20T22:09:11.4542837Z -                                         LogicChallengeUpdate)
2026-02-20T22:09:11.4543372Z -from app.schemas.progress import (Progress, ProgressBase, ProgressCreate,
2026-02-20T22:09:11.4543577Z -                                  ProgressInDB, ProgressUpdate,
2026-02-20T22:09:11.4543790Z -                                  UserProgressSummary)
2026-02-20T22:09:11.4544126Z -from app.schemas.user import (Token, TokenData, User, UserBase, UserCreate,
2026-02-20T22:09:11.4544301Z -                              UserInDB, UserLogin, UserUpdate)
2026-02-20T22:09:11.4544594Z -from app.schemas.user_session import (UserSession, UserSessionBase,
2026-02-20T22:09:11.4544800Z -                                      UserSessionInDB, UserSessionRevoke)
2026-02-20T22:09:11.4544957Z +from app.schemas.attempt import (
2026-02-20T22:09:11.4545067Z +    Attempt,
2026-02-20T22:09:11.4545183Z +    AttemptBase,
2026-02-20T22:09:11.4545299Z +    AttemptBatch,
2026-02-20T22:09:11.4545417Z +    AttemptCreate,
2026-02-20T22:09:11.4545527Z +    AttemptInDB,
2026-02-20T22:09:11.4545642Z +    AttemptStats,
2026-02-20T22:09:11.4545754Z +    AttemptUpdate,
2026-02-20T22:09:11.4545854Z +)
2026-02-20T22:09:11.4546001Z +from app.schemas.common import (
2026-02-20T22:09:11.4546109Z +    ErrorCode,
2026-02-20T22:09:11.4546222Z +    ErrorResponse,
2026-02-20T22:09:11.4546339Z +    HealthCheck,
2026-02-20T22:09:11.4546462Z +    ListResponse,
2026-02-20T22:09:11.4546569Z +    PageInfo,
2026-02-20T22:09:11.4546674Z +    Response,
2026-02-20T22:09:11.4546788Z +    StatusCode,
2026-02-20T22:09:11.4546905Z +    ValidationError,
2026-02-20T22:09:11.4547004Z +)
2026-02-20T22:09:11.4547147Z +from app.schemas.exercise import (
2026-02-20T22:09:11.4547270Z +    Exercise,
2026-02-20T22:09:11.4547383Z +    ExerciseBase,
2026-02-20T22:09:11.4547500Z +    ExerciseCreate,
2026-02-20T22:09:11.4547617Z +    ExerciseInDB,
2026-02-20T22:09:11.4547732Z +    ExerciseStats,
2026-02-20T22:09:11.4547857Z +    ExerciseUpdate,
2026-02-20T22:09:11.4547963Z +)
2026-02-20T22:09:11.4548149Z +from app.schemas.logic_challenge import (
2026-02-20T22:09:11.4548277Z +    LogicChallenge,
2026-02-20T22:09:11.4548420Z +    LogicChallengeAttempt,
2026-02-20T22:09:11.4548573Z +    LogicChallengeAttemptBase,
2026-02-20T22:09:11.4548719Z +    LogicChallengeAttemptCreate,
2026-02-20T22:09:11.4548854Z +    LogicChallengeAttemptInDB,
2026-02-20T22:09:11.4549276Z +    LogicChallengeAttemptUpdate,
2026-02-20T22:09:11.4549424Z +    LogicChallengeBase,
2026-02-20T22:09:11.4549561Z +    LogicChallengeCreate,
2026-02-20T22:09:11.4549688Z +    LogicChallengeInDB,
2026-02-20T22:09:11.4549820Z +    LogicChallengeStats,
2026-02-20T22:09:11.4549947Z +    LogicChallengeUpdate,
2026-02-20T22:09:11.4550260Z +)
2026-02-20T22:09:11.4550418Z +from app.schemas.progress import (
2026-02-20T22:09:11.4550542Z +    Progress,
2026-02-20T22:09:11.4550656Z +    ProgressBase,
2026-02-20T22:09:11.4550780Z +    ProgressCreate,
2026-02-20T22:09:11.4550907Z +    ProgressInDB,
2026-02-20T22:09:11.4551036Z +    ProgressUpdate,
2026-02-20T22:09:11.4551171Z +    UserProgressSummary,
2026-02-20T22:09:11.4551276Z +)
2026-02-20T22:09:11.4551422Z +from app.schemas.user import (
2026-02-20T22:09:11.4551531Z +    Token,
2026-02-20T22:09:11.4551643Z +    TokenData,
2026-02-20T22:09:11.4551756Z +    User,
2026-02-20T22:09:11.4551863Z +    UserBase,
2026-02-20T22:09:11.4551985Z +    UserCreate,
2026-02-20T22:09:11.4552087Z +    UserInDB,
2026-02-20T22:09:11.4552188Z +    UserLogin,
2026-02-20T22:09:11.4552284Z +    UserUpdate,
2026-02-20T22:09:11.4552371Z +)
2026-02-20T22:09:11.4552533Z +from app.schemas.user_session import (
2026-02-20T22:09:11.4552646Z +    UserSession,
2026-02-20T22:09:11.4552763Z +    UserSessionBase,
2026-02-20T22:09:11.4552884Z +    UserSessionInDB,
2026-02-20T22:09:11.4553214Z +    UserSessionRevoke,
2026-02-20T22:09:11.4553324Z +)
2026-02-20T22:09:11.4553432Z  
2026-02-20T22:09:11.4553562Z  # Export all schemas
2026-02-20T22:09:11.4553675Z  __all__ = [
2026-02-20T22:09:11.4553792Z      # User schemas
2026-02-20T22:09:11.4554224Z -    "UserBase", "UserCreate", "UserUpdate", "UserInDB", "User", "UserLogin", "Token", "TokenData",
2026-02-20T22:09:11.4554341Z -    
2026-02-20T22:09:11.4554456Z +    "UserBase",
2026-02-20T22:09:11.4554566Z +    "UserCreate",
2026-02-20T22:09:11.4554695Z +    "UserUpdate",
2026-02-20T22:09:11.4554807Z +    "UserInDB",
2026-02-20T22:09:11.4554924Z +    "User",
2026-02-20T22:09:11.4555032Z +    "UserLogin",
2026-02-20T22:09:11.4555139Z +    "Token",
2026-02-20T22:09:11.4555245Z +    "TokenData",
2026-02-20T22:09:11.4555372Z      # User Session schemas
2026-02-20T22:09:11.4555712Z -    "UserSessionBase", "UserSessionInDB", "UserSession", "UserSessionRevoke",
2026-02-20T22:09:11.4555817Z -
2026-02-20T22:09:11.4555945Z +    "UserSessionBase",
2026-02-20T22:09:11.4556072Z +    "UserSessionInDB",
2026-02-20T22:09:11.4556192Z +    "UserSession",
2026-02-20T22:09:11.4556323Z +    "UserSessionRevoke",
2026-02-20T22:09:11.4556444Z      # Exercise schemas
2026-02-20T22:09:11.4556910Z -    "ExerciseBase", "ExerciseCreate", "ExerciseUpdate", "ExerciseInDB", "Exercise", "ExerciseStats",
2026-02-20T22:09:11.4557025Z -
2026-02-20T22:09:11.4557151Z +    "ExerciseBase",
2026-02-20T22:09:11.4557284Z +    "ExerciseCreate",
2026-02-20T22:09:11.4557417Z +    "ExerciseUpdate",
2026-02-20T22:09:11.4557529Z +    "ExerciseInDB",
2026-02-20T22:09:11.4557652Z +    "Exercise",
2026-02-20T22:09:11.4557782Z +    "ExerciseStats",
2026-02-20T22:09:11.4557906Z      # Attempt schemas
2026-02-20T22:09:11.4558337Z -    "AttemptBase", "AttemptCreate", "AttemptUpdate", "AttemptInDB", "Attempt", "AttemptBatch"\
2026-02-20T22:09:11.4558468Z -        , "AttemptStats",
2026-02-20T22:09:11.4558573Z -
2026-02-20T22:09:11.4558691Z +    "AttemptBase",
2026-02-20T22:09:11.4558807Z +    "AttemptCreate",
2026-02-20T22:09:11.4558929Z +    "AttemptUpdate",
2026-02-20T22:09:11.4559042Z +    "AttemptInDB",
2026-02-20T22:09:11.4559152Z +    "Attempt",
2026-02-20T22:09:11.4559276Z +    "AttemptBatch",
2026-02-20T22:09:11.4559404Z +    "AttemptStats",
2026-02-20T22:09:11.4559533Z      # Progress schemas
2026-02-20T22:09:11.4559911Z -    "ProgressBase", "ProgressCreate", "ProgressUpdate", "ProgressInDB", "Progress"\
2026-02-20T22:09:11.4560064Z -        , "UserProgressSummary",
2026-02-20T22:09:11.4560170Z -
2026-02-20T22:09:11.4560290Z +    "ProgressBase",
2026-02-20T22:09:11.4560661Z +    "ProgressCreate",
2026-02-20T22:09:11.4560802Z +    "ProgressUpdate",
2026-02-20T22:09:11.4560921Z +    "ProgressInDB",
2026-02-20T22:09:11.4561026Z +    "Progress",
2026-02-20T22:09:11.4561171Z +    "UserProgressSummary",
2026-02-20T22:09:11.4561313Z      # Logic Challenge schemas
2026-02-20T22:09:11.4561796Z -    "LogicChallengeBase", "LogicChallengeCreate", "LogicChallengeUpdate", "LogicChallengeInDB"\
2026-02-20T22:09:11.4562167Z -        , "LogicChallenge",
2026-02-20T22:09:11.4562667Z -    "LogicChallengeAttemptBase", "LogicChallengeAttemptCreate", "LogicChallengeAttemptUpdate",
2026-02-20T22:09:11.4563243Z -    "LogicChallengeAttemptInDB", "LogicChallengeAttempt", "LogicChallengeStats",
2026-02-20T22:09:11.4563359Z -
2026-02-20T22:09:11.4563496Z +    "LogicChallengeBase",
2026-02-20T22:09:11.4563628Z +    "LogicChallengeCreate",
2026-02-20T22:09:11.4563771Z +    "LogicChallengeUpdate",
2026-02-20T22:09:11.4563897Z +    "LogicChallengeInDB",
2026-02-20T22:09:11.4564014Z +    "LogicChallenge",
2026-02-20T22:09:11.4564179Z +    "LogicChallengeAttemptBase",
2026-02-20T22:09:11.4564336Z +    "LogicChallengeAttemptCreate",
2026-02-20T22:09:11.4564516Z +    "LogicChallengeAttemptUpdate",
2026-02-20T22:09:11.4564662Z +    "LogicChallengeAttemptInDB",
2026-02-20T22:09:11.4564801Z +    "LogicChallengeAttempt",
2026-02-20T22:09:11.4564941Z +    "LogicChallengeStats",
2026-02-20T22:09:11.4565085Z      # Common response schemas
2026-02-20T22:09:11.4565439Z -    "Response", "ListResponse", "ErrorResponse", "StatusCode", "ErrorCode", "PageInfo"\
2026-02-20T22:09:11.4565600Z -        , "ValidationError", "HealthCheck"
2026-02-20T22:09:11.4565710Z +    "Response",
2026-02-20T22:09:11.4565834Z +    "ListResponse",
2026-02-20T22:09:11.4565967Z +    "ErrorResponse",
2026-02-20T22:09:11.4566095Z +    "StatusCode",
2026-02-20T22:09:11.4566218Z +    "ErrorCode",
2026-02-20T22:09:11.4566330Z +    "PageInfo",
2026-02-20T22:09:11.4566465Z +    "ValidationError",
2026-02-20T22:09:11.4566581Z +    "HealthCheck",
2026-02-20T22:09:11.4566697Z  ]
2026-02-20T22:09:11.4567371Z --- /home/runner/work/mathakine/mathakine/app/models/user_session.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4567884Z +++ /home/runner/work/mathakine/mathakine/app/models/user_session.py	2026-02-20 22:09:11.452858+00:00
2026-02-20T22:09:11.4568330Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py
2026-02-20T22:09:11.4568724Z would reformat /home/runner/work/mathakine/mathakine/app/models/user_session.py
2026-02-20T22:09:11.4568851Z @@ -1,26 +1,37 @@
2026-02-20T22:09:11.4568960Z  """
2026-02-20T22:09:11.4569370Z  Modèle SQLAlchemy pour les sessions utilisateur
2026-02-20T22:09:11.4569491Z  """
2026-02-20T22:09:11.4569826Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.4569977Z -                        Integer, String, Text)
2026-02-20T22:09:11.4570085Z +
2026-02-20T22:09:11.4570219Z +from sqlalchemy import (
2026-02-20T22:09:11.4570322Z +    JSON,
2026-02-20T22:09:11.4570445Z +    Boolean,
2026-02-20T22:09:11.4570563Z +    Column,
2026-02-20T22:09:11.4570682Z +    DateTime,
2026-02-20T22:09:11.4570799Z +    ForeignKey,
2026-02-20T22:09:11.4570918Z +    Index,
2026-02-20T22:09:11.4571027Z +    Integer,
2026-02-20T22:09:11.4587133Z +    String,
2026-02-20T22:09:11.4587303Z +    Text,
2026-02-20T22:09:11.4587419Z +)
2026-02-20T22:09:11.4587670Z  from sqlalchemy.dialects.postgresql import INET
2026-02-20T22:09:11.4587859Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.4588016Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.4588122Z  
2026-02-20T22:09:11.4588281Z  from app.db.base import Base
2026-02-20T22:09:11.4588393Z  
2026-02-20T22:09:11.4588495Z  
2026-02-20T22:09:11.4588635Z  class UserSession(Base):
2026-02-20T22:09:11.4589009Z      """Modèle pour les sessions utilisateur"""
2026-02-20T22:09:11.4589114Z +
2026-02-20T22:09:11.4589247Z      __tablename__ = "user_sessions"
2026-02-20T22:09:11.4589381Z -    __table_args__ = (
2026-02-20T22:09:11.4589852Z -        Index('idx_user_sessions_user_id', 'user_id'),
2026-02-20T22:09:11.4589964Z -    )
2026-02-20T22:09:11.4590244Z +    __table_args__ = (Index("idx_user_sessions_user_id", "user_id"),)
2026-02-20T22:09:11.4590359Z  
2026-02-20T22:09:11.4590570Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4590979Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.4591318Z +    user_id = Column(
2026-02-20T22:09:11.4591635Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.4591745Z +    )
2026-02-20T22:09:11.4592098Z      session_token = Column(String(255), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.4592277Z      device_info = Column(JSON, nullable=True)
2026-02-20T22:09:11.4592453Z      ip_address = Column(INET, nullable=True)
2026-02-20T22:09:11.4592615Z      user_agent = Column(Text, nullable=True)
2026-02-20T22:09:11.4592802Z      location_data = Column(JSON, nullable=True)
2026-02-20T22:09:11.4592933Z @@ -36,12 +47,14 @@
2026-02-20T22:09:11.4593540Z          return f"<UserSession {self.id}: User {self.user_id}, Active: {self.is_active}>"
2026-02-20T22:09:11.4593659Z  
2026-02-20T22:09:11.4593814Z      def is_expired(self) -> bool:
2026-02-20T22:09:11.4594112Z          """Vérifier si la session a expiré"""
2026-02-20T22:09:11.4594317Z          from datetime import datetime, timezone
2026-02-20T22:09:11.4594425Z +
2026-02-20T22:09:11.4594663Z          return datetime.now(timezone.utc) > self.expires_at
2026-02-20T22:09:11.4594772Z  
2026-02-20T22:09:11.4594954Z      def extend_session(self, hours: int = 24):
2026-02-20T22:09:11.4595098Z          """Prolonger la session"""
2026-02-20T22:09:11.4595323Z          from datetime import datetime, timedelta, timezone
2026-02-20T22:09:11.4595441Z +
2026-02-20T22:09:11.4595761Z          self.expires_at = datetime.now(timezone.utc) + timedelta(hours=hours)
2026-02-20T22:09:11.4595968Z          self.last_activity = datetime.now(timezone.utc)
2026-02-20T22:09:11.4715339Z --- /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4717462Z +++ /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py	2026-02-20 22:09:11.468429+00:00
2026-02-20T22:09:11.4719595Z @@ -1,91 +1,124 @@
2026-02-20T22:09:11.4720907Z would reformat /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py
2026-02-20T22:09:11.4721667Z  from enum import Enum as PyEnum
2026-02-20T22:09:11.4724081Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:11.4727267Z  
2026-02-20T22:09:11.4734223Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Enum, Float,
2026-02-20T22:09:11.4735131Z -                        ForeignKey, Index, Integer, String, Table, Text)
2026-02-20T22:09:11.4735808Z +from sqlalchemy import (
2026-02-20T22:09:11.4736283Z +    JSON,
2026-02-20T22:09:11.4736664Z +    Boolean,
2026-02-20T22:09:11.4737053Z +    Column,
2026-02-20T22:09:11.4737440Z +    DateTime,
2026-02-20T22:09:11.4737947Z +    Enum,
2026-02-20T22:09:11.4738927Z +    Float,
2026-02-20T22:09:11.4739530Z +    ForeignKey,
2026-02-20T22:09:11.4740569Z +    Index,
2026-02-20T22:09:11.4741041Z +    Integer,
2026-02-20T22:09:11.4741433Z +    String,
2026-02-20T22:09:11.4741826Z +    Table,
2026-02-20T22:09:11.4742254Z +    Text,
2026-02-20T22:09:11.4742658Z +)
2026-02-20T22:09:11.4743266Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.4743902Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.4744384Z  
2026-02-20T22:09:11.4744769Z  from app.db.base import Base
2026-02-20T22:09:11.4745231Z  
2026-02-20T22:09:11.4745580Z  
2026-02-20T22:09:11.4745979Z  class LogicChallengeType(str, PyEnum):
2026-02-20T22:09:11.4746793Z      """Types de défis logiques"""
2026-02-20T22:09:11.4747504Z -    SEQUENCE = "sequence"          # Suites logiques (nombres, formes, etc.)
2026-02-20T22:09:11.4748373Z -    PATTERN = "pattern"            # Reconnaissance de motifs
2026-02-20T22:09:11.4749768Z -    VISUAL = "visual"              # Défis visuels et spatiaux (inclut rotation, symétrie)
2026-02-20T22:09:11.4750884Z -    PUZZLE = "puzzle"              # Puzzles interactifs (réorganisation, ordre)
2026-02-20T22:09:11.4753465Z -    RIDDLE = "riddle"              # Énigmes textuelles avec grilles
2026-02-20T22:09:11.4754341Z -    DEDUCTION = "deduction"        # Raisonnement déductif (grilles logiques)
2026-02-20T22:09:11.4755436Z -    PROBABILITY = "probability"    # Probabilités simples
2026-02-20T22:09:11.4756167Z -    GRAPH = "graph"                # Problèmes de graphes
2026-02-20T22:09:11.4756856Z -    CODING = "coding"              # Codage et décryptage
2026-02-20T22:09:11.4757524Z -    CHESS = "chess"                # Problèmes d'échecs
2026-02-20T22:09:11.4758196Z -    CUSTOM = "custom"              # Défis personnalisés
2026-02-20T22:09:11.4758668Z -
2026-02-20T22:09:11.4758919Z +
2026-02-20T22:09:11.4759336Z +    SEQUENCE = "sequence"  # Suites logiques (nombres, formes, etc.)
2026-02-20T22:09:11.4760017Z +    PATTERN = "pattern"  # Reconnaissance de motifs
2026-02-20T22:09:11.4760829Z +    VISUAL = "visual"  # Défis visuels et spatiaux (inclut rotation, symétrie)
2026-02-20T22:09:11.4761739Z +    PUZZLE = "puzzle"  # Puzzles interactifs (réorganisation, ordre)
2026-02-20T22:09:11.4762506Z +    RIDDLE = "riddle"  # Énigmes textuelles avec grilles
2026-02-20T22:09:11.4763492Z +    DEDUCTION = "deduction"  # Raisonnement déductif (grilles logiques)
2026-02-20T22:09:11.4764295Z +    PROBABILITY = "probability"  # Probabilités simples
2026-02-20T22:09:11.4764922Z +    GRAPH = "graph"  # Problèmes de graphes
2026-02-20T22:09:11.4765492Z +    CODING = "coding"  # Codage et décryptage
2026-02-20T22:09:11.4766047Z +    CHESS = "chess"  # Problèmes d'échecs
2026-02-20T22:09:11.4766622Z +    CUSTOM = "custom"  # Défis personnalisés
2026-02-20T22:09:11.4767065Z  
2026-02-20T22:09:11.4767316Z  
2026-02-20T22:09:11.4767610Z  class AgeGroup(str, PyEnum):
2026-02-20T22:09:11.4767978Z      """
2026-02-20T22:09:11.4768402Z      Groupes d'âge pour les défis logiques.
2026-02-20T22:09:11.4768828Z -    
2026-02-20T22:09:11.4769075Z +
2026-02-20T22:09:11.4769669Z      IMPORTANT: Les valeurs DOIVENT correspondre EXACTEMENT aux valeurs de l'ENUM PostgreSQL.
2026-02-20T22:09:11.4770428Z -    
2026-02-20T22:09:11.4770690Z +
2026-02-20T22:09:11.4771098Z      Mapping frontend → DB:
2026-02-20T22:09:11.4771587Z      - "6-8"      → GROUP_6_8
2026-02-20T22:09:11.4772040Z      - "9-11"     → GROUP_10_12
2026-02-20T22:09:11.4772497Z      - "12-14"    → GROUP_13_15
2026-02-20T22:09:11.4772940Z      - "15-17"    → GROUP_15_17
2026-02-20T22:09:11.4773575Z      - "adulte"   → ADULT
2026-02-20T22:09:11.4773997Z      - "tous-ages"→ ALL_AGES
2026-02-20T22:09:11.4774361Z      """
2026-02-20T22:09:11.4774636Z +
2026-02-20T22:09:11.4775116Z      # Groupes d'âge - alignés avec les valeurs PostgreSQL
2026-02-20T22:09:11.4775709Z -    GROUP_6_8 = "GROUP_6_8"      # 6-8 ans (CP-CE2)
2026-02-20T22:09:11.4776428Z -    GROUP_10_12 = "GROUP_10_12"  # 9-11 ans (CM1-CM2-6e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4777388Z -    GROUP_13_15 = "GROUP_13_15"  # 12-14 ans (5e-4e-3e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4778107Z +    GROUP_6_8 = "GROUP_6_8"  # 6-8 ans (CP-CE2)
2026-02-20T22:09:11.4778553Z +    GROUP_10_12 = (
2026-02-20T22:09:11.4779067Z +        "GROUP_10_12"  # 9-11 ans (CM1-CM2-6e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4779682Z +    )
2026-02-20T22:09:11.4779964Z +    GROUP_13_15 = (
2026-02-20T22:09:11.4780455Z +        "GROUP_13_15"  # 12-14 ans (5e-4e-3e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4781063Z +    )
2026-02-20T22:09:11.4781527Z      GROUP_15_17 = "GROUP_15_17"  # 15-17 ans (Lycée)
2026-02-20T22:09:11.4782044Z -    ADULT = "ADULT"              # Adultes (18+)
2026-02-20T22:09:11.4782620Z -    ALL_AGES = "ALL_AGES"        # Tous âges
2026-02-20T22:09:11.4783260Z +    ADULT = "ADULT"  # Adultes (18+)
2026-02-20T22:09:11.4783784Z +    ALL_AGES = "ALL_AGES"  # Tous âges
2026-02-20T22:09:11.4784690Z      # AGE_9_12 = "9-12"         # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4785423Z      # AGE_12_13 = "12-13"       # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4786115Z      # AGE_13_PLUS = "13+"       # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4786623Z  
2026-02-20T22:09:11.4786874Z  
2026-02-20T22:09:11.4787429Z -
2026-02-20T22:09:11.4787718Z  class LogicChallenge(Base):
2026-02-20T22:09:11.4788222Z      """Modèle pour les défis logiques"""
2026-02-20T22:09:11.4788645Z +
2026-02-20T22:09:11.4788933Z      __tablename__ = "logic_challenges"
2026-02-20T22:09:11.4789342Z -    
2026-02-20T22:09:11.4789595Z +
2026-02-20T22:09:11.4790104Z      # Index composites pour les requêtes de filtrage fréquentes
2026-02-20T22:09:11.4790652Z      __table_args__ = (
2026-02-20T22:09:11.4791163Z -        Index('ix_challenges_type_age', 'challenge_type', 'age_group'),
2026-02-20T22:09:11.4791951Z -        Index('ix_challenges_archived_type', 'is_archived', 'challenge_type'),
2026-02-20T22:09:11.4792740Z +        Index("ix_challenges_type_age", "challenge_type", "age_group"),
2026-02-20T22:09:11.4793695Z +        Index("ix_challenges_archived_type", "is_archived", "challenge_type"),
2026-02-20T22:09:11.4794282Z      )
2026-02-20T22:09:11.4794533Z  
2026-02-20T22:09:11.4794868Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4795347Z  
2026-02-20T22:09:11.4795665Z      # Métadonnées
2026-02-20T22:09:11.4796029Z      title = Column(String(255), nullable=False)
2026-02-20T22:09:11.4796534Z      description = Column(Text, nullable=False)
2026-02-20T22:09:11.4797523Z -    challenge_type = Column(Enum(LogicChallengeType, name="logicchallengetype", create_type=False), nullable=False, index=True)
2026-02-20T22:09:11.4798835Z -    age_group = Column(Enum(AgeGroup, name="agegroup", create_type=False), nullable=False, index=True)
2026-02-20T22:09:11.4799975Z -    difficulty = Column(String(50), nullable=True, index=True)  # Optionnel pour compatibilité
2026-02-20T22:09:11.4800691Z -    
2026-02-20T22:09:11.4800972Z +    challenge_type = Column(
2026-02-20T22:09:11.4801570Z +        Enum(LogicChallengeType, name="logicchallengetype", create_type=False),
2026-02-20T22:09:11.4802214Z +        nullable=False,
2026-02-20T22:09:11.4802545Z +        index=True,
2026-02-20T22:09:11.4802842Z +    )
2026-02-20T22:09:11.4803271Z +    age_group = Column(
2026-02-20T22:09:11.4803856Z +        Enum(AgeGroup, name="agegroup", create_type=False), nullable=False, index=True
2026-02-20T22:09:11.4804499Z +    )
2026-02-20T22:09:11.4804777Z +    difficulty = Column(
2026-02-20T22:09:11.4805151Z +        String(50), nullable=True, index=True
2026-02-20T22:09:11.4805665Z +    )  # Optionnel pour compatibilité
2026-02-20T22:09:11.4806057Z +
2026-02-20T22:09:11.4806364Z      # Contenu du défi
2026-02-20T22:09:11.4806951Z      content = Column(Text, nullable=True)  # Contenu formaté du défi
2026-02-20T22:09:11.4807879Z      question = Column(Text, nullable=True)  # Question spécifique (pour compatibilité)
2026-02-20T22:09:11.4808695Z      solution = Column(Text, nullable=True)  # Solution technique
2026-02-20T22:09:11.4809666Z -    correct_answer = Column(String(255), nullable=True)  # Réponse courte (pour compatibilité)
2026-02-20T22:09:11.4810400Z +    correct_answer = Column(
2026-02-20T22:09:11.4810749Z +        String(255), nullable=True
2026-02-20T22:09:11.4811273Z +    )  # Réponse courte (pour compatibilité)
2026-02-20T22:09:11.4811943Z      choices = Column(JSON, nullable=True)  # Choix possibles (pour les QCM)
2026-02-20T22:09:11.4813328Z -    solution_explanation = Column(Text, nullable=True)  # Explication détaillée (alias pour solution)
2026-02-20T22:09:11.4814781Z -    visual_data = Column(JSON, nullable=True)  # Données pour visualisation (graphes, formes, etc.)
2026-02-20T22:09:11.4815577Z -    
2026-02-20T22:09:11.4815895Z +    solution_explanation = Column(
2026-02-20T22:09:11.4816320Z +        Text, nullable=True
2026-02-20T22:09:11.4816902Z +    )  # Explication détaillée (alias pour solution)
2026-02-20T22:09:11.4817704Z +    visual_data = Column(
2026-02-20T22:09:11.4818085Z +        JSON, nullable=True
2026-02-20T22:09:11.4818715Z +    )  # Données pour visualisation (graphes, formes, etc.)
2026-02-20T22:09:11.4819232Z +
2026-02-20T22:09:11.4819539Z      hints = Column(JSON, nullable=True)
2026-02-20T22:09:11.4820297Z      is_active = Column(Boolean, default=True)
2026-02-20T22:09:11.4821031Z      creator_id = Column(Integer, ForeignKey("users.id"), nullable=True, index=True)
2026-02-20T22:09:11.4822129Z -    created_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.4823188Z +    created_at = Column(
2026-02-20T22:09:11.4823753Z +        DateTime(timezone=True), server_default=func.now(), index=True
2026-02-20T22:09:11.4824365Z +    )  # Tri chronologique
2026-02-20T22:09:11.4824926Z      updated_at = Column(DateTime(timezone=True), onupdate=func.now())
2026-02-20T22:09:11.4825517Z  
2026-02-20T22:09:11.4825954Z      # Métadonnées d'évaluation
2026-02-20T22:09:11.4826630Z      difficulty_rating = Column(Float, default=3.0)  # Échelle 1-5
2026-02-20T22:09:11.4827629Z      estimated_time_minutes = Column(Integer, default=15)  # Temps estimé en minutes
2026-02-20T22:09:11.4828335Z @@ -95,82 +128,93 @@
2026-02-20T22:09:11.4829001Z      image_url = Column(String, nullable=True)  # URL de l'image associée
2026-02-20T22:09:11.4829912Z      source_reference = Column(String, nullable=True)  # Source (concours, livre, etc.)
2026-02-20T22:09:11.4830972Z      tags = Column(String, nullable=True)  # Tags séparés par des virgules
2026-02-20T22:09:11.4831584Z  
2026-02-20T22:09:11.4831996Z      # Métadonnées pour la génération
2026-02-20T22:09:11.4832897Z -    is_template = Column(Boolean, default=False)  # S'il s'agit d'un template pour génération
2026-02-20T22:09:11.4833888Z +    is_template = Column(
2026-02-20T22:09:11.4834280Z +        Boolean, default=False
2026-02-20T22:09:11.4834867Z +    )  # S'il s'agit d'un template pour génération
2026-02-20T22:09:11.4835870Z      generation_parameters = Column(JSON, nullable=True)  # Paramètres pour la génération
2026-02-20T22:09:11.4836619Z  
2026-02-20T22:09:11.4836952Z      # États
2026-02-20T22:09:11.4837634Z      is_archived = Column(Boolean, default=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.4838385Z      view_count = Column(Integer, default=0)
2026-02-20T22:09:11.4838827Z  
2026-02-20T22:09:11.4839097Z      # Relations
2026-02-20T22:09:11.4839868Z -    attempts = relationship("LogicChallengeAttempt", back_populates="challenge", cascade="all, delete-orphan")
2026-02-20T22:09:11.4840803Z +    attempts = relationship(
2026-02-20T22:09:11.4841223Z +        "LogicChallengeAttempt",
2026-02-20T22:09:11.4841659Z +        back_populates="challenge",
2026-02-20T22:09:11.4842111Z +        cascade="all, delete-orphan",
2026-02-20T22:09:11.4842530Z +    )
2026-02-20T22:09:11.4843211Z      creator = relationship("User", back_populates="created_logic_challenges")
2026-02-20T22:09:11.4843899Z  
2026-02-20T22:09:11.4844222Z      def to_dict(self) -> Dict[str, Any]:
2026-02-20T22:09:11.4845084Z          """Convertit le modèle en dictionnaire avec conversion des énumérations."""
2026-02-20T22:09:11.4845831Z          from datetime import datetime, timezone
2026-02-20T22:09:11.4846285Z  
2026-02-20T22:09:11.4846693Z          from app.utils.db_helpers import get_python_enum_value
2026-02-20T22:09:11.4847292Z  
2026-02-20T22:09:11.4847721Z          # Créer le dictionnaire de base
2026-02-20T22:09:11.4848352Z          result = {c.name: getattr(self, c.name) for c in self.__table__.columns}
2026-02-20T22:09:11.4848983Z -        
2026-02-20T22:09:11.4849272Z +
2026-02-20T22:09:11.4849862Z          # Convertir les énumérations PostgreSQL vers les valeurs Python
2026-02-20T22:09:11.4850524Z -        if result.get('challenge_type'):
2026-02-20T22:09:11.4851350Z -            result['challenge_type'] = get_python_enum_value(LogicChallengeType, result['challenge_type'])
2026-02-20T22:09:11.4852426Z -        
2026-02-20T22:09:11.4852736Z -        if result.get('age_group'):
2026-02-20T22:09:11.4853577Z -            result['age_group'] = get_python_enum_value(AgeGroup, result['age_group'])
2026-02-20T22:09:11.4854233Z -        
2026-02-20T22:09:11.4854561Z +        if result.get("challenge_type"):
2026-02-20T22:09:11.4855110Z +            result["challenge_type"] = get_python_enum_value(
2026-02-20T22:09:11.4856000Z +                LogicChallengeType, result["challenge_type"]
2026-02-20T22:09:11.4856508Z +            )
2026-02-20T22:09:11.4856787Z +
2026-02-20T22:09:11.4857080Z +        if result.get("age_group"):
2026-02-20T22:09:11.4857708Z +            result["age_group"] = get_python_enum_value(AgeGroup, result["age_group"])
2026-02-20T22:09:11.4858356Z +
2026-02-20T22:09:11.4858895Z          # Gérer le champ hints (conversion JSON si nécessaire)
2026-02-20T22:09:11.4859450Z -        if result.get('hints'):
2026-02-20T22:09:11.4859899Z -            if isinstance(result['hints'], str):
2026-02-20T22:09:11.4860388Z +        if result.get("hints"):
2026-02-20T22:09:11.4860820Z +            if isinstance(result["hints"], str):
2026-02-20T22:09:11.4861531Z                  # Si c'est une chaîne, essayer de la parser en JSON
2026-02-20T22:09:11.4862070Z                  try:
2026-02-20T22:09:11.4862401Z                      import json
2026-02-20T22:09:11.4862848Z -                    result['hints'] = json.loads(result['hints'])
2026-02-20T22:09:11.4863552Z +
2026-02-20T22:09:11.4863917Z +                    result["hints"] = json.loads(result["hints"])
2026-02-20T22:09:11.4864508Z                  except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:11.4865236Z                      # Si ça échoue, transformer en liste simple
2026-02-20T22:09:11.4865814Z -                    result['hints'] = [result['hints']]
2026-02-20T22:09:11.4866375Z -            elif not isinstance(result['hints'], list):
2026-02-20T22:09:11.4866884Z -                result['hints'] = []
2026-02-20T22:09:11.4867354Z +                    result["hints"] = [result["hints"]]
2026-02-20T22:09:11.4867880Z +            elif not isinstance(result["hints"], list):
2026-02-20T22:09:11.4868375Z +                result["hints"] = []
2026-02-20T22:09:11.4868771Z          else:
2026-02-20T22:09:11.4869091Z -            result['hints'] = []
2026-02-20T22:09:11.4869469Z -        
2026-02-20T22:09:11.4869778Z +            result["hints"] = []
2026-02-20T22:09:11.4870136Z +
2026-02-20T22:09:11.4870752Z          # Gérer les dates (s'assurer qu'elles existent comme objets datetime)
2026-02-20T22:09:11.4871420Z          now = datetime.now(timezone.utc)
2026-02-20T22:09:11.4871894Z -        if not result.get('created_at'):
2026-02-20T22:09:11.4872357Z -            result['created_at'] = now
2026-02-20T22:09:11.4872826Z -        if not result.get('updated_at'):
2026-02-20T22:09:11.4873516Z -            result['updated_at'] = now
2026-02-20T22:09:11.4873944Z -            
2026-02-20T22:09:11.4874286Z +        if not result.get("created_at"):
2026-02-20T22:09:11.4874760Z +            result["created_at"] = now
2026-02-20T22:09:11.4875223Z +        if not result.get("updated_at"):
2026-02-20T22:09:11.4875693Z +            result["updated_at"] = now
2026-02-20T22:09:11.4876109Z +
2026-02-20T22:09:11.4876380Z          return result
2026-02-20T22:09:11.4876703Z  
2026-02-20T22:09:11.4876974Z      def __repr__(self):
2026-02-20T22:09:11.4877723Z          return f"<LogicChallenge {self.id}: {self.title} (Age: {self.age_group}, Type: {self.challenge_type})>"
2026-02-20T22:09:11.4878542Z  
2026-02-20T22:09:11.4878798Z  
2026-02-20T22:09:11.4879045Z -
2026-02-20T22:09:11.4879347Z  class LogicChallengeAttempt(Base):
2026-02-20T22:09:11.4880104Z      """Modèle pour les tentatives de résolution de défis logiques"""
2026-02-20T22:09:11.4880672Z +
2026-02-20T22:09:11.4881011Z      __tablename__ = "logic_challenge_attempts"
2026-02-20T22:09:11.4881466Z -    
2026-02-20T22:09:11.4881735Z +
2026-02-20T22:09:11.4882212Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.4883173Z      __table_args__ = (
2026-02-20T22:09:11.4883756Z -        Index('ix_logic_attempts_user_challenge', 'user_id', 'challenge_id'),
2026-02-20T22:09:11.4884558Z -        Index('ix_logic_attempts_user_correct', 'user_id', 'is_correct'),
2026-02-20T22:09:11.4885353Z +        Index("ix_logic_attempts_user_challenge", "user_id", "challenge_id"),
2026-02-20T22:09:11.4886404Z +        Index("ix_logic_attempts_user_correct", "user_id", "is_correct"),
2026-02-20T22:09:11.4886999Z      )
2026-02-20T22:09:11.4887259Z  
2026-02-20T22:09:11.4887627Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4888121Z  
2026-02-20T22:09:11.4888465Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.4889199Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.4890061Z      user = relationship("User", back_populates="logic_challenge_attempts")
2026-02-20T22:09:11.4891113Z -    challenge_id = Column(Integer, ForeignKey("logic_challenges.id"), nullable=False, index=True)
2026-02-20T22:09:11.4891931Z +    challenge_id = Column(
2026-02-20T22:09:11.4892519Z +        Integer, ForeignKey("logic_challenges.id"), nullable=False, index=True
2026-02-20T22:09:11.4893365Z +    )
2026-02-20T22:09:11.4893848Z      challenge = relationship("LogicChallenge", back_populates="attempts")
2026-02-20T22:09:11.4894476Z  
2026-02-20T22:09:11.4894877Z      # Données de tentative
2026-02-20T22:09:11.4895314Z      user_solution = Column(Text, nullable=False)
2026-02-20T22:09:11.4896159Z      is_correct = Column(Boolean, nullable=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.4896830Z @@ -178,15 +222,19 @@
2026-02-20T22:09:11.4897139Z  
2026-02-20T22:09:11.4897510Z      # Indices utilisés
2026-02-20T22:09:11.4897914Z      hints_used = Column(Integer, default=0)
2026-02-20T22:09:11.4898349Z  
2026-02-20T22:09:11.4898686Z      # Métadonnées
2026-02-20T22:09:11.4899549Z -    attempt_number = Column(Integer, default=1)  # Numéro de tentative pour ce défi et cet utilisateur
2026-02-20T22:09:11.4900418Z +    attempt_number = Column(
2026-02-20T22:09:11.4900819Z +        Integer, default=1
2026-02-20T22:09:11.4901447Z +    )  # Numéro de tentative pour ce défi et cet utilisateur
2026-02-20T22:09:11.4902134Z      notes = Column(Text, nullable=True)  # Notes de l'utilisateur
2026-02-20T22:09:11.4902710Z  
2026-02-20T22:09:11.4903165Z      # Horodatage
2026-02-20T22:09:11.4903898Z -    created_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.4904777Z +    created_at = Column(
2026-02-20T22:09:11.4905307Z +        DateTime(timezone=True), server_default=func.now(), index=True
2026-02-20T22:09:11.4905915Z +    )  # Tri chronologique
2026-02-20T22:09:11.4906259Z  
2026-02-20T22:09:11.4906537Z      def __repr__(self):
2026-02-20T22:09:11.4907139Z          status = "réussie" if self.is_correct else "échouée"
2026-02-20T22:09:11.4908191Z          return f"<Tentative Logique {self.id}: Utilisateur {self.user_id}, Défi {self.challenge_id}\
2026-02-20T22:09:11.4909011Z              , {status}>"
2026-02-20T22:09:11.5347843Z --- /home/runner/work/mathakine/mathakine/app/models/user.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5349003Z +++ /home/runner/work/mathakine/mathakine/app/models/user.py	2026-02-20 22:09:11.532883+00:00
2026-02-20T22:09:11.5349804Z @@ -1,13 +1,24 @@
2026-02-20T22:09:11.5350102Z  """
2026-02-20T22:09:11.5350637Z  Modèle SQLAlchemy pour les utilisateurs
2026-02-20T22:09:11.5351090Z  """
2026-02-20T22:09:11.5351351Z +
2026-02-20T22:09:11.5351628Z  import json
2026-02-20T22:09:11.5351980Z  from datetime import datetime, timezone
2026-02-20T22:09:11.5352459Z  from enum import Enum as PyEnum
2026-02-20T22:09:11.5352840Z  
2026-02-20T22:09:11.5353647Z -from sqlalchemy import Boolean, Column, Date, DateTime, Enum, Index, Integer, String, Text
2026-02-20T22:09:11.5354463Z +from sqlalchemy import (
2026-02-20T22:09:11.5354837Z +    Boolean,
2026-02-20T22:09:11.5355472Z +    Column,
2026-02-20T22:09:11.5355750Z +    Date,
2026-02-20T22:09:11.5356008Z +    DateTime,
2026-02-20T22:09:11.5356270Z +    Enum,
2026-02-20T22:09:11.5356530Z +    Index,
2026-02-20T22:09:11.5356804Z +    Integer,
2026-02-20T22:09:11.5357092Z +    String,
2026-02-20T22:09:11.5357365Z +    Text,
2026-02-20T22:09:11.5357634Z +)
2026-02-20T22:09:11.5358266Z  from sqlalchemy.dialects.postgresql import JSONB
2026-02-20T22:09:11.5358855Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.5359335Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.5359816Z  from sqlalchemy.sql.expression import text
2026-02-20T22:09:11.5360338Z  from sqlalchemy.types import TypeDecorator
2026-02-20T22:09:11.5360786Z @@ -15,19 +26,20 @@
2026-02-20T22:09:11.5361121Z  from app.db.base import Base
2026-02-20T22:09:11.5361464Z  
2026-02-20T22:09:11.5361699Z  
2026-02-20T22:09:11.5361974Z  class UserRole(PyEnum):
2026-02-20T22:09:11.5362578Z      """Énumération des rôles d'utilisateur"""
2026-02-20T22:09:11.5363322Z -    PADAWAN = "padawan"     # Apprenti, niveau standard
2026-02-20T22:09:11.5364096Z -    MAITRE = "maitre"       # Enseignant, créateur d'exercices
2026-02-20T22:09:11.5364888Z -    GARDIEN = "gardien"     # Modérateur, gestion des utilisateurs
2026-02-20T22:09:11.5365466Z +
2026-02-20T22:09:11.5365848Z +    PADAWAN = "padawan"  # Apprenti, niveau standard
2026-02-20T22:09:11.5366612Z +    MAITRE = "maitre"  # Enseignant, créateur d'exercices
2026-02-20T22:09:11.5367394Z +    GARDIEN = "gardien"  # Modérateur, gestion des utilisateurs
2026-02-20T22:09:11.5368217Z      ARCHIVISTE = "archiviste"  # Administrateur, accès complet
2026-02-20T22:09:11.5368776Z -
2026-02-20T22:09:11.5369034Z  
2026-02-20T22:09:11.5369280Z  
2026-02-20T22:09:11.5369582Z  class JSONEncodedDict(TypeDecorator):
2026-02-20T22:09:11.5370270Z      """Représente un dictionnaire mappé vers une colonne TEXT"""
2026-02-20T22:09:11.5370826Z +
2026-02-20T22:09:11.5371076Z      impl = Text
2026-02-20T22:09:11.5371368Z  
2026-02-20T22:09:11.5371711Z      def process_bind_param(self, value, dialect):
2026-02-20T22:09:11.5372199Z          if value is not None:
2026-02-20T22:09:11.5372570Z              value = json.dumps(value)
2026-02-20T22:09:11.5372954Z @@ -37,30 +49,34 @@
2026-02-20T22:09:11.5403634Z          if value is not None:
2026-02-20T22:09:11.5404055Z              value = json.loads(value)
2026-02-20T22:09:11.5404490Z          return value
2026-02-20T22:09:11.5404805Z  
2026-02-20T22:09:11.5405052Z  
2026-02-20T22:09:11.5405285Z -
2026-02-20T22:09:11.5405546Z  class User(Base):
2026-02-20T22:09:11.5406170Z      """Modèle de données pour les utilisateurs de Mathakine"""
2026-02-20T22:09:11.5406713Z +
2026-02-20T22:09:11.5406986Z      __tablename__ = "users"
2026-02-20T22:09:11.5407355Z      __table_args__ = (
2026-02-20T22:09:11.5407754Z -        Index('idx_users_avatar_url', 'avatar_url'),
2026-02-20T22:09:11.5408291Z -        Index('idx_users_jedi_rank', 'jedi_rank'),
2026-02-20T22:09:11.5408839Z -        Index('idx_users_total_points', 'total_points'),
2026-02-20T22:09:11.5409412Z +        Index("idx_users_avatar_url", "avatar_url"),
2026-02-20T22:09:11.5409943Z +        Index("idx_users_jedi_rank", "jedi_rank"),
2026-02-20T22:09:11.5410470Z +        Index("idx_users_total_points", "total_points"),
2026-02-20T22:09:11.5410960Z      )
2026-02-20T22:09:11.5411211Z  
2026-02-20T22:09:11.5411570Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.5412254Z      username = Column(String(50), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.5413203Z      email = Column(String(100), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.5413917Z      hashed_password = Column(String(255), nullable=False)
2026-02-20T22:09:11.5414487Z      full_name = Column(String(100))
2026-02-20T22:09:11.5415326Z -    role = Column(Enum(UserRole, name="userrole", create_type=False), default=UserRole.PADAWAN)
2026-02-20T22:09:11.5416123Z +    role = Column(
2026-02-20T22:09:11.5416706Z +        Enum(UserRole, name="userrole", create_type=False), default=UserRole.PADAWAN
2026-02-20T22:09:11.5417663Z +    )
2026-02-20T22:09:11.5418021Z      is_active = Column(Boolean, default=True)
2026-02-20T22:09:11.5418694Z      created_at = Column(DateTime(timezone=True), server_default=func.now())
2026-02-20T22:09:11.5419667Z -    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.5420646Z -    
2026-02-20T22:09:11.5420931Z +    updated_at = Column(
2026-02-20T22:09:11.5421505Z +        DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.5422134Z +    )
2026-02-20T22:09:11.5422392Z +
2026-02-20T22:09:11.5422770Z      # Vérification email
2026-02-20T22:09:11.5423499Z      is_email_verified = Column(Boolean, default=False, nullable=False)
2026-02-20T22:09:11.5424333Z      email_verification_token = Column(String(255), nullable=True, index=True)
2026-02-20T22:09:11.5425223Z      email_verification_sent_at = Column(DateTime(timezone=True), nullable=True)
2026-02-20T22:09:11.5425875Z  
2026-02-20T22:09:11.5426127Z @@ -79,33 +95,51 @@
2026-02-20T22:09:11.5426427Z  
2026-02-20T22:09:11.5426866Z      # Colonnes de gamification (système de badges)
2026-02-20T22:09:11.5427737Z      pinned_badge_ids = Column(JSONB, nullable=True)  # A-4: max 3 badge IDs épinglés
2026-02-20T22:09:11.5428793Z      current_streak = Column(Integer, default=0)  # Jours consécutifs avec activité
2026-02-20T22:09:11.5429694Z      best_streak = Column(Integer, default=0)  # Record de série
2026-02-20T22:09:11.5430578Z -    last_activity_date = Column(Date, nullable=True)  # Dernier jour calendaire avec activité
2026-02-20T22:09:11.5431291Z +    last_activity_date = Column(
2026-02-20T22:09:11.5431681Z +        Date, nullable=True
2026-02-20T22:09:11.5432146Z +    )  # Dernier jour calendaire avec activité
2026-02-20T22:09:11.5432660Z      total_points = Column(Integer, default=0)
2026-02-20T22:09:11.5463499Z      current_level = Column(Integer, default=1)
2026-02-20T22:09:11.5464125Z      experience_points = Column(Integer, default=0)
2026-02-20T22:09:11.5464733Z -    jedi_rank = Column(String(50), default='youngling')
2026-02-20T22:09:11.5465338Z +    jedi_rank = Column(String(50), default="youngling")
2026-02-20T22:09:11.5465912Z      avatar_url = Column(String(255), nullable=True)
2026-02-20T22:09:11.5466373Z  
2026-02-20T22:09:11.5466647Z      # Relations
2026-02-20T22:09:11.5467362Z -    created_exercises = relationship("Exercise", back_populates="creator", cascade="all, delete-orphan")
2026-02-20T22:09:11.5468521Z -    attempts = relationship("Attempt", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5469634Z -    progress_records = relationship("Progress", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5470848Z -    recommendations = relationship("Recommendation", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5471809Z +    created_exercises = relationship(
2026-02-20T22:09:11.5472410Z +        "Exercise", back_populates="creator", cascade="all, delete-orphan"
2026-02-20T22:09:11.5473263Z +    )
2026-02-20T22:09:11.5473567Z +    attempts = relationship(
2026-02-20T22:09:11.5474106Z +        "Attempt", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5474668Z +    )
2026-02-20T22:09:11.5474980Z +    progress_records = relationship(
2026-02-20T22:09:11.5475568Z +        "Progress", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5476134Z +    )
2026-02-20T22:09:11.5476433Z +    recommendations = relationship(
2026-02-20T22:09:11.5477043Z +        "Recommendation", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5477662Z +    )
2026-02-20T22:09:11.5477908Z  
2026-02-20T22:09:11.5478337Z      # Relations avec les défis logiques
2026-02-20T22:09:11.5479274Z -    created_logic_challenges = relationship("LogicChallenge", back_populates="creator", cascade="all, delete-orphan")
2026-02-20T22:09:11.5480748Z -    logic_challenge_attempts = relationship("LogicChallengeAttempt", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5482169Z +    created_logic_challenges = relationship(
2026-02-20T22:09:11.5482874Z +        "LogicChallenge", back_populates="creator", cascade="all, delete-orphan"
2026-02-20T22:09:11.5483695Z +    )
2026-02-20T22:09:11.5484028Z +    logic_challenge_attempts = relationship(
2026-02-20T22:09:11.5484963Z +        "LogicChallengeAttempt", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5485637Z +    )
2026-02-20T22:09:11.5485896Z  
2026-02-20T22:09:11.5486298Z      # Relations avec le système de badges
2026-02-20T22:09:11.5487186Z -    user_achievements = relationship("UserAchievement", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5488096Z +    user_achievements = relationship(
2026-02-20T22:09:11.5488722Z +        "UserAchievement", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5489349Z +    )
2026-02-20T22:09:11.5489606Z  
2026-02-20T22:09:11.5489943Z      # Relations avec les sessions et notifications
2026-02-20T22:09:11.5490789Z -    user_sessions = relationship("UserSession", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5491986Z -    notifications = relationship("Notification", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5492800Z -
2026-02-20T22:09:11.5523328Z -
2026-02-20T22:09:11.5523700Z +    user_sessions = relationship(
2026-02-20T22:09:11.5524309Z +        "UserSession", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5524912Z +    )
2026-02-20T22:09:11.5525213Z +    notifications = relationship(
2026-02-20T22:09:11.5525811Z +        "Notification", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5526421Z +    )
2026-02-20T22:09:11.5526686Z  
2026-02-20T22:09:11.5526960Z      def __repr__(self):
2026-02-20T22:09:11.5527399Z          return f"<User {self.username}, Role: {self.role}>"
2026-02-20T22:09:11.5528142Z would reformat /home/runner/work/mathakine/mathakine/app/models/user.py
2026-02-20T22:09:11.5858377Z --- /home/runner/work/mathakine/mathakine/app/schemas/common.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5859577Z +++ /home/runner/work/mathakine/mathakine/app/schemas/common.py	2026-02-20 22:09:11.583442+00:00
2026-02-20T22:09:11.5860371Z @@ -3,104 +3,114 @@
2026-02-20T22:09:11.5860884Z  from typing import Any, Dict, Generic, List, Optional, TypeVar, Union
2026-02-20T22:09:11.5861440Z  
2026-02-20T22:09:11.5861738Z  from pydantic import BaseModel, Field
2026-02-20T22:09:11.5862114Z  
2026-02-20T22:09:11.5862638Z  # Type générique pour les réponses
2026-02-20T22:09:11.5863259Z -T = TypeVar('T')
2026-02-20T22:09:11.5863559Z -
2026-02-20T22:09:11.5863797Z +T = TypeVar("T")
2026-02-20T22:09:11.5864076Z  
2026-02-20T22:09:11.5864293Z  
2026-02-20T22:09:11.5864562Z  class StatusCode(str, Enum):
2026-02-20T22:09:11.5865269Z      """Codes d'état standardisés pour l'API (Codes de Transmission)"""
2026-02-20T22:09:11.5865878Z +
2026-02-20T22:09:11.5866256Z      SUCCESS = "success"  # Succès
2026-02-20T22:09:11.5866638Z -    ERROR = "error"      # Erreur
2026-02-20T22:09:11.5867042Z +    ERROR = "error"  # Erreur
2026-02-20T22:09:11.5867446Z      WARNING = "warning"  # Avertissement
2026-02-20T22:09:11.5867921Z -    INFO = "info"        # Information
2026-02-20T22:09:11.5868342Z -
2026-02-20T22:09:11.5868640Z +    INFO = "info"  # Information
2026-02-20T22:09:11.5869014Z  
2026-02-20T22:09:11.5869279Z  
2026-02-20T22:09:11.5869577Z  class ErrorCode(str, Enum):
2026-02-20T22:09:11.5870253Z      """Codes d'erreur standardisés (Codes de Défaillance)"""
2026-02-20T22:09:11.5871096Z -    NOT_FOUND = "not_found"                 # Ressource non trouvée
2026-02-20T22:09:11.5872050Z -    ALREADY_EXISTS = "already_exists"       # Conflit, ressource déjà existante
2026-02-20T22:09:11.5873326Z -    VALIDATION_ERROR = "validation_error"   # Erreur de validation des données
2026-02-20T22:09:11.5874211Z -    AUTHENTICATION_ERROR = "auth_error"     # Erreur d'authentification
2026-02-20T22:09:11.5875469Z -    PERMISSION_ERROR = "permission_error"   # Erreur de permission
2026-02-20T22:09:11.5876237Z -    SERVER_ERROR = "server_error"           # Erreur serveur interne
2026-02-20T22:09:11.5877163Z -    DATABASE_ERROR = "database_error"       # Erreur de base de données
2026-02-20T22:09:11.5878235Z -    EXTERNAL_API_ERROR = "external_error"   # Erreur d'API externe
2026-02-20T22:09:11.5879150Z -    RATE_LIMIT_ERROR = "rate_limit"         # Limite de taux dépassée
2026-02-20T22:09:11.5879567Z -    INVALID_OPERATION = "invalid_operation" # Opération invalide
2026-02-20T22:09:11.5879684Z  
2026-02-20T22:09:11.5879994Z +    NOT_FOUND = "not_found"  # Ressource non trouvée
2026-02-20T22:09:11.5880449Z +    ALREADY_EXISTS = "already_exists"  # Conflit, ressource déjà existante
2026-02-20T22:09:11.5880938Z +    VALIDATION_ERROR = "validation_error"  # Erreur de validation des données
2026-02-20T22:09:11.5881243Z +    AUTHENTICATION_ERROR = "auth_error"  # Erreur d'authentification
2026-02-20T22:09:11.5881554Z +    PERMISSION_ERROR = "permission_error"  # Erreur de permission
2026-02-20T22:09:11.5881808Z +    SERVER_ERROR = "server_error"  # Erreur serveur interne
2026-02-20T22:09:11.5882223Z +    DATABASE_ERROR = "database_error"  # Erreur de base de données
2026-02-20T22:09:11.5882520Z +    EXTERNAL_API_ERROR = "external_error"  # Erreur d'API externe
2026-02-20T22:09:11.5882913Z +    RATE_LIMIT_ERROR = "rate_limit"  # Limite de taux dépassée
2026-02-20T22:09:11.5891802Z +    INVALID_OPERATION = "invalid_operation"  # Opération invalide
2026-02-20T22:09:11.5891947Z  
2026-02-20T22:09:11.5892066Z  
2026-02-20T22:09:11.5892224Z  class PageInfo(BaseModel):
2026-02-20T22:09:11.5892625Z      """Information de pagination (Coordonnées de Navigation)"""
2026-02-20T22:09:11.5892746Z +
2026-02-20T22:09:11.5893376Z      page: int = Field(..., ge=1, description="Page actuelle")
2026-02-20T22:09:11.5893927Z      page_size: int = Field(..., ge=1, description="Nombre d'éléments par page")
2026-02-20T22:09:11.5894293Z      total_pages: int = Field(..., ge=0, description="Nombre total de pages")
2026-02-20T22:09:11.5894782Z      total_items: int = Field(..., ge=0, description="Nombre total d'éléments")
2026-02-20T22:09:11.5895100Z      has_next: bool = Field(..., description="S'il existe une page suivante")
2026-02-20T22:09:11.5895566Z      has_prev: bool = Field(..., description="S'il existe une page précédente")
2026-02-20T22:09:11.5895689Z  
2026-02-20T22:09:11.5895796Z  
2026-02-20T22:09:11.5895901Z -
2026-02-20T22:09:11.5896061Z  class ResponseMeta(BaseModel):
2026-02-20T22:09:11.5896433Z      """Métadonnées de réponse (Données de Transmission)"""
2026-02-20T22:09:11.5896545Z +
2026-02-20T22:09:11.5896676Z      code: StatusCode
2026-02-20T22:09:11.5897237Z -    message: str = Field(..., description="Message décrivant le résultat de l'opération")
2026-02-20T22:09:11.5897687Z -    error_code: Optional[ErrorCode] = Field(None, description="Code d'erreur si applicable")
2026-02-20T22:09:11.5898224Z -    pagination: Optional[PageInfo] = Field(None, description="Information de pagination si applicable")
2026-02-20T22:09:11.5899025Z -    debug_info: Optional[Dict[str, Any]] = Field(None, description="Informations de débogage (en mode debug uniquement)")
2026-02-20T22:09:11.5899144Z -
2026-02-20T22:09:11.5899304Z +    message: str = Field(
2026-02-20T22:09:11.5899720Z +        ..., description="Message décrivant le résultat de l'opération"
2026-02-20T22:09:11.5899843Z +    )
2026-02-20T22:09:11.5900019Z +    error_code: Optional[ErrorCode] = Field(
2026-02-20T22:09:11.5900234Z +        None, description="Code d'erreur si applicable"
2026-02-20T22:09:11.5900356Z +    )
2026-02-20T22:09:11.5900537Z +    pagination: Optional[PageInfo] = Field(
2026-02-20T22:09:11.5900819Z +        None, description="Information de pagination si applicable"
2026-02-20T22:09:11.5900939Z +    )
2026-02-20T22:09:11.5901133Z +    debug_info: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.5901956Z +        None, description="Informations de débogage (en mode debug uniquement)"
2026-02-20T22:09:11.5902079Z +    )
2026-02-20T22:09:11.5902202Z  
2026-02-20T22:09:11.5902318Z  
2026-02-20T22:09:11.5902494Z  class Response(BaseModel, Generic[T]):
2026-02-20T22:09:11.5902854Z      """Réponse API standard (Transmission Galactique)"""
2026-02-20T22:09:11.5903492Z +
2026-02-20T22:09:11.5903644Z      meta: ResponseMeta
2026-02-20T22:09:11.5905645Z      data: Optional[T] = Field(None, description="Données de la réponse")
2026-02-20T22:09:11.5905900Z  
2026-02-20T22:09:11.5906014Z  
2026-02-20T22:09:11.5907248Z -
2026-02-20T22:09:11.5933347Z  class ListResponse(Response[List[T]], Generic[T]):
2026-02-20T22:09:11.5933872Z      """Réponse API pour listes paginées (Liste de Transmission)"""
2026-02-20T22:09:11.5933998Z +
2026-02-20T22:09:11.5934392Z      data: List[T] = Field(..., description="Liste des éléments")
2026-02-20T22:09:11.5934518Z -
2026-02-20T22:09:11.5934632Z  
2026-02-20T22:09:11.5934764Z  
2026-02-20T22:09:11.5934932Z  class ValidationError(BaseModel):
2026-02-20T22:09:11.5935322Z      """Détails d'une erreur de validation (Rapport d'Anomalie)"""
2026-02-20T22:09:11.5935432Z +
2026-02-20T22:09:11.5935871Z      field: str = Field(..., description="Champ concerné par l'erreur")
2026-02-20T22:09:11.5936142Z      message: str = Field(..., description="Message d'erreur")
2026-02-20T22:09:11.5936640Z      code: Optional[str] = Field(None, description="Code d'erreur spécifique")
2026-02-20T22:09:11.5936759Z  
2026-02-20T22:09:11.5936872Z  
2026-02-20T22:09:11.5936976Z -
2026-02-20T22:09:11.5937140Z  class ErrorResponse(BaseModel):
2026-02-20T22:09:11.5937525Z      """Réponse d'erreur détaillée (Rapport de Défaillance)"""
2026-02-20T22:09:11.5937646Z +
2026-02-20T22:09:11.5937788Z      meta: ResponseMeta
2026-02-20T22:09:11.5938548Z -    errors: Optional[List[ValidationError]] = Field(None, description="Liste détaillée des erreurs de validation")
2026-02-20T22:09:11.5938672Z -
2026-02-20T22:09:11.5938909Z +    errors: Optional[List[ValidationError]] = Field(
2026-02-20T22:09:11.5939329Z +        None, description="Liste détaillée des erreurs de validation"
2026-02-20T22:09:11.5939454Z +    )
2026-02-20T22:09:11.5939564Z  
2026-02-20T22:09:11.5939672Z  
2026-02-20T22:09:11.5939825Z  class HealthCheck(BaseModel):
2026-02-20T22:09:11.5940148Z      """État de santé de l'API (État des Systèmes)"""
2026-02-20T22:09:11.5940274Z +
2026-02-20T22:09:11.5940656Z      status: str = Field(..., description="État général du service")
2026-02-20T22:09:11.5940920Z      version: str = Field(..., description="Version de l'API")
2026-02-20T22:09:11.5941274Z      uptime: float = Field(..., description="Temps de fonctionnement en secondes")
2026-02-20T22:09:11.5941763Z      database_status: str = Field(..., description="État de la base de données")
2026-02-20T22:09:11.5942220Z      environment: str = Field(..., description="Environnement d'exécution")
2026-02-20T22:09:11.5942783Z -    dependencies: Dict[str, str] = Field(..., description="État des dépendances externes")
2026-02-20T22:09:11.5942922Z -
2026-02-20T22:09:11.5943316Z +    dependencies: Dict[str, str] = Field(
2026-02-20T22:09:11.5943656Z +        ..., description="État des dépendances externes"
2026-02-20T22:09:11.5943765Z +    )
2026-02-20T22:09:11.5943866Z  
2026-02-20T22:09:11.5943967Z  
2026-02-20T22:09:11.5944131Z  class PaginationParams:
2026-02-20T22:09:11.5944240Z      """
2026-02-20T22:09:11.5944627Z      Paramètres de pagination standards pour les requêtes API.
2026-02-20T22:09:11.5945050Z      Peut être utilisé comme dépendance FastAPI pour les endpoints.
2026-02-20T22:09:11.5945167Z      """
2026-02-20T22:09:11.5945280Z -
2026-02-20T22:09:11.5945395Z  
2026-02-20T22:09:11.5945518Z      def __init__(
2026-02-20T22:09:11.5945633Z          self,
2026-02-20T22:09:11.5945759Z          skip: int = 0,
2026-02-20T22:09:11.5945893Z          limit: int = 100,
2026-02-20T22:09:11.5946291Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/common.py
2026-02-20T22:09:11.5983412Z --- /home/runner/work/mathakine/mathakine/app/schemas/attempt.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5983917Z +++ /home/runner/work/mathakine/mathakine/app/schemas/attempt.py	2026-02-20 22:09:11.596180+00:00
2026-02-20T22:09:11.5984048Z @@ -4,112 +4,114 @@
2026-02-20T22:09:11.5984363Z  from pydantic import BaseModel, ConfigDict, Field, field_validator
2026-02-20T22:09:11.5984756Z  
2026-02-20T22:09:11.5985163Z  # Schémas pour la manipulation des tentatives d'exercices
2026-02-20T22:09:11.5985278Z  
2026-02-20T22:09:11.5985391Z  
2026-02-20T22:09:11.5985488Z -
2026-02-20T22:09:11.5985637Z  class AttemptBase(BaseModel):
2026-02-20T22:09:11.5986075Z      """Schéma de base pour les tentatives (Tentatives d'Accomplissement)"""
2026-02-20T22:09:11.5986198Z +
2026-02-20T22:09:11.5986598Z      exercise_id: int = Field(..., description="ID de l'exercice tenté")
2026-02-20T22:09:11.5987057Z      user_answer: str = Field(..., description="Réponse fournie par l'utilisateur")
2026-02-20T22:09:11.5987291Z -    time_spent: Optional[float] = Field(None, ge=0.0,
2026-02-20T22:09:11.5987632Z -                                     description="Temps passé en secondes")
2026-02-20T22:09:11.5987816Z -    hints_used: Optional[int] = Field(0, ge=0,
2026-02-20T22:09:11.5988168Z -                                   description="Nombre d'indices utilisés")
2026-02-20T22:09:11.5988345Z -    device_info: Optional[str] = Field(None,
2026-02-20T22:09:11.5988712Z -                                    description="Information sur l'appareil utilisé")
2026-02-20T22:09:11.5988866Z +    time_spent: Optional[float] = Field(
2026-02-20T22:09:11.5989204Z +        None, ge=0.0, description="Temps passé en secondes"
2026-02-20T22:09:11.5989317Z +    )
2026-02-20T22:09:11.5989840Z +    hints_used: Optional[int] = Field(0, ge=0, description="Nombre d'indices utilisés")
2026-02-20T22:09:11.5990008Z +    device_info: Optional[str] = Field(
2026-02-20T22:09:11.5990348Z +        None, description="Information sur l'appareil utilisé"
2026-02-20T22:09:11.5990475Z +    )
2026-02-20T22:09:11.5990593Z  
2026-02-20T22:09:11.5990747Z -    @field_validator('user_answer')
2026-02-20T22:09:11.5990893Z +    @field_validator("user_answer")
2026-02-20T22:09:11.5991005Z      @classmethod
2026-02-20T22:09:11.5991121Z -
2026-02-20T22:09:11.5991228Z -
2026-02-20T22:09:11.5991377Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.5991540Z          if not v or v.isspace():
2026-02-20T22:09:11.5991928Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.5992051Z          return v
2026-02-20T22:09:11.5992164Z  
2026-02-20T22:09:11.5992267Z  
2026-02-20T22:09:11.5992373Z -
2026-02-20T22:09:11.5992525Z  class AttemptCreate(AttemptBase):
2026-02-20T22:09:11.5993213Z      """Schéma pour la création d'une tentative (Enregistrement d'une Tentative)"""
2026-02-20T22:09:11.5993328Z +
2026-02-20T22:09:11.5993441Z      pass
2026-02-20T22:09:11.5993548Z -
2026-02-20T22:09:11.5993645Z  
2026-02-20T22:09:11.5993743Z  
2026-02-20T22:09:11.5994178Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/attempt.py
2026-02-20T22:09:11.5994344Z  class AttemptUpdate(BaseModel):
2026-02-20T22:09:11.5994711Z      """Schéma pour la mise à jour d'une tentative (rare)"""
2026-02-20T22:09:11.5994832Z +
2026-02-20T22:09:11.5994996Z      is_correct: Optional[bool] = None
2026-02-20T22:09:11.5995226Z      time_spent: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.5995423Z      hints_used: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.5995539Z  
2026-02-20T22:09:11.5995690Z -    @field_validator('time_spent')
2026-02-20T22:09:11.5995832Z +    @field_validator("time_spent")
2026-02-20T22:09:11.5995954Z      @classmethod
2026-02-20T22:09:11.5996061Z -
2026-02-20T22:09:11.5996163Z -
2026-02-20T22:09:11.5996323Z      def time_spent_positive(cls, v):
2026-02-20T22:09:11.5996471Z          if v is not None and v < 0:
2026-02-20T22:09:11.5996892Z              raise ValueError("Le temps passé ne peut pas être négatif")
2026-02-20T22:09:11.5997259Z          return v
2026-02-20T22:09:11.5997369Z  
2026-02-20T22:09:11.5997466Z  
2026-02-20T22:09:11.5997562Z -
2026-02-20T22:09:11.5997718Z  class AttemptInDB(AttemptBase):
2026-02-20T22:09:11.5998222Z      """Schéma pour une tentative en base de données (Archives des Tentatives)"""
2026-02-20T22:09:11.5998334Z +
2026-02-20T22:09:11.5998682Z      id: int
2026-02-20T22:09:11.5998811Z      user_id: int
2026-02-20T22:09:11.5998944Z      is_correct: bool
2026-02-20T22:09:11.5999081Z      attempt_number: int
2026-02-20T22:09:11.5999220Z      created_at: datetime
2026-02-20T22:09:11.5999334Z  
2026-02-20T22:09:11.5999544Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.5999653Z  
2026-02-20T22:09:11.5999768Z  
2026-02-20T22:09:11.5999871Z -
2026-02-20T22:09:11.6000019Z  class Attempt(AttemptInDB):
2026-02-20T22:09:11.6000409Z      """Schéma pour une tentative complète (Journal de Bord)"""
2026-02-20T22:09:11.6000524Z +
2026-02-20T22:09:11.6000685Z      exercise_title: Optional[str] = None
2026-02-20T22:09:11.6000857Z      exercise_type: Optional[str] = None
2026-02-20T22:09:11.6001047Z      exercise_difficulty: Optional[str] = None
2026-02-20T22:09:11.6001155Z  
2026-02-20T22:09:11.6001361Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6001468Z  
2026-02-20T22:09:11.6001577Z  
2026-02-20T22:09:11.6001693Z -
2026-02-20T22:09:11.6001842Z  class AttemptBatch(BaseModel):
2026-02-20T22:09:11.6002283Z      """Schéma pour l'envoi de plusieurs tentatives (Rapport de Mission)"""
2026-02-20T22:09:11.6002469Z -    attempts: list[AttemptCreate] = Field(...,
2026-02-20T22:09:11.6002885Z -                                       description="Liste des tentatives à enregistrer")
2026-02-20T22:09:11.6003195Z  
2026-02-20T22:09:11.6003352Z -    @field_validator('attempts')
2026-02-20T22:09:11.6003516Z +    attempts: list[AttemptCreate] = Field(
2026-02-20T22:09:11.6003861Z +        ..., description="Liste des tentatives à enregistrer"
2026-02-20T22:09:11.6003987Z +    )
2026-02-20T22:09:11.6004092Z +
2026-02-20T22:09:11.6004233Z +    @field_validator("attempts")
2026-02-20T22:09:11.6004354Z      @classmethod
2026-02-20T22:09:11.6004453Z -
2026-02-20T22:09:11.6004555Z -
2026-02-20T22:09:11.6004694Z      def validate_batch(cls, v):
2026-02-20T22:09:11.6004814Z          if not v:
2026-02-20T22:09:11.6005238Z              raise ValueError("Le lot de tentatives ne peut pas être vide")
2026-02-20T22:09:11.6005361Z          if len(v) > 50:
2026-02-20T22:09:11.6005586Z              raise ValueError("Maximum 50 tentatives par lot")
2026-02-20T22:09:11.6005698Z          return v
2026-02-20T22:09:11.6005802Z  
2026-02-20T22:09:11.6005904Z  
2026-02-20T22:09:11.6006011Z -
2026-02-20T22:09:11.6006157Z  class AttemptStats(BaseModel):
2026-02-20T22:09:11.6006585Z      """Statistiques sur les tentatives d'un utilisateur (Analyse de Performance)"""
2026-02-20T22:09:11.6006698Z +
2026-02-20T22:09:11.6006831Z      total_attempts: int
2026-02-20T22:09:11.6006965Z      correct_attempts: int
2026-02-20T22:09:11.6007104Z      success_rate: float
2026-02-20T22:09:11.6007269Z      average_time: Optional[float] = None
2026-02-20T22:09:11.6007424Z      fastest_time: Optional[float] = None
2026-02-20T22:09:11.6007573Z      slowest_time: Optional[float] = None
2026-02-20T22:09:11.6007725Z      streak: Optional[int] = None
2026-02-20T22:09:11.6007839Z  
2026-02-20T22:09:11.6008041Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6008150Z  
2026-02-20T22:09:11.6008248Z +
2026-02-20T22:09:11.6008401Z  class AttemptResponse(BaseModel):
2026-02-20T22:09:11.6008761Z      """Schéma pour la réponse à une tentative d'exercice"""
2026-02-20T22:09:11.6008874Z +
2026-02-20T22:09:11.6009290Z      is_correct: bool = Field(..., description="Si la réponse est correcte")
2026-02-20T22:09:11.6009891Z -    correct_answer: Optional[str] = Field(None, description="La réponse correcte (si incorrecte)")
2026-02-20T22:09:11.6010064Z +    correct_answer: Optional[str] = Field(
2026-02-20T22:09:11.6010658Z +        None, description="La réponse correcte (si incorrecte)"
2026-02-20T22:09:11.6010769Z +    )
2026-02-20T22:09:11.6011050Z      feedback: str = Field(..., description="Retour sur la tentative")
2026-02-20T22:09:11.6011562Z      time_spent: Optional[float] = Field(None, description="Temps passé en secondes")
2026-02-20T22:09:11.6012400Z -    mastery_progress: Optional[int] = Field(None, description="Progression dans la maîtrise du sujet")
2026-02-20T22:09:11.6012508Z -    
2026-02-20T22:09:11.6012689Z +    mastery_progress: Optional[int] = Field(
2026-02-20T22:09:11.6013248Z +        None, description="Progression dans la maîtrise du sujet"
2026-02-20T22:09:11.6013369Z +    )
2026-02-20T22:09:11.6013482Z +
2026-02-20T22:09:11.6013691Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6589716Z --- /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.6590624Z +++ /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py	2026-02-20 22:09:11.657896+00:00
2026-02-20T22:09:11.6591025Z @@ -4,42 +4,55 @@
2026-02-20T22:09:11.6591284Z  from pydantic import BaseModel, ConfigDict, Field
2026-02-20T22:09:11.6591403Z  
2026-02-20T22:09:11.6591523Z  
2026-02-20T22:09:11.6591698Z  class RecommendationBase(BaseModel):
2026-02-20T22:09:11.6592231Z      """Schéma de base pour les recommandations d'exercices"""
2026-02-20T22:09:11.6592373Z +
2026-02-20T22:09:11.6592861Z      exercise_type: str = Field(..., description="Type d'exercice recommandé")
2026-02-20T22:09:11.6593593Z      difficulty: str = Field(..., description="Niveau de difficulté recommandé")
2026-02-20T22:09:11.6594210Z -    priority: int = Field(5, ge=1, le=10, description="Priorité de la recommandation (1-10)")
2026-02-20T22:09:11.6594437Z +    priority: int = Field(
2026-02-20T22:09:11.6594921Z +        5, ge=1, le=10, description="Priorité de la recommandation (1-10)"
2026-02-20T22:09:11.6595038Z +    )
2026-02-20T22:09:11.6595421Z      reason: Optional[str] = Field(None, description="Raison de la recommandation")
2026-02-20T22:09:11.6595562Z +
2026-02-20T22:09:11.6595672Z  
2026-02-20T22:09:11.6595897Z  class RecommendationCreate(RecommendationBase):
2026-02-20T22:09:11.6596221Z      """Schéma pour la création de recommandations"""
2026-02-20T22:09:11.6596337Z +
2026-02-20T22:09:11.6596565Z      user_id: int = Field(..., description="ID de l'utilisateur")
2026-02-20T22:09:11.6597157Z -    exercise_id: Optional[int] = Field(None, description="ID de l'exercice recommandé (optionnel)")
2026-02-20T22:09:11.6597276Z -    
2026-02-20T22:09:11.6597438Z +    exercise_id: Optional[int] = Field(
2026-02-20T22:09:11.6597853Z +        None, description="ID de l'exercice recommandé (optionnel)"
2026-02-20T22:09:11.6597970Z +    )
2026-02-20T22:09:11.6598079Z +
2026-02-20T22:09:11.6598186Z +
2026-02-20T22:09:11.6598368Z  class RecommendationUpdate(BaseModel):
2026-02-20T22:09:11.6598705Z      """Schéma pour la mise à jour de recommandations"""
2026-02-20T22:09:11.6598835Z +
2026-02-20T22:09:11.6599374Z      is_completed: Optional[bool] = Field(None, description="Marqué comme complété")
2026-02-20T22:09:11.6599740Z      shown_count: Optional[int] = Field(None, description="Nombre d'affichages")
2026-02-20T22:09:11.6600081Z      clicked_count: Optional[int] = Field(None, description="Nombre de clics")
2026-02-20T22:09:11.6600216Z  
2026-02-20T22:09:11.6600314Z +
2026-02-20T22:09:11.6600507Z  class RecommendationInDB(RecommendationBase):
2026-02-20T22:09:11.6600924Z      """Schéma pour les recommandations stockées en base de données"""
2026-02-20T22:09:11.6601047Z +
2026-02-20T22:09:11.6601259Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6601376Z -    
2026-02-20T22:09:11.6601494Z +
2026-02-20T22:09:11.6601608Z      id: int
2026-02-20T22:09:11.6602068Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py
2026-02-20T22:09:11.6602201Z      user_id: int
2026-02-20T22:09:11.6602363Z      exercise_id: Optional[int] = None
2026-02-20T22:09:11.6602912Z      is_completed: bool
2026-02-20T22:09:11.6603246Z      shown_count: int
2026-02-20T22:09:11.6603390Z      clicked_count: int
2026-02-20T22:09:11.6603525Z      created_at: datetime
2026-02-20T22:09:11.6603654Z      updated_at: datetime
2026-02-20T22:09:11.6603769Z  
2026-02-20T22:09:11.6603874Z +
2026-02-20T22:09:11.6604369Z  class RecommendationResponse(RecommendationBase):
2026-02-20T22:09:11.6604763Z      """Schéma pour la réponse API de recommandations"""
2026-02-20T22:09:11.6604891Z +
2026-02-20T22:09:11.6605109Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6605221Z -    
2026-02-20T22:09:11.6605338Z +
2026-02-20T22:09:11.6605451Z      id: int
2026-02-20T22:09:11.6605610Z      exercise_id: Optional[int] = None
2026-02-20T22:09:11.6605773Z      exercise_title: Optional[str] = None
2026-02-20T22:09:11.6605965Z -    exercise_question: Optional[str] = None 
2026-02-20T22:09:11.6606112Z \ No newline at end of file
2026-02-20T22:09:11.6606289Z +    exercise_question: Optional[str] = None
2026-02-20T22:09:11.7708698Z --- /home/runner/work/mathakine/mathakine/app/schemas/exercise.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.7716918Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/exercise.py
2026-02-20T22:09:11.7734054Z +++ /home/runner/work/mathakine/mathakine/app/schemas/exercise.py	2026-02-20 22:09:11.768236+00:00
2026-02-20T22:09:11.7735235Z @@ -5,114 +5,134 @@
2026-02-20T22:09:11.7735805Z  
2026-02-20T22:09:11.7736298Z  from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:11.7736856Z  
2026-02-20T22:09:11.7737480Z  # Schémas pour la manipulation des exercices
2026-02-20T22:09:11.7737927Z  
2026-02-20T22:09:11.7738172Z +
2026-02-20T22:09:11.7738443Z  class ExerciseBase(BaseModel):
2026-02-20T22:09:11.7739060Z      """Schéma de base pour les exercices (Épreuves Jedi)"""
2026-02-20T22:09:11.7739677Z -    title: str = Field(..., min_length=3, max_length=100,
2026-02-20T22:09:11.7740433Z -                    description="Titre de l'exercice (3-100 caractères)")
2026-02-20T22:09:11.7741114Z -    exercise_type: Union[str, ExerciseType] = Field(...,
2026-02-20T22:09:11.7741853Z -                                     description="Type d'exercice mathématique")
2026-02-20T22:09:11.7742501Z -    difficulty: Union[str, DifficultyLevel] = Field(...,
2026-02-20T22:09:11.7743447Z -                                     description="Niveau de difficulté")
2026-02-20T22:09:11.7744008Z -    question: str = Field(..., min_length=5,
2026-02-20T22:09:11.7744757Z -                       description="Question de l'exercice (min 5 caractères)")
2026-02-20T22:09:11.7745357Z -    correct_answer: str = Field(...,
2026-02-20T22:09:11.7745991Z -                             description="Réponse correcte à la question")
2026-02-20T22:09:11.7746571Z -    choices: Optional[List[str]] = Field(None,
2026-02-20T22:09:11.7747375Z -                                     description="Options pour les questions à choix multiples")
2026-02-20T22:09:11.7748066Z -    explanation: Optional[str] = Field(None,
2026-02-20T22:09:11.7748687Z -                                    description="Explication de la solution")
2026-02-20T22:09:11.7749235Z -    hint: Optional[str] = Field(None,
2026-02-20T22:09:11.7749849Z -                             description="Indice pour aider l'élève")
2026-02-20T22:09:11.7750391Z -    tags: Optional[str] = Field(None,
2026-02-20T22:09:11.7751011Z -                             description="Tags séparés par des virgules")
2026-02-20T22:09:11.7751518Z -
2026-02-20T22:09:11.7751807Z -    @field_validator('exercise_type')
2026-02-20T22:09:11.7752206Z +
2026-02-20T22:09:11.7752459Z +    title: str = Field(
2026-02-20T22:09:11.7752789Z +        ...,
2026-02-20T22:09:11.7753214Z +        min_length=3,
2026-02-20T22:09:11.7753546Z +        max_length=100,
2026-02-20T22:09:11.7754111Z +        description="Titre de l'exercice (3-100 caractères)",
2026-02-20T22:09:11.7754613Z +    )
2026-02-20T22:09:11.7754965Z +    exercise_type: Union[str, ExerciseType] = Field(
2026-02-20T22:09:11.7756048Z +        ..., description="Type d'exercice mathématique"
2026-02-20T22:09:11.7756518Z +    )
2026-02-20T22:09:11.7756867Z +    difficulty: Union[str, DifficultyLevel] = Field(
2026-02-20T22:09:11.7757484Z +        ..., description="Niveau de difficulté"
2026-02-20T22:09:11.7757911Z +    )
2026-02-20T22:09:11.7758402Z +    question: str = Field(
2026-02-20T22:09:11.7759089Z +        ..., min_length=5, description="Question de l'exercice (min 5 caractères)"
2026-02-20T22:09:11.7759701Z +    )
2026-02-20T22:09:11.7760318Z +    correct_answer: str = Field(..., description="Réponse correcte à la question")
2026-02-20T22:09:11.7760989Z +    choices: Optional[List[str]] = Field(
2026-02-20T22:09:11.7761702Z +        None, description="Options pour les questions à choix multiples"
2026-02-20T22:09:11.7762271Z +    )
2026-02-20T22:09:11.7762795Z +    explanation: Optional[str] = Field(None, description="Explication de la solution")
2026-02-20T22:09:11.7763994Z +    hint: Optional[str] = Field(None, description="Indice pour aider l'élève")
2026-02-20T22:09:11.7764990Z +    tags: Optional[str] = Field(None, description="Tags séparés par des virgules")
2026-02-20T22:09:11.7765617Z +
2026-02-20T22:09:11.7765895Z +    @field_validator("exercise_type")
2026-02-20T22:09:11.7766309Z      @classmethod
2026-02-20T22:09:11.7766657Z      def validate_exercise_type(cls, v):
2026-02-20T22:09:11.7767314Z          # Si c'est déjà un objet ExerciseType, retourner sa valeur
2026-02-20T22:09:11.7767878Z          if isinstance(v, ExerciseType):
2026-02-20T22:09:11.7768306Z              return v.value
2026-02-20T22:09:11.7768640Z  
2026-02-20T22:09:11.7769183Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7769783Z          if isinstance(v, str):
2026-02-20T22:09:11.7770333Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7770949Z              v_upper = v.upper()
2026-02-20T22:09:11.7771574Z -            valid_types = [t.value for t in ExerciseType]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7772261Z +            valid_types = [
2026-02-20T22:09:11.7772649Z +                t.value for t in ExerciseType
2026-02-20T22:09:11.7773400Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7774158Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7774791Z              if v_upper in valid_types:
2026-02-20T22:09:11.7775206Z                  return v_upper
2026-02-20T22:09:11.7775550Z              else:
2026-02-20T22:09:11.7776263Z -                raise ValueError(f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}")
2026-02-20T22:09:11.7791809Z -
2026-02-20T22:09:11.7792271Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7792780Z -
2026-02-20T22:09:11.7810057Z -    @field_validator('difficulty')
2026-02-20T22:09:11.7810564Z +                raise ValueError(
2026-02-20T22:09:11.7811294Z +                    f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}"
2026-02-20T22:09:11.7812029Z +                )
2026-02-20T22:09:11.7812326Z +
2026-02-20T22:09:11.7812689Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7813500Z +
2026-02-20T22:09:11.7813816Z +    @field_validator("difficulty")
2026-02-20T22:09:11.7814214Z      @classmethod
2026-02-20T22:09:11.7814554Z      def validate_difficulty(cls, v):
2026-02-20T22:09:11.7815307Z          # Si c'est déjà un objet DifficultyLevel, retourner sa valeur
2026-02-20T22:09:11.7815912Z          if isinstance(v, DifficultyLevel):
2026-02-20T22:09:11.7816359Z              return v.value
2026-02-20T22:09:11.7816689Z  
2026-02-20T22:09:11.7817251Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7817857Z          if isinstance(v, str):
2026-02-20T22:09:11.7818422Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7819331Z              v_upper = v.upper()
2026-02-20T22:09:11.7820031Z -            valid_difficulties = [d.value for d in DifficultyLevel]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7820801Z +            valid_difficulties = [
2026-02-20T22:09:11.7821245Z +                d.value for d in DifficultyLevel
2026-02-20T22:09:11.7821938Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7822701Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7823544Z              if v_upper in valid_difficulties:
2026-02-20T22:09:11.7823986Z                  return v_upper
2026-02-20T22:09:11.7824346Z              else:
2026-02-20T22:09:11.7825283Z -                raise ValueError(f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}")
2026-02-20T22:09:11.7826148Z -
2026-02-20T22:09:11.7826509Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7826995Z -
2026-02-20T22:09:11.7827288Z -    @field_validator('correct_answer')
2026-02-20T22:09:11.7827716Z +                raise ValueError(
2026-02-20T22:09:11.7828585Z +                    f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}"
2026-02-20T22:09:11.7829316Z +                )
2026-02-20T22:09:11.7829617Z +
2026-02-20T22:09:11.7829963Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7830422Z +
2026-02-20T22:09:11.7830704Z +    @field_validator("correct_answer")
2026-02-20T22:09:11.7831108Z      @classmethod
2026-02-20T22:09:11.7831446Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.7831848Z          if not v or v.isspace():
2026-02-20T22:09:11.7832517Z              raise ValueError("La réponse correcte ne peut pas être vide")
2026-02-20T22:09:11.7833235Z          return v
2026-02-20T22:09:11.7833523Z  
2026-02-20T22:09:11.7833796Z -    @field_validator('choices')
2026-02-20T22:09:11.7834214Z +    @field_validator("choices")
2026-02-20T22:09:11.7834591Z      @classmethod
2026-02-20T22:09:11.7834919Z      def validate_choices(cls, v, info):
2026-02-20T22:09:11.7835350Z          if v is not None:
2026-02-20T22:09:11.7835846Z              # Vérifier qu'il y a au moins 2 choix
2026-02-20T22:09:11.7836298Z              if len(v) < 2:
2026-02-20T22:09:11.7836837Z                  raise ValueError("Il doit y avoir au moins 2 choix pour un QCM")
2026-02-20T22:09:11.7837430Z  
2026-02-20T22:09:11.7837897Z              # Vérifier que la réponse correcte est dans les choix
2026-02-20T22:09:11.7838426Z              values = info.data
2026-02-20T22:09:11.7838981Z -            if 'correct_answer' in values and values['correct_answer'] not in v:
2026-02-20T22:09:11.7839946Z -                raise ValueError("La réponse correcte doit être présente dans les choix")
2026-02-20T22:09:11.7840791Z +            if "correct_answer" in values and values["correct_answer"] not in v:
2026-02-20T22:09:11.7841396Z +                raise ValueError(
2026-02-20T22:09:11.7842035Z +                    "La réponse correcte doit être présente dans les choix"
2026-02-20T22:09:11.7842563Z +                )
2026-02-20T22:09:11.7842842Z  
2026-02-20T22:09:11.7843379Z              # Vérifier que les choix sont uniques
2026-02-20T22:09:11.7843843Z              if len(v) != len(set(v)):
2026-02-20T22:09:11.7844473Z                  raise ValueError("Les choix doivent être uniques")
2026-02-20T22:09:11.7844968Z  
2026-02-20T22:09:11.7845219Z          return v
2026-02-20T22:09:11.7845488Z  
2026-02-20T22:09:11.7845754Z -    @field_validator('question')
2026-02-20T22:09:11.7846150Z +    @field_validator("question")
2026-02-20T22:09:11.7846527Z      @classmethod
2026-02-20T22:09:11.7846839Z      def validate_question(cls, v):
2026-02-20T22:09:11.7847844Z          # Vérifier que la question contient un point d'interrogation, deux points, point d'exclamation ou point final
2026-02-20T22:09:11.7848800Z -        if not any(mark in v for mark in ['?', ':', '!', '.']):
2026-02-20T22:09:11.7849795Z -            raise ValueError("La question doit contenir une ponctuation finale (?, :, !, .)")
2026-02-20T22:09:11.7850492Z -        return v
2026-02-20T22:09:11.7850875Z +        if not any(mark in v for mark in ["?", ":", "!", "."]):
2026-02-20T22:09:11.7851384Z +            raise ValueError(
2026-02-20T22:09:11.7852092Z +                "La question doit contenir une ponctuation finale (?, :, !, .)"
2026-02-20T22:09:11.7852667Z +            )
2026-02-20T22:09:11.7852945Z +        return v
2026-02-20T22:09:11.7853366Z +
2026-02-20T22:09:11.7853608Z  
2026-02-20T22:09:11.7853887Z  class ExerciseCreate(ExerciseBase):
2026-02-20T22:09:11.7854601Z      """Schéma pour la création d'un exercice (Création d'une Épreuve)"""
2026-02-20T22:09:11.7855214Z -    image_url: Optional[str] = Field(None,
2026-02-20T22:09:11.7855854Z -                                  description="URL de l'image associée")
2026-02-20T22:09:11.7856378Z -    audio_url: Optional[str] = Field(None,
2026-02-20T22:09:11.7857087Z -                                  description="URL audio pour accessibilité")
2026-02-20T22:09:11.7857644Z +
2026-02-20T22:09:11.7858307Z +    image_url: Optional[str] = Field(None, description="URL de l'image associée")
2026-02-20T22:09:11.7859402Z +    audio_url: Optional[str] = Field(None, description="URL audio pour accessibilité")
2026-02-20T22:09:11.7860118Z +
2026-02-20T22:09:11.7860389Z  
2026-02-20T22:09:11.7860681Z  class ExerciseUpdate(BaseModel):
2026-02-20T22:09:11.7861479Z      """Schéma pour la mise à jour d'un exercice (Modification d'une Épreuve)"""
2026-02-20T22:09:11.7862115Z +
2026-02-20T22:09:11.7862549Z      title: Optional[str] = Field(None, min_length=3, max_length=100)
2026-02-20T22:09:11.7864574Z      exercise_type: Optional[Union[str, ExerciseType]] = None
2026-02-20T22:09:11.7897315Z      difficulty: Optional[Union[str, DifficultyLevel]] = None
2026-02-20T22:09:11.7898075Z      question: Optional[str] = Field(None, min_length=5)
2026-02-20T22:09:11.7898665Z      correct_answer: Optional[str] = None
2026-02-20T22:09:11.7899125Z @@ -123,11 +143,11 @@
2026-02-20T22:09:11.7899488Z      image_url: Optional[str] = None
2026-02-20T22:09:11.7899942Z      audio_url: Optional[str] = None
2026-02-20T22:09:11.7900385Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.7900854Z      is_archived: Optional[bool] = None
2026-02-20T22:09:11.7901301Z  
2026-02-20T22:09:11.7901620Z -    @field_validator('exercise_type')
2026-02-20T22:09:11.7902090Z +    @field_validator("exercise_type")
2026-02-20T22:09:11.7902508Z      @classmethod
2026-02-20T22:09:11.7902863Z      def validate_exercise_type(cls, v):
2026-02-20T22:09:11.7903590Z          if v is None:
2026-02-20T22:09:11.7903934Z              return None
2026-02-20T22:09:11.7904263Z  
2026-02-20T22:09:11.7904538Z @@ -137,20 +157,24 @@
2026-02-20T22:09:11.7904835Z  
2026-02-20T22:09:11.7905505Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7906168Z          if isinstance(v, str):
2026-02-20T22:09:11.7906762Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7907411Z              v_upper = v.upper()
2026-02-20T22:09:11.7908060Z -            valid_types = [t.value for t in ExerciseType]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7908773Z +            valid_types = [
2026-02-20T22:09:11.7909199Z +                t.value for t in ExerciseType
2026-02-20T22:09:11.7909706Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7910539Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7911217Z              if v_upper in valid_types:
2026-02-20T22:09:11.7911661Z                  return v_upper
2026-02-20T22:09:11.7912030Z              else:
2026-02-20T22:09:11.7912784Z -                raise ValueError(f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}")
2026-02-20T22:09:11.7913835Z -
2026-02-20T22:09:11.7914486Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7914987Z -
2026-02-20T22:09:11.7915299Z -    @field_validator('difficulty')
2026-02-20T22:09:11.7915727Z +                raise ValueError(
2026-02-20T22:09:11.7916445Z +                    f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}"
2026-02-20T22:09:11.7917480Z +                )
2026-02-20T22:09:11.7917788Z +
2026-02-20T22:09:11.7918156Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7918633Z +
2026-02-20T22:09:11.7918925Z +    @field_validator("difficulty")
2026-02-20T22:09:11.7919332Z      @classmethod
2026-02-20T22:09:11.7919677Z      def validate_difficulty(cls, v):
2026-02-20T22:09:11.7920090Z          if v is None:
2026-02-20T22:09:11.7920426Z              return None
2026-02-20T22:09:11.7920759Z  
2026-02-20T22:09:11.7921023Z @@ -160,27 +184,33 @@
2026-02-20T22:09:11.7921327Z  
2026-02-20T22:09:11.7921946Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7922600Z          if isinstance(v, str):
2026-02-20T22:09:11.7929537Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7934253Z              v_upper = v.upper()
2026-02-20T22:09:11.7935009Z -            valid_difficulties = [d.value for d in DifficultyLevel]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7935835Z +            valid_difficulties = [
2026-02-20T22:09:11.7936301Z +                d.value for d in DifficultyLevel
2026-02-20T22:09:11.7936797Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7937654Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7938356Z              if v_upper in valid_difficulties:
2026-02-20T22:09:11.7938815Z                  return v_upper
2026-02-20T22:09:11.7939162Z              else:
2026-02-20T22:09:11.7940124Z -                raise ValueError(f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}")
2026-02-20T22:09:11.7941044Z -
2026-02-20T22:09:11.7941429Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7941936Z -
2026-02-20T22:09:11.7942227Z -    @field_validator('question')
2026-02-20T22:09:11.7942654Z +                raise ValueError(
2026-02-20T22:09:11.7943827Z +                    f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}"
2026-02-20T22:09:11.7946145Z +                )
2026-02-20T22:09:11.7947496Z +
2026-02-20T22:09:11.7973532Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7974056Z +
2026-02-20T22:09:11.7974371Z +    @field_validator("question")
2026-02-20T22:09:11.7974786Z      @classmethod
2026-02-20T22:09:11.7975125Z      def validate_question(cls, v):
2026-02-20T22:09:11.7975748Z -        if v is not None and not any(mark in v for mark in ['?', ':', '!', '.']):
2026-02-20T22:09:11.7976674Z -            raise ValueError("La question doit contenir une ponctuation finale (?, :, !, .)")
2026-02-20T22:09:11.7977424Z -        return v
2026-02-20T22:09:11.7977726Z -
2026-02-20T22:09:11.7978023Z -    @field_validator('choices')
2026-02-20T22:09:11.7978595Z +        if v is not None and not any(mark in v for mark in ["?", ":", "!", "."]):
2026-02-20T22:09:11.7979232Z +            raise ValueError(
2026-02-20T22:09:11.7979799Z +                "La question doit contenir une ponctuation finale (?, :, !, .)"
2026-02-20T22:09:11.7980397Z +            )
2026-02-20T22:09:11.7980701Z +        return v
2026-02-20T22:09:11.7980989Z +
2026-02-20T22:09:11.7981279Z +    @field_validator("choices")
2026-02-20T22:09:11.7981664Z      @classmethod
2026-02-20T22:09:11.7982009Z      def validate_choices(cls, v, info):
2026-02-20T22:09:11.7982440Z          if v is not None:
2026-02-20T22:09:11.7983206Z              # Vérifier qu'il y a au moins 2 choix
2026-02-20T22:09:11.7983705Z              if len(v) < 2:
2026-02-20T22:09:11.7984061Z @@ -190,12 +220,14 @@
2026-02-20T22:09:11.7984696Z              if len(v) != len(set(v)):
2026-02-20T22:09:11.7985386Z                  raise ValueError("Les choix doivent être uniques")
2026-02-20T22:09:11.7985920Z  
2026-02-20T22:09:11.7986178Z          return v
2026-02-20T22:09:11.7986479Z  
2026-02-20T22:09:11.7986715Z +
2026-02-20T22:09:11.7987015Z  class ExerciseInDB(ExerciseBase):
2026-02-20T22:09:11.7988045Z      """Schéma pour un exercice en base de données (Archives des Épreuves)"""
2026-02-20T22:09:11.7988666Z +
2026-02-20T22:09:11.7988933Z      id: int
2026-02-20T22:09:11.7989264Z      creator_id: Optional[int] = None
2026-02-20T22:09:11.7989719Z      image_url: Optional[str] = None
2026-02-20T22:09:11.7990161Z      audio_url: Optional[str] = None
2026-02-20T22:09:11.7990682Z      is_active: bool
2026-02-20T22:09:11.7991017Z @@ -204,18 +236,22 @@
2026-02-20T22:09:11.7991363Z      created_at: datetime
2026-02-20T22:09:11.7991733Z      updated_at: datetime
2026-02-20T22:09:11.7992083Z  
2026-02-20T22:09:11.7992438Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.7992953Z  
2026-02-20T22:09:11.8023541Z +
2026-02-20T22:09:11.8023850Z  class Exercise(ExerciseInDB):
2026-02-20T22:09:11.8024585Z      """Schéma pour un exercice complet (Holocron d'Épreuve)"""
2026-02-20T22:09:11.8025143Z +
2026-02-20T22:09:11.8025523Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8026035Z +
2026-02-20T22:09:11.8026295Z  
2026-02-20T22:09:11.8026581Z  class ExerciseStats(BaseModel):
2026-02-20T22:09:11.8027245Z      """Statistiques sur un exercice (Données de l'Holocron)"""
2026-02-20T22:09:11.8027774Z +
2026-02-20T22:09:11.8028051Z      exercise_id: int
2026-02-20T22:09:11.8028393Z      view_count: int
2026-02-20T22:09:11.8028723Z      attempt_count: int
2026-02-20T22:09:11.8029081Z      success_rate: float
2026-02-20T22:09:11.8029465Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8029897Z  
2026-02-20T22:09:11.8030245Z -    model_config = ConfigDict(from_attributes=True) 
2026-02-20T22:09:11.8030790Z \ No newline at end of file
2026-02-20T22:09:11.8031227Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8032030Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/progress.py
2026-02-20T22:09:11.8033309Z --- /home/runner/work/mathakine/mathakine/app/schemas/progress.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.8034504Z +++ /home/runner/work/mathakine/mathakine/app/schemas/progress.py	2026-02-20 22:09:11.776861+00:00
2026-02-20T22:09:11.8035294Z @@ -4,41 +4,47 @@
2026-02-20T22:09:11.8035796Z  from pydantic import BaseModel, ConfigDict, Field, field_validator
2026-02-20T22:09:11.8036386Z  
2026-02-20T22:09:11.8036882Z  # Schémas pour la manipulation des progressions
2026-02-20T22:09:11.8037365Z  
2026-02-20T22:09:11.8037623Z  
2026-02-20T22:09:11.8037868Z -
2026-02-20T22:09:11.8038178Z  class ProgressBase(BaseModel):
2026-02-20T22:09:11.8038913Z      """Schéma de base pour les progressions (Chemin vers la Maîtrise)"""
2026-02-20T22:09:11.8039868Z -    exercise_type: str = Field(..., description="Type d'exercice (addition, soustraction, etc.)")
2026-02-20T22:09:11.8040629Z +
2026-02-20T22:09:11.8040926Z +    exercise_type: str = Field(
2026-02-20T22:09:11.8041504Z +        ..., description="Type d'exercice (addition, soustraction, etc.)"
2026-02-20T22:09:11.8042083Z +    )
2026-02-20T22:09:11.8042708Z      difficulty: str = Field(..., description="Niveau de difficulté")
2026-02-20T22:09:11.8043742Z      total_attempts: int = Field(0, ge=0, description="Nombre total de tentatives")
2026-02-20T22:09:11.8044854Z      correct_attempts: int = Field(0, ge=0, description="Nombre de tentatives réussies")
2026-02-20T22:09:11.8046116Z -    average_time: Optional[float] = Field(None, ge=0.0, description="Temps moyen pour résoudre (secondes)")
2026-02-20T22:09:11.8047466Z -    completion_rate: Optional[float] = Field(None, ge=0.0, le=100.0, description="Taux de complétion (%)")
2026-02-20T22:09:11.8048204Z +    average_time: Optional[float] = Field(
2026-02-20T22:09:11.8049115Z +        None, ge=0.0, description="Temps moyen pour résoudre (secondes)"
2026-02-20T22:09:11.8049661Z +    )
2026-02-20T22:09:11.8049977Z +    completion_rate: Optional[float] = Field(
2026-02-20T22:09:11.8050635Z +        None, ge=0.0, le=100.0, description="Taux de complétion (%)"
2026-02-20T22:09:11.8051099Z +    )
2026-02-20T22:09:11.8051864Z      mastery_level: int = Field(1, description="Niveau de maîtrise (1-5)")
2026-02-20T22:09:11.8052432Z  
2026-02-20T22:09:11.8052712Z -    @field_validator('correct_attempts')
2026-02-20T22:09:11.8083490Z +    @field_validator("correct_attempts")
2026-02-20T22:09:11.8083960Z      @classmethod
2026-02-20T22:09:11.8084276Z -
2026-02-20T22:09:11.8084540Z -
2026-02-20T22:09:11.8084900Z      def correct_not_greater_than_total(cls, v, info):
2026-02-20T22:09:11.8085427Z          values = info.data
2026-02-20T22:09:11.8085955Z -        if 'total_attempts' in values and v > values['total_attempts']:
2026-02-20T22:09:11.8087212Z -            raise ValueError("Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives")
2026-02-20T22:09:11.8088281Z +        if "total_attempts" in values and v > values["total_attempts"]:
2026-02-20T22:09:11.8088900Z +            raise ValueError(
2026-02-20T22:09:11.8089845Z +                "Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives"
2026-02-20T22:09:11.8090621Z +            )
2026-02-20T22:09:11.8090921Z          return v
2026-02-20T22:09:11.8091211Z -
2026-02-20T22:09:11.8091468Z  
2026-02-20T22:09:11.8091716Z  
2026-02-20T22:09:11.8092027Z  class ProgressCreate(ProgressBase):
2026-02-20T22:09:11.8092784Z      """Schéma pour la création d'un enregistrement de progression"""
2026-02-20T22:09:11.8093547Z +
2026-02-20T22:09:11.8094133Z      user_id: int = Field(..., description="ID de l'utilisateur associé")
2026-02-20T22:09:11.8094720Z -
2026-02-20T22:09:11.8094990Z  
2026-02-20T22:09:11.8095227Z  
2026-02-20T22:09:11.8095525Z  class ProgressUpdate(BaseModel):
2026-02-20T22:09:11.8096297Z      """Schéma pour la mise à jour d'un enregistrement de progression"""
2026-02-20T22:09:11.8096898Z +
2026-02-20T22:09:11.8097261Z      total_attempts: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8097875Z      correct_attempts: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8098470Z      average_time: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.8099170Z      completion_rate: Optional[float] = Field(None, ge=0.0, le=100.0)
2026-02-20T22:09:11.8099823Z      streak: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8100276Z @@ -47,36 +53,44 @@
2026-02-20T22:09:11.8100643Z      awards: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8101108Z      strengths: Optional[str] = None
2026-02-20T22:09:11.8101571Z      areas_to_improve: Optional[str] = None
2026-02-20T22:09:11.8102060Z      recommendations: Optional[str] = None
2026-02-20T22:09:11.8102489Z  
2026-02-20T22:09:11.8102794Z -    @field_validator('correct_attempts')
2026-02-20T22:09:11.8103487Z +    @field_validator("correct_attempts")
2026-02-20T22:09:11.8103912Z      @classmethod
2026-02-20T22:09:11.8104212Z -
2026-02-20T22:09:11.8104466Z -
2026-02-20T22:09:11.8104803Z      def correct_not_greater_than_total(cls, v, info):
2026-02-20T22:09:11.8105308Z          values = info.data
2026-02-20T22:09:11.8105961Z -        if v is not None and 'total_attempts' in values and values['total_attempts'] is not None\
2026-02-20T22:09:11.8106748Z -            and v > values['total_attempts']:
2026-02-20T22:09:11.8107846Z -            raise ValueError("Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives")
2026-02-20T22:09:11.8108712Z +        if (
2026-02-20T22:09:11.8109020Z +            v is not None
2026-02-20T22:09:11.8109397Z +            and "total_attempts" in values
2026-02-20T22:09:11.8109894Z +            and values["total_attempts"] is not None
2026-02-20T22:09:11.8110405Z +            and v > values["total_attempts"]
2026-02-20T22:09:11.8110840Z +        ):
2026-02-20T22:09:11.8111404Z +            raise ValueError(
2026-02-20T22:09:11.8112285Z +                "Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives"
2026-02-20T22:09:11.8143258Z +            )
2026-02-20T22:09:11.8143648Z          return v
2026-02-20T22:09:11.8143960Z  
2026-02-20T22:09:11.8144291Z -    @field_validator('highest_streak')
2026-02-20T22:09:11.8145054Z +    @field_validator("highest_streak")
2026-02-20T22:09:11.8145485Z      @classmethod
2026-02-20T22:09:11.8145789Z -
2026-02-20T22:09:11.8146043Z -
2026-02-20T22:09:11.8146434Z      def highest_streak_not_less_than_streak(cls, v, info):
2026-02-20T22:09:11.8146974Z          values = info.data
2026-02-20T22:09:11.8147534Z -        if v is not None and 'streak' in values and values['streak'] is not None\
2026-02-20T22:09:11.8148185Z -            and v < values['streak']:
2026-02-20T22:09:11.8149158Z -            raise ValueError("La meilleure série ne peut pas être inférieure à la série actuelle")
2026-02-20T22:09:11.8149973Z +        if (
2026-02-20T22:09:11.8150291Z +            v is not None
2026-02-20T22:09:11.8150672Z +            and "streak" in values
2026-02-20T22:09:11.8151114Z +            and values["streak"] is not None
2026-02-20T22:09:11.8151585Z +            and v < values["streak"]
2026-02-20T22:09:11.8151993Z +        ):
2026-02-20T22:09:11.8152321Z +            raise ValueError(
2026-02-20T22:09:11.8153282Z +                "La meilleure série ne peut pas être inférieure à la série actuelle"
2026-02-20T22:09:11.8153940Z +            )
2026-02-20T22:09:11.8154242Z          return v
2026-02-20T22:09:11.8154532Z -
2026-02-20T22:09:11.8154794Z  
2026-02-20T22:09:11.8155041Z  
2026-02-20T22:09:11.8155344Z  class ProgressInDB(ProgressBase):
2026-02-20T22:09:11.8156103Z      """Schéma pour un enregistrement de progression en base de données"""
2026-02-20T22:09:11.8156715Z +
2026-02-20T22:09:11.8156977Z      id: int
2026-02-20T22:09:11.8157274Z      user_id: int
2026-02-20T22:09:11.8157619Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8158107Z      completion_rate: Optional[float] = None
2026-02-20T22:09:11.8158516Z      streak: int
2026-02-20T22:09:11.8158796Z @@ -89,24 +103,26 @@
2026-02-20T22:09:11.8159114Z      last_updated: datetime
2026-02-20T22:09:11.8159430Z  
2026-02-20T22:09:11.8159743Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8160196Z  
2026-02-20T22:09:11.8160421Z  
2026-02-20T22:09:11.8160637Z -
2026-02-20T22:09:11.8160915Z  class Progress(ProgressInDB):
2026-02-20T22:09:11.8161660Z      """Schéma pour un enregistrement de progression complet (Carte de Progression)"""
2026-02-20T22:09:11.8162298Z +
2026-02-20T22:09:11.8162564Z      user_name: Optional[str] = None
2026-02-20T22:09:11.8162938Z  
2026-02-20T22:09:11.8163416Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8163850Z  
2026-02-20T22:09:11.8164084Z  
2026-02-20T22:09:11.8164303Z -
2026-02-20T22:09:11.8164590Z  class UserProgressSummary(BaseModel):
2026-02-20T22:09:11.8165315Z      """Résumé de la progression d'un utilisateur (Rapport du Conseil Jedi)"""
2026-02-20T22:09:11.8165875Z +
2026-02-20T22:09:11.8166111Z      user_id: int
2026-02-20T22:09:11.8166395Z      user_name: str
2026-02-20T22:09:11.8167124Z -    overall_mastery: float = Field(..., ge=0.0, le=5.0, description="Niveau de maîtrise global (0-5)")
2026-02-20T22:09:11.8167865Z +    overall_mastery: float = Field(
2026-02-20T22:09:11.8168502Z +        ..., ge=0.0, le=5.0, description="Niveau de maîtrise global (0-5)"
2026-02-20T22:09:11.8169007Z +    )
2026-02-20T22:09:11.8169286Z      total_exercises_completed: int
2026-02-20T22:09:11.8169692Z      strongest_area: Optional[str] = None
2026-02-20T22:09:11.8170126Z      weakest_area: Optional[str] = None
2026-02-20T22:09:11.8170613Z      recent_progress: Optional[List[Dict[str, Any]]] = None
2026-02-20T22:09:11.8171230Z      next_recommended_exercise_types: Optional[List[str]] = None
2026-02-20T22:09:11.8171745Z @@ -114,26 +130,33 @@
2026-02-20T22:09:11.8172332Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8172772Z  
2026-02-20T22:09:11.8203266Z  
2026-02-20T22:09:11.8203671Z  class ProgressResponse(ProgressBase):
2026-02-20T22:09:11.8204420Z      """Schéma pour la réponse de progrès utilisateur"""
2026-02-20T22:09:11.8205389Z -    last_updated: Optional[str] = Field(None, description="Date de dernière mise à jour")
2026-02-20T22:09:11.8206438Z -    
2026-02-20T22:09:11.8206724Z +
2026-02-20T22:09:11.8207026Z +    last_updated: Optional[str] = Field(
2026-02-20T22:09:11.8207715Z +        None, description="Date de dernière mise à jour"
2026-02-20T22:09:11.8208221Z +    )
2026-02-20T22:09:11.8208495Z +
2026-02-20T22:09:11.8208858Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8209345Z  
2026-02-20T22:09:11.8209608Z  
2026-02-20T22:09:11.8209902Z  class RecentAttempt(BaseModel):
2026-02-20T22:09:11.8210492Z      """Schéma pour les tentatives récentes"""
2026-02-20T22:09:11.8210935Z +
2026-02-20T22:09:11.8211383Z      exercise_id: int = Field(..., description="ID de l'exercice")
2026-02-20T22:09:11.8212136Z      exercise_title: str = Field(..., description="Titre de l'exercice")
2026-02-20T22:09:11.8213159Z      is_correct: bool = Field(..., description="Si la tentative est correcte")
2026-02-20T22:09:11.8214160Z      time_spent: float = Field(..., description="Temps passé (secondes)")
2026-02-20T22:09:11.8214972Z      date: Optional[str] = Field(None, description="Date de la tentative")
2026-02-20T22:09:11.8215575Z  
2026-02-20T22:09:11.8215826Z  
2026-02-20T22:09:11.8216144Z  class ProgressDetail(ProgressResponse):
2026-02-20T22:09:11.8216841Z      """Schéma détaillé pour les progrès utilisateur"""
2026-02-20T22:09:11.8217343Z +
2026-02-20T22:09:11.8217966Z      streak: int = Field(0, description="Série actuelle d'exercices réussis")
2026-02-20T22:09:11.8218889Z      highest_streak: int = Field(0, description="Meilleure série")
2026-02-20T22:09:11.8219865Z      strengths: Optional[str] = Field(None, description="Points forts identifiés")
2026-02-20T22:09:11.8220994Z      areas_to_improve: Optional[str] = Field(None, description="Domaines à améliorer")
2026-02-20T22:09:11.8222285Z -    recent_attempts: List[RecentAttempt] = Field(default_factory=list, description="Tentatives récentes")
2026-02-20T22:09:11.8223435Z +    recent_attempts: List[RecentAttempt] = Field(
2026-02-20T22:09:11.8224241Z +        default_factory=list, description="Tentatives récentes"
2026-02-20T22:09:11.8224801Z +    )
2026-02-20T22:09:11.8225464Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py
2026-02-20T22:09:11.8226597Z --- /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.8227839Z +++ /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py	2026-02-20 22:09:11.813484+00:00
2026-02-20T22:09:11.8228670Z @@ -5,71 +5,87 @@
2026-02-20T22:09:11.8228978Z  
2026-02-20T22:09:11.8229300Z  from app.models.logic_challenge import AgeGroup, LogicChallengeType
2026-02-20T22:09:11.8229428Z  
2026-02-20T22:09:11.8229769Z  # Schémas pour la manipulation des défis logiques
2026-02-20T22:09:11.8229882Z  
2026-02-20T22:09:11.8229990Z +
2026-02-20T22:09:11.8230160Z  class LogicChallengeBase(BaseModel):
2026-02-20T22:09:11.8230626Z      """Schéma de base pour les défis de logique (Épreuves du Conseil Jedi)"""
2026-02-20T22:09:11.8230881Z -    title: str = Field(..., min_length=3, max_length=100,
2026-02-20T22:09:11.8231257Z -                    description="Titre du défi (3-100 caractères)")
2026-02-20T22:09:11.8231482Z -    challenge_type: LogicChallengeType = Field(...,
2026-02-20T22:09:11.8231849Z -                                           description="Type de défi logique")
2026-02-20T22:09:11.8232006Z -    age_group: AgeGroup = Field(...,
2026-02-20T22:09:11.8232317Z -                             description="Groupe d'âge cible")
2026-02-20T22:09:11.8232520Z -    description: str = Field(..., min_length=10,
2026-02-20T22:09:11.8232921Z -                         description="Énoncé du problème (min 10 caractères)")
2026-02-20T22:09:11.8263635Z -    correct_answer: str = Field(...,
2026-02-20T22:09:11.8264059Z -                             description="Réponse correcte au défi")
2026-02-20T22:09:11.8264306Z -    solution_explanation: str = Field(..., min_length=10,
2026-02-20T22:09:11.8264911Z -                                  description="Explication détaillée de la solution")
2026-02-20T22:09:11.8265032Z +
2026-02-20T22:09:11.8265168Z +    title: str = Field(
2026-02-20T22:09:11.8265277Z +        ...,
2026-02-20T22:09:11.8265401Z +        min_length=3,
2026-02-20T22:09:11.8265533Z +        max_length=100,
2026-02-20T22:09:11.8265841Z +        description="Titre du défi (3-100 caractères)",
2026-02-20T22:09:11.8265948Z +    )
2026-02-20T22:09:11.8266499Z +    challenge_type: LogicChallengeType = Field(..., description="Type de défi logique")
2026-02-20T22:09:11.8266896Z +    age_group: AgeGroup = Field(..., description="Groupe d'âge cible")
2026-02-20T22:09:11.8267054Z +    description: str = Field(
2026-02-20T22:09:11.8267499Z +        ..., min_length=10, description="Énoncé du problème (min 10 caractères)"
2026-02-20T22:09:11.8267616Z +    )
2026-02-20T22:09:11.8268047Z +    correct_answer: str = Field(..., description="Réponse correcte au défi")
2026-02-20T22:09:11.8268199Z +    solution_explanation: str = Field(
2026-02-20T22:09:11.8268644Z +        ..., min_length=10, description="Explication détaillée de la solution"
2026-02-20T22:09:11.8268748Z +    )
2026-02-20T22:09:11.8268851Z  
2026-02-20T22:09:11.8268986Z      # Champs optionnels
2026-02-20T22:09:11.8269153Z -    hints: Optional[List[str]] = Field(None,
2026-02-20T22:09:11.8269427Z -                                    description="Liste des indices (aide progressive)")
2026-02-20T22:09:11.8269650Z -    difficulty_rating: float = Field(3.0, ge=1.0, le=5.0,
2026-02-20T22:09:11.8270001Z -                                 description="Niveau de difficulté (1-5)")
2026-02-20T22:09:11.8270227Z -    estimated_time_minutes: int = Field(15, ge=1, le=120,
2026-02-20T22:09:11.8270645Z -                                     description="Temps estimé pour résoudre (en minutes)")
2026-02-20T22:09:11.8270807Z -    tags: Optional[str] = Field(None,
2026-02-20T22:09:11.8271149Z -                             description="Tags séparés par des virgules")
2026-02-20T22:09:11.8271269Z -
2026-02-20T22:09:11.8271427Z -    @field_validator('correct_answer')
2026-02-20T22:09:11.8271574Z +    hints: Optional[List[str]] = Field(
2026-02-20T22:09:11.8271819Z +        None, description="Liste des indices (aide progressive)"
2026-02-20T22:09:11.8271922Z +    )
2026-02-20T22:09:11.8272075Z +    difficulty_rating: float = Field(
2026-02-20T22:09:11.8272426Z +        3.0, ge=1.0, le=5.0, description="Niveau de difficulté (1-5)"
2026-02-20T22:09:11.8272529Z +    )
2026-02-20T22:09:11.8272683Z +    estimated_time_minutes: int = Field(
2026-02-20T22:09:11.8273265Z +        15, ge=1, le=120, description="Temps estimé pour résoudre (en minutes)"
2026-02-20T22:09:11.8273390Z +    )
2026-02-20T22:09:11.8273867Z +    tags: Optional[str] = Field(None, description="Tags séparés par des virgules")
2026-02-20T22:09:11.8273981Z +
2026-02-20T22:09:11.8274128Z +    @field_validator("correct_answer")
2026-02-20T22:09:11.8274248Z      @classmethod
2026-02-20T22:09:11.8274401Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8274553Z          if not v or v.isspace():
2026-02-20T22:09:11.8274956Z              raise ValueError("La réponse correcte ne peut pas être vide")
2026-02-20T22:09:11.8275080Z          return v
2026-02-20T22:09:11.8275182Z  
2026-02-20T22:09:11.8275333Z -    @field_validator('description')
2026-02-20T22:09:11.8275474Z +    @field_validator("description")
2026-02-20T22:09:11.8275593Z      @classmethod
2026-02-20T22:09:11.8275757Z      def description_not_too_short(cls, v):
2026-02-20T22:09:11.8275882Z          if len(v) < 10:
2026-02-20T22:09:11.8276350Z              raise ValueError("La description doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8276662Z          return v
2026-02-20T22:09:11.8276759Z  
2026-02-20T22:09:11.8276929Z -    @field_validator('solution_explanation')
2026-02-20T22:09:11.8277097Z +    @field_validator("solution_explanation")
2026-02-20T22:09:11.8277203Z      @classmethod
2026-02-20T22:09:11.8277345Z      def explanation_not_too_short(cls, v):
2026-02-20T22:09:11.8277627Z          if len(v) < 10:
2026-02-20T22:09:11.8278184Z -            raise ValueError("L'explication de la solution doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8278292Z -        return v
2026-02-20T22:09:11.8278426Z +            raise ValueError(
2026-02-20T22:09:11.8278856Z +                "L'explication de la solution doit contenir au moins 10 caractères"
2026-02-20T22:09:11.8278961Z +            )
2026-02-20T22:09:11.8279067Z +        return v
2026-02-20T22:09:11.8279168Z +
2026-02-20T22:09:11.8279270Z  
2026-02-20T22:09:11.8279471Z  class LogicChallengeCreate(LogicChallengeBase):
2026-02-20T22:09:11.8279768Z      """Schéma pour la création d'un défi logique"""
2026-02-20T22:09:11.8279977Z -    visual_data: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.8280514Z -                                             description="Données pour visualisation (graphes, formes, etc.)")
2026-02-20T22:09:11.8280673Z -    image_url: Optional[str] = Field(None,
2026-02-20T22:09:11.8281003Z -                                 description="URL de l'image associée")
2026-02-20T22:09:11.8281193Z -    source_reference: Optional[str] = Field(None,
2026-02-20T22:09:11.8281441Z -                                        description="Source (concours, livre, etc.)")
2026-02-20T22:09:11.8281591Z -    is_template: bool = Field(False,
2026-02-20T22:09:11.8281990Z -                           description="S'il s'agit d'un template pour génération")
2026-02-20T22:09:11.8282264Z -    generation_parameters: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.8282685Z -                                                       description="Paramètres pour la génération")
2026-02-20T22:09:11.8282794Z +
2026-02-20T22:09:11.8283144Z +    visual_data: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.8283588Z +        None, description="Données pour visualisation (graphes, formes, etc.)"
2026-02-20T22:09:11.8283689Z +    )
2026-02-20T22:09:11.8284145Z +    image_url: Optional[str] = Field(None, description="URL de l'image associée")
2026-02-20T22:09:11.8284325Z +    source_reference: Optional[str] = Field(
2026-02-20T22:09:11.8284526Z +        None, description="Source (concours, livre, etc.)"
2026-02-20T22:09:11.8284634Z +    )
2026-02-20T22:09:11.8284770Z +    is_template: bool = Field(
2026-02-20T22:09:11.8285166Z +        False, description="S'il s'agit d'un template pour génération"
2026-02-20T22:09:11.8285272Z +    )
2026-02-20T22:09:11.8285518Z +    generation_parameters: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.8285847Z +        None, description="Paramètres pour la génération"
2026-02-20T22:09:11.8285955Z +    )
2026-02-20T22:09:11.8286076Z +
2026-02-20T22:09:11.8286178Z  
2026-02-20T22:09:11.8286354Z  class LogicChallengeUpdate(BaseModel):
2026-02-20T22:09:11.8286651Z      """Schéma pour la mise à jour d'un défi logique"""
2026-02-20T22:09:11.8286754Z +
2026-02-20T22:09:11.8287042Z      title: Optional[str] = Field(None, min_length=3, max_length=100)
2026-02-20T22:09:11.8287366Z      challenge_type: Optional[LogicChallengeType] = None
2026-02-20T22:09:11.8287526Z      age_group: Optional[AgeGroup] = None
2026-02-20T22:09:11.8287764Z      description: Optional[str] = Field(None, min_length=10)
2026-02-20T22:09:11.8287921Z      correct_answer: Optional[str] = None
2026-02-20T22:09:11.8288035Z @@ -84,26 +100,30 @@
2026-02-20T22:09:11.8288182Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.8288339Z      is_archived: Optional[bool] = None
2026-02-20T22:09:11.8288487Z      is_template: Optional[bool] = None
2026-02-20T22:09:11.8288721Z      generation_parameters: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8289048Z  
2026-02-20T22:09:11.8289204Z -    @field_validator('description')
2026-02-20T22:09:11.8289346Z +    @field_validator("description")
2026-02-20T22:09:11.8289463Z      @classmethod
2026-02-20T22:09:11.8289638Z      def description_not_too_short(cls, v):
2026-02-20T22:09:11.8289788Z          if v is not None and len(v) < 10:
2026-02-20T22:09:11.8290458Z              raise ValueError("La description doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8290582Z          return v
2026-02-20T22:09:11.8290684Z  
2026-02-20T22:09:11.8290860Z -    @field_validator('solution_explanation')
2026-02-20T22:09:11.8291026Z +    @field_validator("solution_explanation")
2026-02-20T22:09:11.8291145Z      @classmethod
2026-02-20T22:09:11.8291310Z      def explanation_not_too_short(cls, v):
2026-02-20T22:09:11.8291457Z          if v is not None and len(v) < 10:
2026-02-20T22:09:11.8292043Z -            raise ValueError("L'explication de la solution doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8292172Z -        return v
2026-02-20T22:09:11.8292303Z +            raise ValueError(
2026-02-20T22:09:11.8292751Z +                "L'explication de la solution doit contenir au moins 10 caractères"
2026-02-20T22:09:11.8292860Z +            )
2026-02-20T22:09:11.8323172Z +        return v
2026-02-20T22:09:11.8323336Z +
2026-02-20T22:09:11.8323450Z  
2026-02-20T22:09:11.8323690Z  class LogicChallengeInDB(LogicChallengeBase):
2026-02-20T22:09:11.8324070Z      """Schéma pour un défi logique en base de données"""
2026-02-20T22:09:11.8324187Z +
2026-02-20T22:09:11.8324300Z      id: int
2026-02-20T22:09:11.8324454Z      creator_id: Optional[int] = None
2026-02-20T22:09:11.8324640Z      visual_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8324796Z      image_url: Optional[str] = None
2026-02-20T22:09:11.8324957Z      source_reference: Optional[str] = None
2026-02-20T22:09:11.8325074Z @@ -116,83 +136,111 @@
2026-02-20T22:09:11.8325213Z      created_at: datetime
2026-02-20T22:09:11.8325341Z      updated_at: datetime
2026-02-20T22:09:11.8325456Z  
2026-02-20T22:09:11.8325660Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8325772Z  
2026-02-20T22:09:11.8325874Z +
2026-02-20T22:09:11.8326051Z  class LogicChallenge(LogicChallengeInDB):
2026-02-20T22:09:11.8326329Z      """Schéma pour un défi logique complet"""
2026-02-20T22:09:11.8326546Z -    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8326648Z +
2026-02-20T22:09:11.8326843Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8326954Z +
2026-02-20T22:09:11.8327057Z  
2026-02-20T22:09:11.8327317Z  # Schémas pour les tentatives de résolution
2026-02-20T22:09:11.8327429Z +
2026-02-20T22:09:11.8327532Z  
2026-02-20T22:09:11.8327721Z  class LogicChallengeAttemptBase(BaseModel):
2026-02-20T22:09:11.8328158Z      """Schéma de base pour les tentatives de résolution de défis logiques"""
2026-02-20T22:09:11.8328271Z +
2026-02-20T22:09:11.8328665Z      challenge_id: int = Field(..., description="ID du défi logique")
2026-02-20T22:09:11.8329172Z      user_solution: str = Field(..., description="Réponse fournie par l'utilisateur")
2026-02-20T22:09:11.8329387Z -    time_spent: Optional[float] = Field(None, ge=0.0,
2026-02-20T22:09:11.8329731Z -                                     description="Temps passé en secondes")
2026-02-20T22:09:11.8330364Z -    hints_used: Optional[List[int]] = Field(None, description="Liste des indices utilisés (ex: [1, 2])")
2026-02-20T22:09:11.8330779Z -    notes: Optional[str] = Field(None, description="Notes personnelles de l'utilisateur")
2026-02-20T22:09:11.8330885Z -
2026-02-20T22:09:11.8331038Z -    @field_validator('user_solution')
2026-02-20T22:09:11.8331204Z +    time_spent: Optional[float] = Field(
2026-02-20T22:09:11.8331532Z +        None, ge=0.0, description="Temps passé en secondes"
2026-02-20T22:09:11.8331640Z +    )
2026-02-20T22:09:11.8331810Z +    hints_used: Optional[List[int]] = Field(
2026-02-20T22:09:11.8332188Z +        None, description="Liste des indices utilisés (ex: [1, 2])"
2026-02-20T22:09:11.8332525Z +    )
2026-02-20T22:09:11.8332673Z +    notes: Optional[str] = Field(
2026-02-20T22:09:11.8332936Z +        None, description="Notes personnelles de l'utilisateur"
2026-02-20T22:09:11.8333211Z +    )
2026-02-20T22:09:11.8333320Z +
2026-02-20T22:09:11.8333475Z +    @field_validator("user_solution")
2026-02-20T22:09:11.8333783Z      @classmethod
2026-02-20T22:09:11.8333931Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8334070Z          if not v or v.isspace():
2026-02-20T22:09:11.8334448Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.8334562Z          return v
2026-02-20T22:09:11.8334667Z  
2026-02-20T22:09:11.8334769Z +
2026-02-20T22:09:11.8335077Z  class LogicChallengeAttemptCreate(LogicChallengeAttemptBase):
2026-02-20T22:09:11.8335532Z      """Schéma pour la création d'une tentative de résolution de défi logique"""
2026-02-20T22:09:11.8335646Z +
2026-02-20T22:09:11.8335769Z      pass
2026-02-20T22:09:11.8335872Z +
2026-02-20T22:09:11.8335992Z  
2026-02-20T22:09:11.8336200Z  class LogicChallengeAttemptUpdate(BaseModel):
2026-02-20T22:09:11.8336585Z      """Schéma pour la mise à jour d'une tentative de résolution"""
2026-02-20T22:09:11.8336692Z +
2026-02-20T22:09:11.8336848Z      user_solution: Optional[str] = None
2026-02-20T22:09:11.8337010Z      is_correct: Optional[bool] = None
2026-02-20T22:09:11.8337231Z      time_spent: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.8337391Z      hints_used: Optional[List[int]] = None
2026-02-20T22:09:11.8337546Z      notes: Optional[str] = None
2026-02-20T22:09:11.8337652Z  
2026-02-20T22:09:11.8337803Z -    @field_validator('user_solution')
2026-02-20T22:09:11.8337949Z +    @field_validator("user_solution")
2026-02-20T22:09:11.8338071Z      @classmethod
2026-02-20T22:09:11.8338212Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8338400Z          if v is not None and (not v or v.isspace()):
2026-02-20T22:09:11.8338754Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.8338883Z          return v
2026-02-20T22:09:11.8338985Z  
2026-02-20T22:09:11.8339087Z +
2026-02-20T22:09:11.8339382Z  class LogicChallengeAttemptInDB(LogicChallengeAttemptBase):
2026-02-20T22:09:11.8339767Z      """Schéma pour une tentative de résolution en base de données"""
2026-02-20T22:09:11.8339873Z +
2026-02-20T22:09:11.8340005Z      id: int
2026-02-20T22:09:11.8340120Z      user_id: int
2026-02-20T22:09:11.8340244Z      is_correct: bool
2026-02-20T22:09:11.8340375Z      attempt_number: int
2026-02-20T22:09:11.8340510Z      created_at: datetime
2026-02-20T22:09:11.8340612Z  
2026-02-20T22:09:11.8340812Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8340924Z  
2026-02-20T22:09:11.8341026Z +
2026-02-20T22:09:11.8341281Z  class LogicChallengeAttempt(LogicChallengeAttemptInDB):
2026-02-20T22:09:11.8341602Z      """Schéma pour une tentative de résolution complète"""
2026-02-20T22:09:11.8341711Z +
2026-02-20T22:09:11.8341869Z      challenge_title: Optional[str] = None
2026-02-20T22:09:11.8342105Z      challenge_type: Optional[LogicChallengeType] = None
2026-02-20T22:09:11.8342268Z      age_group: Optional[AgeGroup] = None
2026-02-20T22:09:11.8342371Z  
2026-02-20T22:09:11.8342571Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8342683Z  
2026-02-20T22:09:11.8342800Z +
2026-02-20T22:09:11.8343209Z  class LogicChallengeStats(BaseModel):
2026-02-20T22:09:11.8343473Z      """Statistiques sur un défi logique"""
2026-02-20T22:09:11.8343588Z +
2026-02-20T22:09:11.8343717Z      challenge_id: int
2026-02-20T22:09:11.8343838Z      view_count: int
2026-02-20T22:09:11.8343976Z      attempt_count: int
2026-02-20T22:09:11.8344104Z      success_rate: float
2026-02-20T22:09:11.8344257Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8344717Z -    hint_usage_rate: Optional[Dict[str, float]] = None  # Taux d'utilisation de chaque niveau d'indice
2026-02-20T22:09:11.8344830Z -
2026-02-20T22:09:11.8345027Z -    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8345462Z +    hint_usage_rate: Optional[Dict[str, float]] = (
2026-02-20T22:09:11.8345701Z +        None  # Taux d'utilisation de chaque niveau d'indice
2026-02-20T22:09:11.8345808Z +    )
2026-02-20T22:09:11.8345911Z +
2026-02-20T22:09:11.8346104Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8346380Z +
2026-02-20T22:09:11.8346487Z  
2026-02-20T22:09:11.8346689Z  class LogicChallengeAttemptResult(BaseModel):
2026-02-20T22:09:11.8347088Z      """Résultat d'une tentative de résolution d'un défi logique"""
2026-02-20T22:09:11.8347193Z +
2026-02-20T22:09:11.8347614Z      is_correct: bool = Field(..., description="Si la réponse est correcte")
2026-02-20T22:09:11.8347900Z      feedback: str = Field(..., description="Retour sur la tentative")
2026-02-20T22:09:11.8348377Z -    explanation: Optional[str] = Field(None, description="Explication de la solution (si correct)")
2026-02-20T22:09:11.8348791Z -    hints: Optional[List[str]] = Field(None, description="Indices pour aider (si incorrect)")
2026-02-20T22:09:11.8348915Z -
2026-02-20T22:09:11.8349129Z -    model_config = ConfigDict(from_attributes=True) 
2026-02-20T22:09:11.8349266Z \ No newline at end of file
2026-02-20T22:09:11.8349424Z +    explanation: Optional[str] = Field(
2026-02-20T22:09:11.8349703Z +        None, description="Explication de la solution (si correct)"
2026-02-20T22:09:11.8349822Z +    )
2026-02-20T22:09:11.8349973Z +    hints: Optional[List[str]] = Field(
2026-02-20T22:09:11.8350214Z +        None, description="Indices pour aider (si incorrect)"
2026-02-20T22:09:11.8350321Z +    )
2026-02-20T22:09:11.8350422Z +
2026-02-20T22:09:11.8350620Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8351055Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/user_session.py
2026-02-20T22:09:11.8351557Z --- /home/runner/work/mathakine/mathakine/app/schemas/user_session.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.8352046Z +++ /home/runner/work/mathakine/mathakine/app/schemas/user_session.py	2026-02-20 22:09:11.825999+00:00
2026-02-20T22:09:11.8352178Z @@ -1,24 +1,27 @@
2026-02-20T22:09:11.8352282Z  """
2026-02-20T22:09:11.8352565Z  Schémas Pydantic pour les sessions utilisateur
2026-02-20T22:09:11.8352690Z  """
2026-02-20T22:09:11.8352795Z +
2026-02-20T22:09:11.8352945Z  from datetime import datetime
2026-02-20T22:09:11.8383332Z  from typing import Any, Dict, Optional
2026-02-20T22:09:11.8383440Z  
2026-02-20T22:09:11.8383613Z  from pydantic import BaseModel, ConfigDict
2026-02-20T22:09:11.8383717Z  
2026-02-20T22:09:11.8383836Z  
2026-02-20T22:09:11.8383991Z  class UserSessionBase(BaseModel):
2026-02-20T22:09:11.8384319Z      """Schéma de base pour une session utilisateur"""
2026-02-20T22:09:11.8384433Z +
2026-02-20T22:09:11.8384619Z      device_info: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8384771Z      ip_address: Optional[str] = None
2026-02-20T22:09:11.8384916Z      user_agent: Optional[str] = None
2026-02-20T22:09:11.8385129Z      location_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8385234Z  
2026-02-20T22:09:11.8385342Z  
2026-02-20T22:09:11.8385521Z  class UserSessionInDB(UserSessionBase):
2026-02-20T22:09:11.8385949Z      """Schéma pour une session en base de données (avec tous les champs)"""
2026-02-20T22:09:11.8386130Z +
2026-02-20T22:09:11.8386257Z      id: int
2026-02-20T22:09:11.8386383Z      user_id: int
2026-02-20T22:09:11.8386513Z      session_token: str
2026-02-20T22:09:11.8386634Z      is_active: bool
2026-02-20T22:09:11.8386784Z      last_activity: datetime
2026-02-20T22:09:11.8386898Z @@ -28,10 +31,11 @@
2026-02-20T22:09:11.8387094Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8387199Z  
2026-02-20T22:09:11.8387311Z  
2026-02-20T22:09:11.8387455Z  class UserSession(BaseModel):
2026-02-20T22:09:11.8387789Z      """Schéma pour une session utilisateur (réponse API)"""
2026-02-20T22:09:11.8387905Z +
2026-02-20T22:09:11.8388011Z      id: int
2026-02-20T22:09:11.8388452Z      device_info: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8388607Z      ip_address: Optional[str] = None
2026-02-20T22:09:11.8388761Z      user_agent: Optional[str] = None
2026-02-20T22:09:11.8388951Z      location_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8389063Z @@ -44,7 +48,8 @@
2026-02-20T22:09:11.8389277Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8389543Z  
2026-02-20T22:09:11.8389648Z  
2026-02-20T22:09:11.8389813Z  class UserSessionRevoke(BaseModel):
2026-02-20T22:09:11.8390096Z      """Schéma pour la révocation d'une session"""
2026-02-20T22:09:11.8390199Z +
2026-02-20T22:09:11.8390316Z      success: bool
2026-02-20T22:09:11.8390439Z      message: str
2026-02-20T22:09:11.9422025Z --- /home/runner/work/mathakine/mathakine/app/schemas/user.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.9422540Z +++ /home/runner/work/mathakine/mathakine/app/schemas/user.py	2026-02-20 22:09:11.939488+00:00
2026-02-20T22:09:11.9422671Z @@ -8,55 +8,81 @@
2026-02-20T22:09:11.9422871Z  from app.models.user import UserRole
2026-02-20T22:09:11.9423144Z  
2026-02-20T22:09:11.9423652Z  # Schémas pour la manipulation des utilisateurs
2026-02-20T22:09:11.9423766Z  
2026-02-20T22:09:11.9423869Z  
2026-02-20T22:09:11.9423972Z -
2026-02-20T22:09:11.9424119Z  class UserBase(BaseModel):
2026-02-20T22:09:11.9424563Z      """Schéma de base pour les utilisateurs (Les bases d'un Padawan)"""
2026-02-20T22:09:11.9424780Z -    username: str = Field(..., min_length=3, max_length=50,
2026-02-20T22:09:11.9425177Z -                        description="Nom d'utilisateur unique (3-50 caractères)")
2026-02-20T22:09:11.9425282Z +
2026-02-20T22:09:11.9425408Z +    username: str = Field(
2026-02-20T22:09:11.9425516Z +        ...,
2026-02-20T22:09:11.9425623Z +        min_length=3,
2026-02-20T22:09:11.9425728Z +        max_length=50,
2026-02-20T22:09:11.9426092Z +        description="Nom d'utilisateur unique (3-50 caractères)",
2026-02-20T22:09:11.9426203Z +    )
2026-02-20T22:09:11.9426509Z      email: EmailStr = Field(..., description="Adresse email valide")
2026-02-20T22:09:11.9426810Z -    full_name: Optional[str] = Field(None, min_length=2, max_length=100,
2026-02-20T22:09:11.9427038Z -                                  description="Nom complet de l'utilisateur")
2026-02-20T22:09:11.9427234Z -    role: Optional[UserRole] = Field(default="PADAWAN",
2026-02-20T22:09:11.9427669Z -                                  description="Rôle dans l'Ordre Jedi des Mathématiques")
2026-02-20T22:09:11.9427887Z -    grade_level: Optional[int] = Field(None, ge=1, le=12,
2026-02-20T22:09:11.9428085Z -                                    description="Niveau scolaire (1-12)")
2026-02-20T22:09:11.9428251Z -    learning_style: Optional[str] = Field(None,
2026-02-20T22:09:11.9428593Z -                                      description="Style d'apprentissage préféré")
2026-02-20T22:09:11.9428796Z -    preferred_difficulty: Optional[str] = Field(None,
2026-02-20T22:09:11.9429128Z -                                           description="Difficulté préférée")
2026-02-20T22:09:11.9429352Z -    preferred_theme: Optional[str] = Field("spatial",
2026-02-20T22:09:11.9429948Z -                                      description="Thème préféré: spatial, minimalist, ocean, dune, forest, peach")
2026-02-20T22:09:11.9430248Z -    accessibility_settings: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.9430798Z -                                                        description="Paramètres d'accessibilité personnalisés")
2026-02-20T22:09:11.9430918Z -
2026-02-20T22:09:11.9431069Z -    @field_validator('username')
2026-02-20T22:09:11.9431224Z +    full_name: Optional[str] = Field(
2026-02-20T22:09:11.9431584Z +        None, min_length=2, max_length=100, description="Nom complet de l'utilisateur"
2026-02-20T22:09:11.9431693Z +    )
2026-02-20T22:09:11.9431840Z +    role: Optional[UserRole] = Field(
2026-02-20T22:09:11.9432332Z +        default="PADAWAN", description="Rôle dans l'Ordre Jedi des Mathématiques"
2026-02-20T22:09:11.9432873Z +    )
2026-02-20T22:09:11.9433243Z +    grade_level: Optional[int] = Field(
2026-02-20T22:09:11.9433486Z +        None, ge=1, le=12, description="Niveau scolaire (1-12)"
2026-02-20T22:09:11.9433602Z +    )
2026-02-20T22:09:11.9433767Z +    learning_style: Optional[str] = Field(
2026-02-20T22:09:11.9434127Z +        None, description="Style d'apprentissage préféré"
2026-02-20T22:09:11.9434825Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/user.py
2026-02-20T22:09:11.9434941Z +    )
2026-02-20T22:09:11.9435519Z +    preferred_difficulty: Optional[str] = Field(None, description="Difficulté préférée")
2026-02-20T22:09:11.9435697Z +    preferred_theme: Optional[str] = Field(
2026-02-20T22:09:11.9435828Z +        "spatial",
2026-02-20T22:09:11.9436318Z +        description="Thème préféré: spatial, minimalist, ocean, dune, forest, peach",
2026-02-20T22:09:11.9436433Z +    )
2026-02-20T22:09:11.9436703Z +    accessibility_settings: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.9437118Z +        None, description="Paramètres d'accessibilité personnalisés"
2026-02-20T22:09:11.9437228Z +    )
2026-02-20T22:09:11.9437342Z +
2026-02-20T22:09:11.9437488Z +    @field_validator("username")
2026-02-20T22:09:11.9437603Z      @classmethod
2026-02-20T22:09:11.9437754Z      def username_alphanumeric(cls, v):
2026-02-20T22:09:11.9437983Z -        if not v.replace('_', '').replace('-', '').isalnum():
2026-02-20T22:09:11.9438556Z -            raise ValueError("Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores")
2026-02-20T22:09:11.9438674Z -        return v
2026-02-20T22:09:11.9438795Z -
2026-02-20T22:09:11.9438952Z -    @field_validator('preferred_theme')
2026-02-20T22:09:11.9439162Z +        if not v.replace("_", "").replace("-", "").isalnum():
2026-02-20T22:09:11.9439291Z +            raise ValueError(
2026-02-20T22:09:11.9439734Z +                "Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores"
2026-02-20T22:09:11.9439854Z +            )
2026-02-20T22:09:11.9439964Z +        return v
2026-02-20T22:09:11.9440072Z +
2026-02-20T22:09:11.9440226Z +    @field_validator("preferred_theme")
2026-02-20T22:09:11.9440342Z      @classmethod
2026-02-20T22:09:11.9440477Z      def theme_valid(cls, v):
2026-02-20T22:09:11.9441416Z          # Accepter les thèmes UI (light/dark) et les thèmes visuels (spatial, minimalist, ocean, dune, forest, peach, dino; neutral pour rétrocompat)
2026-02-20T22:09:11.9441958Z -        valid_themes = ['light', 'dark', 'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral']
2026-02-20T22:09:11.9442098Z +        valid_themes = [
2026-02-20T22:09:11.9442211Z +            "light",
2026-02-20T22:09:11.9442323Z +            "dark",
2026-02-20T22:09:11.9442442Z +            "spatial",
2026-02-20T22:09:11.9442576Z +            "minimalist",
2026-02-20T22:09:11.9442687Z +            "ocean",
2026-02-20T22:09:11.9442794Z +            "dune",
2026-02-20T22:09:11.9442913Z +            "forest",
2026-02-20T22:09:11.9443218Z +            "peach",
2026-02-20T22:09:11.9443336Z +            "dino",
2026-02-20T22:09:11.9443454Z +            "neutral",
2026-02-20T22:09:11.9443570Z +        ]
2026-02-20T22:09:11.9443763Z          if v is not None and v not in valid_themes:
2026-02-20T22:09:11.9444327Z -            raise ValueError(f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}")
2026-02-20T22:09:11.9444467Z -        return v
2026-02-20T22:09:11.9444573Z -
2026-02-20T22:09:11.9444703Z +            raise ValueError(
2026-02-20T22:09:11.9445130Z +                f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}"
2026-02-20T22:09:11.9445247Z +            )
2026-02-20T22:09:11.9445354Z +        return v
2026-02-20T22:09:11.9445453Z  
2026-02-20T22:09:11.9445563Z  
2026-02-20T22:09:11.9445701Z  class UserCreate(UserBase):
2026-02-20T22:09:11.9446134Z      """Schéma pour la création d'un utilisateur (Recrutement d'un Padawan)"""
2026-02-20T22:09:11.9446313Z -    password: str = Field(..., min_length=8, 
2026-02-20T22:09:11.9446956Z -                        description="Mot de passe (8 caractères minimum)")
2026-02-20T22:09:11.9447065Z -    
2026-02-20T22:09:11.9447216Z -    @field_validator('password')
2026-02-20T22:09:11.9447327Z +
2026-02-20T22:09:11.9447462Z +    password: str = Field(
2026-02-20T22:09:11.9447888Z +        ..., min_length=8, description="Mot de passe (8 caractères minimum)"
2026-02-20T22:09:11.9448207Z +    )
2026-02-20T22:09:11.9448313Z +
2026-02-20T22:09:11.9448463Z +    @field_validator("password")
2026-02-20T22:09:11.9448580Z      @classmethod
2026-02-20T22:09:11.9448740Z      def password_strength(cls, v):
2026-02-20T22:09:11.9449101Z          """Vérifie que le mot de passe est suffisamment fort"""
2026-02-20T22:09:11.9449223Z          if len(v) < 8:
2026-02-20T22:09:11.9449677Z              raise ValueError("Le mot de passe doit faire au moins 8 caractères")
2026-02-20T22:09:11.9449789Z @@ -65,41 +91,72 @@
2026-02-20T22:09:11.9449966Z          if not any(char.isupper() for char in v):
2026-02-20T22:09:11.9450309Z              raise ValueError("Le mot de passe doit contenir au moins une majuscule")
2026-02-20T22:09:11.9450431Z          return v
2026-02-20T22:09:11.9450533Z  
2026-02-20T22:09:11.9450633Z  
2026-02-20T22:09:11.9450741Z -
2026-02-20T22:09:11.9450888Z  class UserUpdate(BaseModel):
2026-02-20T22:09:11.9451211Z      """Schéma pour la mise à jour d'un utilisateur"""
2026-02-20T22:09:11.9451318Z +
2026-02-20T22:09:11.9451474Z      email: Optional[EmailStr] = None
2026-02-20T22:09:11.9451618Z      full_name: Optional[str] = None
2026-02-20T22:09:11.9451763Z      password: Optional[str] = None
2026-02-20T22:09:11.9451920Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.9452057Z      grade_level: Optional[int] = None
2026-02-20T22:09:11.9452206Z      learning_style: Optional[str] = None
2026-02-20T22:09:11.9452397Z      preferred_difficulty: Optional[str] = None
2026-02-20T22:09:11.9454968Z -    preferred_theme: Optional[str] = Field(None, description="Thème préféré (spatial, minimalist, ocean, dune, forest, peach, dino)")
2026-02-20T22:09:11.9455727Z -    accessibility_settings: Optional[Dict[str, bool]] = Field(None, description="Paramètres d'accessibilité")
2026-02-20T22:09:11.9455908Z +    preferred_theme: Optional[str] = Field(
2026-02-20T22:09:11.9456025Z +        None,
2026-02-20T22:09:11.9456595Z +        description="Thème préféré (spatial, minimalist, ocean, dune, forest, peach, dino)",
2026-02-20T22:09:11.9456708Z +    )
2026-02-20T22:09:11.9456979Z +    accessibility_settings: Optional[Dict[str, bool]] = Field(
2026-02-20T22:09:11.9457287Z +        None, description="Paramètres d'accessibilité"
2026-02-20T22:09:11.9457398Z +    )
2026-02-20T22:09:11.9457609Z      # Paramètres Settings
2026-02-20T22:09:11.9458679Z -    notification_preferences: Optional[Dict[str, bool]] = Field(None, description="Préférences de notifications (achievements, progress, recommendations, news)")
2026-02-20T22:09:11.9459253Z -    language_preference: Optional[str] = Field(None, description="Langue préférée (fr, en)")
2026-02-20T22:09:11.9459556Z +    notification_preferences: Optional[Dict[str, bool]] = Field(
2026-02-20T22:09:11.9459671Z +        None,
2026-02-20T22:09:11.9460301Z +        description="Préférences de notifications (achievements, progress, recommendations, news)",
2026-02-20T22:09:11.9460413Z +    )
2026-02-20T22:09:11.9460624Z +    language_preference: Optional[str] = Field(
2026-02-20T22:09:11.9460918Z +        None, description="Langue préférée (fr, en)"
2026-02-20T22:09:11.9461028Z +    )
2026-02-20T22:09:11.9461349Z      timezone: Optional[str] = Field(None, description="Fuseau horaire")
2026-02-20T22:09:11.9461711Z      is_public_profile: Optional[bool] = Field(None, description="Profil public")
2026-02-20T22:09:11.9462176Z -    allow_friend_requests: Optional[bool] = Field(None, description="Autoriser les demandes d'amis")
2026-02-20T22:09:11.9462645Z -    show_in_leaderboards: Optional[bool] = Field(None, description="Afficher dans les classements")
2026-02-20T22:09:11.9463752Z -    data_retention_consent: Optional[bool] = Field(None, description="Consentement conservation données")
2026-02-20T22:09:11.9464177Z -    marketing_consent: Optional[bool] = Field(None, description="Consentement marketing")
2026-02-20T22:09:11.9464295Z -    
2026-02-20T22:09:11.9464488Z +    allow_friend_requests: Optional[bool] = Field(
2026-02-20T22:09:11.9464907Z +        None, description="Autoriser les demandes d'amis"
2026-02-20T22:09:11.9465014Z +    )
2026-02-20T22:09:11.9465217Z +    show_in_leaderboards: Optional[bool] = Field(
2026-02-20T22:09:11.9465427Z +        None, description="Afficher dans les classements"
2026-02-20T22:09:11.9465535Z +    )
2026-02-20T22:09:11.9465733Z +    data_retention_consent: Optional[bool] = Field(
2026-02-20T22:09:11.9466098Z +        None, description="Consentement conservation données"
2026-02-20T22:09:11.9466208Z +    )
2026-02-20T22:09:11.9466377Z +    marketing_consent: Optional[bool] = Field(
2026-02-20T22:09:11.9466579Z +        None, description="Consentement marketing"
2026-02-20T22:09:11.9466683Z +    )
2026-02-20T22:09:11.9466784Z +
2026-02-20T22:09:11.9466944Z      @field_validator("preferred_theme")
2026-02-20T22:09:11.9467059Z      @classmethod
2026-02-20T22:09:11.9467201Z      def validate_theme(cls, v):
2026-02-20T22:09:11.9468157Z          # Accepter les thèmes UI (light/dark) et les thèmes visuels (spatial, minimalist, ocean, dune, forest, peach, dino; neutral pour rétrocompat)
2026-02-20T22:09:11.9468724Z -        valid_themes = ['light', 'dark', 'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral']
2026-02-20T22:09:11.9468858Z +        valid_themes = [
2026-02-20T22:09:11.9468971Z +            "light",
2026-02-20T22:09:11.9469087Z +            "dark",
2026-02-20T22:09:11.9469202Z +            "spatial",
2026-02-20T22:09:11.9469327Z +            "minimalist",
2026-02-20T22:09:11.9469445Z +            "ocean",
2026-02-20T22:09:11.9469550Z +            "dune",
2026-02-20T22:09:11.9469675Z +            "forest",
2026-02-20T22:09:11.9469788Z +            "peach",
2026-02-20T22:09:11.9469904Z +            "dino",
2026-02-20T22:09:11.9470016Z +            "neutral",
2026-02-20T22:09:11.9470121Z +        ]
2026-02-20T22:09:11.9470314Z          if v is not None and v not in valid_themes:
2026-02-20T22:09:11.9470879Z -            raise ValueError(f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}")
2026-02-20T22:09:11.9471000Z -        return v
2026-02-20T22:09:11.9471107Z -    
2026-02-20T22:09:11.9471231Z +            raise ValueError(
2026-02-20T22:09:11.9471635Z +                f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}"
2026-02-20T22:09:11.9471744Z +            )
2026-02-20T22:09:11.9471863Z +        return v
2026-02-20T22:09:11.9471966Z +
2026-02-20T22:09:11.9472089Z      model_config = {
2026-02-20T22:09:11.9472238Z          "json_schema_extra": {
2026-02-20T22:09:11.9472358Z              "example": {
2026-02-20T22:09:11.9472502Z                  "email": "luke@jedi.com",
2026-02-20T22:09:11.9472669Z                  "full_name": "Luke Skywalker",
2026-02-20T22:09:11.9472793Z @@ -107,47 +164,44 @@
2026-02-20T22:09:11.9472921Z                  "is_active": True,
2026-02-20T22:09:11.9473235Z                  "grade_level": 5,
2026-02-20T22:09:11.9473395Z                  "learning_style": "visuel",
2026-02-20T22:09:11.9473590Z                  "preferred_difficulty": "chevalier",
2026-02-20T22:09:11.9473748Z                  "preferred_theme": "spatial",
2026-02-20T22:09:11.9474092Z -                "accessibility_settings": {"high_contrast": True, "large_text": False}
2026-02-20T22:09:11.9474446Z +                "accessibility_settings": {"high_contrast": True, "large_text": False},
2026-02-20T22:09:11.9474556Z              }
2026-02-20T22:09:11.9474663Z          },
2026-02-20T22:09:11.9474800Z -        "json_encoders": {
2026-02-20T22:09:11.9474949Z -            dict: lambda v: json.dumps(v)
2026-02-20T22:09:11.9475056Z -        }
2026-02-20T22:09:11.9475501Z +        "json_encoders": {dict: lambda v: json.dumps(v)},
2026-02-20T22:09:11.9475607Z      }
2026-02-20T22:09:11.9475706Z -
2026-02-20T22:09:11.9475811Z  
2026-02-20T22:09:11.9475921Z  
2026-02-20T22:09:11.9476051Z  class User(UserBase):
2026-02-20T22:09:11.9476421Z      """Schéma pour un utilisateur (Membre de l'Ordre Jedi)"""
2026-02-20T22:09:11.9476720Z +
2026-02-20T22:09:11.9476835Z      id: int
2026-02-20T22:09:11.9476952Z      is_active: bool
2026-02-20T22:09:11.9477076Z      created_at: datetime
2026-02-20T22:09:11.9477212Z      updated_at: datetime
2026-02-20T22:09:11.9477316Z  
2026-02-20T22:09:11.9477522Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.9477638Z  
2026-02-20T22:09:11.9477739Z  
2026-02-20T22:09:11.9477845Z -
2026-02-20T22:09:11.9477981Z  class UserInDB(UserBase):
2026-02-20T22:09:11.9478405Z      """Schéma pour un utilisateur en base de données (Archives Jedi)"""
2026-02-20T22:09:11.9478512Z +
2026-02-20T22:09:11.9478620Z      id: int
2026-02-20T22:09:11.9478764Z      is_active: bool
2026-02-20T22:09:11.9478895Z      created_at: datetime
2026-02-20T22:09:11.9479022Z      updated_at: datetime
2026-02-20T22:09:11.9479125Z  
2026-02-20T22:09:11.9479324Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.9479427Z  
2026-02-20T22:09:11.9479529Z  
2026-02-20T22:09:11.9479643Z -
2026-02-20T22:09:11.9479796Z  class UserLogin(BaseModel):
2026-02-20T22:09:11.9480177Z      """Schéma pour l'authentification (Vérification d'identité)"""
2026-02-20T22:09:11.9480287Z +
2026-02-20T22:09:11.9480413Z      username: str
2026-02-20T22:09:11.9480530Z      password: str
2026-02-20T22:09:11.9480632Z -
2026-02-20T22:09:11.9480743Z  
2026-02-20T22:09:11.9480846Z  
2026-02-20T22:09:11.9480994Z  class SchemaUserRole(str, Enum):
2026-02-20T22:09:11.9481127Z      PADAWAN = "padawan"
2026-02-20T22:09:11.9481269Z      CHEVALIER = "chevalier"
2026-02-20T22:09:11.9481385Z @@ -158,36 +212,46 @@
2026-02-20T22:09:11.9481511Z      access_token: str
2026-02-20T22:09:11.9481653Z      refresh_token: str
2026-02-20T22:09:11.9481787Z      token_type: str = "bearer"
2026-02-20T22:09:11.9481932Z      user_id: Optional[int] = None
2026-02-20T22:09:11.9482030Z  
2026-02-20T22:09:11.9482140Z +
2026-02-20T22:09:11.9482307Z  class RefreshTokenResponse(BaseModel):
2026-02-20T22:09:11.9482662Z      """Schéma pour la réponse de rafraîchissement de token"""
2026-02-20T22:09:11.9482790Z +
2026-02-20T22:09:11.9482914Z      access_token: str
2026-02-20T22:09:11.9483264Z      token_type: str = "bearer"
2026-02-20T22:09:11.9483377Z +
2026-02-20T22:09:11.9483493Z  
2026-02-20T22:09:11.9483627Z  class TokenData(BaseModel):
2026-02-20T22:09:11.9483728Z      username: str
2026-02-20T22:09:11.9483868Z      role: Optional[str] = None
2026-02-20T22:09:11.9484009Z      exp: Optional[int] = None
2026-02-20T22:09:11.9484111Z +
2026-02-20T22:09:11.9484221Z  
2026-02-20T22:09:11.9484380Z  class TokenPayload(BaseModel):
2026-02-20T22:09:11.9484493Z      sub: str
2026-02-20T22:09:11.9484605Z      exp: int
2026-02-20T22:09:11.9484775Z      type: str  # "access" ou "refresh"
2026-02-20T22:09:11.9484916Z      role: Optional[str] = None
2026-02-20T22:09:11.9485022Z  
2026-02-20T22:09:11.9485131Z +
2026-02-20T22:09:11.9485312Z  class RefreshTokenRequest(BaseModel):
2026-02-20T22:09:11.9485710Z      """Schéma pour la requête de rafraîchissement de token"""
2026-02-20T22:09:11.9485837Z +
2026-02-20T22:09:11.9486375Z      refresh_token: str = Field(..., description="Token de rafraîchissement à utiliser")
2026-02-20T22:09:11.9486494Z +
2026-02-20T22:09:11.9486597Z  
2026-02-20T22:09:11.9486764Z  class UserPasswordUpdate(BaseModel):
2026-02-20T22:09:11.9487169Z      """Schéma pour la mise à jour du mot de passe d'un utilisateur"""
2026-02-20T22:09:11.9487276Z +
2026-02-20T22:09:11.9487576Z      current_password: str = Field(..., description="Mot de passe actuel")
2026-02-20T22:09:11.9488200Z -    new_password: str = Field(..., min_length=8, description="Nouveau mot de passe (8 caractères minimum)")
2026-02-20T22:09:11.9488611Z -    
2026-02-20T22:09:11.9488773Z -    @field_validator('new_password')
2026-02-20T22:09:11.9488926Z +    new_password: str = Field(
2026-02-20T22:09:11.9489438Z +        ..., min_length=8, description="Nouveau mot de passe (8 caractères minimum)"
2026-02-20T22:09:11.9489553Z +    )
2026-02-20T22:09:11.9489653Z +
2026-02-20T22:09:11.9489810Z +    @field_validator("new_password")
2026-02-20T22:09:11.9490141Z      @classmethod
2026-02-20T22:09:11.9490300Z      def password_strength(cls, v):
2026-02-20T22:09:11.9490666Z          """Vérifie que le mot de passe est suffisamment fort"""
2026-02-20T22:09:11.9490790Z          if len(v) < 8:
2026-02-20T22:09:11.9491239Z              raise ValueError("Le mot de passe doit faire au moins 8 caractères")
2026-02-20T22:09:11.9491360Z @@ -195,13 +259,17 @@
2026-02-20T22:09:11.9491685Z              raise ValueError("Le mot de passe doit contenir au moins un chiffre")
2026-02-20T22:09:11.9491860Z          if not any(char.isupper() for char in v):
2026-02-20T22:09:11.9492211Z              raise ValueError("Le mot de passe doit contenir au moins une majuscule")
2026-02-20T22:09:11.9492336Z          return v
2026-02-20T22:09:11.9492442Z  
2026-02-20T22:09:11.9492546Z +
2026-02-20T22:09:11.9492724Z  class ForgotPasswordRequest(BaseModel):
2026-02-20T22:09:11.9493300Z      """Schéma pour la demande de réinitialisation de mot de passe"""
2026-02-20T22:09:11.9493427Z +
2026-02-20T22:09:11.9493908Z      email: EmailStr = Field(..., description="Adresse email associée au compte")
2026-02-20T22:09:11.9494023Z +
2026-02-20T22:09:11.9494127Z  
2026-02-20T22:09:11.9494306Z  class ForgotPasswordResponse(BaseModel):
2026-02-20T22:09:11.9494682Z      """Schéma pour la réponse de demande de réinitialisation"""
2026-02-20T22:09:11.9494790Z +
2026-02-20T22:09:11.9495076Z      message: str = Field(..., description="Message de confirmation")
2026-02-20T22:09:11.9495345Z      success: bool = Field(..., description="Statut de la demande")
2026-02-20T22:09:12.1599861Z --- /home/runner/work/mathakine/mathakine/app/services/auth_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.1601119Z +++ /home/runner/work/mathakine/mathakine/app/services/auth_service.py	2026-02-20 22:09:12.154114+00:00
2026-02-20T22:09:12.1601942Z @@ -1,143 +1,161 @@
2026-02-20T22:09:12.1602234Z  """
2026-02-20T22:09:12.1603218Z  Service d'authentification pour gérer les utilisateurs et les connexions
2026-02-20T22:09:12.1603859Z  """
2026-02-20T22:09:12.1604120Z +
2026-02-20T22:09:12.1604472Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:12.1604982Z  from typing import Optional
2026-02-20T22:09:12.1605329Z  
2026-02-20T22:09:12.1620838Z  from fastapi import HTTPException, status
2026-02-20T22:09:12.1621367Z  from jose import JWTError, jwt
2026-02-20T22:09:12.1621799Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.1622211Z  
2026-02-20T22:09:12.1622505Z  from app.core.config import settings
2026-02-20T22:09:12.1623225Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.1623926Z -from app.core.security import (create_access_token, decode_token,
2026-02-20T22:09:12.1624600Z -                               get_password_hash, verify_password)
2026-02-20T22:09:12.1625128Z +from app.core.security import (
2026-02-20T22:09:12.1625545Z +    create_access_token,
2026-02-20T22:09:12.1625894Z +    decode_token,
2026-02-20T22:09:12.1626239Z +    get_password_hash,
2026-02-20T22:09:12.1626591Z +    verify_password,
2026-02-20T22:09:12.1626890Z +)
2026-02-20T22:09:12.1627213Z  from app.models.user import User, UserRole
2026-02-20T22:09:12.1627812Z  from app.schemas.user import TokenData, UserCreate, UserUpdate
2026-02-20T22:09:12.1628557Z  from app.utils.db_helpers import adapt_enum_for_db, get_enum_value
2026-02-20T22:09:12.1629118Z  
2026-02-20T22:09:12.1629403Z  logger = get_logger(__name__)
2026-02-20T22:09:12.1629758Z  
2026-02-20T22:09:12.1630005Z +
2026-02-20T22:09:12.1630454Z  def get_user_by_username(db: Session, username: str) -> Optional[User]:
2026-02-20T22:09:12.1631059Z      """
2026-02-20T22:09:12.1632078Z      Récupère un utilisateur par son nom d'utilisateur.
2026-02-20T22:09:12.1632572Z -    
2026-02-20T22:09:12.1632842Z +
2026-02-20T22:09:12.1633280Z      Args:
2026-02-20T22:09:12.1633726Z          db: Session de base de données
2026-02-20T22:09:12.1634320Z          username: Nom d'utilisateur à rechercher
2026-02-20T22:09:12.1635096Z -    
2026-02-20T22:09:12.1635378Z +
2026-02-20T22:09:12.1635642Z      Returns:
2026-02-20T22:09:12.1636055Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1636546Z      """
2026-02-20T22:09:12.1636948Z      user = db.query(User).filter(User.username == username).first()
2026-02-20T22:09:12.1637945Z -    logger.debug(f"Recherche utilisateur {username}: {'trouvé' if user else 'non trouvé'}")
2026-02-20T22:09:12.1638716Z +    logger.debug(
2026-02-20T22:09:12.1639426Z +        f"Recherche utilisateur {username}: {'trouvé' if user else 'non trouvé'}"
2026-02-20T22:09:12.1640083Z +    )
2026-02-20T22:09:12.1640372Z      return user
2026-02-20T22:09:12.1640674Z  
2026-02-20T22:09:12.1640920Z +
2026-02-20T22:09:12.1641344Z  def get_user_by_email(db: Session, email: str) -> Optional[User]:
2026-02-20T22:09:12.1641898Z      """
2026-02-20T22:09:12.1642317Z      Récupère un utilisateur par son email.
2026-02-20T22:09:12.1642755Z -    
2026-02-20T22:09:12.1643197Z +
2026-02-20T22:09:12.1643464Z      Args:
2026-02-20T22:09:12.1643836Z          db: Session de base de données
2026-02-20T22:09:12.1644353Z          email: Email à rechercher
2026-02-20T22:09:12.1644726Z -    
2026-02-20T22:09:12.1644990Z +
2026-02-20T22:09:12.1645237Z      Returns:
2026-02-20T22:09:12.1645649Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1646165Z      """
2026-02-20T22:09:12.1646571Z      return db.query(User).filter(User.email == email).first()
2026-02-20T22:09:12.1647089Z  
2026-02-20T22:09:12.1647324Z +
2026-02-20T22:09:12.1647731Z  def get_user_by_id(db: Session, user_id: int) -> Optional[User]:
2026-02-20T22:09:12.1648282Z      """
2026-02-20T22:09:12.1648688Z      Récupère un utilisateur par son ID.
2026-02-20T22:09:12.1649103Z -    
2026-02-20T22:09:12.1649363Z +
2026-02-20T22:09:12.1649606Z      Args:
2026-02-20T22:09:12.1649990Z          db: Session de base de données
2026-02-20T22:09:12.1650555Z          user_id: ID de l'utilisateur à rechercher
2026-02-20T22:09:12.1651018Z -    
2026-02-20T22:09:12.1651274Z +
2026-02-20T22:09:12.1651516Z      Returns:
2026-02-20T22:09:12.1651924Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1652432Z      """
2026-02-20T22:09:12.1652824Z      return db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.1683234Z  
2026-02-20T22:09:12.1683577Z +
2026-02-20T22:09:12.1684144Z  def authenticate_user(db: Session, username: str, password: str) -> Optional[User]:
2026-02-20T22:09:12.1684853Z      """
2026-02-20T22:09:12.1685606Z      Authentifie un utilisateur en vérifiant son nom d'utilisateur et mot de passe.
2026-02-20T22:09:12.1686310Z -    
2026-02-20T22:09:12.1686581Z +
2026-02-20T22:09:12.1686833Z      Args:
2026-02-20T22:09:12.1687231Z          db: Session de base de données
2026-02-20T22:09:12.1687675Z          username: Nom d'utilisateur
2026-02-20T22:09:12.1688137Z          password: Mot de passe en clair
2026-02-20T22:09:12.1688526Z -    
2026-02-20T22:09:12.1688789Z +
2026-02-20T22:09:12.1689019Z      Returns:
2026-02-20T22:09:12.1689577Z          Instance de User si l'authentification réussit, None sinon
2026-02-20T22:09:12.1690141Z      """
2026-02-20T22:09:12.1690656Z      logger.debug(f"Tentative d'authentification pour l'utilisateur: {username}")
2026-02-20T22:09:12.1691320Z -    
2026-02-20T22:09:12.1691577Z +
2026-02-20T22:09:12.1691891Z      user = get_user_by_username(db, username)
2026-02-20T22:09:12.1692332Z      if not user:
2026-02-20T22:09:12.1692882Z          logger.warning(f"Utilisateur non trouvé: {username}")
2026-02-20T22:09:12.1693603Z          return None
2026-02-20T22:09:12.1693917Z  
2026-02-20T22:09:12.1694473Z      if not user.is_active:
2026-02-20T22:09:12.1695068Z          logger.warning(f"Compte désactivé: {username}")
2026-02-20T22:09:12.1695574Z          return None
2026-02-20T22:09:12.1695878Z -        
2026-02-20T22:09:12.1696146Z +
2026-02-20T22:09:12.1696580Z      logger.debug(f"Utilisateur trouvé: {username}")
2026-02-20T22:09:12.1697286Z -    
2026-02-20T22:09:12.1697547Z +
2026-02-20T22:09:12.1697799Z      try:
2026-02-20T22:09:12.1698219Z          is_valid = verify_password(password, user.hashed_password)
2026-02-20T22:09:12.1699140Z          logger.debug(f"Résultat de la vérification du mot de passe: {is_valid}")
2026-02-20T22:09:12.1699765Z -        
2026-02-20T22:09:12.1700035Z +
2026-02-20T22:09:12.1700308Z          if not is_valid:
2026-02-20T22:09:12.1700879Z              logger.warning(f"Mot de passe incorrect pour l'utilisateur: {username}")
2026-02-20T22:09:12.1701555Z              return None
2026-02-20T22:09:12.1701881Z -            
2026-02-20T22:09:12.1702160Z +
2026-02-20T22:09:12.1702795Z          logger.info(f"Authentification réussie pour l'utilisateur: {username}")
2026-02-20T22:09:12.1703626Z          return user
2026-02-20T22:09:12.1704041Z      except Exception as password_verification_error:
2026-02-20T22:09:12.1705074Z -        logger.error(f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}")
2026-02-20T22:09:12.1705916Z +        logger.error(
2026-02-20T22:09:12.1706695Z +            f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}"
2026-02-20T22:09:12.1707409Z +        )
2026-02-20T22:09:12.1707686Z          return None
2026-02-20T22:09:12.1707981Z  
2026-02-20T22:09:12.1708227Z +
2026-02-20T22:09:12.1708611Z  def create_user(db: Session, user_in: UserCreate) -> User:
2026-02-20T22:09:12.1709132Z      """
2026-02-20T22:09:12.1709508Z      Crée un nouvel utilisateur.
2026-02-20T22:09:12.1709886Z -    
2026-02-20T22:09:12.1710133Z +
2026-02-20T22:09:12.1710385Z      Args:
2026-02-20T22:09:12.1710778Z          db: Session de base de données
2026-02-20T22:09:12.1711400Z          user_in: Données pour la création de l'utilisateur
2026-02-20T22:09:12.1711886Z -    
2026-02-20T22:09:12.1712143Z +
2026-02-20T22:09:12.1712400Z      Returns:
2026-02-20T22:09:12.1712814Z          Instance du nouvel utilisateur créé
2026-02-20T22:09:12.1743509Z -    
2026-02-20T22:09:12.1743810Z +
2026-02-20T22:09:12.1744072Z      Raises:
2026-02-20T22:09:12.1744768Z          HTTPException: Si un utilisateur avec le même nom ou email existe déjà
2026-02-20T22:09:12.1745408Z      """
2026-02-20T22:09:12.1745982Z      # Vérifier si un utilisateur avec le même nom ou email existe déjà
2026-02-20T22:09:12.1747081Z      # Message uniforme (anti-énumération) : ne pas révéler si c'est le username ou l'email qui existe
2026-02-20T22:09:12.1747938Z      if get_user_by_username(db, user_in.username):
2026-02-20T22:09:12.1748851Z -        logger.warning(f"Tentative de création avec nom déjà utilisé: {user_in.username}")
2026-02-20T22:09:12.1749605Z +        logger.warning(
2026-02-20T22:09:12.1750283Z +            f"Tentative de création avec nom déjà utilisé: {user_in.username}"
2026-02-20T22:09:12.1750890Z +        )
2026-02-20T22:09:12.1751181Z          raise HTTPException(
2026-02-20T22:09:12.1751609Z              status_code=status.HTTP_409_CONFLICT,
2026-02-20T22:09:12.1752315Z -            detail="Un compte avec ces informations existe déjà"
2026-02-20T22:09:12.1752852Z -        )
2026-02-20T22:09:12.1753303Z -    
2026-02-20T22:09:12.1753811Z +            detail="Un compte avec ces informations existe déjà",
2026-02-20T22:09:12.1754337Z +        )
2026-02-20T22:09:12.1754586Z +
2026-02-20T22:09:12.1754891Z      if get_user_by_email(db, user_in.email):
2026-02-20T22:09:12.1755752Z -        logger.warning(f"Tentative de création avec email déjà utilisé: {user_in.email}")
2026-02-20T22:09:12.1756471Z +        logger.warning(
2026-02-20T22:09:12.1757124Z +            f"Tentative de création avec email déjà utilisé: {user_in.email}"
2026-02-20T22:09:12.1757994Z +        )
2026-02-20T22:09:12.1758303Z          raise HTTPException(
2026-02-20T22:09:12.1758728Z              status_code=status.HTTP_409_CONFLICT,
2026-02-20T22:09:12.1759426Z -            detail="Un compte avec ces informations existe déjà"
2026-02-20T22:09:12.1759940Z -        )
2026-02-20T22:09:12.1760206Z -    
2026-02-20T22:09:12.1760956Z +            detail="Un compte avec ces informations existe déjà",
2026-02-20T22:09:12.1761485Z +        )
2026-02-20T22:09:12.1761813Z +
2026-02-20T22:09:12.1762536Z      # Par défaut, les nouveaux utilisateurs sont des Padawans sauf spécification contraire
2026-02-20T22:09:12.1763442Z      if user_in.role:
2026-02-20T22:09:12.1764121Z          # Utiliser le rôle fourni (déjà une énumération grâce au schéma Pydantic)
2026-02-20T22:09:12.1764780Z          user_role = user_in.role
2026-02-20T22:09:12.1765161Z      else:
2026-02-20T22:09:12.1765522Z          # Rôle par défaut
2026-02-20T22:09:12.1765898Z          user_role = UserRole.PADAWAN
2026-02-20T22:09:12.1766317Z -    
2026-02-20T22:09:12.1766564Z +
2026-02-20T22:09:12.1767014Z      # Créer l'utilisateur avec les données fournies
2026-02-20T22:09:12.1767534Z      current_time = datetime.now(timezone.utc)
2026-02-20T22:09:12.1767985Z      user = User(
2026-02-20T22:09:12.1768316Z          username=user_in.username,
2026-02-20T22:09:12.1768738Z          email=user_in.email,
2026-02-20T22:09:12.1769109Z @@ -149,253 +167,273 @@
2026-02-20T22:09:12.1769538Z          preferred_difficulty=user_in.preferred_difficulty,
2026-02-20T22:09:12.1770114Z          preferred_theme=user_in.preferred_theme,
2026-02-20T22:09:12.1770699Z          accessibility_settings=user_in.accessibility_settings,
2026-02-20T22:09:12.1771243Z          is_active=True,
2026-02-20T22:09:12.1771589Z          created_at=current_time,
2026-02-20T22:09:12.1771988Z -        updated_at=current_time
2026-02-20T22:09:12.1772392Z +        updated_at=current_time,
2026-02-20T22:09:12.1772752Z      )
2026-02-20T22:09:12.1803223Z -    
2026-02-20T22:09:12.1803556Z +
2026-02-20T22:09:12.1804028Z      # Ajouter l'utilisateur à la base de données
2026-02-20T22:09:12.1804494Z      db.add(user)
2026-02-20T22:09:12.1804800Z      db.commit()
2026-02-20T22:09:12.1805106Z      db.refresh(user)
2026-02-20T22:09:12.1805413Z -    
2026-02-20T22:09:12.1805665Z +
2026-02-20T22:09:12.1806274Z      logger.info(f"Nouvel utilisateur créé: {user.username} (ID: {user.id})")
2026-02-20T22:09:12.1806921Z      return user
2026-02-20T22:09:12.1807207Z  
2026-02-20T22:09:12.1807447Z +
2026-02-20T22:09:12.1807745Z  def create_user_token(user: User) -> dict:
2026-02-20T22:09:12.1808178Z      """
2026-02-20T22:09:12.1808724Z      Crée un token d'accès et un refresh token pour un utilisateur.
2026-02-20T22:09:12.1809273Z -    
2026-02-20T22:09:12.1809524Z +
2026-02-20T22:09:12.1809777Z      Args:
2026-02-20T22:09:12.1810074Z          user: Instance de l'utilisateur
2026-02-20T22:09:12.1810475Z -    
2026-02-20T22:09:12.1810721Z +
2026-02-20T22:09:12.1810962Z      Returns:
2026-02-20T22:09:12.1811859Z          Dictionnaire contenant le token d'accès, le refresh token et leur type
2026-02-20T22:09:12.1812492Z      """
2026-02-20T22:09:12.1813181Z      # Créer un access token avec une durée d'expiration courte
2026-02-20T22:09:12.1813975Z      access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
2026-02-20T22:09:12.1814896Z      refresh_token_expires = timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
2026-02-20T22:09:12.1815520Z -    
2026-02-20T22:09:12.1815782Z +
2026-02-20T22:09:12.1816341Z      # Données pour les tokens - gérer le cas où role est string ou enum
2026-02-20T22:09:12.1817130Z      role_value = user.role if isinstance(user.role, str) else user.role.value
2026-02-20T22:09:12.1817761Z -    token_data = {
2026-02-20T22:09:12.1818084Z -        "sub": user.username, 
2026-02-20T22:09:12.1818466Z -        "role": role_value
2026-02-20T22:09:12.1818799Z -    }
2026-02-20T22:09:12.1819056Z -    
2026-02-20T22:09:12.1819425Z +    token_data = {"sub": user.username, "role": role_value}
2026-02-20T22:09:12.1819935Z +
2026-02-20T22:09:12.1820286Z      # Créer le token d'accès
2026-02-20T22:09:12.1820687Z      access_token = create_access_token(
2026-02-20T22:09:12.1821117Z -        data=token_data,
2026-02-20T22:09:12.1821495Z -        expires_delta=access_token_expires
2026-02-20T22:09:12.1822324Z +        data=token_data, expires_delta=access_token_expires
2026-02-20T22:09:12.1822792Z      )
2026-02-20T22:09:12.1823206Z -    
2026-02-20T22:09:12.1823445Z +
2026-02-20T22:09:12.1823879Z      # Données pour le token de rafraîchissement
2026-02-20T22:09:12.1824364Z      refresh_data = token_data.copy()
2026-02-20T22:09:12.1824803Z      refresh_data["type"] = "refresh"
2026-02-20T22:09:12.1825179Z -    
2026-02-20T22:09:12.1825431Z +
2026-02-20T22:09:12.1825876Z      # Créer le token de rafraîchissement manuellement
2026-02-20T22:09:12.1826373Z      refresh_token = jwt.encode(
2026-02-20T22:09:12.1826753Z -        {
2026-02-20T22:09:12.1827035Z -            **refresh_data,
2026-02-20T22:09:12.1827547Z -            "exp": datetime.now(timezone.utc) + refresh_token_expires
2026-02-20T22:09:12.1828078Z -        },
2026-02-20T22:09:12.1828569Z +        {**refresh_data, "exp": datetime.now(timezone.utc) + refresh_token_expires},
2026-02-20T22:09:12.1829231Z          settings.SECRET_KEY,
2026-02-20T22:09:12.1829648Z -        algorithm=settings.ALGORITHM
2026-02-20T22:09:12.1830088Z +        algorithm=settings.ALGORITHM,
2026-02-20T22:09:12.1830477Z      )
2026-02-20T22:09:12.1830733Z -    
2026-02-20T22:09:12.1830979Z +
2026-02-20T22:09:12.1831411Z      # Vérifier que le refresh_token est bien créé
2026-02-20T22:09:12.1831893Z      if not refresh_token:
2026-02-20T22:09:12.1832669Z -        logger.error(f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1863644Z +        logger.error(
2026-02-20T22:09:12.1864405Z +            f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}"
2026-02-20T22:09:12.1865049Z +        )
2026-02-20T22:09:12.1865326Z      else:
2026-02-20T22:09:12.1866185Z -        logger.debug(f"Refresh token créé (longueur: {len(refresh_token)}) pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1866998Z -    
2026-02-20T22:09:12.1867287Z +        logger.debug(
2026-02-20T22:09:12.1868101Z +            f"Refresh token créé (longueur: {len(refresh_token)}) pour l'utilisateur: {user.username}"
2026-02-20T22:09:12.1868869Z +        )
2026-02-20T22:09:12.1869135Z +
2026-02-20T22:09:12.1869698Z      logger.info(f"Tokens créés pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1870275Z      return {
2026-02-20T22:09:12.1870598Z          "access_token": access_token,
2026-02-20T22:09:12.1871041Z          "refresh_token": refresh_token,
2026-02-20T22:09:12.1871471Z          "token_type": "bearer",
2026-02-20T22:09:12.1871926Z -        "user_id": user.id
2026-02-20T22:09:12.1872282Z +        "user_id": user.id,
2026-02-20T22:09:12.1872625Z      }
2026-02-20T22:09:12.1872871Z  
2026-02-20T22:09:12.1873554Z +
2026-02-20T22:09:12.1873993Z  def refresh_access_token(db: Session, refresh_token: str) -> dict:
2026-02-20T22:09:12.1874571Z      """
2026-02-20T22:09:12.1875261Z      Rafraîchit un token d'accès JWT en utilisant un token de rafraîchissement valide.
2026-02-20T22:09:12.1875944Z -    
2026-02-20T22:09:12.1876214Z +
2026-02-20T22:09:12.1876479Z      Args:
2026-02-20T22:09:12.1876874Z          db: Session de base de données
2026-02-20T22:09:12.1877494Z          refresh_token: Token de rafraîchissement à valider
2026-02-20T22:09:12.1877993Z -    
2026-02-20T22:09:12.1878247Z +
2026-02-20T22:09:12.1878496Z      Returns:
2026-02-20T22:09:12.1879143Z          Dictionnaire contenant le nouveau token d'accès JWT et le type de token
2026-02-20T22:09:12.1879785Z -        
2026-02-20T22:09:12.1880047Z +
2026-02-20T22:09:12.1880292Z      Raises:
2026-02-20T22:09:12.1880991Z          HTTPException: Si le token est invalide, expiré, ou si l'utilisateur n'existe plus
2026-02-20T22:09:12.1881799Z          RuntimeError: Si une erreur inattendue se produit
2026-02-20T22:09:12.1882316Z      """
2026-02-20T22:09:12.1882571Z      try:
2026-02-20T22:09:12.1882854Z          # Log pour diagnostic
2026-02-20T22:09:12.1883887Z -        logger.debug(f"Tentative de décodage du refresh_token (longueur: {len(refresh_token)})")
2026-02-20T22:09:12.1884636Z -        
2026-02-20T22:09:12.1885221Z +        logger.debug(
2026-02-20T22:09:12.1885936Z +            f"Tentative de décodage du refresh_token (longueur: {len(refresh_token)})"
2026-02-20T22:09:12.1886594Z +        )
2026-02-20T22:09:12.1886854Z +
2026-02-20T22:09:12.1887328Z          # Décoder le token avec vérification de l'expiration
2026-02-20T22:09:12.1888118Z          # Si le token est expiré, jwt.ExpiredSignatureError sera levée
2026-02-20T22:09:12.1888686Z          try:
2026-02-20T22:09:12.1888995Z              payload = jwt.decode(
2026-02-20T22:09:12.1889397Z -                refresh_token, 
2026-02-20T22:09:12.1889802Z -                settings.SECRET_KEY, 
2026-02-20T22:09:12.1890248Z +                refresh_token,
2026-02-20T22:09:12.1890702Z +                settings.SECRET_KEY,
2026-02-20T22:09:12.1891156Z                  algorithms=[settings.ALGORITHM],
2026-02-20T22:09:12.1891661Z -                options={"verify_exp": True}
2026-02-20T22:09:12.1892133Z +                options={"verify_exp": True},
2026-02-20T22:09:12.1892570Z              )
2026-02-20T22:09:12.1892885Z          except JWTError as decode_error:
2026-02-20T22:09:12.1923902Z              logger.error(f"Erreur de décodage JWT: {str(decode_error)}")
2026-02-20T22:09:12.1925207Z -            logger.debug(f"Token reçu (premiers 50 caractères): {refresh_token[:50] if len(refresh_token) > 50 else refresh_token}")
2026-02-20T22:09:12.1926174Z +            logger.debug(
2026-02-20T22:09:12.1927141Z +                f"Token reçu (premiers 50 caractères): {refresh_token[:50] if len(refresh_token) > 50 else refresh_token}"
2026-02-20T22:09:12.1927967Z +            )
2026-02-20T22:09:12.1928289Z              raise HTTPException(
2026-02-20T22:09:12.1928774Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1929439Z -                detail="Token JWT invalide ou malformé"
2026-02-20T22:09:12.1930080Z +                detail="Token JWT invalide ou malformé",
2026-02-20T22:09:12.1930546Z              )
2026-02-20T22:09:12.1930957Z          except jwt.InvalidSignatureError as sig_error:
2026-02-20T22:09:12.1931600Z              logger.error(f"Signature JWT invalide: {str(sig_error)}")
2026-02-20T22:09:12.1932745Z -            logger.warning("Le SECRET_KEY utilisé pour décoder ne correspond pas à celui utilisé pour encoder")
2026-02-20T22:09:12.1933762Z +            logger.warning(
2026-02-20T22:09:12.1934605Z +                "Le SECRET_KEY utilisé pour décoder ne correspond pas à celui utilisé pour encoder"
2026-02-20T22:09:12.1935309Z +            )
2026-02-20T22:09:12.1935631Z              raise HTTPException(
2026-02-20T22:09:12.1936099Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1936937Z -                detail="Token invalide (signature incorrecte)"
2026-02-20T22:09:12.1937452Z -            )
2026-02-20T22:09:12.1937724Z -        
2026-02-20T22:09:12.1938107Z +                detail="Token invalide (signature incorrecte)",
2026-02-20T22:09:12.1938594Z +            )
2026-02-20T22:09:12.1938886Z +
2026-02-20T22:09:12.1939385Z          # Vérifier que c'est bien un token de rafraîchissement
2026-02-20T22:09:12.1939956Z          token_type = payload.get("type")
2026-02-20T22:09:12.1940622Z          logger.debug(f"Type de token décodé: {token_type}")
2026-02-20T22:09:12.1941162Z          if token_type != "refresh":
2026-02-20T22:09:12.1942224Z -            logger.warning(f"Tentative de rafraîchissement avec un token non-refresh: {token_type}. Payload: {payload}")
2026-02-20T22:09:12.1943310Z +            logger.warning(
2026-02-20T22:09:12.1944236Z +                f"Tentative de rafraîchissement avec un token non-refresh: {token_type}. Payload: {payload}"
2026-02-20T22:09:12.1945037Z +            )
2026-02-20T22:09:12.1945356Z              raise HTTPException(
2026-02-20T22:09:12.1945826Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1946503Z -                detail=f"Token de rafraîchissement invalide (type: {token_type})"
2026-02-20T22:09:12.1947010Z -            )
2026-02-20T22:09:12.1947457Z -        
2026-02-20T22:09:12.1947954Z +                detail=f"Token de rafraîchissement invalide (type: {token_type})",
2026-02-20T22:09:12.1948464Z +            )
2026-02-20T22:09:12.1948695Z +
2026-02-20T22:09:12.1948941Z          # Extraire les informations utilisateur
2026-02-20T22:09:12.1949345Z          username = payload.get("sub")
2026-02-20T22:09:12.1949703Z          if not username:
2026-02-20T22:09:12.1950343Z              logger.warning("Tentative de rafraîchissement avec un token sans sujet")
2026-02-20T22:09:12.1950980Z              raise HTTPException(
2026-02-20T22:09:12.1951366Z -                status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1951810Z -                detail="Token invalide"
2026-02-20T22:09:12.1952151Z -            )
2026-02-20T22:09:12.1952411Z -        
2026-02-20T22:09:12.1952845Z +                status_code=status.HTTP_401_UNAUTHORIZED, detail="Token invalide"
2026-02-20T22:09:12.1983747Z +            )
2026-02-20T22:09:12.1984072Z +
2026-02-20T22:09:12.1984541Z          # Vérifier que l'utilisateur existe toujours
2026-02-20T22:09:12.1985094Z          user = get_user_by_username(db, username)
2026-02-20T22:09:12.1985554Z          if not user:
2026-02-20T22:09:12.1986466Z -            logger.warning(f"Tentative de rafraîchissement pour un utilisateur qui n'existe pas: {username}")
2026-02-20T22:09:12.1987322Z +            logger.warning(
2026-02-20T22:09:12.1988129Z +                f"Tentative de rafraîchissement pour un utilisateur qui n'existe pas: {username}"
2026-02-20T22:09:12.1988847Z +            )
2026-02-20T22:09:12.1989184Z              raise HTTPException(
2026-02-20T22:09:12.1989675Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1990295Z -                detail="Utilisateur non trouvé"
2026-02-20T22:09:12.1990748Z -            )
2026-02-20T22:09:12.1991023Z -        
2026-02-20T22:09:12.1991454Z +                detail="Utilisateur non trouvé",
2026-02-20T22:09:12.1991882Z +            )
2026-02-20T22:09:12.1992182Z +
2026-02-20T22:09:12.1992631Z          # Vérifier que l'utilisateur est toujours actif
2026-02-20T22:09:12.1993312Z          if not user.is_active:
2026-02-20T22:09:12.1994198Z -            logger.warning(f"Tentative de rafraîchissement pour un utilisateur inactif: {username}")
2026-02-20T22:09:12.1994979Z +            logger.warning(
2026-02-20T22:09:12.1995711Z +                f"Tentative de rafraîchissement pour un utilisateur inactif: {username}"
2026-02-20T22:09:12.1996360Z +            )
2026-02-20T22:09:12.1996673Z              raise HTTPException(
2026-02-20T22:09:12.1997126Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1998034Z -                detail="Compte utilisateur désactivé"
2026-02-20T22:09:12.1998489Z -            )
2026-02-20T22:09:12.1998771Z -        
2026-02-20T22:09:12.1999220Z +                detail="Compte utilisateur désactivé",
2026-02-20T22:09:12.1999672Z +            )
2026-02-20T22:09:12.1999946Z +
2026-02-20T22:09:12.2000544Z          # Générer un nouveau token d'accès ET un nouveau refresh token (rotation)
2026-02-20T22:09:12.2001497Z          # Best-practice: chaque refresh invalide l'ancien en émettant un nouveau
2026-02-20T22:09:12.2002273Z          # Gérer le cas où role est string ou enum
2026-02-20T22:09:12.2002928Z          role_value = user.role if isinstance(user.role, str) else user.role.value
2026-02-20T22:09:12.2003798Z          new_token_data = create_user_token(user)
2026-02-20T22:09:12.2004241Z          return {
2026-02-20T22:09:12.2004660Z              "access_token": new_token_data.get("access_token"),
2026-02-20T22:09:12.2005645Z -            "refresh_token": new_token_data.get("refresh_token"),  # Rotation: nouveau à chaque refresh
2026-02-20T22:09:12.2006462Z +            "refresh_token": new_token_data.get(
2026-02-20T22:09:12.2006919Z +                "refresh_token"
2026-02-20T22:09:12.2007446Z +            ),  # Rotation: nouveau à chaque refresh
2026-02-20T22:09:12.2007914Z              "token_type": "bearer",
2026-02-20T22:09:12.2008523Z          }
2026-02-20T22:09:12.2008783Z -        
2026-02-20T22:09:12.2009044Z -        
2026-02-20T22:09:12.2009306Z +
2026-02-20T22:09:12.2009738Z          # ... (le code précédent reste le même) ...
2026-02-20T22:09:12.2010189Z -        
2026-02-20T22:09:12.2010439Z +
2026-02-20T22:09:12.2010740Z      except jwt.ExpiredSignatureError:
2026-02-20T22:09:12.2011489Z          logger.warning("Tentative de rafraîchissement avec un token expiré")
2026-02-20T22:09:12.2012135Z          raise HTTPException(
2026-02-20T22:09:12.2012574Z              status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2043833Z -            detail="Token de rafraîchissement expiré"
2026-02-20T22:09:12.2044493Z +            detail="Token de rafraîchissement expiré",
2026-02-20T22:09:12.2044944Z          )
2026-02-20T22:09:12.2045267Z      except JWTError as jwt_err:
2026-02-20T22:09:12.2046350Z -        logger.warning(f"Tentative de rafraîchissement avec un token JWT invalide: {type(jwt_err).__name__}: {str(jwt_err)}")
2026-02-20T22:09:12.2047342Z -        raise HTTPException(
2026-02-20T22:09:12.2047795Z -            status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2048292Z -            detail="Token invalide"
2026-02-20T22:09:12.2048714Z +        logger.warning(
2026-02-20T22:09:12.2049625Z +            f"Tentative de rafraîchissement avec un token JWT invalide: {type(jwt_err).__name__}: {str(jwt_err)}"
2026-02-20T22:09:12.2050442Z +        )
2026-02-20T22:09:12.2050733Z +        raise HTTPException(
2026-02-20T22:09:12.2051301Z +            status_code=status.HTTP_401_UNAUTHORIZED, detail="Token invalide"
2026-02-20T22:09:12.2051914Z          )
2026-02-20T22:09:12.2052214Z      except HTTPException:
2026-02-20T22:09:12.2053207Z          # Re-lancer les HTTPException sans les modifier (elles ont déjà le bon code de statut)
2026-02-20T22:09:12.2053944Z          raise
2026-02-20T22:09:12.2054253Z      except RuntimeError:
2026-02-20T22:09:12.2054854Z          # Ne pas intercepter les RuntimeError pour permettre aux tests de les attraper
2026-02-20T22:09:12.2055880Z          logger.error("Erreur RuntimeError lors du rafraîchissement du token")
2026-02-20T22:09:12.2056507Z          raise
2026-02-20T22:09:12.2056852Z      except Exception as token_refresh_error:
2026-02-20T22:09:12.2057736Z -        logger.error(f"Erreur lors du rafraîchissement du token: {str(token_refresh_error)}")
2026-02-20T22:09:12.2058483Z +        logger.error(
2026-02-20T22:09:12.2059160Z +            f"Erreur lors du rafraîchissement du token: {str(token_refresh_error)}"
2026-02-20T22:09:12.2059783Z +        )
2026-02-20T22:09:12.2060085Z          raise HTTPException(
2026-02-20T22:09:12.2060812Z              status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
2026-02-20T22:09:12.2061386Z -            detail="Erreur interne du serveur"
2026-02-20T22:09:12.2061882Z -        )
2026-02-20T22:09:12.2062206Z +            detail="Erreur interne du serveur",
2026-02-20T22:09:12.2062641Z +        )
2026-02-20T22:09:12.2062909Z +
2026-02-20T22:09:12.2063316Z  
2026-02-20T22:09:12.2063764Z  def update_user(db: Session, user: User, user_in: UserUpdate) -> User:
2026-02-20T22:09:12.2064360Z      """
2026-02-20T22:09:12.2064866Z      Met à jour les informations d'un utilisateur existant.
2026-02-20T22:09:12.2065377Z -    
2026-02-20T22:09:12.2065636Z +
2026-02-20T22:09:12.2065877Z      Args:
2026-02-20T22:09:12.2066261Z          db: Session de base de données
2026-02-20T22:09:12.2066867Z          user: Instance de l'utilisateur à mettre à jour
2026-02-20T22:09:12.2067485Z          user_in: Données pour la mise à jour
2026-02-20T22:09:12.2067913Z -    
2026-02-20T22:09:12.2068183Z +
2026-02-20T22:09:12.2068426Z      Returns:
2026-02-20T22:09:12.2068847Z          Instance de l'utilisateur mise à jour
2026-02-20T22:09:12.2069273Z      """
2026-02-20T22:09:12.2069685Z      # Mettre à jour le mot de passe si fourni
2026-02-20T22:09:12.2070133Z      if user_in.password:
2026-02-20T22:09:12.2070637Z          user.hashed_password = get_password_hash(user_in.password)
2026-02-20T22:09:12.2071394Z -    
2026-02-20T22:09:12.2071654Z +
2026-02-20T22:09:12.2072064Z      # Mettre à jour les autres champs si fournis
2026-02-20T22:09:12.2072751Z      update_data = user_in.model_dump(exclude_unset=True, exclude={"password"})
2026-02-20T22:09:12.2103717Z      for field, value in update_data.items():
2026-02-20T22:09:12.2104202Z          if value is not None:
2026-02-20T22:09:12.2104613Z              setattr(user, field, value)
2026-02-20T22:09:12.2105012Z -    
2026-02-20T22:09:12.2105276Z +
2026-02-20T22:09:12.2105527Z      db.add(user)
2026-02-20T22:09:12.2105833Z      db.commit()
2026-02-20T22:09:12.2106152Z      db.refresh(user)
2026-02-20T22:09:12.2106461Z -    
2026-02-20T22:09:12.2106708Z +
2026-02-20T22:09:12.2107324Z      logger.info(f"Utilisateur mis à jour: {user.username} (ID: {user.id})")
2026-02-20T22:09:12.2107954Z      return user
2026-02-20T22:09:12.2108241Z  
2026-02-20T22:09:12.2108868Z -def update_user_password(db: Session, user: User, current_password: str, new_password: str) -> bool:
2026-02-20T22:09:12.2109659Z +
2026-02-20T22:09:12.2109802Z +def update_user_password(
2026-02-20T22:09:12.2110094Z +    db: Session, user: User, current_password: str, new_password: str
2026-02-20T22:09:12.2110208Z +) -> bool:
2026-02-20T22:09:12.2110314Z      """
2026-02-20T22:09:12.2110875Z      Met à jour le mot de passe d'un utilisateur après vérification du mot de passe actuel.
2026-02-20T22:09:12.2110985Z -    
2026-02-20T22:09:12.2111088Z +
2026-02-20T22:09:12.2111204Z      Args:
2026-02-20T22:09:12.2111429Z          db: Session de base de données
2026-02-20T22:09:12.2111583Z          user: Instance de l'utilisateur
2026-02-20T22:09:12.2111978Z          current_password: Mot de passe actuel (pour vérification)
2026-02-20T22:09:12.2112152Z          new_password: Nouveau mot de passe
2026-02-20T22:09:12.2112253Z -    
2026-02-20T22:09:12.2112354Z +
2026-02-20T22:09:12.2112471Z      Returns:
2026-02-20T22:09:12.2112753Z          True si la mise à jour a réussi, False sinon
2026-02-20T22:09:12.2112878Z -        
2026-02-20T22:09:12.2113150Z +
2026-02-20T22:09:12.2113271Z      Raises:
2026-02-20T22:09:12.2113528Z          HTTPException: Si le mot de passe actuel est incorrect
2026-02-20T22:09:12.2113635Z      """
2026-02-20T22:09:12.2113879Z      # Vérifier le mot de passe actuel
2026-02-20T22:09:12.2114170Z      if not verify_password(current_password, user.hashed_password):
2026-02-20T22:09:12.2114771Z -        logger.warning(f"Tentative de changement de mot de passe avec mot de passe actuel incorrect pour {user.username}")
2026-02-20T22:09:12.2114905Z +        logger.warning(
2026-02-20T22:09:12.2115651Z +            f"Tentative de changement de mot de passe avec mot de passe actuel incorrect pour {user.username}"
2026-02-20T22:09:12.2115764Z +        )
2026-02-20T22:09:12.2115908Z          raise HTTPException(
2026-02-20T22:09:12.2116106Z              status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2116287Z -            detail="Mot de passe actuel incorrect"
2026-02-20T22:09:12.2116404Z -        )
2026-02-20T22:09:12.2116514Z -    
2026-02-20T22:09:12.2116697Z +            detail="Mot de passe actuel incorrect",
2026-02-20T22:09:12.2116800Z +        )
2026-02-20T22:09:12.2116907Z +
2026-02-20T22:09:12.2117206Z      # Mettre à jour avec le nouveau mot de passe
2026-02-20T22:09:12.2117451Z      user.hashed_password = get_password_hash(new_password)
2026-02-20T22:09:12.2117643Z      user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:12.2117753Z -    
2026-02-20T22:09:12.2117853Z +
2026-02-20T22:09:12.2117968Z      db.add(user)
2026-02-20T22:09:12.2118083Z      db.commit()
2026-02-20T22:09:12.2118224Z      db.refresh(user)
2026-02-20T22:09:12.2118326Z -    
2026-02-20T22:09:12.2118425Z +
2026-02-20T22:09:12.2118902Z      logger.info(f"Mot de passe mis à jour pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.2119020Z -    return True 
2026-02-20T22:09:12.2119162Z \ No newline at end of file
2026-02-20T22:09:12.2119480Z +    return True
2026-02-20T22:09:12.2119934Z would reformat /home/runner/work/mathakine/mathakine/app/services/auth_service.py
2026-02-20T22:09:12.5230905Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.5234542Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_service.py	2026-02-20 22:09:12.516193+00:00
2026-02-20T22:09:12.5236953Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_service.py
2026-02-20T22:09:12.5240075Z @@ -4,23 +4,26 @@
2026-02-20T22:09:12.5242642Z  Ce service remplace challenge_service_translations.py qui utilisait du raw SQL.
2026-02-20T22:09:12.5252347Z  Utilise uniquement SQLAlchemy ORM pour la maintenabilité.
2026-02-20T22:09:12.5255599Z  
2026-02-20T22:09:12.5257988Z  Créé : Phase 4 (20 Nov 2025)
2026-02-20T22:09:12.5260824Z  """
2026-02-20T22:09:12.5261097Z +
2026-02-20T22:09:12.5262667Z  from datetime import datetime, timezone
2026-02-20T22:09:12.5264607Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:12.5266284Z  
2026-02-20T22:09:12.5267846Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.5269538Z  
2026-02-20T22:09:12.5272137Z  logger = get_logger(__name__)
2026-02-20T22:09:12.5306007Z  from sqlalchemy import and_, or_, func, case
2026-02-20T22:09:12.5306662Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.5307059Z  
2026-02-20T22:09:12.5307481Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:12.5308131Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:12.5308656Z -                                        LogicChallengeType)
2026-02-20T22:09:12.5309099Z -
2026-02-20T22:09:12.5309408Z +from app.models.logic_challenge import (
2026-02-20T22:09:12.5309839Z +    AgeGroup,
2026-02-20T22:09:12.5310129Z +    LogicChallenge,
2026-02-20T22:09:12.5310456Z +    LogicChallengeAttempt,
2026-02-20T22:09:12.5310819Z +    LogicChallengeType,
2026-02-20T22:09:12.5311146Z +)
2026-02-20T22:09:12.5311381Z  
2026-02-20T22:09:12.5311687Z  # ============================================================================
2026-02-20T22:09:12.5312401Z  # MAPPING DES GROUPES D'ÂGE (après migration ENUM)
2026-02-20T22:09:12.5312945Z  # ============================================================================
2026-02-20T22:09:12.5313904Z  # PostgreSQL ENUM `agegroup` contient (après migration):
2026-02-20T22:09:12.5314406Z @@ -36,16 +39,16 @@
2026-02-20T22:09:12.5314754Z  # ============================================================================
2026-02-20T22:09:12.5315206Z  
2026-02-20T22:09:12.5315743Z  # Mapping des groupes d'âge frontend vers les valeurs ENUM PostgreSQL
2026-02-20T22:09:12.5316708Z  FRONTEND_TO_DB_AGE_GROUP = {
2026-02-20T22:09:12.5317340Z      # Groupes d'âge frontend → valeurs DB (mapping 1:1 après migration)
2026-02-20T22:09:12.5318079Z -    "6-8": AgeGroup.GROUP_6_8,        # 6-8 ans → GROUP_6_8
2026-02-20T22:09:12.5318756Z -    "9-11": AgeGroup.GROUP_10_12,     # 9-11 ans → GROUP_10_12
2026-02-20T22:09:12.5319464Z -    "12-14": AgeGroup.GROUP_13_15,    # 12-14 ans → GROUP_13_15
2026-02-20T22:09:12.5320151Z -    "15-17": AgeGroup.GROUP_15_17,    # 15-17 ans → GROUP_15_17
2026-02-20T22:09:12.5320791Z -    "adulte": AgeGroup.ADULT,         # adulte → ADULT
2026-02-20T22:09:12.5321450Z -    "tous-ages": AgeGroup.ALL_AGES,   # tous âges → ALL_AGES
2026-02-20T22:09:12.5322087Z +    "6-8": AgeGroup.GROUP_6_8,  # 6-8 ans → GROUP_6_8
2026-02-20T22:09:12.5322715Z +    "9-11": AgeGroup.GROUP_10_12,  # 9-11 ans → GROUP_10_12
2026-02-20T22:09:12.5323532Z +    "12-14": AgeGroup.GROUP_13_15,  # 12-14 ans → GROUP_13_15
2026-02-20T22:09:12.5324220Z +    "15-17": AgeGroup.GROUP_15_17,  # 15-17 ans → GROUP_15_17
2026-02-20T22:09:12.5324830Z +    "adulte": AgeGroup.ADULT,  # adulte → ADULT
2026-02-20T22:09:12.5325453Z +    "tous-ages": AgeGroup.ALL_AGES,  # tous âges → ALL_AGES
2026-02-20T22:09:12.5326066Z      # Anciennes valeurs (rétrocompatibilité)
2026-02-20T22:09:12.5326717Z      "10-12": AgeGroup.GROUP_10_12,
2026-02-20T22:09:12.5327113Z      "13-15": AgeGroup.GROUP_13_15,
2026-02-20T22:09:12.5327497Z      "all": AgeGroup.ALL_AGES,
2026-02-20T22:09:12.5327951Z      # Valeurs legacy qui pourraient arriver (code ancien)
2026-02-20T22:09:12.5328425Z @@ -63,76 +66,76 @@
2026-02-20T22:09:12.5328728Z      "all_ages": AgeGroup.ALL_AGES,
2026-02-20T22:09:12.5329093Z  }
2026-02-20T22:09:12.5329318Z  
2026-02-20T22:09:12.5329757Z  # Mapping inverse : ENUM PostgreSQL vers format frontend pour affichage
2026-02-20T22:09:12.5330358Z  DB_TO_FRONTEND_AGE_GROUP = {
2026-02-20T22:09:12.5330921Z -    AgeGroup.GROUP_6_8: "6-8",        # GROUP_6_8 → 6-8 ans
2026-02-20T22:09:12.5331627Z -    AgeGroup.GROUP_10_12: "9-11",     # GROUP_10_12 → 9-11 ans
2026-02-20T22:09:12.5332347Z -    AgeGroup.GROUP_13_15: "12-14",    # GROUP_13_15 → 12-14 ans
2026-02-20T22:09:12.5333234Z -    AgeGroup.GROUP_15_17: "15-17",    # GROUP_15_17 → 15-17 ans
2026-02-20T22:09:12.5333942Z -    AgeGroup.ADULT: "adulte",         # ADULT → adulte
2026-02-20T22:09:12.5334666Z -    AgeGroup.ALL_AGES: "tous-ages",   # ALL_AGES → tous âges
2026-02-20T22:09:12.5335357Z +    AgeGroup.GROUP_6_8: "6-8",  # GROUP_6_8 → 6-8 ans
2026-02-20T22:09:12.5336008Z +    AgeGroup.GROUP_10_12: "9-11",  # GROUP_10_12 → 9-11 ans
2026-02-20T22:09:12.5336727Z +    AgeGroup.GROUP_13_15: "12-14",  # GROUP_13_15 → 12-14 ans
2026-02-20T22:09:12.5337447Z +    AgeGroup.GROUP_15_17: "15-17",  # GROUP_15_17 → 15-17 ans
2026-02-20T22:09:12.5338096Z +    AgeGroup.ADULT: "adulte",  # ADULT → adulte
2026-02-20T22:09:12.5338754Z +    AgeGroup.ALL_AGES: "tous-ages",  # ALL_AGES → tous âges
2026-02-20T22:09:12.5339271Z  }
2026-02-20T22:09:12.5339578Z  
2026-02-20T22:09:12.5339971Z  # Alias pour compatibilité (même contenu)
2026-02-20T22:09:12.5340547Z  DB_TO_FRONTEND_AGE_GROUP_EXTENDED = DB_TO_FRONTEND_AGE_GROUP
2026-02-20T22:09:12.5341066Z  
2026-02-20T22:09:12.5341296Z  
2026-02-20T22:09:12.5341686Z  def normalize_age_group_for_db(age_group: str) -> AgeGroup:
2026-02-20T22:09:12.5342212Z      """
2026-02-20T22:09:12.5342771Z      Convertit un groupe d'âge frontend vers une valeur ENUM PostgreSQL.
2026-02-20T22:09:12.5343581Z -    
2026-02-20T22:09:12.5343832Z +
2026-02-20T22:09:12.5344073Z      Args:
2026-02-20T22:09:12.5344535Z          age_group: Groupe d'âge (format frontend ou ENUM)
2026-02-20T22:09:12.5345011Z -    
2026-02-20T22:09:12.5345253Z +
2026-02-20T22:09:12.5345495Z      Returns:
2026-02-20T22:09:12.5345846Z          Valeur AgeGroup compatible avec PostgreSQL
2026-02-20T22:09:12.5346320Z      """
2026-02-20T22:09:12.5346589Z      if not age_group:
2026-02-20T22:09:12.5346939Z          return AgeGroup.ALL_AGES
2026-02-20T22:09:12.5347535Z -    
2026-02-20T22:09:12.5347785Z +
2026-02-20T22:09:12.5348049Z      # Normaliser la casse
2026-02-20T22:09:12.5348455Z      age_group_lower = age_group.lower().strip()
2026-02-20T22:09:12.5348895Z -    
2026-02-20T22:09:12.5349131Z +
2026-02-20T22:09:12.5349404Z      # Chercher dans le mapping
2026-02-20T22:09:12.5350040Z      if age_group_lower in FRONTEND_TO_DB_AGE_GROUP:
2026-02-20T22:09:12.5350614Z          return FRONTEND_TO_DB_AGE_GROUP[age_group_lower]
2026-02-20T22:09:12.5351085Z -    
2026-02-20T22:09:12.5351332Z +
2026-02-20T22:09:12.5351767Z      # Si c'est déjà une valeur AgeGroup, la retourner
2026-02-20T22:09:12.5352235Z      try:
2026-02-20T22:09:12.5352541Z          return AgeGroup(age_group_lower)
2026-02-20T22:09:12.5353133Z      except ValueError:
2026-02-20T22:09:12.5353478Z          pass
2026-02-20T22:09:12.5353743Z -    
2026-02-20T22:09:12.5353993Z +
2026-02-20T22:09:12.5354255Z      # Fallback vers ALL_AGES
2026-02-20T22:09:12.5355015Z      logger.warning(f"Groupe d'âge non reconnu: {age_group}, utilisation de ALL_AGES")
2026-02-20T22:09:12.5355732Z      return AgeGroup.ALL_AGES
2026-02-20T22:09:12.5356088Z  
2026-02-20T22:09:12.5356315Z  
2026-02-20T22:09:12.5356674Z  def normalize_age_group_for_frontend(age_group) -> str:
2026-02-20T22:09:12.5357181Z      """
2026-02-20T22:09:12.5357606Z      Convertit une valeur ENUM PostgreSQL vers le format frontend.
2026-02-20T22:09:12.5358170Z -    
2026-02-20T22:09:12.5358406Z +
2026-02-20T22:09:12.5358638Z      Args:
2026-02-20T22:09:12.5359212Z          age_group: Valeur AgeGroup de la DB (peut être AgeGroup, str, ou None)
2026-02-20T22:09:12.5359783Z -    
2026-02-20T22:09:12.5360036Z +
2026-02-20T22:09:12.5360295Z      Returns:
2026-02-20T22:09:12.5360643Z          String au format frontend (6-8, 9-11, etc.)
2026-02-20T22:09:12.5361071Z      """
2026-02-20T22:09:12.5361349Z      if not age_group:
2026-02-20T22:09:12.5361680Z          return "tous-ages"
2026-02-20T22:09:12.5362022Z -    
2026-02-20T22:09:12.5362284Z +
2026-02-20T22:09:12.5362704Z      # Si c'est une string, essayer de la convertir en AgeGroup d'abord
2026-02-20T22:09:12.5363454Z      if isinstance(age_group, str):
2026-02-20T22:09:12.5364130Z          # Vérifier d'abord dans le mapping étendu par valeur string
2026-02-20T22:09:12.5364729Z          age_group_lower = age_group.lower()
2026-02-20T22:09:12.5365389Z          for ag_enum, frontend_val in DB_TO_FRONTEND_AGE_GROUP_EXTENDED.items():
2026-02-20T22:09:12.5366205Z              if ag_enum.value == age_group_lower or ag_enum.name == age_group.upper():
2026-02-20T22:09:12.5366848Z                  return frontend_val
2026-02-20T22:09:12.5367245Z          # Fallback
2026-02-20T22:09:12.5367564Z          return "tous-ages"
2026-02-20T22:09:12.5367909Z -    
2026-02-20T22:09:12.5368160Z +
2026-02-20T22:09:12.5368636Z      # Si c'est un enum, utiliser le mapping étendu
2026-02-20T22:09:12.5369278Z      return DB_TO_FRONTEND_AGE_GROUP_EXTENDED.get(age_group, "tous-ages")
2026-02-20T22:09:12.5369886Z  
2026-02-20T22:09:12.5370143Z  
2026-02-20T22:09:12.5370411Z  def create_challenge(
2026-02-20T22:09:12.5370742Z @@ -152,11 +155,11 @@
2026-02-20T22:09:12.5371082Z      creator_id: Optional[int] = None,
2026-02-20T22:09:12.5371583Z      generation_parameters: Optional[Dict] = None,
2026-02-20T22:09:12.5372088Z  ) -> LogicChallenge:
2026-02-20T22:09:12.5372424Z      """
2026-02-20T22:09:12.5372836Z      Créer un nouveau challenge.
2026-02-20T22:09:12.5373410Z -    
2026-02-20T22:09:12.5373662Z +
2026-02-20T22:09:12.5373914Z      Args:
2026-02-20T22:09:12.5374202Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5374593Z          title: Titre du challenge
2026-02-20T22:09:12.5375134Z          description: Description détaillée
2026-02-20T22:09:12.5375711Z          challenge_type: Type (SEQUENCE, PATTERN, SPATIAL, etc.)
2026-02-20T22:09:12.5376265Z @@ -168,21 +171,21 @@
2026-02-20T22:09:12.5376791Z          visual_data: Données de visualisation (optionnel)
2026-02-20T22:09:12.5377494Z          difficulty_rating: Difficulté 1-5 (défaut: 3.0)
2026-02-20T22:09:12.5378471Z          estimated_time_minutes: Temps estimé (défaut: 10)
2026-02-20T22:09:12.5379159Z          tags: Tags séparés par virgules (optionnel)
2026-02-20T22:09:12.5379787Z          creator_id: ID du créateur (optionnel)
2026-02-20T22:09:12.5380218Z -    
2026-02-20T22:09:12.5380485Z +
2026-02-20T22:09:12.5380957Z      Returns:
2026-02-20T22:09:12.5381349Z          LogicChallenge créé
2026-02-20T22:09:12.5381704Z      """
2026-02-20T22:09:12.5382254Z      # Définir explicitement created_at pour éviter les valeurs NULL
2026-02-20T22:09:12.5382870Z      now = datetime.now(timezone.utc)
2026-02-20T22:09:12.5383474Z -    
2026-02-20T22:09:12.5383722Z +
2026-02-20T22:09:12.5384293Z      # Convertir le groupe d'âge frontend vers la valeur ENUM PostgreSQL
2026-02-20T22:09:12.5384994Z      db_age_group = normalize_age_group_for_db(age_group)
2026-02-20T22:09:12.5385818Z      logger.debug(f"Conversion groupe d'âge: {age_group} -> {db_age_group}")
2026-02-20T22:09:12.5386457Z -    
2026-02-20T22:09:12.5386712Z +
2026-02-20T22:09:12.5386998Z      challenge = LogicChallenge(
2026-02-20T22:09:12.5387384Z          title=title,
2026-02-20T22:09:12.5387733Z          description=description,
2026-02-20T22:09:12.5388158Z          challenge_type=challenge_type,
2026-02-20T22:09:12.5388614Z          age_group=db_age_group,
2026-02-20T22:09:12.5389106Z @@ -197,34 +200,35 @@
2026-02-20T22:09:12.5389450Z          creator_id=creator_id,
2026-02-20T22:09:12.5389835Z          is_active=True,
2026-02-20T22:09:12.5390448Z          created_at=now,  # Définir explicitement la date de création
2026-02-20T22:09:12.5391097Z          generation_parameters=generation_parameters,
2026-02-20T22:09:12.5391564Z      )
2026-02-20T22:09:12.5391822Z -    
2026-02-20T22:09:12.5392068Z +
2026-02-20T22:09:12.5392334Z      db.add(challenge)
2026-02-20T22:09:12.5392657Z      db.commit()
2026-02-20T22:09:12.5393127Z      db.refresh(challenge)
2026-02-20T22:09:12.5393469Z -    
2026-02-20T22:09:12.5393734Z +
2026-02-20T22:09:12.5394314Z      logger.info(f"Challenge créé: {challenge.id} - {challenge.title}")
2026-02-20T22:09:12.5394934Z      return challenge
2026-02-20T22:09:12.5395248Z  
2026-02-20T22:09:12.5395485Z  
2026-02-20T22:09:12.5395985Z  def get_challenge(db: Session, challenge_id: int) -> Optional[LogicChallenge]:
2026-02-20T22:09:12.5396661Z      """
2026-02-20T22:09:12.5397075Z      Récupérer un challenge par ID.
2026-02-20T22:09:12.5397465Z -    
2026-02-20T22:09:12.5397722Z +
2026-02-20T22:09:12.5397967Z      Args:
2026-02-20T22:09:12.5398259Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5398658Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5399049Z -    
2026-02-20T22:09:12.5399305Z +
2026-02-20T22:09:12.5399536Z      Returns:
2026-02-20T22:09:12.5399893Z          LogicChallenge ou None si non trouvé
2026-02-20T22:09:12.5400291Z      """
2026-02-20T22:09:12.5400593Z -    return db.query(LogicChallenge).filter(
2026-02-20T22:09:12.5401042Z -        LogicChallenge.id == challenge_id,
2026-02-20T22:09:12.5401525Z -        LogicChallenge.is_active == True
2026-02-20T22:09:12.5401931Z -    ).first()
2026-02-20T22:09:12.5402219Z +    return (
2026-02-20T22:09:12.5402529Z +        db.query(LogicChallenge)
2026-02-20T22:09:12.5403353Z +        .filter(LogicChallenge.id == challenge_id, LogicChallenge.is_active == True)
2026-02-20T22:09:12.5404051Z +        .first()
2026-02-20T22:09:12.5404342Z +    )
2026-02-20T22:09:12.5404600Z  
2026-02-20T22:09:12.5404834Z  
2026-02-20T22:09:12.5405098Z  def list_challenges(
2026-02-20T22:09:12.5405437Z      db: Session,
2026-02-20T22:09:12.5405787Z      challenge_type: Optional[str] = None,
2026-02-20T22:09:12.5406205Z @@ -237,57 +241,57 @@
2026-02-20T22:09:12.5406536Z      order: str = "random",
2026-02-20T22:09:12.5406949Z      exclude_ids: Optional[List[int]] = None,
2026-02-20T22:09:12.5407397Z  ) -> List[LogicChallenge]:
2026-02-20T22:09:12.5407746Z      """
2026-02-20T22:09:12.5408038Z      Lister les challenges avec filtres.
2026-02-20T22:09:12.5408685Z -    
2026-02-20T22:09:12.5408940Z +
2026-02-20T22:09:12.5409185Z      Args:
2026-02-20T22:09:12.5409471Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5409926Z          challenge_type: Filtrer par type (optionnel)
2026-02-20T22:09:12.5410627Z          age_group: Filtrer par groupe d'âge (optionnel)
2026-02-20T22:09:12.5411593Z          difficulty_min: Difficulté minimale (optionnel)
2026-02-20T22:09:12.5412284Z          difficulty_max: Difficulté maximale (optionnel)
2026-02-20T22:09:12.5412815Z          tags: Filtrer par tags (optionnel)
2026-02-20T22:09:12.5413630Z          limit: Nombre maximum de résultats (défaut: 10)
2026-02-20T22:09:12.5414276Z          offset: Offset pour pagination (défaut: 0)
2026-02-20T22:09:12.5414728Z -    
2026-02-20T22:09:12.5414977Z +
2026-02-20T22:09:12.5415228Z      Returns:
2026-02-20T22:09:12.5460903Z          Liste de LogicChallenge
2026-02-20T22:09:12.5461332Z      """
2026-02-20T22:09:12.5461843Z      query = db.query(LogicChallenge).filter(LogicChallenge.is_active == True)
2026-02-20T22:09:12.5462520Z -    
2026-02-20T22:09:12.5462785Z +
2026-02-20T22:09:12.5463258Z      # Filtres
2026-02-20T22:09:12.5463574Z      if challenge_type:
2026-02-20T22:09:12.5464150Z          query = query.filter(LogicChallenge.challenge_type == challenge_type)
2026-02-20T22:09:12.5464773Z -    
2026-02-20T22:09:12.5465055Z +
2026-02-20T22:09:12.5465328Z      if age_group:
2026-02-20T22:09:12.5465796Z          query = query.filter(LogicChallenge.age_group == age_group)
2026-02-20T22:09:12.5466357Z -    
2026-02-20T22:09:12.5466611Z +
2026-02-20T22:09:12.5466905Z      if difficulty_min is not None:
2026-02-20T22:09:12.5467559Z          query = query.filter(LogicChallenge.difficulty_rating >= difficulty_min)
2026-02-20T22:09:12.5468203Z -    
2026-02-20T22:09:12.5468451Z +
2026-02-20T22:09:12.5468737Z      if difficulty_max is not None:
2026-02-20T22:09:12.5469351Z          query = query.filter(LogicChallenge.difficulty_rating <= difficulty_max)
2026-02-20T22:09:12.5469994Z -    
2026-02-20T22:09:12.5470252Z +
2026-02-20T22:09:12.5470500Z      if tags:
2026-02-20T22:09:12.5470842Z          # Recherche partielle dans les tags
2026-02-20T22:09:12.5471438Z          query = query.filter(LogicChallenge.tags.contains(tags))
2026-02-20T22:09:12.5471989Z  
2026-02-20T22:09:12.5472457Z      # Exclure les défis déjà réussis si demandé
2026-02-20T22:09:12.5472937Z      if exclude_ids:
2026-02-20T22:09:12.5473640Z          query = query.filter(LogicChallenge.id.notin_(exclude_ids))
2026-02-20T22:09:12.5474199Z -    
2026-02-20T22:09:12.5474456Z +
2026-02-20T22:09:12.5475019Z      # Ordre : aléatoire par défaut (varier l'entraînement), ou récent
2026-02-20T22:09:12.5475629Z      if order == "recent":
2026-02-20T22:09:12.5475991Z          query = query.order_by(
2026-02-20T22:09:12.5476469Z -            LogicChallenge.created_at.desc().nullslast(),
2026-02-20T22:09:12.5477001Z -            LogicChallenge.id.desc()
2026-02-20T22:09:12.5477663Z +            LogicChallenge.created_at.desc().nullslast(), LogicChallenge.id.desc()
2026-02-20T22:09:12.5478338Z          )
2026-02-20T22:09:12.5478618Z      else:
2026-02-20T22:09:12.5478908Z          from sqlalchemy import func
2026-02-20T22:09:12.5479307Z +
2026-02-20T22:09:12.5479616Z          query = query.order_by(func.random())
2026-02-20T22:09:12.5480036Z -    
2026-02-20T22:09:12.5480312Z +
2026-02-20T22:09:12.5480640Z      return query.offset(offset).limit(limit).all()
2026-02-20T22:09:12.5481110Z  
2026-02-20T22:09:12.5481346Z  
2026-02-20T22:09:12.5481607Z  def count_challenges(
2026-02-20T22:09:12.5481932Z      db: Session,
2026-02-20T22:09:12.5482239Z @@ -295,110 +299,109 @@
2026-02-20T22:09:12.5482589Z      age_group: Optional[str] = None,
2026-02-20T22:09:12.5483314Z      exclude_ids: Optional[List[int]] = None,
2026-02-20T22:09:12.5483765Z  ) -> int:
2026-02-20T22:09:12.5484028Z      """
2026-02-20T22:09:12.5484344Z      Compter les challenges avec filtres.
2026-02-20T22:09:12.5484753Z -    
2026-02-20T22:09:12.5485009Z +
2026-02-20T22:09:12.5485513Z      Args:
2026-02-20T22:09:12.5485811Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5486273Z          challenge_type: Filtrer par type (optionnel)
2026-02-20T22:09:12.5486982Z          age_group: Filtrer par groupe d'âge (optionnel)
2026-02-20T22:09:12.5487767Z          exclude_ids: IDs à exclure du comptage (ex: défis déjà réussis)
2026-02-20T22:09:12.5488600Z -    
2026-02-20T22:09:12.5488857Z +
2026-02-20T22:09:12.5489098Z      Returns:
2026-02-20T22:09:12.5489459Z          Nombre de challenges correspondant aux filtres
2026-02-20T22:09:12.5489929Z      """
2026-02-20T22:09:12.5490427Z      query = db.query(LogicChallenge).filter(LogicChallenge.is_active == True)
2026-02-20T22:09:12.5491049Z -    
2026-02-20T22:09:12.5491315Z +
2026-02-20T22:09:12.5491581Z      if challenge_type:
2026-02-20T22:09:12.5492134Z          query = query.filter(LogicChallenge.challenge_type == challenge_type)
2026-02-20T22:09:12.5492751Z -    
2026-02-20T22:09:12.5493191Z +
2026-02-20T22:09:12.5493463Z      if age_group:
2026-02-20T22:09:12.5493920Z          query = query.filter(LogicChallenge.age_group == age_group)
2026-02-20T22:09:12.5494458Z  
2026-02-20T22:09:12.5494722Z      if exclude_ids:
2026-02-20T22:09:12.5495199Z          query = query.filter(LogicChallenge.id.notin_(exclude_ids))
2026-02-20T22:09:12.5495744Z -    
2026-02-20T22:09:12.5496021Z +
2026-02-20T22:09:12.5496285Z      return query.count()
2026-02-20T22:09:12.5496618Z  
2026-02-20T22:09:12.5496842Z  
2026-02-20T22:09:12.5497111Z  def update_challenge(
2026-02-20T22:09:12.5497430Z -    db: Session,
2026-02-20T22:09:12.5497749Z -    challenge_id: int,
2026-02-20T22:09:12.5498076Z -    **kwargs
2026-02-20T22:09:12.5498406Z +    db: Session, challenge_id: int, **kwargs
2026-02-20T22:09:12.5498883Z  ) -> Optional[LogicChallenge]:
2026-02-20T22:09:12.5499241Z      """
2026-02-20T22:09:12.5499636Z      Mettre à jour un challenge.
2026-02-20T22:09:12.5500010Z -    
2026-02-20T22:09:12.5500265Z +
2026-02-20T22:09:12.5500502Z      Args:
2026-02-20T22:09:12.5500810Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5501193Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5501730Z          **kwargs: Champs à mettre à jour
2026-02-20T22:09:12.5502150Z -    
2026-02-20T22:09:12.5502405Z +
2026-02-20T22:09:12.5502668Z      Returns:
2026-02-20T22:09:12.5503278Z          LogicChallenge mis à jour ou None si non trouvé
2026-02-20T22:09:12.5503773Z      """
2026-02-20T22:09:12.5504108Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5504565Z -    
2026-02-20T22:09:12.5504820Z +
2026-02-20T22:09:12.5505090Z      if not challenge:
2026-02-20T22:09:12.5505417Z          return None
2026-02-20T22:09:12.5505730Z -    
2026-02-20T22:09:12.5505980Z +
2026-02-20T22:09:12.5506372Z      # Mettre à jour les champs fournis
2026-02-20T22:09:12.5506835Z      for key, value in kwargs.items():
2026-02-20T22:09:12.5507282Z          if hasattr(challenge, key):
2026-02-20T22:09:12.5507724Z              setattr(challenge, key, value)
2026-02-20T22:09:12.5508160Z -    
2026-02-20T22:09:12.5508410Z +
2026-02-20T22:09:12.5508767Z      challenge.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:12.5509269Z      db.commit()
2026-02-20T22:09:12.5509581Z      db.refresh(challenge)
2026-02-20T22:09:12.5509927Z -    
2026-02-20T22:09:12.5510173Z +
2026-02-20T22:09:12.5510644Z      logger.info(f"Challenge mis à jour: {challenge.id}")
2026-02-20T22:09:12.5511176Z      return challenge
2026-02-20T22:09:12.5511491Z  
2026-02-20T22:09:12.5511728Z  
2026-02-20T22:09:12.5512136Z  def delete_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:12.5512673Z      """
2026-02-20T22:09:12.5564862Z      Supprimer (soft delete) un challenge.
2026-02-20T22:09:12.5565551Z -    
2026-02-20T22:09:12.5565816Z +
2026-02-20T22:09:12.5566072Z      Args:
2026-02-20T22:09:12.5566366Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5566801Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5567202Z -    
2026-02-20T22:09:12.5567480Z +
2026-02-20T22:09:12.5568107Z      Returns:
2026-02-20T22:09:12.5568692Z          True si supprimé, False sinon
2026-02-20T22:09:12.5569112Z      """
2026-02-20T22:09:12.5569459Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5569920Z -    
2026-02-20T22:09:12.5570178Z +
2026-02-20T22:09:12.5570455Z      if not challenge:
2026-02-20T22:09:12.5571118Z          return False
2026-02-20T22:09:12.5571435Z -    
2026-02-20T22:09:12.5571683Z +
2026-02-20T22:09:12.5571968Z      challenge.is_active = False
2026-02-20T22:09:12.5572341Z      db.commit()
2026-02-20T22:09:12.5572630Z -    
2026-02-20T22:09:12.5572885Z +
2026-02-20T22:09:12.5573730Z      logger.info(f"Challenge supprimé (soft): {challenge.id}")
2026-02-20T22:09:12.5574278Z      return True
2026-02-20T22:09:12.5574575Z  
2026-02-20T22:09:12.5574798Z  
2026-02-20T22:09:12.5575072Z -def get_user_completed_challenges(
2026-02-20T22:09:12.5575488Z -    db: Session,
2026-02-20T22:09:12.5575780Z -    user_id: int
2026-02-20T22:09:12.5576076Z -) -> List[int]:
2026-02-20T22:09:12.5576608Z +def get_user_completed_challenges(db: Session, user_id: int) -> List[int]:
2026-02-20T22:09:12.5577235Z      """
2026-02-20T22:09:12.5577825Z      Récupérer les IDs des challenges complétés par un utilisateur.
2026-02-20T22:09:12.5578396Z -    
2026-02-20T22:09:12.5578645Z +
2026-02-20T22:09:12.5578886Z      Args:
2026-02-20T22:09:12.5579172Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5579562Z          user_id: ID de l'utilisateur
2026-02-20T22:09:12.5579957Z -    
2026-02-20T22:09:12.5580203Z +
2026-02-20T22:09:12.5580451Z      Returns:
2026-02-20T22:09:12.5580886Z          Liste des IDs de challenges complétés
2026-02-20T22:09:12.5581328Z      """
2026-02-20T22:09:12.5581698Z -    attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5582280Z -        LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.5582812Z -        LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:12.5583472Z -    ).all()
2026-02-20T22:09:12.5583745Z -    
2026-02-20T22:09:12.5584026Z +    attempts = (
2026-02-20T22:09:12.5584371Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5584801Z +        .filter(
2026-02-20T22:09:12.5585186Z +            LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.5585729Z +            LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.5586222Z +        )
2026-02-20T22:09:12.5586500Z +        .all()
2026-02-20T22:09:12.5586786Z +    )
2026-02-20T22:09:12.5587028Z +
2026-02-20T22:09:12.5587405Z      return [attempt.challenge_id for attempt in attempts]
2026-02-20T22:09:12.5587907Z  
2026-02-20T22:09:12.5588177Z  
2026-02-20T22:09:12.5588443Z  def record_attempt(
2026-02-20T22:09:12.5588760Z      db: Session,
2026-02-20T22:09:12.5589072Z @@ -408,88 +411,106 @@
2026-02-20T22:09:12.5589397Z      is_correct: bool,
2026-02-20T22:09:12.5589770Z      time_spent_seconds: Optional[int] = None,
2026-02-20T22:09:12.5590248Z  ) -> LogicChallengeAttempt:
2026-02-20T22:09:12.5590621Z      """
2026-02-20T22:09:12.5591071Z      Enregistrer une tentative de résolution.
2026-02-20T22:09:12.5591520Z -    
2026-02-20T22:09:12.5591775Z +
2026-02-20T22:09:12.5592035Z      Args:
2026-02-20T22:09:12.5592319Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5592719Z          user_id: ID de l'utilisateur
2026-02-20T22:09:12.5593438Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5594013Z          user_answer: Réponse fournie
2026-02-20T22:09:12.5594545Z          is_correct: Réponse correcte ou non
2026-02-20T22:09:12.5595149Z          time_spent_seconds: Temps passé (optionnel)
2026-02-20T22:09:12.5595622Z -    
2026-02-20T22:09:12.5595880Z +
2026-02-20T22:09:12.5596136Z      Returns:
2026-02-20T22:09:12.5596546Z          LogicChallengeAttempt créé
2026-02-20T22:09:12.5596945Z      """
2026-02-20T22:09:12.5597257Z      attempt = LogicChallengeAttempt(
2026-02-20T22:09:12.5597673Z          user_id=user_id,
2026-02-20T22:09:12.5598042Z          challenge_id=challenge_id,
2026-02-20T22:09:12.5598446Z          user_answer=user_answer,
2026-02-20T22:09:12.5599121Z          is_correct=is_correct,
2026-02-20T22:09:12.5599545Z          time_spent_seconds=time_spent_seconds,
2026-02-20T22:09:12.5599989Z      )
2026-02-20T22:09:12.5600235Z -    
2026-02-20T22:09:12.5600483Z +
2026-02-20T22:09:12.5600733Z      db.add(attempt)
2026-02-20T22:09:12.5601044Z -    
2026-02-20T22:09:12.5601594Z +
2026-02-20T22:09:12.5602439Z      # Mettre à jour le taux de réussite du challenge (sur chaque tentative, pas seulement les correctes)
2026-02-20T22:09:12.5603506Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5603963Z      if challenge:
2026-02-20T22:09:12.5604546Z          # Requête unique avec agrégation pour total et correct
2026-02-20T22:09:12.5605095Z -        stats = db.query(
2026-02-20T22:09:12.5605583Z -            func.count(LogicChallengeAttempt.id).label('total'),
2026-02-20T22:09:12.5606401Z -            func.count(case((LogicChallengeAttempt.is_correct == True, 1))).label('correct')
2026-02-20T22:09:12.5607133Z -        ).filter(
2026-02-20T22:09:12.5607572Z -            LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5608098Z -        ).first()
2026-02-20T22:09:12.5608390Z -        
2026-02-20T22:09:12.5608651Z +        stats = (
2026-02-20T22:09:12.5608956Z +            db.query(
2026-02-20T22:09:12.5609415Z +                func.count(LogicChallengeAttempt.id).label("total"),
2026-02-20T22:09:12.5610209Z +                func.count(case((LogicChallengeAttempt.is_correct == True, 1))).label(
2026-02-20T22:09:12.5610857Z +                    "correct"
2026-02-20T22:09:12.5611213Z +                ),
2026-02-20T22:09:12.5611507Z +            )
2026-02-20T22:09:12.5611954Z +            .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5612535Z +            .first()
2026-02-20T22:09:12.5612845Z +        )
2026-02-20T22:09:12.5613397Z +
2026-02-20T22:09:12.5613745Z          total_attempts = stats.total if stats else 0
2026-02-20T22:09:12.5614323Z          correct_attempts = stats.correct if stats else 0
2026-02-20T22:09:12.5615173Z -        challenge.success_rate = (correct_attempts / total_attempts) * 100 if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5615966Z -    
2026-02-20T22:09:12.5616274Z +        challenge.success_rate = (
2026-02-20T22:09:12.5616894Z +            (correct_attempts / total_attempts) * 100 if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5617534Z +        )
2026-02-20T22:09:12.5617790Z +
2026-02-20T22:09:12.5618049Z      db.commit()
2026-02-20T22:09:12.5618351Z      db.refresh(attempt)
2026-02-20T22:09:12.5618680Z -    
2026-02-20T22:09:12.5619549Z -    logger.info(f"Tentative enregistrée: Challenge {challenge_id}, User {user_id}, Correct: {is_correct}")
2026-02-20T22:09:12.5620372Z +
2026-02-20T22:09:12.5620613Z +    logger.info(
2026-02-20T22:09:12.5621358Z +        f"Tentative enregistrée: Challenge {challenge_id}, User {user_id}, Correct: {is_correct}"
2026-02-20T22:09:12.5622094Z +    )
2026-02-20T22:09:12.5622355Z      return attempt
2026-02-20T22:09:12.5622651Z  
2026-02-20T22:09:12.5622887Z  
2026-02-20T22:09:12.5623548Z  def get_challenge_stats(db: Session, challenge_id: int) -> Dict[str, Any]:
2026-02-20T22:09:12.5624170Z      """
2026-02-20T22:09:12.5624640Z      Récupérer les statistiques d'un challenge.
2026-02-20T22:09:12.5625135Z -    
2026-02-20T22:09:12.5625390Z +
2026-02-20T22:09:12.5625646Z      Args:
2026-02-20T22:09:12.5625938Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5626337Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5626777Z -    
2026-02-20T22:09:12.5627079Z +
2026-02-20T22:09:12.5627328Z      Returns:
2026-02-20T22:09:12.5627658Z          Dictionnaire avec les statistiques
2026-02-20T22:09:12.5628067Z      """
2026-02-20T22:09:12.5628389Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5628834Z -    
2026-02-20T22:09:12.5629083Z +
2026-02-20T22:09:12.5629336Z      if not challenge:
2026-02-20T22:09:12.5629656Z          return {}
2026-02-20T22:09:12.5629937Z -    
2026-02-20T22:09:12.5630592Z -    total_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5631259Z -        LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5631766Z -    ).count()
2026-02-20T22:09:12.5632047Z -    
2026-02-20T22:09:12.5632451Z -    correct_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5633527Z -        LogicChallengeAttempt.challenge_id == challenge_id,
2026-02-20T22:09:12.5634116Z -        LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:12.5634583Z -    ).count()
2026-02-20T22:09:12.5634853Z -    
2026-02-20T22:09:12.5635289Z -    unique_users = db.query(LogicChallengeAttempt.user_id).filter(
2026-02-20T22:09:12.5635994Z -        LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5636530Z -    ).distinct().count()
2026-02-20T22:09:12.5636873Z -    
2026-02-20T22:09:12.5637118Z +
2026-02-20T22:09:12.5637391Z +    total_attempts = (
2026-02-20T22:09:12.5637759Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5638376Z +        .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5638944Z +        .count()
2026-02-20T22:09:12.5639229Z +    )
2026-02-20T22:09:12.5639481Z +
2026-02-20T22:09:12.5639818Z +    correct_attempts = (
2026-02-20T22:09:12.5640211Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5640637Z +        .filter(
2026-02-20T22:09:12.5641059Z +            LogicChallengeAttempt.challenge_id == challenge_id,
2026-02-20T22:09:12.5641668Z +            LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.5642136Z +        )
2026-02-20T22:09:12.5642392Z +        .count()
2026-02-20T22:09:12.5642674Z +    )
2026-02-20T22:09:12.5642922Z +
2026-02-20T22:09:12.5643336Z +    unique_users = (
2026-02-20T22:09:12.5643710Z +        db.query(LogicChallengeAttempt.user_id)
2026-02-20T22:09:12.5644332Z +        .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5644913Z +        .distinct()
2026-02-20T22:09:12.5645216Z +        .count()
2026-02-20T22:09:12.5645507Z +    )
2026-02-20T22:09:12.5645749Z +
2026-02-20T22:09:12.5646000Z      return {
2026-02-20T22:09:12.5646311Z          "challenge_id": challenge_id,
2026-02-20T22:09:12.5646751Z          "title": challenge.title,
2026-02-20T22:09:12.5647175Z          "total_attempts": total_attempts,
2026-02-20T22:09:12.5647655Z          "correct_attempts": correct_attempts,
2026-02-20T22:09:12.5648411Z -        "success_rate": (correct_attempts / total_attempts * 100) if total_attempts > 0 else 0.0,
2026-02-20T22:09:12.5649141Z +        "success_rate": (
2026-02-20T22:09:12.5649663Z +            (correct_attempts / total_attempts * 100) if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5743903Z +        ),
2026-02-20T22:09:12.5744262Z          "unique_users": unique_users,
2026-02-20T22:09:12.5744793Z          "difficulty_rating": challenge.difficulty_rating,
2026-02-20T22:09:12.5745292Z      }
2026-02-20T22:09:12.5745543Z -
2026-02-20T22:09:12.5749711Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py
2026-02-20T22:09:12.5750800Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.5751916Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py	2026-02-20 22:09:12.528805+00:00
2026-02-20T22:09:12.5752647Z @@ -1,9 +1,10 @@
2026-02-20T22:09:12.5752888Z  """
2026-02-20T22:09:12.5753498Z  Service de génération de challenges par IA.
2026-02-20T22:09:12.5754141Z  Extrait la logique de génération streaming depuis challenge_handlers.
2026-02-20T22:09:12.5754675Z  """
2026-02-20T22:09:12.5754910Z +
2026-02-20T22:09:12.5755142Z  import json
2026-02-20T22:09:12.5755410Z  import traceback
2026-02-20T22:09:12.5755708Z  from datetime import datetime
2026-02-20T22:09:12.5756116Z  from typing import Any, AsyncGenerator, Dict, Optional
2026-02-20T22:09:12.5756534Z  
2026-02-20T22:09:12.5756754Z @@ -85,13 +86,15 @@
2026-02-20T22:09:12.5757194Z      params = AGE_GROUP_PARAMS.get(age_group, AGE_GROUP_PARAMS["9-11"])
2026-02-20T22:09:12.5758043Z      age_display = params["display"]
2026-02-20T22:09:12.5758439Z      age_target_phrase = (
2026-02-20T22:09:12.5758768Z          "pour des adultes"
2026-02-20T22:09:12.5759069Z          if age_group == "adulte"
2026-02-20T22:09:12.5759484Z -        else "pour un public de tous âges"
2026-02-20T22:09:12.5760003Z -        if age_group == "tous-ages"
2026-02-20T22:09:12.5760482Z -        else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5760958Z +        else (
2026-02-20T22:09:12.5761370Z +            "pour un public de tous âges"
2026-02-20T22:09:12.5761817Z +            if age_group == "tous-ages"
2026-02-20T22:09:12.5762435Z +            else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5762928Z +        )
2026-02-20T22:09:12.5763399Z      )
2026-02-20T22:09:12.5763648Z  
2026-02-20T22:09:12.5763923Z      visual_adult_rule = ""
2026-02-20T22:09:12.5764382Z      if age_group == "adulte" and challenge_type == "visual":
2026-02-20T22:09:12.5764930Z          visual_adult_rule = """
2026-02-20T22:09:12.5765302Z @@ -396,20 +399,24 @@
2026-02-20T22:09:12.5765610Z  
2026-02-20T22:09:12.5766131Z  Assure-toi que le visual_data est complet et permet une visualisation interactive.
2026-02-20T22:09:12.5767222Z  IMPORTANT : Vérifie TOUJOURS la cohérence logique avant de retourner le JSON."""
2026-02-20T22:09:12.5767893Z  
2026-02-20T22:09:12.5768135Z  
2026-02-20T22:09:12.5768703Z -def build_challenge_user_prompt(challenge_type: str, age_group: str, prompt: str) -> str:
2026-02-20T22:09:12.5769472Z +def build_challenge_user_prompt(
2026-02-20T22:09:12.5769956Z +    challenge_type: str, age_group: str, prompt: str
2026-02-20T22:09:12.5770433Z +) -> str:
2026-02-20T22:09:12.5771025Z      """Construit le prompt utilisateur pour la génération de défis."""
2026-02-20T22:09:12.5771774Z      params = AGE_GROUP_PARAMS.get(age_group, AGE_GROUP_PARAMS["9-11"])
2026-02-20T22:09:12.5772396Z      age_display = params["display"]
2026-02-20T22:09:12.5772831Z      age_target_phrase = (
2026-02-20T22:09:12.5773375Z          "pour des adultes"
2026-02-20T22:09:12.5773747Z          if age_group == "adulte"
2026-02-20T22:09:12.5774252Z -        else "pour un public de tous âges"
2026-02-20T22:09:12.5774734Z -        if age_group == "tous-ages"
2026-02-20T22:09:12.5775340Z -        else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5775827Z +        else (
2026-02-20T22:09:12.5776243Z +            "pour un public de tous âges"
2026-02-20T22:09:12.5776699Z +            if age_group == "tous-ages"
2026-02-20T22:09:12.5777320Z +            else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5777807Z +        )
2026-02-20T22:09:12.5778069Z      )
2026-02-20T22:09:12.5778315Z  
2026-02-20T22:09:12.5779019Z      user_prompt = f"""Crée un défi mathélogique de type "{challenge_type}" {age_target_phrase}.
2026-02-20T22:09:12.5779712Z  
2026-02-20T22:09:12.5779994Z  CONTRAINTES OBLIGATOIRES :
2026-02-20T22:09:12.5780365Z @@ -436,17 +443,23 @@
2026-02-20T22:09:12.5780693Z  ) -> Dict[str, Any]:
2026-02-20T22:09:12.5780993Z      """
2026-02-20T22:09:12.5781559Z      Normalise les données générées avec ajustements de difficulté.
2026-02-20T22:09:12.5782138Z      """
2026-02-20T22:09:12.5782441Z      if age_group not in AGE_GROUP_PARAMS:
2026-02-20T22:09:12.5783660Z -        logger.warning(f"Groupe d'âge '{age_group}' non trouvé dans le mapping, utilisation de '9-11' par défaut")
2026-02-20T22:09:12.5784528Z +        logger.warning(
2026-02-20T22:09:12.5785353Z +            f"Groupe d'âge '{age_group}' non trouvé dans le mapping, utilisation de '9-11' par défaut"
2026-02-20T22:09:12.5786078Z +        )
2026-02-20T22:09:12.5786348Z  
2026-02-20T22:09:12.5786624Z      final_age_group = age_group
2026-02-20T22:09:12.5787124Z      ai_difficulty = challenge_data.get("difficulty_rating")
2026-02-20T22:09:12.5787870Z      expected_difficulty = calculate_difficulty_for_age_group(final_age_group)
2026-02-20T22:09:12.5788757Z  
2026-02-20T22:09:12.5789350Z -    if ai_difficulty and isinstance(ai_difficulty, (int, float)) and 1.0 <= ai_difficulty <= 5.0:
2026-02-20T22:09:12.5790095Z +    if (
2026-02-20T22:09:12.5790376Z +        ai_difficulty
2026-02-20T22:09:12.5790773Z +        and isinstance(ai_difficulty, (int, float))
2026-02-20T22:09:12.5791268Z +        and 1.0 <= ai_difficulty <= 5.0
2026-02-20T22:09:12.5791864Z +    ):
2026-02-20T22:09:12.5792234Z          if abs(ai_difficulty - expected_difficulty) > 1.5:
2026-02-20T22:09:12.5792746Z              logger.info(
2026-02-20T22:09:12.5793890Z                  f"Difficulté IA ({ai_difficulty}) ajustée pour groupe d'âge {final_age_group} -> {expected_difficulty}"
2026-02-20T22:09:12.5794740Z              )
2026-02-20T22:09:12.5795097Z              final_difficulty = expected_difficulty
2026-02-20T22:09:12.5795567Z @@ -558,16 +571,23 @@
2026-02-20T22:09:12.5795870Z  
2026-02-20T22:09:12.5796127Z              if use_o1:
2026-02-20T22:09:12.5796603Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5797212Z              elif use_o3:
2026-02-20T22:09:12.5797717Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5798538Z -                api_kwargs["reasoning_effort"] = ai_params.get("reasoning_effort", "medium")
2026-02-20T22:09:12.5799326Z +                api_kwargs["reasoning_effort"] = ai_params.get(
2026-02-20T22:09:12.5799866Z +                    "reasoning_effort", "medium"
2026-02-20T22:09:12.5800303Z +                )
2026-02-20T22:09:12.5800693Z              elif AIConfig.is_gpt5_model(ai_params["model"]):
2026-02-20T22:09:12.5801351Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5802171Z -                api_kwargs["reasoning_effort"] = ai_params.get("reasoning_effort", "medium")
2026-02-20T22:09:12.5802937Z +                api_kwargs["reasoning_effort"] = ai_params.get(
2026-02-20T22:09:12.5803674Z +                    "reasoning_effort", "medium"
2026-02-20T22:09:12.5804113Z +                )
2026-02-20T22:09:12.5804563Z                  api_kwargs["verbosity"] = ai_params.get("verbosity", "low")
2026-02-20T22:09:12.5805357Z -                if ai_params.get("reasoning_effort") == "none" and "temperature" in ai_params:
2026-02-20T22:09:12.5806034Z +                if (
2026-02-20T22:09:12.5806441Z +                    ai_params.get("reasoning_effort") == "none"
2026-02-20T22:09:12.5806966Z +                    and "temperature" in ai_params
2026-02-20T22:09:12.5807408Z +                ):
2026-02-20T22:09:12.5807829Z                      api_kwargs["temperature"] = ai_params["temperature"]
2026-02-20T22:09:12.5808364Z              else:
2026-02-20T22:09:12.5808755Z                  api_kwargs["max_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5809434Z                  api_kwargs["temperature"] = ai_params.get("temperature", 0.5)
2026-02-20T22:09:12.5810007Z  
2026-02-20T22:09:12.5810258Z @@ -577,12 +597,16 @@
2026-02-20T22:09:12.5810743Z              return await client.chat.completions.create(**api_kwargs)
2026-02-20T22:09:12.5811286Z  
2026-02-20T22:09:12.5811543Z          try:
2026-02-20T22:09:12.5811889Z              stream = await create_stream_with_retry()
2026-02-20T22:09:12.5812535Z          except (RateLimitError, APIError, APITimeoutError) as api_error:
2026-02-20T22:09:12.5813802Z -            logger.error(f"Erreur API OpenAI après {AIConfig.MAX_RETRIES} tentatives: {api_error}")
2026-02-20T22:09:12.5815124Z -            yield sse_error_message(f"Erreur lors de la génération après plusieurs tentatives: {str(api_error)}")
2026-02-20T22:09:12.5815962Z +            logger.error(
2026-02-20T22:09:12.5816726Z +                f"Erreur API OpenAI après {AIConfig.MAX_RETRIES} tentatives: {api_error}"
2026-02-20T22:09:12.5817389Z +            )
2026-02-20T22:09:12.5817697Z +            yield sse_error_message(
2026-02-20T22:09:12.5818498Z +                f"Erreur lors de la génération après plusieurs tentatives: {str(api_error)}"
2026-02-20T22:09:12.5819409Z +            )
2026-02-20T22:09:12.5819696Z              return
2026-02-20T22:09:12.5820048Z          except Exception as unexpected_error:
2026-02-20T22:09:12.5820899Z              logger.error(f"Erreur inattendue lors de la génération: {unexpected_error}")
2026-02-20T22:09:12.5821882Z              yield sse_error_message("Erreur inattendue lors de la génération")
2026-02-20T22:09:12.5822705Z              return
2026-02-20T22:09:12.5823191Z @@ -597,16 +621,22 @@
2026-02-20T22:09:12.5823625Z              if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:12.5824214Z                  content = chunk.choices[0].delta.content
2026-02-20T22:09:12.5824703Z                  full_response += content
2026-02-20T22:09:12.5825252Z                  completion_tokens_estimate = len(full_response) // 4
2026-02-20T22:09:12.5825865Z              if hasattr(chunk, "usage") and chunk.usage:
2026-02-20T22:09:12.5826616Z -                prompt_tokens_estimate = chunk.usage.prompt_tokens or prompt_tokens_estimate
2026-02-20T22:09:12.5827687Z -                completion_tokens_estimate = chunk.usage.completion_tokens or completion_tokens_estimate
2026-02-20T22:09:12.5828510Z +                prompt_tokens_estimate = (
2026-02-20T22:09:12.5829069Z +                    chunk.usage.prompt_tokens or prompt_tokens_estimate
2026-02-20T22:09:12.5829621Z +                )
2026-02-20T22:09:12.5829962Z +                completion_tokens_estimate = (
2026-02-20T22:09:12.5830578Z +                    chunk.usage.completion_tokens or completion_tokens_estimate
2026-02-20T22:09:12.5831152Z +                )
2026-02-20T22:09:12.5831441Z  
2026-02-20T22:09:12.5831840Z          # Fallback si réponse vide (o3)
2026-02-20T22:09:12.5832493Z          if not full_response.strip() and AIConfig.is_o3_model(ai_params["model"]):
2026-02-20T22:09:12.5833720Z -            logger.warning("Réponse vide de o3, fallback vers modèle sans raisonnement...")
2026-02-20T22:09:12.5834434Z +            logger.warning(
2026-02-20T22:09:12.5835118Z +                "Réponse vide de o3, fallback vers modèle sans raisonnement..."
2026-02-20T22:09:12.5835689Z +            )
2026-02-20T22:09:12.5836051Z              fallback_model = AIConfig.ADVANCED_MODEL
2026-02-20T22:09:12.5836503Z              try:
2026-02-20T22:09:12.5836845Z                  fallback_client = AsyncOpenAI(
2026-02-20T22:09:12.5837407Z                      api_key=settings.OPENAI_API_KEY,
2026-02-20T22:09:12.5837946Z                      timeout=ai_params.get("timeout", 120),
2026-02-20T22:09:12.5838414Z @@ -621,15 +651,19 @@
2026-02-20T22:09:12.5838788Z                      max_tokens=ai_params["max_tokens"],
2026-02-20T22:09:12.5839266Z                      temperature=0.4,
2026-02-20T22:09:12.5839642Z                  )
2026-02-20T22:09:12.5840170Z                  if fallback_resp.choices and fallback_resp.choices[0].message.content:
2026-02-20T22:09:12.5840956Z                      full_response = fallback_resp.choices[0].message.content
2026-02-20T22:09:12.5841982Z -                    logger.info(f"Fallback {fallback_model}: {len(full_response)} caractères reçus")
2026-02-20T22:09:12.5842705Z +                    logger.info(
2026-02-20T22:09:12.5843614Z +                        f"Fallback {fallback_model}: {len(full_response)} caractères reçus"
2026-02-20T22:09:12.5844255Z +                    )
2026-02-20T22:09:12.5844614Z              except Exception as fb_err:
2026-02-20T22:09:12.5845206Z                  logger.error(f"Fallback échoué: {fb_err}")
2026-02-20T22:09:12.5845652Z  
2026-02-20T22:09:12.5846439Z -        logger.info(f"Réponse reçue: {len(full_response)} caractères, ~{len(full_response)//4} tokens estimés")
2026-02-20T22:09:12.5847240Z +        logger.info(
2026-02-20T22:09:12.5848014Z +            f"Réponse reçue: {len(full_response)} caractères, ~{len(full_response)//4} tokens estimés"
2026-02-20T22:09:12.5848742Z +        )
2026-02-20T22:09:12.5848995Z  
2026-02-20T22:09:12.5849238Z          try:
2026-02-20T22:09:12.5849890Z              challenge_data = extract_json_from_text(full_response)
2026-02-20T22:09:12.5850500Z          except json.JSONDecodeError as json_error:
2026-02-20T22:09:12.5851095Z              logger.error(f"Erreur de parsing JSON: {json_error}")
2026-02-20T22:09:12.5851622Z @@ -645,40 +679,52 @@
2026-02-20T22:09:12.5852270Z              yield sse_error_message("Erreur lors du parsing de la réponse JSON")
2026-02-20T22:09:12.5853277Z              return
2026-02-20T22:09:12.5853577Z  
2026-02-20T22:09:12.5854063Z          if not challenge_data.get("title") or not challenge_data.get("description"):
2026-02-20T22:09:12.5855056Z              logger.error(f"Données de challenge incomplètes: {challenge_data}")
2026-02-20T22:09:12.5856194Z -            yield sse_error_message("Les données générées sont incomplètes (titre ou description manquant)")
2026-02-20T22:09:12.5857011Z +            yield sse_error_message(
2026-02-20T22:09:12.5857756Z +                "Les données générées sont incomplètes (titre ou description manquant)"
2026-02-20T22:09:12.5858406Z +            )
2026-02-20T22:09:12.5858690Z              return
2026-02-20T22:09:12.5858970Z  
2026-02-20T22:09:12.5859336Z          challenge_data["challenge_type"] = challenge_type
2026-02-20T22:09:12.5859892Z          if challenge_type.lower() == "pattern":
2026-02-20T22:09:12.5860467Z              challenge_data = auto_correct_challenge(challenge_data)
2026-02-20T22:09:12.5861223Z          is_valid, validation_errors = validate_challenge_logic(challenge_data)
2026-02-20T22:09:12.5861839Z  
2026-02-20T22:09:12.5862094Z          if not is_valid:
2026-02-20T22:09:12.5862893Z -            logger.warning(f"Challenge généré avec erreurs de validation: {validation_errors}")
2026-02-20T22:09:12.5863822Z +            logger.warning(
2026-02-20T22:09:12.5864539Z +                f"Challenge généré avec erreurs de validation: {validation_errors}"
2026-02-20T22:09:12.5865151Z +            )
2026-02-20T22:09:12.5865570Z              logger.info("Tentative de correction automatique...")
2026-02-20T22:09:12.5866303Z              corrected_challenge = auto_correct_challenge(challenge_data)
2026-02-20T22:09:12.5867228Z -            is_valid_after_correction, remaining_errors = validate_challenge_logic(corrected_challenge)
2026-02-20T22:09:12.5868245Z +            is_valid_after_correction, remaining_errors = validate_challenge_logic(
2026-02-20T22:09:12.5868923Z +                corrected_challenge
2026-02-20T22:09:12.5869314Z +            )
2026-02-20T22:09:12.5869648Z              if is_valid_after_correction:
2026-02-20T22:09:12.5870290Z                  logger.info("Correction automatique réussie")
2026-02-20T22:09:12.5870862Z                  challenge_data = corrected_challenge
2026-02-20T22:09:12.5871334Z                  auto_corrected = True
2026-02-20T22:09:12.5871774Z                  validation_passed = True
2026-02-20T22:09:12.5872184Z              else:
2026-02-20T22:09:12.5872846Z -                logger.error(f"Correction automatique impossible. Erreurs restantes: {remaining_errors}")
2026-02-20T22:09:12.5873819Z +                logger.error(
2026-02-20T22:09:12.5874454Z +                    f"Correction automatique impossible. Erreurs restantes: {remaining_errors}"
2026-02-20T22:09:12.5875153Z +                )
2026-02-20T22:09:12.5875476Z                  validation_passed = False
2026-02-20T22:09:12.5875992Z                  errors_str = ", ".join(remaining_errors[:2])
2026-02-20T22:09:12.5876822Z                  yield f"data: {json.dumps({'type': 'warning', 'message': f'Avertissement: {errors_str}'})}\n\n"
2026-02-20T22:09:12.5877586Z          else:
2026-02-20T22:09:12.5878076Z              logger.debug("Challenge validé avec succès")
2026-02-20T22:09:12.5878585Z              validation_passed = True
2026-02-20T22:09:12.5878979Z  
2026-02-20T22:09:12.5879602Z -        normalized_challenge = normalize_generated_challenge(challenge_data, challenge_type, age_group)
2026-02-20T22:09:12.5880397Z -
2026-02-20T22:09:12.5880966Z -        if not normalized_challenge.get("title") or not normalized_challenge.get("description"):
2026-02-20T22:09:12.5882058Z +        normalized_challenge = normalize_generated_challenge(
2026-02-20T22:09:12.5882659Z +            challenge_data, challenge_type, age_group
2026-02-20T22:09:12.5883288Z +        )
2026-02-20T22:09:12.5883554Z +
2026-02-20T22:09:12.5884039Z +        if not normalized_challenge.get("title") or not normalized_challenge.get(
2026-02-20T22:09:12.5884924Z +            "description"
2026-02-20T22:09:12.5885261Z +        ):
2026-02-20T22:09:12.5885902Z              logger.error(f"Challenge normalisé invalide: {normalized_challenge}")
2026-02-20T22:09:12.5886860Z              yield sse_error_message("Erreur lors de la normalisation des données")
2026-02-20T22:09:12.5887493Z              return
2026-02-20T22:09:12.5887788Z  
2026-02-20T22:09:12.5888031Z          try:
2026-02-20T22:09:12.5888309Z @@ -692,23 +738,31 @@
2026-02-20T22:09:12.5888726Z                      question=normalized_challenge.get("question"),
2026-02-20T22:09:12.5889400Z                      correct_answer=normalized_challenge["correct_answer"],
2026-02-20T22:09:12.5890176Z                      solution_explanation=normalized_challenge["solution_explanation"],
2026-02-20T22:09:12.5890928Z                      hints=normalized_challenge.get("hints", []),
2026-02-20T22:09:12.5891581Z                      visual_data=normalized_challenge.get("visual_data", {}),
2026-02-20T22:09:12.5892400Z -                    difficulty_rating=normalized_challenge.get("difficulty_rating", 3.0),
2026-02-20T22:09:12.5893555Z -                    estimated_time_minutes=normalized_challenge.get("estimated_time_minutes", 10),
2026-02-20T22:09:12.5894376Z +                    difficulty_rating=normalized_challenge.get(
2026-02-20T22:09:12.5894921Z +                        "difficulty_rating", 3.0
2026-02-20T22:09:12.5895356Z +                    ),
2026-02-20T22:09:12.5895798Z +                    estimated_time_minutes=normalized_challenge.get(
2026-02-20T22:09:12.5896374Z +                        "estimated_time_minutes", 10
2026-02-20T22:09:12.5896824Z +                    ),
2026-02-20T22:09:12.5897285Z                      tags=normalized_challenge.get("tags", "ai,generated"),
2026-02-20T22:09:12.5897856Z                      creator_id=user_id,
2026-02-20T22:09:12.5898303Z                      generation_parameters={
2026-02-20T22:09:12.5898755Z                          "source": "ai",
2026-02-20T22:09:12.5899328Z                          "challenge_type": normalized_challenge["challenge_type"],
2026-02-20T22:09:12.5900008Z                          "age_group": normalized_challenge["age_group"],
2026-02-20T22:09:12.5900620Z                          "model": ai_params.get("model", "unknown"),
2026-02-20T22:09:12.5901116Z                      },
2026-02-20T22:09:12.5901420Z                  )
2026-02-20T22:09:12.5901705Z  
2026-02-20T22:09:12.5902310Z -                if created_challenge and hasattr(created_challenge, "title") and created_challenge.title:
2026-02-20T22:09:12.5903270Z +                if (
2026-02-20T22:09:12.5903603Z +                    created_challenge
2026-02-20T22:09:12.5904080Z +                    and hasattr(created_challenge, "title")
2026-02-20T22:09:12.5904604Z +                    and created_challenge.title
2026-02-20T22:09:12.5905032Z +                ):
2026-02-20T22:09:12.5905413Z                      usage_stats = token_tracker.track_usage(
2026-02-20T22:09:12.5905952Z                          challenge_type=challenge_type,
2026-02-20T22:09:12.5906497Z                          prompt_tokens=prompt_tokens_estimate,
2026-02-20T22:09:12.5907084Z                          completion_tokens=completion_tokens_estimate,
2026-02-20T22:09:12.5907643Z                          model=ai_params["model"],
2026-02-20T22:09:12.5908073Z @@ -732,11 +786,13 @@
2026-02-20T22:09:12.5908375Z                          "challenge_type": (
2026-02-20T22:09:12.5908870Z                              str(created_challenge.challenge_type)
2026-02-20T22:09:12.5909502Z                              if hasattr(created_challenge.challenge_type, "value")
2026-02-20T22:09:12.5910381Z                              else created_challenge.challenge_type
2026-02-20T22:09:12.5910869Z                          ),
2026-02-20T22:09:12.5911489Z -                        "age_group": normalize_age_group_for_frontend(created_challenge.age_group),
2026-02-20T22:09:12.5912493Z +                        "age_group": normalize_age_group_for_frontend(
2026-02-20T22:09:12.5913246Z +                            created_challenge.age_group
2026-02-20T22:09:12.5913716Z +                        ),
2026-02-20T22:09:12.5914128Z                          "question": created_challenge.question,
2026-02-20T22:09:12.5914744Z                          "correct_answer": created_challenge.correct_answer,
2026-02-20T22:09:12.5915494Z                          "solution_explanation": created_challenge.solution_explanation,
2026-02-20T22:09:12.5916201Z                          "hints": created_challenge.hints or [],
2026-02-20T22:09:12.5916811Z                          "visual_data": created_challenge.visual_data or {},
2026-02-20T22:09:12.5917355Z @@ -758,11 +814,13 @@
2026-02-20T22:09:12.5917882Z              logger.error(f"Erreur lors de la sauvegarde du challenge: {db_error}")
2026-02-20T22:09:12.5918561Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:12.5919085Z              if normalized_challenge.get("title"):
2026-02-20T22:09:12.5920314Z                  yield f"data: {json.dumps({'type': 'challenge', 'challenge': normalized_challenge, 'warning': 'Non sauvegardé en base'})}\n\n"
2026-02-20T22:09:12.5921277Z              else:
2026-02-20T22:09:12.5921840Z -                yield sse_error_message("Erreur lors de la sauvegarde et challenge invalide")
2026-02-20T22:09:12.5922574Z +                yield sse_error_message(
2026-02-20T22:09:12.5923288Z +                    "Erreur lors de la sauvegarde et challenge invalide"
2026-02-20T22:09:12.5923821Z +                )
2026-02-20T22:09:12.5924112Z  
2026-02-20T22:09:12.5924468Z          yield f"data: {json.dumps({'type': 'done'})}\n\n"
2026-02-20T22:09:12.5924943Z  
2026-02-20T22:09:12.5925296Z      except Exception as gen_error:
2026-02-20T22:09:12.5925979Z          logger.error(f"Erreur lors de la génération: {gen_error}")
2026-02-20T22:09:12.6881723Z --- /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.6884002Z +++ /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py	2026-02-20 22:09:12.680331+00:00
2026-02-20T22:09:12.6885201Z @@ -32,22 +32,31 @@
2026-02-20T22:09:12.6885806Z  # Type: Callable[[Session, int, dict, Optional[dict]], bool]
2026-02-20T22:09:12.6888971Z  CheckerFn = Callable[[Session, int, Dict[str, Any], Optional[Dict[str, Any]]], bool]
2026-02-20T22:09:12.6889763Z  
2026-02-20T22:09:12.6890022Z  
2026-02-20T22:09:12.6890310Z  def _check_attempts_count(
2026-02-20T22:09:12.6891000Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6891786Z +    db: Session,
2026-02-20T22:09:12.6892112Z +    user_id: int,
2026-02-20T22:09:12.6892440Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6892901Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6893618Z  ) -> bool:
2026-02-20T22:09:12.6894318Z      """Vérifie count(attempts) >= attempts_count."""
2026-02-20T22:09:12.6894893Z      target = req.get("attempts_count")
2026-02-20T22:09:12.6895338Z      if target is None:
2026-02-20T22:09:12.6895709Z          return False
2026-02-20T22:09:12.6896320Z -    count = db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar() or 0
2026-02-20T22:09:12.6897021Z +    count = (
2026-02-20T22:09:12.6897551Z +        db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar()
2026-02-20T22:09:12.6898230Z +        or 0
2026-02-20T22:09:12.6898515Z +    )
2026-02-20T22:09:12.6898832Z      return count >= int(target)
2026-02-20T22:09:12.6899224Z  
2026-02-20T22:09:12.6899959Z  
2026-02-20T22:09:12.6900266Z  def _check_logic_attempts_count(
2026-02-20T22:09:12.6900978Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6901723Z +    db: Session,
2026-02-20T22:09:12.6902033Z +    user_id: int,
2026-02-20T22:09:12.6902363Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6903373Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6903871Z  ) -> bool:
2026-02-20T22:09:12.6904672Z      """Vérifie count(logic_challenge_attempts corrects) >= logic_attempts_count. B5."""
2026-02-20T22:09:12.6905571Z      from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:12.6906150Z  
2026-02-20T22:09:12.6906478Z      target = req.get("logic_attempts_count")
2026-02-20T22:09:12.6906936Z @@ -64,20 +73,26 @@
2026-02-20T22:09:12.6907246Z      )
2026-02-20T22:09:12.6907560Z      return count >= int(target)
2026-02-20T22:09:12.6907937Z  
2026-02-20T22:09:12.6908206Z  
2026-02-20T22:09:12.6908484Z  def _check_mixte(
2026-02-20T22:09:12.6909110Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6909864Z +    db: Session,
2026-02-20T22:09:12.6910174Z +    user_id: int,
2026-02-20T22:09:12.6910504Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6910937Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6911444Z  ) -> bool:
2026-02-20T22:09:12.6912042Z      """Vérifie attempts_count ET logic_attempts_count. B5."""
2026-02-20T22:09:12.6912940Z -    return _check_attempts_count(db, user_id, req, _attempt_data) and _check_logic_attempts_count(
2026-02-20T22:09:12.6913960Z +    return _check_attempts_count(
2026-02-20T22:09:12.6914413Z          db, user_id, req, _attempt_data
2026-02-20T22:09:12.6914834Z -    )
2026-02-20T22:09:12.6915280Z +    ) and _check_logic_attempts_count(db, user_id, req, _attempt_data)
2026-02-20T22:09:12.6915869Z  
2026-02-20T22:09:12.6916125Z  
2026-02-20T22:09:12.6916430Z  def _check_success_rate(
2026-02-20T22:09:12.6917118Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6917875Z +    db: Session,
2026-02-20T22:09:12.6918196Z +    user_id: int,
2026-02-20T22:09:12.6918534Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6918994Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6919521Z  ) -> bool:
2026-02-20T22:09:12.6920145Z      """Vérifie min_attempts atteint ET success_rate >= taux."""
2026-02-20T22:09:12.6920722Z      target = req.get("min_attempts")
2026-02-20T22:09:12.6921170Z      rate = req.get("success_rate")
2026-02-20T22:09:12.6921604Z      if target is None or rate is None:
2026-02-20T22:09:12.6922037Z @@ -94,11 +109,14 @@
2026-02-20T22:09:12.6922488Z      success_pct = (stats[1] / stats[0] * 100) if stats[0] else 0
2026-02-20T22:09:12.6923281Z      return success_pct >= float(rate)
2026-02-20T22:09:12.6923711Z  
2026-02-20T22:09:12.6923959Z  
2026-02-20T22:09:12.6924262Z  def _check_consecutive(
2026-02-20T22:09:12.6924910Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6925745Z +    db: Session,
2026-02-20T22:09:12.6926071Z +    user_id: int,
2026-02-20T22:09:12.6926397Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6926826Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6927338Z  ) -> bool:
2026-02-20T22:09:12.6928008Z      """Vérifie série consécutive de succès pour un type d'exercice."""
2026-02-20T22:09:12.6928690Z      ex_type = req.get("exercise_type", "addition")
2026-02-20T22:09:12.6929256Z      required = req.get("consecutive_correct")
2026-02-20T22:09:12.6929738Z      if required is None:
2026-02-20T22:09:12.6930113Z @@ -126,11 +144,14 @@
2026-02-20T22:09:12.6930430Z              break
2026-02-20T22:09:12.6930738Z      return False
2026-02-20T22:09:12.6931030Z  
2026-02-20T22:09:12.6931288Z  
2026-02-20T22:09:12.6931556Z  def _check_max_time(
2026-02-20T22:09:12.6932622Z -    db: Session, user_id: int, req: Dict[str, Any], attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6933621Z +    db: Session,
2026-02-20T22:09:12.6933961Z +    user_id: int,
2026-02-20T22:09:12.6934299Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6934740Z +    attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6935610Z  ) -> bool:
2026-02-20T22:09:12.6936315Z      """Vérifie au moins une tentative correcte en moins de max_time secondes."""
2026-02-20T22:09:12.6937003Z      max_t = req.get("max_time")
2026-02-20T22:09:12.6937402Z      if max_t is None:
2026-02-20T22:09:12.6937743Z          return False
2026-02-20T22:09:12.6938067Z @@ -148,11 +169,14 @@
2026-02-20T22:09:12.6938388Z      )
2026-02-20T22:09:12.6938684Z      return fast is not None
2026-02-20T22:09:12.6939037Z  
2026-02-20T22:09:12.6939291Z  
2026-02-20T22:09:12.6939574Z  def _check_consecutive_days(
2026-02-20T22:09:12.6940256Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6940995Z +    db: Session,
2026-02-20T22:09:12.6941307Z +    user_id: int,
2026-02-20T22:09:12.6941626Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6942068Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6942533Z  ) -> bool:
2026-02-20T22:09:12.6943272Z      """Vérifie X jours consécutifs d'activité (exercices)."""
2026-02-20T22:09:12.6943850Z      days = req.get("consecutive_days")
2026-02-20T22:09:12.6943980Z      if days is None:
2026-02-20T22:09:12.6944104Z          return False
2026-02-20T22:09:12.6944222Z @@ -180,11 +204,14 @@
2026-02-20T22:09:12.6944347Z              break
2026-02-20T22:09:12.6944481Z      return count >= days
2026-02-20T22:09:12.6944587Z  
2026-02-20T22:09:12.6944701Z  
2026-02-20T22:09:12.6944837Z  def _check_perfect_day(
2026-02-20T22:09:12.6945265Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6945393Z +    db: Session,
2026-02-20T22:09:12.6945540Z +    user_id: int,
2026-02-20T22:09:12.6945673Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6945875Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6946011Z  ) -> bool:
2026-02-20T22:09:12.6946579Z      """Vérifie journée parfaite : tous les exercices du jour réussis, au moins 3."""
2026-02-20T22:09:12.6946771Z      today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.6946931Z      row = db.execute(
2026-02-20T22:09:12.6947051Z          text("""
2026-02-20T22:09:12.6947174Z @@ -198,15 +225,20 @@
2026-02-20T22:09:12.6947296Z          return False
2026-02-20T22:09:12.6947442Z      return row[0] == row[1]
2026-02-20T22:09:12.6947554Z  
2026-02-20T22:09:12.6947660Z  
2026-02-20T22:09:12.6947794Z  def _check_all_types(
2026-02-20T22:09:12.6948229Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6948353Z +    db: Session,
2026-02-20T22:09:12.6948467Z +    user_id: int,
2026-02-20T22:09:12.6948620Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6948824Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6948947Z  ) -> bool:
2026-02-20T22:09:12.6949418Z      """Vérifie que l'utilisateur a essayé tous les types d'exercices."""
2026-02-20T22:09:12.6949569Z      all_types = db.execute(
2026-02-20T22:09:12.6950088Z -        text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.6950219Z +        text(
2026-02-20T22:09:12.6950716Z +            "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.6950833Z +        )
2026-02-20T22:09:12.6950951Z      ).fetchall()
2026-02-20T22:09:12.6951079Z      if not all_types:
2026-02-20T22:09:12.6951204Z          return False
2026-02-20T22:09:12.6951398Z      all_set = {str(r[0]).lower() for r in all_types}
2026-02-20T22:09:12.6951543Z      user_types = db.execute(
2026-02-20T22:09:12.6951666Z @@ -221,11 +253,14 @@
2026-02-20T22:09:12.6952172Z      user_set = {str(r[0]).lower() for r in user_types}
2026-02-20T22:09:12.6952341Z      return all_set.issubset(user_set)
2026-02-20T22:09:12.6952478Z  
2026-02-20T22:09:12.6952587Z  
2026-02-20T22:09:12.6952717Z  def _check_comeback(
2026-02-20T22:09:12.6953339Z -    db: Session, user_id: int, req: Dict[str, Any], attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6953716Z +    db: Session,
2026-02-20T22:09:12.6953842Z +    user_id: int,
2026-02-20T22:09:12.6953975Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6954186Z +    attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6954304Z  ) -> bool:
2026-02-20T22:09:12.6954898Z      """Vérifie si l'utilisateur revient après X jours sans activité (loss aversion)."""
2026-02-20T22:09:12.6955066Z      days = req.get("comeback_days")
2026-02-20T22:09:12.6955244Z      if days is None or attempt_data is None:
2026-02-20T22:09:12.6955367Z          return False
2026-02-20T22:09:12.6955492Z @@ -249,17 +284,22 @@
2026-02-20T22:09:12.6955900Z      delta = (current_dt - prev.created_at).days if hasattr(current_dt, "__sub__") else 0
2026-02-20T22:09:12.6956035Z      return delta >= days
2026-02-20T22:09:12.6956148Z  
2026-02-20T22:09:12.6956265Z  
2026-02-20T22:09:12.6956401Z  def _check_min_per_type(
2026-02-20T22:09:12.6956822Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6956966Z +    db: Session,
2026-02-20T22:09:12.6957084Z +    user_id: int,
2026-02-20T22:09:12.6957213Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6957417Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6957545Z  ) -> bool:
2026-02-20T22:09:12.6957908Z      """Vérifie au moins X exercices réussis par type."""
2026-02-20T22:09:12.6958166Z      min_count = req.get("min_per_type", req.get("min_count", 5))
2026-02-20T22:09:12.6958311Z      min_count = int(min_count)
2026-02-20T22:09:12.6958447Z      all_types = db.execute(
2026-02-20T22:09:12.6958973Z -        text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.6959116Z +        text(
2026-02-20T22:09:12.6959611Z +            "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.6959731Z +        )
2026-02-20T22:09:12.6959853Z      ).fetchall()
2026-02-20T22:09:12.6960010Z      if not all_types:
2026-02-20T22:09:12.6960133Z          return False
2026-02-20T22:09:12.6960258Z      for r in all_types:
2026-02-20T22:09:12.6960389Z          ex_type = str(r[0])
2026-02-20T22:09:12.6960513Z @@ -310,11 +350,15 @@
2026-02-20T22:09:12.6960660Z      # logic_attempts_count seul
2026-02-20T22:09:12.6979465Z      if "logic_attempts_count" in keys:
2026-02-20T22:09:12.6979701Z          return "logic_attempts_count"
2026-02-20T22:09:12.6979818Z  
2026-02-20T22:09:12.6980108Z      # attempts_count seul (pas de consecutive_correct, etc.)
2026-02-20T22:09:12.6980600Z -    if "attempts_count" in keys and "consecutive_correct" not in keys and "success_rate" not in keys:
2026-02-20T22:09:12.6980736Z +    if (
2026-02-20T22:09:12.6980883Z +        "attempts_count" in keys
2026-02-20T22:09:12.6981071Z +        and "consecutive_correct" not in keys
2026-02-20T22:09:12.6981217Z +        and "success_rate" not in keys
2026-02-20T22:09:12.6981324Z +    ):
2026-02-20T22:09:12.6981497Z          return "attempts_count"
2026-02-20T22:09:12.6981607Z  
2026-02-20T22:09:12.6981730Z      # success_rate
2026-02-20T22:09:12.6981973Z      if "min_attempts" in keys and "success_rate" in keys:
2026-02-20T22:09:12.6982119Z          return "success_rate"
2026-02-20T22:09:12.6982247Z @@ -375,31 +419,41 @@
2026-02-20T22:09:12.6982358Z  
2026-02-20T22:09:12.6982531Z  # --- Progress getters (Lot C-2) ---
2026-02-20T22:09:12.6982941Z  # Type: Callable[[Session, int, Dict, Optional[Dict]], Optional[tuple[float, int, int]]]
2026-02-20T22:09:12.6983863Z  # stats_cache évite N+1 quand get_badges_progress pré-fetch les stats
2026-02-20T22:09:12.6984336Z  ProgressFn = Callable[
2026-02-20T22:09:12.6984787Z -    [Session, int, Dict[str, Any], Optional[Dict[str, Any]]], Optional[tuple[float, int, int]]
2026-02-20T22:09:12.6985057Z +    [Session, int, Dict[str, Any], Optional[Dict[str, Any]]],
2026-02-20T22:09:12.6985240Z +    Optional[tuple[float, int, int]],
2026-02-20T22:09:12.6985362Z  ]
2026-02-20T22:09:12.6985754Z  
2026-02-20T22:09:12.6985860Z  
2026-02-20T22:09:12.6986042Z  def _progress_attempts_count(
2026-02-20T22:09:12.6986432Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6986559Z +    db: Session,
2026-02-20T22:09:12.6986689Z +    user_id: int,
2026-02-20T22:09:12.6986824Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6986996Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6987157Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6987312Z      t = req.get("attempts_count")
2026-02-20T22:09:12.6987427Z      if t is None:
2026-02-20T22:09:12.6987558Z          return None
2026-02-20T22:09:12.6987685Z      t = int(t)
2026-02-20T22:09:12.6987907Z      if cache is not None and "attempts_count" in cache:
2026-02-20T22:09:12.6988060Z          c = cache["attempts_count"]
2026-02-20T22:09:12.6988177Z      else:
2026-02-20T22:09:12.6988608Z -        c = db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar() or 0
2026-02-20T22:09:12.6988751Z +        c = (
2026-02-20T22:09:12.6989118Z +            db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar()
2026-02-20T22:09:12.6989247Z +            or 0
2026-02-20T22:09:12.6989359Z +        )
2026-02-20T22:09:12.6989502Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.6989642Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.6989757Z  
2026-02-20T22:09:12.6989860Z  
2026-02-20T22:09:12.6990015Z  def _progress_logic_attempts_count(
2026-02-20T22:09:12.6990399Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6990531Z +    db: Session,
2026-02-20T22:09:12.6990648Z +    user_id: int,
2026-02-20T22:09:12.6990789Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6990956Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6991115Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6991401Z      from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:12.6991528Z  
2026-02-20T22:09:12.6991688Z      t = req.get("logic_attempts_count")
2026-02-20T22:09:12.6991812Z      if t is None:
2026-02-20T22:09:12.6991947Z @@ -408,20 +462,26 @@
2026-02-20T22:09:12.6992183Z      if cache is not None and "logic_correct_count" in cache:
2026-02-20T22:09:12.6992340Z          c = cache["logic_correct_count"]
2026-02-20T22:09:12.6992456Z      else:
2026-02-20T22:09:12.6992577Z          c = (
2026-02-20T22:09:12.6992807Z              db.query(func.count(LogicChallengeAttempt.id))
2026-02-20T22:09:12.6993504Z -            .filter(LogicChallengeAttempt.user_id == user_id, LogicChallengeAttempt.is_correct == True)
2026-02-20T22:09:12.6993653Z +            .filter(
2026-02-20T22:09:12.6993861Z +                LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.6994065Z +                LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.6994186Z +            )
2026-02-20T22:09:12.6994309Z              .scalar()
2026-02-20T22:09:12.6994428Z              or 0
2026-02-20T22:09:12.6994537Z          )
2026-02-20T22:09:12.6994688Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.6994829Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.6994939Z  
2026-02-20T22:09:12.6995053Z  
2026-02-20T22:09:12.6995187Z  def _progress_mixte(
2026-02-20T22:09:12.6995536Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6995649Z +    db: Session,
2026-02-20T22:09:12.6995766Z +    user_id: int,
2026-02-20T22:09:12.6995890Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6996049Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6996457Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6996690Z      p1 = _progress_attempts_count(db, user_id, req, cache)
2026-02-20T22:09:12.6996952Z      p2 = _progress_logic_attempts_count(db, user_id, req, cache)
2026-02-20T22:09:12.6997092Z      if not p1 or not p2:
2026-02-20T22:09:12.6997227Z          return None
2026-02-20T22:09:12.6997579Z @@ -432,11 +492,14 @@
2026-02-20T22:09:12.6997745Z          return (round(prog, 2), cur1, tgt1)
2026-02-20T22:09:12.6997914Z      return (round(prog, 2), cur2, tgt2)
2026-02-20T22:09:12.6998021Z  
2026-02-20T22:09:12.6998131Z  
2026-02-20T22:09:12.6998279Z  def _progress_success_rate(
2026-02-20T22:09:12.6998665Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6998792Z +    db: Session,
2026-02-20T22:09:12.6998913Z +    user_id: int,
2026-02-20T22:09:12.6999050Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6999215Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6999384Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6999542Z      t = req.get("min_attempts")
2026-02-20T22:09:12.6999689Z      rate = req.get("success_rate")
2026-02-20T22:09:12.6999850Z      if t is None or rate is None:
2026-02-20T22:09:12.7000011Z          return None
2026-02-20T22:09:12.7000143Z @@ -444,11 +507,13 @@
2026-02-20T22:09:12.7000531Z      if cache is not None and "attempts_total" in cache and "attempts_correct" in cache:
2026-02-20T22:09:12.7000691Z          total = cache["attempts_total"]
2026-02-20T22:09:12.7000859Z          correct = cache["attempts_correct"]
2026-02-20T22:09:12.7000975Z      else:
2026-02-20T22:09:12.7001107Z          row = db.execute(
2026-02-20T22:09:12.7001617Z -            text("SELECT COUNT(*), COUNT(CASE WHEN is_correct THEN 1 END) FROM attempts WHERE user_id = :user_id"),
2026-02-20T22:09:12.7001753Z +            text(
2026-02-20T22:09:12.7002231Z +                "SELECT COUNT(*), COUNT(CASE WHEN is_correct THEN 1 END) FROM attempts WHERE user_id = :user_id"
2026-02-20T22:09:12.7002354Z +            ),
2026-02-20T22:09:12.7002507Z              {"user_id": user_id},
2026-02-20T22:09:12.7002631Z          ).fetchone()
2026-02-20T22:09:12.7002774Z          total = row[0] if row else 0
2026-02-20T22:09:12.7002924Z          correct = row[1] if row else 0
2026-02-20T22:09:12.7013533Z      p = min(1.0, total / max(1, t)) if total else 0.0
2026-02-20T22:09:12.7013721Z @@ -456,18 +521,25 @@
2026-02-20T22:09:12.7013842Z          p = 1.0
2026-02-20T22:09:12.7013999Z      return (round(p, 2), total, t)
2026-02-20T22:09:12.7014111Z  
2026-02-20T22:09:12.7014218Z  
2026-02-20T22:09:12.7014379Z  def _progress_consecutive(
2026-02-20T22:09:12.7014764Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7014888Z +    db: Session,
2026-02-20T22:09:12.7015005Z +    user_id: int,
2026-02-20T22:09:12.7015145Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7015318Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7015487Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7015755Z      ex_type = str(req.get("exercise_type", "addition")).lower()
2026-02-20T22:09:12.7015918Z      t = req.get("consecutive_correct")
2026-02-20T22:09:12.7016034Z      if t is None:
2026-02-20T22:09:12.7016163Z          return None
2026-02-20T22:09:12.7016272Z      t = int(t)
2026-02-20T22:09:12.7016774Z -    if cache is not None and "consecutive_by_type" in cache and ex_type in cache["consecutive_by_type"]:
2026-02-20T22:09:12.7016892Z +    if (
2026-02-20T22:09:12.7017034Z +        cache is not None
2026-02-20T22:09:12.7017192Z +        and "consecutive_by_type" in cache
2026-02-20T22:09:12.7017392Z +        and ex_type in cache["consecutive_by_type"]
2026-02-20T22:09:12.7017516Z +    ):
2026-02-20T22:09:12.7017720Z          streak = cache["consecutive_by_type"][ex_type]
2026-02-20T22:09:12.7017833Z      else:
2026-02-20T22:09:12.7017965Z          rows = db.execute(
2026-02-20T22:09:12.7018096Z              text("""
2026-02-20T22:09:12.7018592Z                  SELECT a.is_correct FROM attempts a
2026-02-20T22:09:12.7018727Z @@ -486,11 +558,14 @@
2026-02-20T22:09:12.7018879Z      p = min(1.0, streak / max(1, t))
2026-02-20T22:09:12.7019027Z      return (round(p, 2), streak, t)
2026-02-20T22:09:12.7019132Z  
2026-02-20T22:09:12.7019246Z  
2026-02-20T22:09:12.7019417Z  def _progress_consecutive_days(
2026-02-20T22:09:12.7020071Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7020197Z +    db: Session,
2026-02-20T22:09:12.7020333Z +    user_id: int,
2026-02-20T22:09:12.7020469Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7020635Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7020803Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7020958Z      t = req.get("consecutive_days")
2026-02-20T22:09:12.7021078Z      if t is None:
2026-02-20T22:09:12.7021200Z          return None
2026-02-20T22:09:12.7021323Z      t = int(t)
2026-02-20T22:09:12.7021452Z @@ -517,30 +592,42 @@
2026-02-20T22:09:12.7021587Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.7021735Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.7021841Z  
2026-02-20T22:09:12.7021946Z  
2026-02-20T22:09:12.7022088Z  def _progress_max_time(
2026-02-20T22:09:12.7022477Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7022608Z +    db: Session,
2026-02-20T22:09:12.7022726Z +    user_id: int,
2026-02-20T22:09:12.7022868Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7023246Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7023426Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7023565Z      max_t = req.get("max_time")
2026-02-20T22:09:12.7023695Z      if max_t is None:
2026-02-20T22:09:12.7023817Z          return None
2026-02-20T22:09:12.7024247Z      max_t = float(max_t)
2026-02-20T22:09:12.7025818Z      if cache is not None and "min_fast_time" in cache:
2026-02-20T22:09:12.7026226Z -        has_fast = cache["min_fast_time"] is not None and cache["min_fast_time"] <= max_t
2026-02-20T22:09:12.7026359Z +        has_fast = (
2026-02-20T22:09:12.7026683Z +            cache["min_fast_time"] is not None and cache["min_fast_time"] <= max_t
2026-02-20T22:09:12.7026798Z +        )
2026-02-20T22:09:12.7026912Z      else:
2026-02-20T22:09:12.7027040Z          fast = (
2026-02-20T22:09:12.7027187Z              db.query(Attempt)
2026-02-20T22:09:12.7027787Z -            .filter(Attempt.user_id == user_id, Attempt.is_correct == True, Attempt.time_spent <= max_t)
2026-02-20T22:09:12.7028500Z +            .filter(
2026-02-20T22:09:12.7028709Z +                Attempt.user_id == user_id,
2026-02-20T22:09:12.7028867Z +                Attempt.is_correct == True,
2026-02-20T22:09:12.7029031Z +                Attempt.time_spent <= max_t,
2026-02-20T22:09:12.7029147Z +            )
2026-02-20T22:09:12.7029420Z              .first()
2026-02-20T22:09:12.7029536Z          )
2026-02-20T22:09:12.7031093Z          has_fast = fast is not None
2026-02-20T22:09:12.7031376Z      return (1.0, 1, 1) if has_fast else (0.0, 0, 1)
2026-02-20T22:09:12.7035418Z  
2026-02-20T22:09:12.7035585Z  
2026-02-20T22:09:12.7035755Z  def _progress_perfect_day(
2026-02-20T22:09:12.7036160Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7036300Z +    db: Session,
2026-02-20T22:09:12.7036421Z +    user_id: int,
2026-02-20T22:09:12.7036563Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7036732Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7036893Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7037138Z      if cache is not None and "perfect_day_today" in cache:
2026-02-20T22:09:12.7037335Z          total, correct = cache["perfect_day_today"]
2026-02-20T22:09:12.7037450Z      else:
2026-02-20T22:09:12.7037640Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.7037770Z @@ -557,18 +644,27 @@
2026-02-20T22:09:12.7037898Z          return (0.0, 0, 1)
2026-02-20T22:09:12.7038413Z      return (1.0, 1, 1) if total == correct else (0.0, 0, 1)
2026-02-20T22:09:12.7038532Z  
2026-02-20T22:09:12.7038639Z  
2026-02-20T22:09:12.7038783Z  def _progress_all_types(
2026-02-20T22:09:12.7039169Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7039592Z -) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7039998Z -    if cache is not None and "exercise_types" in cache and "user_exercise_types" in cache:
2026-02-20T22:09:12.7040135Z +    db: Session,
2026-02-20T22:09:12.7040253Z +    user_id: int,
2026-02-20T22:09:12.7040385Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7040559Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7040718Z +) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7040828Z +    if (
2026-02-20T22:09:12.7040957Z +        cache is not None
2026-02-20T22:09:12.7041122Z +        and "exercise_types" in cache
2026-02-20T22:09:12.7041274Z +        and "user_exercise_types" in cache
2026-02-20T22:09:12.7041397Z +    ):
2026-02-20T22:09:12.7041582Z          all_set = set(cache["exercise_types"])
2026-02-20T22:09:12.7041758Z          user_set = cache["user_exercise_types"]
2026-02-20T22:09:12.7041870Z      else:
2026-02-20T22:09:12.7042004Z          all_rows = db.execute(
2026-02-20T22:09:12.7042552Z -            text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.7042674Z +            text(
2026-02-20T22:09:12.7043390Z +                "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.7043523Z +            )
2026-02-20T22:09:12.7043650Z          ).fetchall()
2026-02-20T22:09:12.7043773Z          if not all_rows:
2026-02-20T22:09:12.7043905Z              return None
2026-02-20T22:09:12.7044102Z          all_set = {str(r[0]).lower() for r in all_rows}
2026-02-20T22:09:12.7044240Z          user_rows = db.execute(
2026-02-20T22:09:12.7044369Z @@ -586,44 +682,52 @@
2026-02-20T22:09:12.7044508Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.7044646Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.7044757Z  
2026-02-20T22:09:12.7044871Z  
2026-02-20T22:09:12.7045003Z  def _progress_comeback(
2026-02-20T22:09:12.7045394Z -    _db: Session, _user_id: int, req: Dict[str, Any], _cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7045519Z +    _db: Session,
2026-02-20T22:09:12.7045646Z +    _user_id: int,
2026-02-20T22:09:12.7045780Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7045952Z +    _cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7046117Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7046373Z      """Comeback : pas de progression affichable (surprise)."""
2026-02-20T22:09:12.7046519Z      if "comeback_days" not in req:
2026-02-20T22:09:12.7046649Z          return None
2026-02-20T22:09:12.7046765Z      return (0.0, 0, 1)
2026-02-20T22:09:12.7046866Z  
2026-02-20T22:09:12.7046956Z  
2026-02-20T22:09:12.7047113Z  def _progress_min_per_type(
2026-02-20T22:09:12.7047468Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7047582Z +    db: Session,
2026-02-20T22:09:12.7047696Z +    user_id: int,
2026-02-20T22:09:12.7047818Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7047986Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7048135Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7048431Z      min_count = int(req.get("min_per_type", req.get("min_count", 5)))
2026-02-20T22:09:12.7048810Z      if cache is not None and "exercise_types" in cache and "per_type_correct" in cache:
2026-02-20T22:09:12.7048988Z          types_list = cache["exercise_types"]
2026-02-20T22:09:12.7049163Z          per_type = cache["per_type_correct"]
2026-02-20T22:09:12.7049444Z          min_cur = min((per_type.get(t, 0) for t in types_list), default=0)
2026-02-20T22:09:12.7049559Z      else:
2026-02-20T22:09:12.7049704Z          all_rows = db.execute(
2026-02-20T22:09:12.7050571Z -            text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.7050710Z +            text(
2026-02-20T22:09:12.7051199Z +                "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.7051547Z +            )
2026-02-20T22:09:12.7051676Z          ).fetchall()
2026-02-20T22:09:12.7051799Z          if not all_rows:
2026-02-20T22:09:12.7051923Z              return None
2026-02-20T22:09:12.7052054Z          min_cur = float("inf")
2026-02-20T22:09:12.7052185Z          for r in all_rows:
2026-02-20T22:09:12.7052333Z              ex_type = str(r[0]).lower()
2026-02-20T22:09:12.7052474Z              cnt = db.execute(
2026-02-20T22:09:12.7052602Z -                    text("""
2026-02-20T22:09:12.7052717Z +                text("""
2026-02-20T22:09:12.7052910Z                          SELECT COUNT(*) FROM attempts a
2026-02-20T22:09:12.7053356Z                          JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.7055431Z                          WHERE a.user_id = :user_id AND LOWER(e.exercise_type::text) = LOWER(:ex_type)
2026-02-20T22:09:12.7056275Z                          AND a.is_correct = true
2026-02-20T22:09:12.7057567Z                      """),
2026-02-20T22:09:12.7057831Z -                    {"user_id": user_id, "ex_type": ex_type},
2026-02-20T22:09:12.7143670Z -                ).fetchone()
2026-02-20T22:09:12.7144046Z +                {"user_id": user_id, "ex_type": ex_type},
2026-02-20T22:09:12.7144188Z +            ).fetchone()
2026-02-20T22:09:12.7144334Z              c = cnt[0] if cnt else 0
2026-02-20T22:09:12.7144491Z              min_cur = min(min_cur, c)
2026-02-20T22:09:12.7144740Z          min_cur = int(min_cur) if min_cur != float("inf") else 0
2026-02-20T22:09:12.7144861Z      t = min_count
2026-02-20T22:09:12.7145148Z      min_cur = int(min_cur) if isinstance(min_cur, float) else min_cur
2026-02-20T22:09:12.7145751Z would reformat /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py
2026-02-20T22:09:12.8794218Z --- /home/runner/work/mathakine/mathakine/app/services/badge_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.8795528Z +++ /home/runner/work/mathakine/mathakine/app/services/badge_service.py	2026-02-20 22:09:12.865127+00:00
2026-02-20T22:09:12.8796318Z @@ -15,78 +15,95 @@
2026-02-20T22:09:12.8796705Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.8797340Z  from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:12.8797972Z  from app.models.attempt import Attempt
2026-02-20T22:09:12.8798417Z  from app.models.progress import Progress
2026-02-20T22:09:12.8798861Z  from app.models.user import User
2026-02-20T22:09:12.8799567Z -from app.services.badge_requirement_engine import check_requirements, get_requirement_progress
2026-02-20T22:09:12.8800431Z +from app.services.badge_requirement_engine import (
2026-02-20T22:09:12.8800914Z +    check_requirements,
2026-02-20T22:09:12.8801275Z +    get_requirement_progress,
2026-02-20T22:09:12.8801614Z +)
2026-02-20T22:09:12.8801837Z  
2026-02-20T22:09:12.8802089Z  logger = get_logger(__name__)
2026-02-20T22:09:12.8802408Z +
2026-02-20T22:09:12.8802628Z  
2026-02-20T22:09:12.8802888Z  class BadgeService:
2026-02-20T22:09:12.8803539Z      """Service pour la gestion des badges et achievements"""
2026-02-20T22:09:12.8804050Z -    
2026-02-20T22:09:12.8804315Z +
2026-02-20T22:09:12.8804608Z      def __init__(self, db: Session):
2026-02-20T22:09:12.8805025Z          self.db = db
2026-02-20T22:09:12.8805333Z -    
2026-02-20T22:09:12.8806014Z -    def check_and_award_badges(self, user_id: int, attempt_data: Dict[str, Any] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.8806840Z +
2026-02-20T22:09:12.8807116Z +    def check_and_award_badges(
2026-02-20T22:09:12.8807622Z +        self, user_id: int, attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8808173Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.8808964Z          """
2026-02-20T22:09:12.8809753Z          Vérifier et attribuer les badges mérités par un utilisateur
2026-02-20T22:09:12.8810317Z -        
2026-02-20T22:09:12.8810584Z +
2026-02-20T22:09:12.8810829Z          Args:
2026-02-20T22:09:12.8811146Z              user_id: ID de l'utilisateur
2026-02-20T22:09:12.8812114Z              attempt_data: Données de la dernière tentative (optionnel)
2026-02-20T22:09:12.8812681Z -            
2026-02-20T22:09:12.8813140Z +
2026-02-20T22:09:12.8813402Z          Returns:
2026-02-20T22:09:12.8813806Z              Liste des nouveaux badges obtenus
2026-02-20T22:09:12.8814244Z          """
2026-02-20T22:09:12.8814518Z          try:
2026-02-20T22:09:12.8814946Z              user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.8815511Z              if not user:
2026-02-20T22:09:12.8816110Z                  logger.error(f"Utilisateur {user_id} non trouvé")
2026-02-20T22:09:12.8816640Z                  return []
2026-02-20T22:09:12.8816981Z -            
2026-02-20T22:09:12.8817256Z +
2026-02-20T22:09:12.8817674Z              # Récupérer tous les badges disponibles
2026-02-20T22:09:12.8818275Z -            available_badges = self.db.query(Achievement).filter(
2026-02-20T22:09:12.8818835Z -                Achievement.is_active == True
2026-02-20T22:09:12.8819269Z -            ).all()
2026-02-20T22:09:12.8819570Z -            
2026-02-20T22:09:12.8819860Z +            available_badges = (
2026-02-20T22:09:12.8820463Z +                self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.8821085Z +            )
2026-02-20T22:09:12.8821353Z +
2026-02-20T22:09:12.8821818Z              # Récupérer les badges déjà obtenus - CORRECTION
2026-02-20T22:09:12.8822332Z              earned_badge_ids = set(
2026-02-20T22:09:12.8830822Z -                badge_id[0] for badge_id in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.8832546Z +                badge_id[0]
2026-02-20T22:09:12.8833475Z +                for badge_id in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.8834165Z                  .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:12.8834659Z                  .all()
2026-02-20T22:09:12.8834966Z              )
2026-02-20T22:09:12.8835244Z -            
2026-02-20T22:09:12.8835521Z +
2026-02-20T22:09:12.8835794Z              new_badges = []
2026-02-20T22:09:12.8836141Z -            
2026-02-20T22:09:12.8836402Z +
2026-02-20T22:09:12.8836688Z              for badge in available_badges:
2026-02-20T22:09:12.8837157Z                  if badge.id not in earned_badge_ids:
2026-02-20T22:09:12.8837790Z                      if self._check_badge_requirements(user_id, badge, attempt_data):
2026-02-20T22:09:12.8838480Z                          new_badge = self._award_badge(user_id, badge)
2026-02-20T22:09:12.8838991Z                          if new_badge:
2026-02-20T22:09:12.8839435Z                              new_badges.append(new_badge)
2026-02-20T22:09:12.8840401Z -                            logger.info(f"🎖️ Badge '{badge.name}' attribué à l'utilisateur {user_id}")
2026-02-20T22:09:12.8841089Z -            
2026-02-20T22:09:12.8841397Z +                            logger.info(
2026-02-20T22:09:12.8842142Z +                                f"🎖️ Badge '{badge.name}' attribué à l'utilisateur {user_id}"
2026-02-20T22:09:12.8842749Z +                            )
2026-02-20T22:09:12.8843261Z +
2026-02-20T22:09:12.8843673Z              # Mettre à jour les points et le niveau
2026-02-20T22:09:12.8844131Z              if new_badges:
2026-02-20T22:09:12.8844551Z                  self._update_user_gamification(user_id, new_badges)
2026-02-20T22:09:12.8845062Z -            
2026-02-20T22:09:12.8845337Z +
2026-02-20T22:09:12.8845596Z              return new_badges
2026-02-20T22:09:12.8845939Z -            
2026-02-20T22:09:12.8846194Z +
2026-02-20T22:09:12.8846496Z          except Exception as badge_check_error:
2026-02-20T22:09:12.8847547Z -            logger.error(f"Erreur lors de la vérification des badges pour l'utilisateur {user_id}: {badge_check_error}")
2026-02-20T22:09:12.8848698Z +            logger.error(
2026-02-20T22:09:12.8849566Z +                f"Erreur lors de la vérification des badges pour l'utilisateur {user_id}: {badge_check_error}"
2026-02-20T22:09:12.8850333Z +            )
2026-02-20T22:09:12.8850865Z              return []
2026-02-20T22:09:12.8851169Z -    
2026-02-20T22:09:12.8851976Z would reformat /home/runner/work/mathakine/mathakine/app/services/badge_service.py
2026-02-20T22:09:12.8853430Z -    def _check_badge_requirements(self, user_id: int, badge: Achievement, attempt_data: Dict[str, Any] = None) -> bool:
2026-02-20T22:09:12.8854292Z +
2026-02-20T22:09:12.8854565Z +    def _check_badge_requirements(
2026-02-20T22:09:12.8855172Z +        self, user_id: int, badge: Achievement, attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8855787Z +    ) -> bool:
2026-02-20T22:09:12.8856386Z          """Vérifier si un utilisateur remplit les conditions pour un badge.
2026-02-20T22:09:12.8857338Z          Lot C : moteur générique d'abord, fallback par code pour rétrocompatibilité.
2026-02-20T22:09:12.8857953Z          """
2026-02-20T22:09:12.8858260Z          if not badge.requirements:
2026-02-20T22:09:12.8858649Z              return False
2026-02-20T22:09:12.8858974Z  
2026-02-20T22:09:12.8859221Z          try:
2026-02-20T22:09:12.8859972Z -            requirements = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.8860866Z +            requirements = (
2026-02-20T22:09:12.8861260Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.8861766Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.8862246Z +                else badge.requirements
2026-02-20T22:09:12.8862641Z +            )
2026-02-20T22:09:12.8863240Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.8864640Z              logger.error(f"Requirements invalides pour le badge {badge.code}")
2026-02-20T22:09:12.8923456Z              return False
2026-02-20T22:09:12.8923839Z  
2026-02-20T22:09:12.8924179Z          if not isinstance(requirements, dict):
2026-02-20T22:09:12.8924656Z @@ -96,483 +113,566 @@
2026-02-20T22:09:12.8925236Z          result = check_requirements(self.db, user_id, requirements, attempt_data)
2026-02-20T22:09:12.8925935Z          if result is not None:
2026-02-20T22:09:12.8926339Z              return result
2026-02-20T22:09:12.8926682Z  
2026-02-20T22:09:12.8927381Z          # Fallback par code pour rétrocompatibilité (badges sans schéma reconnu)
2026-02-20T22:09:12.8928419Z -        return self._check_badge_requirements_by_code(user_id, badge, requirements, attempt_data)
2026-02-20T22:09:12.8929290Z +        return self._check_badge_requirements_by_code(
2026-02-20T22:09:12.8929861Z +            user_id, badge, requirements, attempt_data
2026-02-20T22:09:12.8930325Z +        )
2026-02-20T22:09:12.8930601Z  
2026-02-20T22:09:12.8930920Z      def _check_badge_requirements_by_code(
2026-02-20T22:09:12.8931789Z -        self, user_id: int, badge: Achievement, requirements: Dict[str, Any], attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8932645Z +        self,
2026-02-20T22:09:12.8933148Z +        user_id: int,
2026-02-20T22:09:12.8933517Z +        badge: Achievement,
2026-02-20T22:09:12.8933911Z +        requirements: Dict[str, Any],
2026-02-20T22:09:12.8934361Z +        attempt_data: Dict[str, Any] = None,
2026-02-20T22:09:12.8934796Z      ) -> bool:
2026-02-20T22:09:12.8935415Z          """Fallback : vérification par code (rétrocompatibilité)."""
2026-02-20T22:09:12.8936043Z          # BADGE: Premiers Pas (1 tentative)
2026-02-20T22:09:12.8936511Z -        if badge.code == 'first_steps':
2026-02-20T22:09:12.8937117Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8937787Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8938225Z -            ).scalar()
2026-02-20T22:09:12.8939043Z -            return attempts_count >= requirements.get('attempts_count', 1)
2026-02-20T22:09:12.8939638Z -        
2026-02-20T22:09:12.8939947Z +        if badge.code == "first_steps":
2026-02-20T22:09:12.8940393Z +            attempts_count = (
2026-02-20T22:09:12.8940841Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8941689Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8942161Z +                .scalar()
2026-02-20T22:09:12.8942503Z +            )
2026-02-20T22:09:12.8943183Z +            return attempts_count >= requirements.get("attempts_count", 1)
2026-02-20T22:09:12.8943779Z +
2026-02-20T22:09:12.8944105Z          # BADGE: Voie du Padawan (10 tentatives)
2026-02-20T22:09:12.8944598Z -        elif badge.code == 'padawan_path':
2026-02-20T22:09:12.8945225Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8945847Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8946281Z -            ).scalar()
2026-02-20T22:09:12.8946806Z -            return attempts_count >= requirements.get('attempts_count', 10)
2026-02-20T22:09:12.8947414Z -        
2026-02-20T22:09:12.8947740Z +        elif badge.code == "padawan_path":
2026-02-20T22:09:12.8948193Z +            attempts_count = (
2026-02-20T22:09:12.8948651Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8949211Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8949701Z +                .scalar()
2026-02-20T22:09:12.8950051Z +            )
2026-02-20T22:09:12.8950538Z +            return attempts_count >= requirements.get("attempts_count", 10)
2026-02-20T22:09:12.8951145Z +
2026-02-20T22:09:12.8951659Z          # BADGE: Épreuve du Chevalier (50 tentatives)
2026-02-20T22:09:12.8952201Z -        elif badge.code == 'knight_trial':
2026-02-20T22:09:12.8952836Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8983822Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8984320Z -            ).scalar()
2026-02-20T22:09:12.8984874Z -            return attempts_count >= requirements.get('attempts_count', 50)
2026-02-20T22:09:12.8985484Z -        
2026-02-20T22:09:12.8985824Z +        elif badge.code == "knight_trial":
2026-02-20T22:09:12.8986288Z +            attempts_count = (
2026-02-20T22:09:12.8986758Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8987305Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8987773Z +                .scalar()
2026-02-20T22:09:12.8988120Z +            )
2026-02-20T22:09:12.8988616Z +            return attempts_count >= requirements.get("attempts_count", 50)
2026-02-20T22:09:12.8989223Z +
2026-02-20T22:09:12.8989809Z          # BADGE: Maître des Additions (20 additions consécutives)
2026-02-20T22:09:12.8990440Z -        elif badge.code == 'addition_master':
2026-02-20T22:09:12.8990983Z -            return self._check_consecutive_success(
2026-02-20T22:09:12.8991491Z -                user_id, 
2026-02-20T22:09:12.8991963Z -                requirements.get('exercise_type', 'addition'),
2026-02-20T22:09:12.8992583Z -                requirements.get('consecutive_correct', 20)
2026-02-20T22:09:12.8993278Z -            )
2026-02-20T22:09:12.8993586Z -        
2026-02-20T22:09:12.8994183Z -        # BADGE: Éclair de Vitesse (exercice en moins de 5 secondes)
2026-02-20T22:09:12.8994813Z -        elif badge.code == 'speed_demon':
2026-02-20T22:09:12.8995368Z -            max_time = requirements.get('max_time', 5)
2026-02-20T22:09:12.8996116Z -            if attempt_data and attempt_data.get('time_spent', float('inf')) <= max_time:
2026-02-20T22:09:12.8996815Z -                return True
2026-02-20T22:09:12.8997176Z -            
2026-02-20T22:09:12.8997624Z -            # Vérifier dans l'historique
2026-02-20T22:09:12.8998167Z -            fast_attempt = self.db.query(Attempt).filter(
2026-02-20T22:09:12.8998710Z -                Attempt.user_id == user_id,
2026-02-20T22:09:12.8999469Z -                Attempt.is_correct == True,
2026-02-20T22:09:12.8999952Z -                Attempt.time_spent <= max_time
2026-02-20T22:09:12.9000417Z -            ).first()
2026-02-20T22:09:12.9000804Z -            return fast_attempt is not None
2026-02-20T22:09:12.9001244Z -        
2026-02-20T22:09:12.9001908Z -        # BADGE: Journée Parfaite (tous les exercices d'une journée réussis)
2026-02-20T22:09:12.9002851Z -        elif badge.code == 'perfect_day':
2026-02-20T22:09:12.9003580Z -            return self._check_perfect_day(user_id)
2026-02-20T22:09:12.9004054Z -        
2026-02-20T22:09:12.9004527Z -        # BADGE: Maître Jedi (100 tentatives)
2026-02-20T22:09:12.9005026Z -        elif badge.code == 'jedi_master':
2026-02-20T22:09:12.9005661Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.9006329Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.9006763Z -            ).scalar()
2026-02-20T22:09:12.9007306Z -            return attempts_count >= requirements.get('attempts_count', 100)
2026-02-20T22:09:12.9007940Z -        
2026-02-20T22:09:12.9008408Z -        # BADGE: Grand Maître (200 tentatives)
2026-02-20T22:09:12.9008893Z -        elif badge.code == 'grand_master':
2026-02-20T22:09:12.9009504Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.9010264Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.9010703Z -            ).scalar()
2026-02-20T22:09:12.9011230Z -            return attempts_count >= requirements.get('attempts_count', 200)
2026-02-20T22:09:12.9011839Z -        
2026-02-20T22:09:12.9012479Z -        # BADGE: Maître des Soustractions (15 soustractions consécutives)
2026-02-20T22:09:12.9043466Z -        elif badge.code == 'subtraction_master':
2026-02-20T22:09:12.9044050Z +        elif badge.code == "addition_master":
2026-02-20T22:09:12.9044589Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9045081Z                  user_id,
2026-02-20T22:09:12.9045586Z -                requirements.get('exercise_type', 'soustraction'),
2026-02-20T22:09:12.9046238Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9046750Z -            )
2026-02-20T22:09:12.9047039Z -        
2026-02-20T22:09:12.9047735Z -        # BADGE: Maître des Multiplications (15 multiplications consécutives)
2026-02-20T22:09:12.9048498Z -        elif badge.code == 'multiplication_master':
2026-02-20T22:09:12.9049095Z +                requirements.get("exercise_type", "addition"),
2026-02-20T22:09:12.9049705Z +                requirements.get("consecutive_correct", 20),
2026-02-20T22:09:12.9050211Z +            )
2026-02-20T22:09:12.9050510Z +
2026-02-20T22:09:12.9051165Z +        # BADGE: Éclair de Vitesse (exercice en moins de 5 secondes)
2026-02-20T22:09:12.9051763Z +        elif badge.code == "speed_demon":
2026-02-20T22:09:12.9052281Z +            max_time = requirements.get("max_time", 5)
2026-02-20T22:09:12.9052774Z +            if (
2026-02-20T22:09:12.9053298Z +                attempt_data
2026-02-20T22:09:12.9053832Z +                and attempt_data.get("time_spent", float("inf")) <= max_time
2026-02-20T22:09:12.9054430Z +            ):
2026-02-20T22:09:12.9054744Z +                return True
2026-02-20T22:09:12.9055103Z +
2026-02-20T22:09:12.9055533Z +            # Vérifier dans l'historique
2026-02-20T22:09:12.9056023Z +            fast_attempt = (
2026-02-20T22:09:12.9056428Z +                self.db.query(Attempt)
2026-02-20T22:09:12.9056865Z +                .filter(
2026-02-20T22:09:12.9057255Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:12.9057754Z +                    Attempt.is_correct == True,
2026-02-20T22:09:12.9058257Z +                    Attempt.time_spent <= max_time,
2026-02-20T22:09:12.9058722Z +                )
2026-02-20T22:09:12.9059040Z +                .first()
2026-02-20T22:09:12.9059365Z +            )
2026-02-20T22:09:12.9059710Z +            return fast_attempt is not None
2026-02-20T22:09:12.9060428Z +
2026-02-20T22:09:12.9061088Z +        # BADGE: Journée Parfaite (tous les exercices d'une journée réussis)
2026-02-20T22:09:12.9061769Z +        elif badge.code == "perfect_day":
2026-02-20T22:09:12.9062291Z +            return self._check_perfect_day(user_id)
2026-02-20T22:09:12.9062762Z +
2026-02-20T22:09:12.9063403Z +        # BADGE: Maître Jedi (100 tentatives)
2026-02-20T22:09:12.9064161Z +        elif badge.code == "jedi_master":
2026-02-20T22:09:12.9064617Z +            attempts_count = (
2026-02-20T22:09:12.9065070Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.9065602Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.9066082Z +                .scalar()
2026-02-20T22:09:12.9066422Z +            )
2026-02-20T22:09:12.9066926Z +            return attempts_count >= requirements.get("attempts_count", 100)
2026-02-20T22:09:12.9067532Z +
2026-02-20T22:09:12.9067986Z +        # BADGE: Grand Maître (200 tentatives)
2026-02-20T22:09:12.9068503Z +        elif badge.code == "grand_master":
2026-02-20T22:09:12.9068965Z +            attempts_count = (
2026-02-20T22:09:12.9069425Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.9069954Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.9070433Z +                .scalar()
2026-02-20T22:09:12.9070795Z +            )
2026-02-20T22:09:12.9071290Z +            return attempts_count >= requirements.get("attempts_count", 200)
2026-02-20T22:09:12.9071893Z +
2026-02-20T22:09:12.9072518Z +        # BADGE: Maître des Soustractions (15 soustractions consécutives)
2026-02-20T22:09:12.9103521Z +        elif badge.code == "subtraction_master":
2026-02-20T22:09:12.9104114Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9104619Z                  user_id,
2026-02-20T22:09:12.9105114Z -                requirements.get('exercise_type', 'multiplication'),
2026-02-20T22:09:12.9105791Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9106315Z -            )
2026-02-20T22:09:12.9106611Z -        
2026-02-20T22:09:12.9107215Z -        # BADGE: Maître des Divisions (15 divisions consécutives)
2026-02-20T22:09:12.9107850Z -        elif badge.code == 'division_master':
2026-02-20T22:09:12.9108536Z +                requirements.get("exercise_type", "soustraction"),
2026-02-20T22:09:12.9109206Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9109719Z +            )
2026-02-20T22:09:12.9109998Z +
2026-02-20T22:09:12.9110643Z +        # BADGE: Maître des Multiplications (15 multiplications consécutives)
2026-02-20T22:09:12.9111361Z +        elif badge.code == "multiplication_master":
2026-02-20T22:09:12.9111922Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9112409Z                  user_id,
2026-02-20T22:09:12.9114010Z -                requirements.get('exercise_type', 'division'),
2026-02-20T22:09:12.9114672Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9115194Z -            )
2026-02-20T22:09:12.9115498Z -        
2026-02-20T22:09:12.9115923Z +                requirements.get("exercise_type", "multiplication"),
2026-02-20T22:09:12.9116593Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9117095Z +            )
2026-02-20T22:09:12.9117388Z +
2026-02-20T22:09:12.9117968Z +        # BADGE: Maître des Divisions (15 divisions consécutives)
2026-02-20T22:09:12.9118588Z +        elif badge.code == "division_master":
2026-02-20T22:09:12.9119122Z +            return self._check_consecutive_success(
2026-02-20T22:09:12.9119590Z +                user_id,
2026-02-20T22:09:12.9120054Z +                requirements.get("exercise_type", "division"),
2026-02-20T22:09:12.9120665Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9121169Z +            )
2026-02-20T22:09:12.9121441Z +
2026-02-20T22:09:12.9122008Z          # BADGE: Expert (taux de réussite ≥ 80% sur 50 tentatives)
2026-02-20T22:09:12.9122872Z -        elif badge.code == 'expert':
2026-02-20T22:09:12.9123534Z +        elif badge.code == "expert":
2026-02-20T22:09:12.9124005Z              return self._check_success_rate(
2026-02-20T22:09:12.9124449Z                  user_id,
2026-02-20T22:09:12.9124862Z -                requirements.get('success_rate', 80),
2026-02-20T22:09:12.9125676Z -                requirements.get('min_attempts', 50)
2026-02-20T22:09:12.9126161Z -            )
2026-02-20T22:09:12.9126446Z -        
2026-02-20T22:09:12.9126798Z +                requirements.get("success_rate", 80),
2026-02-20T22:09:12.9127339Z +                requirements.get("min_attempts", 50),
2026-02-20T22:09:12.9127809Z +            )
2026-02-20T22:09:12.9128101Z +
2026-02-20T22:09:12.9128738Z          # BADGE: Perfectionniste (taux de réussite ≥ 95% sur 30 tentatives)
2026-02-20T22:09:12.9129428Z -        elif badge.code == 'perfectionist':
2026-02-20T22:09:12.9129939Z +        elif badge.code == "perfectionist":
2026-02-20T22:09:12.9130450Z              return self._check_success_rate(
2026-02-20T22:09:12.9130888Z                  user_id,
2026-02-20T22:09:12.9131287Z -                requirements.get('success_rate', 95),
2026-02-20T22:09:12.9131828Z -                requirements.get('min_attempts', 30)
2026-02-20T22:09:12.9132296Z -            )
2026-02-20T22:09:12.9132598Z -        
2026-02-20T22:09:12.9132949Z +                requirements.get("success_rate", 95),
2026-02-20T22:09:12.9163860Z +                requirements.get("min_attempts", 30),
2026-02-20T22:09:12.9164351Z +            )
2026-02-20T22:09:12.9164648Z +
2026-02-20T22:09:12.9165173Z          # BADGE: Semaine Parfaite (7 jours consécutifs)
2026-02-20T22:09:12.9165734Z -        elif badge.code == 'perfect_week':
2026-02-20T22:09:12.9166228Z +        elif badge.code == "perfect_week":
2026-02-20T22:09:12.9166749Z              return self._check_consecutive_days(
2026-02-20T22:09:12.9167228Z -                user_id,
2026-02-20T22:09:12.9167657Z -                requirements.get('consecutive_days', 7)
2026-02-20T22:09:12.9168166Z -            )
2026-02-20T22:09:12.9168458Z -        
2026-02-20T22:09:12.9168857Z +                user_id, requirements.get("consecutive_days", 7)
2026-02-20T22:09:12.9169367Z +            )
2026-02-20T22:09:12.9169650Z +
2026-02-20T22:09:12.9170126Z          # BADGE: Mois Parfait (30 jours consécutifs)
2026-02-20T22:09:12.9170674Z -        elif badge.code == 'perfect_month':
2026-02-20T22:09:12.9171161Z +        elif badge.code == "perfect_month":
2026-02-20T22:09:12.9171646Z              return self._check_consecutive_days(
2026-02-20T22:09:12.9172118Z -                user_id,
2026-02-20T22:09:12.9172546Z -                requirements.get('consecutive_days', 30)
2026-02-20T22:09:12.9173231Z -            )
2026-02-20T22:09:12.9173540Z -        
2026-02-20T22:09:12.9173944Z +                user_id, requirements.get("consecutive_days", 30)
2026-02-20T22:09:12.9174472Z +            )
2026-02-20T22:09:12.9174769Z +
2026-02-20T22:09:12.9175179Z          # BADGE: Explorateur (essayer tous les types d'exercices)
2026-02-20T22:09:12.9175792Z -        elif badge.code == 'explorer':
2026-02-20T22:09:12.9176266Z +        elif badge.code == "explorer":
2026-02-20T22:09:12.9176793Z              return self._check_all_exercise_types(user_id)
2026-02-20T22:09:12.9177291Z -        
2026-02-20T22:09:12.9177561Z +
2026-02-20T22:09:12.9178193Z          # BADGE: Polyvalent (réussir au moins 5 exercices de chaque type)
2026-02-20T22:09:12.9178858Z -        elif badge.code == 'versatile':
2026-02-20T22:09:12.9179333Z +        elif badge.code == "versatile":
2026-02-20T22:09:12.9179806Z              return self._check_min_per_type(
2026-02-20T22:09:12.9180268Z -                user_id,
2026-02-20T22:09:12.9180698Z -                requirements.get('min_per_type', 5)
2026-02-20T22:09:12.9181176Z -            )
2026-02-20T22:09:12.9181486Z -        
2026-02-20T22:09:12.9181873Z +                user_id, requirements.get("min_per_type", 5)
2026-02-20T22:09:12.9182380Z +            )
2026-02-20T22:09:12.9182946Z +
2026-02-20T22:09:12.9183439Z          return False
2026-02-20T22:09:12.9183762Z -    
2026-02-20T22:09:12.9184435Z -    def _check_consecutive_success(self, user_id: int, exercise_type: str, required_streak: int) -> bool:
2026-02-20T22:09:12.9185258Z +
2026-02-20T22:09:12.9185567Z +    def _check_consecutive_success(
2026-02-20T22:09:12.9186408Z +        self, user_id: int, exercise_type: str, required_streak: int
2026-02-20T22:09:12.9186978Z +    ) -> bool:
2026-02-20T22:09:12.9187672Z          """Vérifier une série consécutive de succès pour un type d'exercice"""
2026-02-20T22:09:12.9188294Z -        
2026-02-20T22:09:12.9188584Z +
2026-02-20T22:09:12.9189154Z          # Récupérer les dernières tentatives pour ce type d'exercice
2026-02-20T22:09:12.9189793Z -        attempts = self.db.execute(text("""
2026-02-20T22:09:12.9190268Z +        attempts = self.db.execute(
2026-02-20T22:09:12.9190688Z +            text("""
2026-02-20T22:09:12.9191036Z              SELECT a.is_correct
2026-02-20T22:09:12.9191439Z              FROM attempts a
2026-02-20T22:09:12.9191865Z              JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9192347Z              WHERE a.user_id = :user_id 
2026-02-20T22:09:12.9192808Z              AND e.exercise_type = :exercise_type
2026-02-20T22:09:12.9223564Z              ORDER BY a.created_at DESC
2026-02-20T22:09:12.9224024Z              LIMIT :limit
2026-02-20T22:09:12.9224344Z -        """), {
2026-02-20T22:09:12.9224626Z -            "user_id": user_id,
2026-02-20T22:09:12.9225036Z -            "exercise_type": exercise_type,
2026-02-20T22:09:12.9225770Z -            "limit": required_streak * 2  # Prendre plus pour être sûr
2026-02-20T22:09:12.9226336Z -        }).fetchall()
2026-02-20T22:09:12.9226651Z -        
2026-02-20T22:09:12.9226917Z +        """),
2026-02-20T22:09:12.9227189Z +            {
2026-02-20T22:09:12.9227503Z +                "user_id": user_id,
2026-02-20T22:09:12.9227939Z +                "exercise_type": exercise_type,
2026-02-20T22:09:12.9228673Z +                "limit": required_streak * 2,  # Prendre plus pour être sûr
2026-02-20T22:09:12.9229242Z +            },
2026-02-20T22:09:12.9229535Z +        ).fetchall()
2026-02-20T22:09:12.9229845Z +
2026-02-20T22:09:12.9230140Z          if len(attempts) < required_streak:
2026-02-20T22:09:12.9230573Z              return False
2026-02-20T22:09:12.9230908Z -        
2026-02-20T22:09:12.9231162Z +
2026-02-20T22:09:12.9231551Z          # Compter la série actuelle de succès
2026-02-20T22:09:12.9232006Z          current_streak = 0
2026-02-20T22:09:12.9232374Z          for attempt in attempts:
2026-02-20T22:09:12.9233266Z              if attempt.is_correct:  # Accès direct à l'attribut au lieu de [0]
2026-02-20T22:09:12.9233896Z                  current_streak += 1
2026-02-20T22:09:12.9234347Z                  if current_streak >= required_streak:
2026-02-20T22:09:12.9234816Z                      return True
2026-02-20T22:09:12.9235168Z              else:
2026-02-20T22:09:12.9235609Z                  break  # Série interrompue
2026-02-20T22:09:12.9236015Z -        
2026-02-20T22:09:12.9236279Z +
2026-02-20T22:09:12.9236534Z          return False
2026-02-20T22:09:12.9236842Z -    
2026-02-20T22:09:12.9237089Z +
2026-02-20T22:09:12.9237433Z      def _check_perfect_day(self, user_id: int) -> bool:
2026-02-20T22:09:12.9238159Z          """Vérifier si l'utilisateur a eu une journée parfaite"""
2026-02-20T22:09:12.9238699Z -        
2026-02-20T22:09:12.9238969Z +
2026-02-20T22:09:12.9239284Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9239735Z -        
2026-02-20T22:09:12.9239985Z +
2026-02-20T22:09:12.9240427Z          # Récupérer toutes les tentatives d'aujourd'hui
2026-02-20T22:09:12.9240967Z -        today_attempts = self.db.execute(text("""
2026-02-20T22:09:12.9241459Z +        today_attempts = self.db.execute(
2026-02-20T22:09:12.9241876Z +            text("""
2026-02-20T22:09:12.9242195Z              SELECT COUNT(*) as total, 
2026-02-20T22:09:12.9242937Z                     COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9243626Z              FROM attempts
2026-02-20T22:09:12.9243991Z              WHERE user_id = :user_id 
2026-02-20T22:09:12.9244405Z              AND DATE(created_at) = :today
2026-02-20T22:09:12.9244810Z -        """), {
2026-02-20T22:09:12.9245111Z -            "user_id": user_id,
2026-02-20T22:09:12.9245667Z -            "today": today
2026-02-20T22:09:12.9246001Z -        }).fetchone()
2026-02-20T22:09:12.9246316Z -        
2026-02-20T22:09:12.9246569Z +        """),
2026-02-20T22:09:12.9246884Z +            {"user_id": user_id, "today": today},
2026-02-20T22:09:12.9247314Z +        ).fetchone()
2026-02-20T22:09:12.9247597Z +
2026-02-20T22:09:12.9247959Z          if not today_attempts or today_attempts.total == 0:
2026-02-20T22:09:12.9248442Z              return False
2026-02-20T22:09:12.9248756Z -        
2026-02-20T22:09:12.9249012Z +
2026-02-20T22:09:12.9249601Z          # Tous les exercices doivent être réussis ET au moins 3 exercices
2026-02-20T22:09:12.9250479Z -        return today_attempts.correct == today_attempts.total and today_attempts.total >= 3
2026-02-20T22:09:12.9251199Z -    
2026-02-20T22:09:12.9251801Z -    def _check_success_rate(self, user_id: int, min_success_rate: float, min_attempts: int) -> bool:
2026-02-20T22:09:12.9252533Z +        return (
2026-02-20T22:09:12.9273462Z +            today_attempts.correct == today_attempts.total and today_attempts.total >= 3
2026-02-20T22:09:12.9274209Z +        )
2026-02-20T22:09:12.9274489Z +
2026-02-20T22:09:12.9274766Z +    def _check_success_rate(
2026-02-20T22:09:12.9275316Z +        self, user_id: int, min_success_rate: float, min_attempts: int
2026-02-20T22:09:12.9275885Z +    ) -> bool:
2026-02-20T22:09:12.9276783Z          """Vérifier si l'utilisateur atteint un taux de réussite minimum sur un nombre minimum de tentatives"""
2026-02-20T22:09:12.9277593Z -        
2026-02-20T22:09:12.9277902Z -        stats = self.db.execute(text("""
2026-02-20T22:09:12.9278348Z +
2026-02-20T22:09:12.9278617Z +        stats = self.db.execute(
2026-02-20T22:09:12.9279010Z +            text("""
2026-02-20T22:09:12.9279325Z              SELECT 
2026-02-20T22:09:12.9279658Z                  COUNT(*) as total,
2026-02-20T22:09:12.9280150Z                  COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9280693Z              FROM attempts
2026-02-20T22:09:12.9281067Z              WHERE user_id = :user_id
2026-02-20T22:09:12.9281460Z -        """), {
2026-02-20T22:09:12.9281776Z -            "user_id": user_id
2026-02-20T22:09:12.9282144Z -        }).fetchone()
2026-02-20T22:09:12.9282459Z -        
2026-02-20T22:09:12.9282722Z +        """),
2026-02-20T22:09:12.9283201Z +            {"user_id": user_id},
2026-02-20T22:09:12.9283594Z +        ).fetchone()
2026-02-20T22:09:12.9283909Z +
2026-02-20T22:09:12.9284230Z          if not stats or stats.total < min_attempts:
2026-02-20T22:09:12.9284707Z              return False
2026-02-20T22:09:12.9285040Z -        
2026-02-20T22:09:12.9285302Z +
2026-02-20T22:09:12.9285666Z          success_rate = (stats.correct / stats.total) * 100
2026-02-20T22:09:12.9286221Z          return success_rate >= min_success_rate
2026-02-20T22:09:12.9286655Z -    
2026-02-20T22:09:12.9286760Z +
2026-02-20T22:09:12.9287118Z      def _check_consecutive_days(self, user_id: int, required_days: int) -> bool:
2026-02-20T22:09:12.9287678Z          """Vérifier si l'utilisateur a fait des exercices pendant X jours consécutifs"""
2026-02-20T22:09:12.9287793Z -        
2026-02-20T22:09:12.9287900Z +
2026-02-20T22:09:12.9288417Z          # Récupérer les jours uniques avec des tentatives, triés par date décroissante
2026-02-20T22:09:12.9288580Z -        days = self.db.execute(text("""
2026-02-20T22:09:12.9288716Z +        days = self.db.execute(
2026-02-20T22:09:12.9288835Z +            text("""
2026-02-20T22:09:12.9289024Z              SELECT DISTINCT DATE(created_at) as day
2026-02-20T22:09:12.9289153Z              FROM attempts
2026-02-20T22:09:12.9289578Z              WHERE user_id = :user_id
2026-02-20T22:09:12.9289713Z              ORDER BY day DESC
2026-02-20T22:09:12.9289829Z              LIMIT :limit
2026-02-20T22:09:12.9289933Z -        """), {
2026-02-20T22:09:12.9290051Z -            "user_id": user_id,
2026-02-20T22:09:12.9290625Z -            "limit": required_days + 1  # Prendre un jour de plus pour vérifier la continuité
2026-02-20T22:09:12.9291024Z -        }).fetchall()
2026-02-20T22:09:12.9291132Z -        
2026-02-20T22:09:12.9291247Z +        """),
2026-02-20T22:09:12.9291357Z +            {
2026-02-20T22:09:12.9291492Z +                "user_id": user_id,
2026-02-20T22:09:12.9291629Z +                "limit": required_days
2026-02-20T22:09:12.9292031Z +                + 1,  # Prendre un jour de plus pour vérifier la continuité
2026-02-20T22:09:12.9292143Z +            },
2026-02-20T22:09:12.9292263Z +        ).fetchall()
2026-02-20T22:09:12.9292380Z +
2026-02-20T22:09:12.9292527Z          if len(days) < required_days:
2026-02-20T22:09:12.9292665Z              return False
2026-02-20T22:09:12.9292777Z -        
2026-02-20T22:09:12.9292876Z +
2026-02-20T22:09:12.9293343Z          # Vérifier que les jours sont consécutifs
2026-02-20T22:09:12.9293528Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9293672Z          consecutive_count = 0
2026-02-20T22:09:12.9293792Z -        
2026-02-20T22:09:12.9293895Z +
2026-02-20T22:09:12.9294060Z          for i, day_row in enumerate(days):
2026-02-20T22:09:12.9294333Z -            day = day_row.day if hasattr(day_row, 'day') else day_row[0]
2026-02-20T22:09:12.9294577Z +            day = day_row.day if hasattr(day_row, "day") else day_row[0]
2026-02-20T22:09:12.9294773Z              expected_date = today - timedelta(days=i)
2026-02-20T22:09:12.9294895Z -            
2026-02-20T22:09:12.9294999Z +
2026-02-20T22:09:12.9295139Z              if day == expected_date:
2026-02-20T22:09:12.9295285Z                  consecutive_count += 1
2026-02-20T22:09:12.9295394Z              else:
2026-02-20T22:09:12.9295521Z                  break
2026-02-20T22:09:12.9295626Z -        
2026-02-20T22:09:12.9295734Z +
2026-02-20T22:09:12.9295903Z          return consecutive_count >= required_days
2026-02-20T22:09:12.9296008Z -    
2026-02-20T22:09:12.9296117Z +
2026-02-20T22:09:12.9296374Z      def _check_all_exercise_types(self, user_id: int) -> bool:
2026-02-20T22:09:12.9296914Z          """Vérifier si l'utilisateur a essayé tous les types d'exercices disponibles"""
2026-02-20T22:09:12.9297030Z -        
2026-02-20T22:09:12.9297129Z +
2026-02-20T22:09:12.9297453Z          # Récupérer tous les types d'exercices disponibles
2026-02-20T22:09:12.9297624Z          all_types = self.db.execute(text("""
2026-02-20T22:09:12.9297791Z              SELECT DISTINCT exercise_type
2026-02-20T22:09:12.9297916Z              FROM exercises
2026-02-20T22:09:12.9298119Z              WHERE is_active = true AND is_archived = false
2026-02-20T22:09:12.9298251Z          """)).fetchall()
2026-02-20T22:09:12.9298361Z -        
2026-02-20T22:09:12.9298472Z +
2026-02-20T22:09:12.9298597Z          if not all_types:
2026-02-20T22:09:12.9298730Z              return False
2026-02-20T22:09:12.9298835Z -        
2026-02-20T22:09:12.9299334Z -        all_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in all_types}
2026-02-20T22:09:12.9299453Z -        
2026-02-20T22:09:12.9299567Z +
2026-02-20T22:09:12.9299693Z +        all_types_set = {
2026-02-20T22:09:12.9299983Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9300134Z +            for row in all_types
2026-02-20T22:09:12.9300242Z +        }
2026-02-20T22:09:12.9300342Z +
2026-02-20T22:09:12.9300746Z          # Récupérer les types d'exercices que l'utilisateur a essayés
2026-02-20T22:09:12.9300918Z -        user_types = self.db.execute(text("""
2026-02-20T22:09:12.9301066Z +        user_types = self.db.execute(
2026-02-20T22:09:12.9301191Z +            text("""
2026-02-20T22:09:12.9301355Z              SELECT DISTINCT e.exercise_type
2026-02-20T22:09:12.9301700Z              FROM attempts a
2026-02-20T22:09:12.9301885Z              JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9302036Z              WHERE a.user_id = :user_id
2026-02-20T22:09:12.9302145Z -        """), {
2026-02-20T22:09:12.9302272Z -            "user_id": user_id
2026-02-20T22:09:12.9302593Z -        }).fetchall()
2026-02-20T22:09:12.9302705Z -        
2026-02-20T22:09:12.9343578Z -        user_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in user_types}
2026-02-20T22:09:12.9343727Z -        
2026-02-20T22:09:12.9343850Z +        """),
2026-02-20T22:09:12.9343999Z +            {"user_id": user_id},
2026-02-20T22:09:12.9344124Z +        ).fetchall()
2026-02-20T22:09:12.9344244Z +
2026-02-20T22:09:12.9344379Z +        user_types_set = {
2026-02-20T22:09:12.9344675Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9344815Z +            for row in user_types
2026-02-20T22:09:12.9344942Z +        }
2026-02-20T22:09:12.9345046Z +
2026-02-20T22:09:12.9345288Z          # Normaliser les types (lowercase pour comparaison)
2026-02-20T22:09:12.9345573Z          all_types_normalized = {str(t).lower() for t in all_types_set}
2026-02-20T22:09:12.9345868Z          user_types_normalized = {str(t).lower() for t in user_types_set}
2026-02-20T22:09:12.9345994Z -        
2026-02-20T22:09:12.9346111Z +
2026-02-20T22:09:12.9346393Z          return all_types_normalized.issubset(user_types_normalized)
2026-02-20T22:09:12.9346502Z -    
2026-02-20T22:09:12.9346603Z +
2026-02-20T22:09:12.9346902Z      def _check_min_per_type(self, user_id: int, min_count: int) -> bool:
2026-02-20T22:09:12.9347431Z          """Vérifier si l'utilisateur a réussi au moins X exercices de chaque type"""
2026-02-20T22:09:12.9347543Z -        
2026-02-20T22:09:12.9347652Z +
2026-02-20T22:09:12.9347984Z          # Récupérer tous les types d'exercices disponibles
2026-02-20T22:09:12.9348155Z          all_types = self.db.execute(text("""
2026-02-20T22:09:12.9348324Z              SELECT DISTINCT exercise_type
2026-02-20T22:09:12.9348458Z              FROM exercises
2026-02-20T22:09:12.9348662Z              WHERE is_active = true AND is_archived = false
2026-02-20T22:09:12.9348785Z          """)).fetchall()
2026-02-20T22:09:12.9348896Z -        
2026-02-20T22:09:12.9349007Z +
2026-02-20T22:09:12.9349131Z          if not all_types:
2026-02-20T22:09:12.9349254Z              return False
2026-02-20T22:09:12.9349356Z -        
2026-02-20T22:09:12.9349841Z -        all_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in all_types}
2026-02-20T22:09:12.9349950Z -        
2026-02-20T22:09:12.9350058Z +
2026-02-20T22:09:12.9350186Z +        all_types_set = {
2026-02-20T22:09:12.9350466Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9350611Z +            for row in all_types
2026-02-20T22:09:12.9350717Z +        }
2026-02-20T22:09:12.9350829Z +
2026-02-20T22:09:12.9351372Z          # Pour chaque type, vérifier si l'utilisateur a réussi au moins min_count exercices
2026-02-20T22:09:12.9351537Z          for ex_type in all_types_set:
2026-02-20T22:09:12.9351722Z -            success_count = self.db.execute(text("""
2026-02-20T22:09:12.9351883Z +            success_count = self.db.execute(
2026-02-20T22:09:12.9352027Z +                text("""
2026-02-20T22:09:12.9352167Z                  SELECT COUNT(*) as count
2026-02-20T22:09:12.9352298Z                  FROM attempts a
2026-02-20T22:09:12.9352497Z                  JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9352638Z                  WHERE a.user_id = :user_id
2026-02-20T22:09:12.9353135Z                  AND LOWER(e.exercise_type::text) = LOWER(:exercise_type)
2026-02-20T22:09:12.9353291Z                  AND a.is_correct = true
2026-02-20T22:09:12.9353412Z -            """), {
2026-02-20T22:09:12.9353548Z -                "user_id": user_id,
2026-02-20T22:09:12.9353974Z -                "exercise_type": str(ex_type)
2026-02-20T22:09:12.9354112Z -            }).fetchone()
2026-02-20T22:09:12.9354225Z -            
2026-02-20T22:09:12.9354648Z -            count = success_count.count if hasattr(success_count, 'count') else success_count[0]
2026-02-20T22:09:12.9354766Z +            """),
2026-02-20T22:09:12.9354996Z +                {"user_id": user_id, "exercise_type": str(ex_type)},
2026-02-20T22:09:12.9355328Z +            ).fetchone()
2026-02-20T22:09:12.9355439Z +
2026-02-20T22:09:12.9355562Z +            count = (
2026-02-20T22:09:12.9355694Z +                success_count.count
2026-02-20T22:09:12.9355859Z +                if hasattr(success_count, "count")
2026-02-20T22:09:12.9356004Z +                else success_count[0]
2026-02-20T22:09:12.9356113Z +            )
2026-02-20T22:09:12.9356244Z              if count < min_count:
2026-02-20T22:09:12.9356371Z                  return False
2026-02-20T22:09:12.9356487Z -        
2026-02-20T22:09:12.9356588Z +
2026-02-20T22:09:12.9356710Z          return True
2026-02-20T22:09:12.9356823Z -    
2026-02-20T22:09:12.9357219Z -    def _award_badge(self, user_id: int, badge: Achievement) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9357326Z +
2026-02-20T22:09:12.9357444Z +    def _award_badge(
2026-02-20T22:09:12.9357616Z +        self, user_id: int, badge: Achievement
2026-02-20T22:09:12.9357774Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9358079Z          """Attribuer un badge à un utilisateur"""
2026-02-20T22:09:12.9358200Z -        
2026-02-20T22:09:12.9358303Z +
2026-02-20T22:09:12.9358412Z          try:
2026-02-20T22:09:12.9358584Z              user_achievement = UserAchievement(
2026-02-20T22:09:12.9358722Z                  user_id=user_id,
2026-02-20T22:09:12.9358864Z                  achievement_id=badge.id,
2026-02-20T22:09:12.9359051Z                  earned_at=datetime.now(timezone.utc),
2026-02-20T22:09:12.9359184Z -                is_displayed=True
2026-02-20T22:09:12.9359292Z -            )
2026-02-20T22:09:12.9359414Z -            
2026-02-20T22:09:12.9359542Z +                is_displayed=True,
2026-02-20T22:09:12.9359649Z +            )
2026-02-20T22:09:12.9359747Z +
2026-02-20T22:09:12.9359904Z              self.db.add(user_achievement)
2026-02-20T22:09:12.9360042Z              self.db.commit()
2026-02-20T22:09:12.9360147Z -            
2026-02-20T22:09:12.9360275Z +
2026-02-20T22:09:12.9360394Z              return {
2026-02-20T22:09:12.9360526Z -                'id': badge.id,
2026-02-20T22:09:12.9360656Z -                'code': badge.code,
2026-02-20T22:09:12.9360783Z -                'name': badge.name,
2026-02-20T22:09:12.9360971Z -                'description': badge.description,
2026-02-20T22:09:12.9361166Z -                'star_wars_title': badge.star_wars_title,
2026-02-20T22:09:12.9361335Z -                'difficulty': badge.difficulty,
2026-02-20T22:09:12.9361522Z -                'points_reward': badge.points_reward,
2026-02-20T22:09:12.9361762Z -                'earned_at': user_achievement.earned_at.isoformat()
2026-02-20T22:09:12.9361895Z +                "id": badge.id,
2026-02-20T22:09:12.9362023Z +                "code": badge.code,
2026-02-20T22:09:12.9362153Z +                "name": badge.name,
2026-02-20T22:09:12.9362317Z +                "description": badge.description,
2026-02-20T22:09:12.9362504Z +                "star_wars_title": badge.star_wars_title,
2026-02-20T22:09:12.9362675Z +                "difficulty": badge.difficulty,
2026-02-20T22:09:12.9362848Z +                "points_reward": badge.points_reward,
2026-02-20T22:09:12.9363314Z +                "earned_at": user_achievement.earned_at.isoformat(),
2026-02-20T22:09:12.9363458Z              }
2026-02-20T22:09:12.9363568Z -            
2026-02-20T22:09:12.9363673Z +
2026-02-20T22:09:12.9363844Z          except Exception as badge_award_error:
2026-02-20T22:09:12.9363987Z              self.db.rollback()
2026-02-20T22:09:12.9364435Z -            logger.error(f"Erreur lors de l'attribution du badge {badge.code}: {badge_award_error}")
2026-02-20T22:09:12.9364760Z +            logger.error(
2026-02-20T22:09:12.9365127Z +                f"Erreur lors de l'attribution du badge {badge.code}: {badge_award_error}"
2026-02-20T22:09:12.9365239Z +            )
2026-02-20T22:09:12.9365362Z              return None
2026-02-20T22:09:12.9365471Z -    
2026-02-20T22:09:12.9365571Z +
2026-02-20T22:09:12.9366148Z      def _update_user_gamification(self, user_id: int, new_badges: List[Dict[str, Any]]):
2026-02-20T22:09:12.9366553Z          """Mettre à jour les points et le niveau de l'utilisateur"""
2026-02-20T22:09:12.9366667Z -        
2026-02-20T22:09:12.9366773Z +
2026-02-20T22:09:12.9366883Z          try:
2026-02-20T22:09:12.9367138Z              # Calculer les points gagnés
2026-02-20T22:09:12.9367487Z -            total_points_gained = sum(badge['points_reward'] for badge in new_badges)
2026-02-20T22:09:12.9367598Z -            
2026-02-20T22:09:12.9367936Z +            total_points_gained = sum(badge["points_reward"] for badge in new_badges)
2026-02-20T22:09:12.9368061Z +
2026-02-20T22:09:12.9368299Z              # Mettre à jour l'utilisateur
2026-02-20T22:09:12.9368582Z              user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.9368706Z              if user:
2026-02-20T22:09:12.9368849Z                  # Ajouter les points
2026-02-20T22:09:12.9369118Z -                current_points = getattr(user, 'total_points', 0) or 0
2026-02-20T22:09:12.9369368Z +                current_points = getattr(user, "total_points", 0) or 0
2026-02-20T22:09:12.9369623Z                  new_total_points = current_points + total_points_gained
2026-02-20T22:09:12.9369731Z -                
2026-02-20T22:09:12.9369833Z +
2026-02-20T22:09:12.9370140Z                  # Calculer le nouveau niveau (100 points par niveau)
2026-02-20T22:09:12.9370385Z                  new_level = max(1, new_total_points // 100 + 1)
2026-02-20T22:09:12.9417665Z -                
2026-02-20T22:09:12.9417813Z +
2026-02-20T22:09:12.9418206Z                  # Calculer le rang Jedi basé sur le niveau
2026-02-20T22:09:12.9418471Z                  jedi_rank = self._calculate_jedi_rank(new_level)
2026-02-20T22:09:12.9418599Z -                
2026-02-20T22:09:12.9418705Z +
2026-02-20T22:09:12.9419162Z                  # Mettre à jour via SQL brut pour éviter les problèmes de modèle
2026-02-20T22:09:12.9419340Z -                self.db.execute(text("""
2026-02-20T22:09:12.9419480Z +                self.db.execute(
2026-02-20T22:09:12.9419602Z +                    text("""
2026-02-20T22:09:12.9419744Z                      UPDATE users 
2026-02-20T22:09:12.9419923Z                      SET total_points = :total_points,
2026-02-20T22:09:12.9420095Z                          current_level = :current_level,
2026-02-20T22:09:12.9420309Z                          experience_points = :experience_points,
2026-02-20T22:09:12.9420476Z                          jedi_rank = :jedi_rank
2026-02-20T22:09:12.9420612Z                      WHERE id = :user_id
2026-02-20T22:09:12.9420743Z -                """), {
2026-02-20T22:09:12.9420935Z -                    "total_points": new_total_points,
2026-02-20T22:09:12.9421096Z -                    "current_level": new_level,
2026-02-20T22:09:12.9421289Z -                    "experience_points": new_total_points % 100,
2026-02-20T22:09:12.9421420Z -                    "jedi_rank": jedi_rank,
2026-02-20T22:09:12.9421547Z -                    "user_id": user_id
2026-02-20T22:09:12.9421650Z -                })
2026-02-20T22:09:12.9421750Z -                
2026-02-20T22:09:12.9421875Z +                """),
2026-02-20T22:09:12.9421986Z +                    {
2026-02-20T22:09:12.9422168Z +                        "total_points": new_total_points,
2026-02-20T22:09:12.9422341Z +                        "current_level": new_level,
2026-02-20T22:09:12.9422555Z +                        "experience_points": new_total_points % 100,
2026-02-20T22:09:12.9422705Z +                        "jedi_rank": jedi_rank,
2026-02-20T22:09:12.9422841Z +                        "user_id": user_id,
2026-02-20T22:09:12.9423398Z +                    },
2026-02-20T22:09:12.9423514Z +                )
2026-02-20T22:09:12.9423621Z +
2026-02-20T22:09:12.9423770Z                  self.db.commit()
2026-02-20T22:09:12.9424754Z -                logger.info(f"Gamification mise à jour pour l'utilisateur {user_id}: {total_points_gained} points, niveau {new_level}, rang {jedi_rank}")
2026-02-20T22:09:12.9425047Z -                
2026-02-20T22:09:12.9425183Z +                logger.info(
2026-02-20T22:09:12.9426043Z +                    f"Gamification mise à jour pour l'utilisateur {user_id}: {total_points_gained} points, niveau {new_level}, rang {jedi_rank}"
2026-02-20T22:09:12.9426155Z +                )
2026-02-20T22:09:12.9426259Z +
2026-02-20T22:09:12.9426477Z          except Exception as gamification_update_error:
2026-02-20T22:09:12.9426603Z              self.db.rollback()
2026-02-20T22:09:12.9427316Z -            logger.error(f"Erreur mise à jour gamification pour l'utilisateur {user_id}: {gamification_update_error}")
2026-02-20T22:09:12.9427452Z -    
2026-02-20T22:09:12.9427582Z +            logger.error(
2026-02-20T22:09:12.9428205Z +                f"Erreur mise à jour gamification pour l'utilisateur {user_id}: {gamification_update_error}"
2026-02-20T22:09:12.9428323Z +            )
2026-02-20T22:09:12.9428428Z +
2026-02-20T22:09:12.9428649Z      def _calculate_jedi_rank(self, level: int) -> str:
2026-02-20T22:09:12.9428932Z          """Calculer le rang Jedi basé sur le niveau"""
2026-02-20T22:09:12.9429052Z -        
2026-02-20T22:09:12.9429154Z +
2026-02-20T22:09:12.9429276Z          if level < 5:
2026-02-20T22:09:12.9429415Z -            return 'youngling'
2026-02-20T22:09:12.9429541Z +            return "youngling"
2026-02-20T22:09:12.9429667Z          elif level < 15:
2026-02-20T22:09:12.9429795Z -            return 'padawan'
2026-02-20T22:09:12.9429933Z +            return "padawan"
2026-02-20T22:09:12.9430054Z          elif level < 30:
2026-02-20T22:09:12.9430180Z -            return 'knight'
2026-02-20T22:09:12.9430329Z +            return "knight"
2026-02-20T22:09:12.9430453Z          elif level < 50:
2026-02-20T22:09:12.9430575Z -            return 'master'
2026-02-20T22:09:12.9430699Z +            return "master"
2026-02-20T22:09:12.9430816Z          else:
2026-02-20T22:09:12.9430947Z -            return 'grand_master'
2026-02-20T22:09:12.9431061Z -    
2026-02-20T22:09:12.9431196Z +            return "grand_master"
2026-02-20T22:09:12.9431299Z +
2026-02-20T22:09:12.9431547Z      def get_user_badges(self, user_id: int) -> Dict[str, Any]:
2026-02-20T22:09:12.9431858Z          """Récupérer tous les badges d'un utilisateur"""
2026-02-20T22:09:12.9431973Z -        
2026-02-20T22:09:12.9432078Z +
2026-02-20T22:09:12.9432184Z          try:
2026-02-20T22:09:12.9432317Z              # Badges obtenus
2026-02-20T22:09:12.9432501Z -            earned_badges = self.db.execute(text("""
2026-02-20T22:09:12.9432661Z +            earned_badges = self.db.execute(
2026-02-20T22:09:12.9432804Z +                text("""
2026-02-20T22:09:12.9463448Z                  SELECT a.id, a.code, a.name, a.description, a.star_wars_title,
2026-02-20T22:09:12.9463725Z                         a.difficulty, a.points_reward, a.category,
2026-02-20T22:09:12.9463908Z                         ua.earned_at, ua.is_displayed
2026-02-20T22:09:12.9464062Z                  FROM achievements a
2026-02-20T22:09:12.9464335Z                  JOIN user_achievements ua ON a.id = ua.achievement_id
2026-02-20T22:09:12.9464488Z                  WHERE ua.user_id = :user_id
2026-02-20T22:09:12.9464644Z                  ORDER BY ua.earned_at DESC
2026-02-20T22:09:12.9464808Z -            """), {"user_id": user_id}).fetchall()
2026-02-20T22:09:12.9464918Z -            
2026-02-20T22:09:12.9465034Z +            """),
2026-02-20T22:09:12.9465168Z +                {"user_id": user_id},
2026-02-20T22:09:12.9465292Z +            ).fetchall()
2026-02-20T22:09:12.9465398Z +
2026-02-20T22:09:12.9465597Z              # Statistiques utilisateur (inclut streak)
2026-02-20T22:09:12.9466032Z -            user_stats = self.db.execute(text("""
2026-02-20T22:09:12.9466197Z +            user_stats = self.db.execute(
2026-02-20T22:09:12.9466330Z +                text("""
2026-02-20T22:09:12.9466650Z                  SELECT total_points, current_level, experience_points, jedi_rank,
2026-02-20T22:09:12.9467106Z                         COALESCE(current_streak, 0), COALESCE(best_streak, 0)
2026-02-20T22:09:12.9467229Z                  FROM users
2026-02-20T22:09:12.9467372Z                  WHERE id = :user_id
2026-02-20T22:09:12.9467536Z -            """), {"user_id": user_id}).fetchone()
2026-02-20T22:09:12.9467643Z +            """),
2026-02-20T22:09:12.9467782Z +                {"user_id": user_id},
2026-02-20T22:09:12.9467899Z +            ).fetchone()
2026-02-20T22:09:12.9468005Z  
2026-02-20T22:09:12.9468153Z              pinned: List[int] = []
2026-02-20T22:09:12.9468266Z              try:
2026-02-20T22:09:12.9468549Z                  user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.9468917Z                  if user and hasattr(user, "pinned_badge_ids") and user.pinned_badge_ids:
2026-02-20T22:09:12.9469308Z -                    pinned = [int(x) for x in user.pinned_badge_ids if isinstance(x, (int, float))]
2026-02-20T22:09:12.9469437Z +                    pinned = [
2026-02-20T22:09:12.9469559Z +                        int(x)
2026-02-20T22:09:12.9469744Z +                        for x in user.pinned_badge_ids
2026-02-20T22:09:12.9469905Z +                        if isinstance(x, (int, float))
2026-02-20T22:09:12.9470017Z +                    ]
2026-02-20T22:09:12.9470163Z              except Exception:
2026-02-20T22:09:12.9470280Z                  pass
2026-02-20T22:09:12.9470386Z -            
2026-02-20T22:09:12.9470490Z +
2026-02-20T22:09:12.9470615Z              return {
2026-02-20T22:09:12.9470749Z -                'earned_badges': [
2026-02-20T22:09:12.9470876Z +                "earned_badges": [
2026-02-20T22:09:12.9471002Z                      {
2026-02-20T22:09:12.9471134Z -                        'id': badge[0],
2026-02-20T22:09:12.9471270Z -                        'code': badge[1],
2026-02-20T22:09:12.9471402Z -                        'name': badge[2],
2026-02-20T22:09:12.9471573Z -                        'description': badge[3],
2026-02-20T22:09:12.9471737Z -                        'star_wars_title': badge[4],
2026-02-20T22:09:12.9471895Z -                        'difficulty': badge[5],
2026-02-20T22:09:12.9472060Z -                        'points_reward': badge[6],
2026-02-20T22:09:12.9472208Z -                        'category': badge[7],
2026-02-20T22:09:12.9472468Z -                        'earned_at': badge[8].isoformat() if badge[8] else None,
2026-02-20T22:09:12.9472631Z -                        'is_displayed': badge[9]
2026-02-20T22:09:12.9472761Z +                        "id": badge[0],
2026-02-20T22:09:12.9472894Z +                        "code": badge[1],
2026-02-20T22:09:12.9473215Z +                        "name": badge[2],
2026-02-20T22:09:12.9473423Z +                        "description": badge[3],
2026-02-20T22:09:12.9473661Z +                        "star_wars_title": badge[4],
2026-02-20T22:09:12.9473866Z +                        "difficulty": badge[5],
2026-02-20T22:09:12.9474074Z +                        "points_reward": badge[6],
2026-02-20T22:09:12.9474262Z +                        "category": badge[7],
2026-02-20T22:09:12.9474561Z +                        "earned_at": badge[8].isoformat() if badge[8] else None,
2026-02-20T22:09:12.9474764Z +                        "is_displayed": badge[9],
2026-02-20T22:09:12.9474898Z                      }
2026-02-20T22:09:12.9475092Z                      for badge in earned_badges
2026-02-20T22:09:12.9475224Z                  ],
2026-02-20T22:09:12.9475391Z -                'user_stats': {
2026-02-20T22:09:12.9475645Z -                    'total_points': user_stats[0] if user_stats else 0,
2026-02-20T22:09:12.9475881Z -                    'current_level': user_stats[1] if user_stats else 1,
2026-02-20T22:09:12.9476436Z -                    'experience_points': user_stats[2] if user_stats else 0,
2026-02-20T22:09:12.9476766Z -                    'jedi_rank': user_stats[3] if user_stats else 'youngling',
2026-02-20T22:09:12.9476932Z -                    'pinned_badge_ids': pinned,
2026-02-20T22:09:12.9477374Z -                    'current_streak': user_stats[4] if user_stats and len(user_stats) > 4 else 0,
2026-02-20T22:09:12.9477982Z -                    'best_streak': user_stats[5] if user_stats and len(user_stats) > 5 else 0,
2026-02-20T22:09:12.9478142Z -                } if user_stats else {
2026-02-20T22:09:12.9478335Z -                    'total_points': 0,
2026-02-20T22:09:12.9478497Z -                    'current_level': 1,
2026-02-20T22:09:12.9478656Z -                    'experience_points': 0,
2026-02-20T22:09:12.9478842Z -                    'jedi_rank': 'youngling',
2026-02-20T22:09:12.9479008Z -                    'pinned_badge_ids': [],
2026-02-20T22:09:12.9479162Z -                    'current_streak': 0,
2026-02-20T22:09:12.9479302Z -                    'best_streak': 0,
2026-02-20T22:09:12.9479424Z -                }
2026-02-20T22:09:12.9479566Z +                "user_stats": (
2026-02-20T22:09:12.9479684Z +                    {
2026-02-20T22:09:12.9479972Z +                        "total_points": user_stats[0] if user_stats else 0,
2026-02-20T22:09:12.9480231Z +                        "current_level": user_stats[1] if user_stats else 1,
2026-02-20T22:09:12.9480549Z +                        "experience_points": user_stats[2] if user_stats else 0,
2026-02-20T22:09:12.9480833Z +                        "jedi_rank": user_stats[3] if user_stats else "youngling",
2026-02-20T22:09:12.9481016Z +                        "pinned_badge_ids": pinned,
2026-02-20T22:09:12.9481162Z +                        "current_streak": (
2026-02-20T22:09:12.9481482Z +                            user_stats[4] if user_stats and len(user_stats) > 4 else 0
2026-02-20T22:09:12.9481628Z +                        ),
2026-02-20T22:09:12.9481766Z +                        "best_streak": (
2026-02-20T22:09:12.9482086Z +                            user_stats[5] if user_stats and len(user_stats) > 5 else 0
2026-02-20T22:09:12.9482225Z +                        ),
2026-02-20T22:09:12.9482340Z +                    }
2026-02-20T22:09:12.9482473Z +                    if user_stats
2026-02-20T22:09:12.9482594Z +                    else {
2026-02-20T22:09:12.9482748Z +                        "total_points": 0,
2026-02-20T22:09:12.9482932Z +                        "current_level": 1,
2026-02-20T22:09:12.9483290Z +                        "experience_points": 0,
2026-02-20T22:09:12.9483499Z +                        "jedi_rank": "youngling",
2026-02-20T22:09:12.9483660Z +                        "pinned_badge_ids": [],
2026-02-20T22:09:12.9483810Z +                        "current_streak": 0,
2026-02-20T22:09:12.9483956Z +                        "best_streak": 0,
2026-02-20T22:09:12.9484088Z +                    }
2026-02-20T22:09:12.9484209Z +                ),
2026-02-20T22:09:12.9484317Z              }
2026-02-20T22:09:12.9484438Z -            
2026-02-20T22:09:12.9484547Z +
2026-02-20T22:09:12.9484733Z          except Exception as user_badges_error:
2026-02-20T22:09:12.9485410Z -            logger.error(f"Erreur récupération badges utilisateur {user_id}: {user_badges_error}")
2026-02-20T22:09:12.9485654Z -            return {'earned_badges': [], 'user_stats': {}}
2026-02-20T22:09:12.9485772Z -    
2026-02-20T22:09:12.9485907Z +            logger.error(
2026-02-20T22:09:12.9486438Z +                f"Erreur récupération badges utilisateur {user_id}: {user_badges_error}"
2026-02-20T22:09:12.9486560Z +            )
2026-02-20T22:09:12.9486767Z +            return {"earned_badges": [], "user_stats": {}}
2026-02-20T22:09:12.9486885Z +
2026-02-20T22:09:12.9487261Z      def _format_requirements_to_text(self, badge: Achievement) -> Optional[str]:
2026-02-20T22:09:12.9487867Z          """Convertit le JSON requirements en texte lisible (critères d'obtention)."""
2026-02-20T22:09:12.9488311Z          if not badge.requirements:
2026-02-20T22:09:12.9488446Z              return None
2026-02-20T22:09:12.9488569Z          try:
2026-02-20T22:09:12.9489167Z -            req = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.9489667Z +            req = (
2026-02-20T22:09:12.9489899Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.9490169Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.9490374Z +                else badge.requirements
2026-02-20T22:09:12.9490530Z +            )
2026-02-20T22:09:12.9490787Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.9490977Z              return None
2026-02-20T22:09:12.9491128Z          if not isinstance(req, dict):
2026-02-20T22:09:12.9491263Z              return None
2026-02-20T22:09:12.9491426Z          # attempts_count
2026-02-20T22:09:12.9491546Z @@ -586,11 +686,16 @@
2026-02-20T22:09:12.9491956Z              return f"{target} tentatives avec {rate}% de réussite"
2026-02-20T22:09:12.9492144Z          # exercise_type + consecutive_correct
2026-02-20T22:09:12.9492391Z          ex_type = req.get("exercise_type", "").lower()
2026-02-20T22:09:12.9492574Z          consec = req.get("consecutive_correct")
2026-02-20T22:09:12.9492766Z          if consec is not None:
2026-02-20T22:09:12.9523941Z -            labels = {"addition": "additions", "soustraction": "soustractions", "multiplication": "multiplications", "division": "divisions"}
2026-02-20T22:09:12.9524189Z +            labels = {
2026-02-20T22:09:12.9524407Z +                "addition": "additions",
2026-02-20T22:09:12.9524659Z +                "soustraction": "soustractions",
2026-02-20T22:09:12.9524862Z +                "multiplication": "multiplications",
2026-02-20T22:09:12.9525020Z +                "division": "divisions",
2026-02-20T22:09:12.9525144Z +            }
2026-02-20T22:09:12.9525318Z              label = labels.get(ex_type, ex_type)
2026-02-20T22:09:12.9525751Z              return f"{consec} {label} consécutives correctes"
2026-02-20T22:09:12.9525885Z          # max_time
2026-02-20T22:09:12.9526030Z          max_t = req.get("max_time")
2026-02-20T22:09:12.9526168Z          if max_t is not None:
2026-02-20T22:09:12.9526298Z @@ -613,50 +718,62 @@
2026-02-20T22:09:12.9526644Z              return f"Revenir après {cb} jours sans activité"
2026-02-20T22:09:12.9526771Z          return None
2026-02-20T22:09:12.9526884Z  
2026-02-20T22:09:12.9527141Z      def get_available_badges(self) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.9527456Z          """Récupérer tous les badges disponibles"""
2026-02-20T22:09:12.9527574Z -        
2026-02-20T22:09:12.9527696Z +
2026-02-20T22:09:12.9527818Z          try:
2026-02-20T22:09:12.9528046Z -            badges = self.db.query(Achievement).filter(
2026-02-20T22:09:12.9528228Z -                Achievement.is_active == True
2026-02-20T22:09:12.9528554Z -            ).order_by(Achievement.category, Achievement.difficulty).all()
2026-02-20T22:09:12.9528683Z -            
2026-02-20T22:09:12.9528808Z +            badges = (
2026-02-20T22:09:12.9528966Z +                self.db.query(Achievement)
2026-02-20T22:09:12.9529132Z +                .filter(Achievement.is_active == True)
2026-02-20T22:09:12.9529376Z +                .order_by(Achievement.category, Achievement.difficulty)
2026-02-20T22:09:12.9529507Z +                .all()
2026-02-20T22:09:12.9529608Z +            )
2026-02-20T22:09:12.9529706Z +
2026-02-20T22:09:12.9529813Z              return [
2026-02-20T22:09:12.9529924Z                  {
2026-02-20T22:09:12.9530054Z -                    'id': badge.id,
2026-02-20T22:09:12.9530193Z -                    'code': badge.code,
2026-02-20T22:09:12.9530342Z -                    'name': badge.name,
2026-02-20T22:09:12.9530532Z -                    'description': badge.description,
2026-02-20T22:09:12.9530825Z -                    'criteria_text': self._format_requirements_to_text(badge),
2026-02-20T22:09:12.9531299Z -                    'star_wars_title': badge.star_wars_title,
2026-02-20T22:09:12.9531497Z -                    'difficulty': badge.difficulty,
2026-02-20T22:09:12.9531695Z -                    'points_reward': badge.points_reward,
2026-02-20T22:09:12.9531861Z -                    'category': badge.category,
2026-02-20T22:09:12.9532255Z -                    'is_secret': badge.is_secret,
2026-02-20T22:09:12.9532423Z -                    'icon_url': badge.icon_url,
2026-02-20T22:09:12.9532556Z +                    "id": badge.id,
2026-02-20T22:09:12.9532708Z +                    "code": badge.code,
2026-02-20T22:09:12.9532845Z +                    "name": badge.name,
2026-02-20T22:09:12.9533265Z +                    "description": badge.description,
2026-02-20T22:09:12.9533573Z +                    "criteria_text": self._format_requirements_to_text(badge),
2026-02-20T22:09:12.9533803Z +                    "star_wars_title": badge.star_wars_title,
2026-02-20T22:09:12.9533992Z +                    "difficulty": badge.difficulty,
2026-02-20T22:09:12.9534185Z +                    "points_reward": badge.points_reward,
2026-02-20T22:09:12.9534356Z +                    "category": badge.category,
2026-02-20T22:09:12.9534518Z +                    "is_secret": badge.is_secret,
2026-02-20T22:09:12.9534674Z +                    "icon_url": badge.icon_url,
2026-02-20T22:09:12.9534816Z                  }
2026-02-20T22:09:12.9534956Z                  for badge in badges
2026-02-20T22:09:12.9535067Z              ]
2026-02-20T22:09:12.9535181Z -            
2026-02-20T22:09:12.9535299Z +
2026-02-20T22:09:12.9535505Z          except Exception as available_badges_error:
2026-02-20T22:09:12.9536136Z -            logger.error(f"Erreur récupération badges disponibles: {available_badges_error}")
2026-02-20T22:09:12.9536291Z +            logger.error(
2026-02-20T22:09:12.9536762Z +                f"Erreur récupération badges disponibles: {available_badges_error}"
2026-02-20T22:09:12.9536885Z +            )
2026-02-20T22:09:12.9537037Z              return []
2026-02-20T22:09:12.9537149Z  
2026-02-20T22:09:12.9537293Z      def _get_badge_progress(
2026-02-20T22:09:12.9537691Z -        self, user_id: int, badge: Achievement, stats_cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.9537813Z +        self,
2026-02-20T22:09:12.9537938Z +        user_id: int,
2026-02-20T22:09:12.9538087Z +        badge: Achievement,
2026-02-20T22:09:12.9538297Z +        stats_cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.9538447Z      ) -> tuple[float, int, int]:
2026-02-20T22:09:12.9538564Z          """
2026-02-20T22:09:12.9538952Z          Calcule la progression vers un badge non débloqué.
2026-02-20T22:09:12.9539413Z          Lot C-2 : utilise badge_requirement_engine.get_requirement_progress pour tous les types.
2026-02-20T22:09:12.9539721Z          stats_cache: pré-fetch pour éviter N+1.
2026-02-20T22:09:12.9540040Z          Returns: (progress 0.0-1.0, current_value, target_value)
2026-02-20T22:09:12.9540181Z          """
2026-02-20T22:09:12.9540334Z          if not badge.requirements:
2026-02-20T22:09:12.9540466Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9540589Z          try:
2026-02-20T22:09:12.9541130Z -            req = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.9541280Z +            req = (
2026-02-20T22:09:12.9541455Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.9541657Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.9541824Z +                else badge.requirements
2026-02-20T22:09:12.9541934Z +            )
2026-02-20T22:09:12.9542130Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.9542248Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9542391Z          if not isinstance(req, dict):
2026-02-20T22:09:12.9542517Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9542628Z  
2026-02-20T22:09:12.9542749Z @@ -669,15 +786,18 @@
2026-02-20T22:09:12.9543415Z          """
2026-02-20T22:09:12.9543732Z          Progression vers les badges (unlocked + in_progress).
2026-02-20T22:09:12.9544178Z          Pré-fetch des stats communes pour éviter N+1.
2026-02-20T22:09:12.9544342Z          """
2026-02-20T22:09:12.9544497Z          earned_ids = {
2026-02-20T22:09:12.9544871Z -            r[0] for r in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.9545310Z +            r[0]
2026-02-20T22:09:12.9545664Z +            for r in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.9545921Z              .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:12.9546080Z              .all()
2026-02-20T22:09:12.9546209Z          }
2026-02-20T22:09:12.9546730Z -        all_badges = self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.9546888Z +        all_badges = (
2026-02-20T22:09:12.9547322Z +            self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.9547462Z +        )
2026-02-20T22:09:12.9547632Z  
2026-02-20T22:09:12.9548119Z          # Pré-fetch stats pour éviter N+1 — une requête par type de donnée
2026-02-20T22:09:12.9548282Z          stats_cache: Dict[str, Any] = {}
2026-02-20T22:09:12.9548405Z          try:
2026-02-20T22:09:12.9548547Z              row = self.db.execute(
2026-02-20T22:09:12.9548688Z @@ -713,46 +833,56 @@
2026-02-20T22:09:12.9548921Z                      WHERE a.user_id = :uid AND a.is_correct = true
2026-02-20T22:09:12.9549172Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:12.9549292Z                  """),
2026-02-20T22:09:12.9549426Z                  {"uid": user_id},
2026-02-20T22:09:12.9549558Z              ).fetchall()
2026-02-20T22:09:12.9549925Z -            stats_cache["per_type_correct"] = {str(r[0]).lower(): r[1] for r in per_type}
2026-02-20T22:09:12.9550157Z +            stats_cache["per_type_correct"] = {
2026-02-20T22:09:12.9550361Z +                str(r[0]).lower(): r[1] for r in per_type
2026-02-20T22:09:12.9550488Z +            }
2026-02-20T22:09:12.9550661Z              user_types_rows = self.db.execute(
2026-02-20T22:09:12.9550797Z                  text("""
2026-02-20T22:09:12.9551131Z                      SELECT DISTINCT LOWER(e.exercise_type::text) FROM attempts a
2026-02-20T22:09:12.9551482Z                      JOIN exercises e ON a.exercise_id = e.id WHERE a.user_id = :uid
2026-02-20T22:09:12.9551611Z                  """),
2026-02-20T22:09:12.9551749Z                  {"uid": user_id},
2026-02-20T22:09:12.9551870Z              ).fetchall()
2026-02-20T22:09:12.9552261Z -            stats_cache["user_exercise_types"] = {str(r[0]).lower() for r in user_types_rows}
2026-02-20T22:09:12.9552454Z +            stats_cache["user_exercise_types"] = {
2026-02-20T22:09:12.9552648Z +                str(r[0]).lower() for r in user_types_rows
2026-02-20T22:09:12.9552762Z +            }
2026-02-20T22:09:12.9552903Z              # consecutive_days
2026-02-20T22:09:12.9583442Z              days_rows = self.db.execute(
2026-02-20T22:09:12.9583625Z                  text("""
2026-02-20T22:09:12.9583908Z                      SELECT DISTINCT DATE(created_at) as day FROM attempts
2026-02-20T22:09:12.9584154Z                      WHERE user_id = :uid ORDER BY day DESC LIMIT 35
2026-02-20T22:09:12.9584279Z                  """),
2026-02-20T22:09:12.9584424Z                  {"uid": user_id},
2026-02-20T22:09:12.9584558Z              ).fetchall()
2026-02-20T22:09:12.9585041Z -            stats_cache["activity_dates"] = [r[0] if hasattr(r, "__getitem__") else r.day for r in days_rows]
2026-02-20T22:09:12.9585223Z +            stats_cache["activity_dates"] = [
2026-02-20T22:09:12.9585510Z +                r[0] if hasattr(r, "__getitem__") else r.day for r in days_rows
2026-02-20T22:09:12.9585623Z +            ]
2026-02-20T22:09:12.9585892Z              # max_time : min time_spent parmi les tentatives correctes
2026-02-20T22:09:12.9586047Z              min_time = self.db.execute(
2026-02-20T22:09:12.9586485Z                  text(
2026-02-20T22:09:12.9586915Z                      "SELECT MIN(time_spent) FROM attempts WHERE user_id = :uid AND is_correct = true"
2026-02-20T22:09:12.9587036Z                  ),
2026-02-20T22:09:12.9587180Z                  {"uid": user_id},
2026-02-20T22:09:12.9587307Z              ).fetchone()
2026-02-20T22:09:12.9588070Z -            stats_cache["min_fast_time"] = float(min_time[0]) if min_time and min_time[0] is not None else None
2026-02-20T22:09:12.9588254Z +            stats_cache["min_fast_time"] = (
2026-02-20T22:09:12.9588565Z +                float(min_time[0]) if min_time and min_time[0] is not None else None
2026-02-20T22:09:12.9588679Z +            )
2026-02-20T22:09:12.9588829Z              # perfect_day : stats du jour
2026-02-20T22:09:12.9589032Z              today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9589183Z              pd_row = self.db.execute(
2026-02-20T22:09:12.9589307Z                  text("""
2026-02-20T22:09:12.9589676Z                      SELECT COUNT(*) as total, COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9590004Z                      FROM attempts WHERE user_id = :uid AND DATE(created_at) = :today
2026-02-20T22:09:12.9590130Z                  """),
2026-02-20T22:09:12.9590300Z                  {"uid": user_id, "today": today},
2026-02-20T22:09:12.9590433Z              ).fetchone()
2026-02-20T22:09:12.9590855Z -            stats_cache["perfect_day_today"] = (pd_row[0] or 0, pd_row[1] or 0) if pd_row else (0, 0)
2026-02-20T22:09:12.9591035Z +            stats_cache["perfect_day_today"] = (
2026-02-20T22:09:12.9591281Z +                (pd_row[0] or 0, pd_row[1] or 0) if pd_row else (0, 0)
2026-02-20T22:09:12.9591398Z +            )
2026-02-20T22:09:12.9591883Z              # consecutive par type : streak actuel (dernières tentatives)
2026-02-20T22:09:12.9592136Z              for ex_t in stats_cache.get("exercise_types", []):
2026-02-20T22:09:12.9592304Z                  streak_rows = self.db.execute(
2026-02-20T22:09:12.9592445Z                      text("""
2026-02-20T22:09:12.9592652Z                          SELECT a.is_correct FROM attempts a
2026-02-20T22:09:12.9592774Z @@ -779,23 +909,27 @@
2026-02-20T22:09:12.9592908Z          for b in all_badges:
2026-02-20T22:09:12.9593239Z              if b.id in earned_ids:
2026-02-20T22:09:12.9593556Z                  unlocked.append({"id": b.id, "code": b.code, "name": b.name})
2026-02-20T22:09:12.9593697Z              else:
2026-02-20T22:09:12.9594004Z                  prog, cur, tgt = self._get_badge_progress(user_id, b, stats_cache)
2026-02-20T22:09:12.9594171Z -                in_progress.append({
2026-02-20T22:09:12.9594302Z -                    "id": b.id,
2026-02-20T22:09:12.9594435Z -                    "code": b.code,
2026-02-20T22:09:12.9594569Z -                    "name": b.name,
2026-02-20T22:09:12.9594711Z -                    "progress": prog,
2026-02-20T22:09:12.9594822Z -                    "current": cur,
2026-02-20T22:09:12.9594929Z -                    "target": tgt,
2026-02-20T22:09:12.9595196Z -                    "criteria_text": self._format_requirements_to_text(b),
2026-02-20T22:09:12.9595402Z -                    "is_secret": getattr(b, "is_secret", False),
2026-02-20T22:09:12.9595508Z -                })
2026-02-20T22:09:12.9595655Z +                in_progress.append(
2026-02-20T22:09:12.9595769Z +                    {
2026-02-20T22:09:12.9595892Z +                        "id": b.id,
2026-02-20T22:09:12.9596031Z +                        "code": b.code,
2026-02-20T22:09:12.9596172Z +                        "name": b.name,
2026-02-20T22:09:12.9596316Z +                        "progress": prog,
2026-02-20T22:09:12.9596453Z +                        "current": cur,
2026-02-20T22:09:12.9596595Z +                        "target": tgt,
2026-02-20T22:09:12.9596868Z +                        "criteria_text": self._format_requirements_to_text(b),
2026-02-20T22:09:12.9597087Z +                        "is_secret": getattr(b, "is_secret", False),
2026-02-20T22:09:12.9597459Z +                    }
2026-02-20T22:09:12.9597574Z +                )
2026-02-20T22:09:12.9597839Z          return {"unlocked": unlocked, "in_progress": in_progress}
2026-02-20T22:09:12.9597953Z  
2026-02-20T22:09:12.9598409Z -    def get_closest_progress_notification(self, user_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9598809Z +    def get_closest_progress_notification(
2026-02-20T22:09:12.9598947Z +        self, user_id: int
2026-02-20T22:09:12.9599105Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9599217Z          """
2026-02-20T22:09:12.9599769Z          Retourne le badge le plus proche du déblocage (progress >= 0.5, target > 0)
2026-02-20T22:09:12.9600099Z          pour afficher « Tu approches ! Plus que X ».
2026-02-20T22:09:12.9600380Z          Exclut les badges secrets non débloqués.
2026-02-20T22:09:12.9600495Z          """
2026-02-20T22:09:12.9600615Z @@ -809,11 +943,13 @@
2026-02-20T22:09:12.9600753Z              if prog < 0.5:
2026-02-20T22:09:12.9600893Z                  continue
2026-02-20T22:09:12.9601133Z              if p.get("is_secret") and p["id"] not in earned_ids:
2026-02-20T22:09:12.9601264Z                  continue
2026-02-20T22:09:12.9601591Z              remaining = max(0, (p.get("target", 0) or 0) - (p.get("current", 0) or 0))
2026-02-20T22:09:12.9601973Z -            candidates.append((prog, {"name": p.get("name", ""), "remaining": remaining}))
2026-02-20T22:09:12.9602137Z +            candidates.append(
2026-02-20T22:09:12.9602396Z +                (prog, {"name": p.get("name", ""), "remaining": remaining})
2026-02-20T22:09:12.9602508Z +            )
2026-02-20T22:09:12.9602639Z          if not candidates:
2026-02-20T22:09:12.9602770Z              return None
2026-02-20T22:09:12.9603303Z          candidates.sort(key=lambda x: -x[0])  # Plus haute progression d'abord
2026-02-20T22:09:12.9603459Z          return candidates[0][1]
2026-02-20T22:09:12.9603581Z  
2026-02-20T22:09:12.9603700Z @@ -821,11 +957,16 @@
2026-02-20T22:09:12.9603820Z          """
2026-02-20T22:09:12.9604297Z          Stats rareté par badge : unlock_count, unlock_percent, rarity_label.
2026-02-20T22:09:12.9604718Z          A-4 : preuve sociale (« X% ont débloqué »), indicateur rareté.
2026-02-20T22:09:12.9604837Z          """
2026-02-20T22:09:12.9604945Z          try:
2026-02-20T22:09:12.9605427Z -            total_users = self.db.query(func.count(User.id)).filter(User.is_active == True).scalar() or 1
2026-02-20T22:09:12.9605575Z +            total_users = (
2026-02-20T22:09:12.9605749Z +                self.db.query(func.count(User.id))
2026-02-20T22:09:12.9605919Z +                .filter(User.is_active == True)
2026-02-20T22:09:12.9606042Z +                .scalar()
2026-02-20T22:09:12.9606157Z +                or 1
2026-02-20T22:09:12.9606268Z +            )
2026-02-20T22:09:12.9606437Z              rows = self.db.execute(text("""
2026-02-20T22:09:12.9606855Z                  SELECT ua.achievement_id, COUNT(DISTINCT ua.user_id) as unlock_count
2026-02-20T22:09:12.9607034Z                  FROM user_achievements ua
2026-02-20T22:09:12.9607265Z                  JOIN achievements a ON a.id = ua.achievement_id
2026-02-20T22:09:12.9607415Z                  WHERE a.is_active = true
2026-02-20T22:09:12.9607536Z @@ -873,6 +1014,6 @@
2026-02-20T22:09:12.9607670Z                  self.db.commit()
2026-02-20T22:09:12.9607819Z          except Exception as e:
2026-02-20T22:09:12.9607965Z              self.db.rollback()
2026-02-20T22:09:12.9608183Z              logger.error(f"Erreur set_pinned_badges: {e}")
2026-02-20T22:09:12.9608316Z              return []
2026-02-20T22:09:12.9608440Z -        return valid 
2026-02-20T22:09:12.9608575Z \ No newline at end of file
2026-02-20T22:09:12.9608701Z +        return valid
2026-02-20T22:09:12.9609214Z would reformat /home/runner/work/mathakine/mathakine/app/services/db_init_service.py
2026-02-20T22:09:12.9609784Z --- /home/runner/work/mathakine/mathakine/app/services/db_init_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:12.9610586Z +++ /home/runner/work/mathakine/mathakine/app/services/db_init_service.py	2026-02-20 22:09:12.910586+00:00
2026-02-20T22:09:12.9610720Z @@ -1,8 +1,9 @@
2026-02-20T22:09:12.9610835Z  """
2026-02-20T22:09:12.9611169Z  Service d'initialisation de la base de données
2026-02-20T22:09:12.9611279Z  """
2026-02-20T22:09:12.9611384Z +
2026-02-20T22:09:12.9611737Z  import random
2026-02-20T22:09:12.9611910Z  from datetime import datetime, timedelta
2026-02-20T22:09:12.9612018Z  
2026-02-20T22:09:12.9612224Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.9612330Z  
2026-02-20T22:09:12.9612445Z @@ -10,12 +11,11 @@
2026-02-20T22:09:12.9612599Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.9612716Z  
2026-02-20T22:09:12.9612903Z  from app.db.base import Base, engine, get_db
2026-02-20T22:09:12.9643356Z  from app.models.attempt import Attempt
2026-02-20T22:09:12.9643765Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:12.9644076Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:12.9644274Z -                                        LogicChallengeType)
2026-02-20T22:09:12.9644694Z +from app.models.logic_challenge import AgeGroup, LogicChallenge, LogicChallengeType
2026-02-20T22:09:12.9644880Z  from app.models.user import User, UserRole
2026-02-20T22:09:12.9645075Z  from app.utils.db_helpers import get_enum_value
2026-02-20T22:09:12.9645188Z  
2026-02-20T22:09:12.9645300Z  
2026-02-20T22:09:12.9645426Z  def create_tables():
2026-02-20T22:09:12.9645544Z @@ -23,12 +23,10 @@
2026-02-20T22:09:12.9645928Z      Crée toutes les tables dans la base de données.
2026-02-20T22:09:12.9646046Z      """
2026-02-20T22:09:12.9646438Z      logger.info("Création des tables dans la base de données")
2026-02-20T22:09:12.9646613Z      Base.metadata.create_all(bind=engine)
2026-02-20T22:09:12.9646915Z      logger.success("Tables créées avec succès")
2026-02-20T22:09:12.9647023Z -
2026-02-20T22:09:12.9647127Z -
2026-02-20T22:09:12.9647243Z  
2026-02-20T22:09:12.9647367Z  
2026-02-20T22:09:12.9647515Z  def populate_test_data():
2026-02-20T22:09:12.9647629Z      """
2026-02-20T22:09:12.9647988Z      Remplit la base de données avec des données de test.
2026-02-20T22:09:12.9648112Z @@ -54,16 +52,16 @@
2026-02-20T22:09:12.9648219Z  
2026-02-20T22:09:12.9648355Z          db.commit()
2026-02-20T22:09:12.9648728Z          logger.success("Données de test créées avec succès")
2026-02-20T22:09:12.9648933Z      except Exception as test_data_creation_error:
2026-02-20T22:09:12.9649060Z          db.rollback()
2026-02-20T22:09:12.9649713Z -        logger.error(f"Erreur lors de la création des données de test: {str(test_data_creation_error)}")
2026-02-20T22:09:12.9649852Z +        logger.error(
2026-02-20T22:09:12.9650389Z +            f"Erreur lors de la création des données de test: {str(test_data_creation_error)}"
2026-02-20T22:09:12.9650516Z +        )
2026-02-20T22:09:12.9650626Z          raise
2026-02-20T22:09:12.9650742Z      finally:
2026-02-20T22:09:12.9650881Z          db.close()
2026-02-20T22:09:12.9650986Z -
2026-02-20T22:09:12.9651092Z -
2026-02-20T22:09:12.9651196Z  
2026-02-20T22:09:12.9651307Z  
2026-02-20T22:09:12.9651464Z  def create_test_users(db: Session):
2026-02-20T22:09:12.9651576Z      """
2026-02-20T22:09:12.9651939Z      Crée des utilisateurs de test dans la base de données.
2026-02-20T22:09:12.9652077Z @@ -119,12 +117,10 @@
2026-02-20T22:09:12.9652206Z      db.add_all(users)
2026-02-20T22:09:12.9652320Z      db.flush()
2026-02-20T22:09:12.9652814Z      logger.info(f"{len(users)} utilisateurs créés (incluant ObiWan permanent)")
2026-02-20T22:09:12.9652933Z  
2026-02-20T22:09:12.9653268Z  
2026-02-20T22:09:12.9653387Z -
2026-02-20T22:09:12.9653494Z -
2026-02-20T22:09:12.9653673Z  def create_test_exercises(db: Session):
2026-02-20T22:09:12.9653791Z      """
2026-02-20T22:09:12.9654167Z      Crée des exercices de test dans la base de données.
2026-02-20T22:09:12.9654289Z      """
2026-02-20T22:09:12.9654590Z      logger.info("Création des exercices de test")
2026-02-20T22:09:12.9654973Z @@ -180,12 +176,10 @@
2026-02-20T22:09:12.9655119Z      db.add_all(exercises)
2026-02-20T22:09:12.9655241Z      db.flush()
2026-02-20T22:09:12.9655550Z      logger.info(f"{len(exercises)} exercices créés")
2026-02-20T22:09:12.9655661Z  
2026-02-20T22:09:12.9655759Z  
2026-02-20T22:09:12.9655858Z -
2026-02-20T22:09:12.9656154Z -
2026-02-20T22:09:12.9656313Z  def create_test_attempts(db: Session):
2026-02-20T22:09:12.9656422Z      """
2026-02-20T22:09:12.9656754Z      Crée des tentatives de test dans la base de données.
2026-02-20T22:09:12.9656882Z      """
2026-02-20T22:09:12.9657196Z      logger.info("Création des tentatives de test")
2026-02-20T22:09:12.9657328Z @@ -197,11 +191,13 @@
2026-02-20T22:09:12.9657441Z  
2026-02-20T22:09:12.9657834Z      # Récupérer un utilisateur Padawan avec l'énumération native
2026-02-20T22:09:12.9658161Z      padawan = db.query(User).filter(User.role == UserRole.PADAWAN).first()
2026-02-20T22:09:12.9658279Z  
2026-02-20T22:09:12.9658449Z      if not padawan:
2026-02-20T22:09:12.9659033Z -        logger.warning("Aucun utilisateur Padawan trouvé, création des tentatives ignorée")
2026-02-20T22:09:12.9659171Z +        logger.warning(
2026-02-20T22:09:12.9659654Z +            "Aucun utilisateur Padawan trouvé, création des tentatives ignorée"
2026-02-20T22:09:12.9659771Z +        )
2026-02-20T22:09:12.9659903Z          return
2026-02-20T22:09:12.9660017Z  
2026-02-20T22:09:12.9660256Z      # Récupérer tous les exercices
2026-02-20T22:09:12.9660421Z      exercises = db.query(Exercise).all()
2026-02-20T22:09:12.9660528Z  
2026-02-20T22:09:12.9660655Z @@ -226,20 +222,22 @@
2026-02-20T22:09:12.9660768Z          db.flush()
2026-02-20T22:09:12.9661235Z          logger.info(f"Tentative réussie créée pour l'exercice {exercise.id}")
2026-02-20T22:09:12.9661355Z  
2026-02-20T22:09:12.9661593Z          # Créer une tentative échouée
2026-02-20T22:09:12.9661727Z          failed_answer = ""
2026-02-20T22:09:12.9661835Z -        
2026-02-20T22:09:12.9661968Z +
2026-02-20T22:09:12.9662203Z          if exercise.choices and len(exercise.choices) > 0:
2026-02-20T22:09:12.9662606Z -            incorrect_choices = [c for c in exercise.choices if c != exercise.correct_answer]
2026-02-20T22:09:12.9662762Z +            incorrect_choices = [
2026-02-20T22:09:12.9663231Z +                c for c in exercise.choices if c != exercise.correct_answer
2026-02-20T22:09:12.9663372Z +            ]
2026-02-20T22:09:12.9663511Z              if incorrect_choices:
2026-02-20T22:09:12.9663745Z                  failed_answer = random.choice(incorrect_choices)
2026-02-20T22:09:12.9663860Z -        
2026-02-20T22:09:12.9663963Z +
2026-02-20T22:09:12.9664432Z          # Si on n'a pas trouvé de mauvaise réponse, on utilise juste un espace
2026-02-20T22:09:12.9664575Z          if not failed_answer:
2026-02-20T22:09:12.9664713Z              failed_answer = " "
2026-02-20T22:09:12.9664832Z -            
2026-02-20T22:09:12.9664935Z +
2026-02-20T22:09:12.9665074Z          failed_attempt = Attempt(
2026-02-20T22:09:12.9665227Z              user_id=padawan.id,
2026-02-20T22:09:12.9665380Z              exercise_id=exercise.id,
2026-02-20T22:09:12.9665522Z              user_answer=failed_answer,
2026-02-20T22:09:12.9665651Z              is_correct=False,
2026-02-20T22:09:12.9665777Z @@ -251,12 +249,10 @@
2026-02-20T22:09:12.9665915Z          db.add(failed_attempt)
2026-02-20T22:09:12.9666043Z          db.flush()
2026-02-20T22:09:12.9666525Z          logger.info(f"Tentative échouée créée pour l'exercice {exercise.id}")
2026-02-20T22:09:12.9666639Z  
2026-02-20T22:09:12.9667035Z      logger.info(f"Tentatives créées pour {len(exercises)} exercices")
2026-02-20T22:09:12.9667141Z -
2026-02-20T22:09:12.9667259Z -
2026-02-20T22:09:12.9667360Z  
2026-02-20T22:09:12.9667459Z  
2026-02-20T22:09:12.9667654Z  def create_test_logic_challenges(db: Session):
2026-02-20T22:09:12.9667777Z      """
2026-02-20T22:09:12.9668134Z      Crée des défis logiques de test dans la base de données.
2026-02-20T22:09:12.9668254Z @@ -308,26 +304,27 @@
2026-02-20T22:09:12.9668633Z      db.add_all(logic_challenges)
2026-02-20T22:09:12.9668754Z      db.flush()
2026-02-20T22:09:12.9669152Z      logger.info(f"{len(logic_challenges)} défis logiques créés")
2026-02-20T22:09:12.9669262Z  
2026-02-20T22:09:12.9669375Z  
2026-02-20T22:09:12.9669476Z -
2026-02-20T22:09:12.9669579Z -
2026-02-20T22:09:12.9669956Z  def initialize_database():
2026-02-20T22:09:12.9670070Z      """
2026-02-20T22:09:12.9670575Z      Initialise la base de données avec les tables et les données nécessaires.
2026-02-20T22:09:12.9670691Z -    
2026-02-20T22:09:12.9670803Z +
2026-02-20T22:09:12.9671313Z      ATTENTION : populate_test_data() n'est appelé qu'en dehors de la production.
2026-02-20T22:09:12.9671764Z      Les fonctions de peuplement vérifient déjà si des données existent.
2026-02-20T22:09:12.9671888Z      """
2026-02-20T22:09:12.9672008Z      import os
2026-02-20T22:09:12.9672115Z +
2026-02-20T22:09:12.9672231Z      try:
2026-02-20T22:09:12.9672363Z          create_tables()
2026-02-20T22:09:12.9672625Z          environment = os.getenv("ENVIRONMENT", "development")
2026-02-20T22:09:12.9672786Z          if environment != "production":
2026-02-20T22:09:12.9672940Z              populate_test_data()
2026-02-20T22:09:12.9703337Z          else:
2026-02-20T22:09:12.9703820Z              logger.info("Mode production : pas de données de test")
2026-02-20T22:09:12.9704251Z          logger.success("Base de données initialisée avec succès")
2026-02-20T22:09:12.9704420Z      except Exception as db_init_error:
2026-02-20T22:09:12.9705049Z -        logger.error(f"Erreur lors de l'initialisation de la base de données: {str(db_init_error)}")
2026-02-20T22:09:12.9705178Z -        raise
2026-02-20T22:09:12.9705333Z \ No newline at end of file
2026-02-20T22:09:12.9705461Z +        logger.error(
2026-02-20T22:09:12.9706000Z +            f"Erreur lors de l'initialisation de la base de données: {str(db_init_error)}"
2026-02-20T22:09:12.9706125Z +        )
2026-02-20T22:09:12.9706240Z +        raise
2026-02-20T22:09:13.0336386Z --- /home/runner/work/mathakine/mathakine/app/services/email_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.0338812Z +++ /home/runner/work/mathakine/mathakine/app/services/email_service.py	2026-02-20 22:09:13.030432+00:00
2026-02-20T22:09:13.0339875Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.0340410Z  """
2026-02-20T22:09:13.0340813Z  Service d'envoi d'emails pour Mathakine
2026-02-20T22:09:13.0341343Z  Support SMTP et SendGrid (optionnel)
2026-02-20T22:09:13.0341770Z  """
2026-02-20T22:09:13.0342035Z +
2026-02-20T22:09:13.0342303Z  import os
2026-02-20T22:09:13.0342587Z  import smtplib
2026-02-20T22:09:13.0343167Z  from email.mime.multipart import MIMEMultipart
2026-02-20T22:09:13.0343717Z  from email.mime.text import MIMEText
2026-02-20T22:09:13.0344195Z  from typing import Optional
2026-02-20T22:09:13.0344576Z @@ -29,35 +30,36 @@
2026-02-20T22:09:13.0344894Z          Mail,
2026-02-20T22:09:13.0345182Z          To,
2026-02-20T22:09:13.0345497Z          TrackingSettings,
2026-02-20T22:09:13.0345892Z          ClickTracking,
2026-02-20T22:09:13.0346219Z      )
2026-02-20T22:09:13.0346495Z +
2026-02-20T22:09:13.0346787Z      SENDGRID_AVAILABLE = True
2026-02-20T22:09:13.0347195Z  except ImportError:
2026-02-20T22:09:13.0347574Z      SENDGRID_AVAILABLE = False
2026-02-20T22:09:13.0348180Z      logger.debug("SendGrid non disponible, utilisation SMTP uniquement")
2026-02-20T22:09:13.0348826Z  
2026-02-20T22:09:13.0349100Z  
2026-02-20T22:09:13.0349382Z  class EmailService:
2026-02-20T22:09:13.0349764Z      """Service pour l'envoi d'emails"""
2026-02-20T22:09:13.0350196Z -    
2026-02-20T22:09:13.0350464Z +
2026-02-20T22:09:13.0350737Z      @staticmethod
2026-02-20T22:09:13.0351067Z      def send_email(
2026-02-20T22:09:13.0351406Z          to_email: str,
2026-02-20T22:09:13.0351743Z          subject: str,
2026-02-20T22:09:13.0352096Z          html_content: str,
2026-02-20T22:09:13.0352497Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0353168Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0354010Z      ) -> bool:
2026-02-20T22:09:13.0354301Z          """
2026-02-20T22:09:13.0354605Z          Envoie un email.
2026-02-20T22:09:13.0355323Z would reformat /home/runner/work/mathakine/mathakine/app/services/email_service.py
2026-02-20T22:09:13.0356031Z -        
2026-02-20T22:09:13.0356576Z +
2026-02-20T22:09:13.0356825Z          Args:
2026-02-20T22:09:13.0357199Z              to_email: Adresse email du destinataire
2026-02-20T22:09:13.0357706Z              subject: Sujet de l'email
2026-02-20T22:09:13.0358189Z              html_content: Contenu HTML de l'email
2026-02-20T22:09:13.0358771Z              text_content: Contenu texte alternatif (optionnel)
2026-02-20T22:09:13.0359296Z -        
2026-02-20T22:09:13.0359569Z +
2026-02-20T22:09:13.0359820Z          Returns:
2026-02-20T22:09:13.0360518Z              True si l'email a été envoyé avec succès, False sinon
2026-02-20T22:09:13.0361060Z          """
2026-02-20T22:09:13.0361451Z          if os.getenv("TESTING", "false").lower() == "true":
2026-02-20T22:09:13.0362318Z              logger.debug(f"[Email] Mode test : envoi simulé vers {to_email}")
2026-02-20T22:09:13.0362953Z @@ -65,152 +67,176 @@
2026-02-20T22:09:13.0363469Z  
2026-02-20T22:09:13.0363851Z          # Vérifier si SendGrid est configuré
2026-02-20T22:09:13.0364315Z          sendgrid_api_key = os.getenv("SENDGRID_API_KEY")
2026-02-20T22:09:13.0364836Z          if sendgrid_api_key and SENDGRID_AVAILABLE:
2026-02-20T22:09:13.0365392Z              logger.info(f"[Email] Envoi via SendGrid vers {to_email}")
2026-02-20T22:09:13.0366211Z -            return EmailService._send_via_sendgrid(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0366983Z +            return EmailService._send_via_sendgrid(
2026-02-20T22:09:13.0367497Z +                to_email, subject, html_content, text_content
2026-02-20T22:09:13.0367965Z +            )
2026-02-20T22:09:13.0368242Z          else:
2026-02-20T22:09:13.0369230Z -            logger.info(f"[Email] Envoi via SMTP vers {to_email} (SendGrid: key={'✓' if sendgrid_api_key else '✗'}, pkg={SENDGRID_AVAILABLE})")
2026-02-20T22:09:13.0370255Z -            return EmailService._send_via_smtp(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0370908Z -    
2026-02-20T22:09:13.0371191Z +            logger.info(
2026-02-20T22:09:13.0372226Z +                f"[Email] Envoi via SMTP vers {to_email} (SendGrid: key={'✓' if sendgrid_api_key else '✗'}, pkg={SENDGRID_AVAILABLE})"
2026-02-20T22:09:13.0373321Z +            )
2026-02-20T22:09:13.0373702Z +            return EmailService._send_via_smtp(
2026-02-20T22:09:13.0374255Z +                to_email, subject, html_content, text_content
2026-02-20T22:09:13.0374739Z +            )
2026-02-20T22:09:13.0375026Z +
2026-02-20T22:09:13.0375317Z      @staticmethod
2026-02-20T22:09:13.0375652Z      def _send_via_sendgrid(
2026-02-20T22:09:13.0376040Z          to_email: str,
2026-02-20T22:09:13.0376386Z          subject: str,
2026-02-20T22:09:13.0376758Z          html_content: str,
2026-02-20T22:09:13.0377154Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0377599Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0378018Z      ) -> bool:
2026-02-20T22:09:13.0378366Z          """Envoie un email via SendGrid API"""
2026-02-20T22:09:13.0378816Z          try:
2026-02-20T22:09:13.0379227Z              sendgrid_api_key = os.getenv("SENDGRID_API_KEY")
2026-02-20T22:09:13.0379736Z              if not sendgrid_api_key:
2026-02-20T22:09:13.0381807Z                  logger.error("SENDGRID_API_KEY non configurée")
2026-02-20T22:09:13.0382389Z                  return False
2026-02-20T22:09:13.0382762Z -            
2026-02-20T22:09:13.0383253Z +
2026-02-20T22:09:13.0383690Z              sg = sendgrid.SendGridAPIClient(api_key=sendgrid_api_key)
2026-02-20T22:09:13.0384514Z -            from_email = Email(os.getenv("SENDGRID_FROM_EMAIL", "noreply@mathakine.com"))
2026-02-20T22:09:13.0385226Z +            from_email = Email(
2026-02-20T22:09:13.0386055Z +                os.getenv("SENDGRID_FROM_EMAIL", "noreply@mathakine.com")
2026-02-20T22:09:13.0386624Z +            )
2026-02-20T22:09:13.0386938Z              to_email_obj = To(to_email)
2026-02-20T22:09:13.0387349Z -            
2026-02-20T22:09:13.0387629Z +
2026-02-20T22:09:13.0387908Z              if text_content:
2026-02-20T22:09:13.0388625Z                  content = Content("text/plain", text_content)
2026-02-20T22:09:13.0389117Z              else:
2026-02-20T22:09:13.0389524Z                  # Extraire le texte depuis le HTML si possible
2026-02-20T22:09:13.0390040Z                  import re
2026-02-20T22:09:13.0390513Z -                text_content = re.sub(r'<[^>]+>', '', html_content)
2026-02-20T22:09:13.0391032Z +
2026-02-20T22:09:13.0391423Z +                text_content = re.sub(r"<[^>]+>", "", html_content)
2026-02-20T22:09:13.0392018Z                  content = Content("text/html", html_content)
2026-02-20T22:09:13.0392502Z -            
2026-02-20T22:09:13.0392794Z +
2026-02-20T22:09:13.0393285Z              message = Mail(
2026-02-20T22:09:13.0393689Z                  from_email=from_email,
2026-02-20T22:09:13.0394123Z                  to_emails=to_email_obj,
2026-02-20T22:09:13.0394556Z                  subject=subject,
2026-02-20T22:09:13.0394969Z -                html_content=html_content
2026-02-20T22:09:13.0395447Z +                html_content=html_content,
2026-02-20T22:09:13.0395865Z              )
2026-02-20T22:09:13.0396706Z              # Désactiver le click tracking : les liens restent directs (verify-email, reset-password)
2026-02-20T22:09:13.0397589Z              message.tracking_settings = TrackingSettings()
2026-02-20T22:09:13.0398354Z              message.tracking_settings.click_tracking = ClickTracking(enable=False)
2026-02-20T22:09:13.0399010Z  
2026-02-20T22:09:13.0399293Z              if text_content:
2026-02-20T22:09:13.0399834Z                  message.add_content(Content("text/plain", text_content))
2026-02-20T22:09:13.0400409Z -            
2026-02-20T22:09:13.0400717Z +
2026-02-20T22:09:13.0401010Z              response = sg.send(message)
2026-02-20T22:09:13.0401426Z -            
2026-02-20T22:09:13.0401714Z +
2026-02-20T22:09:13.0402050Z              if response.status_code in [200, 201, 202]:
2026-02-20T22:09:13.0402829Z                  logger.info(f"Email envoyé via SendGrid à {to_email}")
2026-02-20T22:09:13.0403626Z                  return True
2026-02-20T22:09:13.0404001Z              else:
2026-02-20T22:09:13.0404641Z -                logger.error(f"Erreur SendGrid: {response.status_code} - {response.body}")
2026-02-20T22:09:13.0405358Z +                logger.error(
2026-02-20T22:09:13.0405907Z +                    f"Erreur SendGrid: {response.status_code} - {response.body}"
2026-02-20T22:09:13.0406514Z +                )
2026-02-20T22:09:13.0406847Z                  return False
2026-02-20T22:09:13.0407195Z -                
2026-02-20T22:09:13.0407487Z +
2026-02-20T22:09:13.0407809Z          except Exception as sendgrid_error:
2026-02-20T22:09:13.0408501Z              logger.error(f"Erreur lors de l'envoi via SendGrid: {sendgrid_error}")
2026-02-20T22:09:13.0409152Z              return False
2026-02-20T22:09:13.0409499Z -    
2026-02-20T22:09:13.0409759Z +
2026-02-20T22:09:13.0410032Z      @staticmethod
2026-02-20T22:09:13.0410360Z      def _send_via_smtp(
2026-02-20T22:09:13.0410725Z          to_email: str,
2026-02-20T22:09:13.0411085Z          subject: str,
2026-02-20T22:09:13.0411428Z          html_content: str,
2026-02-20T22:09:13.0411835Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0412339Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0412782Z      ) -> bool:
2026-02-20T22:09:13.0413366Z          """Envoie un email via SMTP"""
2026-02-20T22:09:13.0413799Z          try:
2026-02-20T22:09:13.0414256Z              # Configuration SMTP depuis les variables d'environnement
2026-02-20T22:09:13.0414964Z              smtp_host = os.getenv("SMTP_HOST", "smtp.gmail.com")
2026-02-20T22:09:13.0415596Z              smtp_port = int(os.getenv("SMTP_PORT", "587"))
2026-02-20T22:09:13.0416424Z              smtp_user = os.getenv("SMTP_USER", "")
2026-02-20T22:09:13.0416984Z              smtp_password = os.getenv("SMTP_PASSWORD", "")
2026-02-20T22:09:13.0417775Z -            smtp_from_email = os.getenv("SMTP_FROM_EMAIL", smtp_user or "noreply@mathakine.com")
2026-02-20T22:09:13.0418791Z +            smtp_from_email = os.getenv(
2026-02-20T22:09:13.0419346Z +                "SMTP_FROM_EMAIL", smtp_user or "noreply@mathakine.com"
2026-02-20T22:09:13.0419899Z +            )
2026-02-20T22:09:13.0420388Z              smtp_use_tls = os.getenv("SMTP_USE_TLS", "true").lower() == "true"
2026-02-20T22:09:13.0420968Z -            
2026-02-20T22:09:13.0421261Z +
2026-02-20T22:09:13.0421785Z              # Si SMTP non configuré, logger et retourner False
2026-02-20T22:09:13.0422390Z              if not smtp_user or not smtp_password:
2026-02-20T22:09:13.0423366Z                  logger.warning(f"SMTP non configuré - Email non envoyé")
2026-02-20T22:09:13.0424830Z -                logger.warning(f"SMTP_USER={'configuré' if smtp_user else 'MANQUANT'}, SMTP_PASSWORD={'configuré' if smtp_password else 'MANQUANT'}")
2026-02-20T22:09:13.0425898Z +                logger.warning(
2026-02-20T22:09:13.0426998Z +                    f"SMTP_USER={'configuré' if smtp_user else 'MANQUANT'}, SMTP_PASSWORD={'configuré' if smtp_password else 'MANQUANT'}"
2026-02-20T22:09:13.0427959Z +                )
2026-02-20T22:09:13.0428628Z                  logger.info(f"Email qui aurait été envoyé à {to_email}: {subject}")
2026-02-20T22:09:13.0429514Z                  # En développement, on peut simuler l'envoi
2026-02-20T22:09:13.0430159Z                  if os.getenv("ENVIRONMENT", "").lower() != "production":
2026-02-20T22:09:13.0430992Z                      logger.info("Mode développement: Email simulé")
2026-02-20T22:09:13.0431551Z                      return True
2026-02-20T22:09:13.0431942Z                  return False
2026-02-20T22:09:13.0432309Z -            
2026-02-20T22:09:13.0433296Z -            logger.info(f"Tentative d'envoi email SMTP à {to_email} via {smtp_host}:{smtp_port}")
2026-02-20T22:09:13.0434083Z -            
2026-02-20T22:09:13.0434358Z +
2026-02-20T22:09:13.0434637Z +            logger.info(
2026-02-20T22:09:13.0435376Z +                f"Tentative d'envoi email SMTP à {to_email} via {smtp_host}:{smtp_port}"
2026-02-20T22:09:13.0436062Z +            )
2026-02-20T22:09:13.0436358Z +
2026-02-20T22:09:13.0436733Z              # Créer le message
2026-02-20T22:09:13.0437189Z -            msg = MIMEMultipart('alternative')
2026-02-20T22:09:13.0437681Z -            msg['Subject'] = subject
2026-02-20T22:09:13.0438140Z -            msg['From'] = smtp_from_email
2026-02-20T22:09:13.0438581Z -            msg['To'] = to_email
2026-02-20T22:09:13.0438957Z -            
2026-02-20T22:09:13.0439295Z +            msg = MIMEMultipart("alternative")
2026-02-20T22:09:13.0439772Z +            msg["Subject"] = subject
2026-02-20T22:09:13.0440194Z +            msg["From"] = smtp_from_email
2026-02-20T22:09:13.0440638Z +            msg["To"] = to_email
2026-02-20T22:09:13.0441011Z +
2026-02-20T22:09:13.0441319Z              # Ajouter le contenu texte si fourni
2026-02-20T22:09:13.0441801Z              if text_content:
2026-02-20T22:09:13.0442250Z -                part_text = MIMEText(text_content, 'plain')
2026-02-20T22:09:13.0442857Z +                part_text = MIMEText(text_content, "plain")
2026-02-20T22:09:13.0443534Z                  msg.attach(part_text)
2026-02-20T22:09:13.0443919Z -            
2026-02-20T22:09:13.0444193Z +
2026-02-20T22:09:13.0444490Z              # Ajouter le contenu HTML
2026-02-20T22:09:13.0444990Z -            part_html = MIMEText(html_content, 'html')
2026-02-20T22:09:13.0445552Z +            part_html = MIMEText(html_content, "html")
2026-02-20T22:09:13.0446058Z              msg.attach(part_html)
2026-02-20T22:09:13.0446448Z -            
2026-02-20T22:09:13.0446736Z +
2026-02-20T22:09:13.0447014Z              # Envoyer l'email
2026-02-20T22:09:13.0447964Z              logger.debug(f"Connexion SMTP à {smtp_host}:{smtp_port}")
2026-02-20T22:09:13.0448654Z              with smtplib.SMTP(smtp_host, smtp_port) as server:
2026-02-20T22:09:13.0449545Z                  logger.debug(f"Connexion établie, démarrage TLS: {smtp_use_tls}")
2026-02-20T22:09:13.0450216Z                  if smtp_use_tls:
2026-02-20T22:09:13.0450882Z                      server.starttls()
2026-02-20T22:09:13.0451428Z                  logger.debug(f"Authentification avec {smtp_user}")
2026-02-20T22:09:13.0452035Z                  server.login(smtp_user, smtp_password)
2026-02-20T22:09:13.0452753Z                  logger.debug(f"Envoi du message à {to_email}")
2026-02-20T22:09:13.0453495Z                  server.send_message(msg)
2026-02-20T22:09:13.0453930Z -            
2026-02-20T22:09:13.0454667Z -            logger.info(f"✅ Email envoyé via SMTP à {to_email} depuis {smtp_from_email}")
2026-02-20T22:09:13.0455365Z +
2026-02-20T22:09:13.0455651Z +            logger.info(
2026-02-20T22:09:13.0456355Z +                f"✅ Email envoyé via SMTP à {to_email} depuis {smtp_from_email}"
2026-02-20T22:09:13.0456963Z +            )
2026-02-20T22:09:13.0457272Z              return True
2026-02-20T22:09:13.0457611Z -            
2026-02-20T22:09:13.0457889Z +
2026-02-20T22:09:13.0458335Z          except smtplib.SMTPAuthenticationError as smtp_auth_error:
2026-02-20T22:09:13.0459311Z              logger.error(f"❌ Erreur d'authentification SMTP: {smtp_auth_error}")
2026-02-20T22:09:13.0460290Z              logger.error(f"Vérifiez SMTP_USER ({smtp_user}) et SMTP_PASSWORD")
2026-02-20T22:09:13.0460932Z              return False
2026-02-20T22:09:13.0461369Z          except smtplib.SMTPException as smtp_error:
2026-02-20T22:09:13.0462080Z              logger.error(f"❌ Erreur SMTP: {smtp_error}")
2026-02-20T22:09:13.0462583Z              return False
2026-02-20T22:09:13.0463176Z          except Exception as smtp_general_error:
2026-02-20T22:09:13.0464264Z -            logger.error(f"❌ Erreur lors de l'envoi via SMTP: {type(smtp_general_error).__name__}: {smtp_general_error}")
2026-02-20T22:09:13.0465169Z +            logger.error(
2026-02-20T22:09:13.0466073Z +                f"❌ Erreur lors de l'envoi via SMTP: {type(smtp_general_error).__name__}: {smtp_general_error}"
2026-02-20T22:09:13.0466848Z +            )
2026-02-20T22:09:13.0467184Z              import traceback
2026-02-20T22:09:13.0467539Z +
2026-02-20T22:09:13.0467874Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:13.0468345Z              return False
2026-02-20T22:09:13.0468684Z -    
2026-02-20T22:09:13.0468951Z +
2026-02-20T22:09:13.0469230Z      @staticmethod
2026-02-20T22:09:13.0469582Z      def send_verification_email(
2026-02-20T22:09:13.0469991Z          to_email: str,
2026-02-20T22:09:13.0470346Z          username: str,
2026-02-20T22:09:13.0470695Z          verification_token: str,
2026-02-20T22:09:13.0471130Z -        frontend_url: Optional[str] = None
2026-02-20T22:09:13.0471616Z +        frontend_url: Optional[str] = None,
2026-02-20T22:09:13.0472081Z      ) -> bool:
2026-02-20T22:09:13.0472371Z          """
2026-02-20T22:09:13.0472903Z          Envoie un email de vérification à l'inscription.
2026-02-20T22:09:13.0473824Z          Template thème Jedi, ergonomique et accessible.
2026-02-20T22:09:13.0474321Z          """
2026-02-20T22:09:13.0474631Z          if not frontend_url:
2026-02-20T22:09:13.0475359Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.0476166Z +            frontend_url = os.getenv(
2026-02-20T22:09:13.0476760Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.0477359Z +            )
2026-02-20T22:09:13.0477922Z          verification_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:13.0478729Z          subject = "Bienvenue ! Active ton compte Mathakine"
2026-02-20T22:09:13.0479456Z          html_content = verification_email_html(username, verification_link)
2026-02-20T22:09:13.0480528Z          text_content = verification_email_text(username, verification_link)
2026-02-20T22:09:13.0481408Z          return EmailService.send_email(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0482102Z @@ -218,19 +244,20 @@
2026-02-20T22:09:13.0482442Z      @staticmethod
2026-02-20T22:09:13.0483217Z      def send_password_reset_email(
2026-02-20T22:09:13.0483659Z          to_email: str,
2026-02-20T22:09:13.0484002Z          username: str,
2026-02-20T22:09:13.0484350Z          reset_token: str,
2026-02-20T22:09:13.0484750Z -        frontend_url: Optional[str] = None
2026-02-20T22:09:13.0485227Z +        frontend_url: Optional[str] = None,
2026-02-20T22:09:13.0485664Z      ) -> bool:
2026-02-20T22:09:13.0485954Z          """
2026-02-20T22:09:13.0486516Z          Envoie un email de réinitialisation de mot de passe.
2026-02-20T22:09:13.0487257Z          Template thème Jedi, ergonomique et accessible.
2026-02-20T22:09:13.0487756Z          """
2026-02-20T22:09:13.0488081Z          if not frontend_url:
2026-02-20T22:09:13.0488770Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.0489688Z +            frontend_url = os.getenv(
2026-02-20T22:09:13.0490273Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.0490887Z +            )
2026-02-20T22:09:13.0491376Z          reset_link = f"{frontend_url}/reset-password?token={reset_token}"
2026-02-20T22:09:13.0492296Z          subject = "Réinitialisation de ton mot de passe — Mathakine"
2026-02-20T22:09:13.0493266Z          html_content = password_reset_email_html(username, reset_link)
2026-02-20T22:09:13.0494053Z          text_content = password_reset_email_text(username, reset_link)
2026-02-20T22:09:13.0494904Z          return EmailService.send_email(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0495576Z -
2026-02-20T22:09:13.1504327Z --- /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.1505980Z +++ /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py	2026-02-20 22:09:13.145701+00:00
2026-02-20T22:09:13.1507034Z @@ -1,10 +1,11 @@
2026-02-20T22:09:13.1507359Z  """
2026-02-20T22:09:13.1507735Z  Service d'adaptation pour enhanced_server.py.
2026-02-20T22:09:13.1508965Z  Permet d'utiliser le système de transaction et les services avec enhanced_server.py
2026-02-20T22:09:13.1509787Z  sans modifier massivement le serveur existant.
2026-02-20T22:09:13.1510281Z  """
2026-02-20T22:09:13.1510551Z +
2026-02-20T22:09:13.1510810Z  import json
2026-02-20T22:09:13.1511215Z  from typing import Any, Dict, List, Optional, Union
2026-02-20T22:09:13.1511693Z  
2026-02-20T22:09:13.1512038Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.1512500Z  
2026-02-20T22:09:13.1512752Z @@ -22,170 +23,177 @@
2026-02-20T22:09:13.1513299Z  
2026-02-20T22:09:13.1513549Z  
2026-02-20T22:09:13.1513990Z  def _serialize_exercise(exercise: Exercise) -> Dict[str, Any]:
2026-02-20T22:09:13.1514542Z      """
2026-02-20T22:09:13.1515255Z      Helper pour sérialiser un objet Exercise en dictionnaire JSON-sérialisable.
2026-02-20T22:09:13.1515902Z -    
2026-02-20T22:09:13.1516160Z +
2026-02-20T22:09:13.1516400Z      Args:
2026-02-20T22:09:13.1516721Z          exercise: Objet Exercise SQLAlchemy
2026-02-20T22:09:13.1517173Z -        
2026-02-20T22:09:13.1517433Z +
2026-02-20T22:09:13.1517681Z      Returns:
2026-02-20T22:09:13.1518108Z          Dictionnaire sérialisable en JSON
2026-02-20T22:09:13.1518537Z      """
2026-02-20T22:09:13.1518929Z      # Convertir les énumérations en strings
2026-02-20T22:09:13.1519962Z -    exercise_type_value = exercise.exercise_type.value if hasattr(exercise.exercise_type, 'value') else str(exercise.exercise_type)
2026-02-20T22:09:13.1521497Z -    difficulty_value = exercise.difficulty.value if hasattr(exercise.difficulty, 'value') else str(exercise.difficulty)
2026-02-20T22:09:13.1522867Z -    
2026-02-20T22:09:13.1523375Z +    exercise_type_value = (
2026-02-20T22:09:13.1523765Z +        exercise.exercise_type.value
2026-02-20T22:09:13.1524241Z +        if hasattr(exercise.exercise_type, "value")
2026-02-20T22:09:13.1524745Z +        else str(exercise.exercise_type)
2026-02-20T22:09:13.1525176Z +    )
2026-02-20T22:09:13.1525733Z +    difficulty_value = (
2026-02-20T22:09:13.1526124Z +        exercise.difficulty.value
2026-02-20T22:09:13.1526586Z +        if hasattr(exercise.difficulty, "value")
2026-02-20T22:09:13.1527095Z +        else str(exercise.difficulty)
2026-02-20T22:09:13.1527498Z +    )
2026-02-20T22:09:13.1527752Z +
2026-02-20T22:09:13.1528063Z      # Convertir les dates en ISO format strings
2026-02-20T22:09:13.1528788Z      created_at_str = exercise.created_at.isoformat() if exercise.created_at else None
2026-02-20T22:09:13.1529757Z      updated_at_str = exercise.updated_at.isoformat() if exercise.updated_at else None
2026-02-20T22:09:13.1530431Z -    
2026-02-20T22:09:13.1530699Z +
2026-02-20T22:09:13.1531208Z      # Gérer les choices (peut être JSON string ou list)
2026-02-20T22:09:13.1531736Z      choices_value = exercise.choices
2026-02-20T22:09:13.1532189Z      if isinstance(choices_value, str):
2026-02-20T22:09:13.1532611Z          try:
2026-02-20T22:09:13.1533161Z              choices_value = json.loads(choices_value)
2026-02-20T22:09:13.1533721Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:13.1534195Z              choices_value = []
2026-02-20T22:09:13.1534588Z      elif choices_value is None:
2026-02-20T22:09:13.1534994Z          choices_value = []
2026-02-20T22:09:13.1535329Z -    
2026-02-20T22:09:13.1535590Z +
2026-02-20T22:09:13.1535818Z      return {
2026-02-20T22:09:13.1536115Z -        'id': exercise.id,
2026-02-20T22:09:13.1536502Z -        'title': exercise.title,
2026-02-20T22:09:13.1536936Z -        'creator_id': exercise.creator_id,
2026-02-20T22:09:13.1537442Z -        'exercise_type': exercise_type_value,
2026-02-20T22:09:13.1537932Z -        'difficulty': difficulty_value,
2026-02-20T22:09:13.1538383Z -        'tags': exercise.tags,
2026-02-20T22:09:13.1538790Z -        'question': exercise.question,
2026-02-20T22:09:13.1539272Z -        'correct_answer': exercise.correct_answer,
2026-02-20T22:09:13.1539754Z -        'choices': choices_value,
2026-02-20T22:09:13.1540189Z -        'explanation': exercise.explanation,
2026-02-20T22:09:13.1540661Z -        'hint': exercise.hint,
2026-02-20T22:09:13.1541062Z -        'image_url': exercise.image_url,
2026-02-20T22:09:13.1541531Z -        'audio_url': exercise.audio_url,
2026-02-20T22:09:13.1541969Z -        'is_active': exercise.is_active,
2026-02-20T22:09:13.1542432Z -        'is_archived': exercise.is_archived,
2026-02-20T22:09:13.1543182Z -        'ai_generated': getattr(exercise, 'ai_generated', False),
2026-02-20T22:09:13.1543814Z -        'view_count': exercise.view_count or 0,
2026-02-20T22:09:13.1544301Z -        'created_at': created_at_str,
2026-02-20T22:09:13.1544737Z -        'updated_at': updated_at_str,
2026-02-20T22:09:13.1545199Z +        "id": exercise.id,
2026-02-20T22:09:13.1545596Z +        "title": exercise.title,
2026-02-20T22:09:13.1546031Z +        "creator_id": exercise.creator_id,
2026-02-20T22:09:13.1546534Z +        "exercise_type": exercise_type_value,
2026-02-20T22:09:13.1547033Z +        "difficulty": difficulty_value,
2026-02-20T22:09:13.1547500Z +        "tags": exercise.tags,
2026-02-20T22:09:13.1547884Z +        "question": exercise.question,
2026-02-20T22:09:13.1548331Z +        "correct_answer": exercise.correct_answer,
2026-02-20T22:09:13.1548847Z +        "choices": choices_value,
2026-02-20T22:09:13.1549296Z +        "explanation": exercise.explanation,
2026-02-20T22:09:13.1549766Z +        "hint": exercise.hint,
2026-02-20T22:09:13.1550158Z +        "image_url": exercise.image_url,
2026-02-20T22:09:13.1550613Z +        "audio_url": exercise.audio_url,
2026-02-20T22:09:13.1551085Z +        "is_active": exercise.is_active,
2026-02-20T22:09:13.1551543Z +        "is_archived": exercise.is_archived,
2026-02-20T22:09:13.1552406Z +        "ai_generated": getattr(exercise, "ai_generated", False),
2026-02-20T22:09:13.1553215Z +        "view_count": exercise.view_count or 0,
2026-02-20T22:09:13.1553728Z +        "created_at": created_at_str,
2026-02-20T22:09:13.1554177Z +        "updated_at": updated_at_str,
2026-02-20T22:09:13.1554845Z      }
2026-02-20T22:09:13.1555108Z  
2026-02-20T22:09:13.1555344Z  
2026-02-20T22:09:13.1555628Z  class EnhancedServerAdapter:
2026-02-20T22:09:13.1556002Z      """
2026-02-20T22:09:13.1556312Z      Adaptateur pour enhanced_server.py.
2026-02-20T22:09:13.1557098Z      Fournit des méthodes qui correspondent aux opérations SQL directes
2026-02-20T22:09:13.1558033Z      dans enhanced_server.py, mais utilise notre système de transaction.
2026-02-20T22:09:13.1558627Z      """
2026-02-20T22:09:13.1558890Z -    
2026-02-20T22:09:13.1559146Z +
2026-02-20T22:09:13.1559400Z      @staticmethod
2026-02-20T22:09:13.1559742Z      def get_db_session() -> Session:
2026-02-20T22:09:13.1560146Z          """
2026-02-20T22:09:13.1560590Z          Obtient une session de base de données.
2026-02-20T22:09:13.1561213Z          Remplace la fonction get_db_connection() de enhanced_server.py.
2026-02-20T22:09:13.1561773Z -        
2026-02-20T22:09:13.1562030Z +
2026-02-20T22:09:13.1562285Z          Returns:
2026-02-20T22:09:13.1562634Z              Session: Une session SQLAlchemy
2026-02-20T22:09:13.1593354Z          """
2026-02-20T22:09:13.1593714Z          return SessionLocal()
2026-02-20T22:09:13.1594086Z -    
2026-02-20T22:09:13.1594379Z +
2026-02-20T22:09:13.1594638Z      @staticmethod
2026-02-20T22:09:13.1595028Z      def close_db_session(db: Session) -> None:
2026-02-20T22:09:13.1595472Z          """
2026-02-20T22:09:13.1595965Z          Ferme une session de base de données.
2026-02-20T22:09:13.1596391Z -        
2026-02-20T22:09:13.1596657Z +
2026-02-20T22:09:13.1596899Z          Args:
2026-02-20T22:09:13.1597272Z              db: Session à fermer
2026-02-20T22:09:13.1597670Z          """
2026-02-20T22:09:13.1597951Z          db.close()
2026-02-20T22:09:13.1598252Z -    
2026-02-20T22:09:13.1598502Z +
2026-02-20T22:09:13.1598758Z      @staticmethod
2026-02-20T22:09:13.1599314Z      def get_exercise_by_id(db: Session, exercise_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1599980Z          """
2026-02-20T22:09:13.1600419Z          Récupère un exercice par son ID.
2026-02-20T22:09:13.1600857Z -        
2026-02-20T22:09:13.1601115Z +
2026-02-20T22:09:13.1601367Z          Args:
2026-02-20T22:09:13.1601771Z              db: Session de base de données
2026-02-20T22:09:13.1602234Z              exercise_id: ID de l'exercice
2026-02-20T22:09:13.1602647Z -            
2026-02-20T22:09:13.1602920Z +
2026-02-20T22:09:13.1603381Z          Returns:
2026-02-20T22:09:13.1603971Z              Un dictionnaire contenant les données de l'exercice ou None
2026-02-20T22:09:13.1604673Z          """
2026-02-20T22:09:13.1605183Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.1606089Z          if exercise:
2026-02-20T22:09:13.1606601Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1653453Z          return None
2026-02-20T22:09:13.1653872Z -    
2026-02-20T22:09:13.1654136Z +
2026-02-20T22:09:13.1654401Z      @staticmethod
2026-02-20T22:09:13.1654747Z      def list_exercises(
2026-02-20T22:09:13.1655134Z -        db: Session, 
2026-02-20T22:09:13.1655467Z +        db: Session,
2026-02-20T22:09:13.1655827Z          exercise_type: Optional[str] = None,
2026-02-20T22:09:13.1656325Z          difficulty: Optional[str] = None,
2026-02-20T22:09:13.1656776Z -        limit: Optional[int] = None
2026-02-20T22:09:13.1657202Z +        limit: Optional[int] = None,
2026-02-20T22:09:13.1657622Z      ) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1657997Z          """
2026-02-20T22:09:13.1658385Z          Liste les exercices actifs avec filtrage optionnel.
2026-02-20T22:09:13.1658872Z -        
2026-02-20T22:09:13.1659144Z +
2026-02-20T22:09:13.1659813Z          Args:
2026-02-20T22:09:13.1660329Z              db: Session de base de données
2026-02-20T22:09:13.1660931Z              exercise_type: Type d'exercice à filtrer
2026-02-20T22:09:13.1661584Z              difficulty: Niveau de difficulté à filtrer
2026-02-20T22:09:13.1662243Z              limit: Nombre maximum d'exercices à retourner
2026-02-20T22:09:13.1663213Z -            
2026-02-20T22:09:13.1663518Z +
2026-02-20T22:09:13.1663779Z          Returns:
2026-02-20T22:09:13.1664374Z              Liste de dictionnaires contenant les données des exercices
2026-02-20T22:09:13.1664942Z          """
2026-02-20T22:09:13.1665309Z          exercises = ExerciseService.list_exercises(
2026-02-20T22:09:13.1665776Z -            db,
2026-02-20T22:09:13.1666114Z -            exercise_type=exercise_type,
2026-02-20T22:09:13.1666564Z -            difficulty=difficulty,
2026-02-20T22:09:13.1666975Z -            limit=limit
2026-02-20T22:09:13.1667501Z +            db, exercise_type=exercise_type, difficulty=difficulty, limit=limit
2026-02-20T22:09:13.1668129Z          )
2026-02-20T22:09:13.1668388Z -        
2026-02-20T22:09:13.1668656Z +
2026-02-20T22:09:13.1669327Z          # Convertir les objets SQLAlchemy en dictionnaires avec sérialisation des dates
2026-02-20T22:09:13.1670133Z          return [_serialize_exercise(ex) for ex in exercises]
2026-02-20T22:09:13.1670653Z -    
2026-02-20T22:09:13.1670917Z -    @staticmethod
2026-02-20T22:09:13.1671555Z -    def create_exercise(db: Session, exercise_data: Dict[str, Any]) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1672292Z +
2026-02-20T22:09:13.1672560Z +    @staticmethod
2026-02-20T22:09:13.1672873Z +    def create_exercise(
2026-02-20T22:09:13.1673523Z +        db: Session, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.1674022Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1674407Z          """
2026-02-20T22:09:13.1674814Z          Crée un nouvel exercice.
2026-02-20T22:09:13.1675187Z -        
2026-02-20T22:09:13.1675457Z +
2026-02-20T22:09:13.1675715Z          Args:
2026-02-20T22:09:13.1676139Z              db: Session de base de données
2026-02-20T22:09:13.1676691Z              exercise_data: Données de l'exercice
2026-02-20T22:09:13.1677135Z -            
2026-02-20T22:09:13.1677404Z +
2026-02-20T22:09:13.1677654Z          Returns:
2026-02-20T22:09:13.1678093Z              Un dictionnaire contenant les données de l'exercice créé ou None
2026-02-20T22:09:13.1678224Z          """
2026-02-20T22:09:13.1678518Z          exercise = ExerciseService.create_exercise(db, exercise_data)
2026-02-20T22:09:13.1678641Z          if exercise:
2026-02-20T22:09:13.1678806Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1678935Z          return None
2026-02-20T22:09:13.1679041Z -    
2026-02-20T22:09:13.1679146Z +
2026-02-20T22:09:13.1679270Z      @staticmethod
2026-02-20T22:09:13.1679409Z      def create_generated_exercise(
2026-02-20T22:09:13.1679531Z -        db: Session, 
2026-02-20T22:09:13.1679664Z -        exercise_type: str, 
2026-02-20T22:09:13.1679798Z +        db: Session,
2026-02-20T22:09:13.1679934Z +        exercise_type: str,
2026-02-20T22:09:13.1680248Z          age_group: str,  # Ajout du paramètre manquant
2026-02-20T22:09:13.1680392Z -        difficulty: str, 
2026-02-20T22:09:13.1680521Z +        difficulty: str,
2026-02-20T22:09:13.1680637Z          title: str,
2026-02-20T22:09:13.1680775Z          question: str,
2026-02-20T22:09:13.1680916Z          correct_answer: str,
2026-02-20T22:09:13.1681043Z          choices: List[str],
2026-02-20T22:09:13.1681177Z          explanation: str,
2026-02-20T22:09:13.1681331Z          hint: Optional[str] = None,
2026-02-20T22:09:13.1681469Z          tags: Optional[str] = None,
2026-02-20T22:09:13.1682029Z would reformat /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py
2026-02-20T22:09:13.1682186Z          ai_generated: bool = False,
2026-02-20T22:09:13.1682318Z -        locale: str = "fr"
2026-02-20T22:09:13.1682443Z +        locale: str = "fr",
2026-02-20T22:09:13.1682854Z      ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1713195Z          """
2026-02-20T22:09:13.1713718Z          Crée un nouvel exercice généré avec support des traductions.
2026-02-20T22:09:13.1714290Z          Cette méthode est spécifiquement conçue pour les fonctions de génération d'exercices
2026-02-20T22:09:13.1714753Z          dans enhanced_server.py.
2026-02-20T22:09:13.1714869Z -        
2026-02-20T22:09:13.1714980Z +
2026-02-20T22:09:13.1715103Z          Args:
2026-02-20T22:09:13.1715627Z              db: Session de base de données (non utilisée, conservée pour compatibilité)
2026-02-20T22:09:13.1715795Z              exercise_type: Type d'exercice
2026-02-20T22:09:13.1716062Z              age_group: Groupe d'âge de l'exercice
2026-02-20T22:09:13.1716280Z              difficulty: Niveau de difficulté
2026-02-20T22:09:13.1716401Z @@ -196,39 +204,42 @@
2026-02-20T22:09:13.1716671Z              explanation: Explication de la réponse
2026-02-20T22:09:13.1716823Z              hint: Indice (optionnel)
2026-02-20T22:09:13.1716979Z              tags: Tags (optionnel)
2026-02-20T22:09:13.1717304Z              ai_generated: Si l'exercice a été généré par IA
2026-02-20T22:09:13.1717724Z              locale: Locale pour la création des traductions (défaut: "fr")
2026-02-20T22:09:13.1717851Z -            
2026-02-20T22:09:13.1717974Z +
2026-02-20T22:09:13.1718087Z          Returns:
2026-02-20T22:09:13.1718527Z              Un dictionnaire contenant les données de l'exercice créé ou None
2026-02-20T22:09:13.1718640Z          """
2026-02-20T22:09:13.1719141Z          # NOTE: exercise_service_translations archivé - utiliser ExerciseService ORM
2026-02-20T22:09:13.1719337Z          from app.services import ExerciseService
2026-02-20T22:09:13.1719441Z -        
2026-02-20T22:09:13.1719546Z +
2026-02-20T22:09:13.1719675Z          exercise_data = {
2026-02-20T22:09:13.1719810Z -            'title': title,
2026-02-20T22:09:13.1719969Z -            'exercise_type': exercise_type,
2026-02-20T22:09:13.1720374Z -            'age_group': age_group,  # Utilisation du nouveau paramètre
2026-02-20T22:09:13.1720534Z -            'difficulty': difficulty,
2026-02-20T22:09:13.1720671Z -            'question': question,
2026-02-20T22:09:13.1720830Z -            'correct_answer': correct_answer,
2026-02-20T22:09:13.1720958Z -            'choices': choices,
2026-02-20T22:09:13.1721129Z -            'explanation': explanation,
2026-02-20T22:09:13.1721251Z -            'hint': hint,
2026-02-20T22:09:13.1721395Z -            'tags': tags or "generated",
2026-02-20T22:09:13.1721552Z -            'ai_generated': ai_generated,
2026-02-20T22:09:13.1721683Z -            'is_active': True,
2026-02-20T22:09:13.1721816Z -            'is_archived': False,
2026-02-20T22:09:13.1721953Z -            'view_count': 0
2026-02-20T22:09:13.1722081Z +            "title": title,
2026-02-20T22:09:13.1722236Z +            "exercise_type": exercise_type,
2026-02-20T22:09:13.1722624Z +            "age_group": age_group,  # Utilisation du nouveau paramètre
2026-02-20T22:09:13.1722786Z +            "difficulty": difficulty,
2026-02-20T22:09:13.1722917Z +            "question": question,
2026-02-20T22:09:13.1723265Z +            "correct_answer": correct_answer,
2026-02-20T22:09:13.1723412Z +            "choices": choices,
2026-02-20T22:09:13.1723565Z +            "explanation": explanation,
2026-02-20T22:09:13.1723698Z +            "hint": hint,
2026-02-20T22:09:13.1723840Z +            "tags": tags or "generated",
2026-02-20T22:09:13.1723997Z +            "ai_generated": ai_generated,
2026-02-20T22:09:13.1724125Z +            "is_active": True,
2026-02-20T22:09:13.1724255Z +            "is_archived": False,
2026-02-20T22:09:13.1724390Z +            "view_count": 0,
2026-02-20T22:09:13.1724498Z          }
2026-02-20T22:09:13.1724606Z -        
2026-02-20T22:09:13.1725435Z -        logger.info(f"Création d'un exercice généré de type {exercise_type}, groupe d'âge {age_group}, difficulté {difficulty}")
2026-02-20T22:09:13.1725548Z +
2026-02-20T22:09:13.1725902Z +        logger.info(
2026-02-20T22:09:13.1726626Z +            f"Création d'un exercice généré de type {exercise_type}, groupe d'âge {age_group}, difficulté {difficulty}"
2026-02-20T22:09:13.1726752Z +        )
2026-02-20T22:09:13.1726966Z          # NOTE: Utiliser ExerciseService ORM directement
2026-02-20T22:09:13.1727164Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1727494Z          try:
2026-02-20T22:09:13.1727686Z              from app.models.exercise import Exercise
2026-02-20T22:09:13.1727794Z +
2026-02-20T22:09:13.1727970Z              exercise = Exercise(**exercise_data)
2026-02-20T22:09:13.1728105Z              db.add(exercise)
2026-02-20T22:09:13.1728227Z              db.commit()
2026-02-20T22:09:13.1728360Z              db.refresh(exercise)
2026-02-20T22:09:13.1728533Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1728668Z @@ -236,139 +247,148 @@
2026-02-20T22:09:13.1729133Z              logger.error(f"Erreur création exercice: {exercise_creation_error}")
2026-02-20T22:09:13.1729277Z              db.rollback()
2026-02-20T22:09:13.1729407Z              return None
2026-02-20T22:09:13.1729517Z          finally:
2026-02-20T22:09:13.1729720Z              EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.1729827Z -    
2026-02-20T22:09:13.1729949Z -    @staticmethod
2026-02-20T22:09:13.1730393Z -    def update_exercise(db: Session, exercise_id: int, exercise_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.1730504Z +
2026-02-20T22:09:13.1730629Z +    @staticmethod
2026-02-20T22:09:13.1730762Z +    def update_exercise(
2026-02-20T22:09:13.1731030Z +        db: Session, exercise_id: int, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.1731147Z +    ) -> bool:
2026-02-20T22:09:13.1731263Z          """
2026-02-20T22:09:13.1731501Z          Met à jour un exercice existant.
2026-02-20T22:09:13.1731606Z -        
2026-02-20T22:09:13.1731712Z +
2026-02-20T22:09:13.1731817Z          Args:
2026-02-20T22:09:13.1732034Z              db: Session de base de données
2026-02-20T22:09:13.1732331Z              exercise_id: ID de l'exercice à mettre à jour
2026-02-20T22:09:13.1732655Z              exercise_data: Nouvelles données de l'exercice
2026-02-20T22:09:13.1732763Z -            
2026-02-20T22:09:13.1732864Z +
2026-02-20T22:09:13.1733170Z          Returns:
2026-02-20T22:09:13.1733501Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.1733613Z          """
2026-02-20T22:09:13.1733963Z          return ExerciseService.update_exercise(db, exercise_id, exercise_data)
2026-02-20T22:09:13.1734078Z -    
2026-02-20T22:09:13.1734181Z +
2026-02-20T22:09:13.1734295Z      @staticmethod
2026-02-20T22:09:13.1734569Z      def archive_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.1734680Z          """
2026-02-20T22:09:13.1735143Z          Archive un exercice (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.1735256Z -        
2026-02-20T22:09:13.1735358Z +
2026-02-20T22:09:13.1735481Z          Args:
2026-02-20T22:09:13.1735717Z              db: Session de base de données
2026-02-20T22:09:13.1736002Z              exercise_id: ID de l'exercice à archiver
2026-02-20T22:09:13.1736113Z -            
2026-02-20T22:09:13.1736216Z +
2026-02-20T22:09:13.1736338Z          Returns:
2026-02-20T22:09:13.1736616Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.1736737Z          """
2026-02-20T22:09:13.1737000Z          return ExerciseService.archive_exercise(db, exercise_id)
2026-02-20T22:09:13.1737115Z -    
2026-02-20T22:09:13.1737225Z -    @staticmethod
2026-02-20T22:09:13.1737655Z -    def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1737767Z +
2026-02-20T22:09:13.1737886Z +    @staticmethod
2026-02-20T22:09:13.1738020Z +    def record_attempt(
2026-02-20T22:09:13.1738191Z +        db: Session, attempt_data: Dict[str, Any]
2026-02-20T22:09:13.1738346Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1738722Z          """
2026-02-20T22:09:13.1739236Z          Enregistre une tentative de résolution d'exercice avec PostgreSQL direct.
2026-02-20T22:09:13.1739363Z -        
2026-02-20T22:09:13.1739466Z +
2026-02-20T22:09:13.1739575Z          Args:
2026-02-20T22:09:13.1740061Z              db: Session de base de données (non utilisée, conservée pour compatibilité)
2026-02-20T22:09:13.1740531Z              attempt_data: Données de la tentative
2026-02-20T22:09:13.1740643Z -            
2026-02-20T22:09:13.1740744Z +
2026-02-20T22:09:13.1740856Z          Returns:
2026-02-20T22:09:13.1741300Z              Un dictionnaire contenant les données de la tentative créée ou None
2026-02-20T22:09:13.1741411Z          """
2026-02-20T22:09:13.1741851Z          # NOTE: attempt_service_translations archivé - utiliser Attempt ORM
2026-02-20T22:09:13.1742031Z          from app.models.attempt import Attempt
2026-02-20T22:09:13.1742142Z -        
2026-02-20T22:09:13.1742245Z +
2026-02-20T22:09:13.1742410Z          attempt = Attempt(**attempt_data)
2026-02-20T22:09:13.1742561Z          db.add(attempt)
2026-02-20T22:09:13.1742681Z          db.commit()
2026-02-20T22:09:13.1742821Z          db.refresh(attempt)
2026-02-20T22:09:13.1742944Z          return attempt
2026-02-20T22:09:13.1773307Z -    
2026-02-20T22:09:13.1773457Z -    @staticmethod
2026-02-20T22:09:13.1773878Z -    def get_user_stats(db: Session, user_id: int, time_range: str = "30") -> Dict[str, Any]:
2026-02-20T22:09:13.1774013Z +
2026-02-20T22:09:13.1774133Z +    @staticmethod
2026-02-20T22:09:13.1774268Z +    def get_user_stats(
2026-02-20T22:09:13.1774476Z +        db: Session, user_id: int, time_range: str = "30"
2026-02-20T22:09:13.1774603Z +    ) -> Dict[str, Any]:
2026-02-20T22:09:13.1774707Z          """
2026-02-20T22:09:13.1775035Z          Récupère les statistiques d'un utilisateur.
2026-02-20T22:09:13.1775151Z -        
2026-02-20T22:09:13.1775255Z +
2026-02-20T22:09:13.1775374Z          Args:
2026-02-20T22:09:13.1775616Z              db: Session de base de données
2026-02-20T22:09:13.1775773Z              user_id: ID de l'utilisateur
2026-02-20T22:09:13.1776122Z              time_range: Période de temps ("7", "30", "90", "all")
2026-02-20T22:09:13.1776244Z -            
2026-02-20T22:09:13.1776347Z +
2026-02-20T22:09:13.1776459Z          Returns:
2026-02-20T22:09:13.1776748Z              Un dictionnaire contenant les statistiques de l'utilisateur
2026-02-20T22:09:13.1776869Z          """
2026-02-20T22:09:13.1777200Z          return UserService.get_user_stats(db, user_id, time_range=time_range)
2026-02-20T22:09:13.1777312Z -    
2026-02-20T22:09:13.1777429Z -    @staticmethod
2026-02-20T22:09:13.1777872Z -    def execute_raw_query(db: Session, query: str, params: dict = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1777979Z +
2026-02-20T22:09:13.1778102Z +    @staticmethod
2026-02-20T22:09:13.1778231Z +    def execute_raw_query(
2026-02-20T22:09:13.1778427Z +        db: Session, query: str, params: dict = None
2026-02-20T22:09:13.1778569Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1778687Z          """
2026-02-20T22:09:13.1779100Z          Exécute une requête SQL brute (paramètres nommés uniquement).
2026-02-20T22:09:13.1779540Z          À utiliser uniquement pour la compatibilité avec le code existant.
2026-02-20T22:09:13.1779876Z          Privilégier les méthodes du service (audit 3.1).
2026-02-20T22:09:13.1780000Z -        
2026-02-20T22:09:13.1780107Z +
2026-02-20T22:09:13.1780225Z          Args:
2026-02-20T22:09:13.1780464Z              db: Session de base de données
2026-02-20T22:09:13.1780827Z              query: Requête SQL avec paramètres nommés (:param_name)
2026-02-20T22:09:13.1781133Z              params: Dictionnaire de paramètres nommés
2026-02-20T22:09:13.1781245Z -            
2026-02-20T22:09:13.1781349Z +
2026-02-20T22:09:13.1781460Z          Returns:
2026-02-20T22:09:13.1781789Z              Liste de dictionnaires contenant les résultats
2026-02-20T22:09:13.1781899Z          """
2026-02-20T22:09:13.1782519Z -        logger.warning("Utilisation de execute_raw_query - À remplacer par les méthodes du service")
2026-02-20T22:09:13.1782907Z +        logger.warning(
2026-02-20T22:09:13.1783610Z +            "Utilisation de execute_raw_query - À remplacer par les méthodes du service"
2026-02-20T22:09:13.1783716Z +        )
2026-02-20T22:09:13.1784006Z          return DatabaseAdapter.execute_query(db, query, params or {})
2026-02-20T22:09:13.1784374Z -    
2026-02-20T22:09:13.1784480Z +
2026-02-20T22:09:13.1784815Z      # === MÉTHODES POUR LOGIC CHALLENGES (NOUVEAU !) ===
2026-02-20T22:09:13.1784933Z -    
2026-02-20T22:09:13.1785040Z +
2026-02-20T22:09:13.1785158Z      @staticmethod
2026-02-20T22:09:13.1785521Z      def get_logic_challenges(limit: Optional[int] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1785638Z          """
2026-02-20T22:09:13.1785941Z          Récupère la liste des logic challenges actifs.
2026-02-20T22:09:13.1786071Z -        
2026-02-20T22:09:13.1786184Z +
2026-02-20T22:09:13.1786294Z          Args:
2026-02-20T22:09:13.1786638Z              limit: Nombre maximum de challenges à retourner
2026-02-20T22:09:13.1786758Z -            
2026-02-20T22:09:13.1786864Z +
2026-02-20T22:09:13.1786978Z          Returns:
2026-02-20T22:09:13.1787409Z              Liste de dictionnaires contenant les données des logic challenges
2026-02-20T22:09:13.1787526Z          """
2026-02-20T22:09:13.1787727Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1787836Z          try:
2026-02-20T22:09:13.1788083Z -            challenges = LogicChallengeService.list_challenges(
2026-02-20T22:09:13.1788195Z -                db, 
2026-02-20T22:09:13.1788319Z -                limit=limit
2026-02-20T22:09:13.1788424Z -            )
2026-02-20T22:09:13.1788535Z -            
2026-02-20T22:09:13.1788861Z +            challenges = LogicChallengeService.list_challenges(db, limit=limit)
2026-02-20T22:09:13.1788964Z +
2026-02-20T22:09:13.1789546Z              # Convertir en dictionnaires - utiliser to_dict() pour éviter les erreurs d'attributs
2026-02-20T22:09:13.1789747Z              return [ch.to_dict() for ch in challenges]
2026-02-20T22:09:13.1789888Z          except Exception as e:
2026-02-20T22:09:13.1790469Z              logger.error(f"Erreur lors de la récupération des logic challenges: {e}")
2026-02-20T22:09:13.1790596Z              return []
2026-02-20T22:09:13.1790709Z          finally:
2026-02-20T22:09:13.1790921Z              EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.1791029Z -    
2026-02-20T22:09:13.1791128Z +
2026-02-20T22:09:13.1791247Z      @staticmethod
2026-02-20T22:09:13.1791582Z      def get_logic_challenge(challenge_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1791689Z          """
2026-02-20T22:09:13.1791959Z          Récupère un logic challenge par son ID.
2026-02-20T22:09:13.1792068Z -        
2026-02-20T22:09:13.1792180Z +
2026-02-20T22:09:13.1792291Z          Args:
2026-02-20T22:09:13.1792441Z              challenge_id: ID du challenge
2026-02-20T22:09:13.1792561Z -            
2026-02-20T22:09:13.1792674Z +
2026-02-20T22:09:13.1792786Z          Returns:
2026-02-20T22:09:13.1793366Z              Un dictionnaire contenant les données du challenge ou None
2026-02-20T22:09:13.1793496Z          """
2026-02-20T22:09:13.1793685Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1793793Z          try:
2026-02-20T22:09:13.1794126Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.1794253Z              if challenge:
2026-02-20T22:09:13.1794409Z                  return challenge.to_dict()
2026-02-20T22:09:13.1794533Z              return None
2026-02-20T22:09:13.1794677Z          except Exception as e:
2026-02-20T22:09:13.1795253Z -            logger.error(f"Erreur lors de la récupération du logic challenge {challenge_id}: {e}")
2026-02-20T22:09:13.1795386Z +            logger.error(
2026-02-20T22:09:13.1795864Z +                f"Erreur lors de la récupération du logic challenge {challenge_id}: {e}"
2026-02-20T22:09:13.1795976Z +            )
2026-02-20T22:09:13.1796326Z              return None
2026-02-20T22:09:13.1796452Z          finally:
2026-02-20T22:09:13.1796673Z -            EnhancedServerAdapter.close_db_session(db) 
2026-02-20T22:09:13.1796809Z \ No newline at end of file
2026-02-20T22:09:13.1797013Z +            EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.2604161Z --- /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.2609102Z would reformat /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py
2026-02-20T22:09:13.2611724Z +++ /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py	2026-02-20 22:09:13.256723+00:00
2026-02-20T22:09:13.2614089Z @@ -1,235 +1,277 @@
2026-02-20T22:09:13.2615607Z  """
2026-02-20T22:09:13.2617782Z  Service pour la gestion des défis de logique mathématique (Épreuves du Conseil Jedi).
2026-02-20T22:09:13.2620237Z  Implémente les opérations métier liées aux défis logiques et utilise le transaction manager.
2026-02-20T22:09:13.2622204Z  """
2026-02-20T22:09:13.2624105Z +
2026-02-20T22:09:13.2624714Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:13.2625198Z  
2026-02-20T22:09:13.2625559Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.2626031Z  
2026-02-20T22:09:13.2626355Z  logger = get_logger(__name__)
2026-02-20T22:09:13.2626774Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.2627170Z  
2026-02-20T22:09:13.2627493Z  from app.db.adapter import DatabaseAdapter
2026-02-20T22:09:13.2628058Z  from app.db.transaction import TransactionManager
2026-02-20T22:09:13.2628981Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:13.2629648Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:13.2647968Z -                                        LogicChallengeType)
2026-02-20T22:09:13.2654945Z +from app.models.logic_challenge import (
2026-02-20T22:09:13.2656600Z +    AgeGroup,
2026-02-20T22:09:13.2661298Z +    LogicChallenge,
2026-02-20T22:09:13.2694717Z +    LogicChallengeAttempt,
2026-02-20T22:09:13.2695459Z +    LogicChallengeType,
2026-02-20T22:09:13.2699692Z +)
2026-02-20T22:09:13.2700529Z  from app.utils.db_helpers import adapt_enum_for_db, get_enum_value
2026-02-20T22:09:13.2701338Z  
2026-02-20T22:09:13.2701637Z  
2026-02-20T22:09:13.2701927Z  class LogicChallengeService:
2026-02-20T22:09:13.2702758Z      """
2026-02-20T22:09:13.2703512Z      Service pour la gestion des défis de logique mathématique.
2026-02-20T22:09:13.2704405Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des défis.
2026-02-20T22:09:13.2705024Z      """
2026-02-20T22:09:13.2705275Z -    
2026-02-20T22:09:13.2705515Z +
2026-02-20T22:09:13.2705763Z      @staticmethod
2026-02-20T22:09:13.2706288Z      def get_challenge(db: Session, challenge_id: int) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2706917Z          """
2026-02-20T22:09:13.2707343Z          Récupère un défi par son ID.
2026-02-20T22:09:13.2707778Z -        
2026-02-20T22:09:13.2708035Z +
2026-02-20T22:09:13.2708294Z          Args:
2026-02-20T22:09:13.2708728Z              db: Session de base de données
2026-02-20T22:09:13.2709309Z              challenge_id: ID du défi à récupérer
2026-02-20T22:09:13.2709755Z -            
2026-02-20T22:09:13.2710027Z +
2026-02-20T22:09:13.2710306Z          Returns:
2026-02-20T22:09:13.2710836Z              Le défi correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.2711352Z          """
2026-02-20T22:09:13.2711832Z          return DatabaseAdapter.get_by_id(db, LogicChallenge, challenge_id)
2026-02-20T22:09:13.2712450Z -    
2026-02-20T22:09:13.2712703Z +
2026-02-20T22:09:13.2713167Z      @staticmethod
2026-02-20T22:09:13.2713511Z      def list_challenges(
2026-02-20T22:09:13.2713859Z -        db: Session, 
2026-02-20T22:09:13.2714184Z +        db: Session,
2026-02-20T22:09:13.2714547Z          challenge_type: Optional[str] = None,
2026-02-20T22:09:13.2715028Z          age_group: Optional[str] = None,
2026-02-20T22:09:13.2715923Z          limit: Optional[int] = None,
2026-02-20T22:09:13.2716356Z -        offset: Optional[int] = None
2026-02-20T22:09:13.2716788Z +        offset: Optional[int] = None,
2026-02-20T22:09:13.2717272Z      ) -> List[LogicChallenge]:
2026-02-20T22:09:13.2717646Z          """
2026-02-20T22:09:13.2718397Z          Liste les défis actifs avec filtrage optionnel.
2026-02-20T22:09:13.2718883Z -        
2026-02-20T22:09:13.2719147Z +
2026-02-20T22:09:13.2719457Z          Args:
2026-02-20T22:09:13.2719859Z              db: Session de base de données
2026-02-20T22:09:13.2720517Z              challenge_type: Type de défi à filtrer (optionnel)
2026-02-20T22:09:13.2721212Z              age_group: Groupe d'âge à filtrer (optionnel)
2026-02-20T22:09:13.2721876Z              limit: Nombre maximum de défis à retourner
2026-02-20T22:09:13.2722498Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.2722937Z -            
2026-02-20T22:09:13.2744555Z +
2026-02-20T22:09:13.2744819Z          Returns:
2026-02-20T22:09:13.2745377Z              Liste des défis correspondants aux critères
2026-02-20T22:09:13.2745861Z          """
2026-02-20T22:09:13.2746147Z          try:
2026-02-20T22:09:13.2746686Z              query = db.query(LogicChallenge).filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:13.2747378Z -            
2026-02-20T22:09:13.2747657Z +
2026-02-20T22:09:13.2747939Z              if challenge_type:
2026-02-20T22:09:13.2748661Z                  # Adapter le type de défi pour le moteur de base de données actuel
2026-02-20T22:09:13.2749542Z -                adapted_type = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2750657Z -                logger.debug(f"Type de défi adapté: de '{challenge_type}' à '{adapted_type}'")
2026-02-20T22:09:13.2751386Z +                adapted_type = adapt_enum_for_db(
2026-02-20T22:09:13.2751934Z +                    "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2752421Z +                )
2026-02-20T22:09:13.2752743Z +                logger.debug(
2026-02-20T22:09:13.2753644Z +                    f"Type de défi adapté: de '{challenge_type}' à '{adapted_type}'"
2026-02-20T22:09:13.2754228Z +                )
2026-02-20T22:09:13.2754748Z                  query = query.filter(LogicChallenge.challenge_type == adapted_type)
2026-02-20T22:09:13.2755391Z -            
2026-02-20T22:09:13.2755670Z +
2026-02-20T22:09:13.2755934Z              if age_group:
2026-02-20T22:09:13.2756618Z                  # Adapter le groupe d'âge pour le moteur de base de données actuel
2026-02-20T22:09:13.2757346Z                  adapted_age = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2758147Z                  logger.debug(f"Groupe d'âge adapté: de '{age_group}' à '{adapted_age}'")
2026-02-20T22:09:13.2758868Z                  query = query.filter(LogicChallenge.age_group == adapted_age)
2026-02-20T22:09:13.2759367Z -            
2026-02-20T22:09:13.2759624Z +
2026-02-20T22:09:13.2759878Z              if offset is not None:
2026-02-20T22:09:13.2760244Z                  query = query.offset(offset)
2026-02-20T22:09:13.2760591Z -            
2026-02-20T22:09:13.2760830Z +
2026-02-20T22:09:13.2761058Z              if limit is not None:
2026-02-20T22:09:13.2761423Z                  query = query.limit(limit)
2026-02-20T22:09:13.2761799Z -            
2026-02-20T22:09:13.2762045Z +
2026-02-20T22:09:13.2762307Z              return query.all()
2026-02-20T22:09:13.2762721Z          except Exception as challenges_fetch_error:
2026-02-20T22:09:13.2763731Z -            logger.error(f"Erreur lors de la récupération des défis: {challenges_fetch_error}")
2026-02-20T22:09:13.2764415Z +            logger.error(
2026-02-20T22:09:13.2765067Z +                f"Erreur lors de la récupération des défis: {challenges_fetch_error}"
2026-02-20T22:09:13.2765638Z +            )
2026-02-20T22:09:13.2765903Z              return []
2026-02-20T22:09:13.2766178Z -    
2026-02-20T22:09:13.2766702Z -    @staticmethod
2026-02-20T22:09:13.2767227Z -    def create_challenge(db: Session, challenge_data: Dict[str, Any]) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2767951Z +
2026-02-20T22:09:13.2768225Z +    @staticmethod
2026-02-20T22:09:13.2768539Z +    def create_challenge(
2026-02-20T22:09:13.2768961Z +        db: Session, challenge_data: Dict[str, Any]
2026-02-20T22:09:13.2769708Z +    ) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2770119Z          """
2026-02-20T22:09:13.2770523Z          Crée un nouveau défi.
2026-02-20T22:09:13.2770886Z -        
2026-02-20T22:09:13.2771151Z +
2026-02-20T22:09:13.2771393Z          Args:
2026-02-20T22:09:13.2771805Z              db: Session de base de données
2026-02-20T22:09:13.2772503Z              challenge_data: Dictionnaire contenant les données du défi
2026-02-20T22:09:13.2773276Z -            
2026-02-20T22:09:13.2773551Z +
2026-02-20T22:09:13.2773813Z          Returns:
2026-02-20T22:09:13.2774267Z              Le défi créé ou None en cas d'erreur
2026-02-20T22:09:13.2774729Z          """
2026-02-20T22:09:13.2775328Z          # Adapter les valeurs d'enum pour le moteur de base de données actuel
2026-02-20T22:09:13.2776010Z          if "challenge_type" in challenge_data:
2026-02-20T22:09:13.2776575Z              challenge_type = challenge_data["challenge_type"]
2026-02-20T22:09:13.2777451Z -            challenge_data["challenge_type"] = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2778791Z -            logger.debug(f"Type de défi adapté: de '{challenge_type}' à '{challenge_data['challenge_type']}'")
2026-02-20T22:09:13.2779553Z -        
2026-02-20T22:09:13.2779959Z +            challenge_data["challenge_type"] = adapt_enum_for_db(
2026-02-20T22:09:13.2780569Z +                "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2781039Z +            )
2026-02-20T22:09:13.2781348Z +            logger.debug(
2026-02-20T22:09:13.2782127Z +                f"Type de défi adapté: de '{challenge_type}' à '{challenge_data['challenge_type']}'"
2026-02-20T22:09:13.2782845Z +            )
2026-02-20T22:09:13.2783300Z +
2026-02-20T22:09:13.2783608Z          if "age_group" in challenge_data:
2026-02-20T22:09:13.2784090Z              age_group = challenge_data["age_group"]
2026-02-20T22:09:13.2784791Z              challenge_data["age_group"] = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2785937Z -            logger.debug(f"Groupe d'âge adapté: de '{age_group}' à '{challenge_data['age_group']}'")
2026-02-20T22:09:13.2786683Z -        
2026-02-20T22:09:13.2786968Z +            logger.debug(
2026-02-20T22:09:13.2787680Z +                f"Groupe d'âge adapté: de '{age_group}' à '{challenge_data['age_group']}'"
2026-02-20T22:09:13.2788308Z +            )
2026-02-20T22:09:13.2788596Z +
2026-02-20T22:09:13.2789255Z          # Définir explicitement created_at si non présent pour éviter les valeurs NULL
2026-02-20T22:09:13.2789988Z          from datetime import datetime, timezone
2026-02-20T22:09:13.2790778Z -        if "created_at" not in challenge_data or challenge_data.get("created_at") is None:
2026-02-20T22:09:13.2791467Z +
2026-02-20T22:09:13.2791719Z +        if (
2026-02-20T22:09:13.2792046Z +            "created_at" not in challenge_data
2026-02-20T22:09:13.2792567Z +            or challenge_data.get("created_at") is None
2026-02-20T22:09:13.2793205Z +        ):
2026-02-20T22:09:13.2793665Z              challenge_data["created_at"] = datetime.now(timezone.utc)
2026-02-20T22:09:13.2794214Z -        
2026-02-20T22:09:13.2794471Z +
2026-02-20T22:09:13.2794931Z          return DatabaseAdapter.create(db, LogicChallenge, challenge_data)
2026-02-20T22:09:13.2795529Z -    
2026-02-20T22:09:13.2795807Z -    @staticmethod
2026-02-20T22:09:13.2796446Z -    def update_challenge(db: Session, challenge_id: int, challenge_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.2797189Z +
2026-02-20T22:09:13.2797448Z +    @staticmethod
2026-02-20T22:09:13.2797772Z +    def update_challenge(
2026-02-20T22:09:13.2798278Z +        db: Session, challenge_id: int, challenge_data: Dict[str, Any]
2026-02-20T22:09:13.2799091Z +    ) -> bool:
2026-02-20T22:09:13.2799390Z          """
2026-02-20T22:09:13.2799807Z          Met à jour un défi existant.
2026-02-20T22:09:13.2800217Z -        
2026-02-20T22:09:13.2800469Z +
2026-02-20T22:09:13.2800724Z          Args:
2026-02-20T22:09:13.2801130Z              db: Session de base de données
2026-02-20T22:09:13.2801956Z              challenge_id: ID du défi à mettre à jour
2026-02-20T22:09:13.2802597Z              challenge_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.2803355Z -            
2026-02-20T22:09:13.2803640Z +
2026-02-20T22:09:13.2803890Z          Returns:
2026-02-20T22:09:13.2804387Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.2804854Z          """
2026-02-20T22:09:13.2805346Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2805962Z          if not challenge:
2026-02-20T22:09:13.2806677Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.2807339Z              return False
2026-02-20T22:09:13.2807678Z -        
2026-02-20T22:09:13.2807944Z +
2026-02-20T22:09:13.2808516Z          # Adapter les valeurs d'enum pour le moteur de base de données actuel
2026-02-20T22:09:13.2809189Z          if "challenge_type" in challenge_data:
2026-02-20T22:09:13.2809764Z              challenge_type = challenge_data["challenge_type"]
2026-02-20T22:09:13.2810617Z -            challenge_data["challenge_type"] = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2812064Z -            logger.debug(f"Type de défi adapté pour mise à jour: de '{challenge_type}' à '{challenge_data['challenge_type']}'")
2026-02-20T22:09:13.2812946Z -        
2026-02-20T22:09:13.2813557Z +            challenge_data["challenge_type"] = adapt_enum_for_db(
2026-02-20T22:09:13.2814166Z +                "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2814647Z +            )
2026-02-20T22:09:13.2814942Z +            logger.debug(
2026-02-20T22:09:13.2815869Z +                f"Type de défi adapté pour mise à jour: de '{challenge_type}' à '{challenge_data['challenge_type']}'"
2026-02-20T22:09:13.2816636Z +            )
2026-02-20T22:09:13.2816931Z +
2026-02-20T22:09:13.2817266Z          if "age_group" in challenge_data:
2026-02-20T22:09:13.2817770Z              age_group = challenge_data["age_group"]
2026-02-20T22:09:13.2818455Z              challenge_data["age_group"] = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2819676Z -            logger.debug(f"Groupe d'âge adapté pour mise à jour: de '{age_group}' à '{challenge_data['age_group']}'")
2026-02-20T22:09:13.2820500Z -        
2026-02-20T22:09:13.2820784Z +            logger.debug(
2026-02-20T22:09:13.2821613Z +                f"Groupe d'âge adapté pour mise à jour: de '{age_group}' à '{challenge_data['age_group']}'"
2026-02-20T22:09:13.2822341Z +            )
2026-02-20T22:09:13.2822638Z +
2026-02-20T22:09:13.2823258Z          return DatabaseAdapter.update(db, challenge, challenge_data)
2026-02-20T22:09:13.2823842Z -    
2026-02-20T22:09:13.2824103Z +
2026-02-20T22:09:13.2824354Z      @staticmethod
2026-02-20T22:09:13.2824821Z      def archive_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:13.2825364Z          """
2026-02-20T22:09:13.2825987Z          Archive un défi (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.2826609Z -        
2026-02-20T22:09:13.2826872Z +
2026-02-20T22:09:13.2827117Z          Args:
2026-02-20T22:09:13.2827522Z              db: Session de base de données
2026-02-20T22:09:13.2828074Z              challenge_id: ID du défi à archiver
2026-02-20T22:09:13.2828497Z -            
2026-02-20T22:09:13.2828779Z +
2026-02-20T22:09:13.2829024Z          Returns:
2026-02-20T22:09:13.2829491Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.2829945Z          """
2026-02-20T22:09:13.2830439Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2831301Z          if not challenge:
2026-02-20T22:09:13.2832003Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour archivage")
2026-02-20T22:09:13.2832637Z              return False
2026-02-20T22:09:13.2833137Z -        
2026-02-20T22:09:13.2833410Z +
2026-02-20T22:09:13.2833975Z          return DatabaseAdapter.archive(db, challenge)
2026-02-20T22:09:13.2834454Z -    
2026-02-20T22:09:13.2834705Z +
2026-02-20T22:09:13.2834962Z      @staticmethod
2026-02-20T22:09:13.2835423Z      def delete_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:13.2835978Z          """
2026-02-20T22:09:13.2836502Z          Supprime physiquement un défi de la base de données.
2026-02-20T22:09:13.2837242Z          Les tentatives associées sont supprimées en cascade.
2026-02-20T22:09:13.2837745Z -        
2026-02-20T22:09:13.2838003Z +
2026-02-20T22:09:13.2838254Z          Args:
2026-02-20T22:09:13.2838666Z              db: Session de base de données
2026-02-20T22:09:13.2839245Z              challenge_id: ID du défi à supprimer
2026-02-20T22:09:13.2839683Z -            
2026-02-20T22:09:13.2839978Z +
2026-02-20T22:09:13.2840224Z          Returns:
2026-02-20T22:09:13.2840710Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.2841182Z          """
2026-02-20T22:09:13.2841679Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2842304Z          if not challenge:
2026-02-20T22:09:13.2843189Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour suppression")
2026-02-20T22:09:13.2843856Z              return False
2026-02-20T22:09:13.2844177Z -        
2026-02-20T22:09:13.2844446Z +
2026-02-20T22:09:13.2844775Z          return DatabaseAdapter.delete(db, challenge)
2026-02-20T22:09:13.2845252Z -    
2026-02-20T22:09:13.2845518Z -    @staticmethod
2026-02-20T22:09:13.2846161Z -    def get_challenge_attempts(db: Session, challenge_id: int) -> List[LogicChallengeAttempt]:
2026-02-20T22:09:13.2846919Z +
2026-02-20T22:09:13.2847173Z +    @staticmethod
2026-02-20T22:09:13.2847497Z +    def get_challenge_attempts(
2026-02-20T22:09:13.2847909Z +        db: Session, challenge_id: int
2026-02-20T22:09:13.2848366Z +    ) -> List[LogicChallengeAttempt]:
2026-02-20T22:09:13.2848773Z          """
2026-02-20T22:09:13.2849303Z          Récupère toutes les tentatives associées à un défi.
2026-02-20T22:09:13.2849803Z -        
2026-02-20T22:09:13.2850063Z +
2026-02-20T22:09:13.2850311Z          Args:
2026-02-20T22:09:13.2850715Z              db: Session de base de données
2026-02-20T22:09:13.2851248Z              challenge_id: ID du défi
2026-02-20T22:09:13.2851634Z -            
2026-02-20T22:09:13.2851915Z +
2026-02-20T22:09:13.2852165Z          Returns:
2026-02-20T22:09:13.2852602Z              Liste des tentatives pour ce défi
2026-02-20T22:09:13.2853193Z          """
2026-02-20T22:09:13.2853851Z -        return DatabaseAdapter.get_by_field(db, LogicChallengeAttempt, "challenge_id", challenge_id)
2026-02-20T22:09:13.2854650Z -    
2026-02-20T22:09:13.2854927Z -    @staticmethod
2026-02-20T22:09:13.2855592Z -    def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[LogicChallengeAttempt]:
2026-02-20T22:09:13.2856411Z +        return DatabaseAdapter.get_by_field(
2026-02-20T22:09:13.2856992Z +            db, LogicChallengeAttempt, "challenge_id", challenge_id
2026-02-20T22:09:13.2857532Z +        )
2026-02-20T22:09:13.2857800Z +
2026-02-20T22:09:13.2858052Z +    @staticmethod
2026-02-20T22:09:13.2858374Z +    def record_attempt(
2026-02-20T22:09:13.2858772Z +        db: Session, attempt_data: Dict[str, Any]
2026-02-20T22:09:13.2859280Z +    ) -> Optional[LogicChallengeAttempt]:
2026-02-20T22:09:13.2859704Z          """
2026-02-20T22:09:13.2860213Z          Enregistre une nouvelle tentative pour un défi.
2026-02-20T22:09:13.2860713Z -        
2026-02-20T22:09:13.2860969Z +
2026-02-20T22:09:13.2861225Z          Args:
2026-02-20T22:09:13.2861632Z              db: Session de base de données
2026-02-20T22:09:13.2862629Z              attempt_data: Dictionnaire contenant les données de la tentative
2026-02-20T22:09:13.2863428Z -            
2026-02-20T22:09:13.2863720Z +
2026-02-20T22:09:13.2863968Z          Returns:
2026-02-20T22:09:13.2864444Z              La tentative créée ou None en cas d'erreur
2026-02-20T22:09:13.2865115Z          """
2026-02-20T22:09:13.2865524Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:13.2866032Z              try:
2026-02-20T22:09:13.2866458Z                  # Vérifier que le défi existe
2026-02-20T22:09:13.2867000Z                  challenge_id = attempt_data.get("challenge_id")
2026-02-20T22:09:13.2867739Z                  challenge = LogicChallengeService.get_challenge(session, challenge_id)
2026-02-20T22:09:13.2868403Z -                
2026-02-20T22:09:13.2868693Z +
2026-02-20T22:09:13.2868964Z                  if not challenge:
2026-02-20T22:09:13.2869995Z -                    logger.error(f"Tentative d'enregistrement d'une tentative pour un défi inexistant (ID {challenge_id})")
2026-02-20T22:09:13.2870930Z +                    logger.error(
2026-02-20T22:09:13.2871861Z +                        f"Tentative d'enregistrement d'une tentative pour un défi inexistant (ID {challenge_id})"
2026-02-20T22:09:13.2872651Z +                    )
2026-02-20T22:09:13.2873160Z                      return None
2026-02-20T22:09:13.2873517Z -                
2026-02-20T22:09:13.2873804Z +
2026-02-20T22:09:13.2874159Z                  # Créer la tentative
2026-02-20T22:09:13.2874669Z                  attempt = LogicChallengeAttempt(**attempt_data)
2026-02-20T22:09:13.2875207Z                  session.add(attempt)
2026-02-20T22:09:13.2875618Z                  session.flush()
2026-02-20T22:09:13.2875983Z -                
2026-02-20T22:09:13.2876266Z +
2026-02-20T22:09:13.2876533Z                  # Log de l'action
2026-02-20T22:09:13.2877018Z                  is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.2878223Z -                logger.info(f"Tentative enregistrée pour le défi {challenge_id}: {'Correcte' if is_correct else 'Incorrecte'}")
2026-02-20T22:09:13.2879117Z -                
2026-02-20T22:09:13.2879429Z +                logger.info(
2026-02-20T22:09:13.2880381Z +                    f"Tentative enregistrée pour le défi {challenge_id}: {'Correcte' if is_correct else 'Incorrecte'}"
2026-02-20T22:09:13.2881207Z +                )
2026-02-20T22:09:13.2881499Z +
2026-02-20T22:09:13.2881758Z                  return attempt
2026-02-20T22:09:13.2882195Z              except Exception as attempt_save_error:
2026-02-20T22:09:13.2883147Z -                logger.error(f"Erreur lors de l'enregistrement de la tentative: {attempt_save_error}")
2026-02-20T22:09:13.2883919Z -                return None 
2026-02-20T22:09:13.2884297Z \ No newline at end of file
2026-02-20T22:09:13.2884674Z +                logger.error(
2026-02-20T22:09:13.2885270Z +                    f"Erreur lors de l'enregistrement de la tentative: {attempt_save_error}"
2026-02-20T22:09:13.2885934Z +                )
2026-02-20T22:09:13.2886251Z +                return None
2026-02-20T22:09:13.3411809Z --- /home/runner/work/mathakine/mathakine/app/services/streak_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3413578Z +++ /home/runner/work/mathakine/mathakine/app/services/streak_service.py	2026-02-20 22:09:13.339927+00:00
2026-02-20T22:09:13.3415826Z @@ -1,10 +1,11 @@
2026-02-20T22:09:13.3417244Z  """
2026-02-20T22:09:13.3418898Z would reformat /home/runner/work/mathakine/mathakine/app/services/streak_service.py
2026-02-20T22:09:13.3419985Z  Service de calcul de la série d'entraînement (streak).
2026-02-20T22:09:13.3420474Z  
2026-02-20T22:09:13.3421740Z  Jours consécutifs avec au moins une activité (exercice ou défi).
2026-02-20T22:09:13.3423577Z  """
2026-02-20T22:09:13.3423837Z +
2026-02-20T22:09:13.3424238Z  from datetime import date, datetime, timedelta, timezone
2026-02-20T22:09:13.3424781Z  
2026-02-20T22:09:13.3425550Z  from sqlalchemy import func
2026-02-20T22:09:13.3425973Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.3426359Z  
2026-02-20T22:09:13.3426613Z @@ -19,20 +20,26 @@
2026-02-20T22:09:13.3427095Z  def _activity_dates_for_user(db: Session, user_id: int) -> set[date]:
2026-02-20T22:09:13.3428095Z      """Retourne l'ensemble des dates (UTC) où l'utilisateur a eu une activité."""
2026-02-20T22:09:13.3428974Z      dates = set()
2026-02-20T22:09:13.3429260Z  
2026-02-20T22:09:13.3429546Z      # Dates des tentatives exercices
2026-02-20T22:09:13.3430068Z -    for (d,) in db.query(func.date(Attempt.created_at)).filter(
2026-02-20T22:09:13.3430657Z -        Attempt.user_id == user_id
2026-02-20T22:09:13.3431053Z -    ).distinct().all():
2026-02-20T22:09:13.3431385Z +    for (d,) in (
2026-02-20T22:09:13.3431744Z +        db.query(func.date(Attempt.created_at))
2026-02-20T22:09:13.3432222Z +        .filter(Attempt.user_id == user_id)
2026-02-20T22:09:13.3432644Z +        .distinct()
2026-02-20T22:09:13.3433158Z +        .all()
2026-02-20T22:09:13.3433448Z +    ):
2026-02-20T22:09:13.3433695Z          if d:
2026-02-20T22:09:13.3433989Z              dates.add(d)
2026-02-20T22:09:13.3434311Z  
2026-02-20T22:09:13.3434678Z      # Dates des tentatives défis
2026-02-20T22:09:13.3435259Z -    for (d,) in db.query(func.date(LogicChallengeAttempt.created_at)).filter(
2026-02-20T22:09:13.3435902Z -        LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:13.3436319Z -    ).distinct().all():
2026-02-20T22:09:13.3436611Z +    for (d,) in (
2026-02-20T22:09:13.3436993Z +        db.query(func.date(LogicChallengeAttempt.created_at))
2026-02-20T22:09:13.3437526Z +        .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:13.3437949Z +        .distinct()
2026-02-20T22:09:13.3438206Z +        .all()
2026-02-20T22:09:13.3438460Z +    ):
2026-02-20T22:09:13.3438703Z          if d:
2026-02-20T22:09:13.3438982Z              dates.add(d)
2026-02-20T22:09:13.3439298Z  
2026-02-20T22:09:13.3439537Z      return dates
2026-02-20T22:09:13.3439827Z  
2026-02-20T22:09:13.3440061Z @@ -69,9 +76,11 @@
2026-02-20T22:09:13.3440384Z      prev_best = user.best_streak or 0
2026-02-20T22:09:13.3440802Z      best = max(prev_best, current)
2026-02-20T22:09:13.3441167Z  
2026-02-20T22:09:13.3441445Z      user.current_streak = current
2026-02-20T22:09:13.3441831Z      user.best_streak = best
2026-02-20T22:09:13.3442492Z -    user.last_activity_date = today if today in activity_dates else user.last_activity_date
2026-02-20T22:09:13.3443454Z +    user.last_activity_date = (
2026-02-20T22:09:13.3444016Z +        today if today in activity_dates else user.last_activity_date
2026-02-20T22:09:13.3444566Z +    )
2026-02-20T22:09:13.3444840Z      db.commit()
2026-02-20T22:09:13.3445123Z  
2026-02-20T22:09:13.3445404Z      return (current, best)
2026-02-20T22:09:13.3478228Z would reformat /home/runner/work/mathakine/mathakine/app/services/exercise_service.py
2026-02-20T22:09:13.3479369Z --- /home/runner/work/mathakine/mathakine/app/services/exercise_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3480831Z +++ /home/runner/work/mathakine/mathakine/app/services/exercise_service.py	2026-02-20 22:09:13.339050+00:00
2026-02-20T22:09:13.3481690Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.3481990Z  """
2026-02-20T22:09:13.3482526Z  Service pour la gestion des exercices mathématiques.
2026-02-20T22:09:13.3483681Z  Implémente les opérations métier liées aux exercices et utilise le transaction manager.
2026-02-20T22:09:13.3484391Z  """
2026-02-20T22:09:13.3484652Z +
2026-02-20T22:09:13.3485014Z  from typing import Any, Dict, List, Optional, Union
2026-02-20T22:09:13.3485495Z  
2026-02-20T22:09:13.3485845Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.3486291Z  
2026-02-20T22:09:13.3486576Z  logger = get_logger(__name__)
2026-02-20T22:09:13.3486944Z @@ -19,52 +20,56 @@
2026-02-20T22:09:13.3487278Z  class ExerciseService:
2026-02-20T22:09:13.3487602Z      """
2026-02-20T22:09:13.3488118Z      Service pour la gestion des exercices mathématiques.
2026-02-20T22:09:13.3489331Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des exercices.
2026-02-20T22:09:13.3490035Z      """
2026-02-20T22:09:13.3490298Z -    
2026-02-20T22:09:13.3490559Z +
2026-02-20T22:09:13.3490789Z      @staticmethod
2026-02-20T22:09:13.3491229Z      def get_exercise(db: Session, exercise_id: int) -> Optional[Exercise]:
2026-02-20T22:09:13.3492026Z          """
2026-02-20T22:09:13.3523607Z          Récupère un exercice par son ID.
2026-02-20T22:09:13.3524089Z -        
2026-02-20T22:09:13.3524367Z +
2026-02-20T22:09:13.3524852Z          IMPORTANT: Utilise cast() pour charger les enums en tant que strings
2026-02-20T22:09:13.3525912Z          pour éviter les erreurs LookupError avec les valeurs en minuscules dans la DB.
2026-02-20T22:09:13.3526611Z -        
2026-02-20T22:09:13.3526883Z +
2026-02-20T22:09:13.3527132Z          Args:
2026-02-20T22:09:13.3527588Z              db: Session de base de données
2026-02-20T22:09:13.3528179Z              exercise_id: ID de l'exercice à récupérer
2026-02-20T22:09:13.3528669Z -            
2026-02-20T22:09:13.3528945Z +
2026-02-20T22:09:13.3529203Z          Returns:
2026-02-20T22:09:13.3529765Z              L'exercice correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.3530323Z          """
2026-02-20T22:09:13.3530595Z          try:
2026-02-20T22:09:13.3530954Z              from sqlalchemy import String, cast
2026-02-20T22:09:13.3531385Z  
2026-02-20T22:09:13.3532034Z              # Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:13.3532737Z -            exercise_row = db.query(
2026-02-20T22:09:13.3533354Z -                Exercise.id,
2026-02-20T22:09:13.3533754Z -                Exercise.title,
2026-02-20T22:09:13.3534156Z -                Exercise.question,
2026-02-20T22:09:13.3534590Z -                Exercise.correct_answer,
2026-02-20T22:09:13.3535031Z -                Exercise.choices,
2026-02-20T22:09:13.3535438Z -                Exercise.explanation,
2026-02-20T22:09:13.3535903Z -                Exercise.hint,
2026-02-20T22:09:13.3536278Z -                Exercise.tags,
2026-02-20T22:09:13.3536665Z -                Exercise.ai_generated,
2026-02-20T22:09:13.3537080Z -                Exercise.is_active,
2026-02-20T22:09:13.3537500Z -                Exercise.is_archived,
2026-02-20T22:09:13.3537918Z -                Exercise.view_count,
2026-02-20T22:09:13.3538336Z -                Exercise.created_at,
2026-02-20T22:09:13.3538743Z -                Exercise.updated_at,
2026-02-20T22:09:13.3539355Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:13.3540132Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:13.3540769Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:13.3541241Z -            
2026-02-20T22:09:13.3541546Z +            exercise_row = (
2026-02-20T22:09:13.3541913Z +                db.query(
2026-02-20T22:09:13.3542519Z +                    Exercise.id,
2026-02-20T22:09:13.3542918Z +                    Exercise.title,
2026-02-20T22:09:13.3543491Z +                    Exercise.question,
2026-02-20T22:09:13.3543926Z +                    Exercise.correct_answer,
2026-02-20T22:09:13.3544384Z +                    Exercise.choices,
2026-02-20T22:09:13.3544817Z +                    Exercise.explanation,
2026-02-20T22:09:13.3545268Z +                    Exercise.hint,
2026-02-20T22:09:13.3545667Z +                    Exercise.tags,
2026-02-20T22:09:13.3546082Z +                    Exercise.ai_generated,
2026-02-20T22:09:13.3546518Z +                    Exercise.is_active,
2026-02-20T22:09:13.3546952Z +                    Exercise.is_archived,
2026-02-20T22:09:13.3547385Z +                    Exercise.view_count,
2026-02-20T22:09:13.3547826Z +                    Exercise.created_at,
2026-02-20T22:09:13.3548272Z +                    Exercise.updated_at,
2026-02-20T22:09:13.3548881Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:13.3549690Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:13.3550261Z +                )
2026-02-20T22:09:13.3550621Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:13.3551076Z +                .first()
2026-02-20T22:09:13.3551629Z +            )
2026-02-20T22:09:13.3551902Z +
2026-02-20T22:09:13.3552168Z              if not exercise_row:
2026-02-20T22:09:13.3552561Z                  return None
2026-02-20T22:09:13.3552895Z -            
2026-02-20T22:09:13.3553360Z +
2026-02-20T22:09:13.3553771Z              # Créer un objet Exercise avec les valeurs normalisées
2026-02-20T22:09:13.3553916Z              exercise = Exercise()
2026-02-20T22:09:13.3554075Z              exercise.id = exercise_row.id
2026-02-20T22:09:13.3554245Z              exercise.title = exercise_row.title
2026-02-20T22:09:13.3554434Z              exercise.question = exercise_row.question
2026-02-20T22:09:13.3554565Z @@ -77,330 +82,397 @@
2026-02-20T22:09:13.3554773Z              exercise.is_active = exercise_row.is_active
2026-02-20T22:09:13.3554984Z              exercise.is_archived = exercise_row.is_archived
2026-02-20T22:09:13.3555192Z              exercise.view_count = exercise_row.view_count
2026-02-20T22:09:13.3555408Z              exercise.created_at = exercise_row.created_at
2026-02-20T22:09:13.3555625Z              exercise.updated_at = exercise_row.updated_at
2026-02-20T22:09:13.3555735Z -            
2026-02-20T22:09:13.3555848Z +
2026-02-20T22:09:13.3556254Z              # Convertir les strings normalisées en enums (en majuscules)
2026-02-20T22:09:13.3556560Z              from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:13.3557202Z -            exercise_type_normalized = exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION"
2026-02-20T22:09:13.3557797Z -            difficulty_normalized = exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN"
2026-02-20T22:09:13.3557918Z -            
2026-02-20T22:09:13.3558021Z +
2026-02-20T22:09:13.3558187Z +            exercise_type_normalized = (
2026-02-20T22:09:13.3558383Z +                exercise_row.exercise_type_str.upper()
2026-02-20T22:09:13.3558559Z +                if exercise_row.exercise_type_str
2026-02-20T22:09:13.3558710Z +                else "ADDITION"
2026-02-20T22:09:13.3558820Z +            )
2026-02-20T22:09:13.3558969Z +            difficulty_normalized = (
2026-02-20T22:09:13.3559145Z +                exercise_row.difficulty_str.upper()
2026-02-20T22:09:13.3559317Z +                if exercise_row.difficulty_str
2026-02-20T22:09:13.3559448Z +                else "PADAWAN"
2026-02-20T22:09:13.3559555Z +            )
2026-02-20T22:09:13.3559662Z +
2026-02-20T22:09:13.3559766Z              try:
2026-02-20T22:09:13.3560089Z                  exercise.exercise_type = ExerciseType(exercise_type_normalized)
2026-02-20T22:09:13.3560224Z              except ValueError:
2026-02-20T22:09:13.3561466Z -                logger.warning(f"Type d'exercice invalide: {exercise_type_normalized}, utilisation de ADDITION par défaut")
2026-02-20T22:09:13.3561607Z +                logger.warning(
2026-02-20T22:09:13.3562258Z +                    f"Type d'exercice invalide: {exercise_type_normalized}, utilisation de ADDITION par défaut"
2026-02-20T22:09:13.3562389Z +                )
2026-02-20T22:09:13.3562622Z                  exercise.exercise_type = ExerciseType.ADDITION
2026-02-20T22:09:13.3562728Z -            
2026-02-20T22:09:13.3562833Z +
2026-02-20T22:09:13.3562940Z              try:
2026-02-20T22:09:13.3563425Z                  exercise.difficulty = DifficultyLevel(difficulty_normalized)
2026-02-20T22:09:13.3563565Z              except ValueError:
2026-02-20T22:09:13.3564316Z -                logger.warning(f"Difficulté invalide: {difficulty_normalized}, utilisation de PADAWAN par défaut")
2026-02-20T22:09:13.3564455Z +                logger.warning(
2026-02-20T22:09:13.3565059Z +                    f"Difficulté invalide: {difficulty_normalized}, utilisation de PADAWAN par défaut"
2026-02-20T22:09:13.3565181Z +                )
2026-02-20T22:09:13.3565411Z                  exercise.difficulty = DifficultyLevel.PADAWAN
2026-02-20T22:09:13.3565517Z -            
2026-02-20T22:09:13.3565627Z +
2026-02-20T22:09:13.3565755Z              return exercise
2026-02-20T22:09:13.3566190Z          except Exception as get_exercise_error:
2026-02-20T22:09:13.3566854Z -            logger.error(f"Erreur lors de la récupération de l'exercice {exercise_id}: {get_exercise_error}")
2026-02-20T22:09:13.3566995Z +            logger.error(
2026-02-20T22:09:13.3567527Z +                f"Erreur lors de la récupération de l'exercice {exercise_id}: {get_exercise_error}"
2026-02-20T22:09:13.3567637Z +            )
2026-02-20T22:09:13.3567978Z              # Fallback vers la méthode originale en cas d'erreur
2026-02-20T22:09:13.3568091Z              try:
2026-02-20T22:09:13.3568377Z                  return DatabaseAdapter.get_by_id(db, Exercise, exercise_id)
2026-02-20T22:09:13.3568536Z              except Exception:
2026-02-20T22:09:13.3568660Z                  return None
2026-02-20T22:09:13.3568762Z -    
2026-02-20T22:09:13.3568866Z +
2026-02-20T22:09:13.3568991Z      @staticmethod
2026-02-20T22:09:13.3569120Z      def list_exercises(
2026-02-20T22:09:13.3569249Z -        db: Session, 
2026-02-20T22:09:13.3569374Z +        db: Session,
2026-02-20T22:09:13.3569538Z          exercise_type: Optional[str] = None,
2026-02-20T22:09:13.3569696Z          difficulty: Optional[str] = None,
2026-02-20T22:09:13.3569834Z          limit: Optional[int] = None,
2026-02-20T22:09:13.3569977Z -        offset: Optional[int] = None
2026-02-20T22:09:13.3570120Z +        offset: Optional[int] = None,
2026-02-20T22:09:13.3570248Z      ) -> List[Exercise]:
2026-02-20T22:09:13.3570362Z          """
2026-02-20T22:09:13.3570582Z          Liste les exercices actifs avec filtrage optionnel.
2026-02-20T22:09:13.3570693Z -        
2026-02-20T22:09:13.3570806Z +
2026-02-20T22:09:13.3570926Z          Args:
2026-02-20T22:09:13.3571165Z              db: Session de base de données
2026-02-20T22:09:13.3571512Z              exercise_type: Type d'exercice à filtrer (optionnel)
2026-02-20T22:09:13.3571881Z              difficulty: Niveau de difficulté à filtrer (optionnel)
2026-02-20T22:09:13.3572193Z              limit: Nombre maximum d'exercices à retourner
2026-02-20T22:09:13.3572449Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.3572570Z -            
2026-02-20T22:09:13.3572671Z +
2026-02-20T22:09:13.3572780Z          Returns:
2026-02-20T22:09:13.3573277Z              Liste des exercices correspondants aux critères
2026-02-20T22:09:13.3573399Z          """
2026-02-20T22:09:13.3573509Z          try:
2026-02-20T22:09:13.3573668Z              query = db.query(Exercise).filter(
2026-02-20T22:09:13.3573846Z -                Exercise.is_archived == False,
2026-02-20T22:09:13.3573997Z -                Exercise.is_active == True
2026-02-20T22:09:13.3574362Z -            )
2026-02-20T22:09:13.3574473Z -            
2026-02-20T22:09:13.3574756Z +                Exercise.is_archived == False, Exercise.is_active == True
2026-02-20T22:09:13.3574871Z +            )
2026-02-20T22:09:13.3574975Z +
2026-02-20T22:09:13.3575304Z              # FILTRE CRITIQUE : Accepter les valeurs en majuscules ET minuscules
2026-02-20T22:09:13.3575665Z              # pour compatibilité avec les données existantes
2026-02-20T22:09:13.3575874Z              valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.3576135Z              valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.3576246Z -            
2026-02-20T22:09:13.3576349Z +
2026-02-20T22:09:13.3576658Z              # Ajouter les valeurs en minuscules pour compatibilité
2026-02-20T22:09:13.3577097Z -            valid_types.extend(['addition', 'subtraction', 'multiplication', 'division', 'mixed'])
2026-02-20T22:09:13.3577445Z -            valid_difficulties.extend(['initie', 'padawan', 'chevalier', 'maitre'])
2026-02-20T22:09:13.3577569Z -            
2026-02-20T22:09:13.3577719Z +            valid_types.extend(
2026-02-20T22:09:13.3578027Z +                ["addition", "subtraction", "multiplication", "division", "mixed"]
2026-02-20T22:09:13.3578135Z +            )
2026-02-20T22:09:13.3578565Z +            valid_difficulties.extend(["initie", "padawan", "chevalier", "maitre"])
2026-02-20T22:09:13.3578884Z +
2026-02-20T22:09:13.3579301Z              # Ne pas filtrer par énumération pour éviter les problèmes
2026-02-20T22:09:13.3579598Z              # query = query.filter(Exercise.exercise_type.in_(valid_types))
2026-02-20T22:09:13.3579917Z              # query = query.filter(Exercise.difficulty.in_(valid_difficulties))
2026-02-20T22:09:13.3580027Z -            
2026-02-20T22:09:13.3580127Z +
2026-02-20T22:09:13.3580274Z              if exercise_type:
2026-02-20T22:09:13.3580563Z                  query = query.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:13.3580684Z -            
2026-02-20T22:09:13.3580796Z +
2026-02-20T22:09:13.3580922Z              if difficulty:
2026-02-20T22:09:13.3581182Z                  query = query.filter(Exercise.difficulty == difficulty)
2026-02-20T22:09:13.3581288Z -            
2026-02-20T22:09:13.3581405Z +
2026-02-20T22:09:13.3581539Z              if offset is not None:
2026-02-20T22:09:13.3581708Z                  query = query.offset(offset)
2026-02-20T22:09:13.3581823Z -            
2026-02-20T22:09:13.3581928Z +
2026-02-20T22:09:13.3582060Z              if limit is not None:
2026-02-20T22:09:13.3582204Z                  query = query.limit(limit)
2026-02-20T22:09:13.3582313Z -            
2026-02-20T22:09:13.3582414Z +
2026-02-20T22:09:13.3582548Z              return query.all()
2026-02-20T22:09:13.3582746Z          except Exception as exercises_fetch_error:
2026-02-20T22:09:13.3583565Z -            logger.error(f"Erreur lors de la récupération des exercices: {exercises_fetch_error}")
2026-02-20T22:09:13.3583708Z +            logger.error(
2026-02-20T22:09:13.3584199Z +                f"Erreur lors de la récupération des exercices: {exercises_fetch_error}"
2026-02-20T22:09:13.3584321Z +            )
2026-02-20T22:09:13.3584437Z              return []
2026-02-20T22:09:13.3584538Z -    
2026-02-20T22:09:13.3584661Z -    @staticmethod
2026-02-20T22:09:13.3601678Z -    def create_exercise(db: Session, exercise_data: Dict[str, Any]) -> Optional[Exercise]:
2026-02-20T22:09:13.3601862Z +
2026-02-20T22:09:13.3601997Z +    @staticmethod
2026-02-20T22:09:13.3602137Z +    def create_exercise(
2026-02-20T22:09:13.3602332Z +        db: Session, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.3602492Z +    ) -> Optional[Exercise]:
2026-02-20T22:09:13.3602605Z          """
2026-02-20T22:09:13.3602876Z          Crée un nouvel exercice.
2026-02-20T22:09:13.3603236Z -        
2026-02-20T22:09:13.3603360Z +
2026-02-20T22:09:13.3603473Z          Args:
2026-02-20T22:09:13.3603740Z              db: Session de base de données
2026-02-20T22:09:13.3604502Z              exercise_data: Dictionnaire contenant les données de l'exercice
2026-02-20T22:09:13.3604625Z -            
2026-02-20T22:09:13.3604730Z +
2026-02-20T22:09:13.3604852Z          Returns:
2026-02-20T22:09:13.3605130Z              L'exercice créé ou None en cas d'erreur
2026-02-20T22:09:13.3605239Z          """
2026-02-20T22:09:13.3605519Z          return DatabaseAdapter.create(db, Exercise, exercise_data)
2026-02-20T22:09:13.3605644Z -    
2026-02-20T22:09:13.3605764Z -    @staticmethod
2026-02-20T22:09:13.3606209Z -    def update_exercise(db: Session, exercise_id: int, exercise_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.3606326Z +
2026-02-20T22:09:13.3606444Z +    @staticmethod
2026-02-20T22:09:13.3606579Z +    def update_exercise(
2026-02-20T22:09:13.3606847Z +        db: Session, exercise_id: int, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.3606970Z +    ) -> bool:
2026-02-20T22:09:13.3607075Z          """
2026-02-20T22:09:13.3607311Z          Met à jour un exercice existant.
2026-02-20T22:09:13.3607442Z -        
2026-02-20T22:09:13.3607545Z +
2026-02-20T22:09:13.3607656Z          Args:
2026-02-20T22:09:13.3607892Z              db: Session de base de données
2026-02-20T22:09:13.3608214Z              exercise_id: ID de l'exercice à mettre à jour
2026-02-20T22:09:13.3608498Z              exercise_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.3608807Z -            
2026-02-20T22:09:13.3608928Z +
2026-02-20T22:09:13.3609045Z          Returns:
2026-02-20T22:09:13.3609359Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.3609477Z          """
2026-02-20T22:09:13.3609732Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3609863Z          if not exercise:
2026-02-20T22:09:13.3610461Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.3610608Z              return False
2026-02-20T22:09:13.3610719Z -        
2026-02-20T22:09:13.3610824Z +
2026-02-20T22:09:13.3611132Z          return DatabaseAdapter.update(db, exercise, exercise_data)
2026-02-20T22:09:13.3611241Z -    
2026-02-20T22:09:13.3611346Z +
2026-02-20T22:09:13.3611467Z      @staticmethod
2026-02-20T22:09:13.3611749Z      def archive_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.3611855Z          """
2026-02-20T22:09:13.3612345Z          Archive un exercice (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.3612467Z -        
2026-02-20T22:09:13.3612568Z +
2026-02-20T22:09:13.3612678Z          Args:
2026-02-20T22:09:13.3612919Z              db: Session de base de données
2026-02-20T22:09:13.3613394Z              exercise_id: ID de l'exercice à archiver
2026-02-20T22:09:13.3613508Z -            
2026-02-20T22:09:13.3613610Z +
2026-02-20T22:09:13.3613732Z          Returns:
2026-02-20T22:09:13.3614022Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.3614131Z          """
2026-02-20T22:09:13.3614402Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3614547Z          if not exercise:
2026-02-20T22:09:13.3615042Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour archivage")
2026-02-20T22:09:13.3615170Z              return False
2026-02-20T22:09:13.3615285Z -        
2026-02-20T22:09:13.3615385Z +
2026-02-20T22:09:13.3615601Z          return DatabaseAdapter.archive(db, exercise)
2026-02-20T22:09:13.3615715Z -    
2026-02-20T22:09:13.3615819Z +
2026-02-20T22:09:13.3615938Z      @staticmethod
2026-02-20T22:09:13.3616202Z      def delete_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.3616314Z          """
2026-02-20T22:09:13.3616690Z          Supprime physiquement un exercice de la base de données.
2026-02-20T22:09:13.3617039Z          Les tentatives associées sont supprimées en cascade.
2026-02-20T22:09:13.3617175Z -        
2026-02-20T22:09:13.3617321Z +
2026-02-20T22:09:13.3617436Z          Args:
2026-02-20T22:09:13.3617673Z              db: Session de base de données
2026-02-20T22:09:13.3618187Z              exercise_id: ID de l'exercice à supprimer
2026-02-20T22:09:13.3618299Z -            
2026-02-20T22:09:13.3618405Z +
2026-02-20T22:09:13.3618528Z          Returns:
2026-02-20T22:09:13.3618827Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.3618942Z          """
2026-02-20T22:09:13.3619227Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3619357Z          if not exercise:
2026-02-20T22:09:13.3619862Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour suppression")
2026-02-20T22:09:13.3619994Z              return False
2026-02-20T22:09:13.3620115Z -        
2026-02-20T22:09:13.3620220Z +
2026-02-20T22:09:13.3620423Z          return DatabaseAdapter.delete(db, exercise)
2026-02-20T22:09:13.3620535Z -    
2026-02-20T22:09:13.3620642Z +
2026-02-20T22:09:13.3620758Z      @staticmethod
2026-02-20T22:09:13.3621105Z      def get_exercise_attempts(db: Session, exercise_id: int) -> List[Attempt]:
2026-02-20T22:09:13.3621232Z          """
2026-02-20T22:09:13.3621614Z          Récupère toutes les tentatives associées à un exercice.
2026-02-20T22:09:13.3621722Z -        
2026-02-20T22:09:13.3621832Z +
2026-02-20T22:09:13.3621940Z          Args:
2026-02-20T22:09:13.3622170Z              db: Session de base de données
2026-02-20T22:09:13.3622621Z              exercise_id: ID de l'exercice
2026-02-20T22:09:13.3622740Z -            
2026-02-20T22:09:13.3622846Z +
2026-02-20T22:09:13.3623157Z          Returns:
2026-02-20T22:09:13.3623369Z              Liste des tentatives pour cet exercice
2026-02-20T22:09:13.3623481Z          """
2026-02-20T22:09:13.3623861Z          return DatabaseAdapter.get_by_field(db, Attempt, "exercise_id", exercise_id)
2026-02-20T22:09:13.3623976Z -    
2026-02-20T22:09:13.3624082Z +
2026-02-20T22:09:13.3624199Z      @staticmethod
2026-02-20T22:09:13.3624594Z      def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[Attempt]:
2026-02-20T22:09:13.3624728Z          """
2026-02-20T22:09:13.3624956Z          Enregistre une nouvelle tentative pour un exercice.
2026-02-20T22:09:13.3625065Z -        
2026-02-20T22:09:13.3625176Z +
2026-02-20T22:09:13.3625278Z          Args:
2026-02-20T22:09:13.3625526Z              db: Session de base de données
2026-02-20T22:09:13.3625953Z              attempt_data: Dictionnaire contenant les données de la tentative
2026-02-20T22:09:13.3626086Z -            
2026-02-20T22:09:13.3626189Z +
2026-02-20T22:09:13.3626303Z          Returns:
2026-02-20T22:09:13.3626593Z              La tentative créée ou None en cas d'erreur
2026-02-20T22:09:13.3626702Z          """
2026-02-20T22:09:13.3626939Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:13.3627046Z              try:
2026-02-20T22:09:13.3627307Z                  # Vérifier que l'exercice existe
2026-02-20T22:09:13.3627522Z                  exercise_id = attempt_data.get("exercise_id")
2026-02-20T22:09:13.3627896Z                  logger.info(f"Tentative d'enregistrement pour l'exercice {exercise_id}")
2026-02-20T22:09:13.3628031Z -                
2026-02-20T22:09:13.3628137Z +
2026-02-20T22:09:13.3628438Z                  exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3628555Z -                
2026-02-20T22:09:13.3628662Z +
2026-02-20T22:09:13.3629013Z                  # Si SQLAlchemy ne trouve pas l'exercice, essayer avec PostgreSQL direct
2026-02-20T22:09:13.3629146Z                  if not exercise:
2026-02-20T22:09:13.3629902Z -                    logger.warning(f"SQLAlchemy n'a pas trouvé l'exercice {exercise_id}, tentative avec PostgreSQL direct")
2026-02-20T22:09:13.3630046Z +                    logger.warning(
2026-02-20T22:09:13.3630672Z +                        f"SQLAlchemy n'a pas trouvé l'exercice {exercise_id}, tentative avec PostgreSQL direct"
2026-02-20T22:09:13.3630811Z +                    )
2026-02-20T22:09:13.3630932Z                      try:
2026-02-20T22:09:13.3631418Z                          # NOTE: exercise_service_translations archivé - fallback désactivé
2026-02-20T22:09:13.3631957Z                          logger.error(f"Exercice {exercise_id} introuvable en base")
2026-02-20T22:09:13.3632118Z                          exercise_dict = None
2026-02-20T22:09:13.3632263Z                          if exercise_dict:
2026-02-20T22:09:13.3632787Z -                            logger.info(f"Exercice {exercise_id} trouvé via PostgreSQL direct")
2026-02-20T22:09:13.3632940Z +                            logger.info(
2026-02-20T22:09:13.3633541Z +                                f"Exercice {exercise_id} trouvé via PostgreSQL direct"
2026-02-20T22:09:13.3633662Z +                            )
2026-02-20T22:09:13.3634067Z                              # Utiliser get_exercise qui gère correctement les enums
2026-02-20T22:09:13.3634385Z -                            exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3634599Z +                            exercise = ExerciseService.get_exercise(
2026-02-20T22:09:13.3634784Z +                                session, exercise_id
2026-02-20T22:09:13.3634907Z +                            )
2026-02-20T22:09:13.3635086Z                      except Exception as pg_error:
2026-02-20T22:09:13.3635658Z -                        logger.error(f"Erreur lors de la récupération PostgreSQL directe: {pg_error}")
2026-02-20T22:09:13.3635988Z -                
2026-02-20T22:09:13.3636138Z +                        logger.error(
2026-02-20T22:09:13.3636615Z +                            f"Erreur lors de la récupération PostgreSQL directe: {pg_error}"
2026-02-20T22:09:13.3636755Z +                        )
2026-02-20T22:09:13.3636863Z +
2026-02-20T22:09:13.3636997Z                  if not exercise:
2026-02-20T22:09:13.3637610Z -                    logger.error(f"Tentative d'enregistrement d'une tentative pour un exercice inexistant (ID {exercise_id})")
2026-02-20T22:09:13.3637744Z +                    logger.error(
2026-02-20T22:09:13.3638248Z +                        f"Tentative d'enregistrement d'une tentative pour un exercice inexistant (ID {exercise_id})"
2026-02-20T22:09:13.3638389Z +                    )
2026-02-20T22:09:13.3638969Z                      # Essayer de vérifier si l'exercice existe vraiment en BDD avec une requête directe
2026-02-20T22:09:13.3639202Z                      from server.database import get_db_connection
2026-02-20T22:09:13.3639330Z +
2026-02-20T22:09:13.3639488Z                      conn = get_db_connection()
2026-02-20T22:09:13.3639633Z                      cursor = conn.cursor()
2026-02-20T22:09:13.3639753Z                      try:
2026-02-20T22:09:13.3640137Z -                        cursor.execute("SELECT id FROM exercises WHERE id = %s", (exercise_id,))
2026-02-20T22:09:13.3640275Z +                        cursor.execute(
2026-02-20T22:09:13.3640545Z +                            "SELECT id FROM exercises WHERE id = %s", (exercise_id,)
2026-02-20T22:09:13.3640672Z +                        )
2026-02-20T22:09:13.3640849Z                          exists = cursor.fetchone()
2026-02-20T22:09:13.3640976Z                          if exists:
2026-02-20T22:09:13.3641714Z -                            logger.warning(f"L'exercice {exercise_id} existe en BDD mais n'est pas trouvé par SQLAlchemy ORM")
2026-02-20T22:09:13.3641876Z +                            logger.warning(
2026-02-20T22:09:13.3642489Z +                                f"L'exercice {exercise_id} existe en BDD mais n'est pas trouvé par SQLAlchemy ORM"
2026-02-20T22:09:13.3642616Z +                            )
2026-02-20T22:09:13.3643461Z                              # Forcer le refresh de la session SQLAlchemy et utiliser get_exercise qui gère les enums
2026-02-20T22:09:13.3643631Z                              session.expire_all()
2026-02-20T22:09:13.3643949Z -                            exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3644175Z +                            exercise = ExerciseService.get_exercise(
2026-02-20T22:09:13.3644643Z +                                session, exercise_id
2026-02-20T22:09:13.3644769Z +                            )
2026-02-20T22:09:13.3644921Z                              if not exercise:
2026-02-20T22:09:13.3645555Z -                                logger.error(f"Impossible de charger l'exercice {exercise_id} même après refresh")
2026-02-20T22:09:13.3645721Z +                                logger.error(
2026-02-20T22:09:13.3646255Z +                                    f"Impossible de charger l'exercice {exercise_id} même après refresh"
2026-02-20T22:09:13.3646379Z +                                )
2026-02-20T22:09:13.3646515Z                                  return None
2026-02-20T22:09:13.3646629Z                          else:
2026-02-20T22:09:13.3647000Z -                            logger.error(f"L'exercice {exercise_id} n'existe vraiment pas en BDD")
2026-02-20T22:09:13.3647141Z +                            logger.error(
2026-02-20T22:09:13.3647421Z +                                f"L'exercice {exercise_id} n'existe vraiment pas en BDD"
2026-02-20T22:09:13.3647562Z +                            )
2026-02-20T22:09:13.3647694Z                              return None
2026-02-20T22:09:13.3647813Z                      finally:
2026-02-20T22:09:13.3647953Z                          cursor.close()
2026-02-20T22:09:13.3648088Z                          conn.close()
2026-02-20T22:09:13.3648388Z -                
2026-02-20T22:09:13.3648503Z +
2026-02-20T22:09:13.3648638Z                  if not exercise:
2026-02-20T22:09:13.3763392Z                      return None
2026-02-20T22:09:13.3763590Z -                
2026-02-20T22:09:13.3763715Z +
2026-02-20T22:09:13.3764285Z                  logger.info(f"Exercice {exercise_id} trouvé: {exercise.title}")
2026-02-20T22:09:13.3764401Z -                
2026-02-20T22:09:13.3764516Z +
2026-02-20T22:09:13.3764743Z                  # Créer la tentative
2026-02-20T22:09:13.3765260Z -                logger.info(f"Création de la tentative avec attempt_data: {attempt_data}")
2026-02-20T22:09:13.3765428Z +                logger.info(
2026-02-20T22:09:13.3765862Z +                    f"Création de la tentative avec attempt_data: {attempt_data}"
2026-02-20T22:09:13.3765977Z +                )
2026-02-20T22:09:13.3766154Z                  attempt = Attempt(**attempt_data)
2026-02-20T22:09:13.3766308Z                  session.add(attempt)
2026-02-20T22:09:13.3766457Z                  session.flush()
2026-02-20T22:09:13.3766827Z                  logger.info(f"Tentative créée avec ID: {attempt.id}")
2026-02-20T22:09:13.3766948Z -                
2026-02-20T22:09:13.3767052Z +
2026-02-20T22:09:13.3767184Z                  # Log de l'action
2026-02-20T22:09:13.3767413Z                  is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.3768234Z -                logger.info(f"Tentative enregistrée pour l'exercice {exercise_id}: {'Correcte' if is_correct else 'Incorrecte'}")
2026-02-20T22:09:13.3768350Z -                
2026-02-20T22:09:13.3768481Z +                logger.info(
2026-02-20T22:09:13.3769227Z +                    f"Tentative enregistrée pour l'exercice {exercise_id}: {'Correcte' if is_correct else 'Incorrecte'}"
2026-02-20T22:09:13.3769343Z +                )
2026-02-20T22:09:13.3769442Z +
2026-02-20T22:09:13.3769925Z                  # 🔥 CORRECTION CRITIQUE : Mettre à jour les statistiques utilisateur
2026-02-20T22:09:13.3770084Z                  try:
2026-02-20T22:09:13.3770477Z -                    ExerciseService._update_user_statistics(session, attempt_data, exercise)
2026-02-20T22:09:13.3771131Z -                    logger.info(f"Statistiques mises à jour pour l'utilisateur {attempt_data.get('user_id')}")
2026-02-20T22:09:13.3771349Z +                    ExerciseService._update_user_statistics(
2026-02-20T22:09:13.3771531Z +                        session, attempt_data, exercise
2026-02-20T22:09:13.3771646Z +                    )
2026-02-20T22:09:13.3771796Z +                    logger.info(
2026-02-20T22:09:13.3772349Z +                        f"Statistiques mises à jour pour l'utilisateur {attempt_data.get('user_id')}"
2026-02-20T22:09:13.3772773Z +                    )
2026-02-20T22:09:13.3773154Z                  except Exception as stats_error:
2026-02-20T22:09:13.3773720Z -                    logger.error(f"Erreur lors de la mise à jour des statistiques: {stats_error}")
2026-02-20T22:09:13.3773880Z +                    logger.error(
2026-02-20T22:09:13.3774326Z +                        f"Erreur lors de la mise à jour des statistiques: {stats_error}"
2026-02-20T22:09:13.3774453Z +                    )
2026-02-20T22:09:13.3774856Z                      # Ne pas faire échouer la tentative pour une erreur de stats
2026-02-20T22:09:13.3774968Z -                
2026-02-20T22:09:13.3775081Z +
2026-02-20T22:09:13.3775211Z                  return attempt
2026-02-20T22:09:13.3775411Z              except Exception as attempt_record_error:
2026-02-20T22:09:13.3775714Z                  error_type = type(attempt_record_error).__name__
2026-02-20T22:09:13.3775895Z                  error_msg = str(attempt_record_error)
2026-02-20T22:09:13.3776045Z                  import traceback
2026-02-20T22:09:13.3776699Z -                logger.error(f"❌ ERREUR lors de l'enregistrement de la tentative: {error_type}: {error_msg}")
2026-02-20T22:09:13.3776820Z +
2026-02-20T22:09:13.3776949Z +                logger.error(
2026-02-20T22:09:13.3777722Z +                    f"❌ ERREUR lors de l'enregistrement de la tentative: {error_type}: {error_msg}"
2026-02-20T22:09:13.3777848Z +                )
2026-02-20T22:09:13.3778151Z                  logger.error(f"Traceback complet:\n{traceback.format_exc()}")
2026-02-20T22:09:13.3778282Z                  return None
2026-02-20T22:09:13.3778395Z  
2026-02-20T22:09:13.3778513Z      @staticmethod
2026-02-20T22:09:13.3779219Z -    def _update_user_statistics(session: Session, attempt_data: Dict[str, Any], exercise: Union[Exercise, Dict[str, Any], None]) -> None:
2026-02-20T22:09:13.3779368Z +    def _update_user_statistics(
2026-02-20T22:09:13.3779515Z +        session: Session,
2026-02-20T22:09:13.3779662Z +        attempt_data: Dict[str, Any],
2026-02-20T22:09:13.3779876Z +        exercise: Union[Exercise, Dict[str, Any], None],
2026-02-20T22:09:13.3780004Z +    ) -> None:
2026-02-20T22:09:13.3780112Z          """
2026-02-20T22:09:13.3780521Z          Met à jour les statistiques utilisateur après une tentative.
2026-02-20T22:09:13.3780656Z -        
2026-02-20T22:09:13.3780760Z +
2026-02-20T22:09:13.3780868Z          Args:
2026-02-20T22:09:13.3781133Z              session: Session de base de données
2026-02-20T22:09:13.3781409Z              attempt_data: Données de la tentative
2026-02-20T22:09:13.3781814Z              exercise: Exercice concerné (objet Exercise, dict, ou None)
2026-02-20T22:09:13.3781939Z          """
2026-02-20T22:09:13.3782090Z          from datetime import datetime
2026-02-20T22:09:13.3782195Z  
2026-02-20T22:09:13.3782410Z          from app.models.legacy_tables import UserStats
2026-02-20T22:09:13.3782604Z          from app.models.progress import Progress
2026-02-20T22:09:13.3782736Z -        
2026-02-20T22:09:13.3782840Z +
2026-02-20T22:09:13.3783322Z          user_id = attempt_data.get("user_id")
2026-02-20T22:09:13.3783550Z          is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.3783753Z          time_spent = attempt_data.get("time_spent", 0)
2026-02-20T22:09:13.3783874Z -        
2026-02-20T22:09:13.3783976Z +
2026-02-20T22:09:13.3784313Z          # Extraire exercise_type et difficulty depuis exercise (objet ou dict)
2026-02-20T22:09:13.3784448Z          if exercise is None:
2026-02-20T22:09:13.3784963Z              logger.warning("Aucun exercice fourni pour mettre à jour les statistiques")
2026-02-20T22:09:13.3785086Z              return
2026-02-20T22:09:13.3785192Z -        
2026-02-20T22:09:13.3785294Z +
2026-02-20T22:09:13.3785455Z          if isinstance(exercise, dict):
2026-02-20T22:09:13.3785661Z              exercise_type = exercise.get("exercise_type")
2026-02-20T22:09:13.3785842Z              difficulty = exercise.get("difficulty")
2026-02-20T22:09:13.3786159Z          else:
2026-02-20T22:09:13.3786354Z              exercise_type = exercise.exercise_type
2026-02-20T22:09:13.3786519Z              difficulty = exercise.difficulty
2026-02-20T22:09:13.3786620Z -        
2026-02-20T22:09:13.3786733Z +
2026-02-20T22:09:13.3786866Z          if not exercise_type:
2026-02-20T22:09:13.3787471Z -            logger.warning(f"Impossible de déterminer le type d'exercice pour les statistiques")
2026-02-20T22:09:13.3787609Z +            logger.warning(
2026-02-20T22:09:13.3788078Z +                f"Impossible de déterminer le type d'exercice pour les statistiques"
2026-02-20T22:09:13.3788187Z +            )
2026-02-20T22:09:13.3788298Z              return
2026-02-20T22:09:13.3788416Z -        
2026-02-20T22:09:13.3788521Z +
2026-02-20T22:09:13.3788770Z          # 1. Mettre à jour ou créer Progress
2026-02-20T22:09:13.3788962Z -        progress = session.query(Progress).filter(
2026-02-20T22:09:13.3789127Z -            Progress.user_id == user_id,
2026-02-20T22:09:13.3789324Z -            Progress.exercise_type == exercise_type
2026-02-20T22:09:13.3789438Z -        ).first()
2026-02-20T22:09:13.3789554Z -        
2026-02-20T22:09:13.3789673Z +        progress = (
2026-02-20T22:09:13.3789818Z +            session.query(Progress)
2026-02-20T22:09:13.3789938Z +            .filter(
2026-02-20T22:09:13.3790490Z +                Progress.user_id == user_id, Progress.exercise_type == exercise_type
2026-02-20T22:09:13.3790601Z +            )
2026-02-20T22:09:13.3790715Z +            .first()
2026-02-20T22:09:13.3790830Z +        )
2026-02-20T22:09:13.3790928Z +
2026-02-20T22:09:13.3791048Z          if progress:
2026-02-20T22:09:13.3791210Z              progress.total_attempts += 1
2026-02-20T22:09:13.3791333Z              if is_correct:
2026-02-20T22:09:13.3791500Z                  progress.correct_attempts += 1
2026-02-20T22:09:13.3791644Z                  progress.streak += 1
2026-02-20T22:09:13.3791876Z                  if progress.streak > progress.highest_streak:
2026-02-20T22:09:13.3792099Z                      progress.highest_streak = progress.streak
2026-02-20T22:09:13.3792212Z              else:
2026-02-20T22:09:13.3792360Z                  progress.streak = 0
2026-02-20T22:09:13.3792484Z -            
2026-02-20T22:09:13.3792588Z +
2026-02-20T22:09:13.3792840Z              # Mettre à jour le temps moyen
2026-02-20T22:09:13.3793202Z              if progress.average_time is None:
2026-02-20T22:09:13.3793387Z                  progress.average_time = time_spent
2026-02-20T22:09:13.3793504Z              else:
2026-02-20T22:09:13.3793919Z -                total_time = progress.average_time * (progress.total_attempts - 1) + time_spent
2026-02-20T22:09:13.3794048Z +                total_time = (
2026-02-20T22:09:13.3794377Z +                    progress.average_time * (progress.total_attempts - 1) + time_spent
2026-02-20T22:09:13.3794501Z +                )
2026-02-20T22:09:13.3794790Z                  progress.average_time = total_time / progress.total_attempts
2026-02-20T22:09:13.3794912Z -            
2026-02-20T22:09:13.3795014Z +
2026-02-20T22:09:13.3795337Z              progress.completion_rate = progress.calculate_completion_rate()
2026-02-20T22:09:13.3795504Z              progress.update_mastery_level()
2026-02-20T22:09:13.3795618Z          else:
2026-02-20T22:09:13.3795786Z              new_progress = Progress(
2026-02-20T22:09:13.3795915Z                  user_id=user_id,
2026-02-20T22:09:13.3796033Z @@ -408,48 +480,65 @@
2026-02-20T22:09:13.3796278Z                  difficulty=difficulty if difficulty else "initie",
2026-02-20T22:09:13.3796414Z                  total_attempts=1,
2026-02-20T22:09:13.3796597Z                  correct_attempts=1 if is_correct else 0,
2026-02-20T22:09:13.3796744Z                  average_time=time_spent,
2026-02-20T22:09:13.3796910Z                  streak=1 if is_correct else 0,
2026-02-20T22:09:13.3797091Z -                highest_streak=1 if is_correct else 0
2026-02-20T22:09:13.3797539Z +                highest_streak=1 if is_correct else 0,
2026-02-20T22:09:13.3797659Z              )
2026-02-20T22:09:13.3797807Z              session.add(new_progress)
2026-02-20T22:09:13.3797913Z -        
2026-02-20T22:09:13.3798024Z +
2026-02-20T22:09:13.3798540Z          # 2. Mettre à jour ou créer UserStats dans une session SÉPARÉE pour éviter
2026-02-20T22:09:13.3799051Z          #    de contaminer la transaction principale (table legacy, peut être absente)
2026-02-20T22:09:13.3799171Z          try:
2026-02-20T22:09:13.3799372Z              from sqlalchemy.orm import sessionmaker
2026-02-20T22:09:13.3799476Z +
2026-02-20T22:09:13.3799758Z              aux_factory = sessionmaker(autocommit=False, autoflush=False)
2026-02-20T22:09:13.3799992Z              aux_session = aux_factory(bind=session.get_bind())
2026-02-20T22:09:13.3800102Z              try:
2026-02-20T22:09:13.3800271Z -                result = aux_session.execute(text(
2026-02-20T22:09:13.3800476Z -                    "SELECT 1 FROM information_schema.tables "
2026-02-20T22:09:13.3800765Z -                    "WHERE table_schema='public' AND table_name='user_stats'"
2026-02-20T22:09:13.3800879Z -                ))
2026-02-20T22:09:13.3801040Z +                result = aux_session.execute(
2026-02-20T22:09:13.3801167Z +                    text(
2026-02-20T22:09:13.3801378Z +                        "SELECT 1 FROM information_schema.tables "
2026-02-20T22:09:13.3801874Z +                        "WHERE table_schema='public' AND table_name='user_stats'"
2026-02-20T22:09:13.3801995Z +                    )
2026-02-20T22:09:13.3802103Z +                )
2026-02-20T22:09:13.3802247Z                  if not result.scalar():
2026-02-20T22:09:13.3802613Z                      logger.debug("Table user_stats absente, ignorée")
2026-02-20T22:09:13.3802734Z                  else:
2026-02-20T22:09:13.3803429Z -                    ex_type_val = exercise_type.value if hasattr(exercise_type, 'value') else str(exercise_type)
2026-02-20T22:09:13.3803932Z -                    diff_val = difficulty.value if hasattr(difficulty, 'value') else str(difficulty) or "initie"
2026-02-20T22:09:13.3804189Z -                    user_stat = aux_session.query(UserStats).filter(
2026-02-20T22:09:13.3804398Z -                        UserStats.exercise_type == ex_type_val,
2026-02-20T22:09:13.3804583Z -                        UserStats.difficulty == diff_val
2026-02-20T22:09:13.3804727Z -                    ).first()
2026-02-20T22:09:13.3804856Z +                    ex_type_val = (
2026-02-20T22:09:13.3805006Z +                        exercise_type.value
2026-02-20T22:09:13.3805191Z +                        if hasattr(exercise_type, "value")
2026-02-20T22:09:13.3805358Z +                        else str(exercise_type)
2026-02-20T22:09:13.3805476Z +                    )
2026-02-20T22:09:13.3805596Z +                    diff_val = (
2026-02-20T22:09:13.3805734Z +                        difficulty.value
2026-02-20T22:09:13.3805906Z +                        if hasattr(difficulty, "value")
2026-02-20T22:09:13.3806079Z +                        else str(difficulty) or "initie"
2026-02-20T22:09:13.3806201Z +                    )
2026-02-20T22:09:13.3806327Z +                    user_stat = (
2026-02-20T22:09:13.3806488Z +                        aux_session.query(UserStats)
2026-02-20T22:09:13.3806606Z +                        .filter(
2026-02-20T22:09:13.3806830Z +                            UserStats.exercise_type == ex_type_val,
2026-02-20T22:09:13.3807020Z +                            UserStats.difficulty == diff_val,
2026-02-20T22:09:13.3807135Z +                        )
2026-02-20T22:09:13.3807258Z +                        .first()
2026-02-20T22:09:13.3807364Z +                    )
2026-02-20T22:09:13.3807487Z                      if user_stat:
2026-02-20T22:09:13.3807668Z                          user_stat.total_attempts += 1
2026-02-20T22:09:13.3807801Z                          if is_correct:
2026-02-20T22:09:13.3807988Z                              user_stat.correct_attempts += 1
2026-02-20T22:09:13.3808412Z                          user_stat.last_updated = datetime.now()
2026-02-20T22:09:13.3808545Z                      else:
2026-02-20T22:09:13.3808711Z -                        aux_session.add(UserStats(
2026-02-20T22:09:13.3808878Z -                            exercise_type=ex_type_val,
2026-02-20T22:09:13.3809038Z -                            difficulty=diff_val,
2026-02-20T22:09:13.3809195Z -                            total_attempts=1,
2026-02-20T22:09:13.3809403Z -                            correct_attempts=1 if is_correct else 0
2026-02-20T22:09:13.3809529Z -                        ))
2026-02-20T22:09:13.3809666Z +                        aux_session.add(
2026-02-20T22:09:13.3809795Z +                            UserStats(
2026-02-20T22:09:13.3809973Z +                                exercise_type=ex_type_val,
2026-02-20T22:09:13.3810145Z +                                difficulty=diff_val,
2026-02-20T22:09:13.3810296Z +                                total_attempts=1,
2026-02-20T22:09:13.3810518Z +                                correct_attempts=1 if is_correct else 0,
2026-02-20T22:09:13.3810644Z +                            )
2026-02-20T22:09:13.3810761Z +                        )
2026-02-20T22:09:13.3810903Z                      aux_session.commit()
2026-02-20T22:09:13.3811024Z              finally:
2026-02-20T22:09:13.3811157Z                  aux_session.close()
2026-02-20T22:09:13.3811502Z          except Exception as user_stats_err:
2026-02-20T22:09:13.3811878Z              logger.debug("UserStats ignoré: %s", user_stats_err)
2026-02-20T22:09:13.3812004Z  
2026-02-20T22:09:13.3812135Z -        session.flush() 
2026-02-20T22:09:13.3812272Z \ No newline at end of file
2026-02-20T22:09:13.3812409Z +        session.flush()
2026-02-20T22:09:13.3874005Z would reformat /home/runner/work/mathakine/mathakine/app/utils/csrf.py
2026-02-20T22:09:13.3874486Z --- /home/runner/work/mathakine/mathakine/app/utils/csrf.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3875348Z +++ /home/runner/work/mathakine/mathakine/app/utils/csrf.py	2026-02-20 22:09:13.385161+00:00
2026-02-20T22:09:13.3875719Z @@ -3,10 +3,11 @@
2026-02-20T22:09:13.3875835Z  
2026-02-20T22:09:13.3876320Z  Pattern double-submit : le backend génère un token, le met en cookie
2026-02-20T22:09:13.3876621Z  et le retourne. Le client renvoie le token dans le header X-CSRF-Token.
2026-02-20T22:09:13.3876940Z  Un attaquant cross-site ne peut pas lire le cookie ni forger le header.
2026-02-20T22:09:13.3877043Z  """
2026-02-20T22:09:13.3877149Z +
2026-02-20T22:09:13.3877261Z  import os
2026-02-20T22:09:13.3877375Z  import secrets
2026-02-20T22:09:13.3877472Z  
2026-02-20T22:09:13.3877665Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.3877819Z  from starlette.requests import Request
2026-02-20T22:09:13.6017830Z --- /home/runner/work/mathakine/mathakine/app/services/user_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6019161Z +++ /home/runner/work/mathakine/mathakine/app/services/user_service.py	2026-02-20 22:09:13.597470+00:00
2026-02-20T22:09:13.6020021Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.6020328Z  """
2026-02-20T22:09:13.6020659Z  Service pour la gestion des utilisateurs.
2026-02-20T22:09:13.6021809Z  Implémente les opérations métier liées aux utilisateurs et utilise le transaction manager.
2026-02-20T22:09:13.6022572Z  """
2026-02-20T22:09:13.6022854Z +
2026-02-20T22:09:13.6023398Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:13.6023843Z  
2026-02-20T22:09:13.6024187Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.6024647Z  
2026-02-20T22:09:13.6024933Z  logger = get_logger(__name__)
2026-02-20T22:09:13.6025306Z @@ -24,221 +25,237 @@
2026-02-20T22:09:13.6025619Z      """
2026-02-20T22:09:13.6025945Z      Service pour la gestion des utilisateurs.
2026-02-20T22:09:13.6026873Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des utilisateurs,
2026-02-20T22:09:13.6027829Z      ainsi que pour consulter leurs activités et statistiques.
2026-02-20T22:09:13.6028818Z      """
2026-02-20T22:09:13.6029100Z -    
2026-02-20T22:09:13.6029348Z +
2026-02-20T22:09:13.6029613Z      @staticmethod
2026-02-20T22:09:13.6030056Z      def get_user(db: Session, user_id: int) -> Optional[User]:
2026-02-20T22:09:13.6030596Z          """
2026-02-20T22:09:13.6031044Z          Récupère un utilisateur par son ID.
2026-02-20T22:09:13.6031503Z -        
2026-02-20T22:09:13.6031765Z +
2026-02-20T22:09:13.6032015Z          Args:
2026-02-20T22:09:13.6032442Z              db: Session de base de données
2026-02-20T22:09:13.6033201Z              user_id: ID de l'utilisateur à récupérer
2026-02-20T22:09:13.6033678Z -            
2026-02-20T22:09:13.6033959Z +
2026-02-20T22:09:13.6034220Z          Returns:
2026-02-20T22:09:13.6034816Z              L'utilisateur correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.6035406Z          """
2026-02-20T22:09:13.6035800Z          return DatabaseAdapter.get_by_id(db, User, user_id)
2026-02-20T22:09:13.6036308Z -    
2026-02-20T22:09:13.6036585Z +
2026-02-20T22:09:13.6036837Z      @staticmethod
2026-02-20T22:09:13.6037355Z      def get_user_by_username(db: Session, username: str) -> Optional[User]:
2026-02-20T22:09:13.6037961Z          """
2026-02-20T22:09:13.6038470Z          Récupère un utilisateur par son nom d'utilisateur.
2026-02-20T22:09:13.6038965Z -        
2026-02-20T22:09:13.6039510Z +
2026-02-20T22:09:13.6039752Z          Args:
2026-02-20T22:09:13.6040174Z              db: Session de base de données
2026-02-20T22:09:13.6040754Z              username: Nom d'utilisateur à rechercher
2026-02-20T22:09:13.6041216Z -            
2026-02-20T22:09:13.6041488Z +
2026-02-20T22:09:13.6041735Z          Returns:
2026-02-20T22:09:13.6042292Z              L'utilisateur correspondant au nom d'utilisateur ou None s'il n'existe pas
2026-02-20T22:09:13.6063216Z          """
2026-02-20T22:09:13.6063836Z          users = DatabaseAdapter.get_by_field(db, User, "username", username)
2026-02-20T22:09:13.6064501Z          return users[0] if users else None
2026-02-20T22:09:13.6064943Z -    
2026-02-20T22:09:13.6065199Z +
2026-02-20T22:09:13.6065459Z      @staticmethod
2026-02-20T22:09:13.6065924Z      def get_user_by_email(db: Session, email: str) -> Optional[User]:
2026-02-20T22:09:13.6066490Z          """
2026-02-20T22:09:13.6067031Z          Récupère un utilisateur par son adresse email.
2026-02-20T22:09:13.6067523Z -        
2026-02-20T22:09:13.6067790Z +
2026-02-20T22:09:13.6068031Z          Args:
2026-02-20T22:09:13.6068437Z              db: Session de base de données
2026-02-20T22:09:13.6068973Z              email: Adresse email à rechercher
2026-02-20T22:09:13.6069395Z -            
2026-02-20T22:09:13.6069661Z +
2026-02-20T22:09:13.6069915Z          Returns:
2026-02-20T22:09:13.6070628Z              L'utilisateur correspondant à l'adresse email ou None s'il n'existe pas
2026-02-20T22:09:13.6071271Z          """
2026-02-20T22:09:13.6071718Z          users = DatabaseAdapter.get_by_field(db, User, "email", email)
2026-02-20T22:09:13.6072317Z          return users[0] if users else None
2026-02-20T22:09:13.6072742Z -    
2026-02-20T22:09:13.6073203Z -    @staticmethod
2026-02-20T22:09:13.6073880Z -    def list_users(db: Session, limit: Optional[int] = None, offset: Optional[int] = None) -> List[User]:
2026-02-20T22:09:13.6074634Z +
2026-02-20T22:09:13.6074894Z +    @staticmethod
2026-02-20T22:09:13.6075204Z +    def list_users(
2026-02-20T22:09:13.6075708Z +        db: Session, limit: Optional[int] = None, offset: Optional[int] = None
2026-02-20T22:09:13.6076689Z would reformat /home/runner/work/mathakine/mathakine/app/services/user_service.py
2026-02-20T22:09:13.6077366Z +    ) -> List[User]:
2026-02-20T22:09:13.6077678Z          """
2026-02-20T22:09:13.6077995Z          Liste tous les utilisateurs actifs.
2026-02-20T22:09:13.6078417Z -        
2026-02-20T22:09:13.6078669Z +
2026-02-20T22:09:13.6078920Z          Args:
2026-02-20T22:09:13.6079318Z              db: Session de base de données
2026-02-20T22:09:13.6079927Z              limit: Nombre maximum d'utilisateurs à retourner
2026-02-20T22:09:13.6080899Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.6081332Z -            
2026-02-20T22:09:13.6081604Z +
2026-02-20T22:09:13.6081842Z          Returns:
2026-02-20T22:09:13.6082174Z              Liste des utilisateurs actifs
2026-02-20T22:09:13.6082578Z          """
2026-02-20T22:09:13.6083229Z          try:
2026-02-20T22:09:13.6083621Z              query = db.query(User).filter(User.is_active == True)
2026-02-20T22:09:13.6084130Z -            
2026-02-20T22:09:13.6084394Z +
2026-02-20T22:09:13.6084657Z              if offset is not None:
2026-02-20T22:09:13.6085088Z                  query = query.offset(offset)
2026-02-20T22:09:13.6085493Z -            
2026-02-20T22:09:13.6085758Z +
2026-02-20T22:09:13.6086018Z              if limit is not None:
2026-02-20T22:09:13.6086430Z                  query = query.limit(limit)
2026-02-20T22:09:13.6086822Z -            
2026-02-20T22:09:13.6087087Z +
2026-02-20T22:09:13.6087342Z              return query.all()
2026-02-20T22:09:13.6087776Z          except Exception as users_fetch_error:
2026-02-20T22:09:13.6088676Z -            logger.error(f"Erreur lors de la récupération des utilisateurs: {users_fetch_error}")
2026-02-20T22:09:13.6089407Z +            logger.error(
2026-02-20T22:09:13.6090081Z +                f"Erreur lors de la récupération des utilisateurs: {users_fetch_error}"
2026-02-20T22:09:13.6090698Z +            )
2026-02-20T22:09:13.6090985Z              return []
2026-02-20T22:09:13.6091283Z -    
2026-02-20T22:09:13.6091540Z +
2026-02-20T22:09:13.6091782Z      @staticmethod
2026-02-20T22:09:13.6092288Z      def create_user(db: Session, user_data: Dict[str, Any]) -> Optional[User]:
2026-02-20T22:09:13.6092893Z          """
2026-02-20T22:09:13.6123657Z          Crée un nouvel utilisateur.
2026-02-20T22:09:13.6124096Z -        
2026-02-20T22:09:13.6124360Z +
2026-02-20T22:09:13.6124616Z          Args:
2026-02-20T22:09:13.6125014Z              db: Session de base de données
2026-02-20T22:09:13.6125735Z              user_data: Dictionnaire contenant les données de l'utilisateur
2026-02-20T22:09:13.6126327Z -            
2026-02-20T22:09:13.6126605Z +
2026-02-20T22:09:13.6126847Z          Returns:
2026-02-20T22:09:13.6127315Z              L'utilisateur créé ou None en cas d'erreur
2026-02-20T22:09:13.6127768Z          """
2026-02-20T22:09:13.6128335Z          # Vérifier si l'utilisateur existe déjà (par email ou username)
2026-02-20T22:09:13.6128962Z          username = user_data.get("username")
2026-02-20T22:09:13.6129412Z          email = user_data.get("email")
2026-02-20T22:09:13.6129807Z -        
2026-02-20T22:09:13.6130060Z +
2026-02-20T22:09:13.6130551Z          with TransactionManager.transaction(db, auto_commit=False) as session:
2026-02-20T22:09:13.6131386Z              if username and UserService.get_user_by_username(session, username):
2026-02-20T22:09:13.6132331Z                  logger.error(f"Un utilisateur avec le nom '{username}' existe déjà")
2026-02-20T22:09:13.6133114Z                  return None
2026-02-20T22:09:13.6133476Z -            
2026-02-20T22:09:13.6133747Z +
2026-02-20T22:09:13.6134140Z              if email and UserService.get_user_by_email(session, email):
2026-02-20T22:09:13.6135014Z                  logger.error(f"Un utilisateur avec l'email '{email}' existe déjà")
2026-02-20T22:09:13.6135610Z                  return None
2026-02-20T22:09:13.6135958Z -            
2026-02-20T22:09:13.6136213Z +
2026-02-20T22:09:13.6136785Z              # Adapter le rôle utilisateur pour le moteur de base de données actuel
2026-02-20T22:09:13.6137421Z              role = user_data.get("role")
2026-02-20T22:09:13.6137826Z              if role:
2026-02-20T22:09:13.6138312Z                  user_data["role"] = adapt_enum_for_db("UserRole", role, session)
2026-02-20T22:09:13.6139191Z                  logger.debug(f"Rôle adapté: de '{role}' à '{user_data['role']}'")
2026-02-20T22:09:13.6139765Z -            
2026-02-20T22:09:13.6140025Z +
2026-02-20T22:09:13.6140421Z              return DatabaseAdapter.create(session, User, user_data)
2026-02-20T22:09:13.6141210Z -    
2026-02-20T22:09:13.6141465Z +
2026-02-20T22:09:13.6141721Z      @staticmethod
2026-02-20T22:09:13.6142241Z      def update_user(db: Session, user_id: int, user_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.6142870Z          """
2026-02-20T22:09:13.6143453Z          Met à jour un utilisateur existant.
2026-02-20T22:09:13.6144101Z -        
2026-02-20T22:09:13.6144353Z +
2026-02-20T22:09:13.6144602Z          Args:
2026-02-20T22:09:13.6144993Z              db: Session de base de données
2026-02-20T22:09:13.6145587Z              user_id: ID de l'utilisateur à mettre à jour
2026-02-20T22:09:13.6146195Z              user_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.6146712Z -            
2026-02-20T22:09:13.6146987Z +
2026-02-20T22:09:13.6147231Z          Returns:
2026-02-20T22:09:13.6147706Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.6148163Z          """
2026-02-20T22:09:13.6148510Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6148950Z          if not user:
2026-02-20T22:09:13.6149637Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.6150291Z              return False
2026-02-20T22:09:13.6150617Z -        
2026-02-20T22:09:13.6150889Z +
2026-02-20T22:09:13.6151467Z          # Adapter le rôle utilisateur si présent dans les données de mise à jour
2026-02-20T22:09:13.6152097Z          if "role" in user_data:
2026-02-20T22:09:13.6152484Z              role = user_data["role"]
2026-02-20T22:09:13.6183296Z              user_data["role"] = adapt_enum_for_db("UserRole", role, db)
2026-02-20T22:09:13.6184465Z -            logger.debug(f"Rôle adapté pour mise à jour: de '{role}' à '{user_data['role']}'")
2026-02-20T22:09:13.6185202Z -        
2026-02-20T22:09:13.6185506Z +            logger.debug(
2026-02-20T22:09:13.6186244Z +                f"Rôle adapté pour mise à jour: de '{role}' à '{user_data['role']}'"
2026-02-20T22:09:13.6186903Z +            )
2026-02-20T22:09:13.6187198Z +
2026-02-20T22:09:13.6187588Z          return DatabaseAdapter.update(db, user, user_data)
2026-02-20T22:09:13.6188085Z -    
2026-02-20T22:09:13.6188355Z +
2026-02-20T22:09:13.6188619Z      @staticmethod
2026-02-20T22:09:13.6189045Z      def delete_user(db: Session, user_id: int) -> bool:
2026-02-20T22:09:13.6189551Z          """
2026-02-20T22:09:13.6190124Z          Supprime physiquement un utilisateur de la base de données.
2026-02-20T22:09:13.6190931Z          Les entités associées sont supprimées en cascade.
2026-02-20T22:09:13.6191427Z -        
2026-02-20T22:09:13.6191712Z +
2026-02-20T22:09:13.6191980Z          Args:
2026-02-20T22:09:13.6192434Z              db: Session de base de données
2026-02-20T22:09:13.6193247Z              user_id: ID de l'utilisateur à supprimer
2026-02-20T22:09:13.6193736Z -            
2026-02-20T22:09:13.6194017Z +
2026-02-20T22:09:13.6194277Z          Returns:
2026-02-20T22:09:13.6194816Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.6195319Z          """
2026-02-20T22:09:13.6195689Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6196157Z          if not user:
2026-02-20T22:09:13.6196921Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour suppression")
2026-02-20T22:09:13.6197628Z              return False
2026-02-20T22:09:13.6197972Z -        
2026-02-20T22:09:13.6198237Z +
2026-02-20T22:09:13.6198570Z          return DatabaseAdapter.delete(db, user)
2026-02-20T22:09:13.6199026Z -    
2026-02-20T22:09:13.6199294Z +
2026-02-20T22:09:13.6199559Z      @staticmethod
2026-02-20T22:09:13.6199992Z      def disable_user(db: Session, user_id: int) -> bool:
2026-02-20T22:09:13.6200498Z          """
2026-02-20T22:09:13.6201096Z          Désactive un utilisateur (préférable à la suppression).
2026-02-20T22:09:13.6201642Z -        
2026-02-20T22:09:13.6201899Z +
2026-02-20T22:09:13.6202130Z          Args:
2026-02-20T22:09:13.6202860Z              db: Session de base de données
2026-02-20T22:09:13.6203717Z              user_id: ID de l'utilisateur à désactiver
2026-02-20T22:09:13.6204184Z -            
2026-02-20T22:09:13.6204472Z +
2026-02-20T22:09:13.6204718Z          Returns:
2026-02-20T22:09:13.6205243Z              True si la désactivation a réussi, False sinon
2026-02-20T22:09:13.6206043Z          """
2026-02-20T22:09:13.6206400Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6206905Z          if not user:
2026-02-20T22:09:13.6207665Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour désactivation")
2026-02-20T22:09:13.6208267Z              return False
2026-02-20T22:09:13.6208545Z -        
2026-02-20T22:09:13.6208773Z +
2026-02-20T22:09:13.6209153Z          return DatabaseAdapter.update(db, user, {"is_active": False})
2026-02-20T22:09:13.6209662Z -    
2026-02-20T22:09:13.6209909Z -    @staticmethod
2026-02-20T22:09:13.6210411Z -    def get_user_stats(db: Session, user_id: int, time_range: str = "30") -> Dict[str, Any]:
2026-02-20T22:09:13.6211024Z +
2026-02-20T22:09:13.6211254Z +    @staticmethod
2026-02-20T22:09:13.6211539Z +    def get_user_stats(
2026-02-20T22:09:13.6211937Z +        db: Session, user_id: int, time_range: str = "30"
2026-02-20T22:09:13.6212406Z +    ) -> Dict[str, Any]:
2026-02-20T22:09:13.6212695Z          """
2026-02-20T22:09:13.6243504Z          Récupère les statistiques d'un utilisateur.
2026-02-20T22:09:13.6244045Z -        
2026-02-20T22:09:13.6244332Z +
2026-02-20T22:09:13.6244599Z          Args:
2026-02-20T22:09:13.6245073Z              db: Session de base de données
2026-02-20T22:09:13.6245550Z              user_id: ID de l'utilisateur
2026-02-20T22:09:13.6246215Z              time_range: Période de temps ("7", "30", "90", "all")
2026-02-20T22:09:13.6246756Z -            
2026-02-20T22:09:13.6247041Z +
2026-02-20T22:09:13.6247312Z          Returns:
2026-02-20T22:09:13.6247778Z              Dictionnaire contenant les statistiques de l'utilisateur
2026-02-20T22:09:13.6248356Z          """
2026-02-20T22:09:13.6248699Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6249171Z          if not user:
2026-02-20T22:09:13.6250048Z -            logger.error(f"Utilisateur avec ID {user_id} non trouvé pour récupération des statistiques")
2026-02-20T22:09:13.6250863Z +            logger.error(
2026-02-20T22:09:13.6251670Z +                f"Utilisateur avec ID {user_id} non trouvé pour récupération des statistiques"
2026-02-20T22:09:13.6252359Z +            )
2026-02-20T22:09:13.6252664Z              return {}
2026-02-20T22:09:13.6253162Z -        
2026-02-20T22:09:13.6253451Z +
2026-02-20T22:09:13.6253700Z          try:
2026-02-20T22:09:13.6254113Z              from datetime import datetime, timedelta, timezone
2026-02-20T22:09:13.6254644Z  
2026-02-20T22:09:13.6255115Z              # Calculer la date de début selon time_range
2026-02-20T22:09:13.6255635Z              date_filter = None
2026-02-20T22:09:13.6256026Z              if time_range != "all":
2026-02-20T22:09:13.6256488Z                  days = int(time_range)
2026-02-20T22:09:13.6257110Z                  date_filter = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:13.6257740Z -            
2026-02-20T22:09:13.6258038Z +
2026-02-20T22:09:13.6258399Z              # Statistiques de base avec filtre temporel
2026-02-20T22:09:13.6259132Z              attempts_query = db.query(Attempt).filter(Attempt.user_id == user_id)
2026-02-20T22:09:13.6259800Z              if date_filter:
2026-02-20T22:09:13.6260436Z -                attempts_query = attempts_query.filter(Attempt.created_at >= date_filter)
2026-02-20T22:09:13.6261130Z -            
2026-02-20T22:09:13.6261512Z +                attempts_query = attempts_query.filter(
2026-02-20T22:09:13.6262051Z +                    Attempt.created_at >= date_filter
2026-02-20T22:09:13.6262511Z +                )
2026-02-20T22:09:13.6262827Z +
2026-02-20T22:09:13.6263376Z              total_attempts = attempts_query.count()
2026-02-20T22:09:13.6264288Z              correct_attempts = attempts_query.filter(Attempt.is_correct == True).count()
2026-02-20T22:09:13.6264878Z -            
2026-02-20T22:09:13.6265121Z +
2026-02-20T22:09:13.6265644Z              # Calculer le taux de réussite (éviter la division par zéro)
2026-02-20T22:09:13.6266441Z -            success_rate = round((correct_attempts / total_attempts) * 100) if total_attempts > 0 else 0
2026-02-20T22:09:13.6267364Z -            
2026-02-20T22:09:13.6267629Z +            success_rate = (
2026-02-20T22:09:13.6268035Z +                round((correct_attempts / total_attempts) * 100)
2026-02-20T22:09:13.6268476Z +                if total_attempts > 0
2026-02-20T22:09:13.6268840Z +                else 0
2026-02-20T22:09:13.6269114Z +            )
2026-02-20T22:09:13.6269365Z +
2026-02-20T22:09:13.6269640Z              # Statistiques par type d'exercice
2026-02-20T22:09:13.6270066Z              exercise_types_stats = {}
2026-02-20T22:09:13.6270414Z -            
2026-02-20T22:09:13.6270660Z +
2026-02-20T22:09:13.6271274Z              # Récupérer les statistiques directement avec SQL brut pour éviter les problèmes d'enum
2026-02-20T22:09:13.6272129Z              # et gérer les types en MAJUSCULES/minuscules mélangés
2026-02-20T22:09:13.6272748Z              # Ajouter le filtre temporel dans la requête SQL
2026-02-20T22:09:13.6303604Z              if date_filter:
2026-02-20T22:09:13.6303982Z                  stats_query = text("""
2026-02-20T22:09:13.6304316Z @@ -251,14 +268,13 @@
2026-02-20T22:09:13.6304612Z                      WHERE a.user_id = :user_id
2026-02-20T22:09:13.6305019Z                        AND a.created_at >= :date_filter
2026-02-20T22:09:13.6305525Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:13.6305934Z                      ORDER BY total DESC
2026-02-20T22:09:13.6306258Z                  """)
2026-02-20T22:09:13.6306565Z -                result = db.execute(stats_query, {
2026-02-20T22:09:13.6306953Z -                    "user_id": user_id,
2026-02-20T22:09:13.6307321Z -                    "date_filter": date_filter
2026-02-20T22:09:13.6307671Z -                })
2026-02-20T22:09:13.6307957Z +                result = db.execute(
2026-02-20T22:09:13.6308421Z +                    stats_query, {"user_id": user_id, "date_filter": date_filter}
2026-02-20T22:09:13.6308929Z +                )
2026-02-20T22:09:13.6309176Z              else:
2026-02-20T22:09:13.6309433Z                  stats_query = text("""
2026-02-20T22:09:13.6309772Z                      SELECT 
2026-02-20T22:09:13.6310201Z                          LOWER(e.exercise_type::text) as exercise_type_normalized,
2026-02-20T22:09:13.6310691Z                          COUNT(*) as total,
2026-02-20T22:09:13.6311025Z @@ -268,65 +284,71 @@
2026-02-20T22:09:13.6311329Z                      WHERE a.user_id = :user_id
2026-02-20T22:09:13.6311735Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:13.6312130Z                      ORDER BY total DESC
2026-02-20T22:09:13.6312465Z                  """)
2026-02-20T22:09:13.6312811Z                  result = db.execute(stats_query, {"user_id": user_id})
2026-02-20T22:09:13.6313427Z -            
2026-02-20T22:09:13.6313669Z +
2026-02-20T22:09:13.6313923Z              stats_rows = result.fetchall()
2026-02-20T22:09:13.6314276Z -            
2026-02-20T22:09:13.6314513Z +
2026-02-20T22:09:13.6314986Z              # Construire le dictionnaire de statistiques par type normalisé
2026-02-20T22:09:13.6315510Z              for row in stats_rows:
2026-02-20T22:09:13.6315869Z                  ex_type_normalized = row[0]
2026-02-20T22:09:13.6316221Z                  total_type = row[1]
2026-02-20T22:09:13.6316568Z                  correct_type = row[2]
2026-02-20T22:09:13.6317140Z -                success_rate_type = round((correct_type / total_type) * 100) if total_type > 0 else 0
2026-02-20T22:09:13.6317747Z -                
2026-02-20T22:09:13.6318014Z +                success_rate_type = (
2026-02-20T22:09:13.6318499Z +                    round((correct_type / total_type) * 100) if total_type > 0 else 0
2026-02-20T22:09:13.6319242Z +                )
2026-02-20T22:09:13.6319495Z +
2026-02-20T22:09:13.6319782Z                  exercise_types_stats[ex_type_normalized] = {
2026-02-20T22:09:13.6320212Z                      "total": total_type,
2026-02-20T22:09:13.6320603Z                      "correct": correct_type,
2026-02-20T22:09:13.6321230Z -                    "success_rate": success_rate_type
2026-02-20T22:09:13.6321652Z +                    "success_rate": success_rate_type,
2026-02-20T22:09:13.6322021Z                  }
2026-02-20T22:09:13.6322265Z -            
2026-02-20T22:09:13.6322494Z +
2026-02-20T22:09:13.6322937Z              # Récupérer les données de progression si disponibles
2026-02-20T22:09:13.6323807Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.6324430Z +            progress_records = (
2026-02-20T22:09:13.6324890Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.6325385Z +            )
2026-02-20T22:09:13.6325654Z              progress_data = {}
2026-02-20T22:09:13.6325949Z -            
2026-02-20T22:09:13.6326179Z +
2026-02-20T22:09:13.6326415Z              for record in progress_records:
2026-02-20T22:09:13.6326814Z                  ex_type = record.exercise_type
2026-02-20T22:09:13.6327226Z                  difficulty = record.difficulty
2026-02-20T22:09:13.6327577Z -                
2026-02-20T22:09:13.6327820Z +
2026-02-20T22:09:13.6328068Z                  if ex_type not in progress_data:
2026-02-20T22:09:13.6328482Z                      progress_data[ex_type] = {}
2026-02-20T22:09:13.6328831Z -                
2026-02-20T22:09:13.6329062Z +
2026-02-20T22:09:13.6329326Z                  progress_data[ex_type][difficulty] = {
2026-02-20T22:09:13.6329769Z                      "mastery_level": record.mastery_level,
2026-02-20T22:09:13.6330187Z                      "streak": record.streak,
2026-02-20T22:09:13.6330610Z                      "highest_streak": record.highest_streak,
2026-02-20T22:09:13.6331065Z                      "total_attempts": record.total_attempts,
2026-02-20T22:09:13.6331521Z -                    "correct_attempts": record.correct_attempts
2026-02-20T22:09:13.6332005Z +                    "correct_attempts": record.correct_attempts,
2026-02-20T22:09:13.6332405Z                  }
2026-02-20T22:09:13.6332646Z -            
2026-02-20T22:09:13.6332865Z +
2026-02-20T22:09:13.6363488Z              # Assembler toutes les statistiques
2026-02-20T22:09:13.6363907Z              stats = {
2026-02-20T22:09:13.6364190Z                  "user_id": user.id,
2026-02-20T22:09:13.6364551Z                  "username": user.username,
2026-02-20T22:09:13.6364986Z                  "user": {
2026-02-20T22:09:13.6365290Z                      "id": user.id,
2026-02-20T22:09:13.6365637Z                      "username": user.username,
2026-02-20T22:09:13.6366019Z                      "role": user.role,
2026-02-20T22:09:13.6366394Z -                    "grade_level": user.grade_level
2026-02-20T22:09:13.6366819Z +                    "grade_level": user.grade_level,
2026-02-20T22:09:13.6367185Z                  },
2026-02-20T22:09:13.6367473Z                  "total_attempts": total_attempts,
2026-02-20T22:09:13.6367910Z                  "correct_attempts": correct_attempts,
2026-02-20T22:09:13.6368331Z                  "success_rate": success_rate,
2026-02-20T22:09:13.6368750Z -                "by_exercise_type": exercise_types_stats
2026-02-20T22:09:13.6369211Z +                "by_exercise_type": exercise_types_stats,
2026-02-20T22:09:13.6369590Z              }
2026-02-20T22:09:13.6369816Z -            
2026-02-20T22:09:13.6370061Z +
2026-02-20T22:09:13.6370518Z              # Ajouter les données de progression si disponibles
2026-02-20T22:09:13.6370971Z              if progress_data:
2026-02-20T22:09:13.6371331Z                  stats["progress"] = progress_data
2026-02-20T22:09:13.6371707Z -            
2026-02-20T22:09:13.6372176Z +
2026-02-20T22:09:13.6372392Z              return stats
2026-02-20T22:09:13.6372674Z -            
2026-02-20T22:09:13.6372905Z +
2026-02-20T22:09:13.6373355Z          except Exception as stats_fetch_error:
2026-02-20T22:09:13.6374141Z -            logger.error(f"Erreur lors de la récupération des statistiques: {stats_fetch_error}")
2026-02-20T22:09:13.6375250Z -            return {"stats_error": "Erreur lors de la récupération des statistiques"} 
2026-02-20T22:09:13.6375825Z \ No newline at end of file
2026-02-20T22:09:13.6376138Z +            logger.error(
2026-02-20T22:09:13.6376712Z +                f"Erreur lors de la récupération des statistiques: {stats_fetch_error}"
2026-02-20T22:09:13.6377227Z +            )
2026-02-20T22:09:13.6377751Z +            return {"stats_error": "Erreur lors de la récupération des statistiques"}
2026-02-20T22:09:13.6378515Z would reformat /home/runner/work/mathakine/mathakine/app/utils/db_utils.py
2026-02-20T22:09:13.6379340Z --- /home/runner/work/mathakine/mathakine/app/utils/db_utils.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6380274Z +++ /home/runner/work/mathakine/mathakine/app/utils/db_utils.py	2026-02-20 22:09:13.623067+00:00
2026-02-20T22:09:13.6380914Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.6381177Z  """
2026-02-20T22:09:13.6381443Z  Utilitaires DB pour les handlers (DRY).
2026-02-20T22:09:13.6381921Z  Context manager pour session + commit/rollback/close.
2026-02-20T22:09:13.6382334Z  """
2026-02-20T22:09:13.6382546Z +
2026-02-20T22:09:13.6382819Z  from contextlib import asynccontextmanager
2026-02-20T22:09:13.6383411Z  from typing import AsyncGenerator
2026-02-20T22:09:13.6383748Z  
2026-02-20T22:09:13.6383990Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.6384321Z  
2026-02-20T22:09:13.6855590Z --- /home/runner/work/mathakine/mathakine/app/utils/email_templates.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6856754Z +++ /home/runner/work/mathakine/mathakine/app/utils/email_templates.py	2026-02-20 22:09:13.683943+00:00
2026-02-20T22:09:13.6857535Z @@ -1,19 +1,19 @@
2026-02-20T22:09:13.6857792Z  """
2026-02-20T22:09:13.6858526Z  Templates emails Mathakine - Thème Jedi / L'Ordre des Mathématiques
2026-02-20T22:09:13.6859288Z  Design unifié, ergonomique et accessible pour tous les clients email.
2026-02-20T22:09:13.6859797Z  """
2026-02-20T22:09:13.6860016Z +
2026-02-20T22:09:13.6860280Z  from typing import Optional
2026-02-20T22:09:13.6860577Z -
2026-02-20T22:09:13.6860792Z  
2026-02-20T22:09:13.6861209Z  # Couleurs du thème Jedi/Space (compatible clients email)
2026-02-20T22:09:13.6861651Z  THEME = {
2026-02-20T22:09:13.6861953Z -    "bg_dark": "#0f172a",       # Fond header (espace)
2026-02-20T22:09:13.6862394Z -    "bg_content": "#ffffff",    # Corps du message
2026-02-20T22:09:13.6862829Z -    "accent": "#06b6d4",        # Cyan (lame de sabre)
2026-02-20T22:09:13.6863439Z +    "bg_dark": "#0f172a",  # Fond header (espace)
2026-02-20T22:09:13.6863869Z +    "bg_content": "#ffffff",  # Corps du message
2026-02-20T22:09:13.6864292Z +    "accent": "#06b6d4",  # Cyan (lame de sabre)
2026-02-20T22:09:13.6864678Z      "accent_hover": "#0891b2",
2026-02-20T22:09:13.6865020Z -    "gold": "#f59e0b",          # Sagesse Jedi
2026-02-20T22:09:13.6865395Z +    "gold": "#f59e0b",  # Sagesse Jedi
2026-02-20T22:09:13.6865744Z      "text_dark": "#1e293b",
2026-02-20T22:09:13.6866047Z      "text_light": "#e2e8f0",
2026-02-20T22:09:13.6866385Z      "text_muted": "#64748b",
2026-02-20T22:09:13.6866678Z      "border": "#e2e8f0",
2026-02-20T22:09:13.6866953Z  }
2026-02-20T22:09:13.6867639Z would reformat /home/runner/work/mathakine/mathakine/app/utils/email_templates.py
2026-02-20T22:09:13.7805050Z --- /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.7806521Z +++ /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py	2026-02-20 22:09:13.776768+00:00
2026-02-20T22:09:13.7807402Z @@ -1,63 +1,63 @@
2026-02-20T22:09:13.7809535Z  """
2026-02-20T22:09:13.7824149Z would reformat /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py
2026-02-20T22:09:13.7825869Z  Utilitaires pour la gestion des valeurs d'énumération PostgreSQL.
2026-02-20T22:09:13.7826911Z  """
2026-02-20T22:09:13.7827397Z +
2026-02-20T22:09:13.7827782Z  from typing import Any, Dict, Optional
2026-02-20T22:09:13.7828228Z  
2026-02-20T22:09:13.7828544Z  from sqlalchemy import inspect
2026-02-20T22:09:13.7829307Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.7829719Z  
2026-02-20T22:09:13.7829959Z  
2026-02-20T22:09:13.7830283Z  def get_db_engine(db_session: Session) -> str:
2026-02-20T22:09:13.7830721Z      """
2026-02-20T22:09:13.7831383Z      Détecte le moteur de base de données utilisé (postgresql ou sqlite).
2026-02-20T22:09:13.7831990Z -    
2026-02-20T22:09:13.7832235Z +
2026-02-20T22:09:13.7832460Z      Args:
2026-02-20T22:09:13.7832857Z          db_session: Session de base de données
2026-02-20T22:09:13.7833504Z -        
2026-02-20T22:09:13.7833729Z +
2026-02-20T22:09:13.7833959Z      Returns:
2026-02-20T22:09:13.7834517Z          Nom du moteur de base de données ('postgresql' ou 'sqlite')
2026-02-20T22:09:13.7835053Z      """
2026-02-20T22:09:13.7835392Z      engine_name = db_session.bind.engine.name
2026-02-20T22:09:13.7835867Z      return engine_name
2026-02-20T22:09:13.7836202Z  
2026-02-20T22:09:13.7836441Z +
2026-02-20T22:09:13.7836775Z  def is_postgresql(db_session: Session) -> bool:
2026-02-20T22:09:13.7837260Z      """
2026-02-20T22:09:13.7837785Z      Vérifie si le moteur de base de données est PostgreSQL.
2026-02-20T22:09:13.7838296Z -    
2026-02-20T22:09:13.7838566Z +
2026-02-20T22:09:13.7838813Z      Args:
2026-02-20T22:09:13.7839246Z          db_session: Session de base de données
2026-02-20T22:09:13.7839757Z -        
2026-02-20T22:09:13.7840015Z +
2026-02-20T22:09:13.7840265Z      Returns:
2026-02-20T22:09:13.7840619Z          True si le moteur est PostgreSQL, False sinon
2026-02-20T22:09:13.7841091Z      """
2026-02-20T22:09:13.7841398Z      engine_name = get_db_engine(db_session)
2026-02-20T22:09:13.7841889Z -    return engine_name == 'postgresql'
2026-02-20T22:09:13.7842346Z +    return engine_name == "postgresql"
2026-02-20T22:09:13.7842751Z +
2026-02-20T22:09:13.7843166Z  
2026-02-20T22:09:13.7843661Z  # Mapping des valeurs d'énumération pour PostgreSQL
2026-02-20T22:09:13.7844271Z  # Format: (nom_enum, valeur_python): valeur_postgresql
2026-02-20T22:09:13.7844787Z  ENUM_MAPPING = {
2026-02-20T22:09:13.7845152Z      # UserRole - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7845626Z      ("UserRole", "padawan"): "PADAWAN",
2026-02-20T22:09:13.7846101Z      ("UserRole", "maitre"): "MAITRE",
2026-02-20T22:09:13.7846521Z      ("UserRole", "gardien"): "GARDIEN",
2026-02-20T22:09:13.7846984Z      ("UserRole", "archiviste"): "ARCHIVISTE",
2026-02-20T22:09:13.7847857Z      # Note: Le rôle ADMIN a été supprimé - ARCHIVISTE est maintenant le rôle admin suprême
2026-02-20T22:09:13.7848539Z -    
2026-02-20T22:09:13.7848887Z -    # ExerciseType - Valeurs PostgreSQL exactes  
2026-02-20T22:09:13.7849443Z +    # ExerciseType - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7849952Z      ("ExerciseType", "addition"): "ADDITION",
2026-02-20T22:09:13.7850463Z      ("ExerciseType", "soustraction"): "SOUSTRACTION",
2026-02-20T22:09:13.7851057Z      ("ExerciseType", "multiplication"): "MULTIPLICATION",
2026-02-20T22:09:13.7851599Z      ("ExerciseType", "division"): "DIVISION",
2026-02-20T22:09:13.7852077Z      ("ExerciseType", "mixed"): "MIXED",
2026-02-20T22:09:13.7852471Z -    
2026-02-20T22:09:13.7852817Z      # DifficultyLevel - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7853545Z      ("DifficultyLevel", "initie"): "INITIE",
2026-02-20T22:09:13.7854047Z -    ("DifficultyLevel", "padawan"): "PADAWAN", 
2026-02-20T22:09:13.7854573Z +    ("DifficultyLevel", "padawan"): "PADAWAN",
2026-02-20T22:09:13.7855069Z      ("DifficultyLevel", "chevalier"): "CHEVALIER",
2026-02-20T22:09:13.7855579Z      ("DifficultyLevel", "maitre"): "MAITRE",
2026-02-20T22:09:13.7856001Z -    
2026-02-20T22:09:13.7856315Z      # LogicChallengeType - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7857155Z      ("LogicChallengeType", "sequence"): "SEQUENCE",
2026-02-20T22:09:13.7857691Z      ("LogicChallengeType", "pattern"): "PATTERN",
2026-02-20T22:09:13.7858222Z      ("LogicChallengeType", "visual"): "VISUAL",
2026-02-20T22:09:13.7858732Z      ("LogicChallengeType", "puzzle"): "PUZZLE",
2026-02-20T22:09:13.7859394Z @@ -67,95 +67,97 @@
2026-02-20T22:09:13.7859805Z      ("LogicChallengeType", "probability"): "PROBABILITY",
2026-02-20T22:09:13.7860360Z      ("LogicChallengeType", "graph"): "GRAPH",
2026-02-20T22:09:13.7923703Z      ("LogicChallengeType", "coding"): "CODING",
2026-02-20T22:09:13.7924277Z      ("LogicChallengeType", "chess"): "CHESS",
2026-02-20T22:09:13.7924790Z      ("LogicChallengeType", "custom"): "CUSTOM",
2026-02-20T22:09:13.7925224Z -    
2026-02-20T22:09:13.7925612Z      # AgeGroup - Mapping complet Python vers PostgreSQL
2026-02-20T22:09:13.7926251Z -    ("AgeGroup", "enfant"): "GROUP_10_12",       # enfant => 10-12
2026-02-20T22:09:13.7926970Z -    ("AgeGroup", "adolescent"): "GROUP_13_15",   # adolescent => 13-15
2026-02-20T22:09:13.7927669Z -    ("AgeGroup", "adulte"): "ALL_AGES",          # adulte => tous ages
2026-02-20T22:09:13.7928342Z -    ("AgeGroup", "age_9_12"): "GROUP_10_12",     # 9-12 => 10-12
2026-02-20T22:09:13.7928971Z -    ("AgeGroup", "age_12_13"): "GROUP_13_15",    # 12-13 => 13-15
2026-02-20T22:09:13.7929610Z +    ("AgeGroup", "enfant"): "GROUP_10_12",  # enfant => 10-12
2026-02-20T22:09:13.7930272Z +    ("AgeGroup", "adolescent"): "GROUP_13_15",  # adolescent => 13-15
2026-02-20T22:09:13.7930934Z +    ("AgeGroup", "adulte"): "ALL_AGES",  # adulte => tous ages
2026-02-20T22:09:13.7931538Z +    ("AgeGroup", "age_9_12"): "GROUP_10_12",  # 9-12 => 10-12
2026-02-20T22:09:13.7932122Z +    ("AgeGroup", "age_12_13"): "GROUP_13_15",  # 12-13 => 13-15
2026-02-20T22:09:13.7932731Z      ("AgeGroup", "age_13_plus"): "GROUP_13_15",  # 13+ => 13-15
2026-02-20T22:09:13.7933514Z -    ("AgeGroup", "9-12"): "GROUP_10_12",         # 9-12 => 10-12
2026-02-20T22:09:13.7934157Z -    ("AgeGroup", "12-13"): "GROUP_13_15",        # 12-13 => 13-15
2026-02-20T22:09:13.7935046Z -    ("AgeGroup", "13+"): "GROUP_13_15",          # 13+ => 13-15 (AJOUTÉ)
2026-02-20T22:09:13.7935682Z +    ("AgeGroup", "9-12"): "GROUP_10_12",  # 9-12 => 10-12
2026-02-20T22:09:13.7936247Z +    ("AgeGroup", "12-13"): "GROUP_13_15",  # 12-13 => 13-15
2026-02-20T22:09:13.7936959Z +    ("AgeGroup", "13+"): "GROUP_13_15",  # 13+ => 13-15 (AJOUTÉ)
2026-02-20T22:09:13.7937596Z      ("AgeGroup", "group_10_12"): "GROUP_10_12",  # exact match
2026-02-20T22:09:13.7938212Z      ("AgeGroup", "group_13_15"): "GROUP_13_15",  # exact match
2026-02-20T22:09:13.7938828Z -    ("AgeGroup", "all_ages"): "ALL_AGES",        # exact match
2026-02-20T22:09:13.7939430Z +    ("AgeGroup", "all_ages"): "ALL_AGES",  # exact match
2026-02-20T22:09:13.7940015Z      # Anciennes valeurs pour compatibilité
2026-02-20T22:09:13.7940485Z      ("AgeGroup", "10-12"): "GROUP_10_12",
2026-02-20T22:09:13.7940906Z      ("AgeGroup", "13-15"): "GROUP_13_15",
2026-02-20T22:09:13.7941309Z      ("AgeGroup", "all"): "ALL_AGES",
2026-02-20T22:09:13.7941686Z  }
2026-02-20T22:09:13.7941934Z  
2026-02-20T22:09:13.7942175Z +
2026-02-20T22:09:13.7942631Z  def get_enum_value(enum_class, value, db: Optional[Session] = None) -> str:
2026-02-20T22:09:13.7943450Z      """
2026-02-20T22:09:13.7944156Z      Récupère la valeur PostgreSQL correspondant à une valeur d'énumération Python.
2026-02-20T22:09:13.7944842Z -    
2026-02-20T22:09:13.7945103Z +
2026-02-20T22:09:13.7945360Z      Args:
2026-02-20T22:09:13.7945923Z          enum_class: Classe d'énumération (ex: UserRole, ExerciseType)
2026-02-20T22:09:13.7946967Z          value: Valeur de l'énumération (peut être une valeur de l'enum ou sa représentation string)
2026-02-20T22:09:13.7948056Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7948682Z -        
2026-02-20T22:09:13.7948953Z +
2026-02-20T22:09:13.7949562Z      Returns:
2026-02-20T22:09:13.7950001Z          Valeur adaptée pour PostgreSQL
2026-02-20T22:09:13.7950421Z      """
2026-02-20T22:09:13.7950742Z      # Si la valeur est None, retourner None
2026-02-20T22:09:13.7951175Z      if value is None:
2026-02-20T22:09:13.7951515Z          return None
2026-02-20T22:09:13.7951812Z -    
2026-02-20T22:09:13.7952306Z +
2026-02-20T22:09:13.7952726Z      # Obtenir le nom de la classe d'énumération
2026-02-20T22:09:13.7953407Z      enum_name = enum_class.__name__
2026-02-20T22:09:13.7953809Z -    
2026-02-20T22:09:13.7954058Z +
2026-02-20T22:09:13.7954372Z      # Si c'est un objet enum, obtenir sa valeur
2026-02-20T22:09:13.7954967Z -    enum_value = value.value if hasattr(value, 'value') else value
2026-02-20T22:09:13.7955525Z -    
2026-02-20T22:09:13.7955912Z +    enum_value = value.value if hasattr(value, "value") else value
2026-02-20T22:09:13.7956441Z +
2026-02-20T22:09:13.7956706Z      # Chercher dans le mapping
2026-02-20T22:09:13.7957116Z      mapping_key = (enum_name, enum_value)
2026-02-20T22:09:13.7957581Z      if mapping_key in ENUM_MAPPING:
2026-02-20T22:09:13.7957996Z          return ENUM_MAPPING[mapping_key]
2026-02-20T22:09:13.7958399Z -    
2026-02-20T22:09:13.7958645Z +
2026-02-20T22:09:13.7959329Z      # Si pas trouvé, utiliser la valeur telle quelle mais en majuscules pour PostgreSQL
2026-02-20T22:09:13.7960043Z      return str(enum_value).upper()
2026-02-20T22:09:13.7960423Z  
2026-02-20T22:09:13.7960652Z +
2026-02-20T22:09:13.7961162Z  def adapt_enum_for_db(enum_name: str, value: str, db: Optional[Session] = None) -> str:
2026-02-20T22:09:13.7961815Z      """
2026-02-20T22:09:13.7962332Z      Adapte une valeur d'énumération textuelle pour PostgreSQL.
2026-02-20T22:09:13.7962857Z -    
2026-02-20T22:09:13.7963305Z +
2026-02-20T22:09:13.7963554Z      Args:
2026-02-20T22:09:13.7964167Z          enum_name: Nom de la classe d'énumération (ex: 'UserRole', 'ExerciseType')
2026-02-20T22:09:13.7964950Z          value: Valeur textuelle de l'énumération
2026-02-20T22:09:13.7965754Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7966374Z -        
2026-02-20T22:09:13.7966630Z +
2026-02-20T22:09:13.7966876Z      Returns:
2026-02-20T22:09:13.7967290Z          Valeur adaptée pour PostgreSQL
2026-02-20T22:09:13.7967696Z      """
2026-02-20T22:09:13.7967980Z      # Chercher dans le mapping
2026-02-20T22:09:13.7968384Z      mapping_key = (enum_name, value)
2026-02-20T22:09:13.7968826Z      if mapping_key in ENUM_MAPPING:
2026-02-20T22:09:13.7969255Z          return ENUM_MAPPING[mapping_key]
2026-02-20T22:09:13.7969677Z -    
2026-02-20T22:09:13.7969921Z +
2026-02-20T22:09:13.7970452Z      # Si pas trouvé dans le mapping, utiliser la valeur en majuscules
2026-02-20T22:09:13.7971025Z      return value.upper()
2026-02-20T22:09:13.7971360Z  
2026-02-20T22:09:13.7971607Z +
2026-02-20T22:09:13.7972039Z  def get_all_enum_values(db: Optional[Session] = None) -> Dict[str, Any]:
2026-02-20T22:09:13.7972627Z      """
2026-02-20T22:09:13.7973321Z      Fournit toutes les valeurs d'énumération pour PostgreSQL.
2026-02-20T22:09:13.7973900Z      Utile pour les tests et fixtures.
2026-02-20T22:09:13.7974284Z -    
2026-02-20T22:09:13.7974535Z +
2026-02-20T22:09:13.7974773Z      Args:
2026-02-20T22:09:13.7975347Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7975962Z -        
2026-02-20T22:09:13.7976242Z +
2026-02-20T22:09:13.7976491Z      Returns:
2026-02-20T22:09:13.7977131Z          Dictionnaire contenant toutes les valeurs d'énumération adaptées
2026-02-20T22:09:13.7977759Z      """
2026-02-20T22:09:13.7978218Z      from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:13.7979026Z      from app.models.logic_challenge import AgeGroup, LogicChallengeType
2026-02-20T22:09:13.7979696Z      from app.models.user import UserRole
2026-02-20T22:09:13.7980128Z -    
2026-02-20T22:09:13.7980389Z +
2026-02-20T22:09:13.7980648Z      return {
2026-02-20T22:09:13.7981251Z          "engine": "postgresql",
2026-02-20T22:09:13.7981664Z          "user_roles": {
2026-02-20T22:09:13.7982142Z              "padawan": get_enum_value(UserRole, UserRole.PADAWAN),
2026-02-20T22:09:13.7982794Z              "maitre": get_enum_value(UserRole, UserRole.MAITRE),
2026-02-20T22:09:13.7983528Z @@ -170,31 +172,37 @@
2026-02-20T22:09:13.7984305Z              "division": get_enum_value(ExerciseType, ExerciseType.DIVISION),
2026-02-20T22:09:13.7985137Z              "fractions": get_enum_value(ExerciseType, ExerciseType.FRACTIONS),
2026-02-20T22:09:13.7985950Z              "geometrie": get_enum_value(ExerciseType, ExerciseType.GEOMETRIE),
2026-02-20T22:09:13.7986717Z              "texte": get_enum_value(ExerciseType, ExerciseType.TEXTE),
2026-02-20T22:09:13.7987426Z              "mixte": get_enum_value(ExerciseType, ExerciseType.MIXTE),
2026-02-20T22:09:13.7988149Z -            "divers": get_enum_value(ExerciseType, ExerciseType.DIVERS)
2026-02-20T22:09:13.7988891Z +            "divers": get_enum_value(ExerciseType, ExerciseType.DIVERS),
2026-02-20T22:09:13.7989465Z          },
2026-02-20T22:09:13.7989785Z          "difficulty_levels": {
2026-02-20T22:09:13.7990351Z              "initie": get_enum_value(DifficultyLevel, DifficultyLevel.INITIE),
2026-02-20T22:09:13.7991171Z              "padawan": get_enum_value(DifficultyLevel, DifficultyLevel.PADAWAN),
2026-02-20T22:09:13.7992058Z              "chevalier": get_enum_value(DifficultyLevel, DifficultyLevel.CHEVALIER),
2026-02-20T22:09:13.7992921Z -            "maitre": get_enum_value(DifficultyLevel, DifficultyLevel.MAITRE)
2026-02-20T22:09:13.7993941Z +            "maitre": get_enum_value(DifficultyLevel, DifficultyLevel.MAITRE),
2026-02-20T22:09:13.7994544Z          },
2026-02-20T22:09:13.7994859Z          "challenge_types": {
2026-02-20T22:09:13.7995503Z              "sequence": get_enum_value(LogicChallengeType, LogicChallengeType.SEQUENCE),
2026-02-20T22:09:13.7996448Z              "puzzle": get_enum_value(LogicChallengeType, LogicChallengeType.PUZZLE),
2026-02-20T22:09:13.7997385Z              "pattern": get_enum_value(LogicChallengeType, LogicChallengeType.PATTERN),
2026-02-20T22:09:13.7998304Z              "visual": get_enum_value(LogicChallengeType, LogicChallengeType.VISUAL),
2026-02-20T22:09:13.7999201Z              "riddle": get_enum_value(LogicChallengeType, LogicChallengeType.PUZZLE),
2026-02-20T22:09:13.8000167Z -            "deduction": get_enum_value(LogicChallengeType, LogicChallengeType.DEDUCTION),
2026-02-20T22:09:13.8001403Z -            "spatial": get_enum_value(LogicChallengeType, LogicChallengeType.VISUAL),  # SPATIAL fusionné
2026-02-20T22:09:13.8002567Z -            "probability": get_enum_value(LogicChallengeType, LogicChallengeType.PROBABILITY),
2026-02-20T22:09:13.8003566Z +            "deduction": get_enum_value(
2026-02-20T22:09:13.8004152Z +                LogicChallengeType, LogicChallengeType.DEDUCTION
2026-02-20T22:09:13.8004696Z +            ),
2026-02-20T22:09:13.8005040Z +            "spatial": get_enum_value(
2026-02-20T22:09:13.8005557Z +                LogicChallengeType, LogicChallengeType.VISUAL
2026-02-20T22:09:13.8006146Z +            ),  # SPATIAL fusionné
2026-02-20T22:09:13.8006571Z +            "probability": get_enum_value(
2026-02-20T22:09:13.8007138Z +                LogicChallengeType, LogicChallengeType.PROBABILITY
2026-02-20T22:09:13.8007685Z +            ),
2026-02-20T22:09:13.8008218Z              "graph": get_enum_value(LogicChallengeType, LogicChallengeType.GRAPH),
2026-02-20T22:09:13.8009103Z              "coding": get_enum_value(LogicChallengeType, LogicChallengeType.CODING),
2026-02-20T22:09:13.8010053Z              "chess": get_enum_value(LogicChallengeType, LogicChallengeType.CHESS),
2026-02-20T22:09:13.8010910Z -            "custom": get_enum_value(LogicChallengeType, LogicChallengeType.CUSTOM)
2026-02-20T22:09:13.8011812Z +            "custom": get_enum_value(LogicChallengeType, LogicChallengeType.CUSTOM),
2026-02-20T22:09:13.8012476Z          },
2026-02-20T22:09:13.8012786Z          "age_groups": {
2026-02-20T22:09:13.8013718Z              # Seules les 3 valeurs existantes en PostgreSQL
2026-02-20T22:09:13.8014417Z              "group_10_12": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8015178Z              "group_13_15": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8015768Z @@ -213,48 +221,46 @@
2026-02-20T22:09:13.8016498Z              # Legacy values (mappent vers les valeurs existantes)
2026-02-20T22:09:13.8017194Z              "enfant": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8017939Z              "adolescent": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8018664Z              "9-12": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8019326Z              "12-13": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8019978Z -            "13+": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15)
2026-02-20T22:09:13.8020500Z -        }
2026-02-20T22:09:13.8020776Z -    } 
2026-02-20T22:09:13.8021192Z +            "13+": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8021717Z +        },
2026-02-20T22:09:13.8021990Z +    }
2026-02-20T22:09:13.8022255Z +
2026-02-20T22:09:13.8022501Z  
2026-02-20T22:09:13.8022931Z  def get_python_enum_value(enum_class, db_value: str) -> str:
2026-02-20T22:09:13.8023670Z      """
2026-02-20T22:09:13.8024252Z      Convertit une valeur PostgreSQL vers la valeur Python correspondante pour Pydantic.
2026-02-20T22:09:13.8024967Z -    
2026-02-20T22:09:13.8025238Z +
2026-02-20T22:09:13.8025492Z      Args:
2026-02-20T22:09:13.8026154Z          enum_class: La classe d'énumération Python (ex: UserRole, AgeGroup)
2026-02-20T22:09:13.8027195Z          db_value: La valeur stockée dans PostgreSQL (ex: "PADAWAN", "GROUP_10_12")
2026-02-20T22:09:13.8027844Z -    
2026-02-20T22:09:13.8028118Z +
2026-02-20T22:09:13.8028374Z      Returns:
2026-02-20T22:09:13.8028813Z          La valeur Python correspondante (ex: "padawan", "10-12")
2026-02-20T22:09:13.8029356Z      """
2026-02-20T22:09:13.8029669Z      enum_name = enum_class.__name__
2026-02-20T22:09:13.8030072Z -    
2026-02-20T22:09:13.8030346Z +
2026-02-20T22:09:13.8030673Z      # Mapping inverse PostgreSQL -> Python
2026-02-20T22:09:13.8031159Z      reverse_mapping = {
2026-02-20T22:09:13.8031519Z          # UserRole
2026-02-20T22:09:13.8031879Z          ("UserRole", "PADAWAN"): "padawan",
2026-02-20T22:09:13.8032352Z -        ("UserRole", "MAITRE"): "maitre", 
2026-02-20T22:09:13.8032812Z +        ("UserRole", "MAITRE"): "maitre",
2026-02-20T22:09:13.8033479Z          ("UserRole", "GARDIEN"): "gardien",
2026-02-20T22:09:13.8033971Z          ("UserRole", "ARCHIVISTE"): "archiviste",
2026-02-20T22:09:13.8034441Z -        
2026-02-20T22:09:13.8034724Z          # ExerciseType
2026-02-20T22:09:13.8035126Z          ("ExerciseType", "ADDITION"): "addition",
2026-02-20T22:09:13.8035677Z          ("ExerciseType", "SOUSTRACTION"): "soustraction",
2026-02-20T22:09:13.8036296Z          ("ExerciseType", "MULTIPLICATION"): "multiplication",
2026-02-20T22:09:13.8036900Z          ("ExerciseType", "DIVISION"): "division",
2026-02-20T22:09:13.8037401Z          ("ExerciseType", "MIXED"): "mixed",
2026-02-20T22:09:13.8037832Z -        
2026-02-20T22:09:13.8038147Z          # DifficultyLevel
2026-02-20T22:09:13.8038565Z          ("DifficultyLevel", "INITIE"): "initie",
2026-02-20T22:09:13.8039097Z          ("DifficultyLevel", "PADAWAN"): "padawan",
2026-02-20T22:09:13.8039677Z -        ("DifficultyLevel", "CHEVALIER"): "chevalier", 
2026-02-20T22:09:13.8040280Z +        ("DifficultyLevel", "CHEVALIER"): "chevalier",
2026-02-20T22:09:13.8040824Z          ("DifficultyLevel", "MAITRE"): "maitre",
2026-02-20T22:09:13.8041288Z -        
2026-02-20T22:09:13.8041597Z          # LogicChallengeType
2026-02-20T22:09:13.8042076Z          ("LogicChallengeType", "SEQUENCE"): "sequence",
2026-02-20T22:09:13.8042653Z          ("LogicChallengeType", "PATTERN"): "pattern",
2026-02-20T22:09:13.8043446Z          ("LogicChallengeType", "VISUAL"): "visual",
2026-02-20T22:09:13.8044327Z          ("LogicChallengeType", "PUZZLE"): "puzzle",
2026-02-20T22:09:13.8044823Z @@ -264,24 +270,23 @@
2026-02-20T22:09:13.8045271Z          ("LogicChallengeType", "PROBABILITY"): "probability",
2026-02-20T22:09:13.8045856Z          ("LogicChallengeType", "GRAPH"): "graph",
2026-02-20T22:09:13.8046613Z          ("LogicChallengeType", "CODING"): "coding",
2026-02-20T22:09:13.8047115Z          ("LogicChallengeType", "CHESS"): "chess",
2026-02-20T22:09:13.8047651Z          ("LogicChallengeType", "CUSTOM"): "custom",
2026-02-20T22:09:13.8048113Z -        
2026-02-20T22:09:13.8048409Z          # AgeGroup
2026-02-20T22:09:13.8048768Z          ("AgeGroup", "GROUP_10_12"): "10-12",
2026-02-20T22:09:13.8049246Z          ("AgeGroup", "GROUP_13_15"): "13-15",
2026-02-20T22:09:13.8049709Z          ("AgeGroup", "ALL_AGES"): "all",
2026-02-20T22:09:13.8050125Z      }
2026-02-20T22:09:13.8050402Z -    
2026-02-20T22:09:13.8050668Z +
2026-02-20T22:09:13.8050981Z      # Chercher dans le mapping inverse
2026-02-20T22:09:13.8051463Z      key = (enum_name, db_value)
2026-02-20T22:09:13.8051882Z      if key in reverse_mapping:
2026-02-20T22:09:13.8052295Z          return reverse_mapping[key]
2026-02-20T22:09:13.8052701Z -    
2026-02-20T22:09:13.8053148Z +
2026-02-20T22:09:13.8053700Z      # Si pas trouvé, essayer de deviner selon les patterns
2026-02-20T22:09:13.8054285Z      if db_value.startswith("GROUP_"):
2026-02-20T22:09:13.8054735Z          # GROUP_10_12 -> 10-12
2026-02-20T22:09:13.8055250Z          return db_value.replace("GROUP_", "").replace("_", "-")
2026-02-20T22:09:13.8055777Z -    
2026-02-20T22:09:13.8056046Z +
2026-02-20T22:09:13.8056466Z      # Par défaut, retourner en minuscules
2026-02-20T22:09:13.8056934Z -    return db_value.lower() 
2026-02-20T22:09:13.8057333Z \ No newline at end of file
2026-02-20T22:09:13.8057716Z +    return db_value.lower()
2026-02-20T22:09:13.8058597Z would reformat /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py
2026-02-20T22:09:13.8059882Z --- /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.8061301Z +++ /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py	2026-02-20 22:09:13.798723+00:00
2026-02-20T22:09:13.8062219Z @@ -13,13 +13,14 @@
2026-02-20T22:09:13.8062675Z  from app.models.recommendation import Recommendation
2026-02-20T22:09:13.8063436Z  from app.models.user import User
2026-02-20T22:09:13.8063843Z  
2026-02-20T22:09:13.8064127Z  logger = get_logger(__name__)
2026-02-20T22:09:13.8064484Z  
2026-02-20T22:09:13.8064734Z +
2026-02-20T22:09:13.8065020Z  class RecommendationService:
2026-02-20T22:09:13.8065936Z      """Service analysant les performances et générant des recommandations personnalisées"""
2026-02-20T22:09:13.8066700Z -    
2026-02-20T22:09:13.8066985Z +
2026-02-20T22:09:13.8067246Z      @staticmethod
2026-02-20T22:09:13.8067634Z      def generate_recommendations(db, user_id):
2026-02-20T22:09:13.8068513Z          """Génère des recommandations pour un utilisateur basé sur ses performances
2026-02-20T22:09:13.8069191Z  
2026-02-20T22:09:13.8069481Z          Args:
2026-02-20T22:09:13.8069779Z @@ -31,406 +32,508 @@
2026-02-20T22:09:13.8070100Z          """
2026-02-20T22:09:13.8070377Z          try:
2026-02-20T22:09:13.8070851Z              # Récupérer les données utilisateur
2026-02-20T22:09:13.8071541Z              user_exists = db.query(exists().where(User.id == user_id)).scalar()
2026-02-20T22:09:13.8072181Z              if not user_exists:
2026-02-20T22:09:13.8073424Z -                logger.warning(f"Tentative de génération de recommandations pour un utilisateur inexistant: {user_id}")
2026-02-20T22:09:13.8074348Z +                logger.warning(
2026-02-20T22:09:13.8075267Z +                    f"Tentative de génération de recommandations pour un utilisateur inexistant: {user_id}"
2026-02-20T22:09:13.8076044Z +                )
2026-02-20T22:09:13.8076381Z                  return []
2026-02-20T22:09:13.8077021Z -            
2026-02-20T22:09:13.8077324Z +
2026-02-20T22:09:13.8077738Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:13.8078300Z              if not user:
2026-02-20T22:09:13.8078916Z                  logger.error(f"Utilisateur {user_id} non trouvé")
2026-02-20T22:09:13.8079462Z                  return []
2026-02-20T22:09:13.8080065Z  
2026-02-20T22:09:13.8080688Z              # Récupérer les stats récentes (30 derniers jours) pour mieux cibler
2026-02-20T22:09:13.8081440Z              from app.services.user_service import UserService
2026-02-20T22:09:13.8081953Z +
2026-02-20T22:09:13.8082465Z              recent_stats = UserService.get_user_stats(db, user_id, time_range="30")
2026-02-20T22:09:13.8083523Z              performance_by_type = recent_stats.get("by_exercise_type", {})
2026-02-20T22:09:13.8084129Z -            
2026-02-20T22:09:13.8084423Z +
2026-02-20T22:09:13.8084882Z              # Analyser les performances récentes
2026-02-20T22:09:13.8085662Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.8086456Z -            recent_attempts = db.query(Attempt).filter(
2026-02-20T22:09:13.8086996Z -                Attempt.user_id == user_id,
2026-02-20T22:09:13.8087664Z -                Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=30)
2026-02-20T22:09:13.8088461Z -            ).order_by(Attempt.created_at.desc()).limit(50).all()
2026-02-20T22:09:13.8088980Z -            
2026-02-20T22:09:13.8089312Z +            progress_records = (
2026-02-20T22:09:13.8089867Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.8090431Z +            )
2026-02-20T22:09:13.8090741Z +            recent_attempts = (
2026-02-20T22:09:13.8091100Z +                db.query(Attempt)
2026-02-20T22:09:13.8091460Z +                .filter(
2026-02-20T22:09:13.8091820Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:13.8092277Z +                    Attempt.created_at
2026-02-20T22:09:13.8092788Z +                    > datetime.now(timezone.utc) - timedelta(days=30),
2026-02-20T22:09:13.8093500Z +                )
2026-02-20T22:09:13.8093870Z +                .order_by(Attempt.created_at.desc())
2026-02-20T22:09:13.8094339Z +                .limit(50)
2026-02-20T22:09:13.8094708Z +                .all()
2026-02-20T22:09:13.8095018Z +            )
2026-02-20T22:09:13.8095299Z +
2026-02-20T22:09:13.8096083Z              # Récupérer les exercices complétés dans les 7 derniers jours pour éviter les doublons
2026-02-20T22:09:13.8096897Z              recently_completed_exercise_ids = set()
2026-02-20T22:09:13.8097496Z -            recent_completed_attempts = db.query(Attempt).filter(
2026-02-20T22:09:13.8098082Z -                Attempt.user_id == user_id,
2026-02-20T22:09:13.8098547Z -                Attempt.is_correct == True,
2026-02-20T22:09:13.8099181Z -                Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=7)
2026-02-20T22:09:13.8099837Z -            ).all()
2026-02-20T22:09:13.8100177Z +            recent_completed_attempts = (
2026-02-20T22:09:13.8100619Z +                db.query(Attempt)
2026-02-20T22:09:13.8101001Z +                .filter(
2026-02-20T22:09:13.8101386Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:13.8101864Z +                    Attempt.is_correct == True,
2026-02-20T22:09:13.8102553Z +                    Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=7),
2026-02-20T22:09:13.8103392Z +                )
2026-02-20T22:09:13.8103702Z +                .all()
2026-02-20T22:09:13.8104023Z +            )
2026-02-20T22:09:13.8104381Z              for attempt in recent_completed_attempts:
2026-02-20T22:09:13.8104894Z                  if attempt.exercise_id:
2026-02-20T22:09:13.8105471Z                      recently_completed_exercise_ids.add(attempt.exercise_id)
2026-02-20T22:09:13.8106037Z -            
2026-02-20T22:09:13.8106317Z +
2026-02-20T22:09:13.8107129Z              # Supprimer les anciennes recommandations non complétées
2026-02-20T22:09:13.8107739Z              db.query(Recommendation).filter(
2026-02-20T22:09:13.8108219Z -                Recommendation.user_id == user_id,
2026-02-20T22:09:13.8108749Z -                Recommendation.is_completed == False
2026-02-20T22:09:13.8109525Z +                Recommendation.user_id == user_id, Recommendation.is_completed == False
2026-02-20T22:09:13.8110482Z              ).delete()
2026-02-20T22:09:13.8110801Z -            
2026-02-20T22:09:13.8111076Z +
2026-02-20T22:09:13.8111499Z              # Générer de nouvelles recommandations
2026-02-20T22:09:13.8111971Z              recommendations = []
2026-02-20T22:09:13.8112347Z -            
2026-02-20T22:09:13.8112616Z +
2026-02-20T22:09:13.8113589Z              # 1. Recommandations basées sur les domaines à améliorer (utilisant les stats récentes)
2026-02-20T22:09:13.8114598Z              # Prioriser les types avec faible taux de réussite récent
2026-02-20T22:09:13.8115323Z              for ex_type_key, type_stats in performance_by_type.items():
2026-02-20T22:09:13.8116218Z                  # Normaliser le type d'exercice (peut être en minuscules depuis SQL)
2026-02-20T22:09:13.8116912Z                  ex_type = str(ex_type_key).lower()
2026-02-20T22:09:13.8117471Z                  success_rate = type_stats.get("success_rate", 0)
2026-02-20T22:09:13.8118035Z                  total = type_stats.get("total", 0)
2026-02-20T22:09:13.8118476Z -                
2026-02-20T22:09:13.8118762Z +
2026-02-20T22:09:13.8119516Z                  # Seulement recommander si au moins 3 tentatives récentes pour avoir des données fiables
2026-02-20T22:09:13.8120318Z                  if total >= 3 and success_rate < 70:
2026-02-20T22:09:13.8121011Z                      # Déterminer la priorité selon le taux de réussite
2026-02-20T22:09:13.8121576Z                      if success_rate < 50:
2026-02-20T22:09:13.8122023Z                          priority = 9  # Urgent
2026-02-20T22:09:13.8123254Z                          reason = f"Votre taux de réussite en {ex_type} est de {success_rate}%. Continuons à progresser !"
2026-02-20T22:09:13.8124073Z                      else:
2026-02-20T22:09:13.8124463Z                          priority = 8  # Important
2026-02-20T22:09:13.8125371Z                          reason = f"Pour améliorer votre taux de réussite en {ex_type} ({success_rate}%)"
2026-02-20T22:09:13.8126100Z -                    
2026-02-20T22:09:13.8126423Z +
2026-02-20T22:09:13.8126925Z                      # Trouver le niveau de difficulté le plus approprié
2026-02-20T22:09:13.8127878Z                      # Utiliser le niveau le plus pratiqué récemment ou le niveau actuel du Progress
2026-02-20T22:09:13.8128616Z                      target_difficulty = None
2026-02-20T22:09:13.8129121Z                      for progress in progress_records:
2026-02-20T22:09:13.8129697Z                          if str(progress.exercise_type).lower() == ex_type:
2026-02-20T22:09:13.8130328Z                              target_difficulty = progress.difficulty
2026-02-20T22:09:13.8130859Z                              break
2026-02-20T22:09:13.8131224Z -                    
2026-02-20T22:09:13.8131526Z +
2026-02-20T22:09:13.8131812Z                      if not target_difficulty:
2026-02-20T22:09:13.8132448Z                          target_difficulty = "INITIE"  # Par défaut
2026-02-20T22:09:13.8132933Z -                    
2026-02-20T22:09:13.8133418Z +
2026-02-20T22:09:13.8134102Z                      # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8134902Z                      valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8135551Z                      valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8136102Z -                    
2026-02-20T22:09:13.8136399Z +
2026-02-20T22:09:13.8136995Z                      # Trouver des exercices appropriés pour améliorer cette compétence
2026-02-20T22:09:13.8137826Z                      # Utiliser func.lower pour comparer sans tenir compte de la casse
2026-02-20T22:09:13.8138779Z                      exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8139368Z                          func.lower(Exercise.exercise_type) == ex_type,
2026-02-20T22:09:13.8139922Z                          Exercise.difficulty == target_difficulty,
2026-02-20T22:09:13.8140671Z                          Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8141268Z                          Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8141841Z                          Exercise.is_archived == False,
2026-02-20T22:09:13.8142341Z -                        Exercise.is_active == True
2026-02-20T22:09:13.8142792Z -                    )
2026-02-20T22:09:13.8143333Z -                    
2026-02-20T22:09:13.8143699Z +                        Exercise.is_active == True,
2026-02-20T22:09:13.8144148Z +                    )
2026-02-20T22:09:13.8144456Z +
2026-02-20T22:09:13.8144934Z                      # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8145516Z                      if recently_completed_exercise_ids:
2026-02-20T22:09:13.8146398Z -                        exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8147243Z -                    
2026-02-20T22:09:13.8147650Z +                        exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8148304Z +                            ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8148887Z +                        )
2026-02-20T22:09:13.8149205Z +
2026-02-20T22:09:13.8149667Z                      exercises = exercise_query.order_by(func.random()).limit(2).all()
2026-02-20T22:09:13.8150282Z -                    
2026-02-20T22:09:13.8150586Z +
2026-02-20T22:09:13.8150853Z                      for ex in exercises:
2026-02-20T22:09:13.8151535Z                          # Vérifier si l'utilisateur a déjà fait cet exercice
2026-02-20T22:09:13.8152205Z -                        existing_attempt = db.query(Attempt).filter(
2026-02-20T22:09:13.8152783Z -                            Attempt.user_id == user_id,
2026-02-20T22:09:13.8153483Z -                            Attempt.exercise_id == ex.id
2026-02-20T22:09:13.8153950Z -                        ).first()
2026-02-20T22:09:13.8154335Z -                        
2026-02-20T22:09:13.8154697Z +                        existing_attempt = (
2026-02-20T22:09:13.8155156Z +                            db.query(Attempt)
2026-02-20T22:09:13.8155582Z +                            .filter(
2026-02-20T22:09:13.8156145Z +                                Attempt.user_id == user_id, Attempt.exercise_id == ex.id
2026-02-20T22:09:13.8156744Z +                            )
2026-02-20T22:09:13.8157102Z +                            .first()
2026-02-20T22:09:13.8157481Z +                        )
2026-02-20T22:09:13.8157794Z +
2026-02-20T22:09:13.8158100Z                          if not existing_attempt:
2026-02-20T22:09:13.8158639Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8159182Z -                                user_id=user_id,
2026-02-20T22:09:13.8159679Z -                                exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8160221Z -                                difficulty=ex.difficulty,
2026-02-20T22:09:13.8160746Z -                                exercise_id=ex.id,
2026-02-20T22:09:13.8161216Z -                                priority=priority,
2026-02-20T22:09:13.8161684Z -                                reason=reason
2026-02-20T22:09:13.8162108Z -                            ))
2026-02-20T22:09:13.8162458Z -            
2026-02-20T22:09:13.8162785Z +                            recommendations.append(
2026-02-20T22:09:13.8163448Z +                                Recommendation(
2026-02-20T22:09:13.8163910Z +                                    user_id=user_id,
2026-02-20T22:09:13.8164432Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8165229Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8165747Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8166239Z +                                    priority=priority,
2026-02-20T22:09:13.8166708Z +                                    reason=reason,
2026-02-20T22:09:13.8167341Z +                                )
2026-02-20T22:09:13.8167714Z +                            )
2026-02-20T22:09:13.8168058Z +
2026-02-20T22:09:13.8168787Z              # 2. Recommandations pour monter en niveau (progression) - basé sur stats récentes
2026-02-20T22:09:13.8169675Z              for ex_type_key, type_stats in performance_by_type.items():
2026-02-20T22:09:13.8170287Z                  # Normaliser le type d'exercice
2026-02-20T22:09:13.8170766Z                  ex_type = str(ex_type_key).lower()
2026-02-20T22:09:13.8171321Z                  success_rate = type_stats.get("success_rate", 0)
2026-02-20T22:09:13.8171858Z                  total = type_stats.get("total", 0)
2026-02-20T22:09:13.8172309Z -                
2026-02-20T22:09:13.8172585Z +
2026-02-20T22:09:13.8173539Z                  # Si taux de réussite > 85% avec au moins 5 tentatives récentes, proposer niveau supérieur
2026-02-20T22:09:13.8174338Z                  if total >= 5 and success_rate > 85:
2026-02-20T22:09:13.8174898Z                      # Trouver le niveau actuel depuis Progress
2026-02-20T22:09:13.8175436Z                      current_difficulty = None
2026-02-20T22:09:13.8175924Z                      for progress in progress_records:
2026-02-20T22:09:13.8176502Z                          if str(progress.exercise_type).lower() == ex_type:
2026-02-20T22:09:13.8177130Z                              current_difficulty = progress.difficulty
2026-02-20T22:09:13.8177641Z                              break
2026-02-20T22:09:13.8178011Z -                    
2026-02-20T22:09:13.8178309Z +
2026-02-20T22:09:13.8178473Z                      if not current_difficulty:
2026-02-20T22:09:13.8178875Z                          continue  # Pas de niveau trouvé, passer au suivant
2026-02-20T22:09:13.8178994Z -                    
2026-02-20T22:09:13.8179100Z +
2026-02-20T22:09:13.8179427Z                      # Proposer des exercices du niveau supérieur
2026-02-20T22:09:13.8179870Z -                    next_difficulty = RecommendationService._get_next_difficulty(current_difficulty)
2026-02-20T22:09:13.8180175Z +                    next_difficulty = RecommendationService._get_next_difficulty(
2026-02-20T22:09:13.8180324Z +                        current_difficulty
2026-02-20T22:09:13.8180440Z +                    )
2026-02-20T22:09:13.8180576Z                      if next_difficulty:
2026-02-20T22:09:13.8181137Z                          # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8181368Z                          valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8181635Z                          valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8181766Z -                        
2026-02-20T22:09:13.8181879Z +
2026-02-20T22:09:13.8182077Z                          # Normaliser ex_type pour la comparaison
2026-02-20T22:09:13.8182252Z                          exercise_type_filter = ex_type
2026-02-20T22:09:13.8182429Z                          for enum_type in ExerciseType:
2026-02-20T22:09:13.8182640Z                              if enum_type.value.lower() == ex_type:
2026-02-20T22:09:13.8182852Z                                  exercise_type_filter = enum_type.value
2026-02-20T22:09:13.8183145Z                                  break
2026-02-20T22:09:13.8183272Z -                        
2026-02-20T22:09:13.8183376Z +
2026-02-20T22:09:13.8183583Z                          exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8183824Z                              func.lower(Exercise.exercise_type) == ex_type,
2026-02-20T22:09:13.8184028Z                              Exercise.difficulty == next_difficulty,
2026-02-20T22:09:13.8184440Z                              Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8184686Z                              Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8184870Z                              Exercise.is_archived == False,
2026-02-20T22:09:13.8185037Z -                            Exercise.is_active == True
2026-02-20T22:09:13.8185336Z -                        )
2026-02-20T22:09:13.8185455Z -                        
2026-02-20T22:09:13.8185632Z +                            Exercise.is_active == True,
2026-02-20T22:09:13.8185750Z +                        )
2026-02-20T22:09:13.8185863Z +
2026-02-20T22:09:13.8186205Z                          # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8186398Z                          if recently_completed_exercise_ids:
2026-02-20T22:09:13.8186946Z -                            exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8187080Z -                        
2026-02-20T22:09:13.8187409Z -                        exercises = exercise_query.order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8187519Z -                        
2026-02-20T22:09:13.8187705Z +                            exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8187982Z +                                ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8188097Z +                            )
2026-02-20T22:09:13.8188203Z +
2026-02-20T22:09:13.8188329Z +                        exercises = (
2026-02-20T22:09:13.8188588Z +                            exercise_query.order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8188715Z +                        )
2026-02-20T22:09:13.8188818Z +
2026-02-20T22:09:13.8188969Z                          for ex in exercises:
2026-02-20T22:09:13.8189182Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8189338Z -                                user_id=user_id,
2026-02-20T22:09:13.8189535Z -                                exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8189709Z -                                difficulty=ex.difficulty,
2026-02-20T22:09:13.8189873Z -                                exercise_id=ex.id,
2026-02-20T22:09:13.8190013Z -                                priority=7,
2026-02-20T22:09:13.8190903Z -                                reason=f"Excellent ! Vous avez {success_rate}% de réussite en {ex.exercise_type}. Essayons le niveau {next_difficulty} !"
2026-02-20T22:09:13.8191036Z -                            ))
2026-02-20T22:09:13.8191141Z -            
2026-02-20T22:09:13.8191315Z +                            recommendations.append(
2026-02-20T22:09:13.8191465Z +                                Recommendation(
2026-02-20T22:09:13.8191631Z +                                    user_id=user_id,
2026-02-20T22:09:13.8191827Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8192021Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8192185Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8192323Z +                                    priority=7,
2026-02-20T22:09:13.8193411Z +                                    reason=f"Excellent ! Vous avez {success_rate}% de réussite en {ex.exercise_type}. Essayons le niveau {next_difficulty} !",
2026-02-20T22:09:13.8193567Z +                                )
2026-02-20T22:09:13.8193688Z +                            )
2026-02-20T22:09:13.8193790Z +
2026-02-20T22:09:13.8194240Z              # 3. Recommandations pour maintenir les compétences (réactivation)
2026-02-20T22:09:13.8194584Z              # Trouver les compétences non pratiquées récemment
2026-02-20T22:09:13.8195207Z              # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides dès le départ
2026-02-20T22:09:13.8195422Z              valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8195913Z              valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8196042Z -            
2026-02-20T22:09:13.8196336Z -            all_exercise_types = db.query(Exercise.exercise_type).filter(
2026-02-20T22:09:13.8196544Z -                Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8196755Z -                Exercise.difficulty.in_(valid_difficulties)
2026-02-20T22:09:13.8197111Z -            ).distinct().all()
2026-02-20T22:09:13.8197230Z -            
2026-02-20T22:09:13.8197336Z +
2026-02-20T22:09:13.8197475Z +            all_exercise_types = (
2026-02-20T22:09:13.8197646Z +                db.query(Exercise.exercise_type)
2026-02-20T22:09:13.8197768Z +                .filter(
2026-02-20T22:09:13.8197967Z +                    Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8198184Z +                    Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8198296Z +                )
2026-02-20T22:09:13.8198414Z +                .distinct()
2026-02-20T22:09:13.8198529Z +                .all()
2026-02-20T22:09:13.8198629Z +            )
2026-02-20T22:09:13.8198740Z +
2026-02-20T22:09:13.8198901Z              for ex_type in all_exercise_types:
2026-02-20T22:09:13.8199098Z                  ex_type = ex_type[0]  # Extraction du tuple
2026-02-20T22:09:13.8199515Z                  # Vérifier si ce type d'exercice a été pratiqué récemment
2026-02-20T22:09:13.8199993Z                  # Utiliser une requête filtrée pour éviter les erreurs d'énumération
2026-02-20T22:09:13.8200149Z                  recent_type_attempts = []
2026-02-20T22:09:13.8200305Z                  for a in recent_attempts:
2026-02-20T22:09:13.8200489Z -                    exercise = db.query(Exercise).filter(
2026-02-20T22:09:13.8200659Z -                        Exercise.id == a.exercise_id,
2026-02-20T22:09:13.8200864Z -                        Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8201089Z -                        Exercise.difficulty.in_(valid_difficulties)
2026-02-20T22:09:13.8201229Z -                    ).first()
2026-02-20T22:09:13.8201355Z +                    exercise = (
2026-02-20T22:09:13.8201504Z +                        db.query(Exercise)
2026-02-20T22:09:13.8201624Z +                        .filter(
2026-02-20T22:09:13.8201794Z +                            Exercise.id == a.exercise_id,
2026-02-20T22:09:13.8202026Z +                            Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8202255Z +                            Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8202372Z +                        )
2026-02-20T22:09:13.8202487Z +                        .first()
2026-02-20T22:09:13.8202606Z +                    )
2026-02-20T22:09:13.8202844Z                      if exercise and exercise.exercise_type == ex_type:
2026-02-20T22:09:13.8203213Z                          recent_type_attempts.append(a)
2026-02-20T22:09:13.8203345Z -                
2026-02-20T22:09:13.8203449Z +
2026-02-20T22:09:13.8203613Z                  if not recent_type_attempts:
2026-02-20T22:09:13.8204150Z                      # Trouver le niveau le plus élevé maîtrisé par l'utilisateur pour ce type
2026-02-20T22:09:13.8204290Z                      user_level = None
2026-02-20T22:09:13.8204455Z                      for p in progress_records:
2026-02-20T22:09:13.8204791Z -                        if p.exercise_type == ex_type and p.calculate_completion_rate() > 70:
2026-02-20T22:09:13.8204937Z +                        if (
2026-02-20T22:09:13.8205105Z +                            p.exercise_type == ex_type
2026-02-20T22:09:13.8205310Z +                            and p.calculate_completion_rate() > 70
2026-02-20T22:09:13.8205439Z +                        ):
2026-02-20T22:09:13.8205607Z                              user_level = p.difficulty
2026-02-20T22:09:13.8205723Z -                    
2026-02-20T22:09:13.8205836Z +
2026-02-20T22:09:13.8206196Z                      # Si aucun niveau trouvé, proposer le niveau débutant
2026-02-20T22:09:13.8206334Z                      if not user_level:
2026-02-20T22:09:13.8206702Z                          user_level = "INITIE"
2026-02-20T22:09:13.8206827Z -                    
2026-02-20T22:09:13.8206931Z +
2026-02-20T22:09:13.8207318Z                      # Proposer un exercice pour maintenir cette compétence
2026-02-20T22:09:13.8207521Z -                    exercises = db.query(Exercise).filter(
2026-02-20T22:09:13.8207910Z -                        Exercise.exercise_type == ex_type,
2026-02-20T22:09:13.8208098Z -                        Exercise.difficulty == user_level,
2026-02-20T22:09:13.8208229Z +                    exercises = (
2026-02-20T22:09:13.8208375Z +                        db.query(Exercise)
2026-02-20T22:09:13.8208493Z +                        .filter(
2026-02-20T22:09:13.8208688Z +                            Exercise.exercise_type == ex_type,
2026-02-20T22:09:13.8208883Z +                            Exercise.difficulty == user_level,
2026-02-20T22:09:13.8209092Z +                            Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8209412Z +                            Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8209599Z +                            Exercise.is_archived == False,
2026-02-20T22:09:13.8209769Z +                            Exercise.is_active == True,
2026-02-20T22:09:13.8209886Z +                        )
2026-02-20T22:09:13.8210053Z +                        .order_by(func.random())
2026-02-20T22:09:13.8210176Z +                        .limit(1)
2026-02-20T22:09:13.8210290Z +                        .all()
2026-02-20T22:09:13.8210395Z +                    )
2026-02-20T22:09:13.8210506Z +
2026-02-20T22:09:13.8210641Z +                    for ex in exercises:
2026-02-20T22:09:13.8211055Z +                        # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8211300Z +                        if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8211476Z +                            recommendations.append(
2026-02-20T22:09:13.8211638Z +                                Recommendation(
2026-02-20T22:09:13.8211795Z +                                    user_id=user_id,
2026-02-20T22:09:13.8212003Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8212189Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8212361Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8212514Z +                                    priority=5,
2026-02-20T22:09:13.8213204Z +                                    reason=f"Pour maintenir vos compétences en {ex.exercise_type}",
2026-02-20T22:09:13.8213337Z +                                )
2026-02-20T22:09:13.8213465Z +                            )
2026-02-20T22:09:13.8213569Z +
2026-02-20T22:09:13.8213981Z +            # 4. Recommandations de découverte (nouveaux types d'exercices)
2026-02-20T22:09:13.8214295Z +            practised_types = set([p.exercise_type for p in progress_records])
2026-02-20T22:09:13.8214578Z +            all_types = set([ex_type[0] for ex_type in all_exercise_types])
2026-02-20T22:09:13.8214760Z +            new_types = all_types - practised_types
2026-02-20T22:09:13.8214865Z +
2026-02-20T22:09:13.8215014Z +            for new_type in new_types:
2026-02-20T22:09:13.8215533Z +                # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8215752Z +                valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8216014Z +                valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8216119Z +
2026-02-20T22:09:13.8216242Z +                exercises = (
2026-02-20T22:09:13.8216375Z +                    db.query(Exercise)
2026-02-20T22:09:13.8216498Z +                    .filter(
2026-02-20T22:09:13.8216686Z +                        Exercise.exercise_type == new_type,
2026-02-20T22:09:13.8216835Z +                        Exercise.difficulty
2026-02-20T22:09:13.8217080Z +                        == "INITIE",  # Commencer par le niveau le plus simple
2026-02-20T22:09:13.8217497Z                          Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8217726Z                          Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8217903Z                          Exercise.is_archived == False,
2026-02-20T22:09:13.8218228Z -                        Exercise.is_active == True
2026-02-20T22:09:13.8218415Z -                    ).order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8218533Z -                    
2026-02-20T22:09:13.8218672Z -                    for ex in exercises:
2026-02-20T22:09:13.8219069Z -                        # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8219300Z -                        if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8219522Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8219688Z +                        Exercise.is_active == True,
2026-02-20T22:09:13.8219810Z +                    )
2026-02-20T22:09:13.8219961Z +                    .order_by(func.random())
2026-02-20T22:09:13.8220078Z +                    .limit(1)
2026-02-20T22:09:13.8220192Z +                    .all()
2026-02-20T22:09:13.8220305Z +                )
2026-02-20T22:09:13.8220407Z +
2026-02-20T22:09:13.8220552Z +                for ex in exercises:
2026-02-20T22:09:13.8220948Z +                    # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8221179Z +                    if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8221344Z +                        recommendations.append(
2026-02-20T22:09:13.8221483Z +                            Recommendation(
2026-02-20T22:09:13.8221638Z                                  user_id=user_id,
2026-02-20T22:09:13.8221831Z                                  exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8222004Z                                  difficulty=ex.difficulty,
2026-02-20T22:09:13.8222172Z                                  exercise_id=ex.id,
2026-02-20T22:09:13.8222309Z -                                priority=5,
2026-02-20T22:09:13.8222774Z -                                reason=f"Pour maintenir vos compétences en {ex.exercise_type}"
2026-02-20T22:09:13.8222895Z -                            ))
2026-02-20T22:09:13.8223188Z -            
2026-02-20T22:09:13.8223636Z -            # 4. Recommandations de découverte (nouveaux types d'exercices)
2026-02-20T22:09:13.8223961Z -            practised_types = set([p.exercise_type for p in progress_records])
2026-02-20T22:09:13.8224241Z -            all_types = set([ex_type[0] for ex_type in all_exercise_types])
2026-02-20T22:09:13.8224423Z -            new_types = all_types - practised_types
2026-02-20T22:09:13.8224533Z -            
2026-02-20T22:09:13.8224689Z -            for new_type in new_types:
2026-02-20T22:09:13.8225219Z -                # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8225441Z -                valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8225703Z -                valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8225819Z -                
2026-02-20T22:09:13.8225996Z -                exercises = db.query(Exercise).filter(
2026-02-20T22:09:13.8226182Z -                    Exercise.exercise_type == new_type,
2026-02-20T22:09:13.8226575Z -                    Exercise.difficulty == "INITIE",  # Commencer par le niveau le plus simple
2026-02-20T22:09:13.8226774Z -                    Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8226988Z -                    Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8227155Z -                    Exercise.is_archived == False,
2026-02-20T22:09:13.8227309Z -                    Exercise.is_active == True
2026-02-20T22:09:13.8227486Z -                ).order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8227592Z -                
2026-02-20T22:09:13.8227935Z -                for ex in exercises:
2026-02-20T22:09:13.8228325Z -                    # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8228552Z -                    if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8228772Z -                        recommendations.append(Recommendation(
2026-02-20T22:09:13.8229077Z -                            user_id=user_id,
2026-02-20T22:09:13.8229260Z -                            exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8229433Z -                            difficulty=ex.difficulty,
2026-02-20T22:09:13.8229578Z -                            exercise_id=ex.id,
2026-02-20T22:09:13.8229715Z -                            priority=4,
2026-02-20T22:09:13.8230190Z -                            reason=f"Découvrez un nouveau type d'exercice: {ex.exercise_type}"
2026-02-20T22:09:13.8230317Z -                        ))
2026-02-20T22:09:13.8230421Z -            
2026-02-20T22:09:13.8230557Z +                                priority=4,
2026-02-20T22:09:13.8231044Z +                                reason=f"Découvrez un nouveau type d'exercice: {ex.exercise_type}",
2026-02-20T22:09:13.8231169Z +                            )
2026-02-20T22:09:13.8231289Z +                        )
2026-02-20T22:09:13.8231408Z +
2026-02-20T22:09:13.8231939Z              # 5. Recommandations de défis logiques (challenges) — au moins 2, jusqu'à 4
2026-02-20T22:09:13.8232131Z              completed_challenge_ids = {
2026-02-20T22:09:13.8232270Z                  a.challenge_id
2026-02-20T22:09:13.8232487Z                  for a in db.query(LogicChallengeAttempt)
2026-02-20T22:09:13.8232617Z                  .filter(
2026-02-20T22:09:13.8232833Z                      LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:13.8233291Z -                    LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:13.8233514Z +                    LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:13.8233633Z                  )
2026-02-20T22:09:13.8233779Z                  .all()
2026-02-20T22:09:13.8233892Z              }
2026-02-20T22:09:13.8234359Z -            challenge_query = db.query(LogicChallenge).filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:13.8234604Z +            challenge_query = db.query(LogicChallenge).filter(
2026-02-20T22:09:13.8234799Z +                LogicChallenge.is_archived == False
2026-02-20T22:09:13.8234924Z +            )
2026-02-20T22:09:13.8235079Z              if completed_challenge_ids:
2026-02-20T22:09:13.8235288Z                  challenge_query = challenge_query.filter(
2026-02-20T22:09:13.8235568Z                      ~LogicChallenge.id.in_(list(completed_challenge_ids))
2026-02-20T22:09:13.8235686Z                  )
2026-02-20T22:09:13.8236093Z -            suggested_challenges = challenge_query.order_by(func.random()).limit(4).all()
2026-02-20T22:09:13.8236248Z +            suggested_challenges = (
2026-02-20T22:09:13.8236505Z +                challenge_query.order_by(func.random()).limit(4).all()
2026-02-20T22:09:13.8236626Z +            )
2026-02-20T22:09:13.8237322Z              # Priorité plus élevée si l'utilisateur n'a pas encore fait de défis (incitation à découvrir)
2026-02-20T22:09:13.8237553Z              num_completed = len(completed_challenge_ids)
2026-02-20T22:09:13.8237937Z -            challenge_priority = 8 if num_completed == 0 else 7 if num_completed < 3 else 6
2026-02-20T22:09:13.8238110Z +            challenge_priority = (
2026-02-20T22:09:13.8238368Z +                8 if num_completed == 0 else 7 if num_completed < 3 else 6
2026-02-20T22:09:13.8238484Z +            )
2026-02-20T22:09:13.8238662Z              for ch in suggested_challenges:
2026-02-20T22:09:13.8239117Z -                challenge_type_str = str(ch.challenge_type).lower() if ch.challenge_type else "logique"
2026-02-20T22:09:13.8239265Z +                challenge_type_str = (
2026-02-20T22:09:13.8239591Z +                    str(ch.challenge_type).lower() if ch.challenge_type else "logique"
2026-02-20T22:09:13.8240113Z +                )
2026-02-20T22:09:13.8240277Z                  if num_completed == 0:
2026-02-20T22:09:13.8240851Z                      reason = "Découvrez les défis logiques pour aiguiser votre raisonnement !"
2026-02-20T22:09:13.8241023Z                  elif num_completed < 3:
2026-02-20T22:09:13.8241547Z -                    reason = f"Variez votre entraînement avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8241909Z +                    reason = (
2026-02-20T22:09:13.8242412Z +                        f"Variez votre entraînement avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8242536Z +                    )
2026-02-20T22:09:13.8242656Z                  else:
2026-02-20T22:09:13.8243430Z                      reason = f"Testez vos compétences logiques avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8243659Z -                recommendations.append(Recommendation(
2026-02-20T22:09:13.8243805Z -                    user_id=user_id,
2026-02-20T22:09:13.8243952Z -                    exercise_id=None,
2026-02-20T22:09:13.8244134Z -                    challenge_id=ch.id,
2026-02-20T22:09:13.8244314Z -                    recommendation_type="challenge",
2026-02-20T22:09:13.8244472Z -                    exercise_type="challenge",
2026-02-20T22:09:13.8244683Z -                    difficulty=ch.difficulty or "PADAWAN",
2026-02-20T22:09:13.8244872Z -                    priority=challenge_priority,
2026-02-20T22:09:13.8245009Z -                    reason=reason
2026-02-20T22:09:13.8245128Z -                ))
2026-02-20T22:09:13.8245240Z -            
2026-02-20T22:09:13.8245397Z +                recommendations.append(
2026-02-20T22:09:13.8245535Z +                    Recommendation(
2026-02-20T22:09:13.8245683Z +                        user_id=user_id,
2026-02-20T22:09:13.8245824Z +                        exercise_id=None,
2026-02-20T22:09:13.8245974Z +                        challenge_id=ch.id,
2026-02-20T22:09:13.8246168Z +                        recommendation_type="challenge",
2026-02-20T22:09:13.8246343Z +                        exercise_type="challenge",
2026-02-20T22:09:13.8246551Z +                        difficulty=ch.difficulty or "PADAWAN",
2026-02-20T22:09:13.8246727Z +                        priority=challenge_priority,
2026-02-20T22:09:13.8246872Z +                        reason=reason,
2026-02-20T22:09:13.8246988Z +                    )
2026-02-20T22:09:13.8247106Z +                )
2026-02-20T22:09:13.8247226Z +
2026-02-20T22:09:13.8247832Z              # Si aucune recommandation n'a été générée, proposer quelques exercices aléatoires
2026-02-20T22:09:13.8247992Z              if not recommendations:
2026-02-20T22:09:13.8248563Z                  # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8248797Z                  valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8249070Z                  valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8249187Z -                
2026-02-20T22:09:13.8249849Z -                logger.debug(f"Aucune recommandation générée, recherche d'exercices aléatoires...")
2026-02-20T22:09:13.8249964Z +
2026-02-20T22:09:13.8250100Z +                logger.debug(
2026-02-20T22:09:13.8250625Z +                    f"Aucune recommandation générée, recherche d'exercices aléatoires..."
2026-02-20T22:09:13.8250743Z +                )
2026-02-20T22:09:13.8250990Z                  logger.debug(f"Types valides: {valid_types}")
2026-02-20T22:09:13.8251420Z                  logger.debug(f"Difficultés valides: {valid_difficulties}")
2026-02-20T22:09:13.8251542Z -                
2026-02-20T22:09:13.8251650Z +
2026-02-20T22:09:13.8251859Z                  exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8252075Z                      Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8252303Z                      Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8252482Z                      Exercise.is_archived == False,
2026-02-20T22:09:13.8253198Z -                    Exercise.is_active == True
2026-02-20T22:09:13.8253340Z -                )
2026-02-20T22:09:13.8253462Z -                
2026-02-20T22:09:13.8253639Z +                    Exercise.is_active == True,
2026-02-20T22:09:13.8253751Z +                )
2026-02-20T22:09:13.8253858Z +
2026-02-20T22:09:13.8254208Z                  # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8254593Z                  if recently_completed_exercise_ids:
2026-02-20T22:09:13.8255097Z -                    exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8255220Z -                
2026-02-20T22:09:13.8255430Z +                    exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8255716Z +                        ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8255835Z +                    )
2026-02-20T22:09:13.8255951Z +
2026-02-20T22:09:13.8256321Z                  random_exercises = exercise_query.order_by(func.random()).limit(3).all()
2026-02-20T22:09:13.8256456Z -                
2026-02-20T22:09:13.8256563Z +
2026-02-20T22:09:13.8257032Z                  logger.debug(f"Exercices trouvés: {len(random_exercises)}")
2026-02-20T22:09:13.8257199Z                  for ex in random_exercises:
2026-02-20T22:09:13.8257531Z                      logger.debug(f"  - {ex.title} ({ex.exercise_type}/{ex.difficulty})")
2026-02-20T22:09:13.8257669Z -                
2026-02-20T22:09:13.8257782Z +
2026-02-20T22:09:13.8257939Z                  for ex in random_exercises:
2026-02-20T22:09:13.8258153Z -                    recommendations.append(Recommendation(
2026-02-20T22:09:13.8258308Z -                        user_id=user_id,
2026-02-20T22:09:13.8258498Z -                        exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8258660Z -                        difficulty=ex.difficulty,
2026-02-20T22:09:13.8258812Z -                        exercise_id=ex.id,
2026-02-20T22:09:13.8258945Z -                        priority=3,
2026-02-20T22:09:13.8259190Z -                        reason="Pour continuer votre apprentissage"
2026-02-20T22:09:13.8259319Z -                    ))
2026-02-20T22:09:13.8259428Z -                
2026-02-20T22:09:13.8259596Z +                    recommendations.append(
2026-02-20T22:09:13.8259741Z +                        Recommendation(
2026-02-20T22:09:13.8259919Z +                            user_id=user_id,
2026-02-20T22:09:13.8260121Z +                            exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8260302Z +                            difficulty=ex.difficulty,
2026-02-20T22:09:13.8260476Z +                            exercise_id=ex.id,
2026-02-20T22:09:13.8260618Z +                            priority=3,
2026-02-20T22:09:13.8260863Z +                            reason="Pour continuer votre apprentissage",
2026-02-20T22:09:13.8260998Z +                        )
2026-02-20T22:09:13.8261117Z +                    )
2026-02-20T22:09:13.8261228Z +
2026-02-20T22:09:13.8261804Z                  logger.debug(f"Recommandations fallback créées: {len(recommendations)}")
2026-02-20T22:09:13.8261935Z -            
2026-02-20T22:09:13.8262048Z +
2026-02-20T22:09:13.8262232Z              # Ajouter toutes les recommandations
2026-02-20T22:09:13.8262399Z              db.add_all(recommendations)
2026-02-20T22:09:13.8262526Z              db.commit()
2026-02-20T22:09:13.8262651Z -            
2026-02-20T22:09:13.8262757Z +
2026-02-20T22:09:13.8262911Z              return recommendations
2026-02-20T22:09:13.8263214Z -            
2026-02-20T22:09:13.8263328Z +
2026-02-20T22:09:13.8263598Z          except Exception as recommendations_generation_error:
2026-02-20T22:09:13.8264356Z -            logger.error(f"Erreur dans la génération des recommandations: {str(recommendations_generation_error)}")
2026-02-20T22:09:13.8264499Z +            logger.error(
2026-02-20T22:09:13.8265130Z +                f"Erreur dans la génération des recommandations: {str(recommendations_generation_error)}"
2026-02-20T22:09:13.8265494Z +            )
2026-02-20T22:09:13.8265633Z              db.rollback()
2026-02-20T22:09:13.8265758Z              return []
2026-02-20T22:09:13.8265880Z -    
2026-02-20T22:09:13.8265988Z +
2026-02-20T22:09:13.8266110Z      @staticmethod
2026-02-20T22:09:13.8266374Z      def mark_recommendation_as_shown(db, recommendation_id):
2026-02-20T22:09:13.8267065Z          """Marque une recommandation comme ayant été montrée à l'utilisateur"""
2026-02-20T22:09:13.8267186Z          try:
2026-02-20T22:09:13.8267704Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8267863Z +            recommendation = (
2026-02-20T22:09:13.8268020Z +                db.query(Recommendation)
2026-02-20T22:09:13.8268251Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8268384Z +                .first()
2026-02-20T22:09:13.8268494Z +            )
2026-02-20T22:09:13.8268632Z              if recommendation:
2026-02-20T22:09:13.8268830Z                  recommendation.shown_count += 1
2026-02-20T22:09:13.8268958Z                  db.commit()
2026-02-20T22:09:13.8269131Z          except Exception as mark_shown_error:
2026-02-20T22:09:13.8269838Z -            logger.error(f"Erreur lors du marquage de la recommandation comme montrée: {str(mark_shown_error)}")
2026-02-20T22:09:13.8270007Z +            logger.error(
2026-02-20T22:09:13.8270608Z +                f"Erreur lors du marquage de la recommandation comme montrée: {str(mark_shown_error)}"
2026-02-20T22:09:13.8270730Z +            )
2026-02-20T22:09:13.8270873Z              db.rollback()
2026-02-20T22:09:13.8270987Z -    
2026-02-20T22:09:13.8271097Z +
2026-02-20T22:09:13.8271220Z      @staticmethod
2026-02-20T22:09:13.8271507Z      def mark_recommendation_as_clicked(db, recommendation_id):
2026-02-20T22:09:13.8272022Z          """Marque une recommandation comme ayant été cliquée par l'utilisateur"""
2026-02-20T22:09:13.8272140Z          try:
2026-02-20T22:09:13.8272683Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8272828Z +            recommendation = (
2026-02-20T22:09:13.8273166Z +                db.query(Recommendation)
2026-02-20T22:09:13.8273420Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8273575Z +                .first()
2026-02-20T22:09:13.8273687Z +            )
2026-02-20T22:09:13.8273833Z              if recommendation:
2026-02-20T22:09:13.8274027Z                  recommendation.clicked_count += 1
2026-02-20T22:09:13.8274340Z                  recommendation.last_clicked_at = datetime.now(timezone.utc)
2026-02-20T22:09:13.8274473Z                  db.commit()
2026-02-20T22:09:13.8274667Z          except Exception as mark_clicked_error:
2026-02-20T22:09:13.8275422Z -            logger.error(f"Erreur lors du marquage de la recommandation comme cliquée: {str(mark_clicked_error)}")
2026-02-20T22:09:13.8275577Z +            logger.error(
2026-02-20T22:09:13.8276232Z +                f"Erreur lors du marquage de la recommandation comme cliquée: {str(mark_clicked_error)}"
2026-02-20T22:09:13.8276354Z +            )
2026-02-20T22:09:13.8276487Z              db.rollback()
2026-02-20T22:09:13.8276600Z -    
2026-02-20T22:09:13.8276717Z +
2026-02-20T22:09:13.8276832Z      @staticmethod
2026-02-20T22:09:13.8277125Z      def mark_recommendation_as_completed(db, recommendation_id):
2026-02-20T22:09:13.8277473Z          """Marque une recommandation comme complétée"""
2026-02-20T22:09:13.8277590Z          try:
2026-02-20T22:09:13.8278114Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8278268Z +            recommendation = (
2026-02-20T22:09:13.8278433Z +                db.query(Recommendation)
2026-02-20T22:09:13.8278663Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8278791Z +                .first()
2026-02-20T22:09:13.8279150Z +            )
2026-02-20T22:09:13.8279288Z              if recommendation:
2026-02-20T22:09:13.8279477Z                  recommendation.is_completed = True
2026-02-20T22:09:13.8279779Z                  recommendation.completed_at = datetime.now(timezone.utc)
2026-02-20T22:09:13.8279910Z                  db.commit()
2026-02-20T22:09:13.8280106Z          except Exception as mark_completed_error:
2026-02-20T22:09:13.8281105Z -            logger.error(f"Erreur lors du marquage de la recommandation comme complétée: {str(mark_completed_error)}")
2026-02-20T22:09:13.8281262Z +            logger.error(
2026-02-20T22:09:13.8281917Z +                f"Erreur lors du marquage de la recommandation comme complétée: {str(mark_completed_error)}"
2026-02-20T22:09:13.8282035Z +            )
2026-02-20T22:09:13.8282170Z              db.rollback()
2026-02-20T22:09:13.8282280Z -    
2026-02-20T22:09:13.8282389Z +
2026-02-20T22:09:13.8282519Z      @staticmethod
2026-02-20T22:09:13.8282741Z      def get_user_recommendations(db, user_id, limit=7):
2026-02-20T22:09:13.8283410Z          """Récupère les recommandations actives (mix exercices + défis)"""
2026-02-20T22:09:13.8283622Z -        all_recs = db.query(Recommendation).filter(
2026-02-20T22:09:13.8283805Z -            Recommendation.user_id == user_id,
2026-02-20T22:09:13.8283989Z -            Recommendation.is_completed == False
2026-02-20T22:09:13.8284337Z -        ).order_by(Recommendation.priority.desc()).limit(limit + 10).all()
2026-02-20T22:09:13.8284484Z +        all_recs = (
2026-02-20T22:09:13.8284643Z +            db.query(Recommendation)
2026-02-20T22:09:13.8284763Z +            .filter(
2026-02-20T22:09:13.8285145Z +                Recommendation.user_id == user_id, Recommendation.is_completed == False
2026-02-20T22:09:13.8285260Z +            )
2026-02-20T22:09:13.8285468Z +            .order_by(Recommendation.priority.desc())
2026-02-20T22:09:13.8285604Z +            .limit(limit + 10)
2026-02-20T22:09:13.8285725Z +            .all()
2026-02-20T22:09:13.8285839Z +        )
2026-02-20T22:09:13.8286009Z          result = list(all_recs[:limit])
2026-02-20T22:09:13.8286330Z          challenges = [r for r in all_recs if getattr(r, "challenge_id", None)]
2026-02-20T22:09:13.8286803Z          # Si aucun défi dans le top limit mais qu'il en existe, en insérer un
2026-02-20T22:09:13.8287162Z          if challenges and not any(getattr(r, "challenge_id", None) for r in result):
2026-02-20T22:09:13.8287538Z              exercises_only = [r for r in result if not getattr(r, "challenge_id", None)]
2026-02-20T22:09:13.8287721Z              if len(exercises_only) >= limit - 1:
2026-02-20T22:09:13.8287976Z                  result = exercises_only[: limit - 1] + [challenges[0]]
2026-02-20T22:09:13.8288122Z          return result[:limit]
2026-02-20T22:09:13.8288247Z -    
2026-02-20T22:09:13.8288358Z +
2026-02-20T22:09:13.8288488Z      @staticmethod
2026-02-20T22:09:13.8288707Z      def _get_next_difficulty(current_difficulty):
2026-02-20T22:09:13.8289056Z          """Retourne le niveau de difficulté suivant"""
2026-02-20T22:09:13.8289610Z          # Utiliser les mêmes valeurs que les énumérations DifficultyLevel (en majuscules)
2026-02-20T22:09:13.8289926Z          difficulty_levels = ["INITIE", "PADAWAN", "CHEVALIER", "MAITRE"]
2026-02-20T22:09:13.8290053Z @@ -438,6 +541,6 @@
2026-02-20T22:09:13.8290395Z              current_index = difficulty_levels.index(current_difficulty.upper())
2026-02-20T22:09:13.8290636Z              if current_index < len(difficulty_levels) - 1:
2026-02-20T22:09:13.8290866Z                  return difficulty_levels[current_index + 1]
2026-02-20T22:09:13.8291004Z          except ValueError:
2026-02-20T22:09:13.8291123Z              pass
2026-02-20T22:09:13.8291258Z -        return None 
2026-02-20T22:09:13.8291398Z \ No newline at end of file
2026-02-20T22:09:13.8291523Z +        return None
2026-02-20T22:09:13.8544538Z would reformat /home/runner/work/mathakine/mathakine/app/utils/email_verification.py
2026-02-20T22:09:13.8545172Z --- /home/runner/work/mathakine/mathakine/app/utils/email_verification.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.8546329Z +++ /home/runner/work/mathakine/mathakine/app/utils/email_verification.py	2026-02-20 22:09:13.832577+00:00
2026-02-20T22:09:13.8546522Z @@ -1,8 +1,9 @@
2026-02-20T22:09:13.8546871Z  """
2026-02-20T22:09:13.8547311Z  Utilitaires pour la vérification d'email
2026-02-20T22:09:13.8547648Z  """
2026-02-20T22:09:13.8547755Z +
2026-02-20T22:09:13.8547878Z  import secrets
2026-02-20T22:09:13.8548095Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:13.8548258Z  from typing import Optional
2026-02-20T22:09:13.8548359Z  
2026-02-20T22:09:13.8548559Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.8548680Z @@ -11,41 +12,41 @@
2026-02-20T22:09:13.8548786Z  
2026-02-20T22:09:13.8548890Z  
2026-02-20T22:09:13.8549229Z  def generate_verification_token() -> str:
2026-02-20T22:09:13.8549557Z      """
2026-02-20T22:09:13.8549861Z      Génère un token de vérification sécurisé.
2026-02-20T22:09:13.8549997Z -    
2026-02-20T22:09:13.8550114Z +
2026-02-20T22:09:13.8550228Z      Returns:
2026-02-20T22:09:13.8550549Z          Token de vérification (32 caractères aléatoires)
2026-02-20T22:09:13.8550663Z      """
2026-02-20T22:09:13.8550813Z      return secrets.token_urlsafe(32)
2026-02-20T22:09:13.8550915Z  
2026-02-20T22:09:13.8551014Z  
2026-02-20T22:09:13.8551372Z  def is_verification_token_expired(sent_at: Optional[datetime]) -> bool:
2026-02-20T22:09:13.8551479Z      """
2026-02-20T22:09:13.8551763Z      Vérifie si un token de vérification a expiré.
2026-02-20T22:09:13.8551878Z -    
2026-02-20T22:09:13.8551981Z +
2026-02-20T22:09:13.8552089Z      Args:
2026-02-20T22:09:13.8552381Z          sent_at: Date d'envoi du token
2026-02-20T22:09:13.8552732Z -    
2026-02-20T22:09:13.8552837Z +
2026-02-20T22:09:13.8552944Z      Returns:
2026-02-20T22:09:13.8553539Z          True si le token a expiré (plus de 24 heures), False sinon
2026-02-20T22:09:13.8553651Z      """
2026-02-20T22:09:13.8553773Z      if not sent_at:
2026-02-20T22:09:13.8553912Z          return True
2026-02-20T22:09:13.8554014Z -    
2026-02-20T22:09:13.8554117Z +
2026-02-20T22:09:13.8554322Z      expiration_time = sent_at + timedelta(hours=24)
2026-02-20T22:09:13.8554554Z      return datetime.now(timezone.utc) > expiration_time
2026-02-20T22:09:13.8554789Z  
2026-02-20T22:09:13.8555165Z  
2026-02-20T22:09:13.8555534Z  def is_password_reset_token_expired(expires_at: Optional[datetime]) -> bool:
2026-02-20T22:09:13.8555641Z      """
2026-02-20T22:09:13.8556053Z      Vérifie si un token de réinitialisation de mot de passe a expiré.
2026-02-20T22:09:13.8556164Z -    
2026-02-20T22:09:13.8556267Z +
2026-02-20T22:09:13.8556374Z      Args:
2026-02-20T22:09:13.8556544Z          expires_at: Date d'expiration du token
2026-02-20T22:09:13.8556656Z -    
2026-02-20T22:09:13.8556755Z +
2026-02-20T22:09:13.8556862Z      Returns:
2026-02-20T22:09:13.8557205Z          True si le token a expiré (1h par défaut), False sinon
2026-02-20T22:09:13.8557312Z      """
2026-02-20T22:09:13.8557449Z      if not expires_at:
2026-02-20T22:09:13.8557707Z          return True
2026-02-20T22:09:13.8573780Z @@ -53,19 +54,21 @@
2026-02-20T22:09:13.8573907Z  
2026-02-20T22:09:13.8574017Z  
2026-02-20T22:09:13.8574460Z  def create_verification_link(token: str, frontend_url: Optional[str] = None) -> str:
2026-02-20T22:09:13.8574590Z      """
2026-02-20T22:09:13.8574909Z      Crée un lien de vérification d'email.
2026-02-20T22:09:13.8575028Z -    
2026-02-20T22:09:13.8575128Z +
2026-02-20T22:09:13.8575243Z      Args:
2026-02-20T22:09:13.8575471Z          token: Token de vérification
2026-02-20T22:09:13.8575667Z          frontend_url: URL du frontend (optionnel)
2026-02-20T22:09:13.8575774Z -    
2026-02-20T22:09:13.8575877Z +
2026-02-20T22:09:13.8575995Z      Returns:
2026-02-20T22:09:13.8576221Z          Lien de vérification complet
2026-02-20T22:09:13.8576328Z      """
2026-02-20T22:09:13.8576441Z      import os
2026-02-20T22:09:13.8576552Z +
2026-02-20T22:09:13.8576683Z      if not frontend_url:
2026-02-20T22:09:13.8577464Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.8577584Z -    
2026-02-20T22:09:13.8577729Z +        frontend_url = os.getenv(
2026-02-20T22:09:13.8578021Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.8578325Z +        )
2026-02-20T22:09:13.8578436Z +
2026-02-20T22:09:13.8578652Z      return f"{frontend_url}/verify-email?token={token}"
2026-02-20T22:09:13.8578758Z -
2026-02-20T22:09:13.8725995Z --- /home/runner/work/mathakine/mathakine/app/utils/error_handler.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.8726604Z +++ /home/runner/work/mathakine/mathakine/app/utils/error_handler.py	2026-02-20 22:09:13.870662+00:00
2026-02-20T22:09:13.8726739Z @@ -1,8 +1,9 @@
2026-02-20T22:09:13.8726852Z  """
2026-02-20T22:09:13.8727365Z  Helper pour la gestion standardisée des erreurs dans les handlers.
2026-02-20T22:09:13.8727489Z  """
2026-02-20T22:09:13.8727615Z +
2026-02-20T22:09:13.8727736Z  import os
2026-02-20T22:09:13.8727872Z  import traceback
2026-02-20T22:09:13.8728042Z  from typing import Any, Dict, Optional
2026-02-20T22:09:13.8728152Z  
2026-02-20T22:09:13.8728360Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.8728485Z @@ -32,42 +33,44 @@
2026-02-20T22:09:13.8728592Z  
2026-02-20T22:09:13.8728742Z  class ErrorHandler:
2026-02-20T22:09:13.8728861Z      """
2026-02-20T22:09:13.8729337Z      Classe utilitaire pour gérer les erreurs de manière standardisée.
2026-02-20T22:09:13.8729454Z      """
2026-02-20T22:09:13.8729562Z -    
2026-02-20T22:09:13.8729680Z +
2026-02-20T22:09:13.8729805Z      @staticmethod
2026-02-20T22:09:13.8729953Z      def create_error_response(
2026-02-20T22:09:13.8730101Z          error: Exception,
2026-02-20T22:09:13.8730240Z          status_code: int = 500,
2026-02-20T22:09:13.8730404Z          user_message: Optional[str] = None,
2026-02-20T22:09:13.8730558Z -        include_details: bool = None
2026-02-20T22:09:13.8730732Z +        include_details: bool = None,
2026-02-20T22:09:13.8730873Z      ) -> JSONResponse:
2026-02-20T22:09:13.8730989Z          """
2026-02-20T22:09:13.8731350Z          Crée une réponse d'erreur JSON standardisée.
2026-02-20T22:09:13.8731464Z -        
2026-02-20T22:09:13.8731574Z +
2026-02-20T22:09:13.8731688Z          Args:
2026-02-20T22:09:13.8731940Z              error: Exception levée
2026-02-20T22:09:13.8732264Z              status_code: Code HTTP d'erreur (défaut: 500)
2026-02-20T22:09:13.8732929Z              user_message: Message à afficher à l'utilisateur (si None, utilise le message de l'exception)
2026-02-20T22:09:13.8733855Z              include_details: Inclure les détails techniques (défaut: True si DEBUG, False sinon)
2026-02-20T22:09:13.8733984Z -        
2026-02-20T22:09:13.8734094Z +
2026-02-20T22:09:13.8734220Z          Returns:
2026-02-20T22:09:13.8734531Z              JSONResponse avec le format d'erreur standardisé
2026-02-20T22:09:13.8734648Z          """
2026-02-20T22:09:13.8734826Z          error_type = type(error).__name__
2026-02-20T22:09:13.8750495Z          error_message = str(error)
2026-02-20T22:09:13.8750663Z -        
2026-02-20T22:09:13.8750778Z +
2026-02-20T22:09:13.8751215Z          # Ne jamais exposer traceback/détails en production
2026-02-20T22:09:13.8751377Z          if include_details is None:
2026-02-20T22:09:13.8751611Z              include_details = (
2026-02-20T22:09:13.8751822Z                  settings.LOG_LEVEL.upper() == "DEBUG"
2026-02-20T22:09:13.8752045Z                  and os.getenv("ENVIRONMENT") != "production"
2026-02-20T22:09:13.8752164Z              )
2026-02-20T22:09:13.8752272Z  
2026-02-20T22:09:13.8752755Z          # Message utilisateur : générique en prod pour éviter fuite d'info
2026-02-20T22:09:13.8754678Z -        display_error = user_message or (error_message if include_details else GENERIC_ERROR_MESSAGE)
2026-02-20T22:09:13.8754884Z +        display_error = user_message or (
2026-02-20T22:09:13.8755188Z +            error_message if include_details else GENERIC_ERROR_MESSAGE
2026-02-20T22:09:13.8755617Z +        )
2026-02-20T22:09:13.8755733Z  
2026-02-20T22:09:13.8756002Z          # Construire la réponse
2026-02-20T22:09:13.8756183Z          response_data: Dict[str, Any] = {
2026-02-20T22:09:13.8756330Z              "error": display_error,
2026-02-20T22:09:13.8756483Z              "error_type": error_type,
2026-02-20T22:09:13.8756836Z @@ -75,70 +78,65 @@
2026-02-20T22:09:13.8756951Z  
2026-02-20T22:09:13.8757315Z          # Ajouter les détails techniques uniquement en dev
2026-02-20T22:09:13.8757482Z          if include_details:
2026-02-20T22:09:13.8757705Z              response_data["error_message"] = error_message
2026-02-20T22:09:13.8757944Z              response_data["details"] = traceback.format_exc()
2026-02-20T22:09:13.8758064Z -        
2026-02-20T22:09:13.8758178Z +
2026-02-20T22:09:13.8758315Z          # Logger l'erreur
2026-02-20T22:09:13.8758524Z          logger.error(f"{error_type}: {error_message}")
2026-02-20T22:09:13.8758823Z          if include_details:
2026-02-20T22:09:13.8759149Z              logger.debug(f"Traceback complet:\n{traceback.format_exc()}")
2026-02-20T22:09:13.8760185Z -        
2026-02-20T22:09:13.8761123Z +
2026-02-20T22:09:13.8763726Z          # Nettoyer les données pour sérialisation JSON (gère les MagicMock dans les tests)
2026-02-20T22:09:13.8764035Z          response_data = make_json_serializable(response_data)
2026-02-20T22:09:13.8764160Z -        
2026-02-20T22:09:13.8764285Z +
2026-02-20T22:09:13.8766730Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8766877Z -    
2026-02-20T22:09:13.8766998Z +
2026-02-20T22:09:13.8767124Z      @staticmethod
2026-02-20T22:09:13.8767285Z      def create_validation_error(
2026-02-20T22:09:13.8767414Z -        field: str,
2026-02-20T22:09:13.8767552Z -        message: str,
2026-02-20T22:09:13.8767691Z -        status_code: int = 400
2026-02-20T22:09:13.8767914Z +        field: str, message: str, status_code: int = 400
2026-02-20T22:09:13.8768090Z      ) -> JSONResponse:
2026-02-20T22:09:13.8768206Z          """
2026-02-20T22:09:13.8768541Z          Crée une réponse d'erreur de validation.
2026-02-20T22:09:13.8768658Z -        
2026-02-20T22:09:13.8768778Z +
2026-02-20T22:09:13.8768893Z          Args:
2026-02-20T22:09:13.8769052Z              field: Nom du champ en erreur
2026-02-20T22:09:13.8769221Z              message: Message d'erreur
2026-02-20T22:09:13.8769499Z              status_code: Code HTTP (défaut: 400)
2026-02-20T22:09:13.8769610Z -        
2026-02-20T22:09:13.8769718Z +
2026-02-20T22:09:13.8769843Z          Returns:
2026-02-20T22:09:13.8770081Z              JSONResponse avec le format d'erreur de validation
2026-02-20T22:09:13.8770193Z          """
2026-02-20T22:09:13.8770335Z          response_data = {
2026-02-20T22:09:13.8770498Z              "error": "Erreur de validation",
2026-02-20T22:09:13.8770631Z              "field": field,
2026-02-20T22:09:13.8770764Z              "message": message,
2026-02-20T22:09:13.8770900Z          }
2026-02-20T22:09:13.8771011Z -        
2026-02-20T22:09:13.8771121Z +
2026-02-20T22:09:13.8771508Z          logger.warning(f"Erreur de validation pour le champ '{field}': {message}")
2026-02-20T22:09:13.8771623Z -        
2026-02-20T22:09:13.8771732Z +
2026-02-20T22:09:13.8772013Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8772141Z -    
2026-02-20T22:09:13.8772246Z +
2026-02-20T22:09:13.8772366Z      @staticmethod
2026-02-20T22:09:13.8772515Z      def create_not_found_error(
2026-02-20T22:09:13.8772654Z -        resource_type: str,
2026-02-20T22:09:13.8772785Z -        resource_id: Any,
2026-02-20T22:09:13.8772917Z -        status_code: int = 404
2026-02-20T22:09:13.8773401Z +        resource_type: str, resource_id: Any, status_code: int = 404
2026-02-20T22:09:13.8773547Z      ) -> JSONResponse:
2026-02-20T22:09:13.8773659Z          """
2026-02-20T22:09:13.8774050Z          Crée une réponse d'erreur "ressource non trouvée".
2026-02-20T22:09:13.8774435Z -        
2026-02-20T22:09:13.8774548Z +
2026-02-20T22:09:13.8774671Z          Args:
2026-02-20T22:09:13.8775008Z              resource_type: Type de ressource (ex: "exercice", "utilisateur")
2026-02-20T22:09:13.8775175Z              resource_id: ID de la ressource
2026-02-20T22:09:13.8775469Z              status_code: Code HTTP (défaut: 404)
2026-02-20T22:09:13.8775804Z -        
2026-02-20T22:09:13.8775914Z +
2026-02-20T22:09:13.8776038Z          Returns:
2026-02-20T22:09:13.8776409Z              JSONResponse avec le format d'erreur "non trouvé"
2026-02-20T22:09:13.8776529Z          """
2026-02-20T22:09:13.8776672Z          response_data = {
2026-02-20T22:09:13.8777034Z              "error": f"{resource_type.capitalize()} non trouvé",
2026-02-20T22:09:13.8777222Z              "resource_type": resource_type,
2026-02-20T22:09:13.8777391Z              "resource_id": str(resource_id),
2026-02-20T22:09:13.8777504Z          }
2026-02-20T22:09:13.8777624Z -        
2026-02-20T22:09:13.8777734Z +
2026-02-20T22:09:13.8778287Z          logger.warning(f"{resource_type.capitalize()} non trouvé: ID {resource_id}")
2026-02-20T22:09:13.8778409Z -        
2026-02-20T22:09:13.8778529Z +
2026-02-20T22:09:13.8778822Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8778930Z -
2026-02-20T22:09:13.8779351Z would reformat /home/runner/work/mathakine/mathakine/app/utils/error_handler.py
2026-02-20T22:09:13.9598964Z --- /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.9599920Z +++ /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py	2026-02-20 22:09:13.957901+00:00
2026-02-20T22:09:13.9600308Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.9600435Z  """
2026-02-20T22:09:13.9600668Z  Module de sanitization des prompts utilisateurs.
2026-02-20T22:09:13.9600935Z  Protection contre l'injection de prompts malveillants.
2026-02-20T22:09:13.9601043Z  """
2026-02-20T22:09:13.9601151Z +
2026-02-20T22:09:13.9601310Z  import re
2026-02-20T22:09:13.9601462Z  from typing import Optional
2026-02-20T22:09:13.9601567Z  
2026-02-20T22:09:13.9601765Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.9601879Z  
2026-02-20T22:09:13.9601997Z @@ -11,114 +12,112 @@
2026-02-20T22:09:13.9602099Z  
2026-02-20T22:09:13.9602210Z  
2026-02-20T22:09:13.9602520Z  def sanitize_user_prompt(prompt: str, max_length: int = 500) -> str:
2026-02-20T22:09:13.9602647Z      """
2026-02-20T22:09:13.9602873Z      Sanitize user prompt to prevent injection attacks.
2026-02-20T22:09:13.9603155Z -    
2026-02-20T22:09:13.9603263Z +
2026-02-20T22:09:13.9603373Z      Args:
2026-02-20T22:09:13.9603541Z          prompt: Prompt utilisateur brut
2026-02-20T22:09:13.9604004Z          max_length: Longueur maximale autorisée
2026-02-20T22:09:13.9604117Z -        
2026-02-20T22:09:13.9604224Z +
2026-02-20T22:09:13.9604353Z      Returns:
2026-02-20T22:09:13.9604495Z          Prompt sanitized
2026-02-20T22:09:13.9604607Z      """
2026-02-20T22:09:13.9604750Z      if not prompt:
2026-02-20T22:09:13.9604861Z          return ""
2026-02-20T22:09:13.9604964Z -    
2026-02-20T22:09:13.9605069Z +
2026-02-20T22:09:13.9605212Z      # Limiter la longueur
2026-02-20T22:09:13.9605357Z      original_length = len(prompt)
2026-02-20T22:09:13.9605500Z      prompt = prompt[:max_length]
2026-02-20T22:09:13.9605637Z -    
2026-02-20T22:09:13.9605739Z +
2026-02-20T22:09:13.9605888Z      if original_length > max_length:
2026-02-20T22:09:13.9606464Z          logger.warning(f"Prompt tronqué de {original_length} à {max_length} caractères")
2026-02-20T22:09:13.9606582Z -    
2026-02-20T22:09:13.9606685Z +
2026-02-20T22:09:13.9607047Z      # Patterns dangereux à supprimer (tentatives d'injection)
2026-02-20T22:09:13.9607360Z      # Anglais ET français (Mathakine = plateforme FR)
2026-02-20T22:09:13.9607501Z      dangerous_patterns = [
2026-02-20T22:09:13.9607726Z          # Tentatives de contournement d'instructions (EN)
2026-02-20T22:09:13.9608050Z -        r'ignore\s+(previous|above|all|all\s+previous)\s+instructions?',
2026-02-20T22:09:13.9608721Z -        r'forget\s+(everything|all|previous)',
2026-02-20T22:09:13.9608895Z -        r'disregard\s+(previous|above|all)',
2026-02-20T22:09:13.9609026Z -        r'you\s+are\s+now',
2026-02-20T22:09:13.9609173Z -        r'new\s+instructions?',
2026-02-20T22:09:13.9609322Z -        r'override\s+(previous|system)',
2026-02-20T22:09:13.9609904Z +        r"ignore\s+(previous|above|all|all\s+previous)\s+instructions?",
2026-02-20T22:09:13.9610087Z +        r"forget\s+(everything|all|previous)",
2026-02-20T22:09:13.9610244Z +        r"disregard\s+(previous|above|all)",
2026-02-20T22:09:13.9610372Z +        r"you\s+are\s+now",
2026-02-20T22:09:13.9610510Z +        r"new\s+instructions?",
2026-02-20T22:09:13.9610658Z +        r"override\s+(previous|system)",
2026-02-20T22:09:13.9611064Z          # Français : oublie, tu es maintenant, nouveau contexte...
2026-02-20T22:09:13.9611469Z -        r'oublie\s+(tout|tout\s+ce\s+qui\s+précède|les\s+instructions)',
2026-02-20T22:09:13.9611823Z -        r'tu\s+es\s+(maintenant|désormais)\s+(un|une|le|la)',
2026-02-20T22:09:13.9611996Z -        r'ignore\s+(tout|les\s+instructions)',
2026-02-20T22:09:13.9612291Z -        r'nouveau\s+(contexte|rôle|personnage|mode)',
2026-02-20T22:09:13.9612701Z +        r"oublie\s+(tout|tout\s+ce\s+qui\s+précède|les\s+instructions)",
2026-02-20T22:09:13.9613211Z +        r"tu\s+es\s+(maintenant|désormais)\s+(un|une|le|la)",
2026-02-20T22:09:13.9613687Z would reformat /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py
2026-02-20T22:09:13.9613865Z +        r"ignore\s+(tout|les\s+instructions)",
2026-02-20T22:09:13.9614168Z +        r"nouveau\s+(contexte|rôle|personnage|mode)",
2026-02-20T22:09:13.9614466Z          r'r[eé]ponds\s+(uniquement|seulement)\s+["\']',
2026-02-20T22:09:13.9614614Z -        r'from\s+now\s+on',
2026-02-20T22:09:13.9614724Z -        
2026-02-20T22:09:13.9614853Z +        r"from\s+now\s+on",
2026-02-20T22:09:13.9615103Z          # Tentatives de changement de rôle
2026-02-20T22:09:13.9615271Z -        r'act\s+as\s+if\s+you\s+are',
2026-02-20T22:09:13.9615407Z -        r'pretend\s+to\s+be',
2026-02-20T22:09:13.9615544Z -        r'you\s+must\s+now',
2026-02-20T22:09:13.9615803Z -        r'fais\s+comme\s+si\s+tu\s+(étais|es)',
2026-02-20T22:09:13.9615914Z -        
2026-02-20T22:09:13.9616063Z +        r"act\s+as\s+if\s+you\s+are",
2026-02-20T22:09:13.9616202Z +        r"pretend\s+to\s+be",
2026-02-20T22:09:13.9616323Z +        r"you\s+must\s+now",
2026-02-20T22:09:13.9616573Z +        r"fais\s+comme\s+si\s+tu\s+(étais|es)",
2026-02-20T22:09:13.9616733Z          # Tentatives de manipulation
2026-02-20T22:09:13.9616863Z -        r'do\s+not\s+follow',
2026-02-20T22:09:13.9616996Z -        r'ignore\s+the\s+system',
2026-02-20T22:09:13.9617159Z -        r'bypass\s+(safety|security|rules)',
2026-02-20T22:09:13.9617269Z -        
2026-02-20T22:09:13.9617390Z +        r"do\s+not\s+follow",
2026-02-20T22:09:13.9617524Z +        r"ignore\s+the\s+system",
2026-02-20T22:09:13.9617696Z +        r"bypass\s+(safety|security|rules)",
2026-02-20T22:09:13.9617846Z          # Tentatives de fuite d'informations
2026-02-20T22:09:13.9618071Z -        r'show\s+me\s+your\s+(prompt|instructions|system)',
2026-02-20T22:09:13.9618264Z -        r'repeat\s+your\s+(prompt|instructions)',
2026-02-20T22:09:13.9618461Z -        r'what\s+are\s+your\s+(instructions|rules)',
2026-02-20T22:09:13.9618729Z -        r'montre\s+(moi\s+)?(ton|ta|tes)\s+(prompt|instructions)',
2026-02-20T22:09:13.9619005Z -        r'quel\s+est\s+ton\s+(prompt|système)',
2026-02-20T22:09:13.9619232Z +        r"show\s+me\s+your\s+(prompt|instructions|system)",
2026-02-20T22:09:13.9619408Z +        r"repeat\s+your\s+(prompt|instructions)",
2026-02-20T22:09:13.9619589Z +        r"what\s+are\s+your\s+(instructions|rules)",
2026-02-20T22:09:13.9619838Z +        r"montre\s+(moi\s+)?(ton|ta|tes)\s+(prompt|instructions)",
2026-02-20T22:09:13.9620110Z +        r"quel\s+est\s+ton\s+(prompt|système)",
2026-02-20T22:09:13.9620455Z      ]
2026-02-20T22:09:13.9620561Z -    
2026-02-20T22:09:13.9620667Z +
2026-02-20T22:09:13.9620837Z      # Supprimer les patterns dangereux
2026-02-20T22:09:13.9620978Z      sanitized_prompt = prompt
2026-02-20T22:09:13.9621111Z      removed_patterns = []
2026-02-20T22:09:13.9621223Z -    
2026-02-20T22:09:13.9621328Z +
2026-02-20T22:09:13.9621693Z      for pattern in dangerous_patterns:
2026-02-20T22:09:13.9622021Z          matches = re.findall(pattern, sanitized_prompt, flags=re.IGNORECASE)
2026-02-20T22:09:13.9622155Z          if matches:
2026-02-20T22:09:13.9622321Z              removed_patterns.extend(matches)
2026-02-20T22:09:13.9622694Z -            sanitized_prompt = re.sub(pattern, '', sanitized_prompt, flags=re.IGNORECASE)
2026-02-20T22:09:13.9622806Z -    
2026-02-20T22:09:13.9622952Z +            sanitized_prompt = re.sub(
2026-02-20T22:09:13.9623363Z +                pattern, "", sanitized_prompt, flags=re.IGNORECASE
2026-02-20T22:09:13.9623474Z +            )
2026-02-20T22:09:13.9623602Z +
2026-02-20T22:09:13.9623738Z      if removed_patterns:
2026-02-20T22:09:13.9624313Z          logger.warning(f"Patterns dangereux détectés et supprimés: {removed_patterns}")
2026-02-20T22:09:13.9624440Z -    
2026-02-20T22:09:13.9624548Z +
2026-02-20T22:09:13.9624711Z      # Nettoyer les espaces multiples
2026-02-20T22:09:13.9624972Z -    sanitized_prompt = re.sub(r'\s+', ' ', sanitized_prompt)
2026-02-20T22:09:13.9625226Z +    sanitized_prompt = re.sub(r"\s+", " ", sanitized_prompt)
2026-02-20T22:09:13.9625414Z      sanitized_prompt = sanitized_prompt.strip()
2026-02-20T22:09:13.9625520Z -    
2026-02-20T22:09:13.9625631Z +
2026-02-20T22:09:13.9625770Z      return sanitized_prompt
2026-02-20T22:09:13.9625876Z  
2026-02-20T22:09:13.9625986Z  
2026-02-20T22:09:13.9626310Z  def validate_prompt_safety(prompt: str) -> tuple[bool, Optional[str]]:
2026-02-20T22:09:13.9626421Z      """
2026-02-20T22:09:13.9626667Z      Valide la sécurité d'un prompt.
2026-02-20T22:09:13.9626778Z -    
2026-02-20T22:09:13.9626889Z +
2026-02-20T22:09:13.9626996Z      Returns:
2026-02-20T22:09:13.9627457Z          Tuple (is_safe, reason) où reason est None si safe, sinon message d'erreur
2026-02-20T22:09:13.9627568Z      """
2026-02-20T22:09:13.9627690Z      if not prompt:
2026-02-20T22:09:13.9627819Z          return True, None
2026-02-20T22:09:13.9627933Z -    
2026-02-20T22:09:13.9628046Z +
2026-02-20T22:09:13.9628248Z      # Vérifier la longueur
2026-02-20T22:09:13.9628392Z      if len(prompt) > 1000:
2026-02-20T22:09:13.9628732Z          return False, "Prompt trop long (max 1000 caractères)"
2026-02-20T22:09:13.9628840Z -    
2026-02-20T22:09:13.9628942Z +
2026-02-20T22:09:13.9629292Z      # Blocage : fuite de prompt ou messages ultra-courts purement malveillants.
2026-02-20T22:09:13.9629818Z      # Les injections mixtes ("Explique Pythagore. PS: Oublie tout...") sont nettoyées
2026-02-20T22:09:13.9630111Z      # par sanitize_user_prompt qui supprime les fragments dangereux.
2026-02-20T22:09:13.9630254Z      block_patterns = [
2026-02-20T22:09:13.9630484Z -        r'ignore\s+(previous|above|all)\s+instructions?',
2026-02-20T22:09:13.9630640Z -        r'forget\s+everything\s*\.?\s*$',
2026-02-20T22:09:13.9631054Z -        r'(?:show|repeat|disclose)\s+(?:me\s+)?(?:your|the)\s+(?:system\s+)?(?:prompt|instructions)',
2026-02-20T22:09:13.9631271Z +        r"ignore\s+(previous|above|all)\s+instructions?",
2026-02-20T22:09:13.9631431Z +        r"forget\s+everything\s*\.?\s*$",
2026-02-20T22:09:13.9631811Z +        r"(?:show|repeat|disclose)\s+(?:me\s+)?(?:your|the)\s+(?:system\s+)?(?:prompt|instructions)",
2026-02-20T22:09:13.9631931Z      ]
2026-02-20T22:09:13.9632079Z      for pattern in block_patterns:
2026-02-20T22:09:13.9632348Z          if re.search(pattern, prompt.strip(), flags=re.IGNORECASE):
2026-02-20T22:09:13.9632655Z              return False, "Pattern dangereux détecté"
2026-02-20T22:09:13.9632763Z  
2026-02-20T22:09:13.9633290Z      # Message court (< 60 car) + injection FR/EN → bloquer
2026-02-20T22:09:13.9633457Z      if len(prompt.strip()) < 60:
2026-02-20T22:09:13.9634023Z -        for pat in [r'oublie\s+tout', r'you\s+are\s+now', r'tu\s+es\s+maintenant']:
2026-02-20T22:09:13.9634335Z +        for pat in [r"oublie\s+tout", r"you\s+are\s+now", r"tu\s+es\s+maintenant"]:
2026-02-20T22:09:13.9634551Z              if re.search(pat, prompt, flags=re.IGNORECASE):
2026-02-20T22:09:13.9635074Z                  return False, "Pattern dangereux détecté"
2026-02-20T22:09:13.9635187Z -    
2026-02-20T22:09:13.9635290Z +
2026-02-20T22:09:13.9635425Z      return True, None
2026-02-20T22:09:13.9635527Z -
2026-02-20T22:09:13.9982138Z would reformat /home/runner/work/mathakine/mathakine/app/utils/json_utils.py
2026-02-20T22:09:13.9982668Z --- /home/runner/work/mathakine/mathakine/app/utils/json_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.9983466Z +++ /home/runner/work/mathakine/mathakine/app/utils/json_utils.py	2026-02-20 22:09:13.994089+00:00
2026-02-20T22:09:13.9983614Z @@ -1,14 +1,17 @@
2026-02-20T22:09:13.9983729Z  """
2026-02-20T22:09:13.9983934Z  Utilitaires pour le parsing JSON.
2026-02-20T22:09:13.9984044Z  """
2026-02-20T22:09:13.9984159Z +
2026-02-20T22:09:13.9984285Z  import json
2026-02-20T22:09:13.9984415Z  import re
2026-02-20T22:09:13.9984620Z  from typing import Any, List, Optional, Union
2026-02-20T22:09:13.9984732Z  
2026-02-20T22:09:13.9984852Z  
2026-02-20T22:09:13.9985311Z -def safe_parse_json(value: Optional[Union[str, dict, list]], default: Any = None) -> Any:
2026-02-20T22:09:13.9985450Z +def safe_parse_json(
2026-02-20T22:09:13.9985729Z +    value: Optional[Union[str, dict, list]], default: Any = None
2026-02-20T22:09:13.9985857Z +) -> Any:
2026-02-20T22:09:13.9985973Z      """
2026-02-20T22:09:13.9986562Z      Parse JSON en gérant les cas None, string vide, ou JSON invalide.
2026-02-20T22:09:13.9986963Z      Utilisé pour les champs DB (choices, visual_data, etc.).
2026-02-20T22:09:13.9987081Z  
2026-02-20T22:09:13.9987198Z      Args:
2026-02-20T22:09:13.9987325Z @@ -60,87 +63,101 @@
2026-02-20T22:09:13.9987658Z              open_braces = json_cleaned.count("{") - json_cleaned.count("}")
2026-02-20T22:09:13.9987973Z              open_brackets = json_cleaned.count("[") - json_cleaned.count("]")
2026-02-20T22:09:13.9988146Z              if json_cleaned.count('"') % 2 == 1:
2026-02-20T22:09:13.9988301Z                  json_cleaned += '..."'
2026-02-20T22:09:13.9988486Z              last_colon = json_cleaned.rfind(":")
2026-02-20T22:09:13.9988940Z -            last_close = max(json_cleaned.rfind("}"), json_cleaned.rfind("]"), json_cleaned.rfind('"'))
2026-02-20T22:09:13.9989097Z +            last_close = max(
2026-02-20T22:09:13.9989254Z +                json_cleaned.rfind("}"),
2026-02-20T22:09:13.9989404Z +                json_cleaned.rfind("]"),
2026-02-20T22:09:13.9989556Z +                json_cleaned.rfind('"'),
2026-02-20T22:09:13.9989691Z +            )
2026-02-20T22:09:13.9989838Z              if last_colon > last_close:
2026-02-20T22:09:13.9989979Z                  json_cleaned += '""'
2026-02-20T22:09:13.9990245Z              json_cleaned += "]" * open_brackets + "}" * open_braces
2026-02-20T22:09:13.9990412Z              return json.loads(json_cleaned)
2026-02-20T22:09:13.9990526Z  
2026-02-20T22:09:13.9990645Z  
2026-02-20T22:09:13.9990838Z  def make_json_serializable(obj: Any) -> Any:
2026-02-20T22:09:13.9990951Z      """
2026-02-20T22:09:13.9991383Z      Convertit un objet en une structure sérialisable en JSON.
2026-02-20T22:09:13.9991820Z      Gère les MagicMock, les objets avec attributs, les datetime, etc.
2026-02-20T22:09:13.9991935Z -    
2026-02-20T22:09:13.9992041Z +
2026-02-20T22:09:13.9992166Z      Args:
2026-02-20T22:09:13.9992389Z          obj: Objet à convertir
2026-02-20T22:09:13.9992503Z -    
2026-02-20T22:09:13.9992610Z +
2026-02-20T22:09:13.9992738Z      Returns:
2026-02-20T22:09:13.9993345Z          Objet sérialisable (dict, list, str, int, float, bool, None)
2026-02-20T22:09:13.9993471Z      """
2026-02-20T22:09:13.9993773Z      # Détecter MagicMock et autres objets mock
2026-02-20T22:09:13.9994448Z -    if hasattr(obj, '__class__') and 'Mock' in obj.__class__.__name__:
2026-02-20T22:09:13.9994756Z +    if hasattr(obj, "__class__") and "Mock" in obj.__class__.__name__:
2026-02-20T22:09:13.9994984Z          # Si c'est un MagicMock, essayer de le convertir en dict
2026-02-20T22:09:13.9995105Z          try:
2026-02-20T22:09:13.9995479Z              # Si l'objet a un dict, l'utiliser
2026-02-20T22:09:13.9995618Z -            if hasattr(obj, '__dict__'):
2026-02-20T22:09:13.9996093Z -                return {k: make_json_serializable(v) for k, v in obj.__dict__.items() if not k.startswith('_')}
2026-02-20T22:09:13.9996242Z +            if hasattr(obj, "__dict__"):
2026-02-20T22:09:13.9996370Z +                return {
2026-02-20T22:09:13.9996545Z +                    k: make_json_serializable(v)
2026-02-20T22:09:13.9996715Z +                    for k, v in obj.__dict__.items()
2026-02-20T22:09:13.9996870Z +                    if not k.startswith("_")
2026-02-20T22:09:13.9996983Z +                }
2026-02-20T22:09:13.9997370Z              # Sinon, retourner une représentation string
2026-02-20T22:09:13.9997523Z              return str(obj)
2026-02-20T22:09:13.9997675Z          except Exception:
2026-02-20T22:09:13.9997816Z              return str(obj)
2026-02-20T22:09:13.9997925Z -    
2026-02-20T22:09:13.9998035Z +
2026-02-20T22:09:13.9998284Z      # Gérer les dictionnaires
2026-02-20T22:09:13.9998443Z      if isinstance(obj, dict):
2026-02-20T22:09:13.9998724Z          return {k: make_json_serializable(v) for k, v in obj.items()}
2026-02-20T22:09:13.9998838Z -    
2026-02-20T22:09:13.9998959Z +
2026-02-20T22:09:13.9999177Z      # Gérer les listes
2026-02-20T22:09:13.9999343Z      if isinstance(obj, (list, tuple)):
2026-02-20T22:09:13.9999591Z          return [make_json_serializable(item) for item in obj]
2026-02-20T22:09:13.9999708Z -    
2026-02-20T22:09:13.9999815Z +
2026-02-20T22:09:14.0000079Z      # Gérer les types de base sérialisables
2026-02-20T22:09:14.0000339Z      if isinstance(obj, (str, int, float, bool, type(None))):
2026-02-20T22:09:14.0000483Z          return obj
2026-02-20T22:09:14.0000598Z -    
2026-02-20T22:09:14.0000713Z +
2026-02-20T22:09:14.0000933Z      # Gérer les datetime
2026-02-20T22:09:14.0001086Z -    if hasattr(obj, 'isoformat'):
2026-02-20T22:09:14.0001230Z +    if hasattr(obj, "isoformat"):
2026-02-20T22:09:14.0001393Z          return obj.isoformat()
2026-02-20T22:09:14.0001501Z -    
2026-02-20T22:09:14.0001608Z +
2026-02-20T22:09:14.0002071Z      # Gérer les objets avec attributs (modèles SQLAlchemy, Pydantic, etc.)
2026-02-20T22:09:14.0002219Z -    if hasattr(obj, '__dict__'):
2026-02-20T22:09:14.0002356Z +    if hasattr(obj, "__dict__"):
2026-02-20T22:09:14.0002469Z          try:
2026-02-20T22:09:14.0002954Z -            return {k: make_json_serializable(v) for k, v in obj.__dict__.items() if not k.startswith('_')}
2026-02-20T22:09:14.0003347Z +            return {
2026-02-20T22:09:14.0003515Z +                k: make_json_serializable(v)
2026-02-20T22:09:14.0003719Z +                for k, v in obj.__dict__.items()
2026-02-20T22:09:14.0003867Z +                if not k.startswith("_")
2026-02-20T22:09:14.0003976Z +            }
2026-02-20T22:09:14.0004936Z          except Exception:
2026-02-20T22:09:14.0005124Z              return str(obj)
2026-02-20T22:09:14.0005239Z -    
2026-02-20T22:09:14.0005355Z +
2026-02-20T22:09:14.0005535Z      # Fallback: convertir en string
2026-02-20T22:09:14.0005652Z      try:
2026-02-20T22:09:14.0005788Z          return str(obj)
2026-02-20T22:09:14.0005929Z      except Exception:
2026-02-20T22:09:14.0006063Z          return None
2026-02-20T22:09:14.0006176Z  
2026-02-20T22:09:14.0006284Z  
2026-02-20T22:09:14.0006789Z -def parse_choices_json(choices_value: Optional[Union[str, dict, list]]) -> Optional[List[str]]:
2026-02-20T22:09:14.0006946Z +def parse_choices_json(
2026-02-20T22:09:14.0007159Z +    choices_value: Optional[Union[str, dict, list]],
2026-02-20T22:09:14.0007310Z +) -> Optional[List[str]]:
2026-02-20T22:09:14.0007422Z      """
2026-02-20T22:09:14.0008107Z      Parse les choix d'exercice depuis différents formats JSON.
2026-02-20T22:09:14.0008226Z -    
2026-02-20T22:09:14.0008345Z +
2026-02-20T22:09:14.0008462Z      Args:
2026-02-20T22:09:14.0008778Z          choices_value: Valeur des choix (string JSON, dict, list, ou None)
2026-02-20T22:09:14.0008902Z -    
2026-02-20T22:09:14.0009319Z +
2026-02-20T22:09:14.0009442Z      Returns:
2026-02-20T22:09:14.0009590Z          Liste de strings ou None
2026-02-20T22:09:14.0009711Z      """
2026-02-20T22:09:14.0009850Z      if not choices_value:
2026-02-20T22:09:14.0009979Z          return None
2026-02-20T22:09:14.0010097Z -    
2026-02-20T22:09:14.0010203Z +
2026-02-20T22:09:14.0010372Z      if isinstance(choices_value, list):
2026-02-20T22:09:14.0010605Z          # Déjà une liste
2026-02-20T22:09:14.0010755Z          return choices_value
2026-02-20T22:09:14.0010863Z -    
2026-02-20T22:09:14.0010974Z +
2026-02-20T22:09:14.0011139Z      if isinstance(choices_value, str):
2026-02-20T22:09:14.0011379Z          # String JSON à parser
2026-02-20T22:09:14.0011495Z          try:
2026-02-20T22:09:14.0011675Z              parsed = json.loads(choices_value)
2026-02-20T22:09:14.0011842Z              if isinstance(parsed, list):
2026-02-20T22:09:14.0011965Z @@ -149,12 +166,11 @@
2026-02-20T22:09:14.0012145Z                  # Dict JSONB : extraire les valeurs
2026-02-20T22:09:14.0012406Z                  return list(parsed.values()) if parsed else None
2026-02-20T22:09:14.0012535Z              return None
2026-02-20T22:09:14.0012731Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:14.0012859Z              return None
2026-02-20T22:09:14.0013245Z -    
2026-02-20T22:09:14.0013368Z +
2026-02-20T22:09:14.0013541Z      if isinstance(choices_value, dict):
2026-02-20T22:09:14.0013716Z          # Dict JSONB : extraire les valeurs
2026-02-20T22:09:14.0014013Z          return list(choices_value.values()) if choices_value else None
2026-02-20T22:09:14.0014126Z -    
2026-02-20T22:09:14.0014244Z +
2026-02-20T22:09:14.0014378Z      return None
2026-02-20T22:09:14.0014486Z -
2026-02-20T22:09:14.0176536Z --- /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0177860Z +++ /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py	2026-02-20 22:09:14.015247+00:00
2026-02-20T22:09:14.0178688Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0178992Z  """
2026-02-20T22:09:14.0179503Z  Module de métriques pour la génération IA.
2026-02-20T22:09:14.0180164Z  Track la qualité, performance et fiabilité des générations.
2026-02-20T22:09:14.0180673Z  """
2026-02-20T22:09:14.0180920Z +
2026-02-20T22:09:14.0181217Z  from collections import defaultdict
2026-02-20T22:09:14.0181654Z  from datetime import datetime, timedelta
2026-02-20T22:09:14.0182128Z  from typing import Dict, List, Optional
2026-02-20T22:09:14.0182526Z  
2026-02-20T22:09:14.0182861Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.0183479Z @@ -11,31 +12,31 @@
2026-02-20T22:09:14.0183809Z  logger = get_logger(__name__)
2026-02-20T22:09:14.0184162Z  
2026-02-20T22:09:14.0184399Z  
2026-02-20T22:09:14.0184653Z  class GenerationMetrics:
2026-02-20T22:09:14.0185212Z      """Tracker de métriques pour la génération IA."""
2026-02-20T22:09:14.0185677Z -    
2026-02-20T22:09:14.0185931Z +
2026-02-20T22:09:14.0186214Z      def __init__(self):
2026-02-20T22:09:14.0187182Z          # Structure: {challenge_type: [{"timestamp": datetime, "success": bool, "validation_passed": bool, "auto_corrected": bool, "duration": float}]}
2026-02-20T22:09:14.0188370Z          self._generation_history: Dict[str, List] = defaultdict(list)
2026-02-20T22:09:14.0189096Z          self._validation_failures: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0189790Z          self._auto_corrections: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0190452Z          self._success_count: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0191085Z          self._failure_count: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0191908Z -    
2026-02-20T22:09:14.0192169Z +
2026-02-20T22:09:14.0192453Z      def record_generation(
2026-02-20T22:09:14.0192804Z          self,
2026-02-20T22:09:14.0193317Z          challenge_type: str,
2026-02-20T22:09:14.0193700Z          success: bool,
2026-02-20T22:09:14.0194081Z          validation_passed: bool = True,
2026-02-20T22:09:14.0194758Z          auto_corrected: bool = False,
2026-02-20T22:09:14.0195210Z          duration_seconds: float = 0.0,
2026-02-20T22:09:14.0195669Z -        error_type: Optional[str] = None
2026-02-20T22:09:14.0196132Z +        error_type: Optional[str] = None,
2026-02-20T22:09:14.0196555Z      ):
2026-02-20T22:09:14.0196807Z          """
2026-02-20T22:09:14.0197322Z          Enregistre une génération dans les métriques.
2026-02-20T22:09:14.0197788Z -        
2026-02-20T22:09:14.0198006Z +
2026-02-20T22:09:14.0198205Z          Args:
2026-02-20T22:09:14.0198480Z              challenge_type: Type de challenge
2026-02-20T22:09:14.0198985Z              success: Si la génération a réussi
2026-02-20T22:09:14.0199461Z              validation_passed: Si la validation a passé
2026-02-20T22:09:14.0200056Z              auto_corrected: Si une auto-correction a été appliquée
2026-02-20T22:09:14.0200505Z @@ -48,149 +49,167 @@
2026-02-20T22:09:14.0200822Z              "validation_passed": validation_passed,
2026-02-20T22:09:14.0201254Z              "auto_corrected": auto_corrected,
2026-02-20T22:09:14.0201641Z              "duration": duration_seconds,
2026-02-20T22:09:14.0202007Z              "error_type": error_type,
2026-02-20T22:09:14.0202337Z          }
2026-02-20T22:09:14.0202564Z -        
2026-02-20T22:09:14.0202778Z +
2026-02-20T22:09:14.0204913Z          self._generation_history[challenge_type].append(record)
2026-02-20T22:09:14.0205388Z -        
2026-02-20T22:09:14.0205620Z +
2026-02-20T22:09:14.0205843Z          if success:
2026-02-20T22:09:14.0206201Z              self._success_count[challenge_type] += 1
2026-02-20T22:09:14.0206648Z          else:
2026-02-20T22:09:14.0206943Z              self._failure_count[challenge_type] += 1
2026-02-20T22:09:14.0207318Z -        
2026-02-20T22:09:14.0207549Z +
2026-02-20T22:09:14.0207801Z          if not validation_passed:
2026-02-20T22:09:14.0208255Z              self._validation_failures[challenge_type] += 1
2026-02-20T22:09:14.0208797Z -        
2026-02-20T22:09:14.0209028Z +
2026-02-20T22:09:14.0209258Z          if auto_corrected:
2026-02-20T22:09:14.0209634Z              self._auto_corrections[challenge_type] += 1
2026-02-20T22:09:14.0210063Z -        
2026-02-20T22:09:14.0210293Z +
2026-02-20T22:09:14.0210532Z          logger.debug(
2026-02-20T22:09:14.0210920Z              f"Metrics recorded - Type: {challenge_type}, "
2026-02-20T22:09:14.0211515Z              f"Success: {success}, Validation: {validation_passed}, "
2026-02-20T22:09:14.0212428Z              f"Auto-corrected: {auto_corrected}, Duration: {duration_seconds:.2f}s"
2026-02-20T22:09:14.0212930Z          )
2026-02-20T22:09:14.0213310Z -    
2026-02-20T22:09:14.0213768Z -    def get_success_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0214454Z +
2026-02-20T22:09:14.0214703Z +    def get_success_rate(
2026-02-20T22:09:14.0215171Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0215668Z +    ) -> float:
2026-02-20T22:09:14.0216101Z          """Calcule le taux de succès."""
2026-02-20T22:09:14.0216595Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0217053Z -        
2026-02-20T22:09:14.0217328Z -        if challenge_type:
2026-02-20T22:09:14.0217660Z -            records = [
2026-02-20T22:09:14.0218096Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0218608Z +
2026-02-20T22:09:14.0218894Z +        if challenge_type:
2026-02-20T22:09:14.0219255Z +            records = [
2026-02-20T22:09:14.0219583Z +                r
2026-02-20T22:09:14.0219984Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0220818Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0221245Z              ]
2026-02-20T22:09:14.0221522Z          else:
2026-02-20T22:09:14.0221821Z              records = []
2026-02-20T22:09:14.0222289Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0223261Z -                records.extend([
2026-02-20T22:09:14.0223664Z -                    r for r in type_records
2026-02-20T22:09:14.0224140Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0224581Z -                ])
2026-02-20T22:09:14.0224873Z -        
2026-02-20T22:09:14.0225154Z -        if not records:
2026-02-20T22:09:14.0225486Z -            return 0.0
2026-02-20T22:09:14.0225793Z -        
2026-02-20T22:09:14.0226065Z +                records.extend(
2026-02-20T22:09:14.0226574Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0227112Z +                )
2026-02-20T22:09:14.0227414Z +
2026-02-20T22:09:14.0227671Z +        if not records:
2026-02-20T22:09:14.0228008Z +            return 0.0
2026-02-20T22:09:14.0228313Z +
2026-02-20T22:09:14.0228690Z          success_count = sum(1 for r in records if r["success"])
2026-02-20T22:09:14.0229278Z          return success_count / len(records) * 100
2026-02-20T22:09:14.0229727Z -    
2026-02-20T22:09:14.0230391Z -    def get_validation_failure_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0231195Z +
2026-02-20T22:09:14.0231488Z +    def get_validation_failure_rate(
2026-02-20T22:09:14.0232030Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0232567Z +    ) -> float:
2026-02-20T22:09:14.0233268Z          """Calcule le taux d'échec de validation."""
2026-02-20T22:09:14.0233861Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0234354Z -        
2026-02-20T22:09:14.0234635Z -        if challenge_type:
2026-02-20T22:09:14.0235004Z -            records = [
2026-02-20T22:09:14.0235441Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0235946Z +
2026-02-20T22:09:14.0236204Z +        if challenge_type:
2026-02-20T22:09:14.0236552Z +            records = [
2026-02-20T22:09:14.0236867Z +                r
2026-02-20T22:09:14.0237313Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0237860Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0238277Z              ]
2026-02-20T22:09:14.0238556Z          else:
2026-02-20T22:09:14.0238837Z              records = []
2026-02-20T22:09:14.0239300Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0239836Z -                records.extend([
2026-02-20T22:09:14.0240247Z -                    r for r in type_records
2026-02-20T22:09:14.0240707Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0241144Z -                ])
2026-02-20T22:09:14.0241443Z -        
2026-02-20T22:09:14.0241709Z -        if not records:
2026-02-20T22:09:14.0242051Z -            return 0.0
2026-02-20T22:09:14.0242345Z -        
2026-02-20T22:09:14.0242613Z +                records.extend(
2026-02-20T22:09:14.0243285Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0243831Z +                )
2026-02-20T22:09:14.0244140Z +
2026-02-20T22:09:14.0244428Z +        if not records:
2026-02-20T22:09:14.0244776Z +            return 0.0
2026-02-20T22:09:14.0245110Z +
2026-02-20T22:09:14.0245570Z          failure_count = sum(1 for r in records if not r["validation_passed"])
2026-02-20T22:09:14.0246262Z          return failure_count / len(records) * 100
2026-02-20T22:09:14.0246730Z -    
2026-02-20T22:09:14.0247353Z -    def get_auto_correction_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0248085Z +
2026-02-20T22:09:14.0248350Z +    def get_auto_correction_rate(
2026-02-20T22:09:14.0249157Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0249721Z +    ) -> float:
2026-02-20T22:09:14.0250092Z          """Calcule le taux d'auto-correction."""
2026-02-20T22:09:14.0250676Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0251197Z -        
2026-02-20T22:09:14.0251857Z -        if challenge_type:
2026-02-20T22:09:14.0252239Z -            records = [
2026-02-20T22:09:14.0252724Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0253495Z +
2026-02-20T22:09:14.0253780Z +        if challenge_type:
2026-02-20T22:09:14.0254160Z +            records = [
2026-02-20T22:09:14.0254511Z +                r
2026-02-20T22:09:14.0254944Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0255509Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0255952Z              ]
2026-02-20T22:09:14.0256239Z          else:
2026-02-20T22:09:14.0256554Z              records = []
2026-02-20T22:09:14.0257027Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0257600Z -                records.extend([
2026-02-20T22:09:14.0258034Z -                    r for r in type_records
2026-02-20T22:09:14.0258542Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0259017Z -                ])
2026-02-20T22:09:14.0259321Z -        
2026-02-20T22:09:14.0259625Z -        if not records:
2026-02-20T22:09:14.0259969Z -            return 0.0
2026-02-20T22:09:14.0260300Z -        
2026-02-20T22:09:14.0260596Z +                records.extend(
2026-02-20T22:09:14.0261130Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0261687Z +                )
2026-02-20T22:09:14.0261983Z +
2026-02-20T22:09:14.0262249Z +        if not records:
2026-02-20T22:09:14.0262603Z +            return 0.0
2026-02-20T22:09:14.0262925Z +
2026-02-20T22:09:14.0266095Z          corrected_count = sum(1 for r in records if r["auto_corrected"])
2026-02-20T22:09:14.0268266Z          return corrected_count / len(records) * 100
2026-02-20T22:09:14.0268717Z -    
2026-02-20T22:09:14.0269302Z -    def get_average_duration(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0270016Z +
2026-02-20T22:09:14.0270300Z +    def get_average_duration(
2026-02-20T22:09:14.0270791Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0271289Z +    ) -> float:
2026-02-20T22:09:14.0271775Z          """Calcule la durée moyenne de génération."""
2026-02-20T22:09:14.0272341Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0272840Z -        
2026-02-20T22:09:14.0273346Z -        if challenge_type:
2026-02-20T22:09:14.0273730Z -            records = [
2026-02-20T22:09:14.0274192Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0274720Z +
2026-02-20T22:09:14.0274993Z +        if challenge_type:
2026-02-20T22:09:14.0275377Z +            records = [
2026-02-20T22:09:14.0275698Z +                r
2026-02-20T22:09:14.0276117Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0276741Z                  if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0277225Z              ]
2026-02-20T22:09:14.0277525Z          else:
2026-02-20T22:09:14.0277812Z              records = []
2026-02-20T22:09:14.0278280Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0278824Z -                records.extend([
2026-02-20T22:09:14.0279222Z -                    r for r in type_records
2026-02-20T22:09:14.0279738Z -                    if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0280226Z -                ])
2026-02-20T22:09:14.0280509Z -        
2026-02-20T22:09:14.0280785Z -        if not records:
2026-02-20T22:09:14.0281131Z -            return 0.0
2026-02-20T22:09:14.0281437Z -        
2026-02-20T22:09:14.0281992Z +                records.extend(
2026-02-20T22:09:14.0282359Z +                    [
2026-02-20T22:09:14.0282672Z +                        r
2026-02-20T22:09:14.0283218Z +                        for r in type_records
2026-02-20T22:09:14.0283756Z +                        if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0284501Z +                    ]
2026-02-20T22:09:14.0284802Z +                )
2026-02-20T22:09:14.0285093Z +
2026-02-20T22:09:14.0285353Z +        if not records:
2026-02-20T22:09:14.0285687Z +            return 0.0
2026-02-20T22:09:14.0285990Z +
2026-02-20T22:09:14.0286355Z          total_duration = sum(r["duration"] for r in records)
2026-02-20T22:09:14.0286896Z          return total_duration / len(records)
2026-02-20T22:09:14.0287326Z -    
2026-02-20T22:09:14.0287585Z +
2026-02-20T22:09:14.0287911Z      def get_summary(self, days: int = 1) -> Dict:
2026-02-20T22:09:14.0288586Z          """Retourne un résumé complet des métriques."""
2026-02-20T22:09:14.0289082Z          return {
2026-02-20T22:09:14.0289489Z              "success_rate": self.get_success_rate(days=days),
2026-02-20T22:09:14.0290202Z              "validation_failure_rate": self.get_validation_failure_rate(days=days),
2026-02-20T22:09:14.0291039Z              "auto_correction_rate": self.get_auto_correction_rate(days=days),
2026-02-20T22:09:14.0291784Z              "average_duration": self.get_average_duration(days=days),
2026-02-20T22:09:14.0292397Z              "by_type": self._get_summary_by_type(days),
2026-02-20T22:09:14.0292845Z          }
2026-02-20T22:09:14.0293417Z -    
2026-02-20T22:09:14.0293699Z +
2026-02-20T22:09:14.0294117Z      def _get_summary_by_type(self, days: int) -> Dict[str, Dict]:
2026-02-20T22:09:14.0294909Z          """Retourne les métriques groupées par type."""
2026-02-20T22:09:14.0295434Z          summary_by_type = {}
2026-02-20T22:09:14.0295802Z -        
2026-02-20T22:09:14.0296063Z +
2026-02-20T22:09:14.0296457Z          for challenge_type in self._generation_history.keys():
2026-02-20T22:09:14.0297072Z              summary_by_type[challenge_type] = {
2026-02-20T22:09:14.0297702Z                  "success_rate": self.get_success_rate(challenge_type, days),
2026-02-20T22:09:14.0298583Z -                "validation_failure_rate": self.get_validation_failure_rate(challenge_type, days),
2026-02-20T22:09:14.0299586Z -                "auto_correction_rate": self.get_auto_correction_rate(challenge_type, days),
2026-02-20T22:09:14.0300437Z +                "validation_failure_rate": self.get_validation_failure_rate(
2026-02-20T22:09:14.0301053Z +                    challenge_type, days
2026-02-20T22:09:14.0301466Z +                ),
2026-02-20T22:09:14.0301897Z +                "auto_correction_rate": self.get_auto_correction_rate(
2026-02-20T22:09:14.0302477Z +                    challenge_type, days
2026-02-20T22:09:14.0302888Z +                ),
2026-02-20T22:09:14.0303629Z                  "average_duration": self.get_average_duration(challenge_type, days),
2026-02-20T22:09:14.0304335Z -                "total_generations": len([
2026-02-20T22:09:14.0304888Z -                    r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0305565Z -                    if r["timestamp"] > datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0306104Z -                ]),
2026-02-20T22:09:14.0306459Z +                "total_generations": len(
2026-02-20T22:09:14.0306873Z +                    [
2026-02-20T22:09:14.0307186Z +                        r
2026-02-20T22:09:14.0307642Z +                        for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0308314Z +                        if r["timestamp"] > datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0308871Z +                    ]
2026-02-20T22:09:14.0309165Z +                ),
2026-02-20T22:09:14.0309453Z              }
2026-02-20T22:09:14.0309715Z -        
2026-02-20T22:09:14.0309975Z +
2026-02-20T22:09:14.0310238Z          return summary_by_type
2026-02-20T22:09:14.0310824Z  
2026-02-20T22:09:14.0311069Z  
2026-02-20T22:09:14.0311455Z  # Instance globale des métriques
2026-02-20T22:09:14.0311916Z  generation_metrics = GenerationMetrics()
2026-02-20T22:09:14.0312335Z -
2026-02-20T22:09:14.0312935Z would reformat /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py
2026-02-20T22:09:14.0909940Z --- /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0911627Z +++ /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py	2026-02-20 22:09:14.088692+00:00
2026-02-20T22:09:14.0912429Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0912728Z  """
2026-02-20T22:09:14.0913333Z  Rate limiting pour les endpoints sensibles (audit 3.4).
2026-02-20T22:09:14.0914388Z  Protège contre bruteforce (login, forgot-password) et énumération.
2026-02-20T22:09:14.0915008Z  """
2026-02-20T22:09:14.0915273Z +
2026-02-20T22:09:14.0915537Z  import os
2026-02-20T22:09:14.0915824Z  import time
2026-02-20T22:09:14.0916136Z  from collections import defaultdict
2026-02-20T22:09:14.0916579Z  from functools import wraps
2026-02-20T22:09:14.0916963Z  from typing import Callable
2026-02-20T22:09:14.0917345Z @@ -59,12 +60,15 @@
2026-02-20T22:09:14.0917684Z              ip = _get_client_ip(request)
2026-02-20T22:09:14.0918191Z              key = f"rate_limit:{endpoint_name}:{ip}"
2026-02-20T22:09:14.0918794Z              if not _check_rate_limit(key, RATE_LIMIT_AUTH_MAX):
2026-02-20T22:09:14.0919760Z                  logger.warning(f"Rate limit dépassé pour {endpoint_name} depuis {ip}")
2026-02-20T22:09:14.0920547Z                  from starlette.responses import JSONResponse
2026-02-20T22:09:14.0921052Z +
2026-02-20T22:09:14.0921362Z                  return JSONResponse(
2026-02-20T22:09:14.0922188Z -                    {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0922854Z +                    {
2026-02-20T22:09:14.0923772Z +                        "error": "Trop de tentatives. Veuillez réessayer dans une minute."
2026-02-20T22:09:14.0924441Z +                    },
2026-02-20T22:09:14.0924802Z                      status_code=429,
2026-02-20T22:09:14.0925202Z                  )
2026-02-20T22:09:14.0925600Z              return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0926067Z  
2026-02-20T22:09:14.0926353Z          return wrapped
2026-02-20T22:09:14.0926714Z @@ -80,10 +84,11 @@
2026-02-20T22:09:14.0927076Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0927526Z          key = f"rate_limit:register:{ip}"
2026-02-20T22:09:14.0928093Z          if not _check_rate_limit(key, RATE_LIMIT_REGISTER_MAX):
2026-02-20T22:09:14.0929014Z              logger.warning(f"Rate limit dépassé pour register depuis {ip}")
2026-02-20T22:09:14.0929739Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0930245Z +
2026-02-20T22:09:14.0930541Z              return JSONResponse(
2026-02-20T22:09:14.0931301Z                  {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0931976Z                  status_code=429,
2026-02-20T22:09:14.0932369Z              )
2026-02-20T22:09:14.0932747Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0963550Z @@ -99,10 +104,11 @@
2026-02-20T22:09:14.0963987Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0964508Z          key = f"rate_limit:resend_verification:{ip}"
2026-02-20T22:09:14.0965201Z          if not _check_rate_limit(key, RATE_LIMIT_RESEND_VERIFICATION_MAX):
2026-02-20T22:09:14.0966282Z              logger.warning(f"Rate limit dépassé pour resend-verification depuis {ip}")
2026-02-20T22:09:14.0967121Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0967617Z +
2026-02-20T22:09:14.0967906Z              return JSONResponse(
2026-02-20T22:09:14.0968675Z                  {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0969355Z                  status_code=429,
2026-02-20T22:09:14.0969737Z              )
2026-02-20T22:09:14.0970443Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0970940Z @@ -118,12 +124,15 @@
2026-02-20T22:09:14.0971307Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0971763Z          key = f"rate_limit:chat:{ip}"
2026-02-20T22:09:14.0972278Z          if not _check_rate_limit(key, RATE_LIMIT_CHAT_MAX):
2026-02-20T22:09:14.0973615Z              logger.warning(f"Rate limit dépassé pour chat depuis {ip}")
2026-02-20T22:09:14.0974326Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0974819Z +
2026-02-20T22:09:14.0975116Z              return JSONResponse(
2026-02-20T22:09:14.0975956Z -                {"error": "Limite de messages atteinte. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0976654Z +                {
2026-02-20T22:09:14.0977367Z +                    "error": "Limite de messages atteinte. Veuillez réessayer dans une minute."
2026-02-20T22:09:14.0978061Z +                },
2026-02-20T22:09:14.0978405Z                  status_code=429,
2026-02-20T22:09:14.0978785Z              )
2026-02-20T22:09:14.0979156Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0979621Z  
2026-02-20T22:09:14.0979896Z      return wrapped
2026-02-20T22:09:14.0980485Z would reformat /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py
2026-02-20T22:09:14.0997404Z --- /home/runner/work/mathakine/mathakine/app/utils/request_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0998542Z +++ /home/runner/work/mathakine/mathakine/app/utils/request_utils.py	2026-02-20 22:09:14.098653+00:00
2026-02-20T22:09:14.0999379Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0999664Z  """
2026-02-20T22:09:14.1002929Z  Utilitaires pour le parsing des requêtes HTTP (DRY).
2026-02-20T22:09:14.1004449Z  Centralise le pattern await request.json() + validation des champs.
2026-02-20T22:09:14.1005574Z  """
2026-02-20T22:09:14.1006215Z +
2026-02-20T22:09:14.1006678Z  from typing import Any, Dict, Optional, Union
2026-02-20T22:09:14.1007257Z  
2026-02-20T22:09:14.1008584Z  from starlette.requests import Request
2026-02-20T22:09:14.1011812Z  from starlette.responses import JSONResponse
2026-02-20T22:09:14.1012553Z  
2026-02-20T22:09:14.1016407Z would reformat /home/runner/work/mathakine/mathakine/app/utils/request_utils.py
2026-02-20T22:09:14.1125349Z would reformat /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py
2026-02-20T22:09:14.1126518Z --- /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1127749Z +++ /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py	2026-02-20 22:09:14.109142+00:00
2026-02-20T22:09:14.1128562Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.1128868Z  """
2026-02-20T22:09:14.1129446Z  Module de rate limiting pour la génération IA.
2026-02-20T22:09:14.1130254Z  Limite le nombre de générations par utilisateur et par période.
2026-02-20T22:09:14.1130828Z  """
2026-02-20T22:09:14.1131095Z +
2026-02-20T22:09:14.1131397Z  from collections import defaultdict
2026-02-20T22:09:14.1131901Z  from datetime import datetime, timedelta
2026-02-20T22:09:14.1132435Z  from typing import Dict, List, Optional, Tuple
2026-02-20T22:09:14.1132900Z  
2026-02-20T22:09:14.1133449Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.1133893Z @@ -11,97 +12,98 @@
2026-02-20T22:09:14.1134217Z  logger = get_logger(__name__)
2026-02-20T22:09:14.1134568Z  
2026-02-20T22:09:14.1134804Z  
2026-02-20T22:09:14.1135040Z  class RateLimiter:
2026-02-20T22:09:14.1135793Z      """Rate limiter simple en mémoire (peut être migré vers Redis pour production)."""
2026-02-20T22:09:14.1136489Z -    
2026-02-20T22:09:14.1136769Z +
2026-02-20T22:09:14.1137045Z      def __init__(self):
2026-02-20T22:09:14.1137443Z          # Structure: {user_id: [timestamps]}
2026-02-20T22:09:14.1138138Z          self._user_generation_counts: Dict[int, List[datetime]] = defaultdict(list)
2026-02-20T22:09:14.1138884Z          self._cleanup_interval = timedelta(hours=1)
2026-02-20T22:09:14.1139647Z          self._last_cleanup = datetime.now()
2026-02-20T22:09:14.1140060Z -    
2026-02-20T22:09:14.1140315Z +
2026-02-20T22:09:14.1140590Z      def check_rate_limit(
2026-02-20T22:09:14.1140958Z -        self, 
2026-02-20T22:09:14.1141288Z -        user_id: int, 
2026-02-20T22:09:14.1141651Z -        max_per_hour: int = 10,
2026-02-20T22:09:14.1142331Z -        max_per_day: int = 50
2026-02-20T22:09:14.1142869Z +        self, user_id: int, max_per_hour: int = 10, max_per_day: int = 50
2026-02-20T22:09:14.1143699Z      ) -> tuple[bool, Optional[str]]:
2026-02-20T22:09:14.1144117Z          """
2026-02-20T22:09:14.1144694Z          Vérifie si l'utilisateur peut générer un challenge.
2026-02-20T22:09:14.1145217Z -        
2026-02-20T22:09:14.1145494Z +
2026-02-20T22:09:14.1145735Z          Args:
2026-02-20T22:09:14.1146061Z              user_id: ID de l'utilisateur
2026-02-20T22:09:14.1146859Z              max_per_hour: Nombre maximum de générations par heure
2026-02-20T22:09:14.1147587Z              max_per_day: Nombre maximum de générations par jour
2026-02-20T22:09:14.1148093Z -            
2026-02-20T22:09:14.1148372Z +
2026-02-20T22:09:14.1148622Z          Returns:
2026-02-20T22:09:14.1149163Z              Tuple (allowed, reason) où reason est None si autorisé
2026-02-20T22:09:14.1149684Z          """
2026-02-20T22:09:14.1149981Z          now = datetime.now()
2026-02-20T22:09:14.1150347Z -        
2026-02-20T22:09:14.1150612Z +
2026-02-20T22:09:14.1151061Z          # Nettoyage périodique (toutes les heures)
2026-02-20T22:09:14.1151654Z          if now - self._last_cleanup > self._cleanup_interval:
2026-02-20T22:09:14.1152203Z              self._cleanup_old_entries()
2026-02-20T22:09:14.1152654Z              self._last_cleanup = now
2026-02-20T22:09:14.1153245Z -        
2026-02-20T22:09:14.1153525Z +
2026-02-20T22:09:14.1153975Z          # Récupérer les timestamps de l'utilisateur
2026-02-20T22:09:14.1154574Z          user_timestamps = self._user_generation_counts[user_id]
2026-02-20T22:09:14.1155106Z -        
2026-02-20T22:09:14.1155375Z +
2026-02-20T22:09:14.1155846Z          # Filtrer les timestamps récents (dernière heure)
2026-02-20T22:09:14.1156378Z          hour_ago = now - timedelta(hours=1)
2026-02-20T22:09:14.1156996Z          recent_timestamps = [ts for ts in user_timestamps if ts > hour_ago]
2026-02-20T22:09:14.1157589Z -        
2026-02-20T22:09:14.1157868Z +
2026-02-20T22:09:14.1158228Z          # Vérifier limite horaire
2026-02-20T22:09:14.1158697Z          if len(recent_timestamps) >= max_per_hour:
2026-02-20T22:09:14.1159529Z              return False, f"Limite horaire atteinte ({max_per_hour} générations/heure)"
2026-02-20T22:09:14.1160184Z -        
2026-02-20T22:09:14.1160443Z +
2026-02-20T22:09:14.1160890Z          # Filtrer les timestamps récents (dernières 24h)
2026-02-20T22:09:14.1161424Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1162016Z          daily_timestamps = [ts for ts in user_timestamps if ts > day_ago]
2026-02-20T22:09:14.1162600Z -        
2026-02-20T22:09:14.1162868Z +
2026-02-20T22:09:14.1163682Z          # Vérifier limite journalière
2026-02-20T22:09:14.1164183Z          if len(daily_timestamps) >= max_per_day:
2026-02-20T22:09:14.1165061Z -            return False, f"Limite journalière atteinte ({max_per_day} générations/jour)"
2026-02-20T22:09:14.1165762Z -        
2026-02-20T22:09:14.1166052Z +            return (
2026-02-20T22:09:14.1166366Z +                False,
2026-02-20T22:09:14.1167017Z +                f"Limite journalière atteinte ({max_per_day} générations/jour)",
2026-02-20T22:09:14.1167618Z +            )
2026-02-20T22:09:14.1167893Z +
2026-02-20T22:09:14.1168317Z          # Autoriser et enregistrer la génération
2026-02-20T22:09:14.1169182Z          # Stocker la liste filtrée à 24h (pas hourly) pour conserver la limite journalière
2026-02-20T22:09:14.1169924Z          daily_timestamps.append(now)
2026-02-20T22:09:14.1170473Z          self._user_generation_counts[user_id] = daily_timestamps
2026-02-20T22:09:14.1170993Z -        
2026-02-20T22:09:14.1171532Z +
2026-02-20T22:09:14.1171805Z          return True, None
2026-02-20T22:09:14.1172144Z -    
2026-02-20T22:09:14.1172402Z +
2026-02-20T22:09:14.1172686Z      def _cleanup_old_entries(self):
2026-02-20T22:09:14.1173474Z          """Nettoie les entrées de plus de 24h."""
2026-02-20T22:09:14.1173982Z          now = datetime.now()
2026-02-20T22:09:14.1174667Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1175120Z -        
2026-02-20T22:09:14.1175406Z +
2026-02-20T22:09:14.1175820Z          for user_id in list(self._user_generation_counts.keys()):
2026-02-20T22:09:14.1176501Z              timestamps = self._user_generation_counts[user_id]
2026-02-20T22:09:14.1177134Z              filtered = [ts for ts in timestamps if ts > day_ago]
2026-02-20T22:09:14.1177648Z -            
2026-02-20T22:09:14.1177923Z +
2026-02-20T22:09:14.1178211Z              if filtered:
2026-02-20T22:09:14.1178663Z                  self._user_generation_counts[user_id] = filtered
2026-02-20T22:09:14.1180506Z              else:
2026-02-20T22:09:14.1180986Z                  # Supprimer la clé si vide
2026-02-20T22:09:14.1181506Z                  del self._user_generation_counts[user_id]
2026-02-20T22:09:14.1181980Z -        
2026-02-20T22:09:14.1182624Z -        logger.debug(f"Nettoyage rate limiter: {len(self._user_generation_counts)} utilisateurs actifs")
2026-02-20T22:09:14.1183631Z -    
2026-02-20T22:09:14.1183892Z +
2026-02-20T22:09:14.1184159Z +        logger.debug(
2026-02-20T22:09:14.1184759Z +            f"Nettoyage rate limiter: {len(self._user_generation_counts)} utilisateurs actifs"
2026-02-20T22:09:14.1185461Z +        )
2026-02-20T22:09:14.1185719Z +
2026-02-20T22:09:14.1186106Z      def get_user_stats(self, user_id: int) -> Dict[str, int]:
2026-02-20T22:09:14.1186945Z          """Retourne les statistiques de génération d'un utilisateur."""
2026-02-20T22:09:14.1187544Z          now = datetime.now()
2026-02-20T22:09:14.1187972Z          hour_ago = now - timedelta(hours=1)
2026-02-20T22:09:14.1188454Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1188869Z -        
2026-02-20T22:09:14.1189125Z +
2026-02-20T22:09:14.1189408Z          timestamps = self._user_generation_counts.get(user_id, [])
2026-02-20T22:09:14.1189519Z -        
2026-02-20T22:09:14.1189620Z +
2026-02-20T22:09:14.1189738Z          return {
2026-02-20T22:09:14.1190016Z              "last_hour": len([ts for ts in timestamps if ts > hour_ago]),
2026-02-20T22:09:14.1190272Z              "last_day": len([ts for ts in timestamps if ts > day_ago]),
2026-02-20T22:09:14.1190416Z              "total": len(timestamps),
2026-02-20T22:09:14.1190526Z          }
2026-02-20T22:09:14.1190630Z  
2026-02-20T22:09:14.1190730Z  
2026-02-20T22:09:14.1190881Z  # Instance globale du rate limiter
2026-02-20T22:09:14.1191022Z  rate_limiter = RateLimiter()
2026-02-20T22:09:14.1191126Z -
2026-02-20T22:09:14.1191543Z would reformat /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py
2026-02-20T22:09:14.1192069Z --- /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1192585Z +++ /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py	2026-02-20 22:09:14.112945+00:00
2026-02-20T22:09:14.1192699Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.1192810Z  """
2026-02-20T22:09:14.1193318Z  Lecture des paramètres globaux (table settings).
2026-02-20T22:09:14.1193871Z  Utilisé par middleware et handlers pour maintenance_mode, registration_enabled, etc.
2026-02-20T22:09:14.1193990Z  """
2026-02-20T22:09:14.1194095Z +
2026-02-20T22:09:14.1194264Z  from app.models.setting import Setting
2026-02-20T22:09:14.1194430Z  from app.utils.db_utils import db_session
2026-02-20T22:09:14.1194541Z  
2026-02-20T22:09:14.1194643Z  
2026-02-20T22:09:14.1194949Z  async def get_setting_bool(key: str, default: bool = False) -> bool:
2026-02-20T22:09:14.1397300Z --- /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1398166Z +++ /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py	2026-02-20 22:09:14.138919+00:00
2026-02-20T22:09:14.1398818Z @@ -1,13 +1,13 @@
2026-02-20T22:09:14.1399715Z  """
2026-02-20T22:09:14.1401024Z  Utilitaires SSE (Server-Sent Events) — DRY pour génération IA en streaming.
2026-02-20T22:09:14.1401553Z  """
2026-02-20T22:09:14.1402453Z +
2026-02-20T22:09:14.1403557Z  import json
2026-02-20T22:09:14.1404474Z  from typing import AsyncGenerator
2026-02-20T22:09:14.1406441Z  
2026-02-20T22:09:14.1407445Z  from starlette.responses import StreamingResponse
2026-02-20T22:09:14.1408574Z -
2026-02-20T22:09:14.1409474Z  
2026-02-20T22:09:14.1412399Z  SSE_HEADERS = {
2026-02-20T22:09:14.1412676Z      "Cache-Control": "no-cache",
2026-02-20T22:09:14.1412824Z      "Connection": "keep-alive",
2026-02-20T22:09:14.1412932Z  }
2026-02-20T22:09:14.1413210Z @@ -16,11 +16,13 @@
2026-02-20T22:09:14.1413558Z  async def sse_error_generator(message: str) -> AsyncGenerator[str, None]:
2026-02-20T22:09:14.1413949Z      """Générateur async SSE pour envoyer une erreur."""
2026-02-20T22:09:14.1414293Z      yield f"data: {json.dumps({'type': 'error', 'message': message})}\n\n"
2026-02-20T22:09:14.1414401Z  
2026-02-20T22:09:14.1414498Z  
2026-02-20T22:09:14.1414928Z -def sse_error_response(message: str, extra_headers: dict | None = None) -> StreamingResponse:
2026-02-20T22:09:14.1415072Z +def sse_error_response(
2026-02-20T22:09:14.1415259Z +    message: str, extra_headers: dict | None = None
2026-02-20T22:09:14.1415409Z +) -> StreamingResponse:
2026-02-20T22:09:14.1415703Z      """Retourne une StreamingResponse SSE avec un message d'erreur."""
2026-02-20T22:09:14.1415868Z      headers = dict(SSE_HEADERS)
2026-02-20T22:09:14.1416001Z      if extra_headers:
2026-02-20T22:09:14.1416168Z          headers.update(extra_headers)
2026-02-20T22:09:14.1416547Z would reformat /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py
2026-02-20T22:09:14.1416702Z      return StreamingResponse(
2026-02-20T22:09:14.1535510Z --- /home/runner/work/mathakine/mathakine/server/__init__.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.1536713Z +++ /home/runner/work/mathakine/mathakine/server/__init__.py	2026-02-20 22:09:14.152967+00:00
2026-02-20T22:09:14.1538928Z @@ -9,12 +9,12 @@
2026-02-20T22:09:14.1539431Z  from server.app import create_app, run_server
2026-02-20T22:09:14.1539893Z  from server.database import get_database_url, init_database
2026-02-20T22:09:14.1540330Z  from server.template_handler import render_error, render_template
2026-02-20T22:09:14.1540606Z  
2026-02-20T22:09:14.1542523Z  __all__ = [
2026-02-20T22:09:14.1543130Z -    'create_app',
2026-02-20T22:09:14.1543436Z -    'run_server',
2026-02-20T22:09:14.1543697Z -    'render_template',
2026-02-20T22:09:14.1543923Z -    'render_error',
2026-02-20T22:09:14.1544154Z -    'init_database',
2026-02-20T22:09:14.1544395Z -    'get_database_url',
2026-02-20T22:09:14.1544656Z -] 
2026-02-20T22:09:14.1544917Z \ No newline at end of file
2026-02-20T22:09:14.1545164Z +    "create_app",
2026-02-20T22:09:14.1545468Z +    "run_server",
2026-02-20T22:09:14.1545723Z +    "render_template",
2026-02-20T22:09:14.1546010Z +    "render_error",
2026-02-20T22:09:14.1546245Z +    "init_database",
2026-02-20T22:09:14.1546545Z +    "get_database_url",
2026-02-20T22:09:14.1546752Z +]
2026-02-20T22:09:14.1553310Z would reformat /home/runner/work/mathakine/mathakine/server/__init__.py
2026-02-20T22:09:14.2023223Z --- /home/runner/work/mathakine/mathakine/server/app.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.2023703Z +++ /home/runner/work/mathakine/mathakine/server/app.py	2026-02-20 22:09:14.200843+00:00
2026-02-20T22:09:14.2023836Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.2024018Z  App initialization for Mathakine.
2026-02-20T22:09:14.2024130Z  
2026-02-20T22:09:14.2024490Z  This module centralizes Starlette application creation and configuration.
2026-02-20T22:09:14.2024871Z  It ties together routes, middleware, exception handlers, and other components.
2026-02-20T22:09:14.2024982Z  """
2026-02-20T22:09:14.2025488Z +
2026-02-20T22:09:14.2025631Z  import os
2026-02-20T22:09:14.2025739Z  
2026-02-20T22:09:14.2025866Z  import uvicorn
2026-02-20T22:09:14.2026082Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.2026310Z  from app.core.monitoring import init_monitoring
2026-02-20T22:09:14.2026431Z @@ -21,14 +22,14 @@
2026-02-20T22:09:14.2026780Z  
2026-02-20T22:09:14.2026895Z  
2026-02-20T22:09:14.2027115Z  def create_app(debug: bool = False) -> Starlette:
2026-02-20T22:09:14.2027228Z      """
2026-02-20T22:09:14.2027449Z      Create and configure the Starlette application.
2026-02-20T22:09:14.2093427Z -    
2026-02-20T22:09:14.2093589Z +
2026-02-20T22:09:14.2093731Z      Args:
2026-02-20T22:09:14.2093918Z          debug: Whether to enable debug mode
2026-02-20T22:09:14.2094034Z -        
2026-02-20T22:09:14.2094148Z +
2026-02-20T22:09:14.2094280Z      Returns:
2026-02-20T22:09:14.2094456Z          Configured Starlette application
2026-02-20T22:09:14.2094561Z      """
2026-02-20T22:09:14.2094811Z      # Monitoring : Sentry + Prometheus (audit HIGH #1)
2026-02-20T22:09:14.2094946Z      init_monitoring()
2026-02-20T22:09:14.2095062Z @@ -37,48 +38,46 @@
2026-02-20T22:09:14.2095194Z      app = Starlette(
2026-02-20T22:09:14.2095328Z          debug=debug,
2026-02-20T22:09:14.2095462Z          routes=get_routes(),
2026-02-20T22:09:14.2095615Z          middleware=get_middleware(),
2026-02-20T22:09:14.2095847Z          exception_handlers=get_exception_handlers(),
2026-02-20T22:09:14.2095987Z -        on_startup=[startup]
2026-02-20T22:09:14.2096126Z +        on_startup=[startup],
2026-02-20T22:09:14.2096243Z      )
2026-02-20T22:09:14.2096352Z -    
2026-02-20T22:09:14.2096459Z +
2026-02-20T22:09:14.2096696Z      # Store templates in application state for API routes
2026-02-20T22:09:14.2096883Z      app.state.templates = get_templates()
2026-02-20T22:09:14.2096995Z -    
2026-02-20T22:09:14.2097103Z +
2026-02-20T22:09:14.2097229Z      return app
2026-02-20T22:09:14.2097335Z +
2026-02-20T22:09:14.2097451Z  
2026-02-20T22:09:14.2097587Z  async def startup():
2026-02-20T22:09:14.2097713Z      """
2026-02-20T22:09:14.2097905Z      Startup event handler for the application.
2026-02-20T22:09:14.2098018Z -    
2026-02-20T22:09:14.2098136Z +
2026-02-20T22:09:14.2098379Z      This function is called when the application starts.
2026-02-20T22:09:14.2098657Z      It initializes the database and performs other setup tasks.
2026-02-20T22:09:14.2098781Z      """
2026-02-20T22:09:14.2098986Z      logger.info("Starting up Mathakine server")
2026-02-20T22:09:14.2099115Z      init_database()
2026-02-20T22:09:14.2099222Z -    
2026-02-20T22:09:14.2099337Z +
2026-02-20T22:09:14.2099993Z      # Note: La migration email est désormais gérée via Alembic (migrations/versions/)
2026-02-20T22:09:14.2100345Z would reformat /home/runner/work/mathakine/mathakine/server/app.py
2026-02-20T22:09:14.2101056Z      # L'ancien script scripts/apply_email_verification_migration.py a été archivé dans _ARCHIVE_2026
2026-02-20T22:09:14.2101184Z -    
2026-02-20T22:09:14.2101314Z +
2026-02-20T22:09:14.2101560Z      logger.info("Mathakine server started successfully")
2026-02-20T22:09:14.2101679Z +
2026-02-20T22:09:14.2101787Z  
2026-02-20T22:09:14.2102115Z  def run_server(host: str = "0.0.0.0", port: int = 8000, debug: bool = False):
2026-02-20T22:09:14.2102248Z      """
2026-02-20T22:09:14.2102411Z      Run the Starlette server.
2026-02-20T22:09:14.2102518Z -    
2026-02-20T22:09:14.2102622Z +
2026-02-20T22:09:14.2102745Z      Args:
2026-02-20T22:09:14.2102878Z          host: Host to bind to
2026-02-20T22:09:14.2103538Z          port: Port to bind to
2026-02-20T22:09:14.2103745Z          debug: Whether to enable debug mode
2026-02-20T22:09:14.2103858Z      """
2026-02-20T22:09:14.2104168Z      log_level = os.environ.get("MATH_TRAINER_LOG_LEVEL", "INFO").lower()
2026-02-20T22:09:14.2104280Z -    
2026-02-20T22:09:14.2104399Z +
2026-02-20T22:09:14.2104753Z      logger.info(f"Starting Mathakine server on {host}:{port} (debug={debug})")
2026-02-20T22:09:14.2105130Z -    
2026-02-20T22:09:14.2105249Z +
2026-02-20T22:09:14.2105379Z      uvicorn.run(
2026-02-20T22:09:14.2105528Z -        "enhanced_server:app",
2026-02-20T22:09:14.2105647Z -        host=host,
2026-02-20T22:09:14.2105782Z -        port=port,
2026-02-20T22:09:14.2105911Z -        reload=debug,
2026-02-20T22:09:14.2106048Z -        log_level=log_level
2026-02-20T22:09:14.2106402Z -    ) 
2026-02-20T22:09:14.2106551Z \ No newline at end of file
2026-02-20T22:09:14.2106927Z +        "enhanced_server:app", host=host, port=port, reload=debug, log_level=log_level
2026-02-20T22:09:14.2107054Z +    )
2026-02-20T22:09:14.2113711Z --- /home/runner/work/mathakine/mathakine/app/utils/translation.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.2114370Z +++ /home/runner/work/mathakine/mathakine/app/utils/translation.py	2026-02-20 22:09:14.208535+00:00
2026-02-20T22:09:14.2114655Z @@ -11,164 +11,160 @@
2026-02-20T22:09:14.2114766Z  {
2026-02-20T22:09:14.2114916Z    "fr": ["Choix 1", "Choix 2"],
2026-02-20T22:09:14.2115069Z    "en": ["Choice 1", "Choice 2"]
2026-02-20T22:09:14.2115182Z  }
2026-02-20T22:09:14.2115299Z  """
2026-02-20T22:09:14.2115404Z +
2026-02-20T22:09:14.2115595Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:14.2115702Z  
2026-02-20T22:09:14.2115875Z  from app.core.config import settings
2026-02-20T22:09:14.2115983Z  
2026-02-20T22:09:14.2116101Z  
2026-02-20T22:09:14.2116250Z  def get_translated_text(
2026-02-20T22:09:14.2116425Z      translations: Optional[Dict[str, Any]],
2026-02-20T22:09:14.2116554Z      locale: str = "fr",
2026-02-20T22:09:14.2116694Z -    fallback_locale: str = "fr"
2026-02-20T22:09:14.2116845Z +    fallback_locale: str = "fr",
2026-02-20T22:09:14.2116978Z  ) -> Optional[str]:
2026-02-20T22:09:14.2117090Z      """
2026-02-20T22:09:14.2117567Z      Récupère le texte traduit depuis un objet JSONB de traductions.
2026-02-20T22:09:14.2117683Z -    
2026-02-20T22:09:14.2117793Z +
2026-02-20T22:09:14.2117908Z      Args:
2026-02-20T22:09:14.2118240Z          translations: Dictionnaire JSONB des traductions {locale: text}
2026-02-20T22:09:14.2118542Z          locale: Locale demandée (fr, en, etc.)
2026-02-20T22:09:14.2118850Z          fallback_locale: Locale de repli si la traduction n'existe pas
2026-02-20T22:09:14.2118973Z -    
2026-02-20T22:09:14.2119085Z +
2026-02-20T22:09:14.2119208Z      Returns:
2026-02-20T22:09:14.2119369Z          Texte traduit ou None
2026-02-20T22:09:14.2119494Z      """
2026-02-20T22:09:14.2119633Z      if not translations:
2026-02-20T22:09:14.2119756Z          return None
2026-02-20T22:09:14.2119876Z -    
2026-02-20T22:09:14.2119984Z +
2026-02-20T22:09:14.2120232Z      # Essayer la locale demandée
2026-02-20T22:09:14.2120468Z      if locale in translations and translations[locale]:
2026-02-20T22:09:14.2120629Z          return translations[locale]
2026-02-20T22:09:14.2120739Z -    
2026-02-20T22:09:14.2120846Z +
2026-02-20T22:09:14.2121107Z      # Fallback vers la locale par défaut
2026-02-20T22:09:14.2121442Z      if fallback_locale in translations and translations[fallback_locale]:
2026-02-20T22:09:14.2121637Z          return translations[fallback_locale]
2026-02-20T22:09:14.2121759Z -    
2026-02-20T22:09:14.2121869Z +
2026-02-20T22:09:14.2122175Z      # Fallback vers la première locale disponible
2026-02-20T22:09:14.2122307Z      if translations:
2026-02-20T22:09:14.2122493Z          first_locale = next(iter(translations))
2026-02-20T22:09:14.2122659Z          return translations[first_locale]
2026-02-20T22:09:14.2122762Z -    
2026-02-20T22:09:14.2122874Z +
2026-02-20T22:09:14.2123189Z      return None
2026-02-20T22:09:14.2123306Z  
2026-02-20T22:09:14.2123418Z  
2026-02-20T22:09:14.2123584Z  def get_translated_array(
2026-02-20T22:09:14.2123792Z      translations: Optional[Dict[str, List[str]]],
2026-02-20T22:09:14.2123930Z      locale: str = "fr",
2026-02-20T22:09:14.2124091Z -    fallback_locale: str = "fr"
2026-02-20T22:09:14.2124238Z +    fallback_locale: str = "fr",
2026-02-20T22:09:14.2124384Z  ) -> Optional[List[str]]:
2026-02-20T22:09:14.2124760Z      """
2026-02-20T22:09:14.2125219Z      Récupère un array traduit depuis un objet JSONB de traductions.
2026-02-20T22:09:14.2125341Z -    
2026-02-20T22:09:14.2125455Z +
2026-02-20T22:09:14.2125590Z      Args:
2026-02-20T22:09:14.2125919Z          translations: Dictionnaire JSONB des traductions {locale: [items]}
2026-02-20T22:09:14.2126394Z          locale: Locale demandée
2026-02-20T22:09:14.2126564Z          fallback_locale: Locale de repli
2026-02-20T22:09:14.2126683Z -    
2026-02-20T22:09:14.2126792Z +
2026-02-20T22:09:14.2126909Z      Returns:
2026-02-20T22:09:14.2127066Z          Liste traduite ou None
2026-02-20T22:09:14.2127182Z      """
2026-02-20T22:09:14.2127319Z      if not translations:
2026-02-20T22:09:14.2127443Z          return None
2026-02-20T22:09:14.2127564Z -    
2026-02-20T22:09:14.2127676Z +
2026-02-20T22:09:14.2127913Z      if locale in translations and translations[locale]:
2026-02-20T22:09:14.2128081Z          return translations[locale]
2026-02-20T22:09:14.2128212Z -    
2026-02-20T22:09:14.2128321Z +
2026-02-20T22:09:14.2128657Z      if fallback_locale in translations and translations[fallback_locale]:
2026-02-20T22:09:14.2128851Z          return translations[fallback_locale]
2026-02-20T22:09:14.2128964Z -    
2026-02-20T22:09:14.2129074Z +
2026-02-20T22:09:14.2129216Z      if translations:
2026-02-20T22:09:14.2129409Z          first_locale = next(iter(translations))
2026-02-20T22:09:14.2129570Z          return translations[first_locale]
2026-02-20T22:09:14.2129679Z -    
2026-02-20T22:09:14.2129796Z +
2026-02-20T22:09:14.2129921Z      return None
2026-02-20T22:09:14.2130028Z  
2026-02-20T22:09:14.2130144Z  
2026-02-20T22:09:14.2130298Z  def build_translations_dict(
2026-02-20T22:09:14.2130440Z -    fr_text: Optional[str],
2026-02-20T22:09:14.2130588Z -    en_text: Optional[str] = None,
2026-02-20T22:09:14.2130727Z -    **other_locales
2026-02-20T22:09:14.2131050Z +    fr_text: Optional[str], en_text: Optional[str] = None, **other_locales
2026-02-20T22:09:14.2131199Z  ) -> Dict[str, Any]:
2026-02-20T22:09:14.2131326Z      """
2026-02-20T22:09:14.2131645Z      Construit un dictionnaire de traductions pour insertion en JSONB.
2026-02-20T22:09:14.2131757Z -    
2026-02-20T22:09:14.2131866Z +
2026-02-20T22:09:14.2131995Z      Args:
2026-02-20T22:09:14.2132305Z          fr_text: Texte français (obligatoire)
2026-02-20T22:09:14.2132493Z          en_text: Texte anglais (optionnel)
2026-02-20T22:09:14.2132896Z          **other_locales: Autres langues (ex: es="Texto en español")
2026-02-20T22:09:14.2133219Z -    
2026-02-20T22:09:14.2133346Z +
2026-02-20T22:09:14.2133467Z      Returns:
2026-02-20T22:09:14.2133633Z          Dictionnaire de traductions
2026-02-20T22:09:14.2133744Z -    
2026-02-20T22:09:14.2133856Z +
2026-02-20T22:09:14.2133985Z      Example:
2026-02-20T22:09:14.2134248Z          >>> build_translations_dict("Bonjour", "Hello", es="Hola")
2026-02-20T22:09:14.2134437Z          {"fr": "Bonjour", "en": "Hello", "es": "Hola"}
2026-02-20T22:09:14.2134562Z      """
2026-02-20T22:09:14.2134727Z      translations = {"fr": fr_text}
2026-02-20T22:09:14.2134842Z -    
2026-02-20T22:09:14.2134951Z +
2026-02-20T22:09:14.2135081Z      if en_text:
2026-02-20T22:09:14.2135229Z          translations["en"] = en_text
2026-02-20T22:09:14.2135339Z -    
2026-02-20T22:09:14.2135446Z +
2026-02-20T22:09:14.2135626Z      translations.update(other_locales)
2026-02-20T22:09:14.2135745Z -    
2026-02-20T22:09:14.2135852Z +
2026-02-20T22:09:14.2135997Z      return translations
2026-02-20T22:09:14.2136103Z  
2026-02-20T22:09:14.2136214Z  
2026-02-20T22:09:14.2136380Z  def build_translations_array(
2026-02-20T22:09:14.2136532Z -    fr_array: Optional[List[str]],
2026-02-20T22:09:14.2136697Z -    en_array: Optional[List[str]] = None,
2026-02-20T22:09:14.2136830Z -    **other_locales
2026-02-20T22:09:14.2137214Z +    fr_array: Optional[List[str]], en_array: Optional[List[str]] = None, **other_locales
2026-02-20T22:09:14.2137364Z  ) -> Dict[str, List[str]]:
2026-02-20T22:09:14.2137477Z      """
2026-02-20T22:09:14.2137967Z      Construit un dictionnaire de traductions pour arrays.
2026-02-20T22:09:14.2138089Z -    
2026-02-20T22:09:14.2138200Z +
2026-02-20T22:09:14.2138322Z      Args:
2026-02-20T22:09:14.2138631Z          fr_array: Array français (obligatoire)
2026-02-20T22:09:14.2138802Z          en_array: Array anglais (optionnel)
2026-02-20T22:09:14.2139494Z          **other_locales: Autres langues (ex: es=["Opción 1", "Opción 2"])
2026-02-20T22:09:14.2139622Z -    
2026-02-20T22:09:14.2139732Z +
2026-02-20T22:09:14.2139852Z      Returns:
2026-02-20T22:09:14.2140044Z          Dictionnaire de traductions pour arrays
2026-02-20T22:09:14.2140151Z -    
2026-02-20T22:09:14.2140261Z +
2026-02-20T22:09:14.2140377Z      Example:
2026-02-20T22:09:14.2140739Z          >>> build_translations_array(["Choix 1", "Choix 2"], ["Choice 1", "Choice 2"])
2026-02-20T22:09:14.2140988Z          {"fr": ["Choix 1", "Choix 2"], "en": ["Choice 1", "Choice 2"]}
2026-02-20T22:09:14.2141108Z      """
2026-02-20T22:09:14.2141291Z      translations = {"fr": fr_array}
2026-02-20T22:09:14.2141402Z -    
2026-02-20T22:09:14.2141514Z +
2026-02-20T22:09:14.2141639Z      if en_array:
2026-02-20T22:09:14.2141800Z          translations["en"] = en_array
2026-02-20T22:09:14.2141908Z -    
2026-02-20T22:09:14.2142018Z +
2026-02-20T22:09:14.2142188Z      translations.update(other_locales)
2026-02-20T22:09:14.2142310Z -    
2026-02-20T22:09:14.2142416Z +
2026-02-20T22:09:14.2142553Z      return translations
2026-02-20T22:09:14.2142668Z  
2026-02-20T22:09:14.2142776Z  
2026-02-20T22:09:14.2163366Z  def parse_accept_language(accept_language: Optional[str]) -> str:
2026-02-20T22:09:14.2163527Z      """
2026-02-20T22:09:14.2164022Z      Parse le header Accept-Language et retourne la locale préférée.
2026-02-20T22:09:14.2164145Z -    
2026-02-20T22:09:14.2164257Z +
2026-02-20T22:09:14.2164388Z      Args:
2026-02-20T22:09:14.2164743Z          accept_language: Header Accept-Language (ex: "en-US,en;q=0.9,fr;q=0.8")
2026-02-20T22:09:14.2164851Z -    
2026-02-20T22:09:14.2164986Z +
2026-02-20T22:09:14.2165103Z      Returns:
2026-02-20T22:09:14.2165458Z          Locale préférée (fr, en, etc.) ou "fr" par défaut
2026-02-20T22:09:14.2165582Z      """
2026-02-20T22:09:14.2165732Z      if not accept_language:
2026-02-20T22:09:14.2165857Z          return "fr"
2026-02-20T22:09:14.2165966Z -    
2026-02-20T22:09:14.2166103Z +
2026-02-20T22:09:14.2166447Z      # Extraire la première locale (la plus préférée)
2026-02-20T22:09:14.2166756Z      first_locale = accept_language.split(",")[0].split(";")[0].strip()
2026-02-20T22:09:14.2166885Z -    
2026-02-20T22:09:14.2166997Z +
2026-02-20T22:09:14.2167211Z      # Extraire le code langue (ex: "en-US" -> "en")
2026-02-20T22:09:14.2167413Z      lang_code = first_locale.split("-")[0].lower()
2026-02-20T22:09:14.2167533Z -    
2026-02-20T22:09:14.2167639Z +
2026-02-20T22:09:14.2167936Z      # Valider que c'est une locale supportée
2026-02-20T22:09:14.2168106Z      supported_locales = ["fr", "en"]
2026-02-20T22:09:14.2168237Z -    
2026-02-20T22:09:14.2168347Z +
2026-02-20T22:09:14.2168514Z      if lang_code in supported_locales:
2026-02-20T22:09:14.2168655Z          return lang_code
2026-02-20T22:09:14.2168765Z -    
2026-02-20T22:09:14.2168872Z +
2026-02-20T22:09:14.2168998Z      return "fr"
2026-02-20T22:09:14.2169105Z -
2026-02-20T22:09:14.2169504Z would reformat /home/runner/work/mathakine/mathakine/app/utils/translation.py
2026-02-20T22:09:14.2857194Z --- /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.2859941Z +++ /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py	2026-02-20 22:09:14.282978+00:00
2026-02-20T22:09:14.2870645Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.2870986Z  """
2026-02-20T22:09:14.2871391Z  Module de tracking de l'utilisation des tokens OpenAI.
2026-02-20T22:09:14.2872314Z  Permet de monitorer les coûts et l'utilisation de l'API.
2026-02-20T22:09:14.2872868Z  """
2026-02-20T22:09:14.2873325Z +
2026-02-20T22:09:14.2873582Z  import json
2026-02-20T22:09:14.2874274Z  from collections import defaultdict
2026-02-20T22:09:14.2874763Z  from datetime import datetime
2026-02-20T22:09:14.2876515Z  from typing import Dict, Optional
2026-02-20T22:09:14.2878149Z  
2026-02-20T22:09:14.2879655Z @@ -12,168 +13,174 @@
2026-02-20T22:09:14.2881234Z  logger = get_logger(__name__)
2026-02-20T22:09:14.2882124Z  
2026-02-20T22:09:14.2882533Z  
2026-02-20T22:09:14.2882922Z  class TokenTracker:
2026-02-20T22:09:14.2884201Z      """Tracker simple en mémoire pour l'utilisation des tokens (peut être migré vers DB)."""
2026-02-20T22:09:14.2888343Z -    
2026-02-20T22:09:14.2888785Z +
2026-02-20T22:09:14.2889268Z      def __init__(self):
2026-02-20T22:09:14.2891040Z          # Structure: {challenge_type: [{"timestamp": datetime, "tokens": int, "cost": float}]}
2026-02-20T22:09:14.2892114Z would reformat /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py
2026-02-20T22:09:14.2893311Z          self._usage_history: Dict[str, list] = defaultdict(list)
2026-02-20T22:09:14.2895840Z -        self._daily_totals: Dict[str, Dict] = defaultdict(lambda: {"tokens": 0, "cost": 0.0})
2026-02-20T22:09:14.2896577Z -    
2026-02-20T22:09:14.2896973Z +        self._daily_totals: Dict[str, Dict] = defaultdict(
2026-02-20T22:09:14.2897538Z +            lambda: {"tokens": 0, "cost": 0.0}
2026-02-20T22:09:14.2897981Z +        )
2026-02-20T22:09:14.2898270Z +
2026-02-20T22:09:14.2898554Z      def track_usage(
2026-02-20T22:09:14.2898879Z          self,
2026-02-20T22:09:14.2899192Z          challenge_type: str,
2026-02-20T22:09:14.2899582Z          prompt_tokens: int,
2026-02-20T22:09:14.2899985Z          completion_tokens: int,
2026-02-20T22:09:14.2900399Z -        model: str = "gpt-4o-mini"
2026-02-20T22:09:14.2900840Z +        model: str = "gpt-4o-mini",
2026-02-20T22:09:14.2901264Z      ) -> Dict[str, float]:
2026-02-20T22:09:14.2901623Z          """
2026-02-20T22:09:14.2902172Z          Track l'utilisation de tokens pour une génération.
2026-02-20T22:09:14.2902684Z -        
2026-02-20T22:09:14.2903167Z +
2026-02-20T22:09:14.2903436Z          Args:
2026-02-20T22:09:14.2903956Z              challenge_type: Type de challenge généré
2026-02-20T22:09:14.2904536Z              prompt_tokens: Nombre de tokens dans le prompt
2026-02-20T22:09:14.2905316Z              completion_tokens: Nombre de tokens dans la réponse
2026-02-20T22:09:14.2906009Z              model: Modèle OpenAI utilisé
2026-02-20T22:09:14.2906461Z -            
2026-02-20T22:09:14.2906762Z +
2026-02-20T22:09:14.2907021Z          Returns:
2026-02-20T22:09:14.2907624Z              Dict avec 'tokens' (total) et 'cost' (coût estimé en USD)
2026-02-20T22:09:14.2908173Z          """
2026-02-20T22:09:14.2908567Z          total_tokens = prompt_tokens + completion_tokens
2026-02-20T22:09:14.2909061Z -        
2026-02-20T22:09:14.2909332Z +
2026-02-20T22:09:14.2909939Z          # Coûts par modèle (USD par 1K tokens) - Mise à jour janvier 2025
2026-02-20T22:09:14.2910621Z          # Source: https://openai.com/pricing
2026-02-20T22:09:14.2911202Z          cost_per_1k_tokens = {
2026-02-20T22:09:14.2911608Z              "gpt-4o-mini": {
2026-02-20T22:09:14.2912120Z -                "input": 0.15 / 1000,   # $0.15 per 1M tokens = $0.00015 per 1K
2026-02-20T22:09:14.2912788Z +                "input": 0.15 / 1000,  # $0.15 per 1M tokens = $0.00015 per 1K
2026-02-20T22:09:14.2913673Z                  "output": 0.60 / 1000,  # $0.60 per 1M tokens = $0.0006 per 1K
2026-02-20T22:09:14.2914220Z              },
2026-02-20T22:09:14.2914534Z              "gpt-4o": {
2026-02-20T22:09:14.2915008Z -                "input": 2.50 / 1000,   # $2.50 per 1M tokens = $0.0025 per 1K
2026-02-20T22:09:14.2915689Z -                "output": 10.00 / 1000, # $10.00 per 1M tokens = $0.01 per 1K
2026-02-20T22:09:14.2916363Z +                "input": 2.50 / 1000,  # $2.50 per 1M tokens = $0.0025 per 1K
2026-02-20T22:09:14.2917035Z +                "output": 10.00 / 1000,  # $10.00 per 1M tokens = $0.01 per 1K
2026-02-20T22:09:14.2917588Z              },
2026-02-20T22:09:14.2918165Z              "gpt-4-turbo": {
2026-02-20T22:09:14.2918627Z                  "input": 10.00 / 1000,  # $10.00 per 1M tokens
2026-02-20T22:09:14.2919181Z -                "output": 30.00 / 1000, # $30.00 per 1M tokens
2026-02-20T22:09:14.2919747Z +                "output": 30.00 / 1000,  # $30.00 per 1M tokens
2026-02-20T22:09:14.2920463Z              },
2026-02-20T22:09:14.2920750Z          }
2026-02-20T22:09:14.2921029Z -        
2026-02-20T22:09:14.2921300Z +
2026-02-20T22:09:14.2921700Z          # Calculer le coût
2026-02-20T22:09:14.2922315Z          model_costs = cost_per_1k_tokens.get(model, cost_per_1k_tokens["gpt-4o-mini"])
2026-02-20T22:09:14.2925594Z -        cost = (prompt_tokens / 1000 * model_costs["input"]) + (completion_tokens / 1000 * model_costs["output"])
2026-02-20T22:09:14.2926440Z -        
2026-02-20T22:09:14.2926878Z +        cost = (prompt_tokens / 1000 * model_costs["input"]) + (
2026-02-20T22:09:14.2927536Z +            completion_tokens / 1000 * model_costs["output"]
2026-02-20T22:09:14.2928054Z +        )
2026-02-20T22:09:14.2928326Z +
2026-02-20T22:09:14.2928616Z          # Enregistrer l'utilisation
2026-02-20T22:09:14.2929045Z          usage_record = {
2026-02-20T22:09:14.2929431Z              "timestamp": datetime.now(),
2026-02-20T22:09:14.2929908Z              "prompt_tokens": prompt_tokens,
2026-02-20T22:09:14.2930428Z              "completion_tokens": completion_tokens,
2026-02-20T22:09:14.2930931Z              "total_tokens": total_tokens,
2026-02-20T22:09:14.2931363Z              "cost": cost,
2026-02-20T22:09:14.2931724Z              "model": model,
2026-02-20T22:09:14.2932070Z          }
2026-02-20T22:09:14.2932336Z -        
2026-02-20T22:09:14.2932604Z +
2026-02-20T22:09:14.2933193Z          self._usage_history[challenge_type].append(usage_record)
2026-02-20T22:09:14.2933748Z -        
2026-02-20T22:09:14.2934021Z +
2026-02-20T22:09:14.2934484Z          # Mettre à jour les totaux quotidiens
2026-02-20T22:09:14.2934969Z          today = datetime.now().date()
2026-02-20T22:09:14.2935456Z          day_key = f"{challenge_type}_{today}"
2026-02-20T22:09:14.2936007Z          self._daily_totals[day_key]["tokens"] += total_tokens
2026-02-20T22:09:14.2936611Z          self._daily_totals[day_key]["cost"] += cost
2026-02-20T22:09:14.2937087Z -        
2026-02-20T22:09:14.2937362Z +
2026-02-20T22:09:14.2937640Z          logger.info(
2026-02-20T22:09:14.2938090Z              f"Token usage tracked - Type: {challenge_type}, "
2026-02-20T22:09:14.2938917Z              f"Tokens: {total_tokens} (prompt: {prompt_tokens}, completion: {completion_tokens}), "
2026-02-20T22:09:14.2939711Z              f"Cost: ${cost:.6f}, Model: {model}"
2026-02-20T22:09:14.2940169Z          )
2026-02-20T22:09:14.2940447Z -        
2026-02-20T22:09:14.2940706Z +
2026-02-20T22:09:14.2940968Z          return {
2026-02-20T22:09:14.2941287Z              "tokens": total_tokens,
2026-02-20T22:09:14.2941711Z              "cost": cost,
2026-02-20T22:09:14.2942115Z              "prompt_tokens": prompt_tokens,
2026-02-20T22:09:14.2942647Z              "completion_tokens": completion_tokens,
2026-02-20T22:09:14.2943289Z          }
2026-02-20T22:09:14.2943571Z -    
2026-02-20T22:09:14.2943836Z +
2026-02-20T22:09:14.2944360Z      def get_stats(self, challenge_type: Optional[str] = None, days: int = 1) -> Dict:
2026-02-20T22:09:14.2945043Z          """
2026-02-20T22:09:14.2945406Z          Retourne les statistiques d'utilisation.
2026-02-20T22:09:14.2945877Z -        
2026-02-20T22:09:14.2946153Z +
2026-02-20T22:09:14.2946417Z          Args:
2026-02-20T22:09:14.2946829Z              challenge_type: Type de challenge (None pour tous)
2026-02-20T22:09:14.2947558Z              days: Nombre de jours à considérer
2026-02-20T22:09:14.2948010Z -            
2026-02-20T22:09:14.2948306Z +
2026-02-20T22:09:14.2948564Z          Returns:
2026-02-20T22:09:14.2949039Z              Dict avec statistiques agrégées
2026-02-20T22:09:14.2949480Z          """
2026-02-20T22:09:14.2949806Z          from datetime import timedelta
2026-02-20T22:09:14.2950551Z -        
2026-02-20T22:09:14.2950824Z +
2026-02-20T22:09:14.2951206Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.2951710Z -        
2026-02-20T22:09:14.2951986Z +
2026-02-20T22:09:14.2952262Z          if challenge_type:
2026-02-20T22:09:14.2952640Z              records = [
2026-02-20T22:09:14.2953641Z -                r for r in self._usage_history[challenge_type]
2026-02-20T22:09:14.2955939Z +                r
2026-02-20T22:09:14.2958672Z +                for r in self._usage_history[challenge_type]
2026-02-20T22:09:14.2959316Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.2959785Z              ]
2026-02-20T22:09:14.2960086Z          else:
2026-02-20T22:09:14.2960397Z              # Tous les types
2026-02-20T22:09:14.2960769Z              records = []
2026-02-20T22:09:14.2961231Z              for type_records in self._usage_history.values():
2026-02-20T22:09:14.2961760Z -                records.extend([
2026-02-20T22:09:14.2962206Z -                    r for r in type_records
2026-02-20T22:09:14.2962667Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.2963333Z -                ])
2026-02-20T22:09:14.2963658Z -        
2026-02-20T22:09:14.2963956Z +                records.extend(
2026-02-20T22:09:14.2964483Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.2965056Z +                )
2026-02-20T22:09:14.2965352Z +
2026-02-20T22:09:14.2965622Z          if not records:
2026-02-20T22:09:14.2965975Z              return {
2026-02-20T22:09:14.2966319Z                  "total_tokens": 0,
2026-02-20T22:09:14.2966736Z                  "total_cost": 0.0,
2026-02-20T22:09:14.2967159Z                  "average_tokens": 0,
2026-02-20T22:09:14.2967570Z                  "count": 0,
2026-02-20T22:09:14.2967926Z              }
2026-02-20T22:09:14.2968211Z -        
2026-02-20T22:09:14.2968494Z +
2026-02-20T22:09:14.2968874Z          total_tokens = sum(r["total_tokens"] for r in records)
2026-02-20T22:09:14.2969495Z          total_cost = sum(r["cost"] for r in records)
2026-02-20T22:09:14.2970039Z          average_tokens = total_tokens / len(records)
2026-02-20T22:09:14.2970514Z -        
2026-02-20T22:09:14.2970784Z +
2026-02-20T22:09:14.2971030Z          return {
2026-02-20T22:09:14.2971357Z              "total_tokens": total_tokens,
2026-02-20T22:09:14.2971823Z              "total_cost": total_cost,
2026-02-20T22:09:14.2972277Z              "average_tokens": average_tokens,
2026-02-20T22:09:14.2972737Z              "count": len(records),
2026-02-20T22:09:14.2973582Z -            "by_type": self._get_stats_by_type(cutoff_date) if not challenge_type else {},
2026-02-20T22:09:14.2976369Z +            "by_type": (
2026-02-20T22:09:14.2992097Z +                self._get_stats_by_type(cutoff_date) if not challenge_type else {}
2026-02-20T22:09:14.2992757Z +            ),
2026-02-20T22:09:14.2993343Z          }
2026-02-20T22:09:14.2993627Z -    
2026-02-20T22:09:14.2993882Z +
2026-02-20T22:09:14.2994356Z      def _get_stats_by_type(self, cutoff_date: datetime) -> Dict[str, Dict]:
2026-02-20T22:09:14.2995199Z          """Retourne les stats groupées par type."""
2026-02-20T22:09:14.2995722Z          stats_by_type = {}
2026-02-20T22:09:14.2996066Z -        
2026-02-20T22:09:14.2996332Z +
2026-02-20T22:09:14.2996755Z          for challenge_type, records in self._usage_history.items():
2026-02-20T22:09:14.2997513Z              filtered = [r for r in records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.2998107Z              if filtered:
2026-02-20T22:09:14.2998509Z                  stats_by_type[challenge_type] = {
2026-02-20T22:09:14.3003819Z                      "total_tokens": sum(r["total_tokens"] for r in filtered),
2026-02-20T22:09:14.3004527Z                      "total_cost": sum(r["cost"] for r in filtered),
2026-02-20T22:09:14.3005097Z                      "count": len(filtered),
2026-02-20T22:09:14.3005787Z -                    "average_tokens": sum(r["total_tokens"] for r in filtered) / len(filtered),
2026-02-20T22:09:14.3006920Z +                    "average_tokens": sum(r["total_tokens"] for r in filtered)
2026-02-20T22:09:14.3007528Z +                    / len(filtered),
2026-02-20T22:09:14.3007926Z                  }
2026-02-20T22:09:14.3008242Z -        
2026-02-20T22:09:14.3008510Z +
2026-02-20T22:09:14.3008802Z          return stats_by_type
2026-02-20T22:09:14.3009394Z -    
2026-02-20T22:09:14.3009664Z +
2026-02-20T22:09:14.3010122Z      def get_daily_summary(self, date: Optional[datetime] = None) -> Dict:
2026-02-20T22:09:14.3010985Z          """Retourne un résumé quotidien."""
2026-02-20T22:09:14.3011432Z          if date is None:
2026-02-20T22:09:14.3011815Z              date = datetime.now()
2026-02-20T22:09:14.3012209Z -        
2026-02-20T22:09:14.3012480Z +
2026-02-20T22:09:14.3012766Z          date_key = date.date()
2026-02-20T22:09:14.3013352Z          summary = {}
2026-02-20T22:09:14.3013693Z -        
2026-02-20T22:09:14.3013964Z +
2026-02-20T22:09:14.3014342Z          for key, totals in self._daily_totals.items():
2026-02-20T22:09:14.3014849Z              if str(date_key) in key:
2026-02-20T22:09:14.3015328Z                  challenge_type = key.split("_")[0]
2026-02-20T22:09:14.3015845Z                  summary[challenge_type] = totals
2026-02-20T22:09:14.3016294Z -        
2026-02-20T22:09:14.3016585Z +
2026-02-20T22:09:14.3016852Z          return summary
2026-02-20T22:09:14.3017189Z  
2026-02-20T22:09:14.3017442Z  
2026-02-20T22:09:14.3017733Z  # Instance globale du tracker
2026-02-20T22:09:14.3018146Z  token_tracker = TokenTracker()
2026-02-20T22:09:14.3018530Z -
2026-02-20T22:09:14.3019061Z would reformat /home/runner/work/mathakine/mathakine/server/database.py
2026-02-20T22:09:14.3020015Z --- /home/runner/work/mathakine/mathakine/server/database.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3021104Z +++ /home/runner/work/mathakine/mathakine/server/database.py	2026-02-20 22:09:14.297372+00:00
2026-02-20T22:09:14.3021869Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.3022305Z  Database initialization and management for Mathakine.
2026-02-20T22:09:14.3022810Z  
2026-02-20T22:09:14.3023464Z  This module centralizes database operations for the enhanced server,
2026-02-20T22:09:14.3024309Z  providing initialization, connection management, and utility functions.
2026-02-20T22:09:14.3024941Z  """
2026-02-20T22:09:14.3025207Z +
2026-02-20T22:09:14.3025459Z  import os
2026-02-20T22:09:14.3025745Z  import sys
2026-02-20T22:09:14.3026032Z  import traceback
2026-02-20T22:09:14.3026341Z  
2026-02-20T22:09:14.3026602Z  import psycopg2
2026-02-20T22:09:14.3026909Z @@ -18,39 +19,45 @@
2026-02-20T22:09:14.3027214Z  
2026-02-20T22:09:14.3027860Z  # Charger les variables d'environnement (ignorer .env en prod - sécurité)
2026-02-20T22:09:14.3028602Z  if os.environ.get("ENVIRONMENT") != "production":
2026-02-20T22:09:14.3029122Z      load_dotenv(override=False)
2026-02-20T22:09:14.3029517Z  
2026-02-20T22:09:14.3029768Z +
2026-02-20T22:09:14.3030059Z  def get_database_url() -> str:
2026-02-20T22:09:14.3030456Z      """
2026-02-20T22:09:14.3030842Z      Get the database URL from environment variables.
2026-02-20T22:09:14.3031333Z -    
2026-02-20T22:09:14.3031601Z +
2026-02-20T22:09:14.3031859Z      Returns:
2026-02-20T22:09:14.3032174Z          Database URL as a string
2026-02-20T22:09:14.3032556Z      """
2026-02-20T22:09:14.3033194Z      # Essayer d'abord la variable d'environnement DATABASE_URL
2026-02-20T22:09:14.3033825Z      db_url = os.environ.get("DATABASE_URL", "")
2026-02-20T22:09:14.3034271Z -    
2026-02-20T22:09:14.3034550Z +
2026-02-20T22:09:14.3035145Z      # Si pas définie, construire depuis les variables individuelles
2026-02-20T22:09:14.3035750Z      if not db_url:
2026-02-20T22:09:14.3036238Z          postgres_server = os.getenv("POSTGRES_SERVER", "localhost")
2026-02-20T22:09:14.3036949Z          postgres_user = os.getenv("POSTGRES_USER", "postgres")
2026-02-20T22:09:14.3037684Z          postgres_password = os.getenv("POSTGRES_PASSWORD", "postgres")
2026-02-20T22:09:14.3038654Z          postgres_db = os.getenv("POSTGRES_DB", "mathakine")
2026-02-20T22:09:14.3039510Z          db_url = f"postgresql://{postgres_user}:{postgres_password}@{postgres_server}/{postgres_db}"
2026-02-20T22:09:14.3040723Z -        logger.info(f"Using default DATABASE_URL: postgresql://{postgres_user}:***@{postgres_server}/{postgres_db}")
2026-02-20T22:09:14.3041843Z -    
2026-02-20T22:09:14.3042144Z +        logger.info(
2026-02-20T22:09:14.3042851Z +            f"Using default DATABASE_URL: postgresql://{postgres_user}:***@{postgres_server}/{postgres_db}"
2026-02-20T22:09:14.3043887Z +        )
2026-02-20T22:09:14.3044182Z +
2026-02-20T22:09:14.3044460Z      if not db_url:
2026-02-20T22:09:14.3045097Z -        logger.error("DATABASE_URL environment variable not set and no defaults available")
2026-02-20T22:09:14.3045863Z +        logger.error(
2026-02-20T22:09:14.3046426Z +            "DATABASE_URL environment variable not set and no defaults available"
2026-02-20T22:09:14.3047060Z +        )
2026-02-20T22:09:14.3047374Z          sys.exit(1)
2026-02-20T22:09:14.3047687Z -    
2026-02-20T22:09:14.3047965Z +
2026-02-20T22:09:14.3048230Z      return db_url
2026-02-20T22:09:14.3048531Z +
2026-02-20T22:09:14.3048777Z  
2026-02-20T22:09:14.3049057Z  def get_db_connection():
2026-02-20T22:09:14.3049403Z      """
2026-02-20T22:09:14.3049968Z      Obtient une connexion à la base de données PostgreSQL.
2026-02-20T22:09:14.3050506Z -    
2026-02-20T22:09:14.3050786Z +
2026-02-20T22:09:14.3051050Z      Returns:
2026-02-20T22:09:14.3051366Z          Une connexion psycopg2
2026-02-20T22:09:14.3051741Z      """
2026-02-20T22:09:14.3052007Z      try:
2026-02-20T22:09:14.3052363Z          conn = psycopg2.connect(get_database_url())
2026-02-20T22:09:14.3052836Z @@ -58,24 +65,25 @@
2026-02-20T22:09:14.3053492Z          return conn
2026-02-20T22:09:14.3053845Z      except Exception as e:
2026-02-20T22:09:14.3054504Z          logger.error(f"Erreur de connexion à PostgreSQL: {e}")
2026-02-20T22:09:14.3055034Z          raise e
2026-02-20T22:09:14.3055336Z  
2026-02-20T22:09:14.3055587Z +
2026-02-20T22:09:14.3055868Z  def init_database():
2026-02-20T22:09:14.3056191Z      """
2026-02-20T22:09:14.3056507Z      Initialize the database if necessary.
2026-02-20T22:09:14.3056940Z -    
2026-02-20T22:09:14.3057192Z +
2026-02-20T22:09:14.3057572Z      This function creates tables if they don't exist and
2026-02-20T22:09:14.3058146Z      performs other initialization tasks.
2026-02-20T22:09:14.3058594Z      """
2026-02-20T22:09:14.3058906Z      logger.info("Initializing database")
2026-02-20T22:09:14.3059339Z -    
2026-02-20T22:09:14.3059604Z +
2026-02-20T22:09:14.3059872Z      try:
2026-02-20T22:09:14.3060189Z          # Get a database connection
2026-02-20T22:09:14.3060631Z          conn = get_db_connection()
2026-02-20T22:09:14.3061061Z          cursor = conn.cursor()
2026-02-20T22:09:14.3061429Z -        
2026-02-20T22:09:14.3061712Z +
2026-02-20T22:09:14.3061967Z          try:
2026-02-20T22:09:14.3062345Z              # Create exercises table if it doesn't exist
2026-02-20T22:09:14.3062939Z              cursor.execute(ExerciseQueries.CREATE_TABLE)
2026-02-20T22:09:14.3063762Z  
2026-02-20T22:09:14.3064112Z              # Add ai_generated column if it doesn't exist
2026-02-20T22:09:14.3064603Z @@ -85,27 +93,28 @@
2026-02-20T22:09:14.3064926Z                  """)
2026-02-20T22:09:14.3065273Z                  conn.commit()
2026-02-20T22:09:14.3065682Z              except Exception as e:
2026-02-20T22:09:14.3066132Z                  logger.warning(f"Note: {str(e)}")
2026-02-20T22:09:14.3066618Z                  conn.rollback()
2026-02-20T22:09:14.3066983Z -                
2026-02-20T22:09:14.3067284Z +
2026-02-20T22:09:14.3067665Z              # Update existing exercises that contain the AI prefix
2026-02-20T22:09:14.3068295Z              from app.core.constants import Messages
2026-02-20T22:09:14.3068762Z +
2026-02-20T22:09:14.3069015Z              try:
2026-02-20T22:09:14.3069330Z                  cursor.execute(f"""
2026-02-20T22:09:14.3070029Z                  UPDATE exercises
2026-02-20T22:09:14.3070459Z                  SET ai_generated = TRUE
2026-02-20T22:09:14.3071248Z                  WHERE title LIKE '%{Messages.AI_EXERCISE_PREFIX}%' OR question LIKE '%{Messages.AI_EXERCISE_PREFIX}%'
2026-02-20T22:09:14.3072071Z                  """)
2026-02-20T22:09:14.3072404Z                  conn.commit()
2026-02-20T22:09:14.3073239Z              except Exception as e:
2026-02-20T22:09:14.3073705Z                  logger.warning(f"Note: {str(e)}")
2026-02-20T22:09:14.3074195Z                  conn.rollback()
2026-02-20T22:09:14.3074571Z -                
2026-02-20T22:09:14.3074869Z +
2026-02-20T22:09:14.3075214Z              # Create results table if it doesn't exist
2026-02-20T22:09:14.3075777Z              cursor.execute(ResultQueries.CREATE_TABLE)
2026-02-20T22:09:14.3076263Z -            
2026-02-20T22:09:14.3076546Z +
2026-02-20T22:09:14.3076897Z              # Create user_stats table if it doesn't exist
2026-02-20T22:09:14.3077417Z              cursor.execute("""
2026-02-20T22:09:14.3077863Z              CREATE TABLE IF NOT EXISTS user_stats (
2026-02-20T22:09:14.3078350Z                  id SERIAL PRIMARY KEY,
2026-02-20T22:09:14.3078823Z                  exercise_type VARCHAR(50) NOT NULL,
2026-02-20T22:09:14.3079294Z @@ -113,17 +122,17 @@
2026-02-20T22:09:14.3079667Z                  total_attempts INTEGER DEFAULT 0,
2026-02-20T22:09:14.3080199Z                  correct_attempts INTEGER DEFAULT 0,
2026-02-20T22:09:14.3080848Z                  last_updated TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:14.3081465Z              )
2026-02-20T22:09:14.3081749Z              """)
2026-02-20T22:09:14.3082048Z -            
2026-02-20T22:09:14.3082330Z +
2026-02-20T22:09:14.3082727Z              logger.success("Database initialized successfully")
2026-02-20T22:09:14.3083458Z -            
2026-02-20T22:09:14.3083753Z +
2026-02-20T22:09:14.3084016Z          finally:
2026-02-20T22:09:14.3084352Z              # Always close the connection
2026-02-20T22:09:14.3084810Z              cursor.close()
2026-02-20T22:09:14.3085183Z              conn.close()
2026-02-20T22:09:14.3085531Z -            
2026-02-20T22:09:14.3085811Z +
2026-02-20T22:09:14.3086101Z      except Exception as e:
2026-02-20T22:09:14.3086569Z          logger.error(f"Error initializing database: {e}")
2026-02-20T22:09:14.3087124Z          traceback.print_exc()
2026-02-20T22:09:14.3087513Z -        sys.exit(1) 
2026-02-20T22:09:14.3087862Z \ No newline at end of file
2026-02-20T22:09:14.3088232Z +        sys.exit(1)
2026-02-20T22:09:14.3458102Z would reformat /home/runner/work/mathakine/mathakine/server/error_handlers.py
2026-02-20T22:09:14.3459181Z --- /home/runner/work/mathakine/mathakine/server/error_handlers.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3460354Z +++ /home/runner/work/mathakine/mathakine/server/error_handlers.py	2026-02-20 22:09:14.342875+00:00
2026-02-20T22:09:14.3461128Z @@ -4,10 +4,11 @@
2026-02-20T22:09:14.3461686Z  This module centralizes Starlette exception handling logic for a consistent
2026-02-20T22:09:14.3462405Z  error management across the application.
2026-02-20T22:09:14.3462833Z  
2026-02-20T22:09:14.3463565Z  Since the frontend is now Next.js, all error responses are JSON (no HTML templates).
2026-02-20T22:09:14.3464228Z  """
2026-02-20T22:09:14.3464481Z +
2026-02-20T22:09:14.3464745Z  import traceback
2026-02-20T22:09:14.3465038Z  
2026-02-20T22:09:14.3465364Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.3465830Z  
2026-02-20T22:09:14.3466107Z  logger = get_logger(__name__)
2026-02-20T22:09:14.3466478Z @@ -17,59 +18,61 @@
2026-02-20T22:09:14.3466764Z  
2026-02-20T22:09:14.3467007Z  
2026-02-20T22:09:14.3467389Z  async def not_found(request: Request, exc: HTTPException):
2026-02-20T22:09:14.3467915Z      """
2026-02-20T22:09:14.3468210Z      Handle 404 Not Found errors.
2026-02-20T22:09:14.3468583Z -    
2026-02-20T22:09:14.3468843Z +
2026-02-20T22:09:14.3469081Z      Args:
2026-02-20T22:09:14.3469709Z          request: The Starlette request object
2026-02-20T22:09:14.3470194Z          exc: The exception that was raised
2026-02-20T22:09:14.3470615Z -        
2026-02-20T22:09:14.3470871Z +
2026-02-20T22:09:14.3471119Z      Returns:
2026-02-20T22:09:14.3471414Z          JSON error response
2026-02-20T22:09:14.3471768Z      """
2026-02-20T22:09:14.3472413Z      logger.warning(f"404 Not Found: {request.url.path}")
2026-02-20T22:09:14.3472943Z      return JSONResponse(
2026-02-20T22:09:14.3473495Z          {
2026-02-20T22:09:14.3473786Z              "error": "Not Found",
2026-02-20T22:09:14.3474284Z              "message": "The requested resource does not exist.",
2026-02-20T22:09:14.3474826Z -            "path": str(request.url.path)
2026-02-20T22:09:14.3475298Z +            "path": str(request.url.path),
2026-02-20T22:09:14.3475703Z          },
2026-02-20T22:09:14.3475990Z -        status_code=404
2026-02-20T22:09:14.3476350Z +        status_code=404,
2026-02-20T22:09:14.3476680Z      )
2026-02-20T22:09:14.3476949Z +
2026-02-20T22:09:14.3477188Z  
2026-02-20T22:09:14.3477578Z  async def server_error(request: Request, exc: Exception):
2026-02-20T22:09:14.3478100Z      """
2026-02-20T22:09:14.3478509Z      Handle 500 Server Error and other unexpected exceptions.
2026-02-20T22:09:14.3479023Z -    
2026-02-20T22:09:14.3479275Z +
2026-02-20T22:09:14.3479517Z      Args:
2026-02-20T22:09:14.3479855Z          request: The Starlette request object
2026-02-20T22:09:14.3480326Z          exc: The exception that was raised
2026-02-20T22:09:14.3480746Z -        
2026-02-20T22:09:14.3481011Z +
2026-02-20T22:09:14.3481255Z      Returns:
2026-02-20T22:09:14.3481556Z          JSON error response
2026-02-20T22:09:14.3481906Z      """
2026-02-20T22:09:14.3482199Z      # Log the error for debugging
2026-02-20T22:09:14.3482777Z      logger.error(f"500 Server Error for {request.url.path}: {str(exc)}")
2026-02-20T22:09:14.3484218Z      logger.error(traceback.format_exc())
2026-02-20T22:09:14.3485659Z -    
2026-02-20T22:09:14.3513543Z +
2026-02-20T22:09:14.3513854Z      return JSONResponse(
2026-02-20T22:09:14.3514220Z          {
2026-02-20T22:09:14.3514549Z              "error": "Internal Server Error",
2026-02-20T22:09:14.3515194Z              "message": "An internal server error occurred. Please try again later.",
2026-02-20T22:09:14.3515867Z -            "path": str(request.url.path)
2026-02-20T22:09:14.3516341Z +            "path": str(request.url.path),
2026-02-20T22:09:14.3516753Z          },
2026-02-20T22:09:14.3517030Z -        status_code=500
2026-02-20T22:09:14.3517382Z +        status_code=500,
2026-02-20T22:09:14.3517701Z      )
2026-02-20T22:09:14.3517959Z +
2026-02-20T22:09:14.3518195Z  
2026-02-20T22:09:14.3518481Z  def get_exception_handlers():
2026-02-20T22:09:14.3518846Z      """
2026-02-20T22:09:14.3519364Z      Get a dictionary of exception handlers for use in Starlette app initialization.
2026-02-20T22:09:14.3520021Z -    
2026-02-20T22:09:14.3520266Z +
2026-02-20T22:09:14.3520513Z      Returns:
2026-02-20T22:09:14.3520901Z          Dict mapping exception types to handler functions
2026-02-20T22:09:14.3521382Z      """
2026-02-20T22:09:14.3521633Z      return {
2026-02-20T22:09:14.3521927Z          404: not_found,
2026-02-20T22:09:14.3522269Z          500: server_error,
2026-02-20T22:09:14.3522736Z -        Exception: server_error  # Catch all other exceptions
2026-02-20T22:09:14.3523418Z -    } 
2026-02-20T22:09:14.3523704Z \ No newline at end of file
2026-02-20T22:09:14.3524176Z +        Exception: server_error,  # Catch all other exceptions
2026-02-20T22:09:14.3524677Z +    }
2026-02-20T22:09:14.3843816Z --- /home/runner/work/mathakine/mathakine/server/auth.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3856172Z would reformat /home/runner/work/mathakine/mathakine/server/auth.py
2026-02-20T22:09:14.3858560Z +++ /home/runner/work/mathakine/mathakine/server/auth.py	2026-02-20 22:09:14.381536+00:00
2026-02-20T22:09:14.3860512Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.3862151Z  Module d'authentification pour le backend Starlette.
2026-02-20T22:09:14.3863295Z  
2026-02-20T22:09:14.3864115Z  Fournit les fonctions d'authentification utilisées par les handlers API,
2026-02-20T22:09:14.3865252Z  ainsi que des décorateurs pour éliminer la duplication de code auth dans les handlers.
2026-02-20T22:09:14.3865991Z  """
2026-02-20T22:09:14.3866249Z +
2026-02-20T22:09:14.3866800Z  import json
2026-02-20T22:09:14.3867109Z  from functools import wraps
2026-02-20T22:09:14.3867481Z  
2026-02-20T22:09:14.3867930Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:14.3868503Z  
2026-02-20T22:09:14.3868754Z @@ -17,17 +18,17 @@
2026-02-20T22:09:14.3870820Z  
2026-02-20T22:09:14.3871184Z  
2026-02-20T22:09:14.3872787Z  async def get_current_user(request):  # noqa: C901
2026-02-20T22:09:14.3874773Z      """
2026-02-20T22:09:14.3875516Z      Récupère l'utilisateur actuellement authentifié depuis le cookie access_token.
2026-02-20T22:09:14.3876191Z -    
2026-02-20T22:09:14.3876441Z +
2026-02-20T22:09:14.3876709Z      Args:
2026-02-20T22:09:14.3877017Z          request: Starlette Request object
2026-02-20T22:09:14.3877424Z -        
2026-02-20T22:09:14.3877684Z +
2026-02-20T22:09:14.3877925Z      Returns:
2026-02-20T22:09:14.3878589Z          dict: Dictionnaire avec les informations de l'utilisateur ou None si non authentifié
2026-02-20T22:09:14.3879287Z -        
2026-02-20T22:09:14.3879410Z +
2026-02-20T22:09:14.3879520Z      Example:
2026-02-20T22:09:14.3879622Z          {
2026-02-20T22:09:14.3879733Z              "id": 1,
2026-02-20T22:09:14.3879881Z              "username": "test_user",
2026-02-20T22:09:14.3880028Z              "email": "test@example.com",
2026-02-20T22:09:14.3880139Z @@ -35,20 +36,20 @@
2026-02-20T22:09:14.3880251Z          }
2026-02-20T22:09:14.3880353Z      """
2026-02-20T22:09:14.3880464Z      try:
2026-02-20T22:09:14.3880801Z          # Essayer d'abord le cookie (comportement par défaut)
2026-02-20T22:09:14.3881029Z          access_token = request.cookies.get("access_token")
2026-02-20T22:09:14.3881151Z -        
2026-02-20T22:09:14.3881256Z +
2026-02-20T22:09:14.3881478Z          # Si pas de cookie, essayer le header Authorization
2026-02-20T22:09:14.3881667Z          if not access_token:
2026-02-20T22:09:14.3881904Z              auth_header = request.headers.get("Authorization")
2026-02-20T22:09:14.3882164Z              if auth_header and auth_header.startswith("Bearer "):
2026-02-20T22:09:14.3882404Z                  access_token = auth_header.replace("Bearer ", "")
2026-02-20T22:09:14.3882516Z -        
2026-02-20T22:09:14.3882619Z +
2026-02-20T22:09:14.3882751Z          if not access_token:
2026-02-20T22:09:14.3882871Z              return None
2026-02-20T22:09:14.3883166Z -            
2026-02-20T22:09:14.3883274Z +
2026-02-20T22:09:14.3883684Z          # Utiliser le service d'authentification pour décoder le token
2026-02-20T22:09:14.3883856Z          from fastapi import HTTPException
2026-02-20T22:09:14.3883957Z  
2026-02-20T22:09:14.3884142Z          from app.core.security import decode_token
2026-02-20T22:09:14.3884427Z          from app.services.auth_service import get_user_by_username
2026-02-20T22:09:14.3884538Z @@ -61,44 +62,70 @@
2026-02-20T22:09:14.3884656Z              return None
2026-02-20T22:09:14.3884808Z          except Exception as decode_error:
2026-02-20T22:09:14.3885032Z              # Autre erreur de décodage
2026-02-20T22:09:14.3885454Z              logger.debug(f"Erreur lors du décodage du token: {decode_error}")
2026-02-20T22:09:14.3885572Z              return None
2026-02-20T22:09:14.3885685Z -        
2026-02-20T22:09:14.3885787Z +
2026-02-20T22:09:14.3885937Z          username = payload.get("sub")
2026-02-20T22:09:14.3886042Z -        
2026-02-20T22:09:14.3886150Z +
2026-02-20T22:09:14.3886272Z          if not username:
2026-02-20T22:09:14.3886387Z              return None
2026-02-20T22:09:14.3886497Z -            
2026-02-20T22:09:14.3886596Z +
2026-02-20T22:09:14.3886914Z          # Récupérer l'utilisateur depuis la base de données
2026-02-20T22:09:14.3887058Z          async with db_session() as db:
2026-02-20T22:09:14.3887480Z              user = get_user_by_username(db, username)
2026-02-20T22:09:14.3887587Z -            
2026-02-20T22:09:14.3887688Z +
2026-02-20T22:09:14.3887818Z              if user is None:
2026-02-20T22:09:14.3887940Z                  return None
2026-02-20T22:09:14.3888049Z -                
2026-02-20T22:09:14.3888313Z +
2026-02-20T22:09:14.3888777Z              # Retourner un dictionnaire sérialisable avec tous les champs profil
2026-02-20T22:09:14.3888891Z              return {
2026-02-20T22:09:14.3889014Z                  "id": user.id,
2026-02-20T22:09:14.3889168Z                  "username": user.username,
2026-02-20T22:09:14.3889420Z -                "email": user.email if hasattr(user, 'email') else None,
2026-02-20T22:09:14.3889661Z +                "email": user.email if hasattr(user, "email") else None,
2026-02-20T22:09:14.3889815Z                  "is_authenticated": True,
2026-02-20T22:09:14.3890073Z -                "role": user.role.value if hasattr(user, 'role') else None,
2026-02-20T22:09:14.3890386Z -                "full_name": user.full_name if hasattr(user, 'full_name') else None,
2026-02-20T22:09:14.3890735Z -                "grade_level": user.grade_level if hasattr(user, 'grade_level') else None,
2026-02-20T22:09:14.3891157Z -                "learning_style": user.learning_style if hasattr(user, 'learning_style') else None,
2026-02-20T22:09:14.3891723Z -                "preferred_difficulty": user.preferred_difficulty if hasattr(user, 'preferred_difficulty') else None,
2026-02-20T22:09:14.3892161Z -                "preferred_theme": user.preferred_theme if hasattr(user, 'preferred_theme') else None,
2026-02-20T22:09:14.3892764Z -                "accessibility_settings": user.accessibility_settings if hasattr(user, 'accessibility_settings') else None,
2026-02-20T22:09:14.3893456Z -                "created_at": user.created_at.isoformat() if hasattr(user, 'created_at') and user.created_at else None,
2026-02-20T22:09:14.3893824Z -                "total_points": user.total_points if hasattr(user, 'total_points') else 0,
2026-02-20T22:09:14.3894206Z -                "current_level": user.current_level if hasattr(user, 'current_level') else 1,
2026-02-20T22:09:14.3894552Z -                "jedi_rank": user.jedi_rank if hasattr(user, 'jedi_rank') else 'youngling',
2026-02-20T22:09:14.3894821Z +                "role": user.role.value if hasattr(user, "role") else None,
2026-02-20T22:09:14.3895130Z +                "full_name": user.full_name if hasattr(user, "full_name") else None,
2026-02-20T22:09:14.3895260Z +                "grade_level": (
2026-02-20T22:09:14.3895530Z +                    user.grade_level if hasattr(user, "grade_level") else None
2026-02-20T22:09:14.3895646Z +                ),
2026-02-20T22:09:14.3895779Z +                "learning_style": (
2026-02-20T22:09:14.3896087Z +                    user.learning_style if hasattr(user, "learning_style") else None
2026-02-20T22:09:14.3896205Z +                ),
2026-02-20T22:09:14.3896360Z +                "preferred_difficulty": (
2026-02-20T22:09:14.3896519Z +                    user.preferred_difficulty
2026-02-20T22:09:14.3896717Z +                    if hasattr(user, "preferred_difficulty")
2026-02-20T22:09:14.3896843Z +                    else None
2026-02-20T22:09:14.3896949Z +                ),
2026-02-20T22:09:14.3897097Z +                "preferred_theme": (
2026-02-20T22:09:14.3897425Z +                    user.preferred_theme if hasattr(user, "preferred_theme") else None
2026-02-20T22:09:14.3897531Z +                ),
2026-02-20T22:09:14.3897686Z +                "accessibility_settings": (
2026-02-20T22:09:14.3897852Z +                    user.accessibility_settings
2026-02-20T22:09:14.3898055Z +                    if hasattr(user, "accessibility_settings")
2026-02-20T22:09:14.3898174Z +                    else None
2026-02-20T22:09:14.3898276Z +                ),
2026-02-20T22:09:14.3898408Z +                "created_at": (
2026-02-20T22:09:14.3898563Z +                    user.created_at.isoformat()
2026-02-20T22:09:14.3898961Z +                    if hasattr(user, "created_at") and user.created_at
2026-02-20T22:09:14.3899089Z +                    else None
2026-02-20T22:09:14.3899195Z +                ),
2026-02-20T22:09:14.3899326Z +                "total_points": (
2026-02-20T22:09:14.3899594Z +                    user.total_points if hasattr(user, "total_points") else 0
2026-02-20T22:09:14.3899873Z +                ),
2026-02-20T22:09:14.3900008Z +                "current_level": (
2026-02-20T22:09:14.3900291Z +                    user.current_level if hasattr(user, "current_level") else 1
2026-02-20T22:09:14.3900405Z +                ),
2026-02-20T22:09:14.3900529Z +                "jedi_rank": (
2026-02-20T22:09:14.3900815Z +                    user.jedi_rank if hasattr(user, "jedi_rank") else "youngling"
2026-02-20T22:09:14.3900936Z +                ),
2026-02-20T22:09:14.3901041Z              }
2026-02-20T22:09:14.3901143Z -            
2026-02-20T22:09:14.3901254Z +
2026-02-20T22:09:14.3901420Z      except Exception as user_fetch_error:
2026-02-20T22:09:14.3901972Z -        logger.error(f"Erreur lors de la récupération de l'utilisateur: {user_fetch_error}")
2026-02-20T22:09:14.3902094Z +        logger.error(
2026-02-20T22:09:14.3902540Z +            f"Erreur lors de la récupération de l'utilisateur: {user_fetch_error}"
2026-02-20T22:09:14.3902657Z +        )
2026-02-20T22:09:14.3902771Z          return None
2026-02-20T22:09:14.3902874Z  
2026-02-20T22:09:14.3903134Z  
2026-02-20T22:09:14.3903645Z  # ─── Décorateurs d'authentification ───────────────────────────────────────────
2026-02-20T22:09:14.3904138Z  # Éliminent la duplication du code d'authentification dans les handlers.
2026-02-20T22:09:14.3904265Z @@ -117,99 +144,102 @@
2026-02-20T22:09:14.3904505Z  #       current_user = request.state.user  # Garanti non-None
2026-02-20T22:09:14.3904610Z  
2026-02-20T22:09:14.3904717Z  
2026-02-20T22:09:14.3904854Z  def require_auth(handler):
2026-02-20T22:09:14.3905187Z      """Décorateur qui exige une authentification valide.
2026-02-20T22:09:14.3905290Z -    
2026-02-20T22:09:14.3905400Z +
2026-02-20T22:09:14.3905748Z      Place l'utilisateur authentifié dans request.state.user.
2026-02-20T22:09:14.3905980Z      Retourne 401 JSON si non authentifié.
2026-02-20T22:09:14.3906090Z      """
2026-02-20T22:09:14.3906209Z +
2026-02-20T22:09:14.3906328Z      @wraps(handler)
2026-02-20T22:09:14.3906507Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3906718Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3907000Z          if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3907137Z -            return JSONResponse(
2026-02-20T22:09:14.3907324Z -                {"error": "Authentification requise"},
2026-02-20T22:09:14.3907452Z -                status_code=401
2026-02-20T22:09:14.3907557Z -            )
2026-02-20T22:09:14.3907921Z +            return JSONResponse({"error": "Authentification requise"}, status_code=401)
2026-02-20T22:09:14.3908095Z          request.state.user = current_user
2026-02-20T22:09:14.3908285Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3908387Z +
2026-02-20T22:09:14.3908513Z      return wrapper
2026-02-20T22:09:14.3908614Z  
2026-02-20T22:09:14.3908714Z  
2026-02-20T22:09:14.3908858Z  def optional_auth(handler):
2026-02-20T22:09:14.3909207Z      """Décorateur qui tente l'authentification sans l'exiger.
2026-02-20T22:09:14.3909312Z -    
2026-02-20T22:09:14.3909414Z +
2026-02-20T22:09:14.3909866Z      Place l'utilisateur dans request.state.user (None si non authentifié).
2026-02-20T22:09:14.3910185Z      Ne retourne jamais 401 - le handler décide quoi faire.
2026-02-20T22:09:14.3910289Z      """
2026-02-20T22:09:14.3910397Z +
2026-02-20T22:09:14.3910514Z      @wraps(handler)
2026-02-20T22:09:14.3910692Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3910883Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3911334Z          if current_user and current_user.get("is_authenticated"):
2026-02-20T22:09:14.3911500Z              request.state.user = current_user
2026-02-20T22:09:14.3911608Z          else:
2026-02-20T22:09:14.3911761Z              request.state.user = None
2026-02-20T22:09:14.3911954Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3912216Z +
2026-02-20T22:09:14.3912333Z      return wrapper
2026-02-20T22:09:14.3912441Z  
2026-02-20T22:09:14.3912541Z  
2026-02-20T22:09:14.3912684Z  def require_role(role: str):
2026-02-20T22:09:14.3913308Z      """Décorateur qui exige un rôle spécifique (ex: archiviste pour admin).
2026-02-20T22:09:14.3913419Z -    
2026-02-20T22:09:14.3913522Z +
2026-02-20T22:09:14.3913875Z      À combiner avec @require_auth. Place request.state.user.
2026-02-20T22:09:14.3914142Z      Retourne 403 si le rôle ne correspond pas.
2026-02-20T22:09:14.3914247Z -    
2026-02-20T22:09:14.3914349Z +
2026-02-20T22:09:14.3914462Z      Usage:
2026-02-20T22:09:14.3914598Z          @require_auth
2026-02-20T22:09:14.3914739Z          @require_role("archiviste")
2026-02-20T22:09:14.3914894Z          async def admin_handler(request):
2026-02-20T22:09:14.3914998Z              ...
2026-02-20T22:09:14.3915105Z      """
2026-02-20T22:09:14.3915211Z +
2026-02-20T22:09:14.3915344Z      def decorator(handler):
2026-02-20T22:09:14.3915483Z          @wraps(handler)
2026-02-20T22:09:14.3915672Z          async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3915978Z              # S'assurer qu'on a l'utilisateur (require_auth ou get_current_user)
2026-02-20T22:09:14.3916205Z              current_user = getattr(request.state, "user", None)
2026-02-20T22:09:14.3916338Z              if not current_user:
2026-02-20T22:09:14.3916547Z                  current_user = await get_current_user(request)
2026-02-20T22:09:14.3916843Z              if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3916983Z                  return JSONResponse(
2026-02-20T22:09:14.3917181Z -                    {"error": "Authentification requise"},
2026-02-20T22:09:14.3917317Z -                    status_code=401
2026-02-20T22:09:14.3917558Z +                    {"error": "Authentification requise"}, status_code=401
2026-02-20T22:09:14.3917666Z                  )
2026-02-20T22:09:14.3917836Z              if current_user.get("role") != role:
2026-02-20T22:09:14.3917980Z -                return JSONResponse(
2026-02-20T22:09:14.3918151Z -                    {"error": "Droits insuffisants"},
2026-02-20T22:09:14.3918278Z -                    status_code=403
2026-02-20T22:09:14.3918394Z -                )
2026-02-20T22:09:14.3918725Z +                return JSONResponse({"error": "Droits insuffisants"}, status_code=403)
2026-02-20T22:09:14.3918880Z              request.state.user = current_user
2026-02-20T22:09:14.3919076Z              return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3919172Z +
2026-02-20T22:09:14.3919286Z          return wrapper
2026-02-20T22:09:14.3919392Z +
2026-02-20T22:09:14.3919502Z      return decorator
2026-02-20T22:09:14.3919595Z  
2026-02-20T22:09:14.3919690Z  
2026-02-20T22:09:14.3919844Z  # Alias pratique pour les routes admin
2026-02-20T22:09:14.3920001Z  require_admin = require_role("archiviste")
2026-02-20T22:09:14.3920098Z  
2026-02-20T22:09:14.3920199Z  
2026-02-20T22:09:14.3920351Z  def require_auth_sse(handler):
2026-02-20T22:09:14.3920822Z      """Décorateur qui exige une authentification pour les endpoints SSE/streaming.
2026-02-20T22:09:14.3920923Z -    
2026-02-20T22:09:14.3921033Z +
2026-02-20T22:09:14.3921375Z      Place l'utilisateur authentifié dans request.state.user.
2026-02-20T22:09:14.3921837Z      Retourne un flux SSE d'erreur si non authentifié (au lieu d'un JSON 401).
2026-02-20T22:09:14.3921946Z      """
2026-02-20T22:09:14.3922043Z +
2026-02-20T22:09:14.3922157Z      @wraps(handler)
2026-02-20T22:09:14.3922335Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3922539Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3923158Z          if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3923265Z +
2026-02-20T22:09:14.3923438Z              async def auth_error_generator():
2026-02-20T22:09:14.3923854Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Authentification requise'})}\n\n"
2026-02-20T22:09:14.3924133Z +
2026-02-20T22:09:14.3924286Z              return StreamingResponse(
2026-02-20T22:09:14.3924435Z                  auth_error_generator(),
2026-02-20T22:09:14.3924596Z                  media_type="text/event-stream",
2026-02-20T22:09:14.3924901Z -                headers={"Cache-Control": "no-cache", "Connection": "keep-alive"}
2026-02-20T22:09:14.3925212Z +                headers={"Cache-Control": "no-cache", "Connection": "keep-alive"},
2026-02-20T22:09:14.3925322Z              )
2026-02-20T22:09:14.3925478Z          request.state.user = current_user
2026-02-20T22:09:14.3925685Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3925793Z +
2026-02-20T22:09:14.3925908Z      return wrapper
2026-02-20T22:09:14.3926009Z -
2026-02-20T22:09:14.3942837Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:14.3943797Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py	2026-02-20 22:09:14.374982+00:00
2026-02-20T22:09:14.3943945Z @@ -1,99 +1,123 @@
2026-02-20T22:09:14.3944061Z  """
2026-02-20T22:09:14.3944525Z  Module de validation logique pour les challenges générés par IA.
2026-02-20T22:09:14.3945038Z  Vérifie la cohérence entre visual_data, correct_answer et solution_explanation.
2026-02-20T22:09:14.3945155Z  """
2026-02-20T22:09:14.3945270Z +
2026-02-20T22:09:14.3945386Z  import json
2026-02-20T22:09:14.3945598Z  from typing import Any, Dict, List, Optional, Tuple
2026-02-20T22:09:14.3945707Z  
2026-02-20T22:09:14.3945891Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.3946006Z  
2026-02-20T22:09:14.3946138Z  logger = get_logger(__name__)
2026-02-20T22:09:14.3946245Z  
2026-02-20T22:09:14.3963605Z  
2026-02-20T22:09:14.3963857Z  class ChallengeValidationError(Exception):
2026-02-20T22:09:14.3964308Z      """Exception levée lors de la validation d'un challenge."""
2026-02-20T22:09:14.3964420Z +
2026-02-20T22:09:14.3964550Z      pass
2026-02-20T22:09:14.3964657Z  
2026-02-20T22:09:14.3964772Z  
2026-02-20T22:09:14.3965188Z  def validate_challenge_logic(challenge_data: Dict[str, Any]) -> Tuple[bool, List[str]]:
2026-02-20T22:09:14.3965302Z      """
2026-02-20T22:09:14.3965665Z      Valide la cohérence logique d'un challenge généré par IA.
2026-02-20T22:09:14.3965759Z -    
2026-02-20T22:09:14.3965849Z +
2026-02-20T22:09:14.3965942Z      Args:
2026-02-20T22:09:14.3966309Z          challenge_data: Dictionnaire contenant les données du challenge
2026-02-20T22:09:14.3966402Z -        
2026-02-20T22:09:14.3966492Z +
2026-02-20T22:09:14.3966594Z      Returns:
2026-02-20T22:09:14.3966797Z          Tuple (is_valid, errors) où :
2026-02-20T22:09:14.3967009Z          - is_valid: True si le challenge est valide, False sinon
2026-02-20T22:09:14.3967231Z          - errors: Liste des erreurs détectées
2026-02-20T22:09:14.3967333Z      """
2026-02-20T22:09:14.3967451Z      errors = []
2026-02-20T22:09:14.3967561Z -    
2026-02-20T22:09:14.3967871Z -    challenge_type = challenge_data.get('challenge_type', '').upper()
2026-02-20T22:09:14.3968391Z -    visual_data = challenge_data.get('visual_data', {})
2026-02-20T22:09:14.3968638Z -    correct_answer = challenge_data.get('correct_answer', '')
2026-02-20T22:09:14.3968978Z -    solution_explanation = challenge_data.get('solution_explanation', '')
2026-02-20T22:09:14.3969095Z -    
2026-02-20T22:09:14.3969199Z +
2026-02-20T22:09:14.3969488Z +    challenge_type = challenge_data.get("challenge_type", "").upper()
2026-02-20T22:09:14.3969721Z +    visual_data = challenge_data.get("visual_data", {})
2026-02-20T22:09:14.3969961Z +    correct_answer = challenge_data.get("correct_answer", "")
2026-02-20T22:09:14.3970542Z +    solution_explanation = challenge_data.get("solution_explanation", "")
2026-02-20T22:09:14.3970666Z +
2026-02-20T22:09:14.3970946Z      # Parser visual_data si nécessaire
2026-02-20T22:09:14.3971113Z      if isinstance(visual_data, str):
2026-02-20T22:09:14.3971245Z          try:
2026-02-20T22:09:14.3971625Z              visual_data = json.loads(visual_data)
2026-02-20T22:09:14.3971773Z          except json.JSONDecodeError:
2026-02-20T22:09:14.3972008Z              errors.append("visual_data n'est pas un JSON valide")
2026-02-20T22:09:14.3972148Z              return False, errors
2026-02-20T22:09:14.3972253Z -    
2026-02-20T22:09:14.3972357Z +
2026-02-20T22:09:14.3972678Z      # Validation spécifique selon le type de challenge
2026-02-20T22:09:14.3972819Z -    if challenge_type == 'PATTERN':
2026-02-20T22:09:14.3973472Z -        pattern_errors = validate_pattern_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3973644Z +    if challenge_type == "PATTERN":
2026-02-20T22:09:14.3973848Z +        pattern_errors = validate_pattern_challenge(
2026-02-20T22:09:14.3974077Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3974187Z +        )
2026-02-20T22:09:14.3974350Z          errors.extend(pattern_errors)
2026-02-20T22:09:14.3974468Z -    
2026-02-20T22:09:14.3974622Z -    elif challenge_type == 'SEQUENCE':
2026-02-20T22:09:14.3975144Z -        sequence_errors = validate_sequence_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3975253Z +
2026-02-20T22:09:14.3975407Z +    elif challenge_type == "SEQUENCE":
2026-02-20T22:09:14.3975621Z +        sequence_errors = validate_sequence_challenge(
2026-02-20T22:09:14.3975845Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3975956Z +        )
2026-02-20T22:09:14.3976104Z          errors.extend(sequence_errors)
2026-02-20T22:09:14.3976214Z -    
2026-02-20T22:09:14.3976375Z -    elif challenge_type == 'PUZZLE':
2026-02-20T22:09:14.3976852Z -        puzzle_errors = validate_puzzle_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3976973Z +
2026-02-20T22:09:14.3977126Z +    elif challenge_type == "PUZZLE":
2026-02-20T22:09:14.3977315Z +        puzzle_errors = validate_puzzle_challenge(
2026-02-20T22:09:14.3977537Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3977653Z +        )
2026-02-20T22:09:14.3977798Z          errors.extend(puzzle_errors)
2026-02-20T22:09:14.3977902Z -    
2026-02-20T22:09:14.3978054Z -    elif challenge_type == 'GRAPH':
2026-02-20T22:09:14.3978511Z -        graph_errors = validate_graph_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3978620Z +
2026-02-20T22:09:14.3978775Z +    elif challenge_type == "GRAPH":
2026-02-20T22:09:14.3978952Z +        graph_errors = validate_graph_challenge(
2026-02-20T22:09:14.3979169Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3979288Z +        )
2026-02-20T22:09:14.3979442Z          errors.extend(graph_errors)
2026-02-20T22:09:14.3979544Z -    
2026-02-20T22:09:14.3979683Z -    elif challenge_type == 'VISUAL':
2026-02-20T22:09:14.3979797Z +
2026-02-20T22:09:14.3979937Z +    elif challenge_type == "VISUAL":
2026-02-20T22:09:14.3980355Z          # VISUAL inclut les défis spatiaux (rotation, symétrie, etc.)
2026-02-20T22:09:14.3980851Z -        visual_errors = validate_spatial_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3981054Z +        visual_errors = validate_spatial_challenge(
2026-02-20T22:09:14.3981261Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3981367Z +        )
2026-02-20T22:09:14.3981520Z          errors.extend(visual_errors)
2026-02-20T22:09:14.3981627Z -    
2026-02-20T22:09:14.3981768Z -    elif challenge_type == 'CODING':
2026-02-20T22:09:14.3981877Z +
2026-02-20T22:09:14.3982023Z +    elif challenge_type == "CODING":
2026-02-20T22:09:14.3982564Z          # Valider les défis de type labyrinthe/maze
2026-02-20T22:09:14.3983227Z -        coding_errors = validate_coding_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3983434Z +        coding_errors = validate_coding_challenge(
2026-02-20T22:09:14.3983656Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3983973Z +        )
2026-02-20T22:09:14.3984140Z          errors.extend(coding_errors)
2026-02-20T22:09:14.3984247Z -    
2026-02-20T22:09:14.3984395Z -    elif challenge_type == 'RIDDLE':
2026-02-20T22:09:14.3984860Z -        riddle_errors = validate_riddle_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3984977Z +
2026-02-20T22:09:14.3985122Z +    elif challenge_type == "RIDDLE":
2026-02-20T22:09:14.3985304Z +        riddle_errors = validate_riddle_challenge(
2026-02-20T22:09:14.3985531Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3985652Z +        )
2026-02-20T22:09:14.3985796Z          errors.extend(riddle_errors)
2026-02-20T22:09:14.3985907Z -    
2026-02-20T22:09:14.3986069Z -    elif challenge_type == 'PROBABILITY':
2026-02-20T22:09:14.3986567Z -        prob_errors = validate_probability_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3986681Z +
2026-02-20T22:09:14.3986848Z +    elif challenge_type == "PROBABILITY":
2026-02-20T22:09:14.3987044Z +        prob_errors = validate_probability_challenge(
2026-02-20T22:09:14.3987270Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3987383Z +        )
2026-02-20T22:09:14.3987526Z          errors.extend(prob_errors)
2026-02-20T22:09:14.3987621Z  
2026-02-20T22:09:14.3987755Z -    elif challenge_type == 'CHESS':
2026-02-20T22:09:14.3988214Z -        chess_errors = validate_chess_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3988359Z +    elif challenge_type == "CHESS":
2026-02-20T22:09:14.3988539Z +        chess_errors = validate_chess_challenge(
2026-02-20T22:09:14.3988766Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3988872Z +        )
2026-02-20T22:09:14.3989009Z          errors.extend(chess_errors)
2026-02-20T22:09:14.3989122Z  
2026-02-20T22:09:14.3989344Z      # Validation générale
2026-02-20T22:09:14.3989519Z      # Convertir en string si c'est une liste
2026-02-20T22:09:14.3990728Z -    correct_answer_str = ','.join(correct_answer) if isinstance(correct_answer, list) else str(correct_answer) if correct_answer else ''
2026-02-20T22:09:14.3991128Z -    explanation_str = str(solution_explanation) if solution_explanation else ''
2026-02-20T22:09:14.3991240Z -    
2026-02-20T22:09:14.3991382Z +    correct_answer_str = (
2026-02-20T22:09:14.3991527Z +        ",".join(correct_answer)
2026-02-20T22:09:14.3991691Z +        if isinstance(correct_answer, list)
2026-02-20T22:09:14.3991912Z +        else str(correct_answer) if correct_answer else ""
2026-02-20T22:09:14.3992042Z +    )
2026-02-20T22:09:14.3992394Z +    explanation_str = str(solution_explanation) if solution_explanation else ""
2026-02-20T22:09:14.3992499Z +
2026-02-20T22:09:14.3992757Z      if not correct_answer_str or not correct_answer_str.strip():
2026-02-20T22:09:14.3992947Z          errors.append("correct_answer est vide")
2026-02-20T22:09:14.3993246Z -    
2026-02-20T22:09:14.3993357Z +
2026-02-20T22:09:14.3993606Z      if not explanation_str or not explanation_str.strip():
2026-02-20T22:09:14.3993818Z          errors.append("solution_explanation est vide")
2026-02-20T22:09:14.3993927Z -    
2026-02-20T22:09:14.3994028Z +
2026-02-20T22:09:14.3994181Z      return len(errors) == 0, errors
2026-02-20T22:09:14.3994285Z  
2026-02-20T22:09:14.3994390Z  
2026-02-20T22:09:14.3994749Z  def compute_pattern_answers_multi(grid: List[List[Any]]) -> Optional[str]:
2026-02-20T22:09:14.3994857Z      """
2026-02-20T22:09:14.3994982Z @@ -104,11 +128,11 @@
2026-02-20T22:09:14.3995109Z      positions = []
2026-02-20T22:09:14.3995532Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.3995710Z          if not isinstance(row, (list, tuple)):
2026-02-20T22:09:14.3995830Z              continue
2026-02-20T22:09:14.3995990Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.3996251Z -            if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.3996668Z +            if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.3996838Z                  positions.append((i, j))
2026-02-20T22:09:14.3996967Z      if not positions:
2026-02-20T22:09:14.3997089Z          return None
2026-02-20T22:09:14.3997207Z      symbols = []
2026-02-20T22:09:14.3997364Z      for i, j in sorted(positions):
2026-02-20T22:09:14.3997479Z @@ -117,31 +141,37 @@
2026-02-20T22:09:14.3997600Z              return None
2026-02-20T22:09:14.3997763Z          symbols.append(str(s).strip())
2026-02-20T22:09:14.3997900Z      return ", ".join(symbols)
2026-02-20T22:09:14.3998009Z  
2026-02-20T22:09:14.3998112Z  
2026-02-20T22:09:14.3998688Z -def validate_pattern_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.3998842Z +def validate_pattern_challenge(
2026-02-20T22:09:14.3999140Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.3999278Z +) -> List[str]:
2026-02-20T22:09:14.3999386Z      """
2026-02-20T22:09:14.3999545Z      Valide un challenge de type PATTERN.
2026-02-20T22:09:14.3999975Z      Vérifie que la réponse correspond au pattern dans la grille.
2026-02-20T22:09:14.4000086Z      """
2026-02-20T22:09:14.4000202Z      errors = []
2026-02-20T22:09:14.4000318Z -    
2026-02-20T22:09:14.4000526Z -    if not visual_data or 'grid' not in visual_data:
2026-02-20T22:09:14.4000630Z +
2026-02-20T22:09:14.4000833Z +    if not visual_data or "grid" not in visual_data:
2026-02-20T22:09:14.4001164Z          errors.append("visual_data.grid manquant pour un challenge PATTERN")
2026-02-20T22:09:14.4001299Z          return errors
2026-02-20T22:09:14.4001413Z -    
2026-02-20T22:09:14.4001557Z -    grid = visual_data.get('grid', [])
2026-02-20T22:09:14.4001663Z +
2026-02-20T22:09:14.4001806Z +    grid = visual_data.get("grid", [])
2026-02-20T22:09:14.4001995Z      if not grid or not isinstance(grid, list):
2026-02-20T22:09:14.4002355Z          errors.append("visual_data.grid doit être un tableau")
2026-02-20T22:09:14.4002486Z          return errors
2026-02-20T22:09:14.4002599Z -    
2026-02-20T22:09:14.4002703Z +
2026-02-20T22:09:14.4002934Z      # Plusieurs "?" → format "O, O, X, O"
2026-02-20T22:09:14.4003363Z      expected_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:14.4003504Z      if expected_multi:
2026-02-20T22:09:14.4003990Z -        correct_parts = [p.strip().upper() for p in str(correct_answer).split(',') if p.strip()]
2026-02-20T22:09:14.4004377Z -        expected_parts = [p.strip().upper() for p in expected_multi.split(',') if p.strip()]
2026-02-20T22:09:14.4004534Z +        correct_parts = [
2026-02-20T22:09:14.4004843Z +            p.strip().upper() for p in str(correct_answer).split(",") if p.strip()
2026-02-20T22:09:14.4004950Z +        ]
2026-02-20T22:09:14.4005089Z +        expected_parts = [
2026-02-20T22:09:14.4005374Z +            p.strip().upper() for p in expected_multi.split(",") if p.strip()
2026-02-20T22:09:14.4005491Z +        ]
2026-02-20T22:09:14.4005857Z          if len(correct_parts) != len(expected_parts) or correct_parts != expected_parts:
2026-02-20T22:09:14.4005997Z              errors.append(
2026-02-20T22:09:14.4006470Z                  f"Pattern multi-cellules incohérent: attendu '{expected_multi}', "
2026-02-20T22:09:14.4006643Z                  f"correct_answer='{correct_answer}'"
2026-02-20T22:09:14.4006755Z              )
2026-02-20T22:09:14.4006865Z @@ -151,11 +181,11 @@
2026-02-20T22:09:14.4006987Z      question_pos = None
2026-02-20T22:09:14.4007129Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.4007269Z          if not isinstance(row, list):
2026-02-20T22:09:14.4007593Z              continue
2026-02-20T22:09:14.4007743Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4007986Z -            if cell == '?' or (isinstance(cell, str) and '?' in cell):
2026-02-20T22:09:14.4008215Z +            if cell == "?" or (isinstance(cell, str) and "?" in cell):
2026-02-20T22:09:14.4008546Z                  question_pos = (i, j)
2026-02-20T22:09:14.4008674Z                  break
2026-02-20T22:09:14.4008802Z          if question_pos:
2026-02-20T22:09:14.4008914Z              break
2026-02-20T22:09:14.4009049Z      if not question_pos:
2026-02-20T22:09:14.4009162Z @@ -168,11 +198,11 @@
2026-02-20T22:09:14.4009364Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4009492Z              errors.append(
2026-02-20T22:09:14.4009959Z                  f"Pattern incohérent: le pattern suggère '{expected_answer}', "
2026-02-20T22:09:14.4010173Z                  f"mais correct_answer est '{correct_answer}'"
2026-02-20T22:09:14.4010295Z              )
2026-02-20T22:09:14.4010408Z -    
2026-02-20T22:09:14.4010511Z +
2026-02-20T22:09:14.4010629Z      return errors
2026-02-20T22:09:14.4010731Z  
2026-02-20T22:09:14.4010837Z  
2026-02-20T22:09:14.4011248Z  def analyze_pattern(grid: List[List[Any]], row_idx: int, col_idx: int) -> Optional[str]:
2026-02-20T22:09:14.4011358Z      """
2026-02-20T22:09:14.4011491Z @@ -180,16 +210,16 @@
2026-02-20T22:09:14.4011663Z      Supporte plusieurs types de patterns :
2026-02-20T22:09:14.4011951Z      - Symétrie (horizontale, verticale, centrale)
2026-02-20T22:09:14.4012430Z      - Latin square (chaque ligne/colonne contient chaque élément une seule fois)
2026-02-20T22:09:14.4012714Z      - Patterns alternés simples (X-O-X, etc.)
2026-02-20T22:09:14.4012925Z      - Patterns de répétition
2026-02-20T22:09:14.4013943Z -    
2026-02-20T22:09:14.4014082Z +
2026-02-20T22:09:14.4043289Z      Args:
2026-02-20T22:09:14.4043461Z          grid: Grille 2D
2026-02-20T22:09:14.4043651Z          row_idx: Index de la ligne contenant '?'
2026-02-20T22:09:14.4043868Z          col_idx: Index de la colonne contenant '?'
2026-02-20T22:09:14.4043984Z -        
2026-02-20T22:09:14.4044093Z +
2026-02-20T22:09:14.4044210Z      Returns:
2026-02-20T22:09:14.4044705Z          Réponse attendue ou None si le pattern ne peut pas être déterminé
2026-02-20T22:09:14.4044816Z      """
2026-02-20T22:09:14.4045096Z      if not grid or row_idx >= len(grid) or col_idx >= len(grid[0]):
2026-02-20T22:09:14.4045221Z          return None
2026-02-20T22:09:14.4045339Z @@ -205,243 +235,270 @@
2026-02-20T22:09:14.4045512Z      def _rows_match(r1: int, r2: int) -> bool:
2026-02-20T22:09:14.4045674Z          if r1 >= len(grid) or r2 >= len(grid):
2026-02-20T22:09:14.4045800Z              return False
2026-02-20T22:09:14.4045944Z          for j in range(len(grid[0])):
2026-02-20T22:09:14.4046181Z              a, b = str(grid[r1][j]).strip(), str(grid[r2][j]).strip()
2026-02-20T22:09:14.4046393Z -            if a not in ('?', '') and b not in ('?', '') and a != b:
2026-02-20T22:09:14.4046614Z +            if a not in ("?", "") and b not in ("?", "") and a != b:
2026-02-20T22:09:14.4046754Z                  return False
2026-02-20T22:09:14.4046872Z          return True
2026-02-20T22:09:14.4046974Z +
2026-02-20T22:09:14.4047091Z      if rows >= 3:
2026-02-20T22:09:14.4047280Z          if row_idx in (0, 2) and _rows_match(0, 2):
2026-02-20T22:09:14.4047438Z              ref_row = 0 if row_idx == 2 else 2
2026-02-20T22:09:14.4047589Z              ref_val = grid[ref_row][col_idx]
2026-02-20T22:09:14.4047822Z -            if ref_val and str(ref_val).strip() not in ('?', ''):
2026-02-20T22:09:14.4048043Z +            if ref_val and str(ref_val).strip() not in ("?", ""):
2026-02-20T22:09:14.4048200Z                  return str(ref_val).strip()
2026-02-20T22:09:14.4048427Z          if row_idx in (1, 3) and rows >= 4 and _rows_match(1, 3):
2026-02-20T22:09:14.4048587Z              ref_row = 1 if row_idx == 3 else 3
2026-02-20T22:09:14.4048736Z              ref_val = grid[ref_row][col_idx]
2026-02-20T22:09:14.4049191Z -            if ref_val and str(ref_val).strip() not in ('?', ''):
2026-02-20T22:09:14.4049419Z +            if ref_val and str(ref_val).strip() not in ("?", ""):
2026-02-20T22:09:14.4049572Z                  return str(ref_val).strip()
2026-02-20T22:09:14.4049676Z  
2026-02-20T22:09:14.4050175Z      # 3. Symétrie : grille symétrique horizontale/verticale → ? = cellule miroir
2026-02-20T22:09:14.4050532Z      mirror_row = rows - 1 - row_idx
2026-02-20T22:09:14.4050664Z      mirror_col = cols - 1 - col_idx
2026-02-20T22:09:14.4050960Z      if mirror_row != row_idx and 0 <= mirror_row < rows and col_idx < cols:
2026-02-20T22:09:14.4051152Z          mirror_cell = grid[mirror_row][col_idx]
2026-02-20T22:09:14.4051534Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4051650Z +        if (
2026-02-20T22:09:14.4051777Z +            mirror_cell
2026-02-20T22:09:14.4051932Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4052092Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4052209Z +        ):
2026-02-20T22:09:14.4052360Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4052566Z      if mirror_col != col_idx and 0 <= mirror_col < cols:
2026-02-20T22:09:14.4052731Z          mirror_cell = grid[row_idx][mirror_col]
2026-02-20T22:09:14.4053320Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4053434Z +        if (
2026-02-20T22:09:14.4053555Z +            mirror_cell
2026-02-20T22:09:14.4053723Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4053872Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4053982Z +        ):
2026-02-20T22:09:14.4054137Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4054340Z      if 0 <= mirror_row < rows and 0 <= mirror_col < cols:
2026-02-20T22:09:14.4054518Z          mirror_cell = grid[mirror_row][mirror_col]
2026-02-20T22:09:14.4054900Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4055021Z +        if (
2026-02-20T22:09:14.4055139Z +            mirror_cell
2026-02-20T22:09:14.4055301Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4055454Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4055569Z +        ):
2026-02-20T22:09:14.4055716Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4055823Z -    
2026-02-20T22:09:14.4055945Z +
2026-02-20T22:09:14.4056235Z      # 3. Analyser le pattern horizontal (ligne) pour patterns simples
2026-02-20T22:09:14.4056364Z      row = grid[row_idx]
2026-02-20T22:09:14.4056495Z      if len(row) >= 2:
2026-02-20T22:09:14.4056739Z          # Pattern X-O-X suggère X
2026-02-20T22:09:14.4056941Z -        if col_idx == 2 and row[0] == 'X' and row[1] == 'O':
2026-02-20T22:09:14.4057072Z -            return 'X'
2026-02-20T22:09:14.4057268Z +        if col_idx == 2 and row[0] == "X" and row[1] == "O":
2026-02-20T22:09:14.4057403Z +            return "X"
2026-02-20T22:09:14.4057624Z          # Pattern O-X-O suggère O
2026-02-20T22:09:14.4057827Z -        if col_idx == 2 and row[0] == 'O' and row[1] == 'X':
2026-02-20T22:09:14.4057943Z -            return 'O'
2026-02-20T22:09:14.4058132Z +        if col_idx == 2 and row[0] == "O" and row[1] == "X":
2026-02-20T22:09:14.4058266Z +            return "O"
2026-02-20T22:09:14.4058480Z          # Pattern alterné simple
2026-02-20T22:09:14.4058608Z          if col_idx == 2:
2026-02-20T22:09:14.4058895Z              if row[0] == row[1]:  # Même valeur répétée
2026-02-20T22:09:14.4059032Z                  return row[0]
2026-02-20T22:09:14.4059214Z              else:  # Pattern alterné
2026-02-20T22:09:14.4059514Z                  # Si X-O, alors ? = X (pour compléter X-O-X)
2026-02-20T22:09:14.4059686Z -                if row[0] == 'X' and row[1] == 'O':
2026-02-20T22:09:14.4059809Z -                    return 'X'
2026-02-20T22:09:14.4060199Z -                elif row[0] == 'O' and row[1] == 'X':
2026-02-20T22:09:14.4060337Z -                    return 'O'
2026-02-20T22:09:14.4060443Z -    
2026-02-20T22:09:14.4060593Z +                if row[0] == "X" and row[1] == "O":
2026-02-20T22:09:14.4060715Z +                    return "X"
2026-02-20T22:09:14.4060882Z +                elif row[0] == "O" and row[1] == "X":
2026-02-20T22:09:14.4061189Z +                    return "O"
2026-02-20T22:09:14.4061296Z +
2026-02-20T22:09:14.4061492Z      # 3. Analyser le pattern vertical (colonne)
2026-02-20T22:09:14.4061618Z      if len(grid) >= 2:
2026-02-20T22:09:14.4062032Z -        col = [grid[i][col_idx] for i in range(len(grid)) if i < len(grid) and col_idx < len(grid[i])]
2026-02-20T22:09:14.4062150Z +        col = [
2026-02-20T22:09:14.4062287Z +            grid[i][col_idx]
2026-02-20T22:09:14.4062428Z +            for i in range(len(grid))
2026-02-20T22:09:14.4062607Z +            if i < len(grid) and col_idx < len(grid[i])
2026-02-20T22:09:14.4062727Z +        ]
2026-02-20T22:09:14.4062853Z          if len(col) >= 2:
2026-02-20T22:09:14.4063327Z              # Pattern X-O-X suggère X
2026-02-20T22:09:14.4063553Z -            if row_idx == 2 and col[0] == 'X' and col[1] == 'O':
2026-02-20T22:09:14.4063680Z -                return 'X'
2026-02-20T22:09:14.4063884Z +            if row_idx == 2 and col[0] == "X" and col[1] == "O":
2026-02-20T22:09:14.4064021Z +                return "X"
2026-02-20T22:09:14.4064259Z              # Pattern O-X-O suggère O
2026-02-20T22:09:14.4064464Z -            if row_idx == 2 and col[0] == 'O' and col[1] == 'X':
2026-02-20T22:09:14.4064580Z -                return 'O'
2026-02-20T22:09:14.4064784Z +            if row_idx == 2 and col[0] == "O" and col[1] == "X":
2026-02-20T22:09:14.4064902Z +                return "O"
2026-02-20T22:09:14.4065136Z              # Pattern alterné simple
2026-02-20T22:09:14.4065268Z              if row_idx == 2:
2026-02-20T22:09:14.4065571Z                  if col[0] == col[1]:  # Même valeur répétée
2026-02-20T22:09:14.4065708Z                      return col[0]
2026-02-20T22:09:14.4065886Z                  else:  # Pattern alterné
2026-02-20T22:09:14.4066051Z -                    if col[0] == 'X' and col[1] == 'O':
2026-02-20T22:09:14.4066172Z -                        return 'X'
2026-02-20T22:09:14.4066341Z -                    elif col[0] == 'O' and col[1] == 'X':
2026-02-20T22:09:14.4066482Z -                        return 'O'
2026-02-20T22:09:14.4066585Z -    
2026-02-20T22:09:14.4066748Z +                    if col[0] == "X" and col[1] == "O":
2026-02-20T22:09:14.4066872Z +                        return "X"
2026-02-20T22:09:14.4067045Z +                    elif col[0] == "O" and col[1] == "X":
2026-02-20T22:09:14.4067167Z +                        return "O"
2026-02-20T22:09:14.4067273Z +
2026-02-20T22:09:14.4067462Z      # 4. Analyser les diagonales si applicable
2026-02-20T22:09:14.4067654Z      if row_idx == col_idx:  # Diagonale principale
2026-02-20T22:09:14.4068109Z -        diag = [grid[i][i] for i in range(min(len(grid), len(grid[0]))) if i < len(grid) and i < len(grid[0])]
2026-02-20T22:09:14.4068243Z +        diag = [
2026-02-20T22:09:14.4068362Z +            grid[i][i]
2026-02-20T22:09:14.4068553Z +            for i in range(min(len(grid), len(grid[0])))
2026-02-20T22:09:14.4068713Z +            if i < len(grid) and i < len(grid[0])
2026-02-20T22:09:14.4068829Z +        ]
2026-02-20T22:09:14.4068954Z          if len(diag) >= 2:
2026-02-20T22:09:14.4069080Z              if diag[0] == diag[1]:
2026-02-20T22:09:14.4069209Z                  return diag[0]
2026-02-20T22:09:14.4069372Z -            elif diag[0] == 'X' and diag[1] == 'O':
2026-02-20T22:09:14.4069489Z -                return 'X'
2026-02-20T22:09:14.4069650Z -            elif diag[0] == 'O' and diag[1] == 'X':
2026-02-20T22:09:14.4069782Z -                return 'O'
2026-02-20T22:09:14.4069887Z -    
2026-02-20T22:09:14.4070047Z +            elif diag[0] == "X" and diag[1] == "O":
2026-02-20T22:09:14.4070171Z +                return "X"
2026-02-20T22:09:14.4070545Z +            elif diag[0] == "O" and diag[1] == "X":
2026-02-20T22:09:14.4070668Z +                return "O"
2026-02-20T22:09:14.4070773Z +
2026-02-20T22:09:14.4070904Z      # Diagonale secondaire
2026-02-20T22:09:14.4071062Z      if row_idx + col_idx == len(grid) - 1:
2026-02-20T22:09:14.4071412Z -        diag2 = [grid[i][len(grid[0]) - 1 - i] for i in range(min(len(grid), len(grid[0])))]
2026-02-20T22:09:14.4071717Z +        diag2 = [
2026-02-20T22:09:14.4072072Z +            grid[i][len(grid[0]) - 1 - i] for i in range(min(len(grid), len(grid[0])))
2026-02-20T22:09:14.4072182Z +        ]
2026-02-20T22:09:14.4072320Z          if len(diag2) >= 2:
2026-02-20T22:09:14.4072455Z              if diag2[0] == diag2[1]:
2026-02-20T22:09:14.4072583Z                  return diag2[0]
2026-02-20T22:09:14.4072754Z -            elif diag2[0] == 'X' and diag2[1] == 'O':
2026-02-20T22:09:14.4072884Z -                return 'X'
2026-02-20T22:09:14.4103284Z -            elif diag2[0] == 'O' and diag2[1] == 'X':
2026-02-20T22:09:14.4103461Z -                return 'O'
2026-02-20T22:09:14.4103580Z -    
2026-02-20T22:09:14.4103769Z +            elif diag2[0] == "X" and diag2[1] == "O":
2026-02-20T22:09:14.4103896Z +                return "X"
2026-02-20T22:09:14.4104076Z +            elif diag2[0] == "O" and diag2[1] == "X":
2026-02-20T22:09:14.4104216Z +                return "O"
2026-02-20T22:09:14.4104319Z +
2026-02-20T22:09:14.4104432Z      return None
2026-02-20T22:09:14.4104541Z  
2026-02-20T22:09:14.4104641Z  
2026-02-20T22:09:14.4105152Z -def analyze_latin_square_pattern(grid: List[List[Any]], row_idx: int, col_idx: int) -> Optional[str]:
2026-02-20T22:09:14.4105313Z +def analyze_latin_square_pattern(
2026-02-20T22:09:14.4105516Z +    grid: List[List[Any]], row_idx: int, col_idx: int
2026-02-20T22:09:14.4105647Z +) -> Optional[str]:
2026-02-20T22:09:14.4105754Z      """
2026-02-20T22:09:14.4106248Z      Analyse un pattern de type "Latin Square" où chaque ligne et/ou colonne
2026-02-20T22:09:14.4106610Z      doit contenir chaque élément unique exactement une fois.
2026-02-20T22:09:14.4106717Z -    
2026-02-20T22:09:14.4106829Z +
2026-02-20T22:09:14.4107054Z      Exemples de grilles supportées:
2026-02-20T22:09:14.4107599Z      - [triangle, cercle, carré] / [cercle, carré, triangle] / [carré, ?, triangle] → cercle
2026-02-20T22:09:14.4107845Z      - [1, 2, 3] / [2, 3, 1] / [3, ?, 2] → 1
2026-02-20T22:09:14.4107963Z -    
2026-02-20T22:09:14.4108065Z +
2026-02-20T22:09:14.4108173Z      Args:
2026-02-20T22:09:14.4108305Z          grid: Grille 2D
2026-02-20T22:09:14.4108483Z          row_idx: Index de la ligne contenant '?'
2026-02-20T22:09:14.4108661Z          col_idx: Index de la colonne contenant '?'
2026-02-20T22:09:14.4108766Z -        
2026-02-20T22:09:14.4108874Z +
2026-02-20T22:09:14.4108983Z      Returns:
2026-02-20T22:09:14.4109407Z          Élément manquant ou None si le pattern n'est pas un latin square
2026-02-20T22:09:14.4109525Z      """
2026-02-20T22:09:14.4109706Z      if not grid or not isinstance(grid, list):
2026-02-20T22:09:14.4109840Z          return None
2026-02-20T22:09:14.4109957Z -    
2026-02-20T22:09:14.4110062Z +
2026-02-20T22:09:14.4110453Z      # Collecter tous les éléments uniques de la grille (sauf '?')
2026-02-20T22:09:14.4110591Z      all_elements = set()
2026-02-20T22:09:14.4110716Z      for row in grid:
2026-02-20T22:09:14.4110872Z          if isinstance(row, list):
2026-02-20T22:09:14.4110997Z              for cell in row:
2026-02-20T22:09:14.4111183Z                  cell_str = str(cell).strip().lower()
2026-02-20T22:09:14.4111376Z -                if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4111559Z +                if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4111720Z                      all_elements.add(cell_str)
2026-02-20T22:09:14.4111834Z -    
2026-02-20T22:09:14.4111935Z +
2026-02-20T22:09:14.4112070Z      if len(all_elements) < 2:
2026-02-20T22:09:14.4112192Z          return None
2026-02-20T22:09:14.4112527Z -    
2026-02-20T22:09:14.4112795Z -    # Vérifier si c'est un latin square : 
2026-02-20T22:09:14.4112904Z +
2026-02-20T22:09:14.4113369Z +    # Vérifier si c'est un latin square :
2026-02-20T22:09:14.4113824Z      # Le nombre d'éléments uniques devrait être égal à la taille de la grille
2026-02-20T22:09:14.4113962Z      grid_size = len(grid)
2026-02-20T22:09:14.4114326Z      if len(all_elements) != grid_size:
2026-02-20T22:09:14.4114853Z          # Ce n'est peut-être pas un latin square parfait, mais on peut quand même essayer
2026-02-20T22:09:14.4114973Z          pass
2026-02-20T22:09:14.4115084Z -    
2026-02-20T22:09:14.4115187Z +
2026-02-20T22:09:14.4115590Z      # Analyser la ligne contenant '?' pour trouver l'élément manquant
2026-02-20T22:09:14.4115734Z      target_row = grid[row_idx]
2026-02-20T22:09:14.4115900Z      if not isinstance(target_row, list):
2026-02-20T22:09:14.4116028Z          return None
2026-02-20T22:09:14.4116133Z -    
2026-02-20T22:09:14.4116242Z +
2026-02-20T22:09:14.4116390Z      elements_in_row = set()
2026-02-20T22:09:14.4116520Z      for cell in target_row:
2026-02-20T22:09:14.4116673Z          cell_str = str(cell).strip().lower()
2026-02-20T22:09:14.4116862Z -        if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4117036Z +        if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4117202Z              elements_in_row.add(cell_str)
2026-02-20T22:09:14.4117310Z -    
2026-02-20T22:09:14.4117412Z +
2026-02-20T22:09:14.4117959Z      # L'élément manquant est celui qui est dans all_elements mais pas dans elements_in_row
2026-02-20T22:09:14.4118171Z      missing_in_row = all_elements - elements_in_row
2026-02-20T22:09:14.4118287Z -    
2026-02-20T22:09:14.4118388Z +
2026-02-20T22:09:14.4118523Z      if len(missing_in_row) == 1:
2026-02-20T22:09:14.4118682Z          missing = list(missing_in_row)[0]
2026-02-20T22:09:14.4118826Z          # Retrouver la casse originale
2026-02-20T22:09:14.4118952Z          for row in grid:
2026-02-20T22:09:14.4119106Z              if isinstance(row, list):
2026-02-20T22:09:14.4119235Z                  for cell in row:
2026-02-20T22:09:14.4119430Z                      if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4119572Z                          return str(cell)
2026-02-20T22:09:14.4119702Z          return missing
2026-02-20T22:09:14.4119803Z -    
2026-02-20T22:09:14.4119916Z +
2026-02-20T22:09:14.4120377Z      # Si plusieurs éléments manquent dans la ligne, essayer avec la colonne
2026-02-20T22:09:14.4120725Z      if col_idx < len(grid[0]) if len(grid) > 0 and isinstance(grid[0], list) else False:
2026-02-20T22:09:14.4120868Z          elements_in_col = set()
2026-02-20T22:09:14.4120992Z          for row in grid:
2026-02-20T22:09:14.4121214Z              if isinstance(row, list) and col_idx < len(row):
2026-02-20T22:09:14.4121409Z                  cell_str = str(row[col_idx]).strip().lower()
2026-02-20T22:09:14.4121598Z -                if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4121988Z +                if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4122158Z                      elements_in_col.add(cell_str)
2026-02-20T22:09:14.4122270Z -        
2026-02-20T22:09:14.4122388Z +
2026-02-20T22:09:14.4122602Z          missing_in_col = all_elements - elements_in_col
2026-02-20T22:09:14.4122703Z -        
2026-02-20T22:09:14.4122819Z +
2026-02-20T22:09:14.4123145Z          if len(missing_in_col) == 1:
2026-02-20T22:09:14.4123308Z              missing = list(missing_in_col)[0]
2026-02-20T22:09:14.4123462Z              # Retrouver la casse originale
2026-02-20T22:09:14.4123600Z              for row in grid:
2026-02-20T22:09:14.4123747Z                  if isinstance(row, list):
2026-02-20T22:09:14.4123883Z                      for cell in row:
2026-02-20T22:09:14.4124082Z                          if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4124232Z                              return str(cell)
2026-02-20T22:09:14.4124354Z              return missing
2026-02-20T22:09:14.4124468Z -    
2026-02-20T22:09:14.4124583Z +
2026-02-20T22:09:14.4125103Z      # Si on a trouvé des candidats dans la ligne ET la colonne, prendre l'intersection
2026-02-20T22:09:14.4125250Z      if len(missing_in_row) > 0:
2026-02-20T22:09:14.4125399Z          missing_in_col_set = set()
2026-02-20T22:09:14.4125711Z          if col_idx < (len(grid[0]) if grid and isinstance(grid[0], list) else 0):
2026-02-20T22:09:14.4126036Z              for row in grid:
2026-02-20T22:09:14.4126256Z                  if isinstance(row, list) and col_idx < len(row):
2026-02-20T22:09:14.4126466Z                      cell_str = str(row[col_idx]).strip().lower()
2026-02-20T22:09:14.4126663Z -                    if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4126850Z +                    if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4127039Z                          missing_in_col_set.add(cell_str)
2026-02-20T22:09:14.4127260Z              missing_in_col = all_elements - missing_in_col_set
2026-02-20T22:09:14.4127377Z -            
2026-02-20T22:09:14.4127488Z +
2026-02-20T22:09:14.4127701Z              intersection = missing_in_row & missing_in_col
2026-02-20T22:09:14.4127846Z              if len(intersection) == 1:
2026-02-20T22:09:14.4128012Z                  missing = list(intersection)[0]
2026-02-20T22:09:14.4128180Z                  # Retrouver la casse originale
2026-02-20T22:09:14.4128315Z                  for row in grid:
2026-02-20T22:09:14.4128468Z                      if isinstance(row, list):
2026-02-20T22:09:14.4128612Z                          for cell in row:
2026-02-20T22:09:14.4128810Z                              if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4128961Z                                  return str(cell)
2026-02-20T22:09:14.4129096Z                  return missing
2026-02-20T22:09:14.4129202Z -    
2026-02-20T22:09:14.4129303Z +
2026-02-20T22:09:14.4129413Z      return None
2026-02-20T22:09:14.4129519Z  
2026-02-20T22:09:14.4129621Z  
2026-02-20T22:09:14.4130212Z -def validate_sequence_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4130381Z +def validate_sequence_challenge(
2026-02-20T22:09:14.4130675Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4130791Z +) -> List[str]:
2026-02-20T22:09:14.4130901Z      """
2026-02-20T22:09:14.4131067Z      Valide un challenge de type SEQUENCE.
2026-02-20T22:09:14.4131452Z      Vérifie que la réponse correspond à la séquence logique.
2026-02-20T22:09:14.4131565Z      """
2026-02-20T22:09:14.4131686Z      errors = []
2026-02-20T22:09:14.4131789Z -    
2026-02-20T22:09:14.4132007Z -    if not visual_data or 'sequence' not in visual_data:
2026-02-20T22:09:14.4132112Z +
2026-02-20T22:09:14.4132332Z +    if not visual_data or "sequence" not in visual_data:
2026-02-20T22:09:14.4163433Z          # Sequence peut être dans visual_data ou directement dans la question
2026-02-20T22:09:14.4163600Z          return errors
2026-02-20T22:09:14.4163951Z -    
2026-02-20T22:09:14.4164142Z -    sequence = visual_data.get('sequence', [])
2026-02-20T22:09:14.4164248Z +
2026-02-20T22:09:14.4164426Z +    sequence = visual_data.get("sequence", [])
2026-02-20T22:09:14.4164654Z      if not sequence or not isinstance(sequence, list):
2026-02-20T22:09:14.4164782Z          return errors
2026-02-20T22:09:14.4164899Z -    
2026-02-20T22:09:14.4165007Z +
2026-02-20T22:09:14.4165419Z      # Analyser la séquence pour déterminer le prochain élément
2026-02-20T22:09:14.4165581Z      expected = analyze_sequence(sequence)
2026-02-20T22:09:14.4165695Z -    
2026-02-20T22:09:14.4165800Z +
2026-02-20T22:09:14.4165942Z      if expected is not None:
2026-02-20T22:09:14.4166161Z          correct_normalized = str(correct_answer).strip()
2026-02-20T22:09:14.4166371Z          expected_normalized = str(expected).strip()
2026-02-20T22:09:14.4166479Z -        
2026-02-20T22:09:14.4166582Z +
2026-02-20T22:09:14.4166787Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4166930Z              errors.append(
2026-02-20T22:09:14.4167422Z                  f"Séquence incohérente: la séquence {sequence} suggère '{expected}', "
2026-02-20T22:09:14.4167636Z                  f"mais correct_answer est '{correct_answer}'"
2026-02-20T22:09:14.4167752Z              )
2026-02-20T22:09:14.4167860Z -    
2026-02-20T22:09:14.4168166Z +
2026-02-20T22:09:14.4168294Z      return errors
2026-02-20T22:09:14.4168397Z  
2026-02-20T22:09:14.4168500Z  
2026-02-20T22:09:14.4168764Z  def analyze_sequence(sequence: List[Any]) -> Optional[str]:
2026-02-20T22:09:14.4168879Z      """
2026-02-20T22:09:14.4168993Z @@ -451,12 +508,14 @@
2026-02-20T22:09:14.4169149Z      if not sequence or len(sequence) < 2:
2026-02-20T22:09:14.4169276Z          return None
2026-02-20T22:09:14.4169381Z  
2026-02-20T22:09:14.4169492Z      try:
2026-02-20T22:09:14.4169603Z          nums = [
2026-02-20T22:09:14.4169749Z -            float(s) for s in sequence
2026-02-20T22:09:14.4170171Z -            if isinstance(s, (int, float, str)) and str(s).replace(".", "").replace("-", "").isdigit()
2026-02-20T22:09:14.4170299Z +            float(s)
2026-02-20T22:09:14.4170438Z +            for s in sequence
2026-02-20T22:09:14.4170601Z +            if isinstance(s, (int, float, str))
2026-02-20T22:09:14.4170827Z +            and str(s).replace(".", "").replace("-", "").isdigit()
2026-02-20T22:09:14.4170947Z          ]
2026-02-20T22:09:14.4171094Z      except (ValueError, TypeError):
2026-02-20T22:09:14.4171213Z          return None
2026-02-20T22:09:14.4171315Z  
2026-02-20T22:09:14.4171445Z      if len(nums) < 2:
2026-02-20T22:09:14.4171565Z @@ -486,203 +545,257 @@
2026-02-20T22:09:14.4171885Z              return str(int(next_num)) if next_num.is_integer() else str(next_num)
2026-02-20T22:09:14.4171998Z  
2026-02-20T22:09:14.4172110Z      return None
2026-02-20T22:09:14.4172212Z  
2026-02-20T22:09:14.4172316Z  
2026-02-20T22:09:14.4172887Z -def validate_puzzle_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4173225Z +def validate_puzzle_challenge(
2026-02-20T22:09:14.4173525Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4173650Z +) -> List[str]:
2026-02-20T22:09:14.4173758Z      """
2026-02-20T22:09:14.4173915Z      Valide un challenge de type PUZZLE.
2026-02-20T22:09:14.4174116Z      Vérifie que:
2026-02-20T22:09:14.4174455Z      - La réponse correspond à l'ordre logique des pièces
2026-02-20T22:09:14.4174811Z      - Des indices/règles sont fournis pour déterminer l'ordre
2026-02-20T22:09:14.4174988Z      - L'explication justifie l'ordre correct
2026-02-20T22:09:14.4175106Z      """
2026-02-20T22:09:14.4175221Z      errors = []
2026-02-20T22:09:14.4175325Z -    
2026-02-20T22:09:14.4175426Z +
2026-02-20T22:09:14.4175565Z      if not visual_data:
2026-02-20T22:09:14.4175857Z          errors.append("visual_data manquant pour un challenge PUZZLE")
2026-02-20T22:09:14.4175977Z          return errors
2026-02-20T22:09:14.4176289Z -    
2026-02-20T22:09:14.4176580Z -    pieces = visual_data.get('pieces', visual_data.get('items', []))
2026-02-20T22:09:14.4176687Z +
2026-02-20T22:09:14.4176966Z +    pieces = visual_data.get("pieces", visual_data.get("items", []))
2026-02-20T22:09:14.4177161Z      if not pieces or not isinstance(pieces, list):
2026-02-20T22:09:14.4177508Z          errors.append("visual_data.pieces manquant pour un challenge PUZZLE")
2026-02-20T22:09:14.4177631Z          return errors
2026-02-20T22:09:14.4177741Z -    
2026-02-20T22:09:14.4177846Z +
2026-02-20T22:09:14.4178238Z      # Vérifier qu'il y a des indices/règles pour résoudre le puzzle
2026-02-20T22:09:14.4178811Z -    hints = visual_data.get('hints', visual_data.get('rules', visual_data.get('clues', visual_data.get('indices', []))))
2026-02-20T22:09:14.4179019Z -    description = visual_data.get('description', '')
2026-02-20T22:09:14.4179120Z -    
2026-02-20T22:09:14.4179264Z +    hints = visual_data.get(
2026-02-20T22:09:14.4179373Z +        "hints",
2026-02-20T22:09:14.4179507Z +        visual_data.get(
2026-02-20T22:09:14.4179797Z +            "rules", visual_data.get("clues", visual_data.get("indices", []))
2026-02-20T22:09:14.4179911Z +        ),
2026-02-20T22:09:14.4180016Z +    )
2026-02-20T22:09:14.4180219Z +    description = visual_data.get("description", "")
2026-02-20T22:09:14.4180530Z +
2026-02-20T22:09:14.4180692Z      if not hints and not description:
2026-02-20T22:09:14.4180826Z          errors.append(
2026-02-20T22:09:14.4181202Z              "PUZZLE incomplet: aucun indice (hints/rules/clues) ni description fourni. "
2026-02-20T22:09:14.4181628Z              "L'utilisateur n'a aucun moyen de déterminer l'ordre correct."
2026-02-20T22:09:14.4181737Z          )
2026-02-20T22:09:14.4181840Z -    
2026-02-20T22:09:14.4181945Z +
2026-02-20T22:09:14.4182380Z      # Vérifier que les indices sont substantiels (pas vides ou trop courts)
2026-02-20T22:09:14.4182542Z      if hints and isinstance(hints, list):
2026-02-20T22:09:14.4182885Z          valid_hints = [h for h in hints if isinstance(h, str) and len(h.strip()) > 5]
2026-02-20T22:09:14.4183253Z          if len(valid_hints) < 2 and len(pieces) > 2:
2026-02-20T22:09:14.4183387Z              errors.append(
2026-02-20T22:09:14.4184023Z                  f"PUZZLE avec {len(pieces)} éléments mais seulement {len(valid_hints)} indice(s) valide(s). "
2026-02-20T22:09:14.4184428Z                  f"Ajoutez plus d'indices pour permettre la résolution."
2026-02-20T22:09:14.4184541Z              )
2026-02-20T22:09:14.4184641Z -    
2026-02-20T22:09:14.4184749Z +
2026-02-20T22:09:14.4185065Z      # Parser les pièces en liste de strings normalisées
2026-02-20T22:09:14.4185198Z      piece_values = []
2026-02-20T22:09:14.4185322Z      for p in pieces:
2026-02-20T22:09:14.4185466Z          if isinstance(p, dict):
2026-02-20T22:09:14.4185751Z -            val = p.get('label') or p.get('value') or p.get('name') or str(p)
2026-02-20T22:09:14.4186025Z +            val = p.get("label") or p.get("value") or p.get("name") or str(p)
2026-02-20T22:09:14.4186159Z          else:
2026-02-20T22:09:14.4186276Z              val = p
2026-02-20T22:09:14.4186480Z          piece_values.append(str(val).strip().lower())
2026-02-20T22:09:14.4186591Z -    
2026-02-20T22:09:14.4186693Z +
2026-02-20T22:09:14.4187072Z      # Pour un puzzle, la réponse devrait être une liste ordonnée
2026-02-20T22:09:14.4187215Z      if correct_answer:
2026-02-20T22:09:14.4187506Z          # Gérer correct_answer comme liste ou string
2026-02-20T22:09:14.4187676Z          if isinstance(correct_answer, list):
2026-02-20T22:09:14.4187968Z              answer_parts = [str(p).strip().lower() for p in correct_answer]
2026-02-20T22:09:14.4188082Z          else:
2026-02-20T22:09:14.4188421Z -            answer_parts = [p.strip().lower() for p in str(correct_answer).split(',')]
2026-02-20T22:09:14.4188532Z -        
2026-02-20T22:09:14.4188866Z +            answer_parts = [p.strip().lower() for p in str(correct_answer).split(",")]
2026-02-20T22:09:14.4189209Z +
2026-02-20T22:09:14.4189400Z          if len(answer_parts) != len(piece_values):
2026-02-20T22:09:14.4189536Z              errors.append(
2026-02-20T22:09:14.4190077Z                  f"Puzzle incohérent: correct_answer contient {len(answer_parts)} éléments, "
2026-02-20T22:09:14.4190438Z                  f"mais pieces contient {len(piece_values)} éléments"
2026-02-20T22:09:14.4190564Z              )
2026-02-20T22:09:14.4190676Z -        
2026-02-20T22:09:14.4190777Z +
2026-02-20T22:09:14.4191184Z          # Vérifier que tous les éléments de pieces sont dans la réponse
2026-02-20T22:09:14.4191393Z          missing = set(piece_values) - set(answer_parts)
2026-02-20T22:09:14.4191519Z          if missing:
2026-02-20T22:09:14.4192012Z              errors.append(f"Puzzle: éléments manquants dans correct_answer: {missing}")
2026-02-20T22:09:14.4192123Z -    
2026-02-20T22:09:14.4192242Z +
2026-02-20T22:09:14.4192522Z      # Vérifier que l'explication justifie l'ordre
2026-02-20T22:09:14.4192678Z      if explanation and piece_values:
2026-02-20T22:09:14.4223344Z          # L'explication devrait mentionner au moins quelques éléments
2026-02-20T22:09:14.4223593Z          explanation_lower = str(explanation).lower()
2026-02-20T22:09:14.4223946Z          mentioned_count = sum(1 for p in piece_values if p in explanation_lower)
2026-02-20T22:09:14.4224152Z          if mentioned_count < len(piece_values) // 2:
2026-02-20T22:09:14.4224589Z              errors.append(
2026-02-20T22:09:14.4225232Z                  "L'explication ne mentionne pas assez d'éléments du puzzle pour justifier l'ordre."
2026-02-20T22:09:14.4225353Z              )
2026-02-20T22:09:14.4225467Z -    
2026-02-20T22:09:14.4225572Z +
2026-02-20T22:09:14.4225695Z      return errors
2026-02-20T22:09:14.4225796Z  
2026-02-20T22:09:14.4225910Z  
2026-02-20T22:09:14.4226477Z -def validate_graph_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4226634Z +def validate_graph_challenge(
2026-02-20T22:09:14.4226952Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4227075Z +) -> List[str]:
2026-02-20T22:09:14.4227181Z      """
2026-02-20T22:09:14.4227344Z      Valide un challenge de type GRAPH.
2026-02-20T22:09:14.4227664Z      Vérifie que les nœuds et arêtes sont cohérents.
2026-02-20T22:09:14.4227772Z      """
2026-02-20T22:09:14.4227897Z      errors = []
2026-02-20T22:09:14.4228009Z -    
2026-02-20T22:09:14.4228113Z +
2026-02-20T22:09:14.4228239Z      if not visual_data:
2026-02-20T22:09:14.4228367Z          return errors
2026-02-20T22:09:14.4228471Z -    
2026-02-20T22:09:14.4228760Z -    nodes = visual_data.get('nodes', visual_data.get('vertices', []))
2026-02-20T22:09:14.4229031Z -    edges = visual_data.get('edges', visual_data.get('links', []))
2026-02-20T22:09:14.4229145Z -    
2026-02-20T22:09:14.4229247Z +
2026-02-20T22:09:14.4229528Z +    nodes = visual_data.get("nodes", visual_data.get("vertices", []))
2026-02-20T22:09:14.4229800Z +    edges = visual_data.get("edges", visual_data.get("links", []))
2026-02-20T22:09:14.4229915Z +
2026-02-20T22:09:14.4230098Z      if not nodes or not isinstance(nodes, list):
2026-02-20T22:09:14.4230496Z          errors.append("visual_data.nodes manquant ou invalide pour un challenge GRAPH")
2026-02-20T22:09:14.4230628Z          return errors
2026-02-20T22:09:14.4230731Z -    
2026-02-20T22:09:14.4230845Z +
2026-02-20T22:09:14.4231180Z      # Créer un set des noms de nœuds pour vérification
2026-02-20T22:09:14.4231310Z      node_names = set()
2026-02-20T22:09:14.4231429Z      for node in nodes:
2026-02-20T22:09:14.4231587Z          if isinstance(node, dict):
2026-02-20T22:09:14.4231996Z -            node_names.add(str(node.get('label', node.get('value', node.get('id', '')))).upper())
2026-02-20T22:09:14.4232129Z +            node_names.add(
2026-02-20T22:09:14.4232435Z +                str(node.get("label", node.get("value", node.get("id", "")))).upper()
2026-02-20T22:09:14.4232553Z +            )
2026-02-20T22:09:14.4232865Z          else:
2026-02-20T22:09:14.4233214Z              node_names.add(str(node).upper())
2026-02-20T22:09:14.4233331Z -    
2026-02-20T22:09:14.4233433Z +
2026-02-20T22:09:14.4233860Z      # Vérifier que toutes les arêtes référencent des nœuds existants
2026-02-20T22:09:14.4234027Z      if edges and isinstance(edges, list):
2026-02-20T22:09:14.4234185Z          for edge in edges:
2026-02-20T22:09:14.4234330Z              if isinstance(edge, dict):
2026-02-20T22:09:14.4234537Z -                from_node = str(edge.get('from', '')).upper()
2026-02-20T22:09:14.4234726Z -                to_node = str(edge.get('to', '')).upper()
2026-02-20T22:09:14.4234919Z +                from_node = str(edge.get("from", "")).upper()
2026-02-20T22:09:14.4235095Z +                to_node = str(edge.get("to", "")).upper()
2026-02-20T22:09:14.4235352Z              elif isinstance(edge, (list, tuple)) and len(edge) >= 2:
2026-02-20T22:09:14.4235510Z                  from_node = str(edge[0]).upper()
2026-02-20T22:09:14.4235663Z                  to_node = str(edge[1]).upper()
2026-02-20T22:09:14.4235787Z              else:
2026-02-20T22:09:14.4235908Z                  continue
2026-02-20T22:09:14.4236013Z -            
2026-02-20T22:09:14.4236113Z +
2026-02-20T22:09:14.4236453Z              if from_node and from_node not in node_names and not from_node.isdigit():
2026-02-20T22:09:14.4237441Z -                errors.append(f"Arête référence un nœud inexistant: '{edge[0] if isinstance(edge, list) else edge.get('from')}'")
2026-02-20T22:09:14.4237584Z +                errors.append(
2026-02-20T22:09:14.4238250Z +                    f"Arête référence un nœud inexistant: '{edge[0] if isinstance(edge, list) else edge.get('from')}'"
2026-02-20T22:09:14.4238366Z +                )
2026-02-20T22:09:14.4238659Z              if to_node and to_node not in node_names and not to_node.isdigit():
2026-02-20T22:09:14.4239399Z -                errors.append(f"Arête référence un nœud inexistant: '{edge[1] if isinstance(edge, list) else edge.get('to')}'")
2026-02-20T22:09:14.4239532Z -    
2026-02-20T22:09:14.4239664Z +                errors.append(
2026-02-20T22:09:14.4240288Z +                    f"Arête référence un nœud inexistant: '{edge[1] if isinstance(edge, list) else edge.get('to')}'"
2026-02-20T22:09:14.4240407Z +                )
2026-02-20T22:09:14.4240509Z +
2026-02-20T22:09:14.4240621Z      return errors
2026-02-20T22:09:14.4240744Z  
2026-02-20T22:09:14.4240846Z  
2026-02-20T22:09:14.4241412Z -def validate_spatial_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4241562Z +def validate_spatial_challenge(
2026-02-20T22:09:14.4241870Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4241988Z +) -> List[str]:
2026-02-20T22:09:14.4242095Z      """
2026-02-20T22:09:14.4242505Z      Valide un challenge de type VISUAL (inclut les défis spatiaux).
2026-02-20T22:09:14.4242937Z      Vérifie la cohérence des données de symétrie, de formes, ou de grilles.
2026-02-20T22:09:14.4243235Z      """
2026-02-20T22:09:14.4243370Z      errors = []
2026-02-20T22:09:14.4243477Z -    
2026-02-20T22:09:14.4243583Z +
2026-02-20T22:09:14.4243709Z      if not visual_data:
2026-02-20T22:09:14.4243835Z          return errors
2026-02-20T22:09:14.4243941Z -    
2026-02-20T22:09:14.4244044Z +
2026-02-20T22:09:14.4244664Z      # Vérifier si c'est un défi avec grille (souvent catégorisé comme VISUAL mais contient une grille)
2026-02-20T22:09:14.4245078Z -    grid = visual_data.get('grid', visual_data.get('matrix', visual_data.get('pattern')))
2026-02-20T22:09:14.4245215Z +    grid = visual_data.get(
2026-02-20T22:09:14.4245476Z +        "grid", visual_data.get("matrix", visual_data.get("pattern"))
2026-02-20T22:09:14.4245596Z +    )
2026-02-20T22:09:14.4245818Z      if grid and isinstance(grid, list) and len(grid) > 0:
2026-02-20T22:09:14.4246185Z          # C'est en fait un pattern caché dans un challenge VISUAL
2026-02-20T22:09:14.4246493Z          # Appliquer la même validation que pour PATTERN
2026-02-20T22:09:14.4247075Z          pattern_errors = validate_grid_in_visual(grid, correct_answer, explanation)
2026-02-20T22:09:14.4247232Z          errors.extend(pattern_errors)
2026-02-20T22:09:14.4247366Z          return errors
2026-02-20T22:09:14.4247470Z -    
2026-02-20T22:09:14.4247574Z +
2026-02-20T22:09:14.4247825Z      # Vérifier les données de symétrie
2026-02-20T22:09:14.4248023Z -    if visual_data.get('type') == 'symmetry':
2026-02-20T22:09:14.4248194Z -        layout = visual_data.get('layout', [])
2026-02-20T22:09:14.4248408Z -        symmetry_line = visual_data.get('symmetry_line')
2026-02-20T22:09:14.4248519Z -        
2026-02-20T22:09:14.4248678Z +    if visual_data.get("type") == "symmetry":
2026-02-20T22:09:14.4248834Z +        layout = visual_data.get("layout", [])
2026-02-20T22:09:14.4249039Z +        symmetry_line = visual_data.get("symmetry_line")
2026-02-20T22:09:14.4249152Z +
2026-02-20T22:09:14.4249346Z          if not layout or not isinstance(layout, list):
2026-02-20T22:09:14.4249837Z              errors.append("visual_data.layout manquant pour un défi de symétrie")
2026-02-20T22:09:14.4249977Z              return errors
2026-02-20T22:09:14.4250085Z -        
2026-02-20T22:09:14.4250187Z +
2026-02-20T22:09:14.4250614Z          # Vérifier qu'il y a une question (cellule avec '?' ou question: true)
2026-02-20T22:09:14.4250947Z          has_question = False
2026-02-20T22:09:14.4251074Z          for item in layout:
2026-02-20T22:09:14.4251220Z              if isinstance(item, dict):
2026-02-20T22:09:14.4251460Z -                if item.get('question') or item.get('shape') == '?':
2026-02-20T22:09:14.4251693Z +                if item.get("question") or item.get("shape") == "?":
2026-02-20T22:09:14.4251836Z                      has_question = True
2026-02-20T22:09:14.4251959Z                      break
2026-02-20T22:09:14.4252066Z -        
2026-02-20T22:09:14.4252169Z +
2026-02-20T22:09:14.4252296Z          if not has_question:
2026-02-20T22:09:14.4252794Z              errors.append("Défi de symétrie: aucune cellule marquée comme question")
2026-02-20T22:09:14.4252920Z -        
2026-02-20T22:09:14.4273351Z +
2026-02-20T22:09:14.4273740Z          # Vérifier la cohérence gauche/droite
2026-02-20T22:09:14.4274137Z -        left_items = [i for i in layout if isinstance(i, dict) and i.get('side') == 'left']
2026-02-20T22:09:14.4274551Z -        right_items = [i for i in layout if isinstance(i, dict) and i.get('side') == 'right']
2026-02-20T22:09:14.4274668Z -        
2026-02-20T22:09:14.4274794Z +        left_items = [
2026-02-20T22:09:14.4275097Z +            i for i in layout if isinstance(i, dict) and i.get("side") == "left"
2026-02-20T22:09:14.4275207Z +        ]
2026-02-20T22:09:14.4275345Z +        right_items = [
2026-02-20T22:09:14.4275637Z +            i for i in layout if isinstance(i, dict) and i.get("side") == "right"
2026-02-20T22:09:14.4275748Z +        ]
2026-02-20T22:09:14.4275864Z +
2026-02-20T22:09:14.4276033Z          if not left_items or not right_items:
2026-02-20T22:09:14.4276626Z -            errors.append("Défi de symétrie: les côtés gauche et droite doivent être définis")
2026-02-20T22:09:14.4276747Z -    
2026-02-20T22:09:14.4276877Z +            errors.append(
2026-02-20T22:09:14.4277325Z +                "Défi de symétrie: les côtés gauche et droite doivent être définis"
2026-02-20T22:09:14.4277452Z +            )
2026-02-20T22:09:14.4277563Z +
2026-02-20T22:09:14.4277783Z      # Vérifier les formes basiques
2026-02-20T22:09:14.4277950Z -    shapes = visual_data.get('shapes', [])
2026-02-20T22:09:14.4278114Z +    shapes = visual_data.get("shapes", [])
2026-02-20T22:09:14.4278276Z      if shapes and isinstance(shapes, list):
2026-02-20T22:09:14.4278654Z          # Détecter si c'est un défi avec associations forme-couleur
2026-02-20T22:09:14.4278966Z -        colors = {'rouge', 'red', 'bleu', 'blue', 'vert', 'green', 'jaune', 'yellow', 
2026-02-20T22:09:14.4279349Z -                  'orange', 'violet', 'purple', 'rose', 'pink', 'noir', 'black', 'blanc', 'white'}
2026-02-20T22:09:14.4280074Z -        shape_names = {'triangle', 'cercle', 'circle', 'carré', 'carre', 'square', 
2026-02-20T22:09:14.4280497Z -                       'rectangle', 'losange', 'diamond', 'étoile', 'etoile', 'star'}
2026-02-20T22:09:14.4280620Z -        
2026-02-20T22:09:14.4280733Z +        colors = {
2026-02-20T22:09:14.4280850Z +            "rouge",
2026-02-20T22:09:14.4280979Z +            "red",
2026-02-20T22:09:14.4281091Z +            "bleu",
2026-02-20T22:09:14.4281204Z +            "blue",
2026-02-20T22:09:14.4281313Z +            "vert",
2026-02-20T22:09:14.4281431Z +            "green",
2026-02-20T22:09:14.4281542Z +            "jaune",
2026-02-20T22:09:14.4281656Z +            "yellow",
2026-02-20T22:09:14.4281771Z +            "orange",
2026-02-20T22:09:14.4281883Z +            "violet",
2026-02-20T22:09:14.4281999Z +            "purple",
2026-02-20T22:09:14.4282111Z +            "rose",
2026-02-20T22:09:14.4282232Z +            "pink",
2026-02-20T22:09:14.4282341Z +            "noir",
2026-02-20T22:09:14.4282460Z +            "black",
2026-02-20T22:09:14.4282573Z +            "blanc",
2026-02-20T22:09:14.4282685Z +            "white",
2026-02-20T22:09:14.4282788Z +        }
2026-02-20T22:09:14.4282915Z +        shape_names = {
2026-02-20T22:09:14.4283217Z +            "triangle",
2026-02-20T22:09:14.4283332Z +            "cercle",
2026-02-20T22:09:14.4283663Z +            "circle",
2026-02-20T22:09:14.4283868Z +            "carré",
2026-02-20T22:09:14.4283980Z +            "carre",
2026-02-20T22:09:14.4284088Z +            "square",
2026-02-20T22:09:14.4284208Z +            "rectangle",
2026-02-20T22:09:14.4284333Z +            "losange",
2026-02-20T22:09:14.4284451Z +            "diamond",
2026-02-20T22:09:14.4284626Z +            "étoile",
2026-02-20T22:09:14.4284748Z +            "etoile",
2026-02-20T22:09:14.4284859Z +            "star",
2026-02-20T22:09:14.4284968Z +        }
2026-02-20T22:09:14.4285073Z +
2026-02-20T22:09:14.4285358Z          # Collecter les associations forme-couleur visibles (hors ?)
2026-02-20T22:09:14.4285592Z          visible_associations = {}  # {forme: set(couleurs)}
2026-02-20T22:09:14.4285726Z          question_shape = None
2026-02-20T22:09:14.4285838Z -        
2026-02-20T22:09:14.4285940Z +
2026-02-20T22:09:14.4286069Z          for shape in shapes:
2026-02-20T22:09:14.4286231Z              shape_lower = str(shape).lower()
2026-02-20T22:09:14.4286390Z -            if '?' in shape_lower:
2026-02-20T22:09:14.4286517Z +            if "?" in shape_lower:
2026-02-20T22:09:14.4286708Z                  # C'est la question - extraire la forme
2026-02-20T22:09:14.4286859Z                  for sn in shape_names:
2026-02-20T22:09:14.4287006Z                      if sn in shape_lower:
2026-02-20T22:09:14.4287156Z                          question_shape = sn
2026-02-20T22:09:14.4287286Z                          break
2026-02-20T22:09:14.4287405Z                  continue
2026-02-20T22:09:14.4287510Z -            
2026-02-20T22:09:14.4287610Z +
2026-02-20T22:09:14.4287778Z              # Trouver la forme et la couleur
2026-02-20T22:09:14.4287911Z              found_shape = None
2026-02-20T22:09:14.4288039Z              found_color = None
2026-02-20T22:09:14.4288177Z              for sn in shape_names:
2026-02-20T22:09:14.4288315Z                  if sn in shape_lower:
2026-02-20T22:09:14.4288430Z @@ -690,19 +803,21 @@
2026-02-20T22:09:14.4288557Z                      break
2026-02-20T22:09:14.4288691Z              for c in colors:
2026-02-20T22:09:14.4288828Z                  if c in shape_lower:
2026-02-20T22:09:14.4288955Z                      found_color = c
2026-02-20T22:09:14.4289078Z                      break
2026-02-20T22:09:14.4289185Z -            
2026-02-20T22:09:14.4289283Z +
2026-02-20T22:09:14.4289436Z              if found_shape and found_color:
2026-02-20T22:09:14.4289646Z                  if found_shape not in visible_associations:
2026-02-20T22:09:14.4289848Z                      visible_associations[found_shape] = set()
2026-02-20T22:09:14.4290282Z                  visible_associations[found_shape].add(found_color)
2026-02-20T22:09:14.4290402Z -        
2026-02-20T22:09:14.4290501Z +
2026-02-20T22:09:14.4291044Z          # Format multi-cellules (ex: "Position 2: carré bleu, Position 6: triangle vert")
2026-02-20T22:09:14.4291379Z -        correct_lower = str(correct_answer).lower() if correct_answer else ''
2026-02-20T22:09:14.4291880Z -        is_multi_cell = 'position' in correct_lower and (',' in correct_lower or correct_lower.count(':') >= 2)
2026-02-20T22:09:14.4292197Z +        correct_lower = str(correct_answer).lower() if correct_answer else ""
2026-02-20T22:09:14.4292413Z +        is_multi_cell = "position" in correct_lower and (
2026-02-20T22:09:14.4292634Z +            "," in correct_lower or correct_lower.count(":") >= 2
2026-02-20T22:09:14.4292744Z +        )
2026-02-20T22:09:14.4292868Z          if is_multi_cell:
2026-02-20T22:09:14.4293633Z              # Ne pas appliquer la validation forme-couleur unique (trop complexe à valider auto)
2026-02-20T22:09:14.4293767Z              pass
2026-02-20T22:09:14.4293874Z          else:
2026-02-20T22:09:14.4294135Z              answer_is_color = any(c in correct_lower for c in colors)
2026-02-20T22:09:14.4294254Z @@ -719,266 +834,317 @@
2026-02-20T22:09:14.4294461Z                      if not answer_color_found and visible_colors:
2026-02-20T22:09:14.4294814Z                          errors.append(
2026-02-20T22:09:14.4295460Z                              f"VISUAL incohérent: la réponse '{correct_answer}' n'est pas visible dans les exemples "
2026-02-20T22:09:14.4295712Z                              f"de '{question_shape}'. Visible: {visible_colors}"
2026-02-20T22:09:14.4295833Z                          )
2026-02-20T22:09:14.4295948Z -    
2026-02-20T22:09:14.4296049Z +
2026-02-20T22:09:14.4296331Z      # Vérifier que correct_answer n'est pas vide
2026-02-20T22:09:14.4296579Z      if not correct_answer or not str(correct_answer).strip():
2026-02-20T22:09:14.4296968Z          errors.append("correct_answer est vide pour un défi VISUAL")
2026-02-20T22:09:14.4297089Z -    
2026-02-20T22:09:14.4297192Z +
2026-02-20T22:09:14.4297318Z      return errors
2026-02-20T22:09:14.4297421Z  
2026-02-20T22:09:14.4297523Z  
2026-02-20T22:09:14.4298023Z -def validate_grid_in_visual(grid: List[List[Any]], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4298184Z +def validate_grid_in_visual(
2026-02-20T22:09:14.4298440Z +    grid: List[List[Any]], correct_answer: str, explanation: str
2026-02-20T22:09:14.4298565Z +) -> List[str]:
2026-02-20T22:09:14.4298673Z      """
2026-02-20T22:09:14.4298902Z      Valide une grille contenue dans un challenge VISUAL.
2026-02-20T22:09:14.4299276Z      Vérifie la cohérence entre la grille et la réponse fournie.
2026-02-20T22:09:14.4299392Z      """
2026-02-20T22:09:14.4299507Z      errors = []
2026-02-20T22:09:14.4299612Z -    
2026-02-20T22:09:14.4299724Z +
2026-02-20T22:09:14.4299869Z      # Trouver la position du '?'
2026-02-20T22:09:14.4300000Z      question_pos = None
2026-02-20T22:09:14.4300149Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.4300297Z          if not isinstance(row, list):
2026-02-20T22:09:14.4300415Z              continue
2026-02-20T22:09:14.4300559Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4300819Z -            if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.4301076Z +            if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.4301213Z                  question_pos = (i, j)
2026-02-20T22:09:14.4301325Z                  break
2026-02-20T22:09:14.4301464Z          if question_pos:
2026-02-20T22:09:14.4301573Z              break
2026-02-20T22:09:14.4301679Z -    
2026-02-20T22:09:14.4301793Z +
2026-02-20T22:09:14.4301921Z      if not question_pos:
2026-02-20T22:09:14.4302139Z          # Pas de '?' à compléter
2026-02-20T22:09:14.4302262Z          return errors
2026-02-20T22:09:14.4302374Z -    
2026-02-20T22:09:14.4302475Z +
2026-02-20T22:09:14.4302823Z      row_idx, col_idx = question_pos
2026-02-20T22:09:14.4302938Z -    
2026-02-20T22:09:14.4353285Z +
2026-02-20T22:09:14.4353724Z      # Analyser le pattern pour déterminer la réponse attendue
2026-02-20T22:09:14.4354062Z      expected_answer = analyze_latin_square_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4354213Z      if not expected_answer:
2026-02-20T22:09:14.4354491Z          expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4354598Z -    
2026-02-20T22:09:14.4354706Z +
2026-02-20T22:09:14.4354842Z      if expected_answer:
2026-02-20T22:09:14.4355133Z          # Normaliser les réponses pour comparaison
2026-02-20T22:09:14.4355399Z          correct_normalized = str(correct_answer).strip().lower()
2026-02-20T22:09:14.4355668Z          expected_normalized = str(expected_answer).strip().lower()
2026-02-20T22:09:14.4355778Z -        
2026-02-20T22:09:14.4355883Z +
2026-02-20T22:09:14.4356098Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4356246Z              errors.append(
2026-02-20T22:09:14.4356735Z                  f"Grille VISUAL incohérente: le pattern suggère '{expected_answer}', "
2026-02-20T22:09:14.4356969Z                  f"mais correct_answer est '{correct_answer}'. "
2026-02-20T22:09:14.4357108Z                  f"Grille: {grid}"
2026-02-20T22:09:14.4357216Z              )
2026-02-20T22:09:14.4357533Z -    
2026-02-20T22:09:14.4357644Z +
2026-02-20T22:09:14.4357763Z      return errors
2026-02-20T22:09:14.4357865Z  
2026-02-20T22:09:14.4357975Z  
2026-02-20T22:09:14.4358346Z  def auto_correct_challenge(challenge_data: Dict[str, Any]) -> Dict[str, Any]:
2026-02-20T22:09:14.4358457Z      """
2026-02-20T22:09:14.4358710Z      Tente de corriger automatiquement un challenge invalide.
2026-02-20T22:09:14.4358826Z -    
2026-02-20T22:09:14.4358930Z +
2026-02-20T22:09:14.4359042Z      Args:
2026-02-20T22:09:14.4359489Z          challenge_data: Dictionnaire contenant les données du challenge
2026-02-20T22:09:14.4359599Z -        
2026-02-20T22:09:14.4359713Z +
2026-02-20T22:09:14.4359823Z      Returns:
2026-02-20T22:09:14.4360317Z          Dictionnaire corrigé (peut être identique si aucune correction possible)
2026-02-20T22:09:14.4360430Z      """
2026-02-20T22:09:14.4360587Z      corrected = challenge_data.copy()
2026-02-20T22:09:14.4360697Z -    
2026-02-20T22:09:14.4360991Z -    challenge_type = challenge_data.get('challenge_type', '').upper()
2026-02-20T22:09:14.4361214Z -    visual_data = challenge_data.get('visual_data', {})
2026-02-20T22:09:14.4361322Z -    
2026-02-20T22:09:14.4361425Z +
2026-02-20T22:09:14.4361711Z +    challenge_type = challenge_data.get("challenge_type", "").upper()
2026-02-20T22:09:14.4361913Z +    visual_data = challenge_data.get("visual_data", {})
2026-02-20T22:09:14.4362022Z +
2026-02-20T22:09:14.4362258Z      # Parser visual_data si nécessaire
2026-02-20T22:09:14.4362409Z      if isinstance(visual_data, str):
2026-02-20T22:09:14.4362525Z          try:
2026-02-20T22:09:14.4362697Z              visual_data = json.loads(visual_data)
2026-02-20T22:09:14.4362858Z          except json.JSONDecodeError:
2026-02-20T22:09:14.4363161Z              return corrected
2026-02-20T22:09:14.4363283Z -    
2026-02-20T22:09:14.4363388Z +
2026-02-20T22:09:14.4363538Z      # Correction pour PATTERN
2026-02-20T22:09:14.4363874Z -    if challenge_type == 'PATTERN' and visual_data and 'grid' in visual_data:
2026-02-20T22:09:14.4364047Z -        grid = visual_data.get('grid', [])
2026-02-20T22:09:14.4364367Z +    if challenge_type == "PATTERN" and visual_data and "grid" in visual_data:
2026-02-20T22:09:14.4364524Z +        grid = visual_data.get("grid", [])
2026-02-20T22:09:14.4364637Z          if grid:
2026-02-20T22:09:14.4364913Z              # Plusieurs "?" → format "O, O, X, O"
2026-02-20T22:09:14.4365159Z              expected_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:14.4365296Z              if expected_multi:
2026-02-20T22:09:14.4365778Z -                logger.info(f"Correction automatique PATTERN (multi): correct_answer = '{expected_multi}'")
2026-02-20T22:09:14.4366205Z -                corrected['correct_answer'] = expected_multi
2026-02-20T22:09:14.4366483Z -                explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4367108Z -                if expected_multi[:20] not in explanation and expected_multi.split(',')[0].strip().upper() not in explanation.upper():
2026-02-20T22:09:14.4367320Z -                    corrected['solution_explanation'] = (
2026-02-20T22:09:14.4367457Z +                logger.info(
2026-02-20T22:09:14.4367868Z +                    f"Correction automatique PATTERN (multi): correct_answer = '{expected_multi}'"
2026-02-20T22:09:14.4367975Z +                )
2026-02-20T22:09:14.4368178Z +                corrected["correct_answer"] = expected_multi
2026-02-20T22:09:14.4368446Z +                explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4368558Z +                if (
2026-02-20T22:09:14.4368745Z +                    expected_multi[:20] not in explanation
2026-02-20T22:09:14.4368991Z +                    and expected_multi.split(",")[0].strip().upper()
2026-02-20T22:09:14.4369157Z +                    not in explanation.upper()
2026-02-20T22:09:14.4369265Z +                ):
2026-02-20T22:09:14.4369460Z +                    corrected["solution_explanation"] = (
2026-02-20T22:09:14.4370144Z                          f"Les symboles manquants, dans l'ordre des cases (ligne par ligne), sont : {expected_multi}. "
2026-02-20T22:09:14.4370293Z                          f"{explanation}"
2026-02-20T22:09:14.4370416Z                      )
2026-02-20T22:09:14.4370526Z              else:
2026-02-20T22:09:14.4370664Z                  question_pos = None
2026-02-20T22:09:14.4370822Z                  for i, row in enumerate(grid):
2026-02-20T22:09:14.4370993Z                      if not isinstance(row, list):
2026-02-20T22:09:14.4371118Z                          continue
2026-02-20T22:09:14.4371281Z                      for j, cell in enumerate(row):
2026-02-20T22:09:14.4371546Z -                        if cell == '?' or (isinstance(cell, str) and '?' in cell):
2026-02-20T22:09:14.4371789Z +                        if cell == "?" or (isinstance(cell, str) and "?" in cell):
2026-02-20T22:09:14.4371940Z                              question_pos = (i, j)
2026-02-20T22:09:14.4372073Z                              break
2026-02-20T22:09:14.4372214Z                      if question_pos:
2026-02-20T22:09:14.4372334Z                          break
2026-02-20T22:09:14.4372462Z                  if question_pos:
2026-02-20T22:09:14.4372637Z                      row_idx, col_idx = question_pos
2026-02-20T22:09:14.4372907Z                      expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4373226Z                      if expected_answer:
2026-02-20T22:09:14.4373712Z -                        logger.info(f"Correction automatique PATTERN: correct_answer = '{expected_answer}'")
2026-02-20T22:09:14.4373944Z -                        corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4374061Z -                    
2026-02-20T22:09:14.4374200Z +                        logger.info(
2026-02-20T22:09:14.4374590Z +                            f"Correction automatique PATTERN: correct_answer = '{expected_answer}'"
2026-02-20T22:09:14.4374708Z +                        )
2026-02-20T22:09:14.4374931Z +                        corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4375044Z +
2026-02-20T22:09:14.4375443Z                      # Mettre à jour l'explication si elle est contradictoire
2026-02-20T22:09:14.4375695Z -                    explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4375959Z +                    explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4376214Z                      if expected_answer.upper() not in explanation.upper():
2026-02-20T22:09:14.4376413Z -                        corrected['solution_explanation'] = (
2026-02-20T22:09:14.4376602Z +                        corrected["solution_explanation"] = (
2026-02-20T22:09:14.4377392Z                              f"En analysant le pattern dans la grille, on observe que le motif se répète. "
2026-02-20T22:09:14.4377854Z                              f"Le pattern suggère que la réponse est '{expected_answer}'. "
2026-02-20T22:09:14.4378018Z                              f"{explanation}"
2026-02-20T22:09:14.4378145Z                          )
2026-02-20T22:09:14.4378251Z -    
2026-02-20T22:09:14.4378354Z +
2026-02-20T22:09:14.4378518Z      # Correction pour VISUAL avec grille
2026-02-20T22:09:14.4378706Z -    if challenge_type == 'VISUAL' and visual_data:
2026-02-20T22:09:14.4379106Z -        grid = visual_data.get('grid', visual_data.get('matrix', visual_data.get('pattern')))
2026-02-20T22:09:14.4379298Z +    if challenge_type == "VISUAL" and visual_data:
2026-02-20T22:09:14.4379436Z +        grid = visual_data.get(
2026-02-20T22:09:14.4379701Z +            "grid", visual_data.get("matrix", visual_data.get("pattern"))
2026-02-20T22:09:14.4379821Z +        )
2026-02-20T22:09:14.4380053Z          if grid and isinstance(grid, list) and len(grid) > 0:
2026-02-20T22:09:14.4380205Z              # Trouver la position du '?'
2026-02-20T22:09:14.4380337Z              question_pos = None
2026-02-20T22:09:14.4380494Z              for i, row in enumerate(grid):
2026-02-20T22:09:14.4380842Z                  if not isinstance(row, list):
2026-02-20T22:09:14.4380968Z                      continue
2026-02-20T22:09:14.4381135Z                  for j, cell in enumerate(row):
2026-02-20T22:09:14.4381409Z -                    if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.4381668Z +                    if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.4381819Z                          question_pos = (i, j)
2026-02-20T22:09:14.4381943Z                          break
2026-02-20T22:09:14.4382074Z                  if question_pos:
2026-02-20T22:09:14.4382188Z                      break
2026-02-20T22:09:14.4382309Z -            
2026-02-20T22:09:14.4382413Z +
2026-02-20T22:09:14.4382546Z              if question_pos:
2026-02-20T22:09:14.4382713Z                  row_idx, col_idx = question_pos
2026-02-20T22:09:14.4413296Z                  expected_answer = analyze_latin_square_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4413495Z                  if not expected_answer:
2026-02-20T22:09:14.4413787Z                      expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4413912Z -                
2026-02-20T22:09:14.4414025Z +
2026-02-20T22:09:14.4414168Z                  if expected_answer:
2026-02-20T22:09:14.4414550Z -                    current_answer = str(corrected.get('correct_answer', '')).strip().lower()
2026-02-20T22:09:14.4414693Z +                    current_answer = (
2026-02-20T22:09:14.4414961Z +                        str(corrected.get("correct_answer", "")).strip().lower()
2026-02-20T22:09:14.4415088Z +                    )
2026-02-20T22:09:14.4415300Z                      expected_lower = expected_answer.lower()
2026-02-20T22:09:14.4415417Z -                    
2026-02-20T22:09:14.4415523Z +
2026-02-20T22:09:14.4415714Z                      if current_answer != expected_lower:
2026-02-20T22:09:14.4416698Z -                        logger.info(f"Correction automatique VISUAL: correct_answer changé de '{corrected.get('correct_answer')}' à '{expected_answer}'")
2026-02-20T22:09:14.4416943Z -                        corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4417067Z -                        
2026-02-20T22:09:14.4417200Z +                        logger.info(
2026-02-20T22:09:14.4418073Z +                            f"Correction automatique VISUAL: correct_answer changé de '{corrected.get('correct_answer')}' à '{expected_answer}'"
2026-02-20T22:09:14.4418203Z +                        )
2026-02-20T22:09:14.4418422Z +                        corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4418747Z +
2026-02-20T22:09:14.4419173Z                          # Mettre à jour l'explication et le titre si contradictoires
2026-02-20T22:09:14.4419467Z -                        explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4419665Z -                        title = corrected.get('title', '')
2026-02-20T22:09:14.4419869Z -                        question = corrected.get('question', '')
2026-02-20T22:09:14.4420004Z -                        
2026-02-20T22:09:14.4420273Z +                        explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4420453Z +                        title = corrected.get("title", "")
2026-02-20T22:09:14.4420658Z +                        question = corrected.get("question", "")
2026-02-20T22:09:14.4420760Z +
2026-02-20T22:09:14.4420920Z                          # Corriger l'explication
2026-02-20T22:09:14.4421158Z                          if expected_lower not in explanation.lower():
2026-02-20T22:09:14.4421375Z -                            corrected['solution_explanation'] = (
2026-02-20T22:09:14.4421585Z +                            corrected["solution_explanation"] = (
2026-02-20T22:09:14.4422047Z                                  f"En analysant la grille, chaque ligne doit contenir chaque forme une seule fois. "
2026-02-20T22:09:14.4422903Z                                  f"La ligne avec '?' contient déjà les autres formes, donc l'élément manquant est '{expected_answer}'. "
2026-02-20T22:09:14.4423431Z                              )
2026-02-20T22:09:14.4423554Z -                        
2026-02-20T22:09:14.4423670Z +
2026-02-20T22:09:14.4423977Z                          # Corriger le titre si incohérent
2026-02-20T22:09:14.4424523Z                          # Ex: "Où est le carré manquant ?" devrait devenir "Où est le cercle manquant ?"
2026-02-20T22:09:14.4424663Z                          if title:
2026-02-20T22:09:14.4424835Z                              title_lower = title.lower()
2026-02-20T22:09:14.4425213Z                              # Détecter si le titre mentionne une mauvaise forme
2026-02-20T22:09:14.4425740Z -                            shapes = ['triangle', 'cercle', 'carré', 'losange', 'étoile', 'rectangle']
2026-02-20T22:09:14.4425888Z +                            shapes = [
2026-02-20T22:09:14.4426027Z +                                "triangle",
2026-02-20T22:09:14.4426171Z +                                "cercle",
2026-02-20T22:09:14.4426389Z +                                "carré",
2026-02-20T22:09:14.4426524Z +                                "losange",
2026-02-20T22:09:14.4426730Z +                                "étoile",
2026-02-20T22:09:14.4426881Z +                                "rectangle",
2026-02-20T22:09:14.4427003Z +                            ]
2026-02-20T22:09:14.4427160Z                              for shape in shapes:
2026-02-20T22:09:14.4427421Z                                  if shape in title_lower and shape != expected_lower:
2026-02-20T22:09:14.4427857Z                                      # Le titre mentionne une autre forme que la bonne réponse
2026-02-20T22:09:14.4428510Z -                                    new_title = title.replace(shape, expected_answer).replace(shape.capitalize(), expected_answer.capitalize())
2026-02-20T22:09:14.4429075Z -                                    logger.info(f"Correction automatique titre: '{title}' → '{new_title}'")
2026-02-20T22:09:14.4429289Z -                                    corrected['title'] = new_title
2026-02-20T22:09:14.4429478Z +                                    new_title = title.replace(
2026-02-20T22:09:14.4429655Z +                                        shape, expected_answer
2026-02-20T22:09:14.4429810Z +                                    ).replace(
2026-02-20T22:09:14.4430080Z +                                        shape.capitalize(), expected_answer.capitalize()
2026-02-20T22:09:14.4430205Z +                                    )
2026-02-20T22:09:14.4430360Z +                                    logger.info(
2026-02-20T22:09:14.4430837Z +                                        f"Correction automatique titre: '{title}' → '{new_title}'"
2026-02-20T22:09:14.4431162Z +                                    )
2026-02-20T22:09:14.4431362Z +                                    corrected["title"] = new_title
2026-02-20T22:09:14.4431492Z                                      break
2026-02-20T22:09:14.4431866Z -    
2026-02-20T22:09:14.4431972Z +
2026-02-20T22:09:14.4432122Z      # Correction pour SEQUENCE
2026-02-20T22:09:14.4432472Z -    if challenge_type == 'SEQUENCE' and visual_data and 'sequence' in visual_data:
2026-02-20T22:09:14.4432658Z -        sequence = visual_data.get('sequence', [])
2026-02-20T22:09:14.4433185Z +    if challenge_type == "SEQUENCE" and visual_data and "sequence" in visual_data:
2026-02-20T22:09:14.4433378Z +        sequence = visual_data.get("sequence", [])
2026-02-20T22:09:14.4433683Z          if sequence and isinstance(sequence, list) and len(sequence) >= 2:
2026-02-20T22:09:14.4433900Z              expected_answer = analyze_sequence(sequence)
2026-02-20T22:09:14.4434026Z -            
2026-02-20T22:09:14.4434128Z +
2026-02-20T22:09:14.4434265Z              if expected_answer:
2026-02-20T22:09:14.4434519Z -                current_answer = corrected.get('correct_answer', '')
2026-02-20T22:09:14.4434760Z +                current_answer = corrected.get("correct_answer", "")
2026-02-20T22:09:14.4435061Z                  if str(current_answer).strip() != str(expected_answer).strip():
2026-02-20T22:09:14.4435937Z -                    logger.info(f"Correction automatique SEQUENCE: correct_answer changé de '{current_answer}' à '{expected_answer}'")
2026-02-20T22:09:14.4436163Z -                    corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4436277Z -                    
2026-02-20T22:09:14.4436415Z +                    logger.info(
2026-02-20T22:09:14.4437159Z +                        f"Correction automatique SEQUENCE: correct_answer changé de '{current_answer}' à '{expected_answer}'"
2026-02-20T22:09:14.4437281Z +                    )
2026-02-20T22:09:14.4437508Z +                    corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4437623Z +
2026-02-20T22:09:14.4438007Z                      # Mettre à jour l'explication si elle est contradictoire
2026-02-20T22:09:14.4438282Z -                    explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4438561Z +                    explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4438760Z                      if expected_answer not in explanation:
2026-02-20T22:09:14.4438961Z -                        corrected['solution_explanation'] = (
2026-02-20T22:09:14.4439163Z +                        corrected["solution_explanation"] = (
2026-02-20T22:09:14.4439761Z                              f"En analysant la séquence {sequence}, on observe une progression arithmétique. "
2026-02-20T22:09:14.4440221Z                              f"Le prochain élément de la séquence est '{expected_answer}'. "
2026-02-20T22:09:14.4440395Z                              f"{explanation}"
2026-02-20T22:09:14.4440510Z                          )
2026-02-20T22:09:14.4440614Z -    
2026-02-20T22:09:14.4440718Z +
2026-02-20T22:09:14.4440885Z      # Correction pour CODING (labyrinthes)
2026-02-20T22:09:14.4441080Z -    if challenge_type == 'CODING' and visual_data:
2026-02-20T22:09:14.4441483Z -        maze = visual_data.get('maze') or visual_data.get('grid') or visual_data.get('labyrinth')
2026-02-20T22:09:14.4441815Z -        start = visual_data.get('start') or visual_data.get('start_position')
2026-02-20T22:09:14.4442224Z -        end = visual_data.get('end') or visual_data.get('end_position') or visual_data.get('goal')
2026-02-20T22:09:14.4442334Z -        
2026-02-20T22:09:14.4442527Z +    if challenge_type == "CODING" and visual_data:
2026-02-20T22:09:14.4442641Z +        maze = (
2026-02-20T22:09:14.4442779Z +            visual_data.get("maze")
2026-02-20T22:09:14.4442922Z +            or visual_data.get("grid")
2026-02-20T22:09:14.4473324Z +            or visual_data.get("labyrinth")
2026-02-20T22:09:14.4473677Z +        )
2026-02-20T22:09:14.4474159Z +        start = visual_data.get("start") or visual_data.get("start_position")
2026-02-20T22:09:14.4474288Z +        end = (
2026-02-20T22:09:14.4474432Z +            visual_data.get("end")
2026-02-20T22:09:14.4474598Z +            or visual_data.get("end_position")
2026-02-20T22:09:14.4474936Z +            or visual_data.get("goal")
2026-02-20T22:09:14.4475050Z +        )
2026-02-20T22:09:14.4475153Z +
2026-02-20T22:09:14.4475291Z          if maze and start and end:
2026-02-20T22:09:14.4475540Z              # C'est un labyrinthe - valider et corriger le chemin
2026-02-20T22:09:14.4475779Z -            current_answer = corrected.get('correct_answer', '')
2026-02-20T22:09:14.4476008Z +            current_answer = corrected.get("correct_answer", "")
2026-02-20T22:09:14.4476227Z              correct_path = solve_maze_bfs(maze, start, end)
2026-02-20T22:09:14.4476337Z -            
2026-02-20T22:09:14.4476449Z +
2026-02-20T22:09:14.4476577Z              if correct_path:
2026-02-20T22:09:14.4476932Z                  # Vérifier si la réponse actuelle est valide
2026-02-20T22:09:14.4477229Z                  is_valid = validate_maze_path(maze, start, end, current_answer)
2026-02-20T22:09:14.4477342Z -                
2026-02-20T22:09:14.4477453Z +
2026-02-20T22:09:14.4477594Z                  if not is_valid:
2026-02-20T22:09:14.4478308Z -                    logger.info(f"Correction automatique MAZE: chemin invalide '{current_answer}' → '{correct_path}'")
2026-02-20T22:09:14.4478524Z -                    corrected['correct_answer'] = correct_path
2026-02-20T22:09:14.4478714Z -                    corrected['solution_explanation'] = (
2026-02-20T22:09:14.4478842Z +                    logger.info(
2026-02-20T22:09:14.4479455Z +                        f"Correction automatique MAZE: chemin invalide '{current_answer}' → '{correct_path}'"
2026-02-20T22:09:14.4479583Z +                    )
2026-02-20T22:09:14.4479779Z +                    corrected["correct_answer"] = correct_path
2026-02-20T22:09:14.4479975Z +                    corrected["solution_explanation"] = (
2026-02-20T22:09:14.4480353Z                          f"Pour aller du départ {start} à l'arrivée {end}, "
2026-02-20T22:09:14.4480569Z                          f"le chemin optimal est : {correct_path}. "
2026-02-20T22:09:14.4481103Z                          f"Ce chemin évite tous les murs (#) et utilise uniquement les cases libres."
2026-02-20T22:09:14.4481232Z                      )
2026-02-20T22:09:14.4481344Z              else:
2026-02-20T22:09:14.4482010Z -                logger.warning(f"Impossible de trouver un chemin valide dans le labyrinthe de {start} à {end}")
2026-02-20T22:09:14.4482134Z -    
2026-02-20T22:09:14.4482275Z +                logger.warning(
2026-02-20T22:09:14.4482821Z +                    f"Impossible de trouver un chemin valide dans le labyrinthe de {start} à {end}"
2026-02-20T22:09:14.4482935Z +                )
2026-02-20T22:09:14.4483232Z +
2026-02-20T22:09:14.4483359Z      return corrected
2026-02-20T22:09:14.4483462Z  
2026-02-20T22:09:14.4483569Z  
2026-02-20T22:09:14.4484115Z -def validate_riddle_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4484264Z +def validate_riddle_challenge(
2026-02-20T22:09:14.4484557Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4484700Z +) -> List[str]:
2026-02-20T22:09:14.4484805Z      """
2026-02-20T22:09:14.4484959Z      Valide un challenge de type RIDDLE.
2026-02-20T22:09:14.4485373Z      Vérifie la présence de données permettant de résoudre l'énigme.
2026-02-20T22:09:14.4485488Z      """
2026-02-20T22:09:14.4485605Z      errors = []
2026-02-20T22:09:14.4485739Z      if not visual_data:
2026-02-20T22:09:14.4485948Z          errors.append("RIDDLE: visual_data manquant")
2026-02-20T22:09:14.4486068Z          return errors
2026-02-20T22:09:14.4486389Z -    has_clues = bool(visual_data.get('clues') or visual_data.get('indices'))
2026-02-20T22:09:14.4487103Z -    has_context = bool(visual_data.get('context') or visual_data.get('scenario') or visual_data.get('scene'))
2026-02-20T22:09:14.4487445Z -    has_riddle = bool(visual_data.get('riddle') or visual_data.get('question'))
2026-02-20T22:09:14.4487747Z -    has_grid = bool(visual_data.get('grid') or visual_data.get('pattern'))
2026-02-20T22:09:14.4488252Z +    has_clues = bool(visual_data.get("clues") or visual_data.get("indices"))
2026-02-20T22:09:14.4488384Z +    has_context = bool(
2026-02-20T22:09:14.4488525Z +        visual_data.get("context")
2026-02-20T22:09:14.4488672Z +        or visual_data.get("scenario")
2026-02-20T22:09:14.4488810Z +        or visual_data.get("scene")
2026-02-20T22:09:14.4488917Z +    )
2026-02-20T22:09:14.4489237Z +    has_riddle = bool(visual_data.get("riddle") or visual_data.get("question"))
2026-02-20T22:09:14.4489553Z +    has_grid = bool(visual_data.get("grid") or visual_data.get("pattern"))
2026-02-20T22:09:14.4489811Z      if not (has_clues or has_context or has_riddle or has_grid):
2026-02-20T22:09:14.4489937Z          errors.append(
2026-02-20T22:09:14.4490304Z              "RIDDLE: visual_data doit contenir au moins clues, context, riddle ou grid "
2026-02-20T22:09:14.4490592Z              "pour permettre de résoudre l'énigme"
2026-02-20T22:09:14.4490706Z          )
2026-02-20T22:09:14.4490834Z      return errors
2026-02-20T22:09:14.4490943Z  
2026-02-20T22:09:14.4491049Z  
2026-02-20T22:09:14.4491647Z -def validate_probability_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4491813Z +def validate_probability_challenge(
2026-02-20T22:09:14.4492107Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4492227Z +) -> List[str]:
2026-02-20T22:09:14.4492343Z      """
2026-02-20T22:09:14.4492525Z      Valide un challenge de type PROBABILITY.
2026-02-20T22:09:14.4492915Z      Vérifie la présence de données numériques (quantités, totaux).
2026-02-20T22:09:14.4493205Z      """
2026-02-20T22:09:14.4493330Z      errors = []
2026-02-20T22:09:14.4493457Z      if not visual_data:
2026-02-20T22:09:14.4493694Z          errors.append("PROBABILITY: visual_data manquant")
2026-02-20T22:09:14.4493826Z          return errors
2026-02-20T22:09:14.4493948Z      has_counts = False
2026-02-20T22:09:14.4494115Z      for key, val in visual_data.items():
2026-02-20T22:09:14.4494347Z -        if key.lower() in ('total', 'description', 'question'):
2026-02-20T22:09:14.4494579Z +        if key.lower() in ("total", "description", "question"):
2026-02-20T22:09:14.4494694Z              continue
2026-02-20T22:09:14.4494885Z          if isinstance(val, (int, float)) and val > 0:
2026-02-20T22:09:14.4495020Z              has_counts = True
2026-02-20T22:09:14.4495132Z              break
2026-02-20T22:09:14.4495272Z          if isinstance(val, dict):
2026-02-20T22:09:14.4495399Z @@ -992,145 +1158,198 @@
2026-02-20T22:09:14.4495580Z              "(ex: rouge_bonbons: 10, bleu_bonbons: 5)"
2026-02-20T22:09:14.4495700Z          )
2026-02-20T22:09:14.4495813Z      return errors
2026-02-20T22:09:14.4495924Z  
2026-02-20T22:09:14.4496022Z  
2026-02-20T22:09:14.4496570Z -def validate_chess_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4496727Z +def validate_chess_challenge(
2026-02-20T22:09:14.4497023Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4497147Z +) -> List[str]:
2026-02-20T22:09:14.4497463Z      """Valide un challenge de type CHESS (échecs)."""
2026-02-20T22:09:14.4497588Z      errors = []
2026-02-20T22:09:14.4497712Z      if not visual_data:
2026-02-20T22:09:14.4497905Z          errors.append("CHESS: visual_data est vide")
2026-02-20T22:09:14.4498036Z          return errors
2026-02-20T22:09:14.4498141Z  
2026-02-20T22:09:14.4498296Z -    board = visual_data.get('board', [])
2026-02-20T22:09:14.4498446Z +    board = visual_data.get("board", [])
2026-02-20T22:09:14.4498877Z      if not board or not isinstance(board, list):
2026-02-20T22:09:14.4499166Z          errors.append("CHESS: visual_data.board manquant ou invalide")
2026-02-20T22:09:14.4499294Z          return errors
2026-02-20T22:09:14.4499406Z  
2026-02-20T22:09:14.4499532Z      if len(board) != 8:
2026-02-20T22:09:14.4499990Z          errors.append(f"CHESS: board doit avoir 8 rangées, reçu {len(board)}")
2026-02-20T22:09:14.4500452Z -    valid_pieces = {'K', 'k', 'Q', 'q', 'R', 'r', 'B', 'b', 'N', 'n', 'P', 'p', ''}
2026-02-20T22:09:14.4500726Z +    valid_pieces = {"K", "k", "Q", "q", "R", "r", "B", "b", "N", "n", "P", "p", ""}
2026-02-20T22:09:14.4500876Z      for i, row in enumerate(board):
2026-02-20T22:09:14.4501119Z          if not isinstance(row, (list, tuple)) or len(row) != 8:
2026-02-20T22:09:14.4501594Z              errors.append(f"CHESS: board[{i}] doit être une liste de 8 éléments")
2026-02-20T22:09:14.4501709Z              break
2026-02-20T22:09:14.4501854Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4502051Z -            val = str(cell).strip() if cell else ''
2026-02-20T22:09:14.4502216Z +            val = str(cell).strip() if cell else ""
2026-02-20T22:09:14.4502377Z              if val and val not in valid_pieces:
2026-02-20T22:09:14.4502798Z                  errors.append(f"CHESS: pièce invalide '{cell}' en [{i},{j}]")
2026-02-20T22:09:14.4502926Z                  break
2026-02-20T22:09:14.4533257Z  
2026-02-20T22:09:14.4533489Z -    turn = visual_data.get('turn', '').lower()
2026-02-20T22:09:14.4533659Z -    if turn not in ('white', 'black'):
2026-02-20T22:09:14.4533830Z +    turn = visual_data.get("turn", "").lower()
2026-02-20T22:09:14.4533978Z +    if turn not in ("white", "black"):
2026-02-20T22:09:14.4534510Z          errors.append(f"CHESS: turn doit être 'white' ou 'black', reçu '{turn}'")
2026-02-20T22:09:14.4534625Z  
2026-02-20T22:09:14.4534823Z -    objective = visual_data.get('objective', '')
2026-02-20T22:09:14.4535088Z -    valid_obj = ('mat_en_1', 'mat_en_2', 'mat_en_3', 'meilleur_coup')
2026-02-20T22:09:14.4535290Z +    objective = visual_data.get("objective", "")
2026-02-20T22:09:14.4535547Z +    valid_obj = ("mat_en_1", "mat_en_2", "mat_en_3", "meilleur_coup")
2026-02-20T22:09:14.4535692Z      if objective not in valid_obj:
2026-02-20T22:09:14.4536119Z          errors.append(f"CHESS: objective doit être parmi {valid_obj}")
2026-02-20T22:09:14.4536244Z  
2026-02-20T22:09:14.4536495Z      if not correct_answer or not str(correct_answer).strip():
2026-02-20T22:09:14.4537023Z          errors.append("CHESS: correct_answer est vide (notation algébrique attendue)")
2026-02-20T22:09:14.4537132Z  
2026-02-20T22:09:14.4537247Z      return errors
2026-02-20T22:09:14.4537357Z  
2026-02-20T22:09:14.4537462Z  
2026-02-20T22:09:14.4538018Z -def validate_coding_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4538168Z +def validate_coding_challenge(
2026-02-20T22:09:14.4538458Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4538588Z +) -> List[str]:
2026-02-20T22:09:14.4538692Z      """
2026-02-20T22:09:14.4538855Z      Valide un challenge de type CODING.
2026-02-20T22:09:14.4539193Z      REJETTE les défis qui ne sont pas de vraie cryptographie.
2026-02-20T22:09:14.4539288Z      """
2026-02-20T22:09:14.4539393Z      errors = []
2026-02-20T22:09:14.4539491Z -    
2026-02-20T22:09:14.4539578Z +
2026-02-20T22:09:14.4539692Z      if not visual_data:
2026-02-20T22:09:14.4540256Z -        errors.append("CODING: visual_data est vide - un défi de cryptographie doit avoir des données")
2026-02-20T22:09:14.4540374Z -        return errors
2026-02-20T22:09:14.4540471Z -    
2026-02-20T22:09:14.4540585Z +        errors.append(
2026-02-20T22:09:14.4541076Z +            "CODING: visual_data est vide - un défi de cryptographie doit avoir des données"
2026-02-20T22:09:14.4541180Z +        )
2026-02-20T22:09:14.4541290Z +        return errors
2026-02-20T22:09:14.4541393Z +
2026-02-20T22:09:14.4541777Z      # Types valides pour CODING (cryptographie)
2026-02-20T22:09:14.4542135Z -    valid_coding_types = ['caesar', 'substitution', 'binary', 'symbols', 'algorithm', 'maze']
2026-02-20T22:09:14.4542318Z -    coding_type = visual_data.get('type', '').lower()
2026-02-20T22:09:14.4542408Z -    
2026-02-20T22:09:14.4542520Z +    valid_coding_types = [
2026-02-20T22:09:14.4542796Z +        "caesar",
2026-02-20T22:09:14.4542918Z +        "substitution",
2026-02-20T22:09:14.4543210Z +        "binary",
2026-02-20T22:09:14.4543321Z +        "symbols",
2026-02-20T22:09:14.4543446Z +        "algorithm",
2026-02-20T22:09:14.4543549Z +        "maze",
2026-02-20T22:09:14.4543648Z +    ]
2026-02-20T22:09:14.4543838Z +    coding_type = visual_data.get("type", "").lower()
2026-02-20T22:09:14.4543946Z +
2026-02-20T22:09:14.4544312Z      # Détecter si c'est un labyrinthe (même sans "type" explicite)
2026-02-20T22:09:14.4544702Z -    maze = visual_data.get('maze') or visual_data.get('grid') or visual_data.get('labyrinth')
2026-02-20T22:09:14.4545004Z -    start = visual_data.get('start') or visual_data.get('start_position')
2026-02-20T22:09:14.4545343Z -    end = visual_data.get('end') or visual_data.get('end_position') or visual_data.get('goal')
2026-02-20T22:09:14.4545439Z +    maze = (
2026-02-20T22:09:14.4545562Z +        visual_data.get("maze")
2026-02-20T22:09:14.4545691Z +        or visual_data.get("grid")
2026-02-20T22:09:14.4545813Z +        or visual_data.get("labyrinth")
2026-02-20T22:09:14.4545895Z +    )
2026-02-20T22:09:14.4546129Z +    start = visual_data.get("start") or visual_data.get("start_position")
2026-02-20T22:09:14.4546216Z +    end = (
2026-02-20T22:09:14.4546321Z +        visual_data.get("end")
2026-02-20T22:09:14.4546449Z +        or visual_data.get("end_position")
2026-02-20T22:09:14.4546553Z +        or visual_data.get("goal")
2026-02-20T22:09:14.4546635Z +    )
2026-02-20T22:09:14.4546768Z      is_maze = maze and start and end
2026-02-20T22:09:14.4546877Z -    
2026-02-20T22:09:14.4546983Z +
2026-02-20T22:09:14.4547446Z      # Détecter si c'est une SÉQUENCE ou un FAUX LABYRINTHE (INVALIDE pour CODING)
2026-02-20T22:09:14.4547690Z -    has_sequence = visual_data.get('sequence') is not None
2026-02-20T22:09:14.4548079Z -    has_pattern = visual_data.get('pattern') and not visual_data.get('encoded_message')
2026-02-20T22:09:14.4548298Z -    has_shapes = visual_data.get('shapes') is not None
2026-02-20T22:09:14.4548413Z -    
2026-02-20T22:09:14.4548637Z +    has_sequence = visual_data.get("sequence") is not None
2026-02-20T22:09:14.4549015Z +    has_pattern = visual_data.get("pattern") and not visual_data.get("encoded_message")
2026-02-20T22:09:14.4549224Z +    has_shapes = visual_data.get("shapes") is not None
2026-02-20T22:09:14.4549337Z +
2026-02-20T22:09:14.4549833Z      # Détecter les "labyrinthes de nombres" - CE N'EST PAS DE LA CRYPTOGRAPHIE !
2026-02-20T22:09:14.4550054Z -    has_numbers = visual_data.get('numbers') is not None
2026-02-20T22:09:14.4550261Z -    has_target = visual_data.get('target') is not None
2026-02-20T22:09:14.4550836Z -    has_movement_options = visual_data.get('movement_options') is not None or visual_data.get('movement') is not None
2026-02-20T22:09:14.4551056Z +    has_numbers = visual_data.get("numbers") is not None
2026-02-20T22:09:14.4551257Z +    has_target = visual_data.get("target") is not None
2026-02-20T22:09:14.4551404Z +    has_movement_options = (
2026-02-20T22:09:14.4551604Z +        visual_data.get("movement_options") is not None
2026-02-20T22:09:14.4551778Z +        or visual_data.get("movement") is not None
2026-02-20T22:09:14.4551891Z +    )
2026-02-20T22:09:14.4552222Z      is_fake_number_maze = has_numbers and (has_target or has_movement_options)
2026-02-20T22:09:14.4552328Z -    
2026-02-20T22:09:14.4552439Z +
2026-02-20T22:09:14.4552779Z      # Rejeter les séquences, patterns, et faux labyrinthes
2026-02-20T22:09:14.4552905Z      if has_sequence:
2026-02-20T22:09:14.4553715Z -        errors.append("CODING INVALIDE: 'sequence' détectée - utiliser le type SEQUENCE, pas CODING")
2026-02-20T22:09:14.4554060Z -        return errors
2026-02-20T22:09:14.4554206Z -    
2026-02-20T22:09:14.4554349Z +        errors.append(
2026-02-20T22:09:14.4554899Z +            "CODING INVALIDE: 'sequence' détectée - utiliser le type SEQUENCE, pas CODING"
2026-02-20T22:09:14.4555012Z +        )
2026-02-20T22:09:14.4555315Z +        return errors
2026-02-20T22:09:14.4555427Z +
2026-02-20T22:09:14.4555573Z      if has_pattern and not is_maze:
2026-02-20T22:09:14.4556110Z -        errors.append("CODING INVALIDE: 'pattern' sans cryptographie - utiliser le type PATTERN, pas CODING")
2026-02-20T22:09:14.4556237Z -        return errors
2026-02-20T22:09:14.4556348Z -    
2026-02-20T22:09:14.4556472Z +        errors.append(
2026-02-20T22:09:14.4556915Z +            "CODING INVALIDE: 'pattern' sans cryptographie - utiliser le type PATTERN, pas CODING"
2026-02-20T22:09:14.4557035Z +        )
2026-02-20T22:09:14.4557157Z +        return errors
2026-02-20T22:09:14.4557265Z +
2026-02-20T22:09:14.4557406Z      if has_shapes:
2026-02-20T22:09:14.4558018Z -        errors.append("CODING INVALIDE: 'shapes' détectées - utiliser le type VISUAL, pas CODING")
2026-02-20T22:09:14.4558147Z -        return errors
2026-02-20T22:09:14.4558250Z -    
2026-02-20T22:09:14.4558378Z +        errors.append(
2026-02-20T22:09:14.4558867Z +            "CODING INVALIDE: 'shapes' détectées - utiliser le type VISUAL, pas CODING"
2026-02-20T22:09:14.4558993Z +        )
2026-02-20T22:09:14.4559119Z +        return errors
2026-02-20T22:09:14.4559222Z +
2026-02-20T22:09:14.4559354Z      if is_fake_number_maze:
2026-02-20T22:09:14.4559480Z          errors.append(
2026-02-20T22:09:14.4560023Z              "CODING INVALIDE: 'numbers' + 'target' détectés - c'est un labyrinthe de nombres, "
2026-02-20T22:09:14.4560390Z              "pas de la cryptographie ! Utiliser le type SEQUENCE ou PUZZLE, pas CODING."
2026-02-20T22:09:14.4560501Z          )
2026-02-20T22:09:14.4560628Z          return errors
2026-02-20T22:09:14.4560744Z -    
2026-02-20T22:09:14.4560848Z +
2026-02-20T22:09:14.4561339Z      # Rejeter aussi les défis avec uniquement des nombres et pas de message encodé
2026-02-20T22:09:14.4561791Z -    if has_numbers and not visual_data.get('encoded_message') and not visual_data.get('message'):
2026-02-20T22:09:14.4561904Z +    if (
2026-02-20T22:09:14.4562023Z +        has_numbers
2026-02-20T22:09:14.4562229Z +        and not visual_data.get("encoded_message")
2026-02-20T22:09:14.4562387Z +        and not visual_data.get("message")
2026-02-20T22:09:14.4562495Z +    ):
2026-02-20T22:09:14.4562627Z          errors.append(
2026-02-20T22:09:14.4593568Z              "CODING INVALIDE: 'numbers' sans 'encoded_message' - CODING doit avoir un message secret à décoder, "
2026-02-20T22:09:14.4593759Z              "pas une liste de nombres."
2026-02-20T22:09:14.4593869Z          )
2026-02-20T22:09:14.4594008Z          return errors
2026-02-20T22:09:14.4594117Z -    
2026-02-20T22:09:14.4594218Z +
2026-02-20T22:09:14.4594643Z      # Vérifier le type ou la présence d'éléments de cryptographie
2026-02-20T22:09:14.4595083Z -    has_encoded_message = visual_data.get('encoded_message') or visual_data.get('message')
2026-02-20T22:09:14.4595569Z -    has_crypto_key = visual_data.get('key') or visual_data.get('partial_key') or visual_data.get('shift')
2026-02-20T22:09:14.4595956Z -    has_steps = visual_data.get('steps') and isinstance(visual_data.get('steps'), list)
2026-02-20T22:09:14.4596079Z -    
2026-02-20T22:09:14.4596434Z +    has_encoded_message = visual_data.get("encoded_message") or visual_data.get(
2026-02-20T22:09:14.4596550Z +        "message"
2026-02-20T22:09:14.4596665Z +    )
2026-02-20T22:09:14.4596788Z +    has_crypto_key = (
2026-02-20T22:09:14.4596924Z +        visual_data.get("key")
2026-02-20T22:09:14.4597090Z +        or visual_data.get("partial_key")
2026-02-20T22:09:14.4597231Z +        or visual_data.get("shift")
2026-02-20T22:09:14.4597335Z +    )
2026-02-20T22:09:14.4597712Z +    has_steps = visual_data.get("steps") and isinstance(visual_data.get("steps"), list)
2026-02-20T22:09:14.4598098Z +
2026-02-20T22:09:14.4598289Z      is_valid_crypto = (
2026-02-20T22:09:14.4598506Z -        coding_type in valid_coding_types or
2026-02-20T22:09:14.4598667Z -        is_maze or
2026-02-20T22:09:14.4599121Z -        has_encoded_message or
2026-02-20T22:09:14.4643402Z -        (has_crypto_key and has_encoded_message) or
2026-02-20T22:09:14.4643800Z -        has_steps
2026-02-20T22:09:14.4643973Z +        coding_type in valid_coding_types
2026-02-20T22:09:14.4644098Z +        or is_maze
2026-02-20T22:09:14.4644291Z +        or has_encoded_message
2026-02-20T22:09:14.4644486Z +        or (has_crypto_key and has_encoded_message)
2026-02-20T22:09:14.4644609Z +        or has_steps
2026-02-20T22:09:14.4644713Z      )
2026-02-20T22:09:14.4644815Z -    
2026-02-20T22:09:14.4644918Z +
2026-02-20T22:09:14.4645062Z      if not is_valid_crypto:
2026-02-20T22:09:14.4645184Z          errors.append(
2026-02-20T22:09:14.4645566Z              f"CODING INVALIDE: Le visual_data ne contient pas de cryptographie valide. "
2026-02-20T22:09:14.4645939Z              f"Attendu: type={valid_coding_types}, encoded_message, key/shift, ou maze. "
2026-02-20T22:09:14.4646245Z              f"Reçu: {list(visual_data.keys())}"
2026-02-20T22:09:14.4646356Z          )
2026-02-20T22:09:14.4646458Z -    
2026-02-20T22:09:14.4646575Z +
2026-02-20T22:09:14.4646754Z      # Si c'est un labyrinthe, valider le chemin
2026-02-20T22:09:14.4646868Z      if is_maze:
2026-02-20T22:09:14.4647150Z          if not validate_maze_path(maze, start, end, correct_answer):
2026-02-20T22:09:14.4647843Z -            errors.append(f"MAZE: Le chemin '{correct_answer}' ne mène pas du départ {start} à l'arrivée {end}")
2026-02-20T22:09:14.4647981Z +            errors.append(
2026-02-20T22:09:14.4648561Z +                f"MAZE: Le chemin '{correct_answer}' ne mène pas du départ {start} à l'arrivée {end}"
2026-02-20T22:09:14.4648676Z +            )
2026-02-20T22:09:14.4648782Z  
2026-02-20T22:09:14.4649385Z      # Substitution : clé complète OU partial_key avec règle déductible (caesar, atbash, keyword)
2026-02-20T22:09:14.4649645Z      if coding_type == "substitution" and has_encoded_message:
2026-02-20T22:09:14.4650048Z -        msg = (visual_data.get("encoded_message") or visual_data.get("message") or "").upper()
2026-02-20T22:09:14.4650160Z +        msg = (
2026-02-20T22:09:14.4650510Z +            visual_data.get("encoded_message") or visual_data.get("message") or ""
2026-02-20T22:09:14.4650624Z +        ).upper()
2026-02-20T22:09:14.4650959Z          decode_key = visual_data.get("key") or visual_data.get("partial_key") or {}
2026-02-20T22:09:14.4651409Z -        rule_type = (visual_data.get("rule_type") or visual_data.get("deducible_rule") or "").lower()
2026-02-20T22:09:14.4651534Z +        rule_type = (
2026-02-20T22:09:14.4651854Z +            visual_data.get("rule_type") or visual_data.get("deducible_rule") or ""
2026-02-20T22:09:14.4651962Z +        ).lower()
2026-02-20T22:09:14.4652185Z          letters_in_msg = set(c for c in msg if c.isalpha())
2026-02-20T22:09:14.4652430Z          keys_upper = set(k.upper() for k in decode_key.keys())
2026-02-20T22:09:14.4652602Z          missing = letters_in_msg - keys_upper
2026-02-20T22:09:14.4653589Z          # Si règle déductible (César, Atbash, clé-mot), partial_key avec 3+ exemples suffit
2026-02-20T22:09:14.4654022Z -        is_deducible = rule_type in ("caesar", "cesar", "atbash", "reverse", "keyword", "cle-mot")
2026-02-20T22:09:14.4654176Z +        is_deducible = rule_type in (
2026-02-20T22:09:14.4654303Z +            "caesar",
2026-02-20T22:09:14.4654420Z +            "cesar",
2026-02-20T22:09:14.4654531Z +            "atbash",
2026-02-20T22:09:14.4654645Z +            "reverse",
2026-02-20T22:09:14.4654764Z +            "keyword",
2026-02-20T22:09:14.4654880Z +            "cle-mot",
2026-02-20T22:09:14.4654988Z +        )
2026-02-20T22:09:14.4655124Z          if is_deducible:
2026-02-20T22:09:14.4655261Z              if len(decode_key) < 2:
2026-02-20T22:09:14.4655614Z                  errors.append(
2026-02-20T22:09:14.4656309Z                      "SUBSTITUTION: Avec rule_type déductible, fournir au moins 2-3 exemples dans partial_key."
2026-02-20T22:09:14.4656428Z                  )
2026-02-20T22:09:14.4656548Z @@ -1140,139 +1359,151 @@
2026-02-20T22:09:14.4657177Z                  "Fournir une clé complète OU rule_type (caesar/atbash/keyword) avec partial_key déductible."
2026-02-20T22:09:14.4657482Z              )
2026-02-20T22:09:14.4657607Z      return errors
2026-02-20T22:09:14.4657709Z  
2026-02-20T22:09:14.4657819Z  
2026-02-20T22:09:14.4658238Z -def solve_maze_bfs(maze: List[List[str]], start: List[int], end: List[int]) -> Optional[str]:
2026-02-20T22:09:14.4658365Z +def solve_maze_bfs(
2026-02-20T22:09:14.4658595Z +    maze: List[List[str]], start: List[int], end: List[int]
2026-02-20T22:09:14.4658736Z +) -> Optional[str]:
2026-02-20T22:09:14.4658844Z      """
2026-02-20T22:09:14.4659260Z      Résout un labyrinthe avec BFS et retourne le chemin en directions.
2026-02-20T22:09:14.4659390Z -    
2026-02-20T22:09:14.4659495Z +
2026-02-20T22:09:14.4659604Z      Args:
2026-02-20T22:09:14.4659831Z          maze: Grille du labyrinthe (# = mur, espace = chemin)
2026-02-20T22:09:14.4660100Z          start: Position de départ [row, col]
2026-02-20T22:09:14.4660338Z          end: Position d'arrivée [row, col]
2026-02-20T22:09:14.4660455Z -    
2026-02-20T22:09:14.4660567Z +
2026-02-20T22:09:14.4660680Z      Returns:
2026-02-20T22:09:14.4661042Z          Chemin en directions (ex: "BAS, BAS, DROITE, DROITE") ou None si pas de solution
2026-02-20T22:09:14.4661160Z      """
2026-02-20T22:09:14.4661310Z      from collections import deque
2026-02-20T22:09:14.4661418Z -    
2026-02-20T22:09:14.4661524Z +
2026-02-20T22:09:14.4661686Z      if not maze or not start or not end:
2026-02-20T22:09:14.4661807Z          return None
2026-02-20T22:09:14.4661911Z -    
2026-02-20T22:09:14.4662024Z +
2026-02-20T22:09:14.4662149Z      rows = len(maze)
2026-02-20T22:09:14.4662304Z      cols = len(maze[0]) if rows > 0 else 0
2026-02-20T22:09:14.4662408Z -    
2026-02-20T22:09:14.4662516Z +
2026-02-20T22:09:14.4662682Z      start_row, start_col = start[0], start[1]
2026-02-20T22:09:14.4662826Z      end_row, end_col = end[0], end[1]
2026-02-20T22:09:14.4662941Z -    
2026-02-20T22:09:14.4663219Z +
2026-02-20T22:09:14.4663505Z      # Vérifier que start et end sont valides
2026-02-20T22:09:14.4663725Z      if not (0 <= start_row < rows and 0 <= start_col < cols):
2026-02-20T22:09:14.4663860Z          return None
2026-02-20T22:09:14.4664055Z      if not (0 <= end_row < rows and 0 <= end_col < cols):
2026-02-20T22:09:14.4664170Z          return None
2026-02-20T22:09:14.4664279Z -    
2026-02-20T22:09:14.4664380Z +
2026-02-20T22:09:14.4664546Z      # Directions : (delta_row, delta_col, nom)
2026-02-20T22:09:14.4664666Z -    directions = [
2026-02-20T22:09:14.4664801Z -        (-1, 0, "HAUT"),
2026-02-20T22:09:14.4664916Z -        (1, 0, "BAS"),
2026-02-20T22:09:14.4665039Z -        (0, -1, "GAUCHE"),
2026-02-20T22:09:14.4665171Z -        (0, 1, "DROITE")
2026-02-20T22:09:14.4665276Z -    ]
2026-02-20T22:09:14.4665375Z -    
2026-02-20T22:09:14.4665683Z +    directions = [(-1, 0, "HAUT"), (1, 0, "BAS"), (0, -1, "GAUCHE"), (0, 1, "DROITE")]
2026-02-20T22:09:14.4665806Z +
2026-02-20T22:09:14.4665917Z      # BFS
2026-02-20T22:09:14.4666102Z      queue = deque([(start_row, start_col, [])])
2026-02-20T22:09:14.4666264Z      visited = {(start_row, start_col)}
2026-02-20T22:09:14.4666371Z -    
2026-02-20T22:09:14.4666475Z +
2026-02-20T22:09:14.4666590Z      while queue:
2026-02-20T22:09:14.4666756Z          row, col, path = queue.popleft()
2026-02-20T22:09:14.4666860Z -        
2026-02-20T22:09:14.4666960Z +
2026-02-20T22:09:14.4667167Z          # Arrivée atteinte
2026-02-20T22:09:14.4667322Z          if row == end_row and col == end_col:
2026-02-20T22:09:14.4667682Z              return ", ".join(path) if path else "DÉJÀ À L'ARRIVÉE"
2026-02-20T22:09:14.4667792Z -        
2026-02-20T22:09:14.4668106Z +
2026-02-20T22:09:14.4668273Z          for dr, dc, direction in directions:
2026-02-20T22:09:14.4668436Z              new_row, new_col = row + dr, col + dc
2026-02-20T22:09:14.4668550Z -            
2026-02-20T22:09:14.4668653Z +
2026-02-20T22:09:14.4668874Z              # Vérifier les limites
2026-02-20T22:09:14.4669093Z              if not (0 <= new_row < rows and 0 <= new_col < cols):
2026-02-20T22:09:14.4669401Z                  continue
2026-02-20T22:09:14.4669515Z -            
2026-02-20T22:09:14.4669618Z +
2026-02-20T22:09:14.4669862Z              # Vérifier si déjà visité
2026-02-20T22:09:14.4670023Z              if (new_row, new_col) in visited:
2026-02-20T22:09:14.4670142Z                  continue
2026-02-20T22:09:14.4670258Z -            
2026-02-20T22:09:14.4670363Z +
2026-02-20T22:09:14.4670584Z              # Vérifier si c'est un mur
2026-02-20T22:09:14.4670971Z -            cell = maze[new_row][new_col] if isinstance(maze[new_row], list) else maze[new_row]
2026-02-20T22:09:14.4671117Z +            cell = (
2026-02-20T22:09:14.4671254Z +                maze[new_row][new_col]
2026-02-20T22:09:14.4671427Z +                if isinstance(maze[new_row], list)
2026-02-20T22:09:14.4671568Z +                else maze[new_row]
2026-02-20T22:09:14.4671676Z +            )
2026-02-20T22:09:14.4671817Z              if isinstance(cell, list):
2026-02-20T22:09:14.4672056Z -                cell = cell[new_col] if new_col < len(cell) else '#'
2026-02-20T22:09:14.4672174Z -            
2026-02-20T22:09:14.4672404Z -            if cell in ['#', '█', '1']:
2026-02-20T22:09:14.4672622Z +                cell = cell[new_col] if new_col < len(cell) else "#"
2026-02-20T22:09:14.4672738Z +
2026-02-20T22:09:14.4672946Z +            if cell in ["#", "█", "1"]:
2026-02-20T22:09:14.4703337Z                  continue
2026-02-20T22:09:14.4703479Z -            
2026-02-20T22:09:14.4703587Z +
2026-02-20T22:09:14.4703841Z              # Ajouter à la file
2026-02-20T22:09:14.4704010Z              visited.add((new_row, new_col))
2026-02-20T22:09:14.4704289Z              queue.append((new_row, new_col, path + [direction]))
2026-02-20T22:09:14.4704402Z -    
2026-02-20T22:09:14.4704513Z +
2026-02-20T22:09:14.4704730Z      return None  # Pas de chemin trouvé
2026-02-20T22:09:14.4704839Z  
2026-02-20T22:09:14.4704944Z  
2026-02-20T22:09:14.4705441Z -def validate_maze_path(maze: List[List[str]], start: List[int], end: List[int], path_str: str) -> bool:
2026-02-20T22:09:14.4705611Z +def validate_maze_path(
2026-02-20T22:09:14.4705911Z +    maze: List[List[str]], start: List[int], end: List[int], path_str: str
2026-02-20T22:09:14.4706029Z +) -> bool:
2026-02-20T22:09:14.4706146Z      """
2026-02-20T22:09:14.4706476Z      Vérifie si un chemin est valide dans un labyrinthe.
2026-02-20T22:09:14.4706586Z -    
2026-02-20T22:09:14.4706689Z +
2026-02-20T22:09:14.4706809Z      Args:
2026-02-20T22:09:14.4706951Z          maze: Grille du labyrinthe
2026-02-20T22:09:14.4707208Z          start: Position de départ [row, col]
2026-02-20T22:09:14.4707468Z          end: Position d'arrivée [row, col]
2026-02-20T22:09:14.4707702Z          path_str: Chemin en texte (ex: "BAS, DROITE, DROITE")
2026-02-20T22:09:14.4707813Z -    
2026-02-20T22:09:14.4707916Z +
2026-02-20T22:09:14.4708044Z      Returns:
2026-02-20T22:09:14.4708353Z          True si le chemin est valide et mène à l'arrivée
2026-02-20T22:09:14.4708478Z      """
2026-02-20T22:09:14.4708697Z      if not maze or not start or not end or not path_str:
2026-02-20T22:09:14.4708820Z          return False
2026-02-20T22:09:14.4708925Z -    
2026-02-20T22:09:14.4709030Z +
2026-02-20T22:09:14.4709160Z      rows = len(maze)
2026-02-20T22:09:14.4709306Z      cols = len(maze[0]) if rows > 0 else 0
2026-02-20T22:09:14.4709411Z -    
2026-02-20T22:09:14.4709529Z +
2026-02-20T22:09:14.4709656Z      # Parser le chemin
2026-02-20T22:09:14.4709786Z      directions_map = {
2026-02-20T22:09:14.4709957Z -        'haut': (-1, 0), 'up': (-1, 0), 'h': (-1, 0),
2026-02-20T22:09:14.4710123Z -        'bas': (1, 0), 'down': (1, 0), 'b': (1, 0),
2026-02-20T22:09:14.4710557Z -        'gauche': (0, -1), 'left': (0, -1), 'g': (0, -1),
2026-02-20T22:09:14.4710740Z -        'droite': (0, 1), 'right': (0, 1), 'd': (0, 1)
2026-02-20T22:09:14.4710871Z +        "haut": (-1, 0),
2026-02-20T22:09:14.4710986Z +        "up": (-1, 0),
2026-02-20T22:09:14.4711099Z +        "h": (-1, 0),
2026-02-20T22:09:14.4711397Z +        "bas": (1, 0),
2026-02-20T22:09:14.4711526Z +        "down": (1, 0),
2026-02-20T22:09:14.4711634Z +        "b": (1, 0),
2026-02-20T22:09:14.4711760Z +        "gauche": (0, -1),
2026-02-20T22:09:14.4711894Z +        "left": (0, -1),
2026-02-20T22:09:14.4712011Z +        "g": (0, -1),
2026-02-20T22:09:14.4712138Z +        "droite": (0, 1),
2026-02-20T22:09:14.4712261Z +        "right": (0, 1),
2026-02-20T22:09:14.4712371Z +        "d": (0, 1),
2026-02-20T22:09:14.4712474Z      }
2026-02-20T22:09:14.4712579Z -    
2026-02-20T22:09:14.4712689Z +
2026-02-20T22:09:14.4712846Z      # Extraire les directions du chemin
2026-02-20T22:09:14.4713455Z -    path_parts = [p.strip().lower() for p in path_str.replace(',', ' ').split() if p.strip()]
2026-02-20T22:09:14.4713576Z -    
2026-02-20T22:09:14.4713703Z +    path_parts = [
2026-02-20T22:09:14.4714028Z +        p.strip().lower() for p in path_str.replace(",", " ").split() if p.strip()
2026-02-20T22:09:14.4714137Z +    ]
2026-02-20T22:09:14.4714257Z +
2026-02-20T22:09:14.4714396Z      row, col = start[0], start[1]
2026-02-20T22:09:14.4714499Z -    
2026-02-20T22:09:14.4714608Z +
2026-02-20T22:09:14.4714748Z      for direction in path_parts:
2026-02-20T22:09:14.4714903Z          if direction not in directions_map:
2026-02-20T22:09:14.4715015Z              continue
2026-02-20T22:09:14.4715124Z -        
2026-02-20T22:09:14.4715223Z +
2026-02-20T22:09:14.4715378Z          dr, dc = directions_map[direction]
2026-02-20T22:09:14.4715544Z          new_row, new_col = row + dr, col + dc
2026-02-20T22:09:14.4715654Z -        
2026-02-20T22:09:14.4715758Z +
2026-02-20T22:09:14.4715989Z          # Vérifier les limites
2026-02-20T22:09:14.4716218Z          if not (0 <= new_row < rows and 0 <= new_col < cols):
2026-02-20T22:09:14.4716344Z              return False
2026-02-20T22:09:14.4716454Z -        
2026-02-20T22:09:14.4716596Z +
2026-02-20T22:09:14.4716807Z          # Vérifier si c'est un mur
2026-02-20T22:09:14.4716938Z          cell = maze[new_row]
2026-02-20T22:09:14.4717089Z          if isinstance(cell, list):
2026-02-20T22:09:14.4717327Z -            cell = cell[new_col] if new_col < len(cell) else '#'
2026-02-20T22:09:14.4717544Z +            cell = cell[new_col] if new_col < len(cell) else "#"
2026-02-20T22:09:14.4717766Z          elif isinstance(cell, str) and new_col < len(cell):
2026-02-20T22:09:14.4717901Z              cell = cell[new_col]
2026-02-20T22:09:14.4718017Z          else:
2026-02-20T22:09:14.4718138Z -            cell = '#'
2026-02-20T22:09:14.4718250Z -        
2026-02-20T22:09:14.4718465Z -        if cell in ['#', '█', '1']:
2026-02-20T22:09:14.4718584Z +            cell = "#"
2026-02-20T22:09:14.4718697Z +
2026-02-20T22:09:14.4718904Z +        if cell in ["#", "█", "1"]:
2026-02-20T22:09:14.4719023Z              return False
2026-02-20T22:09:14.4719129Z -        
2026-02-20T22:09:14.4719236Z +
2026-02-20T22:09:14.4719371Z          row, col = new_row, new_col
2026-02-20T22:09:14.4719474Z -    
2026-02-20T22:09:14.4719579Z +
2026-02-20T22:09:14.4719859Z      # Vérifier si on est arrivé à destination
2026-02-20T22:09:14.4720009Z      return row == end[0] and col == end[1]
2026-02-20T22:09:14.4720112Z -
2026-02-20T22:09:14.4720584Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py
2026-02-20T22:09:14.7869383Z --- /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:14.7872903Z +++ /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py	2026-02-20 22:09:14.783951+00:00
2026-02-20T22:09:14.7876123Z @@ -1,8 +1,9 @@
2026-02-20T22:09:14.7878575Z  """
2026-02-20T22:09:14.7881554Z  Handlers pour la gestion des badges et achievements (API)
2026-02-20T22:09:14.7883539Z  """
2026-02-20T22:09:14.7887738Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py
2026-02-20T22:09:14.7888485Z +
2026-02-20T22:09:14.7891956Z  import json
2026-02-20T22:09:14.7893822Z  import traceback
2026-02-20T22:09:14.7897795Z  
2026-02-20T22:09:14.7899829Z  from starlette.requests import Request
2026-02-20T22:09:14.7900388Z  from starlette.responses import JSONResponse
2026-02-20T22:09:14.7900849Z @@ -29,13 +30,18 @@
2026-02-20T22:09:14.7901197Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7901748Z              user_badges_data = badge_service.get_user_badges(user_id)
2026-02-20T22:09:14.7902453Z              return JSONResponse({"success": True, "data": user_badges_data})
2026-02-20T22:09:14.7903179Z  
2026-02-20T22:09:14.7903492Z      except Exception as user_badges_error:
2026-02-20T22:09:14.7904591Z -        logger.error(f"Erreur lors de la récupération des badges utilisateur: {user_badges_error}")
2026-02-20T22:09:14.7905376Z -        traceback.print_exc()
2026-02-20T22:09:14.7906068Z -        return JSONResponse({"error": get_safe_error_message(user_badges_error)}, status_code=500)
2026-02-20T22:09:14.7906857Z +        logger.error(
2026-02-20T22:09:14.7907562Z +            f"Erreur lors de la récupération des badges utilisateur: {user_badges_error}"
2026-02-20T22:09:14.7908204Z +        )
2026-02-20T22:09:14.7908493Z +        traceback.print_exc()
2026-02-20T22:09:14.7908867Z +        return JSONResponse(
2026-02-20T22:09:14.7909408Z +            {"error": get_safe_error_message(user_badges_error)}, status_code=500
2026-02-20T22:09:14.7909980Z +        )
2026-02-20T22:09:14.7910240Z +
2026-02-20T22:09:14.7910480Z  
2026-02-20T22:09:14.7910802Z  async def get_available_badges(request: Request):
2026-02-20T22:09:14.7911515Z      """Récupérer tous les badges disponibles avec traductions"""
2026-02-20T22:09:14.7912022Z      try:
2026-02-20T22:09:14.7912486Z          accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:14.7913198Z @@ -43,19 +49,21 @@
2026-02-20T22:09:14.7913495Z  
2026-02-20T22:09:14.7913771Z          async with db_session() as db:
2026-02-20T22:09:14.7914216Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7914766Z              available_badges = badge_service.get_available_badges()
2026-02-20T22:09:14.7915291Z  
2026-02-20T22:09:14.7915566Z -        return JSONResponse({
2026-02-20T22:09:14.7915936Z -            "success": True,
2026-02-20T22:09:14.7916318Z -            "data": available_badges
2026-02-20T22:09:14.7916692Z -        })
2026-02-20T22:09:14.7917145Z +        return JSONResponse({"success": True, "data": available_badges})
2026-02-20T22:09:14.7917702Z  
2026-02-20T22:09:14.7918022Z      except Exception as available_badges_error:
2026-02-20T22:09:14.7918960Z -        logger.error(f"Erreur lors de la récupération des badges disponibles: {available_badges_error}")
2026-02-20T22:09:14.7919730Z +        logger.error(
2026-02-20T22:09:14.7920444Z +            f"Erreur lors de la récupération des badges disponibles: {available_badges_error}"
2026-02-20T22:09:14.7921097Z +        )
2026-02-20T22:09:14.7921412Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:14.7922176Z -        return JSONResponse({"error": get_safe_error_message(available_badges_error)}, status_code=500)
2026-02-20T22:09:14.7923112Z +        return JSONResponse(
2026-02-20T22:09:14.7923680Z +            {"error": get_safe_error_message(available_badges_error)}, status_code=500
2026-02-20T22:09:14.7924300Z +        )
2026-02-20T22:09:14.7924558Z +
2026-02-20T22:09:14.7924792Z  
2026-02-20T22:09:14.7925041Z  @require_auth
2026-02-20T22:09:14.7925358Z  async def check_user_badges(request):
2026-02-20T22:09:14.7926148Z      """Forcer la vérification des badges pour un utilisateur (utile pour les tests)"""
2026-02-20T22:09:14.7926786Z      try:
2026-02-20T22:09:14.7927051Z @@ -63,21 +71,32 @@
2026-02-20T22:09:14.7927649Z          user_id = current_user.get("id")
2026-02-20T22:09:14.7928049Z  
2026-02-20T22:09:14.7928318Z          async with db_session() as db:
2026-02-20T22:09:14.7928761Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7929360Z              new_badges = badge_service.check_and_award_badges(user_id)
2026-02-20T22:09:14.7929933Z -            return JSONResponse({
2026-02-20T22:09:14.7930510Z -                "success": True,
2026-02-20T22:09:14.7930911Z -                "new_badges": new_badges,
2026-02-20T22:09:14.7931357Z -                "badges_earned": len(new_badges),
2026-02-20T22:09:14.7932154Z -                "message": f"{len(new_badges)} nouveaux badges obtenus" if new_badges else "Aucun nouveau badge",
2026-02-20T22:09:14.7932903Z -            })
2026-02-20T22:09:14.7933387Z +            return JSONResponse(
2026-02-20T22:09:14.7933740Z +                {
2026-02-20T22:09:14.7934044Z +                    "success": True,
2026-02-20T22:09:14.7934462Z +                    "new_badges": new_badges,
2026-02-20T22:09:14.7934934Z +                    "badges_earned": len(new_badges),
2026-02-20T22:09:14.7935382Z +                    "message": (
2026-02-20T22:09:14.7935843Z +                        f"{len(new_badges)} nouveaux badges obtenus"
2026-02-20T22:09:14.7936353Z +                        if new_badges
2026-02-20T22:09:14.7936793Z +                        else "Aucun nouveau badge"
2026-02-20T22:09:14.7937217Z +                    ),
2026-02-20T22:09:14.7937527Z +                }
2026-02-20T22:09:14.7937799Z +            )
2026-02-20T22:09:14.7938065Z  
2026-02-20T22:09:14.7938386Z      except Exception as badge_verification_error:
2026-02-20T22:09:14.7939359Z -        logger.error(f"Erreur lors de la vérification forcée des badges: {badge_verification_error}")
2026-02-20T22:09:14.7940134Z -        traceback.print_exc()
2026-02-20T22:09:14.7940876Z -        return JSONResponse({"error": get_safe_error_message(badge_verification_error)}, status_code=500)
2026-02-20T22:09:14.7941659Z +        logger.error(
2026-02-20T22:09:14.7942359Z +            f"Erreur lors de la vérification forcée des badges: {badge_verification_error}"
2026-02-20T22:09:14.7943197Z +        )
2026-02-20T22:09:14.7943497Z +        traceback.print_exc()
2026-02-20T22:09:14.7943884Z +        return JSONResponse(
2026-02-20T22:09:14.7944468Z +            {"error": get_safe_error_message(badge_verification_error)}, status_code=500
2026-02-20T22:09:14.7945108Z +        )
2026-02-20T22:09:14.7945355Z +
2026-02-20T22:09:14.7945595Z  
2026-02-20T22:09:14.7945845Z  @require_auth
2026-02-20T22:09:14.7946196Z  async def get_user_gamification_stats(request):
2026-02-20T22:09:14.7946949Z      """Récupérer les statistiques de gamification d'un utilisateur"""
2026-02-20T22:09:14.7947497Z      try:
2026-02-20T22:09:14.7947761Z @@ -88,56 +107,70 @@
2026-02-20T22:09:14.7948089Z              from sqlalchemy import text
2026-02-20T22:09:14.7948491Z  
2026-02-20T22:09:14.7948777Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7949314Z              user_data = badge_service.get_user_badges(user_id)
2026-02-20T22:09:14.7949786Z  
2026-02-20T22:09:14.7950068Z -            stats = db.execute(text("""
2026-02-20T22:09:14.7950487Z +            stats = db.execute(
2026-02-20T22:09:14.7950845Z +                text("""
2026-02-20T22:09:14.7951176Z                  SELECT
2026-02-20T22:09:14.7951534Z                      COUNT(*) as total_attempts,
2026-02-20T22:09:14.7952111Z                      COUNT(CASE WHEN is_correct THEN 1 END) as correct_attempts,
2026-02-20T22:09:14.7952721Z                      AVG(time_spent) as avg_time_spent
2026-02-20T22:09:14.7953332Z                  FROM attempts
2026-02-20T22:09:14.7953709Z                  WHERE user_id = :user_id
2026-02-20T22:09:14.7954158Z -            """), {"user_id": user_id}).fetchone()
2026-02-20T22:09:14.7954584Z -
2026-02-20T22:09:14.7954877Z -            badge_stats = db.execute(text("""
2026-02-20T22:09:14.7955296Z +            """),
2026-02-20T22:09:14.7955880Z +                {"user_id": user_id},
2026-02-20T22:09:14.7956275Z +            ).fetchone()
2026-02-20T22:09:14.7956584Z +
2026-02-20T22:09:14.7956856Z +            badge_stats = db.execute(
2026-02-20T22:09:14.7957242Z +                text("""
2026-02-20T22:09:14.7957623Z                  SELECT a.category, COUNT(*) as count
2026-02-20T22:09:14.7958246Z                  FROM achievements a
2026-02-20T22:09:14.7958746Z                  JOIN user_achievements ua ON a.id = ua.achievement_id
2026-02-20T22:09:14.7959308Z                  WHERE ua.user_id = :user_id
2026-02-20T22:09:14.7959724Z                  GROUP BY a.category
2026-02-20T22:09:14.7960149Z -            """), {"user_id": user_id}).fetchall()
2026-02-20T22:09:14.7960565Z +            """),
2026-02-20T22:09:14.7960877Z +                {"user_id": user_id},
2026-02-20T22:09:14.7961256Z +            ).fetchall()
2026-02-20T22:09:14.7961567Z  
2026-02-20T22:09:14.7961825Z              response_data = {
2026-02-20T22:09:14.7962273Z                  "user_stats": user_data.get("user_stats", {}),
2026-02-20T22:09:14.7962775Z                  "badges_summary": {
2026-02-20T22:09:14.7963447Z                      "total_badges": len(user_data.get("earned_badges", [])),
2026-02-20T22:09:14.7964108Z                      "by_category": {row[0]: row[1] for row in badge_stats},
2026-02-20T22:09:14.7964620Z                  },
2026-02-20T22:09:14.7964926Z                  "performance": {
2026-02-20T22:09:14.7965374Z                      "total_attempts": stats[0] if stats else 0,
2026-02-20T22:09:14.7965943Z                      "correct_attempts": stats[1] if stats else 0,
2026-02-20T22:09:14.7966707Z -                    "success_rate": round((stats[1] / stats[0] * 100) if stats and stats[0] > 0 else 0, 1),
2026-02-20T22:09:14.7967411Z +                    "success_rate": round(
2026-02-20T22:09:14.7967958Z +                        (stats[1] / stats[0] * 100) if stats and stats[0] > 0 else 0, 1
2026-02-20T22:09:14.7968507Z +                    ),
2026-02-20T22:09:14.7969003Z                      "avg_time_spent": round(stats[2], 2) if stats and stats[2] else 0,
2026-02-20T22:09:14.7969576Z                  },
2026-02-20T22:09:14.7969863Z              }
2026-02-20T22:09:14.7970310Z              return JSONResponse({"success": True, "data": response_data})
2026-02-20T22:09:14.7970859Z  
2026-02-20T22:09:14.7971203Z      except Exception as gamification_stats_error:
2026-02-20T22:09:14.7972277Z -        logger.error(f"Erreur lors de la récupération des statistiques de gamification: {gamification_stats_error}")
2026-02-20T22:09:14.7973298Z -        traceback.print_exc()
2026-02-20T22:09:14.7974019Z -        return JSONResponse({"error": get_safe_error_message(gamification_stats_error)}, status_code=500)
2026-02-20T22:09:14.7974789Z +        logger.error(
2026-02-20T22:09:14.7975606Z +            f"Erreur lors de la récupération des statistiques de gamification: {gamification_stats_error}"
2026-02-20T22:09:14.7976332Z +        )
2026-02-20T22:09:14.7976621Z +        traceback.print_exc()
2026-02-20T22:09:14.7977005Z +        return JSONResponse(
2026-02-20T22:09:14.7977590Z +            {"error": get_safe_error_message(gamification_stats_error)}, status_code=500
2026-02-20T22:09:14.7978221Z +        )
2026-02-20T22:09:14.7978479Z  
2026-02-20T22:09:14.7978711Z  
2026-02-20T22:09:14.7978960Z  @require_auth
2026-02-20T22:09:14.7979333Z  async def patch_pinned_badges(request: Request):
2026-02-20T22:09:14.7980054Z      """A-4 : Épingler 1-3 badges. Body: { "badge_ids": [1, 2, 3] }"""
2026-02-20T22:09:14.7980557Z      try:
2026-02-20T22:09:14.7980829Z          body = await request.json()
2026-02-20T22:09:14.7981252Z          badge_ids = body.get("badge_ids", [])
2026-02-20T22:09:14.7981719Z          if not isinstance(badge_ids, list):
2026-02-20T22:09:14.7982567Z -            return JSONResponse({"error": "badge_ids doit être une liste"}, status_code=400)
2026-02-20T22:09:14.7983517Z +            return JSONResponse(
2026-02-20T22:09:14.7984232Z +                {"error": "badge_ids doit être une liste"}, status_code=400
2026-02-20T22:09:14.7985072Z +            )
2026-02-20T22:09:14.7985570Z          badge_ids = [int(x) for x in badge_ids if isinstance(x, (int, float))]
2026-02-20T22:09:14.7986224Z          current_user = request.state.user
2026-02-20T22:09:14.7986687Z          user_id = current_user.get("id")
2026-02-20T22:09:14.7987372Z          if not user_id:
2026-02-20T22:09:14.7988080Z              return JSONResponse({"error": "Non authentifié"}, status_code=401)
2026-02-20T22:09:14.7988725Z @@ -185,8 +218,10 @@
2026-02-20T22:09:14.7989091Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7989653Z              data = badge_service.get_badges_progress(user_id)
2026-02-20T22:09:14.7990169Z  
2026-02-20T22:09:14.7990546Z          return JSONResponse({"success": True, "data": data})
2026-02-20T22:09:14.7991090Z      except Exception as e:
2026-02-20T22:09:14.7991890Z -        logger.error(f"Erreur lors de la récupération de la progression des badges: {e}")
2026-02-20T22:09:14.7992648Z -        traceback.print_exc()
2026-02-20T22:09:14.7993457Z -        return JSONResponse({"error": get_safe_error_message(e)}, status_code=500) 
2026-02-20T22:09:14.7994155Z \ No newline at end of file
2026-02-20T22:09:14.7994527Z +        logger.error(
2026-02-20T22:09:14.7995218Z +            f"Erreur lors de la récupération de la progression des badges: {e}"
2026-02-20T22:09:14.7995840Z +        )
2026-02-20T22:09:14.7996140Z +        traceback.print_exc()
2026-02-20T22:09:14.7996747Z +        return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:15.2685508Z --- /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:15.2695970Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py
2026-02-20T22:09:15.2697125Z +++ /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py	2026-02-20 22:09:15.258100+00:00
2026-02-20T22:09:15.2698120Z @@ -1,8 +1,9 @@
2026-02-20T22:09:15.2698422Z  """
2026-02-20T22:09:15.2699093Z  Handlers pour l'authentification et la vérification d'email
2026-02-20T22:09:15.2699610Z  """
2026-02-20T22:09:15.2699856Z +
2026-02-20T22:09:15.2700116Z  import os
2026-02-20T22:09:15.2700395Z  import secrets
2026-02-20T22:09:15.2700703Z  import traceback
2026-02-20T22:09:15.2701125Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:15.2701601Z  
2026-02-20T22:09:15.2701861Z @@ -11,12 +12,16 @@
2026-02-20T22:09:15.2702183Z  logger = get_logger(__name__)
2026-02-20T22:09:15.2702601Z  from starlette.requests import Request
2026-02-20T22:09:15.2703402Z  from starlette.responses import JSONResponse, RedirectResponse
2026-02-20T22:09:15.2703988Z  
2026-02-20T22:09:15.2704311Z  from app.core.security import decode_token
2026-02-20T22:09:15.2705013Z -from app.services.auth_service import (authenticate_user, create_user_token,
2026-02-20T22:09:15.2705800Z -                                       get_user_by_email, refresh_access_token)
2026-02-20T22:09:15.2706416Z +from app.services.auth_service import (
2026-02-20T22:09:15.2706879Z +    authenticate_user,
2026-02-20T22:09:15.2707234Z +    create_user_token,
2026-02-20T22:09:15.2707581Z +    get_user_by_email,
2026-02-20T22:09:15.2707920Z +    refresh_access_token,
2026-02-20T22:09:15.2708266Z +)
2026-02-20T22:09:15.2708804Z  from app.utils.rate_limit import rate_limit_auth, rate_limit_resend_verification
2026-02-20T22:09:15.2709574Z  from app.utils.csrf import validate_csrf_token
2026-02-20T22:09:15.2710104Z  from server.auth import require_auth
2026-02-20T22:09:15.2710621Z  from app.services.email_service import EmailService
2026-02-20T22:09:15.2711186Z  from app.utils.db_utils import db_session
2026-02-20T22:09:15.2711621Z @@ -34,20 +39,19 @@
2026-02-20T22:09:15.2712171Z      Récupère un token CSRF (pattern double-submit).
2026-02-20T22:09:15.2712698Z      Route: GET /api/auth/csrf
2026-02-20T22:09:15.2713519Z      Retourne le token et le pose en cookie. Le client doit l'envoyer dans X-CSRF-Token.
2026-02-20T22:09:15.2714662Z      """
2026-02-20T22:09:15.2714953Z      import secrets
2026-02-20T22:09:15.2715263Z +
2026-02-20T22:09:15.2715554Z      token = secrets.token_urlsafe(32)
2026-02-20T22:09:15.2716060Z      response = JSONResponse({"csrf_token": token})
2026-02-20T22:09:15.2716542Z      is_production = (
2026-02-20T22:09:15.2717196Z          os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.2717713Z          or os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.2718159Z      )
2026-02-20T22:09:15.2718438Z      cookie_opts = (
2026-02-20T22:09:15.2718800Z -        "Path=/; SameSite=None; Secure"
2026-02-20T22:09:15.2719241Z -        if is_production
2026-02-20T22:09:15.2719621Z -        else "Path=/; SameSite=Lax"
2026-02-20T22:09:15.2720254Z +        "Path=/; SameSite=None; Secure" if is_production else "Path=/; SameSite=Lax"
2026-02-20T22:09:15.2720900Z      )
2026-02-20T22:09:15.2721190Z      response.set_cookie(
2026-02-20T22:09:15.2721544Z          "csrf_token",
2026-02-20T22:09:15.2721874Z          token,
2026-02-20T22:09:15.2722159Z          path="/",
2026-02-20T22:09:15.2722457Z @@ -64,74 +68,82 @@
2026-02-20T22:09:15.2723188Z      Vérifie l'adresse email d'un utilisateur avec un token.
2026-02-20T22:09:15.2723811Z      Route: GET /api/auth/verify-email?token=...
2026-02-20T22:09:15.2724275Z      """
2026-02-20T22:09:15.2724541Z      try:
2026-02-20T22:09:15.2725007Z          # Récupérer le token depuis les query params
2026-02-20T22:09:15.2725543Z -        token = request.query_params.get('token')
2026-02-20T22:09:15.2726011Z -        
2026-02-20T22:09:15.2726335Z +        token = request.query_params.get("token")
2026-02-20T22:09:15.2726786Z +
2026-02-20T22:09:15.2727043Z          if not token:
2026-02-20T22:09:15.2727389Z              return JSONResponse(
2026-02-20T22:09:15.2727973Z -                {"error": "Token de vérification manquant"},
2026-02-20T22:09:15.2728493Z -                status_code=400
2026-02-20T22:09:15.2729163Z +                {"error": "Token de vérification manquant"}, status_code=400
2026-02-20T22:09:15.2729737Z              )
2026-02-20T22:09:15.2730021Z  
2026-02-20T22:09:15.2730343Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2730799Z  
2026-02-20T22:09:15.2731087Z          async with db_session() as db:
2026-02-20T22:09:15.2731550Z              from app.models.user import User
2026-02-20T22:09:15.2732046Z -            user = db.query(User).filter(
2026-02-20T22:09:15.2732547Z -                User.email_verification_token == token
2026-02-20T22:09:15.2733195Z -            ).first()
2026-02-20T22:09:15.2733510Z +
2026-02-20T22:09:15.2734021Z +            user = db.query(User).filter(User.email_verification_token == token).first()
2026-02-20T22:09:15.2734667Z  
2026-02-20T22:09:15.2734938Z              if not user:
2026-02-20T22:09:15.2735298Z                  return JSONResponse(
2026-02-20T22:09:15.2735928Z -                    {"error": "Token de vérification invalide"},
2026-02-20T22:09:15.2736458Z -                    status_code=400
2026-02-20T22:09:15.2737143Z +                    {"error": "Token de vérification invalide"}, status_code=400
2026-02-20T22:09:15.2737720Z                  )
2026-02-20T22:09:15.2738002Z  
2026-02-20T22:09:15.2738460Z              if is_verification_token_expired(user.email_verification_sent_at):
2026-02-20T22:09:15.2739100Z                  return JSONResponse(
2026-02-20T22:09:15.2739968Z -                    {"error": "Le token de vérification a expiré. Veuillez demander un nouveau lien."},
2026-02-20T22:09:15.2740695Z -                    status_code=400
2026-02-20T22:09:15.2741082Z +                    {
2026-02-20T22:09:15.2741830Z +                        "error": "Le token de vérification a expiré. Veuillez demander un nouveau lien."
2026-02-20T22:09:15.2742536Z +                    },
2026-02-20T22:09:15.2742877Z +                    status_code=400,
2026-02-20T22:09:15.2743440Z                  )
2026-02-20T22:09:15.2743730Z  
2026-02-20T22:09:15.2744252Z              if user.is_email_verified:
2026-02-20T22:09:15.2744711Z -                return JSONResponse({
2026-02-20T22:09:15.2745394Z -                    "message": "Votre adresse email est déjà vérifiée",
2026-02-20T22:09:15.2745960Z +                return JSONResponse(
2026-02-20T22:09:15.2746353Z +                    {
2026-02-20T22:09:15.2747130Z +                        "message": "Votre adresse email est déjà vérifiée",
2026-02-20T22:09:15.2747702Z +                        "success": True,
2026-02-20T22:09:15.2748109Z +                        "user": {
2026-02-20T22:09:15.2748507Z +                            "id": user.id,
2026-02-20T22:09:15.2748960Z +                            "username": user.username,
2026-02-20T22:09:15.2749450Z +                            "email": user.email,
2026-02-20T22:09:15.2749927Z +                            "is_email_verified": True,
2026-02-20T22:09:15.2750385Z +                        },
2026-02-20T22:09:15.2750726Z +                    },
2026-02-20T22:09:15.2751084Z +                    status_code=200,
2026-02-20T22:09:15.2751472Z +                )
2026-02-20T22:09:15.2751758Z +
2026-02-20T22:09:15.2752053Z +            user.is_email_verified = True
2026-02-20T22:09:15.2752562Z +            user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2753247Z +            db.commit()
2026-02-20T22:09:15.2753616Z +            db.refresh(user)
2026-02-20T22:09:15.2753967Z +
2026-02-20T22:09:15.2754234Z +            logger.info(
2026-02-20T22:09:15.2754928Z +                f"Email vérifié pour l'utilisateur {user.username} ({user.email})"
2026-02-20T22:09:15.2755535Z +            )
2026-02-20T22:09:15.2755804Z +
2026-02-20T22:09:15.2756082Z +            return JSONResponse(
2026-02-20T22:09:15.2756448Z +                {
2026-02-20T22:09:15.2757061Z +                    "message": "Votre adresse email a été vérifiée avec succès !",
2026-02-20T22:09:15.2757684Z                      "success": True,
2026-02-20T22:09:15.2758089Z                      "user": {
2026-02-20T22:09:15.2758470Z                          "id": user.id,
2026-02-20T22:09:15.2758920Z                          "username": user.username,
2026-02-20T22:09:15.2759400Z                          "email": user.email,
2026-02-20T22:09:15.2759861Z -                        "is_email_verified": True
2026-02-20T22:09:15.2760306Z -                    }
2026-02-20T22:09:15.2760645Z -                }, status_code=200)
2026-02-20T22:09:15.2761031Z -
2026-02-20T22:09:15.2761320Z -            user.is_email_verified = True
2026-02-20T22:09:15.2761848Z -            user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2762340Z -            db.commit()
2026-02-20T22:09:15.2762705Z -            db.refresh(user)
2026-02-20T22:09:15.2763225Z -
2026-02-20T22:09:15.2763941Z -            logger.info(f"Email vérifié pour l'utilisateur {user.username} ({user.email})")
2026-02-20T22:09:15.2764644Z -
2026-02-20T22:09:15.2764931Z -            return JSONResponse({
2026-02-20T22:09:15.2765643Z -                "message": "Votre adresse email a été vérifiée avec succès !",
2026-02-20T22:09:15.2766256Z -                "success": True,
2026-02-20T22:09:15.2766649Z -                "user": {
2026-02-20T22:09:15.2766994Z -                    "id": user.id,
2026-02-20T22:09:15.2767435Z -                    "username": user.username,
2026-02-20T22:09:15.2767892Z -                    "email": user.email,
2026-02-20T22:09:15.2768409Z -                    "is_email_verified": user.is_email_verified
2026-02-20T22:09:15.2768905Z -                }
2026-02-20T22:09:15.2769224Z -            }, status_code=200)
2026-02-20T22:09:15.2769595Z -            
2026-02-20T22:09:15.2769979Z +                        "is_email_verified": user.is_email_verified,
2026-02-20T22:09:15.2770487Z +                    },
2026-02-20T22:09:15.2770804Z +                },
2026-02-20T22:09:15.2771127Z +                status_code=200,
2026-02-20T22:09:15.2771489Z +            )
2026-02-20T22:09:15.2771775Z +
2026-02-20T22:09:15.2772099Z      except Exception as email_verification_error:
2026-02-20T22:09:15.2773446Z -        logger.error(f"Erreur lors de la vérification de l'email: {email_verification_error}")
2026-02-20T22:09:15.2774205Z +        logger.error(
2026-02-20T22:09:15.2774882Z +            f"Erreur lors de la vérification de l'email: {email_verification_error}"
2026-02-20T22:09:15.2775518Z +        )
2026-02-20T22:09:15.2776062Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2776537Z          return JSONResponse(
2026-02-20T22:09:15.2777155Z -            {"error": "Erreur lors de la vérification de l'email"},
2026-02-20T22:09:15.2777710Z -            status_code=500
2026-02-20T22:09:15.2778406Z +            {"error": "Erreur lors de la vérification de l'email"}, status_code=500
2026-02-20T22:09:15.2779003Z          )
2026-02-20T22:09:15.2779261Z  
2026-02-20T22:09:15.2779502Z  
2026-02-20T22:09:15.2779784Z  @rate_limit_resend_verification
2026-02-20T22:09:15.2780274Z  async def resend_verification_email(request: Request):
2026-02-20T22:09:15.2780746Z @@ -153,68 +165,91 @@
2026-02-20T22:09:15.2781004Z  
2026-02-20T22:09:15.2781279Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2781665Z  
2026-02-20T22:09:15.2781908Z          async with db_session() as db:
2026-02-20T22:09:15.2782296Z              user = get_user_by_email(db, email)
2026-02-20T22:09:15.2782674Z -            
2026-02-20T22:09:15.2782906Z +
2026-02-20T22:09:15.2783292Z              if not user:
2026-02-20T22:09:15.2783863Z                  # Pour des raisons de sécurité, ne pas révéler si l'email existe
2026-02-20T22:09:15.2784481Z -                return JSONResponse({
2026-02-20T22:09:15.2785490Z -                    "message": "Si cette adresse email est associée à un compte non vérifié, vous recevrez un email de vérification."
2026-02-20T22:09:15.2786306Z -                }, status_code=200)
2026-02-20T22:09:15.2786664Z -            
2026-02-20T22:09:15.2786962Z +                return JSONResponse(
2026-02-20T22:09:15.2787333Z +                    {
2026-02-20T22:09:15.2788297Z +                        "message": "Si cette adresse email est associée à un compte non vérifié, vous recevrez un email de vérification."
2026-02-20T22:09:15.2789054Z +                    },
2026-02-20T22:09:15.2789332Z +                    status_code=200,
2026-02-20T22:09:15.2789634Z +                )
2026-02-20T22:09:15.2789873Z +
2026-02-20T22:09:15.2790204Z              # Vérifier si l'email est déjà vérifié
2026-02-20T22:09:15.2790691Z              if user.is_email_verified:
2026-02-20T22:09:15.2791136Z -                return JSONResponse({
2026-02-20T22:09:15.2791776Z -                    "message": "Votre adresse email est déjà vérifiée"
2026-02-20T22:09:15.2792331Z -                }, status_code=200)
2026-02-20T22:09:15.2792704Z -            
2026-02-20T22:09:15.2793183Z +                return JSONResponse(
2026-02-20T22:09:15.2793845Z +                    {"message": "Votre adresse email est déjà vérifiée"},
2026-02-20T22:09:15.2794402Z +                    status_code=200,
2026-02-20T22:09:15.2794809Z +                )
2026-02-20T22:09:15.2795092Z +
2026-02-20T22:09:15.2795432Z              # Rate limit : ne pas renvoyer avant 2 minutes
2026-02-20T22:09:15.2795968Z              if user.email_verification_sent_at:
2026-02-20T22:09:15.2796615Z                  cooldown = user.email_verification_sent_at + timedelta(minutes=2)
2026-02-20T22:09:15.2797324Z                  if datetime.now(timezone.utc) < cooldown:
2026-02-20T22:09:15.2797838Z -                    return JSONResponse({
2026-02-20T22:09:15.2798592Z -                        "message": "Veuillez patienter quelques minutes avant de demander un nouvel email."
2026-02-20T22:09:15.2799701Z -                    }, status_code=200)  # 200 pour ne pas révéler l'existence du compte
2026-02-20T22:09:15.2800320Z -            
2026-02-20T22:09:15.2800635Z +                    return JSONResponse(
2026-02-20T22:09:15.2801054Z +                        {
2026-02-20T22:09:15.2801727Z +                            "message": "Veuillez patienter quelques minutes avant de demander un nouvel email."
2026-02-20T22:09:15.2802713Z +                        },
2026-02-20T22:09:15.2803265Z +                        status_code=200,
2026-02-20T22:09:15.2803930Z +                    )  # 200 pour ne pas révéler l'existence du compte
2026-02-20T22:09:15.2804443Z +
2026-02-20T22:09:15.2805088Z              # Générer un nouveau token
2026-02-20T22:09:15.2805626Z              verification_token = generate_verification_token()
2026-02-20T22:09:15.2806263Z              user.email_verification_token = verification_token
2026-02-20T22:09:15.2806946Z              user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2807516Z -            
2026-02-20T22:09:15.2807801Z +
2026-02-20T22:09:15.2808056Z              db.commit()
2026-02-20T22:09:15.2808407Z              db.refresh(user)
2026-02-20T22:09:15.2808762Z -            
2026-02-20T22:09:15.2809034Z +
2026-02-20T22:09:15.2809308Z              # Envoyer l'email
2026-02-20T22:09:15.2810001Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:15.2810788Z +            frontend_url = os.getenv(
2026-02-20T22:09:15.2811362Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:15.2811941Z +            )
2026-02-20T22:09:15.2812351Z              email_sent = EmailService.send_verification_email(
2026-02-20T22:09:15.2812901Z                  to_email=user.email,
2026-02-20T22:09:15.2813616Z                  username=user.username,
2026-02-20T22:09:15.2814102Z                  verification_token=verification_token,
2026-02-20T22:09:15.2814609Z -                frontend_url=frontend_url
2026-02-20T22:09:15.2815019Z -            )
2026-02-20T22:09:15.2815303Z -            
2026-02-20T22:09:15.2815608Z +                frontend_url=frontend_url,
2026-02-20T22:09:15.2816023Z +            )
2026-02-20T22:09:15.2816290Z +
2026-02-20T22:09:15.2816552Z              if email_sent:
2026-02-20T22:09:15.2817241Z                  logger.info(f"Email de vérification renvoyé à {user.email}")
2026-02-20T22:09:15.2817881Z                  if "localhost" in frontend_url:
2026-02-20T22:09:15.2818558Z -                    verify_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:15.2819470Z -                    logger.info(f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}")
2026-02-20T22:09:15.2820195Z -                return JSONResponse({
2026-02-20T22:09:15.2821011Z -                    "message": "Un nouvel email de vérification a été envoyé à votre adresse."
2026-02-20T22:09:15.2821699Z -                }, status_code=200)
2026-02-20T22:09:15.2822093Z +                    verify_link = (
2026-02-20T22:09:15.2822641Z +                        f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:15.2823397Z +                    )
2026-02-20T22:09:15.2823734Z +                    logger.info(
2026-02-20T22:09:15.2824285Z +                        f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}"
2026-02-20T22:09:15.2824884Z +                    )
2026-02-20T22:09:15.2825234Z +                return JSONResponse(
2026-02-20T22:09:15.2825628Z +                    {
2026-02-20T22:09:15.2826365Z +                        "message": "Un nouvel email de vérification a été envoyé à votre adresse."
2026-02-20T22:09:15.2827061Z +                    },
2026-02-20T22:09:15.2827401Z +                    status_code=200,
2026-02-20T22:09:15.2827793Z +                )
2026-02-20T22:09:15.2828078Z              else:
2026-02-20T22:09:15.2828793Z -                logger.warning(f"Échec de l'envoi de l'email de vérification à {user.email}")
2026-02-20T22:09:15.2829519Z -                return JSONResponse({
2026-02-20T22:09:15.2830429Z -                    "error": "Impossible d'envoyer l'email de vérification. Veuillez réessayer plus tard."
2026-02-20T22:09:15.2831206Z -                }, status_code=500)
2026-02-20T22:09:15.2831624Z +                logger.warning(
2026-02-20T22:09:15.2832555Z +                    f"Échec de l'envoi de l'email de vérification à {user.email}"
2026-02-20T22:09:15.2833313Z +                )
2026-02-20T22:09:15.2833646Z +                return JSONResponse(
2026-02-20T22:09:15.2834042Z +                    {
2026-02-20T22:09:15.2834868Z +                        "error": "Impossible d'envoyer l'email de vérification. Veuillez réessayer plus tard."
2026-02-20T22:09:15.2835795Z +                    },
2026-02-20T22:09:15.2836133Z +                    status_code=500,
2026-02-20T22:09:15.2836519Z +                )
2026-02-20T22:09:15.2836800Z  
2026-02-20T22:09:15.2837148Z      except Exception as resend_verification_error:
2026-02-20T22:09:15.2838132Z -        logger.error(f"Erreur lors du renvoi de l'email de vérification: {resend_verification_error}")
2026-02-20T22:09:15.2838917Z +        logger.error(
2026-02-20T22:09:15.2839633Z +            f"Erreur lors du renvoi de l'email de vérification: {resend_verification_error}"
2026-02-20T22:09:15.2840329Z +        )
2026-02-20T22:09:15.2840655Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2841119Z          return JSONResponse(
2026-02-20T22:09:15.2841764Z              {"error": "Erreur lors du renvoi de l'email de vérification"},
2026-02-20T22:09:15.2842341Z -            status_code=500
2026-02-20T22:09:15.2842734Z +            status_code=500,
2026-02-20T22:09:15.2843250Z          )
2026-02-20T22:09:15.2843518Z  
2026-02-20T22:09:15.2843754Z  
2026-02-20T22:09:15.2844021Z  @rate_limit_auth("login")
2026-02-20T22:09:15.2844407Z  async def api_login(request: Request):
2026-02-20T22:09:15.2844843Z @@ -243,36 +278,41 @@
2026-02-20T22:09:15.2845142Z  
2026-02-20T22:09:15.2845465Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2845916Z  
2026-02-20T22:09:15.2846194Z          async with db_session() as db:
2026-02-20T22:09:15.2846718Z              user = authenticate_user(db, username, password)
2026-02-20T22:09:15.2847211Z -            
2026-02-20T22:09:15.2847495Z +
2026-02-20T22:09:15.2847745Z              if not user:
2026-02-20T22:09:15.2848448Z                  logger.warning(f"Échec de connexion pour l'utilisateur: {username}")
2026-02-20T22:09:15.2849111Z                  return JSONResponse(
2026-02-20T22:09:15.2849665Z                      {"error": "Nom d'utilisateur ou mot de passe incorrect"},
2026-02-20T22:09:15.2850258Z -                    status_code=401
2026-02-20T22:09:15.2850637Z -                )
2026-02-20T22:09:15.2850925Z -
2026-02-20T22:09:15.2851280Z -            if not getattr(user, 'is_email_verified', True):
2026-02-20T22:09:15.2851808Z -                return JSONResponse(
2026-02-20T22:09:15.2852890Z -                    {"error": "Veuillez vérifier votre adresse email avant de vous connecter. Consultez votre boîte de réception."},
2026-02-20T22:09:15.2853982Z -                    status_code=403
2026-02-20T22:09:15.2854363Z -                )
2026-02-20T22:09:15.2854665Z -            
2026-02-20T22:09:15.2854985Z +                    status_code=401,
2026-02-20T22:09:15.2855363Z +                )
2026-02-20T22:09:15.2855653Z +
2026-02-20T22:09:15.2855997Z +            if not getattr(user, "is_email_verified", True):
2026-02-20T22:09:15.2856528Z +                return JSONResponse(
2026-02-20T22:09:15.2856966Z +                    {
2026-02-20T22:09:15.2857981Z +                        "error": "Veuillez vérifier votre adresse email avant de vous connecter. Consultez votre boîte de réception."
2026-02-20T22:09:15.2858879Z +                    },
2026-02-20T22:09:15.2859218Z +                    status_code=403,
2026-02-20T22:09:15.2859571Z +                )
2026-02-20T22:09:15.2859814Z +
2026-02-20T22:09:15.2860133Z              # Créer les tokens d'accès
2026-02-20T22:09:15.2860511Z              token_data = create_user_token(user)
2026-02-20T22:09:15.2861265Z              logger.info(f"Connexion réussie pour l'utilisateur: {user.username}")
2026-02-20T22:09:15.2861874Z  
2026-02-20T22:09:15.2862530Z              # Créer une entrée UserSession pour /api/users/me/sessions (sessions actives)
2026-02-20T22:09:15.2863688Z              from app.models.user_session import UserSession
2026-02-20T22:09:15.2864265Z              from app.core.config import settings
2026-02-20T22:09:15.2864716Z +
2026-02-20T22:09:15.2865093Z              ip = request.client.host if request.client else None
2026-02-20T22:09:15.2865953Z              user_agent = request.headers.get("user-agent") or ""
2026-02-20T22:09:15.2866658Z              device_info = {"user_agent": user_agent[:500]} if user_agent else None
2026-02-20T22:09:15.2867352Z              session_token = secrets.token_urlsafe(32)
2026-02-20T22:09:15.2868187Z -            expires_at = datetime.now(timezone.utc) + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
2026-02-20T22:09:15.2869103Z +            expires_at = datetime.now(timezone.utc) + timedelta(
2026-02-20T22:09:15.2869703Z +                days=settings.REFRESH_TOKEN_EXPIRE_DAYS
2026-02-20T22:09:15.2870163Z +            )
2026-02-20T22:09:15.2870509Z              db_session_row = UserSession(
2026-02-20T22:09:15.2870950Z                  user_id=user.id,
2026-02-20T22:09:15.2871373Z                  session_token=session_token,
2026-02-20T22:09:15.2871832Z                  device_info=device_info,
2026-02-20T22:09:15.2872273Z                  ip_address=ip,
2026-02-20T22:09:15.2872641Z @@ -290,66 +330,72 @@
2026-02-20T22:09:15.2873265Z                  "token_type": token_data.get("token_type", "bearer"),
2026-02-20T22:09:15.2873849Z                  "expires_in": access_token_max_age,
2026-02-20T22:09:15.2874313Z                  "user": {
2026-02-20T22:09:15.2874670Z                      "id": user.id,
2026-02-20T22:09:15.2875086Z                      "username": user.username,
2026-02-20T22:09:15.2875663Z -                    "email": user.email if hasattr(user, 'email') else None,
2026-02-20T22:09:15.2876415Z -                    "full_name": user.full_name if hasattr(user, 'full_name') else None,
2026-02-20T22:09:15.2877218Z -                    "role": user.role.value if hasattr(user, 'role') else None,
2026-02-20T22:09:15.2878154Z -                    "is_email_verified": user.is_email_verified if hasattr(user, 'is_email_verified') else False
2026-02-20T22:09:15.2878929Z -                }
2026-02-20T22:09:15.2879364Z +                    "email": user.email if hasattr(user, "email") else None,
2026-02-20T22:09:15.2880101Z +                    "full_name": user.full_name if hasattr(user, "full_name") else None,
2026-02-20T22:09:15.2880859Z +                    "role": user.role.value if hasattr(user, "role") else None,
2026-02-20T22:09:15.2881458Z +                    "is_email_verified": (
2026-02-20T22:09:15.2881915Z +                        user.is_email_verified
2026-02-20T22:09:15.2882422Z +                        if hasattr(user, "is_email_verified")
2026-02-20T22:09:15.2882906Z +                        else False
2026-02-20T22:09:15.2883478Z +                    ),
2026-02-20T22:09:15.2883789Z +                },
2026-02-20T22:09:15.2884148Z              }
2026-02-20T22:09:15.2884428Z -            
2026-02-20T22:09:15.2884713Z +
2026-02-20T22:09:15.2885133Z              # Créer la réponse avec le cookie
2026-02-20T22:09:15.2885724Z              response = JSONResponse(response_data, status_code=200)
2026-02-20T22:09:15.2886275Z -            
2026-02-20T22:09:15.2886559Z +
2026-02-20T22:09:15.2887123Z              # Déterminer la configuration des cookies selon l'environnement
2026-02-20T22:09:15.2887919Z              # En production (cross-domain), utiliser SameSite=None et Secure=True
2026-02-20T22:09:15.2888562Z              import os
2026-02-20T22:09:15.2888870Z +
2026-02-20T22:09:15.2889150Z              is_production = (
2026-02-20T22:09:15.2889584Z -                os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:15.2890166Z -                os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:15.2890743Z -                os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.2891509Z +                os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.2892059Z +                or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.2892627Z +                or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.2893302Z              )
2026-02-20T22:09:15.2893720Z              cookie_samesite = "none" if is_production else "lax"
2026-02-20T22:09:15.2894711Z              cookie_secure = is_production  # Secure=True obligatoire avec SameSite=None
2026-02-20T22:09:15.2895365Z -            
2026-02-20T22:09:15.2895636Z +
2026-02-20T22:09:15.2896301Z              # Définir le cookie access_token (pour compatibilité avec l'ancien système)
2026-02-20T22:09:15.2896978Z              response.set_cookie(
2026-02-20T22:09:15.2897384Z                  key="access_token",
2026-02-20T22:09:15.2897843Z                  value=token_data.get("access_token"),
2026-02-20T22:09:15.2898323Z                  httponly=True,
2026-02-20T22:09:15.2898725Z                  max_age=access_token_max_age,
2026-02-20T22:09:15.2899218Z                  samesite=cookie_samesite,
2026-02-20T22:09:15.2899665Z -                secure=cookie_secure
2026-02-20T22:09:15.2900061Z -            )
2026-02-20T22:09:15.2900342Z -            
2026-02-20T22:09:15.2900647Z +                secure=cookie_secure,
2026-02-20T22:09:15.2901043Z +            )
2026-02-20T22:09:15.2901320Z +
2026-02-20T22:09:15.2901955Z              # Définir le cookie refresh_token (nécessaire pour le refresh automatique)
2026-02-20T22:09:15.2902834Z              refresh_token_max_age = settings.REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60
2026-02-20T22:09:15.2903803Z              refresh_token_value = token_data.get("refresh_token")
2026-02-20T22:09:15.2904367Z              if refresh_token_value:
2026-02-20T22:09:15.2904794Z                  response.set_cookie(
2026-02-20T22:09:15.2905217Z                      key="refresh_token",
2026-02-20T22:09:15.2905669Z                      value=refresh_token_value,
2026-02-20T22:09:15.2906117Z                      httponly=True,
2026-02-20T22:09:15.2906559Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.2907051Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.2907496Z -                    secure=cookie_secure
2026-02-20T22:09:15.2907916Z -                )
2026-02-20T22:09:15.2909071Z -                logger.info(f"Cookie refresh_token défini pour l'utilisateur: {user.username} (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.2910137Z +                    secure=cookie_secure,
2026-02-20T22:09:15.2910544Z +                )
2026-02-20T22:09:15.2910858Z +                logger.info(
2026-02-20T22:09:15.2911956Z +                    f"Cookie refresh_token défini pour l'utilisateur: {user.username} (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.2912901Z +                )
2026-02-20T22:09:15.2913375Z              else:
2026-02-20T22:09:15.2914230Z -                logger.error(f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}")
2026-02-20T22:09:15.2915076Z -            
2026-02-20T22:09:15.2915515Z +                logger.error(
2026-02-20T22:09:15.2916508Z +                    f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}"
2026-02-20T22:09:15.2931021Z +                )
2026-02-20T22:09:15.2931350Z +
2026-02-20T22:09:15.2931658Z              return response
2026-02-20T22:09:15.2932013Z  
2026-02-20T22:09:15.2932317Z      except Exception as login_error:
2026-02-20T22:09:15.2932879Z          logger.error(f"Erreur lors de la connexion: {login_error}")
2026-02-20T22:09:15.2933701Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2934171Z -        return JSONResponse(
2026-02-20T22:09:15.2934619Z -            {"error": "Erreur lors de la connexion"},
2026-02-20T22:09:15.2935102Z -            status_code=500
2026-02-20T22:09:15.2935462Z -        )
2026-02-20T22:09:15.2935996Z +        return JSONResponse({"error": "Erreur lors de la connexion"}, status_code=500)
2026-02-20T22:09:15.2936896Z  
2026-02-20T22:09:15.2937152Z  
2026-02-20T22:09:15.2937441Z  @rate_limit_auth("validate-token")
2026-02-20T22:09:15.2937943Z  async def api_validate_token(request: Request):
2026-02-20T22:09:15.2938404Z      """
2026-02-20T22:09:15.2938682Z @@ -371,11 +417,13 @@
2026-02-20T22:09:15.2939079Z                  {"valid": False, "error": "Token manquant"},
2026-02-20T22:09:15.2939828Z                  status_code=400,
2026-02-20T22:09:15.2940199Z              )
2026-02-20T22:09:15.2940516Z          token = data_or_err["token"]
2026-02-20T22:09:15.2940953Z          if not isinstance(token, str):
2026-02-20T22:09:15.2941638Z -            return JSONResponse({"valid": False, "error": "Token invalide"}, status_code=400)
2026-02-20T22:09:15.2942365Z +            return JSONResponse(
2026-02-20T22:09:15.2942887Z +                {"valid": False, "error": "Token invalide"}, status_code=400
2026-02-20T22:09:15.2943632Z +            )
2026-02-20T22:09:15.2943954Z          payload = decode_token(token)
2026-02-20T22:09:15.2944641Z          # Vérifier que c'est un access token (type=access)
2026-02-20T22:09:15.2945196Z          if payload.get("type") != "access":
2026-02-20T22:09:15.2945754Z              return JSONResponse({"valid": False}, status_code=401)
2026-02-20T22:09:15.2946488Z          return JSONResponse({"valid": True, "user_id": payload.get("sub")})
2026-02-20T22:09:15.2947103Z @@ -391,113 +439,141 @@
2026-02-20T22:09:15.2947477Z      Cookie (optionnel): refresh_token
2026-02-20T22:09:15.2947911Z      Returns: New access token
2026-02-20T22:09:15.2948276Z      """
2026-02-20T22:09:15.2948535Z      try:
2026-02-20T22:09:15.2948822Z          refresh_token = None
2026-02-20T22:09:15.2949175Z -        
2026-02-20T22:09:15.2949432Z +
2026-02-20T22:09:15.2950103Z          # Essayer de récupérer le refresh token depuis le body JSON (pour compatibilité)
2026-02-20T22:09:15.2950772Z          try:
2026-02-20T22:09:15.2951119Z              body_content = await request.body()
2026-02-20T22:09:15.2951589Z              if body_content:
2026-02-20T22:09:15.2951963Z                  import json
2026-02-20T22:09:15.2952299Z +
2026-02-20T22:09:15.2952557Z                  try:
2026-02-20T22:09:15.2953142Z -                    data = json.loads(body_content.decode('utf-8'))
2026-02-20T22:09:15.2953895Z -                    refresh_token = data.get('refresh_token', '').strip() if data else None
2026-02-20T22:09:15.2954656Z +                    data = json.loads(body_content.decode("utf-8"))
2026-02-20T22:09:15.2955176Z +                    refresh_token = (
2026-02-20T22:09:15.2955723Z +                        data.get("refresh_token", "").strip() if data else None
2026-02-20T22:09:15.2956273Z +                    )
2026-02-20T22:09:15.2956683Z                  except (ValueError, json.JSONDecodeError):
2026-02-20T22:09:15.2957321Z                      # JSON invalide, ce n'est pas grave, on essaiera les cookies
2026-02-20T22:09:15.2957906Z                      pass
2026-02-20T22:09:15.2958264Z          except Exception:
2026-02-20T22:09:15.2958861Z              # Erreur lors de la lecture du body, ce n'est pas grave, on essaiera les cookies
2026-02-20T22:09:15.2959520Z              pass
2026-02-20T22:09:15.2959803Z -        
2026-02-20T22:09:15.2960063Z +
2026-02-20T22:09:15.2960664Z          # Si pas de token dans le body, essayer de le récupérer depuis les cookies
2026-02-20T22:09:15.2961287Z          if not refresh_token:
2026-02-20T22:09:15.2961832Z -            refresh_token = request.cookies.get('refresh_token', '').strip()
2026-02-20T22:09:15.2962424Z -        
2026-02-20T22:09:15.2962870Z +            refresh_token = request.cookies.get("refresh_token", "").strip()
2026-02-20T22:09:15.2963649Z +
2026-02-20T22:09:15.2963937Z          # Log pour diagnostic
2026-02-20T22:09:15.2964368Z          all_cookies = list(request.cookies.keys())
2026-02-20T22:09:15.2965152Z          logger.debug(f"Cookies présents lors du refresh: {all_cookies}")
2026-02-20T22:09:15.2965729Z -        
2026-02-20T22:09:15.2966231Z +
2026-02-20T22:09:15.2966498Z          if refresh_token:
2026-02-20T22:09:15.2967709Z -            logger.debug(f"Refresh token reçu depuis {'body' if 'refresh_token' not in request.cookies else 'cookie'} (longueur: {len(refresh_token)})")
2026-02-20T22:09:15.2968776Z +            logger.debug(
2026-02-20T22:09:15.2969861Z +                f"Refresh token reçu depuis {'body' if 'refresh_token' not in request.cookies else 'cookie'} (longueur: {len(refresh_token)})"
2026-02-20T22:09:15.2971009Z +            )
2026-02-20T22:09:15.2971289Z          else:
2026-02-20T22:09:15.2971949Z              logger.warning("Aucun refresh_token trouvé dans les cookies ou le body")
2026-02-20T22:09:15.2972849Z              # FALLBACK: Pour les utilisateurs existants qui n'ont pas de refresh_token,
2026-02-20T22:09:15.2973904Z              # essayer d'utiliser l'access_token comme fallback temporaire
2026-02-20T22:09:15.2974706Z -            access_token_fallback = request.cookies.get('access_token', '').strip()
2026-02-20T22:09:15.2975589Z +            access_token_fallback = request.cookies.get("access_token", "").strip()
2026-02-20T22:09:15.2976268Z              if access_token_fallback:
2026-02-20T22:09:15.2977071Z -                logger.warning("Tentative de fallback avec access_token (utilisateur existant sans refresh_token)")
2026-02-20T22:09:15.2977933Z +                logger.warning(
2026-02-20T22:09:15.2978632Z +                    "Tentative de fallback avec access_token (utilisateur existant sans refresh_token)"
2026-02-20T22:09:15.2979347Z +                )
2026-02-20T22:09:15.2979985Z                  # Essayer de décoder l'access_token pour vérifier s'il est valide
2026-02-20T22:09:15.2980575Z                  try:
2026-02-20T22:09:15.2980904Z                      import jwt
2026-02-20T22:09:15.2981338Z                      from app.core.config import settings
2026-02-20T22:09:15.2981799Z +
2026-02-20T22:09:15.2982095Z                      payload = jwt.decode(
2026-02-20T22:09:15.2982611Z                          access_token_fallback,
2026-02-20T22:09:15.2983265Z                          settings.SECRET_KEY,
2026-02-20T22:09:15.2983766Z                          algorithms=[settings.ALGORITHM],
2026-02-20T22:09:15.2984751Z -                        options={"verify_exp": False}  # Ne pas vérifier l'expiration pour le fallback
2026-02-20T22:09:15.2985457Z +                        options={
2026-02-20T22:09:15.2985892Z +                            "verify_exp": False
2026-02-20T22:09:15.2986562Z +                        },  # Ne pas vérifier l'expiration pour le fallback
2026-02-20T22:09:15.2987094Z                      )
2026-02-20T22:09:15.2987796Z                      # Si l'access_token est valide mais expiré, créer un nouveau refresh_token
2026-02-20T22:09:15.2988508Z                      username = payload.get("sub")
2026-02-20T22:09:15.2988963Z                      if username:
2026-02-20T22:09:15.2989940Z -                        logger.info(f"Fallback: Création d'un nouveau refresh_token pour l'utilisateur existant: {username}")
2026-02-20T22:09:15.2990828Z +                        logger.info(
2026-02-20T22:09:15.2991746Z +                            f"Fallback: Création d'un nouveau refresh_token pour l'utilisateur existant: {username}"
2026-02-20T22:09:15.2992523Z +                        )
2026-02-20T22:09:15.2992942Z                          async with db_session() as db_fallback:
2026-02-20T22:09:15.2993910Z -                            from app.services.auth_service import get_user_by_username, create_user_token
2026-02-20T22:09:15.2994742Z +                            from app.services.auth_service import (
2026-02-20T22:09:15.2995282Z +                                get_user_by_username,
2026-02-20T22:09:15.2995764Z +                                create_user_token,
2026-02-20T22:09:15.2996209Z +                            )
2026-02-20T22:09:15.2996550Z +
2026-02-20T22:09:15.2996982Z                              user_fallback = get_user_by_username(db_fallback, username)
2026-02-20T22:09:15.2997844Z                              if user_fallback:
2026-02-20T22:09:15.2998569Z                                  # Créer un nouveau refresh_token pour cet utilisateur
2026-02-20T22:09:15.2999313Z -                                new_token_data_fallback = create_user_token(user_fallback)
2026-02-20T22:09:15.3000111Z -                                refresh_token = new_token_data_fallback.get("refresh_token")
2026-02-20T22:09:15.3001365Z -                                logger.info(f"Fallback: Nouveau refresh_token créé pour {username}")
2026-02-20T22:09:15.3002139Z +                                new_token_data_fallback = create_user_token(
2026-02-20T22:09:15.3002708Z +                                    user_fallback
2026-02-20T22:09:15.3003318Z +                                )
2026-02-20T22:09:15.3003814Z +                                refresh_token = new_token_data_fallback.get(
2026-02-20T22:09:15.3004380Z +                                    "refresh_token"
2026-02-20T22:09:15.3004830Z +                                )
2026-02-20T22:09:15.3005248Z +                                logger.info(
2026-02-20T22:09:15.3005987Z +                                    f"Fallback: Nouveau refresh_token créé pour {username}"
2026-02-20T22:09:15.3006581Z +                                )
2026-02-20T22:09:15.3006945Z                              else:
2026-02-20T22:09:15.3007689Z -                                logger.warning(f"Fallback: Utilisateur {username} non trouvé")
2026-02-20T22:09:15.3008363Z +                                logger.warning(
2026-02-20T22:09:15.3009054Z +                                    f"Fallback: Utilisateur {username} non trouvé"
2026-02-20T22:09:15.3009606Z +                                )
2026-02-20T22:09:15.3010027Z                  except Exception as fallback_error:
2026-02-20T22:09:15.3010724Z                      logger.debug(f"Fallback échoué: {fallback_error}")
2026-02-20T22:09:15.3011242Z -        
2026-02-20T22:09:15.3011513Z +
2026-02-20T22:09:15.3011784Z          if not refresh_token:
2026-02-20T22:09:15.3012190Z              return JSONResponse(
2026-02-20T22:09:15.3012826Z -                {"error": "Refresh token requis (body ou cookie). Veuillez vous reconnecter."},
2026-02-20T22:09:15.3013701Z -                status_code=400
2026-02-20T22:09:15.3014072Z -            )
2026-02-20T22:09:15.3014349Z -        
2026-02-20T22:09:15.3014625Z +                {
2026-02-20T22:09:15.3015174Z +                    "error": "Refresh token requis (body ou cookie). Veuillez vous reconnecter."
2026-02-20T22:09:15.3015837Z +                },
2026-02-20T22:09:15.3016149Z +                status_code=400,
2026-02-20T22:09:15.3016517Z +            )
2026-02-20T22:09:15.3016779Z +
2026-02-20T22:09:15.3017065Z          async with db_session() as db:
2026-02-20T22:09:15.3017582Z              # Rafraîchir le token
2026-02-20T22:09:15.3018088Z              new_token_data = refresh_access_token(db, refresh_token)
2026-02-20T22:09:15.3018616Z -            
2026-02-20T22:09:15.3018878Z +
2026-02-20T22:09:15.3019321Z              logger.info("Token rafraîchi avec succès")
2026-02-20T22:09:15.3019774Z -            
2026-02-20T22:09:15.3020042Z +
2026-02-20T22:09:15.3020731Z              # refresh_token UNIQUEMENT en cookie (HttpOnly) — jamais dans le body (sécurité XSS)
2026-02-20T22:09:15.3021457Z              response_data = {
2026-02-20T22:09:15.3021947Z                  "access_token": new_token_data.get("access_token"),
2026-02-20T22:09:15.3022587Z                  "token_type": new_token_data.get("token_type", "bearer"),
2026-02-20T22:09:15.3023295Z              }
2026-02-20T22:09:15.3023709Z              response = JSONResponse(response_data, status_code=200)
2026-02-20T22:09:15.3024244Z -            
2026-02-20T22:09:15.3024516Z +
2026-02-20T22:09:15.3025086Z              # Déterminer la configuration des cookies selon l'environnement
2026-02-20T22:09:15.3025873Z              # En production (cross-domain), utiliser SameSite=None et Secure=True
2026-02-20T22:09:15.3026494Z              import os
2026-02-20T22:09:15.3027048Z +
2026-02-20T22:09:15.3027316Z              is_production = (
2026-02-20T22:09:15.3027770Z -                os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:15.3028344Z -                os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:15.3028931Z -                os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.3029670Z +                os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.3030225Z +                or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.3030798Z +                or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.3031291Z              )
2026-02-20T22:09:15.3031708Z              cookie_samesite = "none" if is_production else "lax"
2026-02-20T22:09:15.3032469Z              cookie_secure = is_production  # Secure=True obligatoire avec SameSite=None
2026-02-20T22:09:15.3033305Z -            
2026-02-20T22:09:15.3033579Z +
2026-02-20T22:09:15.3034165Z              # Mettre à jour le cookie access_token si présent dans la réponse
2026-02-20T22:09:15.3034834Z              from app.core.config import settings
2026-02-20T22:09:15.3035276Z +
2026-02-20T22:09:15.3035582Z              if "access_token" in new_token_data:
2026-02-20T22:09:15.3036216Z                  access_token_max_age = settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
2026-02-20T22:09:15.3036876Z                  response.set_cookie(
2026-02-20T22:09:15.3037307Z                      key="access_token",
2026-02-20T22:09:15.3037798Z                      value=new_token_data.get("access_token"),
2026-02-20T22:09:15.3038298Z                      httponly=True,
2026-02-20T22:09:15.3038739Z                      max_age=access_token_max_age,
2026-02-20T22:09:15.3039216Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3039669Z -                    secure=cookie_secure
2026-02-20T22:09:15.3040081Z -                )
2026-02-20T22:09:15.3040366Z -            
2026-02-20T22:09:15.3040678Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3041083Z +                )
2026-02-20T22:09:15.3041369Z +
2026-02-20T22:09:15.3041931Z              # Si le refresh_token a été créé via fallback, l'ajouter au cookie
2026-02-20T22:09:15.3042739Z              # Sinon, s'assurer que le refresh_token existe toujours dans les cookies
2026-02-20T22:09:15.3043774Z              refresh_token_max_age = settings.REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60
2026-02-20T22:09:15.3044598Z              if refresh_token and "refresh_token" not in request.cookies:
2026-02-20T22:09:15.3045425Z                  # Refresh_token créé via fallback, l'ajouter au cookie
2026-02-20T22:09:15.3045965Z @@ -505,34 +581,37 @@
2026-02-20T22:09:15.3046314Z                      key="refresh_token",
2026-02-20T22:09:15.3046732Z                      value=refresh_token,
2026-02-20T22:09:15.3047145Z                      httponly=True,
2026-02-20T22:09:15.3047570Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.3048069Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3048534Z -                    secure=cookie_secure
2026-02-20T22:09:15.3048930Z -                )
2026-02-20T22:09:15.3050043Z -                logger.info(f"Cookie refresh_token créé via fallback et ajouté à la réponse (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.3051047Z -            
2026-02-20T22:09:15.3051375Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3051777Z +                )
2026-02-20T22:09:15.3052087Z +                logger.info(
2026-02-20T22:09:15.3053318Z +                    f"Cookie refresh_token créé via fallback et ajouté à la réponse (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.3054249Z +                )
2026-02-20T22:09:15.3054543Z +
2026-02-20T22:09:15.3055206Z              # Rotation: nouveau refresh_token à chaque refresh — cookie HttpOnly uniquement
2026-02-20T22:09:15.3055951Z              if "refresh_token" in new_token_data:
2026-02-20T22:09:15.3056430Z                  response.set_cookie(
2026-02-20T22:09:15.3057085Z                      key="refresh_token",
2026-02-20T22:09:15.3057583Z                      value=new_token_data.get("refresh_token"),
2026-02-20T22:09:15.3058110Z                      httponly=True,
2026-02-20T22:09:15.3058550Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.3059251Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3059711Z -                    secure=cookie_secure
2026-02-20T22:09:15.3060112Z -                )
2026-02-20T22:09:15.3060980Z -                logger.debug(f"Cookie refresh_token roté (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.3061784Z -            
2026-02-20T22:09:15.3062100Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3062502Z +                )
2026-02-20T22:09:15.3062817Z +                logger.debug(
2026-02-20T22:09:15.3063825Z +                    f"Cookie refresh_token roté (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.3064545Z +                )
2026-02-20T22:09:15.3064828Z +
2026-02-20T22:09:15.3065100Z              return response
2026-02-20T22:09:15.3065451Z -            
2026-02-20T22:09:15.3065718Z +
2026-02-20T22:09:15.3066028Z      except Exception as token_refresh_error:
2026-02-20T22:09:15.3066881Z          logger.error(f"Erreur lors du rafraîchissement du token: {token_refresh_error}")
2026-02-20T22:09:15.3067641Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3068118Z          return JSONResponse(
2026-02-20T22:09:15.3068676Z -            {"error": "Refresh token invalide ou expiré"},
2026-02-20T22:09:15.3069185Z -            status_code=401
2026-02-20T22:09:15.3069813Z +            {"error": "Refresh token invalide ou expiré"}, status_code=401
2026-02-20T22:09:15.3070385Z          )
2026-02-20T22:09:15.3070639Z  
2026-02-20T22:09:15.3070883Z  
2026-02-20T22:09:15.3071120Z  @require_auth
2026-02-20T22:09:15.3071491Z  async def api_get_current_user(request: Request):
2026-02-20T22:09:15.3071974Z @@ -542,17 +621,19 @@
2026-02-20T22:09:15.3072299Z      Returns: User info
2026-02-20T22:09:15.3072619Z      """
2026-02-20T22:09:15.3072868Z      try:
2026-02-20T22:09:15.3073349Z          current_user = request.state.user
2026-02-20T22:09:15.3073886Z          return JSONResponse(current_user, status_code=200)
2026-02-20T22:09:15.3074395Z -        
2026-02-20T22:09:15.3074650Z +
2026-02-20T22:09:15.3074964Z      except Exception as user_retrieval_error:
2026-02-20T22:09:15.3075895Z -        logger.error(f"Erreur lors de la récupération de l'utilisateur: {user_retrieval_error}")
2026-02-20T22:09:15.3076637Z +        logger.error(
2026-02-20T22:09:15.3077316Z +            f"Erreur lors de la récupération de l'utilisateur: {user_retrieval_error}"
2026-02-20T22:09:15.3077952Z +        )
2026-02-20T22:09:15.3078286Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3078748Z          return JSONResponse(
2026-02-20T22:09:15.3079393Z              {"error": "Erreur lors de la récupération de l'utilisateur"},
2026-02-20T22:09:15.3079979Z -            status_code=500
2026-02-20T22:09:15.3080354Z +            status_code=500,
2026-02-20T22:09:15.3080696Z          )
2026-02-20T22:09:15.3080958Z  
2026-02-20T22:09:15.3081195Z  
2026-02-20T22:09:15.3081492Z  @rate_limit_auth("forgot-password")
2026-02-20T22:09:15.3081992Z  async def api_forgot_password(request: Request):
2026-02-20T22:09:15.3082474Z @@ -562,17 +643,14 @@
2026-02-20T22:09:15.3082834Z      Route: POST /api/auth/forgot-password
2026-02-20T22:09:15.3083521Z      Body: {"email": "user@example.com"}
2026-02-20T22:09:15.3083935Z      """
2026-02-20T22:09:15.3084249Z      try:
2026-02-20T22:09:15.3084543Z          data = await request.json()
2026-02-20T22:09:15.3084990Z -        email = data.get('email', '').strip().lower()
2026-02-20T22:09:15.3085523Z +        email = data.get("email", "").strip().lower()
2026-02-20T22:09:15.3085974Z  
2026-02-20T22:09:15.3086227Z          if not email:
2026-02-20T22:09:15.3086564Z -            return JSONResponse(
2026-02-20T22:09:15.3087222Z -                {"error": "Adresse email requise"},
2026-02-20T22:09:15.3087703Z -                status_code=400
2026-02-20T22:09:15.3088072Z -            )
2026-02-20T22:09:15.3088595Z +            return JSONResponse({"error": "Adresse email requise"}, status_code=400)
2026-02-20T22:09:15.3089231Z  
2026-02-20T22:09:15.3089723Z          async with db_session() as db:
2026-02-20T22:09:15.3090186Z              user = get_user_by_email(db, email)
2026-02-20T22:09:15.3090614Z  
2026-02-20T22:09:15.3091349Z              # Pour la sécurité, toujours retourner le même message (évite l'énumération d'emails)
2026-02-20T22:09:15.3092070Z @@ -598,38 +676,43 @@
2026-02-20T22:09:15.3092484Z              user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.3092950Z  
2026-02-20T22:09:15.3093395Z              db.commit()
2026-02-20T22:09:15.3093739Z              db.refresh(user)
2026-02-20T22:09:15.3094088Z  
2026-02-20T22:09:15.3094663Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:15.3095443Z +            frontend_url = os.getenv(
2026-02-20T22:09:15.3096025Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:15.3096594Z +            )
2026-02-20T22:09:15.3097005Z              email_sent = EmailService.send_password_reset_email(
2026-02-20T22:09:15.3097565Z                  to_email=user.email,
2026-02-20T22:09:15.3097992Z                  username=user.username,
2026-02-20T22:09:15.3098427Z                  reset_token=reset_token,
2026-02-20T22:09:15.3098871Z -                frontend_url=frontend_url
2026-02-20T22:09:15.3099323Z +                frontend_url=frontend_url,
2026-02-20T22:09:15.3099735Z              )
2026-02-20T22:09:15.3100008Z  
2026-02-20T22:09:15.3100266Z              if not email_sent:
2026-02-20T22:09:15.3100920Z                  logger.warning(f"Échec envoi email reset à {user.email}")
2026-02-20T22:09:15.3101506Z                  return JSONResponse(
2026-02-20T22:09:15.3102327Z -                    {"error": "Impossible d'envoyer l'email. Veuillez réessayer plus tard."},
2026-02-20T22:09:15.3103178Z -                    status_code=500
2026-02-20T22:09:15.3103580Z +                    {
2026-02-20T22:09:15.3104276Z +                        "error": "Impossible d'envoyer l'email. Veuillez réessayer plus tard."
2026-02-20T22:09:15.3104947Z +                    },
2026-02-20T22:09:15.3105291Z +                    status_code=500,
2026-02-20T22:09:15.3105669Z                  )
2026-02-20T22:09:15.3105960Z  
2026-02-20T22:09:15.3106523Z              logger.info(f"Email de réinitialisation envoyé à {user.email}")
2026-02-20T22:09:15.3107493Z              # En dev avec localhost : Gmail filtre souvent ces emails. Afficher le lien en console pour tester.
2026-02-20T22:09:15.3108323Z              if "localhost" in frontend_url:
2026-02-20T22:09:15.3108952Z                  reset_link = f"{frontend_url}/reset-password?token={reset_token}"
2026-02-20T22:09:15.3109894Z -                logger.info(f"[DEV] Si l'email n'arrive pas (filtre Gmail), copie ce lien : {reset_link}")
2026-02-20T22:09:15.3110655Z +                logger.info(
2026-02-20T22:09:15.3111259Z +                    f"[DEV] Si l'email n'arrive pas (filtre Gmail), copie ce lien : {reset_link}"
2026-02-20T22:09:15.3111900Z +                )
2026-02-20T22:09:15.3112410Z              return JSONResponse({"message": success_message}, status_code=200)
2026-02-20T22:09:15.3113165Z  
2026-02-20T22:09:15.3113466Z      except Exception as forgot_err:
2026-02-20T22:09:15.3114008Z          logger.error(f"Erreur forgot-password: {forgot_err}")
2026-02-20T22:09:15.3114582Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3115053Z          return JSONResponse(
2026-02-20T22:09:15.3115522Z -            {"error": "Erreur lors du traitement de la demande"},
2026-02-20T22:09:15.3116052Z -            status_code=500
2026-02-20T22:09:15.3116587Z +            {"error": "Erreur lors du traitement de la demande"}, status_code=500
2026-02-20T22:09:15.3117390Z          )
2026-02-20T22:09:15.3117646Z  
2026-02-20T22:09:15.3117890Z  
2026-02-20T22:09:15.3118222Z  async def api_reset_password(request: Request):
2026-02-20T22:09:15.3118671Z      """
2026-02-20T22:09:15.3118943Z @@ -641,56 +724,54 @@
2026-02-20T22:09:15.3119297Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:15.3119915Z      if csrf_err:
2026-02-20T22:09:15.3120221Z          return csrf_err
2026-02-20T22:09:15.3120547Z      try:
2026-02-20T22:09:15.3120838Z          data = await request.json()
2026-02-20T22:09:15.3121296Z -        token = (data.get('token') or '').strip()
2026-02-20T22:09:15.3121808Z -        password = data.get('password', '')
2026-02-20T22:09:15.3122358Z -        password_confirm = data.get('password_confirm', '')
2026-02-20T22:09:15.3122934Z +        token = (data.get("token") or "").strip()
2026-02-20T22:09:15.3123597Z +        password = data.get("password", "")
2026-02-20T22:09:15.3124147Z +        password_confirm = data.get("password_confirm", "")
2026-02-20T22:09:15.3124637Z  
2026-02-20T22:09:15.3124903Z          if not token:
2026-02-20T22:09:15.3125241Z              return JSONResponse(
2026-02-20T22:09:15.3125860Z -                {"error": "Token de réinitialisation manquant"},
2026-02-20T22:09:15.3126363Z -                status_code=400
2026-02-20T22:09:15.3127041Z +                {"error": "Token de réinitialisation manquant"}, status_code=400
2026-02-20T22:09:15.3127621Z              )
2026-02-20T22:09:15.3127890Z  
2026-02-20T22:09:15.3128194Z          if not password or len(password) < 8:
2026-02-20T22:09:15.3128653Z              return JSONResponse(
2026-02-20T22:09:15.3129341Z                  {"error": "Le mot de passe doit contenir au moins 8 caractères"},
2026-02-20T22:09:15.3129933Z -                status_code=400
2026-02-20T22:09:15.3130323Z +                status_code=400,
2026-02-20T22:09:15.3130677Z              )
2026-02-20T22:09:15.3131057Z          if not any(char.isdigit() for char in password):
2026-02-20T22:09:15.3131577Z              return JSONResponse(
2026-02-20T22:09:15.3132115Z                  {"error": "Le mot de passe doit contenir au moins un chiffre"},
2026-02-20T22:09:15.3132699Z -                status_code=400
2026-02-20T22:09:15.3133251Z +                status_code=400,
2026-02-20T22:09:15.3133625Z              )
2026-02-20T22:09:15.3134013Z          if not any(char.isupper() for char in password):
2026-02-20T22:09:15.3134561Z              return JSONResponse(
2026-02-20T22:09:15.3135102Z                  {"error": "Le mot de passe doit contenir au moins une majuscule"},
2026-02-20T22:09:15.3135698Z -                status_code=400
2026-02-20T22:09:15.3136080Z +                status_code=400,
2026-02-20T22:09:15.3136429Z              )
2026-02-20T22:09:15.3136704Z  
2026-02-20T22:09:15.3136998Z          if password != password_confirm:
2026-02-20T22:09:15.3137441Z              return JSONResponse(
2026-02-20T22:09:15.3137936Z -                {"error": "Les mots de passe ne correspondent pas"},
2026-02-20T22:09:15.3145676Z -                status_code=400
2026-02-20T22:09:15.3146234Z +                {"error": "Les mots de passe ne correspondent pas"}, status_code=400
2026-02-20T22:09:15.3146849Z              )
2026-02-20T22:09:15.3147139Z  
2026-02-20T22:09:15.3147426Z          async with db_session() as db:
2026-02-20T22:09:15.3147903Z              from app.models.user import User
2026-02-20T22:09:15.3148331Z +
2026-02-20T22:09:15.3148803Z              user = db.query(User).filter(User.password_reset_token == token).first()
2026-02-20T22:09:15.3149420Z  
2026-02-20T22:09:15.3149688Z              if not user:
2026-02-20T22:09:15.3150049Z                  return JSONResponse(
2026-02-20T22:09:15.3150710Z -                    {"error": "Token invalide ou déjà utilisé"},
2026-02-20T22:09:15.3151230Z -                    status_code=400
2026-02-20T22:09:15.3151909Z +                    {"error": "Token invalide ou déjà utilisé"}, status_code=400
2026-02-20T22:09:15.3152720Z                  )
2026-02-20T22:09:15.3153209Z  
2026-02-20T22:09:15.3153696Z              if is_password_reset_token_expired(user.password_reset_expires_at):
2026-02-20T22:09:15.3154330Z                  return JSONResponse(
2026-02-20T22:09:15.3155084Z                      {"error": "Le lien a expiré. Veuillez demander un nouveau lien."},
2026-02-20T22:09:15.3155919Z -                    status_code=400
2026-02-20T22:09:15.3156332Z +                    status_code=400,
2026-02-20T22:09:15.3156718Z                  )
2026-02-20T22:09:15.3157000Z  
2026-02-20T22:09:15.3157373Z              user.hashed_password = get_password_hash(password)
2026-02-20T22:09:15.3157940Z              user.password_reset_token = None
2026-02-20T22:09:15.3158441Z              user.password_reset_expires_at = None
2026-02-20T22:09:15.3158899Z @@ -698,21 +779,24 @@
2026-02-20T22:09:15.3159199Z  
2026-02-20T22:09:15.3159455Z              db.commit()
2026-02-20T22:09:15.3159803Z              db.refresh(user)
2026-02-20T22:09:15.3160161Z  
2026-02-20T22:09:15.3160720Z              logger.info(f"Mot de passe réinitialisé pour {user.username}")
2026-02-20T22:09:15.3161343Z -            return JSONResponse({
2026-02-20T22:09:15.3162164Z -                "message": "Mot de passe réinitialisé avec succès. Vous pouvez vous connecter.",
2026-02-20T22:09:15.3162895Z -                "success": True
2026-02-20T22:09:15.3163478Z -            }, status_code=200)
2026-02-20T22:09:15.3163871Z +            return JSONResponse(
2026-02-20T22:09:15.3164237Z +                {
2026-02-20T22:09:15.3165824Z +                    "message": "Mot de passe réinitialisé avec succès. Vous pouvez vous connecter.",
2026-02-20T22:09:15.3168188Z +                    "success": True,
2026-02-20T22:09:15.3283659Z +                },
2026-02-20T22:09:15.3284029Z +                status_code=200,
2026-02-20T22:09:15.3284482Z +            )
2026-02-20T22:09:15.3284774Z  
2026-02-20T22:09:15.3285060Z      except Exception as reset_err:
2026-02-20T22:09:15.3285622Z          logger.error(f"Erreur reset-password: {reset_err}")
2026-02-20T22:09:15.3286189Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3286661Z          return JSONResponse(
2026-02-20T22:09:15.3287363Z              {"error": "Erreur lors de la réinitialisation du mot de passe"},
2026-02-20T22:09:15.3287962Z -            status_code=500
2026-02-20T22:09:15.3288360Z +            status_code=500,
2026-02-20T22:09:15.3288706Z          )
2026-02-20T22:09:15.3288968Z  
2026-02-20T22:09:15.3289207Z  
2026-02-20T22:09:15.3289491Z  async def api_logout(request: Request):
2026-02-20T22:09:15.3289845Z      """
2026-02-20T22:09:15.3290073Z @@ -749,12 +833,6 @@
2026-02-20T22:09:15.3290683Z          logger.info("Utilisateur déconnecté : cookies d'authentification effacés.")
2026-02-20T22:09:15.3291301Z          return response
2026-02-20T22:09:15.3291638Z      except Exception as logout_error:
2026-02-20T22:09:15.3292258Z          logger.error(f"Erreur lors de la déconnexion: {logout_error}")
2026-02-20T22:09:15.3292852Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3293479Z -        return JSONResponse(
2026-02-20T22:09:15.3293957Z -            {"error": "Erreur lors de la déconnexion"},
2026-02-20T22:09:15.3294370Z -            status_code=500
2026-02-20T22:09:15.3294688Z -        )
2026-02-20T22:09:15.3294933Z -
2026-02-20T22:09:15.3295180Z -
2026-02-20T22:09:15.3295399Z -
2026-02-20T22:09:15.3296031Z +        return JSONResponse({"error": "Erreur lors de la déconnexion"}, status_code=500)
2026-02-20T22:09:15.9446594Z --- /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:15.9451061Z +++ /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py	2026-02-20 22:09:15.936430+00:00
2026-02-20T22:09:15.9451935Z @@ -1,9 +1,10 @@
2026-02-20T22:09:15.9452230Z  """
2026-02-20T22:09:15.9452550Z  Handlers pour le chatbot utilisant OpenAI
2026-02-20T22:09:15.9453743Z  Optimisé avec streaming SSE, smart routing, et best practices AI modernes
2026-02-20T22:09:15.9454811Z  """
2026-02-20T22:09:15.9455069Z +
2026-02-20T22:09:15.9455316Z  import json
2026-02-20T22:09:15.9455606Z  import os
2026-02-20T22:09:15.9455861Z  
2026-02-20T22:09:15.9456299Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:15.9456870Z  
2026-02-20T22:09:15.9457342Z @@ -14,71 +15,96 @@
2026-02-20T22:09:15.9457632Z  
2026-02-20T22:09:15.9457898Z  logger = get_logger(__name__)
2026-02-20T22:09:15.9458255Z  
2026-02-20T22:09:15.9458489Z  try:
2026-02-20T22:09:15.9458784Z      from openai import AsyncOpenAI
2026-02-20T22:09:15.9459162Z +
2026-02-20T22:09:15.9459516Z      OPENAI_AVAILABLE = True
2026-02-20T22:09:15.9459897Z  except ImportError:
2026-02-20T22:09:15.9460241Z      OPENAI_AVAILABLE = False
2026-02-20T22:09:15.9460587Z  
2026-02-20T22:09:15.9460827Z  
2026-02-20T22:09:15.9461302Z  def _detect_complexity(message: str, conversation_history: list) -> str:
2026-02-20T22:09:15.9461921Z      """
2026-02-20T22:09:15.9462488Z      Détecte la complexité de la question pour smart routing.
2026-02-20T22:09:15.9463480Z      Retourne 'simple' ou 'complex' pour choisir le modèle approprié.
2026-02-20T22:09:15.9464059Z -    
2026-02-20T22:09:15.9464306Z +
2026-02-20T22:09:15.9464928Z      Best practice : Utiliser gpt-4o-mini pour questions simples (coût réduit),
2026-02-20T22:09:15.9465793Z      gpt-4o pour questions complexes (meilleure qualité).
2026-02-20T22:09:15.9466289Z      """
2026-02-20T22:09:15.9466585Z      message_lower = message.lower()
2026-02-20T22:09:15.9466971Z -    
2026-02-20T22:09:15.9467222Z +
2026-02-20T22:09:15.9467542Z      # Indicateurs de complexité
2026-02-20T22:09:15.9467947Z      complex_keywords = [
2026-02-20T22:09:15.9468584Z -        'démontrer', 'prouver', 'théorème', 'formule', 'équation complexe',
2026-02-20T22:09:15.9469462Z -        'raisonnement', 'déduction', 'logique avancée', 'grille logique',
2026-02-20T22:09:15.9470376Z -        'combinatoire', 'probabilité', 'séquence complexe', 'pattern avancé',
2026-02-20T22:09:15.9471331Z -        'résoudre étape par étape', 'explique en détail', 'comment fonctionne'
2026-02-20T22:09:15.9472000Z +        "démontrer",
2026-02-20T22:09:15.9472313Z +        "prouver",
2026-02-20T22:09:15.9472682Z +        "théorème",
2026-02-20T22:09:15.9473136Z +        "formule",
2026-02-20T22:09:15.9473562Z +        "équation complexe",
2026-02-20T22:09:15.9473931Z +        "raisonnement",
2026-02-20T22:09:15.9474321Z +        "déduction",
2026-02-20T22:09:15.9474693Z +        "logique avancée",
2026-02-20T22:09:15.9475063Z +        "grille logique",
2026-02-20T22:09:15.9475407Z +        "combinatoire",
2026-02-20T22:09:15.9475805Z +        "probabilité",
2026-02-20T22:09:15.9476210Z +        "séquence complexe",
2026-02-20T22:09:15.9476635Z +        "pattern avancé",
2026-02-20T22:09:15.9477077Z +        "résoudre étape par étape",
2026-02-20T22:09:15.9477552Z +        "explique en détail",
2026-02-20T22:09:15.9477934Z +        "comment fonctionne",
2026-02-20T22:09:15.9478290Z      ]
2026-02-20T22:09:15.9478545Z -    
2026-02-20T22:09:15.9478792Z +
2026-02-20T22:09:15.9479063Z      simple_keywords = [
2026-02-20T22:09:15.9479657Z -        'combien fait', 'c\'est quoi', 'qu\'est-ce que', 'définition',
2026-02-20T22:09:15.9480442Z -        'exemple', 'calcul simple', 'addition', 'soustraction', 'multiplication',
2026-02-20T22:09:15.9481156Z -        'division', 'aide', 'explique simplement'
2026-02-20T22:09:15.9481610Z +        "combien fait",
2026-02-20T22:09:15.9481949Z +        "c'est quoi",
2026-02-20T22:09:15.9482272Z +        "qu'est-ce que",
2026-02-20T22:09:15.9482671Z +        "définition",
2026-02-20T22:09:15.9483123Z +        "exemple",
2026-02-20T22:09:15.9483444Z +        "calcul simple",
2026-02-20T22:09:15.9483776Z +        "addition",
2026-02-20T22:09:15.9484096Z +        "soustraction",
2026-02-20T22:09:15.9484437Z +        "multiplication",
2026-02-20T22:09:15.9484783Z +        "division",
2026-02-20T22:09:15.9485086Z +        "aide",
2026-02-20T22:09:15.9485676Z +        "explique simplement",
2026-02-20T22:09:15.9486038Z      ]
2026-02-20T22:09:15.9486284Z -    
2026-02-20T22:09:15.9486538Z +
2026-02-20T22:09:15.9486948Z      # Questions courtes = généralement simples
2026-02-20T22:09:15.9487431Z      if len(message.split()) <= 5:
2026-02-20T22:09:15.9487828Z -        return 'simple'
2026-02-20T22:09:15.9488348Z -    
2026-02-20T22:09:15.9488611Z +        return "simple"
2026-02-20T22:09:15.9488925Z +
2026-02-20T22:09:15.9489288Z      # Détecter mots-clés complexes
2026-02-20T22:09:15.9489847Z      if any(keyword in message_lower for keyword in complex_keywords):
2026-02-20T22:09:15.9490459Z -        return 'complex'
2026-02-20T22:09:15.9490786Z -    
2026-02-20T22:09:15.9491047Z +        return "complex"
2026-02-20T22:09:15.9491367Z +
2026-02-20T22:09:15.9491707Z      # Détecter mots-clés simples
2026-02-20T22:09:15.9492259Z      if any(keyword in message_lower for keyword in simple_keywords):
2026-02-20T22:09:15.9492821Z -        return 'simple'
2026-02-20T22:09:15.9494093Z -    
2026-02-20T22:09:15.9494400Z +        return "simple"
2026-02-20T22:09:15.9503690Z +
2026-02-20T22:09:15.9504806Z      # Par défaut, utiliser le modèle simple pour économiser les coûts
2026-02-20T22:09:15.9543214Z -    return 'simple'
2026-02-20T22:09:15.9543594Z +    return "simple"
2026-02-20T22:09:15.9543915Z  
2026-02-20T22:09:15.9544194Z  
2026-02-20T22:09:15.9544522Z  def _estimate_age(message: str) -> str | None:
2026-02-20T22:09:15.9544991Z      """
2026-02-20T22:09:15.9545503Z      Estime l'âge de l'utilisateur depuis le message.
2026-02-20T22:09:15.9546330Z      Amélioration : pourrait utiliser le profil utilisateur si disponible.
2026-02-20T22:09:15.9546944Z      """
2026-02-20T22:09:15.9547239Z      message_lower = message.lower()
2026-02-20T22:09:15.9547639Z -    
2026-02-20T22:09:15.9548182Z -    if any(word in message_lower for word in ['cm1', 'cm2', 'cp', 'ce1', 'ce2', 'maternelle']):
2026-02-20T22:09:15.9548889Z -        return '5-8'
2026-02-20T22:09:15.9549632Z -    elif any(word in message_lower for word in ['6ème', '5ème', 'collège', 'primaire']):
2026-02-20T22:09:15.9550324Z -        return '9-12'
2026-02-20T22:09:15.9551008Z -    elif any(word in message_lower for word in ['4ème', '3ème', 'lycée', 'seconde']):
2026-02-20T22:09:15.9551671Z -        return '13-16'
2026-02-20T22:09:15.9552369Z -    elif any(word in message_lower for word in ['terminale', 'bac', 'université']):
2026-02-20T22:09:15.9553318Z -        return '17-20'
2026-02-20T22:09:15.9553654Z -    
2026-02-20T22:09:15.9553905Z +
2026-02-20T22:09:15.9554158Z +    if any(
2026-02-20T22:09:15.9554456Z +        word in message_lower
2026-02-20T22:09:15.9554950Z +        for word in ["cm1", "cm2", "cp", "ce1", "ce2", "maternelle"]
2026-02-20T22:09:15.9555464Z +    ):
2026-02-20T22:09:15.9555739Z +        return "5-8"
2026-02-20T22:09:15.9556458Z +    elif any(word in message_lower for word in ["6ème", "5ème", "collège", "primaire"]):
2026-02-20T22:09:15.9557125Z +        return "9-12"
2026-02-20T22:09:15.9557839Z +    elif any(word in message_lower for word in ["4ème", "3ème", "lycée", "seconde"]):
2026-02-20T22:09:15.9558485Z +        return "13-16"
2026-02-20T22:09:15.9559168Z +    elif any(word in message_lower for word in ["terminale", "bac", "université"]):
2026-02-20T22:09:15.9559890Z +        return "17-20"
2026-02-20T22:09:15.9560202Z +
2026-02-20T22:09:15.9560465Z      return None
2026-02-20T22:09:15.9560771Z  
2026-02-20T22:09:15.9561005Z  
2026-02-20T22:09:15.9561436Z  def _build_system_prompt(estimated_age: str | None = None) -> str:
2026-02-20T22:09:15.9562000Z      """
2026-02-20T22:09:15.9562260Z @@ -134,28 +160,24 @@
2026-02-20T22:09:15.9562562Z  
2026-02-20T22:09:15.9562811Z  @rate_limit_chat
2026-02-20T22:09:15.9563337Z  async def chat_api(request):
2026-02-20T22:09:15.9563702Z      """
2026-02-20T22:09:15.9564713Z      Endpoint API pour le chatbot
2026-02-20T22:09:15.9565701Z -    
2026-02-20T22:09:15.9566998Z +
2026-02-20T22:09:15.9623495Z      Utilise OpenAI pour répondre aux questions sur Mathakine
2026-02-20T22:09:15.9624369Z      """
2026-02-20T22:09:15.9624632Z      try:
2026-02-20T22:09:15.9625105Z          # Vérifier que OpenAI est disponible
2026-02-20T22:09:15.9625582Z          if not OPENAI_AVAILABLE:
2026-02-20T22:09:15.9625985Z -            return JSONResponse(
2026-02-20T22:09:15.9626432Z -                {"error": "OpenAI non disponible"},
2026-02-20T22:09:15.9627095Z -                status_code=503
2026-02-20T22:09:15.9627463Z -            )
2026-02-20T22:09:15.9627740Z -        
2026-02-20T22:09:15.9628245Z +            return JSONResponse({"error": "OpenAI non disponible"}, status_code=503)
2026-02-20T22:09:15.9628881Z +
2026-02-20T22:09:15.9629302Z          # Vérifier que la clé API est configurée
2026-02-20T22:09:15.9629795Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:15.9630231Z              return JSONResponse(
2026-02-20T22:09:15.9630800Z -                {"error": "Clé API OpenAI non configurée"},
2026-02-20T22:09:15.9631299Z -                status_code=503
2026-02-20T22:09:15.9631680Z -            )
2026-02-20T22:09:15.9631954Z -        
2026-02-20T22:09:15.9632507Z +                {"error": "Clé API OpenAI non configurée"}, status_code=503
2026-02-20T22:09:15.9633258Z +            )
2026-02-20T22:09:15.9633550Z +
2026-02-20T22:09:15.9634068Z          # Récupérer les données de la requête (DRY parse_json_body)
2026-02-20T22:09:15.9634747Z          from app.utils.request_utils import parse_json_body
2026-02-20T22:09:15.9635248Z  
2026-02-20T22:09:15.9635542Z          data_or_err = await parse_json_body(
2026-02-20T22:09:15.9635979Z              request,
2026-02-20T22:09:15.9636298Z @@ -166,302 +188,408 @@
2026-02-20T22:09:15.9636636Z              return data_or_err
2026-02-20T22:09:15.9637041Z          message_raw = data_or_err["message"]
2026-02-20T22:09:15.9637701Z          conversation_history = data_or_err.get("conversation_history", [])[:20]
2026-02-20T22:09:15.9638322Z  
2026-02-20T22:09:15.9638840Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:15.9639724Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:15.9640516Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:15.9641007Z +            sanitize_user_prompt,
2026-02-20T22:09:15.9641410Z +            validate_prompt_safety,
2026-02-20T22:09:15.9641810Z +        )
2026-02-20T22:09:15.9642064Z +
2026-02-20T22:09:15.9642469Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:15.9643177Z          if not is_safe:
2026-02-20T22:09:15.9643539Z              return JSONResponse(
2026-02-20T22:09:15.9644020Z -                {"error": f"Message invalide: {safety_reason}"},
2026-02-20T22:09:15.9644533Z -                status_code=400
2026-02-20T22:09:15.9645070Z +                {"error": f"Message invalide: {safety_reason}"}, status_code=400
2026-02-20T22:09:15.9645627Z              )
2026-02-20T22:09:15.9646072Z          message = sanitize_user_prompt(message_raw, max_length=2000)
2026-02-20T22:09:15.9646624Z  
2026-02-20T22:09:15.9646977Z          # Créer le client OpenAI
2026-02-20T22:09:15.9647490Z          client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:15.9647996Z -        
2026-02-20T22:09:15.9648254Z +
2026-02-20T22:09:15.9648723Z          # Détecter si la demande concerne une image mathématique
2026-02-20T22:09:15.9650211Z -        image_keywords = ['image', 'dessine', 'dessin', 'schéma', 'diagramme', 'figure', 'graphique', 'visualise', 'montre', 'créer', 'génère', 'fais', 'montre-moi', 'affiche']
2026-02-20T22:09:15.9652741Z -        math_image_keywords = ['géométrie', 'triangle', 'cercle', 'carré', 'rectangle', 'forme', 'angle', 'fraction', 'graphique', 'courbe', 'polygone', 'losange', 'trapèze', 'cercle', 'ovale', 'ligne', 'point', 'segment', 'exercice', 'problème']
2026-02-20T22:09:15.9684547Z -        
2026-02-20T22:09:15.9684874Z +        image_keywords = [
2026-02-20T22:09:15.9685232Z +            "image",
2026-02-20T22:09:15.9685800Z +            "dessine",
2026-02-20T22:09:15.9686118Z +            "dessin",
2026-02-20T22:09:15.9686531Z +            "schéma",
2026-02-20T22:09:15.9686846Z +            "diagramme",
2026-02-20T22:09:15.9687183Z +            "figure",
2026-02-20T22:09:15.9687491Z +            "graphique",
2026-02-20T22:09:15.9687827Z +            "visualise",
2026-02-20T22:09:15.9688358Z +            "montre",
2026-02-20T22:09:15.9688722Z +            "créer",
2026-02-20T22:09:15.9689092Z +            "génère",
2026-02-20T22:09:15.9689392Z +            "fais",
2026-02-20T22:09:15.9689703Z +            "montre-moi",
2026-02-20T22:09:15.9690041Z +            "affiche",
2026-02-20T22:09:15.9690353Z +        ]
2026-02-20T22:09:15.9690642Z +        math_image_keywords = [
2026-02-20T22:09:15.9691088Z +            "géométrie",
2026-02-20T22:09:15.9691415Z +            "triangle",
2026-02-20T22:09:15.9691762Z +            "cercle",
2026-02-20T22:09:15.9692118Z +            "carré",
2026-02-20T22:09:15.9692430Z +            "rectangle",
2026-02-20T22:09:15.9692772Z +            "forme",
2026-02-20T22:09:15.9693235Z +            "angle",
2026-02-20T22:09:15.9693545Z +            "fraction",
2026-02-20T22:09:15.9693867Z +            "graphique",
2026-02-20T22:09:15.9694195Z +            "courbe",
2026-02-20T22:09:15.9694501Z +            "polygone",
2026-02-20T22:09:15.9694844Z +            "losange",
2026-02-20T22:09:15.9695225Z +            "trapèze",
2026-02-20T22:09:15.9695543Z +            "cercle",
2026-02-20T22:09:15.9695840Z +            "ovale",
2026-02-20T22:09:15.9696145Z +            "ligne",
2026-02-20T22:09:15.9696450Z +            "point",
2026-02-20T22:09:15.9696748Z +            "segment",
2026-02-20T22:09:15.9697070Z +            "exercice",
2026-02-20T22:09:15.9697455Z +            "problème",
2026-02-20T22:09:15.9697777Z +        ]
2026-02-20T22:09:15.9698034Z +
2026-02-20T22:09:15.9698564Z          is_image_request = any(keyword in message.lower() for keyword in image_keywords)
2026-02-20T22:09:15.9699567Z -        is_math_related = any(keyword in message.lower() for keyword in math_image_keywords) or any(
2026-02-20T22:09:15.9700990Z -            keyword in message.lower() for keyword in ['math', 'mathématique', 'calcul', 'nombre', 'équation', 'exercice', 'problème']
2026-02-20T22:09:15.9701887Z -        )
2026-02-20T22:09:15.9702149Z -        
2026-02-20T22:09:15.9702461Z +        is_math_related = any(
2026-02-20T22:09:15.9703140Z +            keyword in message.lower() for keyword in math_image_keywords
2026-02-20T22:09:15.9703715Z +        ) or any(
2026-02-20T22:09:15.9704043Z +            keyword in message.lower()
2026-02-20T22:09:15.9704468Z +            for keyword in [
2026-02-20T22:09:15.9704820Z +                "math",
2026-02-20T22:09:15.9705246Z +                "mathématique",
2026-02-20T22:09:15.9705646Z +                "calcul",
2026-02-20T22:09:15.9705982Z +                "nombre",
2026-02-20T22:09:15.9706383Z +                "équation",
2026-02-20T22:09:15.9706728Z +                "exercice",
2026-02-20T22:09:15.9707158Z +                "problème",
2026-02-20T22:09:15.9707483Z +            ]
2026-02-20T22:09:15.9707755Z +        )
2026-02-20T22:09:15.9708007Z +
2026-02-20T22:09:15.9708560Z          # Si demande d'image ET mathématique, générer une image avec DALL-E
2026-02-20T22:09:15.9709542Z          # MAIS continuer avec la réponse texte complète pour avoir l'exercice résolvable
2026-02-20T22:09:15.9710298Z          if is_image_request and is_math_related:
2026-02-20T22:09:15.9710750Z              try:
2026-02-20T22:09:15.9711447Z                  # Construire un prompt optimisé pour DALL-E (style éducatif, adapté enfants)
2026-02-20T22:09:15.9712610Z                  dalle_prompt = f"""Image éducative mathématique pour enfants de 5 à 20 ans : {message}. 
2026-02-20T22:09:15.9744139Z  Style simple, clair, coloré, adapté aux enfants. Éléments visuels mathématiques uniquement. 
2026-02-20T22:09:15.9745341Z  Pas de texte complexe, formes géométriques simples, couleurs vives et contrastées."""
2026-02-20T22:09:15.9746299Z -                
2026-02-20T22:09:15.9746588Z +
2026-02-20T22:09:15.9747002Z                  # Générer une image avec DALL-E 3
2026-02-20T22:09:15.9747552Z                  image_response = await client.images.generate(
2026-02-20T22:09:15.9748087Z                      model="dall-e-3",
2026-02-20T22:09:15.9748503Z                      prompt=dalle_prompt,
2026-02-20T22:09:15.9749198Z                      size="1024x1024",
2026-02-20T22:09:15.9749609Z                      quality="standard",
2026-02-20T22:09:15.9750017Z                      n=1,
2026-02-20T22:09:15.9750351Z                  )
2026-02-20T22:09:15.9750634Z -                
2026-02-20T22:09:15.9750931Z +
2026-02-20T22:09:15.9751257Z                  image_url = image_response.data[0].url
2026-02-20T22:09:15.9752148Z                  # Ne pas retourner immédiatement - continuer pour générer l'exercice complet
2026-02-20T22:09:15.9753163Z                  # L'image sera ajoutée à la réponse finale
2026-02-20T22:09:15.9753759Z              except Exception as dalle_generation_error:
2026-02-20T22:09:15.9754603Z                  # Si erreur de génération d'image, continuer avec la réponse texte normale
2026-02-20T22:09:15.9755660Z -                logger.error(f"Erreur génération image DALL-E: {str(dalle_generation_error)}")
2026-02-20T22:09:15.9756365Z +                logger.error(
2026-02-20T22:09:15.9757061Z +                    f"Erreur génération image DALL-E: {str(dalle_generation_error)}"
2026-02-20T22:09:15.9757656Z +                )
2026-02-20T22:09:15.9757962Z                  image_url = None
2026-02-20T22:09:15.9758333Z          else:
2026-02-20T22:09:15.9758622Z              image_url = None
2026-02-20T22:09:15.9758973Z -        
2026-02-20T22:09:15.9759231Z +
2026-02-20T22:09:15.9759736Z          # Détecter la complexité pour smart routing
2026-02-20T22:09:15.9760389Z          complexity = _detect_complexity(message, conversation_history)
2026-02-20T22:09:15.9760948Z -        
2026-02-20T22:09:15.9761225Z +
2026-02-20T22:09:15.9761698Z          # Smart routing : choisir le modèle selon la complexité
2026-02-20T22:09:15.9762760Z          # Best practice : gpt-4o-mini pour questions simples (coût réduit), gpt-4o pour complexes (qualité)
2026-02-20T22:09:15.9763868Z -        model = "gpt-4o-mini" if complexity == 'simple' else "gpt-4o"
2026-02-20T22:09:15.9764428Z -        
2026-02-20T22:09:15.9764834Z +        model = "gpt-4o-mini" if complexity == "simple" else "gpt-4o"
2026-02-20T22:09:15.9765372Z +
2026-02-20T22:09:15.9765776Z          # Détecter l'âge pour personnalisation
2026-02-20T22:09:15.9766268Z          estimated_age = _estimate_age(message)
2026-02-20T22:09:15.9766696Z -        
2026-02-20T22:09:15.9766951Z +
2026-02-20T22:09:15.9812287Z          # Construire le prompt système optimisé avec few-shot learning
2026-02-20T22:09:15.9813186Z          system_prompt = _build_system_prompt(estimated_age)
2026-02-20T22:09:15.9813710Z  
2026-02-20T22:09:15.9814031Z          # Construire les messages pour OpenAI
2026-02-20T22:09:15.9814493Z -        messages = [
2026-02-20T22:09:15.9814900Z -            {"role": "system", "content": system_prompt}
2026-02-20T22:09:15.9815358Z -        ]
2026-02-20T22:09:15.9815628Z -        
2026-02-20T22:09:15.9816019Z +        messages = [{"role": "system", "content": system_prompt}]
2026-02-20T22:09:15.9816538Z +
2026-02-20T22:09:15.9817159Z          # Ajouter l'historique de conversation (limité aux 5 derniers messages)
2026-02-20T22:09:15.9817845Z          for msg in conversation_history[-5:]:
2026-02-20T22:09:15.9818315Z -            messages.append({
2026-02-20T22:09:15.9818740Z -                "role": msg.get("role", "user"),
2026-02-20T22:09:15.9819231Z -                "content": msg.get("content", "")
2026-02-20T22:09:15.9819664Z -            })
2026-02-20T22:09:15.9819954Z -        
2026-02-20T22:09:15.9820238Z +            messages.append(
2026-02-20T22:09:15.9820772Z +                {"role": msg.get("role", "user"), "content": msg.get("content", "")}
2026-02-20T22:09:15.9821587Z +            )
2026-02-20T22:09:15.9821869Z +
2026-02-20T22:09:15.9822148Z          # Ajouter le message actuel
2026-02-20T22:09:15.9822574Z -        messages.append({
2026-02-20T22:09:15.9822943Z -            "role": "user",
2026-02-20T22:09:15.9823466Z -            "content": message
2026-02-20T22:09:15.9823830Z -        })
2026-02-20T22:09:15.9824290Z -        
2026-02-20T22:09:15.9824676Z +        messages.append({"role": "user", "content": message})
2026-02-20T22:09:15.9825170Z +
2026-02-20T22:09:15.9825741Z          # Appeler OpenAI avec paramètres optimisés selon la complexité
2026-02-20T22:09:15.9826637Z          # Best practice : Paramètres adaptés selon le modèle et la complexité
2026-02-20T22:09:15.9827621Z          # Augmenté max_tokens pour permettre des exercices complets et résolvables
2026-02-20T22:09:15.9828763Z -        temperature = 0.4 if complexity == 'simple' else 0.6  # Plus prévisible pour questions simples
2026-02-20T22:09:15.9829954Z -        max_tokens = 500 if complexity == 'complex' else 400  # Augmenté pour exercices complets
2026-02-20T22:09:15.9830672Z -        
2026-02-20T22:09:15.9830960Z +        temperature = (
2026-02-20T22:09:15.9831361Z +            0.4 if complexity == "simple" else 0.6
2026-02-20T22:09:15.9831964Z +        )  # Plus prévisible pour questions simples
2026-02-20T22:09:15.9832440Z +        max_tokens = (
2026-02-20T22:09:15.9832839Z +            500 if complexity == "complex" else 400
2026-02-20T22:09:15.9863763Z +        )  # Augmenté pour exercices complets
2026-02-20T22:09:15.9864237Z +
2026-02-20T22:09:15.9864608Z          response = await client.chat.completions.create(
2026-02-20T22:09:15.9865409Z              model=model,  # Smart routing : modèle choisi selon complexité
2026-02-20T22:09:15.9866000Z              messages=messages,
2026-02-20T22:09:15.9866409Z              temperature=temperature,
2026-02-20T22:09:15.9866832Z              max_tokens=max_tokens,
2026-02-20T22:09:15.9867230Z              top_p=0.9,
2026-02-20T22:09:15.9867593Z              frequency_penalty=0.3,
2026-02-20T22:09:15.9868001Z              presence_penalty=0.1,
2026-02-20T22:09:15.9868384Z          )
2026-02-20T22:09:15.9868645Z -        
2026-02-20T22:09:15.9868906Z +
2026-02-20T22:09:15.9869246Z          # Extraire la réponse
2026-02-20T22:09:15.9869747Z          assistant_message = response.choices[0].message.content
2026-02-20T22:09:15.9870279Z -        
2026-02-20T22:09:15.9870541Z +
2026-02-20T22:09:15.9871253Z          # Nettoyer les placeholders d'images Markdown (best practice : éviter les placeholders)
2026-02-20T22:09:15.9872193Z          # Supprimer les patterns comme ![texte](url) ou ![texte](placeholder)
2026-02-20T22:09:15.9872803Z          import re
2026-02-20T22:09:15.9873270Z  
2026-02-20T22:09:15.9873715Z          # Supprimer les images Markdown avec placeholders ou URLs suspectes
2026-02-20T22:09:15.9874329Z          assistant_message = re.sub(
2026-02-20T22:09:15.9874980Z -            r'!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)',
2026-02-20T22:09:15.9875752Z -            r'\1',  # Remplacer par juste le texte alternatif
2026-02-20T22:09:15.9876489Z +            r"!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)",
2026-02-20T22:09:15.9877237Z +            r"\1",  # Remplacer par juste le texte alternatif
2026-02-20T22:09:15.9877740Z              assistant_message,
2026-02-20T22:09:15.9878134Z -            flags=re.IGNORECASE
2026-02-20T22:09:15.9878523Z +            flags=re.IGNORECASE,
2026-02-20T22:09:15.9878888Z          )
2026-02-20T22:09:15.9879458Z          # Supprimer aussi les images Markdown génériques sans URL valide
2026-02-20T22:09:15.9880070Z          assistant_message = re.sub(
2026-02-20T22:09:15.9880473Z -            r'!\[([^\]]*)\]\([^)]*\)',
2026-02-20T22:09:15.9881068Z -            lambda m: m.group(1) if 'http' not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:15.9881701Z -            assistant_message
2026-02-20T22:09:15.9882043Z -        )
2026-02-20T22:09:15.9882535Z -        
2026-02-20T22:09:15.9882813Z +            r"!\[([^\]]*)\]\([^)]*\)",
2026-02-20T22:09:15.9883563Z +            lambda m: m.group(1) if "http" not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:15.9884186Z +            assistant_message,
2026-02-20T22:09:15.9884548Z +        )
2026-02-20T22:09:15.9884991Z +
2026-02-20T22:09:15.9885517Z          # Retourner la réponse avec l'image si elle a été générée
2026-02-20T22:09:15.9886062Z          response_data = {
2026-02-20T22:09:15.9886439Z              "response": assistant_message,
2026-02-20T22:09:15.9887228Z              "model_used": model,  # Debug : indiquer quel modèle a été utilisé
2026-02-20T22:09:15.9888125Z -            "complexity": complexity  # Debug : indiquer la complexité détectée
2026-02-20T22:09:15.9888959Z +            "complexity": complexity,  # Debug : indiquer la complexité détectée
2026-02-20T22:09:15.9889451Z          }
2026-02-20T22:09:15.9889672Z -        
2026-02-20T22:09:15.9889906Z +
2026-02-20T22:09:15.9890305Z          # Ajouter l'URL de l'image si elle a été générée
2026-02-20T22:09:15.9890768Z          if image_url:
2026-02-20T22:09:15.9891128Z              response_data["image_url"] = image_url
2026-02-20T22:09:15.9891592Z              response_data["type"] = "image"
2026-02-20T22:09:15.9891977Z -        
2026-02-20T22:09:15.9892233Z +
2026-02-20T22:09:15.9892497Z          return JSONResponse(response_data)
2026-02-20T22:09:15.9892891Z -        
2026-02-20T22:09:15.9923416Z +
2026-02-20T22:09:15.9923751Z      except Exception as chat_api_error:
2026-02-20T22:09:15.9924319Z          logger.error(f"Erreur dans chat_api: {str(chat_api_error)}")
2026-02-20T22:09:15.9924870Z          import traceback
2026-02-20T22:09:15.9925188Z +
2026-02-20T22:09:15.9925444Z          traceback.print_exc()
2026-02-20T22:09:15.9925818Z          return JSONResponse(
2026-02-20T22:09:15.9926252Z -            {"error": get_safe_error_message(chat_api_error)},
2026-02-20T22:09:15.9926744Z -            status_code=500
2026-02-20T22:09:15.9927248Z +            {"error": get_safe_error_message(chat_api_error)}, status_code=500
2026-02-20T22:09:15.9927776Z          )
2026-02-20T22:09:15.9928003Z  
2026-02-20T22:09:15.9928210Z  
2026-02-20T22:09:15.9928434Z  @rate_limit_chat
2026-02-20T22:09:15.9928723Z  async def chat_api_stream(request):
2026-02-20T22:09:15.9929084Z      """
2026-02-20T22:09:15.9929396Z      Endpoint API pour le chatbot avec streaming SSE.
2026-02-20T22:09:15.9929786Z -    
2026-02-20T22:09:15.9929998Z +
2026-02-20T22:09:15.9930567Z      Best practice : Streaming pour meilleure UX - l'utilisateur voit la réponse
2026-02-20T22:09:15.9931423Z      apparaître progressivement au lieu d'attendre la réponse complète.
2026-02-20T22:09:15.9931945Z -    
2026-02-20T22:09:15.9932167Z +
2026-02-20T22:09:15.9932637Z      Réduit la perception du temps d'attente et améliore l'engagement.
2026-02-20T22:09:15.9933284Z      """
2026-02-20T22:09:15.9933507Z      try:
2026-02-20T22:09:15.9933858Z          # Vérifier que OpenAI est disponible
2026-02-20T22:09:15.9934267Z          if not OPENAI_AVAILABLE:
2026-02-20T22:09:15.9934591Z +
2026-02-20T22:09:15.9934845Z              async def error_generator():
2026-02-20T22:09:15.9935450Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'OpenAI non disponible'})}\n\n"
2026-02-20T22:09:15.9936046Z -            
2026-02-20T22:09:15.9936293Z +
2026-02-20T22:09:15.9936545Z              return StreamingResponse(
2026-02-20T22:09:15.9936912Z                  error_generator(),
2026-02-20T22:09:15.9937293Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9937675Z                  headers={
2026-02-20T22:09:15.9937999Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9938405Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9938763Z -                }
2026-02-20T22:09:15.9939018Z -            )
2026-02-20T22:09:15.9939252Z -        
2026-02-20T22:09:15.9939478Z +                },
2026-02-20T22:09:15.9939946Z +            )
2026-02-20T22:09:15.9940180Z +
2026-02-20T22:09:15.9940526Z          # Vérifier que la clé API est configurée
2026-02-20T22:09:15.9940942Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:15.9941299Z +
2026-02-20T22:09:15.9941534Z              async def error_generator():
2026-02-20T22:09:15.9942299Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Clé API OpenAI non configurée'})}\n\n"
2026-02-20T22:09:15.9943232Z -            
2026-02-20T22:09:15.9943466Z +
2026-02-20T22:09:15.9943705Z              return StreamingResponse(
2026-02-20T22:09:15.9944064Z                  error_generator(),
2026-02-20T22:09:15.9944421Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9944802Z                  headers={
2026-02-20T22:09:15.9945124Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9945522Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9945873Z -                }
2026-02-20T22:09:15.9946111Z -            )
2026-02-20T22:09:15.9946360Z -        
2026-02-20T22:09:15.9946575Z +                },
2026-02-20T22:09:15.9946821Z +            )
2026-02-20T22:09:15.9947041Z +
2026-02-20T22:09:15.9947371Z          # Récupérer les données de la requête
2026-02-20T22:09:15.9947747Z          data = await request.json()
2026-02-20T22:09:15.9948115Z -        message_raw = data.get('message', '')
2026-02-20T22:09:15.9948763Z -        conversation_history = data.get('conversation_history', [])[:20]  # Limiter l'historique
2026-02-20T22:09:15.9949624Z -        use_streaming = data.get('stream', True)  # Streaming par défaut
2026-02-20T22:09:15.9950100Z -        
2026-02-20T22:09:15.9950357Z +        message_raw = data.get("message", "")
2026-02-20T22:09:15.9950845Z +        conversation_history = data.get("conversation_history", [])[
2026-02-20T22:09:15.9951298Z +            :20
2026-02-20T22:09:15.9951554Z +        ]  # Limiter l'historique
2026-02-20T22:09:15.9952100Z +        use_streaming = data.get("stream", True)  # Streaming par défaut
2026-02-20T22:09:15.9952574Z +
2026-02-20T22:09:15.9952792Z          if not message_raw:
2026-02-20T22:09:15.9983374Z +
2026-02-20T22:09:15.9983715Z              async def error_generator():
2026-02-20T22:09:15.9984391Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Message requis'})}\n\n"
2026-02-20T22:09:15.9985059Z -            
2026-02-20T22:09:15.9985330Z +
2026-02-20T22:09:15.9985619Z              return StreamingResponse(
2026-02-20T22:09:15.9986045Z                  error_generator(),
2026-02-20T22:09:15.9986476Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9986911Z                  headers={
2026-02-20T22:09:15.9987293Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9987768Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9988184Z -                }
2026-02-20T22:09:15.9988479Z +                },
2026-02-20T22:09:15.9988762Z              )
2026-02-20T22:09:15.9989036Z  
2026-02-20T22:09:15.9989605Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:15.9990482Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:15.9991276Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:15.9991760Z +            sanitize_user_prompt,
2026-02-20T22:09:15.9992170Z +            validate_prompt_safety,
2026-02-20T22:09:15.9992560Z +        )
2026-02-20T22:09:15.9992822Z +
2026-02-20T22:09:15.9993384Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:15.9993943Z          if not is_safe:
2026-02-20T22:09:15.9994260Z +
2026-02-20T22:09:15.9994541Z              async def error_generator():
2026-02-20T22:09:15.9995309Z                  yield f"data: {json.dumps({'type': 'error', 'message': f'Message invalide: {safety_reason}'})}\n\n"
2026-02-20T22:09:15.9996058Z +
2026-02-20T22:09:15.9996342Z              return StreamingResponse(
2026-02-20T22:09:15.9996767Z                  error_generator(),
2026-02-20T22:09:15.9997494Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9998119Z                  headers={"Cache-Control": "no-cache", "Connection": "keep-alive"},
2026-02-20T22:09:15.9998709Z              )
2026-02-20T22:09:15.9999138Z          message = sanitize_user_prompt(message_raw, max_length=2000)
2026-02-20T22:09:15.9999851Z  
2026-02-20T22:09:16.0000207Z          # Créer le client OpenAI
2026-02-20T22:09:16.0000717Z          client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:16.0001223Z -        
2026-02-20T22:09:16.0001484Z +
2026-02-20T22:09:16.0001969Z          # Détecter si la demande concerne une image mathématique
2026-02-20T22:09:16.0003605Z -        image_keywords = ['image', 'dessine', 'dessin', 'schéma', 'diagramme', 'figure', 'graphique', 'visualise', 'montre', 'créer', 'génère', 'fais', 'montre-moi', 'affiche']
2026-02-20T22:09:16.0006122Z -        math_image_keywords = ['géométrie', 'triangle', 'cercle', 'carré', 'rectangle', 'forme', 'angle', 'fraction', 'graphique', 'courbe', 'polygone', 'losange', 'trapèze', 'cercle', 'ovale', 'ligne', 'point', 'segment', 'exercice', 'problème']
2026-02-20T22:09:16.0007640Z -        
2026-02-20T22:09:16.0007929Z +        image_keywords = [
2026-02-20T22:09:16.0008278Z +            "image",
2026-02-20T22:09:16.0008583Z +            "dessine",
2026-02-20T22:09:16.0008920Z +            "dessin",
2026-02-20T22:09:16.0009276Z +            "schéma",
2026-02-20T22:09:16.0009597Z +            "diagramme",
2026-02-20T22:09:16.0009923Z +            "figure",
2026-02-20T22:09:16.0010236Z +            "graphique",
2026-02-20T22:09:16.0010563Z +            "visualise",
2026-02-20T22:09:16.0010886Z +            "montre",
2026-02-20T22:09:16.0011244Z +            "créer",
2026-02-20T22:09:16.0011600Z +            "génère",
2026-02-20T22:09:16.0011904Z +            "fais",
2026-02-20T22:09:16.0012207Z +            "montre-moi",
2026-02-20T22:09:16.0012546Z +            "affiche",
2026-02-20T22:09:16.0012859Z +        ]
2026-02-20T22:09:16.0043424Z +        math_image_keywords = [
2026-02-20T22:09:16.0043952Z +            "géométrie",
2026-02-20T22:09:16.0044310Z +            "triangle",
2026-02-20T22:09:16.0044634Z +            "cercle",
2026-02-20T22:09:16.0044999Z +            "carré",
2026-02-20T22:09:16.0045306Z +            "rectangle",
2026-02-20T22:09:16.0045656Z +            "forme",
2026-02-20T22:09:16.0045955Z +            "angle",
2026-02-20T22:09:16.0046255Z +            "fraction",
2026-02-20T22:09:16.0046588Z +            "graphique",
2026-02-20T22:09:16.0046911Z +            "courbe",
2026-02-20T22:09:16.0047229Z +            "polygone",
2026-02-20T22:09:16.0047548Z +            "losange",
2026-02-20T22:09:16.0047925Z +            "trapèze",
2026-02-20T22:09:16.0048228Z +            "cercle",
2026-02-20T22:09:16.0048536Z +            "ovale",
2026-02-20T22:09:16.0048824Z +            "ligne",
2026-02-20T22:09:16.0049121Z +            "point",
2026-02-20T22:09:16.0049412Z +            "segment",
2026-02-20T22:09:16.0049746Z +            "exercice",
2026-02-20T22:09:16.0050135Z +            "problème",
2026-02-20T22:09:16.0050444Z +        ]
2026-02-20T22:09:16.0050704Z +
2026-02-20T22:09:16.0051216Z          is_image_request = any(keyword in message.lower() for keyword in image_keywords)
2026-02-20T22:09:16.0052202Z -        is_math_related = any(keyword in message.lower() for keyword in math_image_keywords) or any(
2026-02-20T22:09:16.0053780Z -            keyword in message.lower() for keyword in ['math', 'mathématique', 'calcul', 'nombre', 'équation', 'exercice', 'problème']
2026-02-20T22:09:16.0054679Z -        )
2026-02-20T22:09:16.0054947Z -        
2026-02-20T22:09:16.0055226Z +        is_math_related = any(
2026-02-20T22:09:16.0055760Z +            keyword in message.lower() for keyword in math_image_keywords
2026-02-20T22:09:16.0056315Z +        ) or any(
2026-02-20T22:09:16.0056635Z +            keyword in message.lower()
2026-02-20T22:09:16.0057045Z +            for keyword in [
2026-02-20T22:09:16.0057641Z +                "math",
2026-02-20T22:09:16.0058054Z +                "mathématique",
2026-02-20T22:09:16.0058418Z +                "calcul",
2026-02-20T22:09:16.0058748Z +                "nombre",
2026-02-20T22:09:16.0059145Z +                "équation",
2026-02-20T22:09:16.0059560Z +                "exercice",
2026-02-20T22:09:16.0060180Z +                "problème",
2026-02-20T22:09:16.0060518Z +            ]
2026-02-20T22:09:16.0060780Z +        )
2026-02-20T22:09:16.0061031Z +
2026-02-20T22:09:16.0061576Z          # Si demande d'image ET mathématique, générer une image avec DALL-E
2026-02-20T22:09:16.0062551Z          # MAIS continuer avec la réponse texte complète pour avoir l'exercice résolvable
2026-02-20T22:09:16.0063395Z          image_url = None
2026-02-20T22:09:16.0063795Z          if is_image_request and is_math_related:
2026-02-20T22:09:16.0064233Z              try:
2026-02-20T22:09:16.0065004Z                  dalle_prompt = f"""Image éducative mathématique pour enfants de 5 à 20 ans : {message}. 
2026-02-20T22:09:16.0066192Z  Style simple, clair, coloré, adapté aux enfants. Éléments visuels mathématiques uniquement. 
2026-02-20T22:09:16.0067303Z  Pas de texte complexe, formes géométriques simples, couleurs vives et contrastées."""
2026-02-20T22:09:16.0067986Z -                
2026-02-20T22:09:16.0068261Z +
2026-02-20T22:09:16.0068643Z                  image_response = await client.images.generate(
2026-02-20T22:09:16.0069167Z                      model="dall-e-3",
2026-02-20T22:09:16.0069595Z                      prompt=dalle_prompt,
2026-02-20T22:09:16.0070021Z                      size="1024x1024",
2026-02-20T22:09:16.0070421Z                      quality="standard",
2026-02-20T22:09:16.0070824Z                      n=1,
2026-02-20T22:09:16.0071135Z                  )
2026-02-20T22:09:16.0071420Z -                
2026-02-20T22:09:16.0071694Z +
2026-02-20T22:09:16.0072018Z                  image_url = image_response.data[0].url
2026-02-20T22:09:16.0072859Z                  # Ne pas retourner immédiatement - continuer pour générer l'exercice complet
2026-02-20T22:09:16.0104231Z                  # L'image sera envoyée dans le stream avec la réponse texte complète
2026-02-20T22:09:16.0104952Z              except Exception as dalle_stream_error:
2026-02-20T22:09:16.0105795Z -                logger.error(f"Erreur génération image DALL-E: {str(dalle_stream_error)}")
2026-02-20T22:09:16.0106502Z +                logger.error(
2026-02-20T22:09:16.0107142Z +                    f"Erreur génération image DALL-E: {str(dalle_stream_error)}"
2026-02-20T22:09:16.0107710Z +                )
2026-02-20T22:09:16.0108085Z                  # Continuer avec le traitement texte normal
2026-02-20T22:09:16.0108581Z                  image_url = None
2026-02-20T22:09:16.0108949Z -        
2026-02-20T22:09:16.0109202Z +
2026-02-20T22:09:16.0109630Z          # Détecter la complexité pour smart routing
2026-02-20T22:09:16.0110263Z          complexity = _detect_complexity(message, conversation_history)
2026-02-20T22:09:16.0111004Z -        model = "gpt-4o-mini" if complexity == 'simple' else "gpt-4o"
2026-02-20T22:09:16.0111540Z -        
2026-02-20T22:09:16.0111946Z +        model = "gpt-4o-mini" if complexity == "simple" else "gpt-4o"
2026-02-20T22:09:16.0112463Z +
2026-02-20T22:09:16.0112866Z          # Détecter l'âge pour personnalisation
2026-02-20T22:09:16.0113546Z          estimated_age = _estimate_age(message)
2026-02-20T22:09:16.0113975Z -        
2026-02-20T22:09:16.0114237Z +
2026-02-20T22:09:16.0114638Z          # Construire le prompt système optimisé
2026-02-20T22:09:16.0115195Z          system_prompt = _build_system_prompt(estimated_age)
2026-02-20T22:09:16.0115676Z -        
2026-02-20T22:09:16.0115936Z +
2026-02-20T22:09:16.0116236Z          # Construire les messages pour OpenAI
2026-02-20T22:09:16.0116679Z -        messages = [
2026-02-20T22:09:16.0117073Z -            {"role": "system", "content": system_prompt}
2026-02-20T22:09:16.0117527Z -        ]
2026-02-20T22:09:16.0118034Z -        
2026-02-20T22:09:16.0118428Z +        messages = [{"role": "system", "content": system_prompt}]
2026-02-20T22:09:16.0118950Z +
2026-02-20T22:09:16.0119550Z          # Ajouter l'historique de conversation (limité aux 5 derniers messages)
2026-02-20T22:09:16.0120520Z          # Best practice : Limiter l'historique pour éviter dépassement de contexte
2026-02-20T22:09:16.0121437Z          for msg in conversation_history[-5:]:
2026-02-20T22:09:16.0121900Z -            messages.append({
2026-02-20T22:09:16.0122313Z -                "role": msg.get("role", "user"),
2026-02-20T22:09:16.0122786Z -                "content": msg.get("content", "")
2026-02-20T22:09:16.0123381Z -            })
2026-02-20T22:09:16.0123658Z -        
2026-02-20T22:09:16.0123945Z +            messages.append(
2026-02-20T22:09:16.0124467Z +                {"role": msg.get("role", "user"), "content": msg.get("content", "")}
2026-02-20T22:09:16.0125039Z +            )
2026-02-20T22:09:16.0125309Z +
2026-02-20T22:09:16.0125589Z          # Ajouter le message actuel
2026-02-20T22:09:16.0126004Z -        messages.append({
2026-02-20T22:09:16.0126356Z -            "role": "user",
2026-02-20T22:09:16.0126715Z -            "content": message
2026-02-20T22:09:16.0127062Z -        })
2026-02-20T22:09:16.0127322Z -        
2026-02-20T22:09:16.0127702Z +        messages.append({"role": "user", "content": message})
2026-02-20T22:09:16.0128219Z +
2026-02-20T22:09:16.0128643Z          # Paramètres optimisés selon la complexité
2026-02-20T22:09:16.0129466Z          # Augmenté max_tokens pour permettre des exercices complets et résolvables
2026-02-20T22:09:16.0130223Z -        temperature = 0.4 if complexity == 'simple' else 0.6
2026-02-20T22:09:16.0131174Z -        max_tokens = 500 if complexity == 'complex' else 400  # Augmenté pour exercices complets
2026-02-20T22:09:16.0131878Z -        
2026-02-20T22:09:16.0132240Z +        temperature = 0.4 if complexity == "simple" else 0.6
2026-02-20T22:09:16.0132744Z +        max_tokens = (
2026-02-20T22:09:16.0163410Z +            500 if complexity == "complex" else 400
2026-02-20T22:09:16.0164093Z +        )  # Augmenté pour exercices complets
2026-02-20T22:09:16.0164526Z +
2026-02-20T22:09:16.0164818Z          async def generate_stream():
2026-02-20T22:09:16.0165210Z              try:
2026-02-20T22:09:16.0165730Z                  # Si une image a été générée, l'envoyer en premier
2026-02-20T22:09:16.0166270Z                  if image_url:
2026-02-20T22:09:16.0166826Z                      yield f"data: {json.dumps({'type': 'image', 'url': image_url})}\n\n"
2026-02-20T22:09:16.0167429Z -                
2026-02-20T22:09:16.0167712Z +
2026-02-20T22:09:16.0168113Z                  # Envoyer un message de démarrage
2026-02-20T22:09:16.0168982Z                  yield f"data: {json.dumps({'type': 'status', 'message': 'Réflexion en cours...'})}\n\n"
2026-02-20T22:09:16.0169677Z -                
2026-02-20T22:09:16.0169953Z +
2026-02-20T22:09:16.0170321Z                  # Créer le stream OpenAI
2026-02-20T22:09:16.0170875Z                  stream = await client.chat.completions.create(
2026-02-20T22:09:16.0171386Z                      model=model,
2026-02-20T22:09:16.0171787Z                      messages=messages,
2026-02-20T22:09:16.0172246Z                      stream=True,  # Activer le streaming
2026-02-20T22:09:16.0172709Z @@ -469,70 +597,75 @@
2026-02-20T22:09:16.0173207Z                      max_tokens=max_tokens,
2026-02-20T22:09:16.0173640Z                      top_p=0.9,
2026-02-20T22:09:16.0174022Z                      frequency_penalty=0.3,
2026-02-20T22:09:16.0174469Z                      presence_penalty=0.1,
2026-02-20T22:09:16.0174877Z                  )
2026-02-20T22:09:16.0175160Z -                
2026-02-20T22:09:16.0175442Z +
2026-02-20T22:09:16.0175852Z                  # Stream chaque chunk de la réponse
2026-02-20T22:09:16.0176330Z                  full_response = ""
2026-02-20T22:09:16.0176740Z                  async for chunk in stream:
2026-02-20T22:09:16.0177416Z                      if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:16.0178276Z                          content = chunk.choices[0].delta.content
2026-02-20T22:09:16.0178810Z                          full_response += content
2026-02-20T22:09:16.0179413Z                          # Envoyer chaque chunk au client pour affichage progressif
2026-02-20T22:09:16.0180393Z                          yield f"data: {json.dumps({'type': 'chunk', 'content': content})}\n\n"
2026-02-20T22:09:16.0181024Z -                
2026-02-20T22:09:16.0181298Z +
2026-02-20T22:09:16.0181932Z                  # Nettoyer les placeholders d'images Markdown dans la réponse complète
2026-02-20T22:09:16.0182576Z                  import re
2026-02-20T22:09:16.0182908Z +
2026-02-20T22:09:16.0183353Z                  cleaned_response = re.sub(
2026-02-20T22:09:16.0184039Z -                    r'!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)',
2026-02-20T22:09:16.0184729Z -                    r'\1',
2026-02-20T22:09:16.0185333Z +                    r"!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)",
2026-02-20T22:09:16.0186010Z +                    r"\1",
2026-02-20T22:09:16.0186356Z                      full_response,
2026-02-20T22:09:16.0186760Z -                    flags=re.IGNORECASE
2026-02-20T22:09:16.0187188Z +                    flags=re.IGNORECASE,
2026-02-20T22:09:16.0187604Z                  )
2026-02-20T22:09:16.0187936Z                  cleaned_response = re.sub(
2026-02-20T22:09:16.0188362Z -                    r'!\[([^\]]*)\]\([^)]*\)',
2026-02-20T22:09:16.0189003Z -                    lambda m: m.group(1) if 'http' not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:16.0189648Z -                    cleaned_response
2026-02-20T22:09:16.0190035Z -                )
2026-02-20T22:09:16.0190317Z -                
2026-02-20T22:09:16.0190633Z +                    r"!\[([^\]]*)\]\([^)]*\)",
2026-02-20T22:09:16.0191047Z +                    lambda m: (
2026-02-20T22:09:16.0191584Z +                        m.group(1) if "http" not in m.group(0).lower() else m.group(0)
2026-02-20T22:09:16.0192158Z +                    ),
2026-02-20T22:09:16.0192489Z +                    cleaned_response,
2026-02-20T22:09:16.0192884Z +                )
2026-02-20T22:09:16.0213433Z +
2026-02-20T22:09:16.0214182Z                  # Si la réponse a été nettoyée, envoyer un chunk de correction si nécessaire
2026-02-20T22:09:16.0214942Z                  if cleaned_response != full_response:
2026-02-20T22:09:16.0215850Z                      # La réponse a déjà été envoyée chunk par chunk, donc on ne peut pas la modifier
2026-02-20T22:09:16.0216691Z                      # Mais on peut envoyer un message de fin avec indication
2026-02-20T22:09:16.0217255Z                      pass
2026-02-20T22:09:16.0217589Z -                
2026-02-20T22:09:16.0217880Z +
2026-02-20T22:09:16.0218356Z                  # Envoyer un message de fin avec métadonnées
2026-02-20T22:09:16.0219186Z                  yield f"data: {json.dumps({'type': 'done', 'model_used': model, 'complexity': complexity})}\n\n"
2026-02-20T22:09:16.0219967Z -                
2026-02-20T22:09:16.0220251Z +
2026-02-20T22:09:16.0220598Z              except Exception as stream_generation_error:
2026-02-20T22:09:16.0221349Z -                logger.error(f"Erreur dans generate_stream: {str(stream_generation_error)}")
2026-02-20T22:09:16.0222073Z +                logger.error(
2026-02-20T22:09:16.0222628Z +                    f"Erreur dans generate_stream: {str(stream_generation_error)}"
2026-02-20T22:09:16.0223368Z +                )
2026-02-20T22:09:16.0224107Z                  yield f"data: {json.dumps({'type': 'error', 'message': get_safe_error_message(stream_generation_error)})}\n\n"
2026-02-20T22:09:16.0224953Z -        
2026-02-20T22:09:16.0225234Z +
2026-02-20T22:09:16.0225522Z          return StreamingResponse(
2026-02-20T22:09:16.0225928Z              generate_stream(),
2026-02-20T22:09:16.0226344Z              media_type="text/event-stream",
2026-02-20T22:09:16.0227095Z              headers={
2026-02-20T22:09:16.0227463Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:16.0227928Z                  "Connection": "keep-alive",
2026-02-20T22:09:16.0228464Z                  "X-Accel-Buffering": "no",  # Important pour Nginx
2026-02-20T22:09:16.0228969Z -            }
2026-02-20T22:09:16.0229460Z -        )
2026-02-20T22:09:16.0229726Z -        
2026-02-20T22:09:16.0229987Z +            },
2026-02-20T22:09:16.0230273Z +        )
2026-02-20T22:09:16.0230524Z +
2026-02-20T22:09:16.0230828Z      except Exception as chat_stream_error:
2026-02-20T22:09:16.0231463Z          logger.error(f"Erreur dans chat_api_stream: {str(chat_stream_error)}")
2026-02-20T22:09:16.0232104Z          import traceback
2026-02-20T22:09:16.0232427Z +
2026-02-20T22:09:16.0232711Z          traceback.print_exc()
2026-02-20T22:09:16.0233403Z          err = chat_stream_error  # capture for closure (Flake8 F821)
2026-02-20T22:09:16.0233939Z  
2026-02-20T22:09:16.0234245Z          async def error_generator(exc=err):
2026-02-20T22:09:16.0234962Z              yield f"data: {json.dumps({'type': 'error', 'message': get_safe_error_message(exc)})}\n\n"
2026-02-20T22:09:16.0235692Z -        
2026-02-20T22:09:16.0235966Z +
2026-02-20T22:09:16.0236265Z          return StreamingResponse(
2026-02-20T22:09:16.0236687Z              error_generator(),
2026-02-20T22:09:16.0237112Z              media_type="text/event-stream",
2026-02-20T22:09:16.0237537Z              headers={
2026-02-20T22:09:16.0237907Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:16.0238370Z                  "Connection": "keep-alive",
2026-02-20T22:09:16.0238776Z -            }
2026-02-20T22:09:16.0239061Z -        )
2026-02-20T22:09:16.0239315Z -
2026-02-20T22:09:16.0239557Z +            },
2026-02-20T22:09:16.0239825Z +        )
2026-02-20T22:09:16.0240405Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py
2026-02-20T22:09:16.1774400Z --- /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:16.1776403Z +++ /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py	2026-02-20 22:09:16.164187+00:00
2026-02-20T22:09:16.1777718Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.1778181Z  """
2026-02-20T22:09:16.1778850Z  Handlers pour les défis logiques (API Starlette)
2026-02-20T22:09:16.1779339Z  """
2026-02-20T22:09:16.1779592Z +
2026-02-20T22:09:16.1779842Z  import json
2026-02-20T22:09:16.1780151Z  import traceback
2026-02-20T22:09:16.1780493Z  from datetime import datetime
2026-02-20T22:09:16.1780872Z  
2026-02-20T22:09:16.1781217Z  from app.core.logging_config import get_logger
2026-02-20T22:09:16.1781680Z @@ -11,14 +12,21 @@
2026-02-20T22:09:16.1782027Z  from starlette.requests import Request
2026-02-20T22:09:16.1782621Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:16.1783376Z  
2026-02-20T22:09:16.1783820Z  from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:16.1784463Z  from app.core.config import settings
2026-02-20T22:09:16.1784848Z +
2026-02-20T22:09:16.1785317Z  # Importer les constantes et fonctions centralisées
2026-02-20T22:09:16.1786376Z -from app.core.constants import (CHALLENGE_TYPES_API, CHALLENGE_TYPES_DB, normalize_age_group, calculate_difficulty_for_age_group)
2026-02-20T22:09:16.1787401Z +from app.core.constants import (
2026-02-20T22:09:16.1787819Z +    CHALLENGE_TYPES_API,
2026-02-20T22:09:16.1788172Z +    CHALLENGE_TYPES_DB,
2026-02-20T22:09:16.1788521Z +    normalize_age_group,
2026-02-20T22:09:16.1788889Z +    calculate_difficulty_for_age_group,
2026-02-20T22:09:16.1789297Z +)
2026-02-20T22:09:16.1789589Z  import app.core.constants as constants
2026-02-20T22:09:16.1790090Z  from app.core.messages import SystemMessages
2026-02-20T22:09:16.1790536Z +
2026-02-20T22:09:16.1791332Z  # NOTE: challenge_service_translations_adapter archivé - utiliser fonctions de challenge_service.py
2026-02-20T22:09:16.1824365Z  from app.services import challenge_service
2026-02-20T22:09:16.1824873Z  from app.utils.db_utils import db_session
2026-02-20T22:09:16.1825523Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:16.1826341Z  from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:16.1826943Z @@ -32,52 +40,70 @@
2026-02-20T22:09:16.1827741Z      Liste des défis logiques avec filtres optionnels.
2026-02-20T22:09:16.1828264Z      Route: GET /api/challenges
2026-02-20T22:09:16.1828640Z      """
2026-02-20T22:09:16.1829492Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py
2026-02-20T22:09:16.1830239Z      try:
2026-02-20T22:09:16.1830545Z          current_user = request.state.user
2026-02-20T22:09:16.1830963Z -        
2026-02-20T22:09:16.1831219Z +
2026-02-20T22:09:16.1831634Z          # Récupérer les paramètres de requête
2026-02-20T22:09:16.1832256Z -        challenge_type_raw = request.query_params.get('challenge_type')
2026-02-20T22:09:16.1833143Z -        age_group_raw = request.query_params.get('age_group')
2026-02-20T22:09:16.1834061Z -        search = request.query_params.get('search') or request.query_params.get('q')  # Support 'search' et 'q'
2026-02-20T22:09:16.1834961Z -        skip = int(request.query_params.get('skip', 0))
2026-02-20T22:09:16.1835532Z -        limit_param = request.query_params.get('limit')
2026-02-20T22:09:16.1836185Z +        challenge_type_raw = request.query_params.get("challenge_type")
2026-02-20T22:09:16.1836873Z +        age_group_raw = request.query_params.get("age_group")
2026-02-20T22:09:16.1837594Z +        search = request.query_params.get("search") or request.query_params.get(
2026-02-20T22:09:16.1838206Z +            "q"
2026-02-20T22:09:16.1838531Z +        )  # Support 'search' et 'q'
2026-02-20T22:09:16.1839000Z +        skip = int(request.query_params.get("skip", 0))
2026-02-20T22:09:16.1839558Z +        limit_param = request.query_params.get("limit")
2026-02-20T22:09:16.1840107Z          limit = int(limit_param) if limit_param else 20
2026-02-20T22:09:16.1840813Z -        active_only = request.query_params.get('active_only', 'true').lower() == 'true'
2026-02-20T22:09:16.1841624Z -        order = (request.query_params.get('order') or 'random').lower()
2026-02-20T22:09:16.1842470Z -        hide_completed = request.query_params.get('hide_completed', 'false').lower() == 'true'
2026-02-20T22:09:16.1843349Z -        
2026-02-20T22:09:16.1843849Z +        active_only = request.query_params.get("active_only", "true").lower() == "true"
2026-02-20T22:09:16.1844645Z +        order = (request.query_params.get("order") or "random").lower()
2026-02-20T22:09:16.1845201Z +        hide_completed = (
2026-02-20T22:09:16.1845766Z +            request.query_params.get("hide_completed", "false").lower() == "true"
2026-02-20T22:09:16.1846372Z +        )
2026-02-20T22:09:16.1846624Z +
2026-02-20T22:09:16.1847061Z          # Normaliser les filtres pour correspondre aux valeurs PostgreSQL
2026-02-20T22:09:16.1848071Z -        challenge_type = constants.normalize_challenge_type(challenge_type_raw) if challenge_type_raw else None
2026-02-20T22:09:16.1848931Z +        challenge_type = (
2026-02-20T22:09:16.1849425Z +            constants.normalize_challenge_type(challenge_type_raw)
2026-02-20T22:09:16.1850047Z +            if challenge_type_raw
2026-02-20T22:09:16.1850439Z +            else None
2026-02-20T22:09:16.1850764Z +        )
2026-02-20T22:09:16.1851275Z          # Utiliser normalize_age_group_for_db pour obtenir la valeur ENUM PostgreSQL
2026-02-20T22:09:16.1852132Z          from app.services.challenge_service import normalize_age_group_for_db
2026-02-20T22:09:16.1853176Z -        age_group_db = normalize_age_group_for_db(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1854254Z -        age_group = normalize_age_group(age_group_raw) if age_group_raw else None  # Format string pour logs
2026-02-20T22:09:16.1855018Z -        
2026-02-20T22:09:16.1855281Z +
2026-02-20T22:09:16.1855540Z +        age_group_db = (
2026-02-20T22:09:16.1856315Z +            normalize_age_group_for_db(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1856913Z +        )
2026-02-20T22:09:16.1857178Z +        age_group = (
2026-02-20T22:09:16.1857656Z +            normalize_age_group(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1858429Z +        )  # Format string pour logs
2026-02-20T22:09:16.1858818Z +
2026-02-20T22:09:16.1859272Z          # Calculer la page à partir de skip et limit
2026-02-20T22:09:16.1859831Z          page = (skip // limit) + 1 if limit > 0 else 1
2026-02-20T22:09:16.1860275Z -        
2026-02-20T22:09:16.1860537Z +
2026-02-20T22:09:16.1861018Z          # Récupérer la locale depuis le header Accept-Language
2026-02-20T22:09:16.1861714Z -        accept_language = request.headers.get('Accept-Language', 'fr')
2026-02-20T22:09:16.1862462Z +        accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.1863286Z          locale = parse_accept_language(accept_language)
2026-02-20T22:09:16.1863770Z  
2026-02-20T22:09:16.1864735Z -        logger.debug(f"API - Paramètres reçus: limit={limit}, skip={skip}, page={page}, order={order}, hide_completed={hide_completed}")
2026-02-20T22:09:16.1865656Z +        logger.debug(
2026-02-20T22:09:16.1866564Z +            f"API - Paramètres reçus: limit={limit}, skip={skip}, page={page}, order={order}, hide_completed={hide_completed}"
2026-02-20T22:09:16.1867405Z +        )
2026-02-20T22:09:16.1867661Z  
2026-02-20T22:09:16.1868015Z          # IDs à exclure si hide_completed
2026-02-20T22:09:16.1868456Z          exclude_ids = []
2026-02-20T22:09:16.1868808Z          if hide_completed:
2026-02-20T22:09:16.1869205Z              user_id = current_user.get("id")
2026-02-20T22:09:16.1869628Z              if user_id:
2026-02-20T22:09:16.1870059Z                  from server.database import get_db_connection
2026-02-20T22:09:16.1870529Z +
2026-02-20T22:09:16.1870810Z                  conn = get_db_connection()
2026-02-20T22:09:16.1871257Z                  cursor = conn.cursor()
2026-02-20T22:09:16.1871643Z                  try:
2026-02-20T22:09:16.1871972Z                      cursor.execute(
2026-02-20T22:09:16.1872792Z                          "SELECT DISTINCT challenge_id FROM logic_challenge_attempts WHERE user_id = %s AND is_correct = true",
2026-02-20T22:09:16.1873830Z -                        (user_id,)
2026-02-20T22:09:16.1874214Z +                        (user_id,),
2026-02-20T22:09:16.1874589Z                      )
2026-02-20T22:09:16.1875106Z -                    exclude_ids = [row[0] for row in cursor.fetchall() if row[0] is not None]
2026-02-20T22:09:16.1875748Z +                    exclude_ids = [
2026-02-20T22:09:16.1876266Z +                        row[0] for row in cursor.fetchall() if row[0] is not None
2026-02-20T22:09:16.1876798Z +                    ]
2026-02-20T22:09:16.1877111Z                  finally:
2026-02-20T22:09:16.1877451Z                      cursor.close()
2026-02-20T22:09:16.1877835Z                      conn.close()
2026-02-20T22:09:16.1878201Z  
2026-02-20T22:09:16.1878530Z          # Utiliser le service ORM challenge_service
2026-02-20T22:09:16.1878985Z @@ -89,14 +115,15 @@
2026-02-20T22:09:16.1879399Z                  age_group=age_group_db,  # Utiliser la valeur ENUM DB
2026-02-20T22:09:16.1880025Z                  tags=search,  # Utiliser search comme filtre tags
2026-02-20T22:09:16.1880535Z                  limit=limit,
2026-02-20T22:09:16.1880900Z                  offset=skip,
2026-02-20T22:09:16.1881253Z                  order=order,
2026-02-20T22:09:16.1881701Z -                exclude_ids=exclude_ids if exclude_ids else None
2026-02-20T22:09:16.1882296Z +                exclude_ids=exclude_ids if exclude_ids else None,
2026-02-20T22:09:16.1882779Z              )
2026-02-20T22:09:16.1883452Z              # Convertir les objets en dicts avec normalisation age_group pour frontend
2026-02-20T22:09:16.1884343Z              from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:16.1885226Z +
2026-02-20T22:09:16.1885496Z              challenges_list = [
2026-02-20T22:09:16.1885863Z                  {
2026-02-20T22:09:16.1886158Z                      "id": c.id,
2026-02-20T22:09:16.1886531Z                      "title": c.title,
2026-02-20T22:09:16.1886955Z                      "description": c.description,
2026-02-20T22:09:16.1887567Z @@ -106,57 +133,68 @@
2026-02-20T22:09:16.1887894Z                      "tags": c.tags,
2026-02-20T22:09:16.1888339Z                      "difficulty_rating": c.difficulty_rating,
2026-02-20T22:09:16.1888952Z                      "estimated_time_minutes": c.estimated_time_minutes,
2026-02-20T22:09:16.1889514Z                      "success_rate": c.success_rate,
2026-02-20T22:09:16.1889985Z                      "view_count": c.view_count,
2026-02-20T22:09:16.1890447Z -                    "is_archived": c.is_archived
2026-02-20T22:09:16.1890912Z -                } for c in challenges
2026-02-20T22:09:16.1891340Z +                    "is_archived": c.is_archived,
2026-02-20T22:09:16.1891771Z +                }
2026-02-20T22:09:16.1892073Z +                for c in challenges
2026-02-20T22:09:16.1892441Z              ]
2026-02-20T22:09:16.1892717Z -            
2026-02-20T22:09:16.1893135Z +
2026-02-20T22:09:16.1893642Z              # Compter le total pour la pagination (même session)
2026-02-20T22:09:16.1894253Z              total = challenge_service.count_challenges(
2026-02-20T22:09:16.1894725Z                  db=db,
2026-02-20T22:09:16.1895087Z                  challenge_type=challenge_type,
2026-02-20T22:09:16.1895548Z                  age_group=age_group_db,
2026-02-20T22:09:16.1896048Z -                exclude_ids=exclude_ids if exclude_ids else None
2026-02-20T22:09:16.1896643Z +                exclude_ids=exclude_ids if exclude_ids else None,
2026-02-20T22:09:16.1897131Z              )
2026-02-20T22:09:16.1897395Z -        
2026-02-20T22:09:16.1897652Z +
2026-02-20T22:09:16.1898389Z          # Filtrer les défis archivés si nécessaire (déjà fait dans la query, mais double vérification)
2026-02-20T22:09:16.1899151Z          if active_only:
2026-02-20T22:09:16.1899729Z -            challenges_list = [c for c in challenges_list if not c.get('is_archived', False)]
2026-02-20T22:09:16.1900413Z +            challenges_list = [
2026-02-20T22:09:16.1900931Z +                c for c in challenges_list if not c.get("is_archived", False)
2026-02-20T22:09:16.1901485Z +            ]
2026-02-20T22:09:16.1901754Z  
2026-02-20T22:09:16.1902085Z          # Log pour déboguer
2026-02-20T22:09:16.1903238Z -        logger.debug(f"API - Retour de {len(challenges_list)} défis sur {total} total (limit demandé: {limit}, page: {page})")
2026-02-20T22:09:16.1904189Z +        logger.debug(
2026-02-20T22:09:16.1905055Z +            f"API - Retour de {len(challenges_list)} défis sur {total} total (limit demandé: {limit}, page: {page})"
2026-02-20T22:09:16.1905778Z +        )
2026-02-20T22:09:16.1906064Z          if len(challenges_list) > 0:
2026-02-20T22:09:16.1907096Z -            logger.debug(f"API - Premier défi: id={challenges_list[0].get('id')}, title={challenges_list[0].get('title')}")
2026-02-20T22:09:16.1907947Z -        
2026-02-20T22:09:16.1908272Z +            logger.debug(
2026-02-20T22:09:16.1909182Z +                f"API - Premier défi: id={challenges_list[0].get('id')}, title={challenges_list[0].get('title')}"
2026-02-20T22:09:16.1909994Z +            )
2026-02-20T22:09:16.1910282Z +
2026-02-20T22:09:16.1910742Z          # Retourner le format paginé standardisé
2026-02-20T22:09:16.1911265Z          has_more = (skip + len(challenges_list)) < total
2026-02-20T22:09:16.1911718Z -        
2026-02-20T22:09:16.1911989Z +
2026-02-20T22:09:16.1912257Z          response_data = {
2026-02-20T22:09:16.1912642Z              "items": challenges_list,
2026-02-20T22:09:16.1913277Z              "total": total,
2026-02-20T22:09:16.1913666Z              "page": page,
2026-02-20T22:09:16.1914021Z              "limit": limit,
2026-02-20T22:09:16.1914401Z -            "hasMore": has_more
2026-02-20T22:09:16.1915088Z +            "hasMore": has_more,
2026-02-20T22:09:16.1915469Z          }
2026-02-20T22:09:16.1915739Z  
2026-02-20T22:09:16.1916693Z -        logger.info(f"Récupération réussie de {len(challenges_list)} défis logiques sur {total} total (locale: {locale})")
2026-02-20T22:09:16.1917621Z +        logger.info(
2026-02-20T22:09:16.1918803Z +            f"Récupération réussie de {len(challenges_list)} défis logiques sur {total} total (locale: {locale})"
2026-02-20T22:09:16.1919624Z +        )
2026-02-20T22:09:16.1919955Z          return JSONResponse(response_data)
2026-02-20T22:09:16.1920485Z      except ValueError as filter_validation_error:
2026-02-20T22:09:16.1921404Z          logger.error(f"Erreur de validation des paramètres: {filter_validation_error}")
2026-02-20T22:09:16.1922188Z          return ErrorHandler.create_validation_error(
2026-02-20T22:09:16.1922748Z              errors=[str(filter_validation_error)],
2026-02-20T22:09:16.1923714Z -            user_message="Les paramètres de filtrage sont invalides."
2026-02-20T22:09:16.1924604Z +            user_message="Les paramètres de filtrage sont invalides.",
2026-02-20T22:09:16.1925170Z          )
2026-02-20T22:09:16.1925552Z      except Exception as challenges_retrieval_error:
2026-02-20T22:09:16.1926531Z -        logger.error(f"Erreur lors de la récupération des défis: {challenges_retrieval_error}")
2026-02-20T22:09:16.1927297Z +        logger.error(
2026-02-20T22:09:16.1928019Z +            f"Erreur lors de la récupération des défis: {challenges_retrieval_error}"
2026-02-20T22:09:16.1928652Z +        )
2026-02-20T22:09:16.1928995Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.1929527Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.1930058Z              error=challenges_retrieval_error,
2026-02-20T22:09:16.1930515Z              status_code=500,
2026-02-20T22:09:16.1931181Z -            user_message="Erreur lors de la récupération des défis."
2026-02-20T22:09:16.1932032Z +            user_message="Erreur lors de la récupération des défis.",
2026-02-20T22:09:16.1932567Z          )
2026-02-20T22:09:16.1932833Z  
2026-02-20T22:09:16.1933269Z  
2026-02-20T22:09:16.1933539Z  @require_auth
2026-02-20T22:09:16.1933896Z  async def get_challenge(request: Request):
2026-02-20T22:09:16.1934340Z @@ -164,28 +202,35 @@
2026-02-20T22:09:16.1934848Z      Récupère un défi logique par son ID.
2026-02-20T22:09:16.1935358Z      Route: GET /api/challenges/{challenge_id}
2026-02-20T22:09:16.1935817Z      """
2026-02-20T22:09:16.1936083Z      try:
2026-02-20T22:09:16.1936400Z          current_user = request.state.user
2026-02-20T22:09:16.1936835Z -        
2026-02-20T22:09:16.1937294Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.1937873Z -        
2026-02-20T22:09:16.1938151Z +
2026-02-20T22:09:16.1938582Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.1939140Z +
2026-02-20T22:09:16.1939687Z          # Récupérer la locale depuis le header Accept-Language
2026-02-20T22:09:16.1940436Z -        accept_language = request.headers.get('Accept-Language', 'fr')
2026-02-20T22:09:16.1941215Z +        accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.1941897Z          locale = parse_accept_language(accept_language)
2026-02-20T22:09:16.1942408Z -        
2026-02-20T22:09:16.1942679Z +
2026-02-20T22:09:16.1943212Z          # Utiliser le service ORM challenge_service
2026-02-20T22:09:16.1943723Z          async with db_session() as db:
2026-02-20T22:09:16.1944401Z              # Récupérer le challenge via get_challenge_by_id
2026-02-20T22:09:16.1945067Z              from app.models.logic_challenge import LogicChallenge
2026-02-20T22:09:16.1945969Z -            challenge = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:16.1946747Z +
2026-02-20T22:09:16.1947026Z +            challenge = (
2026-02-20T22:09:16.1947428Z +                db.query(LogicChallenge)
2026-02-20T22:09:16.1948236Z +                .filter(LogicChallenge.id == challenge_id)
2026-02-20T22:09:16.1948749Z +                .first()
2026-02-20T22:09:16.1949082Z +            )
2026-02-20T22:09:16.1949398Z              if challenge:
2026-02-20T22:09:16.1949861Z                  from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:16.1950701Z  
2026-02-20T22:09:16.1951048Z                  # Normaliser age_group pour le frontend
2026-02-20T22:09:16.1951797Z -                from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:16.1952508Z -                
2026-02-20T22:09:16.1952920Z +                from app.services.challenge_service import (
2026-02-20T22:09:16.1953693Z +                    normalize_age_group_for_frontend,
2026-02-20T22:09:16.1954160Z +                )
2026-02-20T22:09:16.1954462Z +
2026-02-20T22:09:16.1954743Z                  challenge_dict = {
2026-02-20T22:09:16.1955178Z                      "id": challenge.id,
2026-02-20T22:09:16.1955647Z                      "title": challenge.title,
2026-02-20T22:09:16.1956156Z                      "description": challenge.description,
2026-02-20T22:09:16.1956738Z                      "challenge_type": challenge.challenge_type,
2026-02-20T22:09:16.1957219Z @@ -201,36 +246,39 @@
2026-02-20T22:09:16.1957601Z                      "difficulty_rating": challenge.difficulty_rating,
2026-02-20T22:09:16.1958194Z                      "estimated_time_minutes": challenge.estimated_time_minutes,
2026-02-20T22:09:16.1958789Z                      "success_rate": challenge.success_rate,
2026-02-20T22:09:16.1959246Z                      "view_count": challenge.view_count,
2026-02-20T22:09:16.1959687Z                      "is_active": challenge.is_active,
2026-02-20T22:09:16.1960135Z -                    "is_archived": challenge.is_archived
2026-02-20T22:09:16.1960593Z +                    "is_archived": challenge.is_archived,
2026-02-20T22:09:16.1960999Z                  }
2026-02-20T22:09:16.1961261Z              else:
2026-02-20T22:09:16.1961557Z                  challenge_dict = None
2026-02-20T22:09:16.1961912Z -        
2026-02-20T22:09:16.1962142Z +
2026-02-20T22:09:16.1962378Z          if not challenge_dict:
2026-02-20T22:09:16.1962777Z              return ErrorHandler.create_not_found_error(
2026-02-20T22:09:16.1963603Z -                resource_type="Défi logique",
2026-02-20T22:09:16.1964061Z -                resource_id=challenge_id
2026-02-20T22:09:16.1964711Z +                resource_type="Défi logique", resource_id=challenge_id
2026-02-20T22:09:16.1965196Z              )
2026-02-20T22:09:16.1965433Z -        
2026-02-20T22:09:16.1966012Z -        logger.info(f"Récupération réussie du défi logique {challenge_id} (locale: {locale})")
2026-02-20T22:09:16.1966568Z +
2026-02-20T22:09:16.1966808Z +        logger.info(
2026-02-20T22:09:16.1967491Z +            f"Récupération réussie du défi logique {challenge_id} (locale: {locale})"
2026-02-20T22:09:16.1968142Z +        )
2026-02-20T22:09:16.1985443Z          return JSONResponse(challenge_dict)
2026-02-20T22:09:16.1986011Z      except ValueError as id_validation_error:
2026-02-20T22:09:16.1986657Z          logger.error(f"Erreur de validation: {id_validation_error}")
2026-02-20T22:09:16.1987338Z          return ErrorHandler.create_validation_error(
2026-02-20T22:09:16.1988018Z              errors=["ID de défi invalide"],
2026-02-20T22:09:16.1988735Z -            user_message="L'identifiant du défi est invalide."
2026-02-20T22:09:16.1989478Z +            user_message="L'identifiant du défi est invalide.",
2026-02-20T22:09:16.1989995Z          )
2026-02-20T22:09:16.1990365Z      except Exception as challenge_retrieval_error:
2026-02-20T22:09:16.1991318Z -        logger.error(f"Erreur lors de la récupération du défi: {challenge_retrieval_error}")
2026-02-20T22:09:16.1992075Z +        logger.error(
2026-02-20T22:09:16.1992758Z +            f"Erreur lors de la récupération du défi: {challenge_retrieval_error}"
2026-02-20T22:09:16.1993592Z +        )
2026-02-20T22:09:16.1994282Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.1994827Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.1995355Z              error=challenge_retrieval_error,
2026-02-20T22:09:16.1995828Z              status_code=500,
2026-02-20T22:09:16.1996489Z -            user_message="Erreur lors de la récupération du défi."
2026-02-20T22:09:16.1997547Z +            user_message="Erreur lors de la récupération du défi.",
2026-02-20T22:09:16.1998098Z          )
2026-02-20T22:09:16.1998367Z  
2026-02-20T22:09:16.1998624Z  
2026-02-20T22:09:16.1998880Z  @require_auth
2026-02-20T22:09:16.1999293Z  async def submit_challenge_answer(request: Request):
2026-02-20T22:09:16.1999802Z @@ -238,154 +286,222 @@
2026-02-20T22:09:16.2000296Z      Soumet une réponse à un défi logique.
2026-02-20T22:09:16.2000826Z      Route: POST /api/challenges/{challenge_id}/attempt
2026-02-20T22:09:16.2001317Z      """
2026-02-20T22:09:16.2001597Z      try:
2026-02-20T22:09:16.2001925Z          current_user = request.state.user
2026-02-20T22:09:16.2002350Z -        
2026-02-20T22:09:16.2002601Z +
2026-02-20T22:09:16.2002907Z          user_id = current_user.get("id")
2026-02-20T22:09:16.2003528Z          if not user_id:
2026-02-20T22:09:16.2004095Z              return JSONResponse({"error": "Utilisateur invalide"}, status_code=401)
2026-02-20T22:09:16.2004749Z -        
2026-02-20T22:09:16.2005198Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2005780Z +
2026-02-20T22:09:16.2006214Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2006832Z          data = await request.json()
2026-02-20T22:09:16.2007234Z -        
2026-02-20T22:09:16.2007699Z -        user_solution = data.get('user_solution') or data.get('answer')
2026-02-20T22:09:16.2008339Z -        time_spent = data.get('time_spent')
2026-02-20T22:09:16.2008866Z -        hints_used_raw = data.get('hints_used', [])
2026-02-20T22:09:16.2009332Z -        
2026-02-20T22:09:16.2009614Z +
2026-02-20T22:09:16.2010046Z +        user_solution = data.get("user_solution") or data.get("answer")
2026-02-20T22:09:16.2010675Z +        time_spent = data.get("time_spent")
2026-02-20T22:09:16.2011188Z +        hints_used_raw = data.get("hints_used", [])
2026-02-20T22:09:16.2011643Z +
2026-02-20T22:09:16.2012284Z          # Convertir hints_used de liste à entier (nombre d'indices utilisés)
2026-02-20T22:09:16.2013304Z          # Le modèle attend un Integer, pas une liste
2026-02-20T22:09:16.2013864Z          if isinstance(hints_used_raw, list):
2026-02-20T22:09:16.2014370Z              hints_used_count = len(hints_used_raw)
2026-02-20T22:09:16.2014898Z          elif isinstance(hints_used_raw, int):
2026-02-20T22:09:16.2015397Z              hints_used_count = hints_used_raw
2026-02-20T22:09:16.2015824Z          else:
2026-02-20T22:09:16.2016133Z              hints_used_count = 0
2026-02-20T22:09:16.2016514Z -        
2026-02-20T22:09:16.2016787Z +
2026-02-20T22:09:16.2017073Z          if not user_solution:
2026-02-20T22:09:16.2017839Z              return JSONResponse({"error": "Réponse requise"}, status_code=400)
2026-02-20T22:09:16.2018462Z -        
2026-02-20T22:09:16.2018751Z +
2026-02-20T22:09:16.2019047Z          async with db_session() as db:
2026-02-20T22:09:16.2019605Z              # Récupérer le défi
2026-02-20T22:09:16.2020227Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:16.2020878Z              if not challenge:
2026-02-20T22:09:16.2021693Z -                return JSONResponse({"error": "Défi logique non trouvé"}, status_code=404)
2026-02-20T22:09:16.2022358Z -            
2026-02-20T22:09:16.2022679Z +                return JSONResponse(
2026-02-20T22:09:16.2023546Z +                    {"error": "Défi logique non trouvé"}, status_code=404
2026-02-20T22:09:16.2024092Z +                )
2026-02-20T22:09:16.2024397Z +
2026-02-20T22:09:16.2024793Z              # Vérifier la réponse
2026-02-20T22:09:16.2025283Z              def _normalize_accents(text: str) -> str:
2026-02-20T22:09:16.2026403Z                  """Retire les accents pour tolérance (carré→carre, élève→eleve)."""
2026-02-20T22:09:16.2027068Z                  import unicodedata
2026-02-20T22:09:16.2027481Z -                return ''.join(
2026-02-20T22:09:16.2027970Z -                    c for c in unicodedata.normalize('NFD', text)
2026-02-20T22:09:16.2028789Z -                    if unicodedata.category(c) != 'Mn'
2026-02-20T22:09:16.2029295Z -                ) if text else ''
2026-02-20T22:09:16.2029674Z +
2026-02-20T22:09:16.2029937Z +                return (
2026-02-20T22:09:16.2030289Z +                    "".join(
2026-02-20T22:09:16.2030712Z +                        c
2026-02-20T22:09:16.2031165Z +                        for c in unicodedata.normalize("NFD", text)
2026-02-20T22:09:16.2031755Z +                        if unicodedata.category(c) != "Mn"
2026-02-20T22:09:16.2032230Z +                    )
2026-02-20T22:09:16.2032561Z +                    if text
2026-02-20T22:09:16.2032947Z +                    else ""
2026-02-20T22:09:16.2033469Z +                )
2026-02-20T22:09:16.2033767Z  
2026-02-20T22:09:16.2034128Z              def _normalize_shape_answer(text: str) -> str:
2026-02-20T22:09:16.2034837Z                  """Normalise pour VISUAL : synonymes, accents, ordre forme+couleur."""
2026-02-20T22:09:16.2035520Z                  if not text:
2026-02-20T22:09:16.2035883Z -                    return ''
2026-02-20T22:09:16.2036253Z +                    return ""
2026-02-20T22:09:16.2036637Z                  t = text.lower().strip()
2026-02-20T22:09:16.2037326Z -                for old, new in [('rectangle', 'carre'), ('square', 'carre'), ('circle', 'cercle'),
2026-02-20T22:09:16.2038430Z -                                 ('carré', 'carre'), ('étoile', 'etoile'), ('losange', 'losange')]:
2026-02-20T22:09:16.2039108Z +                for old, new in [
2026-02-20T22:09:16.2039538Z +                    ("rectangle", "carre"),
2026-02-20T22:09:16.2040001Z +                    ("square", "carre"),
2026-02-20T22:09:16.2040466Z +                    ("circle", "cercle"),
2026-02-20T22:09:16.2041017Z +                    ("carré", "carre"),
2026-02-20T22:09:16.2041559Z +                    ("étoile", "etoile"),
2026-02-20T22:09:16.2042010Z +                    ("losange", "losange"),
2026-02-20T22:09:16.2042455Z +                ]:
2026-02-20T22:09:16.2042776Z                      if old in t:
2026-02-20T22:09:16.2043388Z                          t = t.replace(old, new)
2026-02-20T22:09:16.2043876Z                  t = _normalize_accents(t)
2026-02-20T22:09:16.2044507Z                  # Accepter "bleu carre" ou "carre bleu" -> normaliser en "carre bleu"
2026-02-20T22:09:16.2045174Z                  mots = t.split()
2026-02-20T22:09:16.2045931Z -                formes = {'carre', 'cercle', 'triangle', 'rectangle', 'losange', 'etoile', 'hexagone', 'pentagone'}
2026-02-20T22:09:16.2047230Z -                couleurs = {'rouge', 'bleu', 'vert', 'jaune', 'orange', 'violet', 'rose', 'gris', 'noir', 'blanc', 'red', 'blue', 'green', 'yellow'}
2026-02-20T22:09:16.2048174Z +                formes = {
2026-02-20T22:09:16.2048542Z +                    "carre",
2026-02-20T22:09:16.2048923Z +                    "cercle",
2026-02-20T22:09:16.2049291Z +                    "triangle",
2026-02-20T22:09:16.2049679Z +                    "rectangle",
2026-02-20T22:09:16.2050151Z +                    "losange",
2026-02-20T22:09:16.2050533Z +                    "etoile",
2026-02-20T22:09:16.2050902Z +                    "hexagone",
2026-02-20T22:09:16.2051296Z +                    "pentagone",
2026-02-20T22:09:16.2051670Z +                }
2026-02-20T22:09:16.2051991Z +                couleurs = {
2026-02-20T22:09:16.2052360Z +                    "rouge",
2026-02-20T22:09:16.2052714Z +                    "bleu",
2026-02-20T22:09:16.2053250Z +                    "vert",
2026-02-20T22:09:16.2053607Z +                    "jaune",
2026-02-20T22:09:16.2053966Z +                    "orange",
2026-02-20T22:09:16.2054593Z +                    "violet",
2026-02-20T22:09:16.2054948Z +                    "rose",
2026-02-20T22:09:16.2055289Z +                    "gris",
2026-02-20T22:09:16.2055718Z +                    "noir",
2026-02-20T22:09:16.2056061Z +                    "blanc",
2026-02-20T22:09:16.2056420Z +                    "red",
2026-02-20T22:09:16.2056972Z +                    "blue",
2026-02-20T22:09:16.2057322Z +                    "green",
2026-02-20T22:09:16.2057685Z +                    "yellow",
2026-02-20T22:09:16.2058020Z +                }
2026-02-20T22:09:16.2058341Z                  f, c = None, None
2026-02-20T22:09:16.2058727Z                  for m in mots:
2026-02-20T22:09:16.2059112Z                      if m in formes:
2026-02-20T22:09:16.2059501Z                          f = m
2026-02-20T22:09:16.2059891Z                      elif m in couleurs:
2026-02-20T22:09:16.2060305Z                          c = m
2026-02-20T22:09:16.2060657Z                  if f and c:
2026-02-20T22:09:16.2061028Z -                    t = f'{f} {c}'
2026-02-20T22:09:16.2061501Z +                    t = f"{f} {c}"
2026-02-20T22:09:16.2061898Z                  return t
2026-02-20T22:09:16.2062220Z  
2026-02-20T22:09:16.2062601Z              def _parse_multi_visual_answer(text: str) -> list:
2026-02-20T22:09:16.2063591Z                  """Parse multi-cellules VISUAL. Formats acceptés :
2026-02-20T22:09:16.2064430Z                  - 'Position 6: carré bleu, Position 9: triangle vert'
2026-02-20T22:09:16.2065201Z                  - '6:cercle rouge,9:étoile jaune' (format IA)
2026-02-20T22:09:16.2065726Z                  """
2026-02-20T22:09:16.2066107Z                  if not text or not text.strip():
2026-02-20T22:09:16.2066569Z                      return []
2026-02-20T22:09:16.2066953Z                  parts = []
2026-02-20T22:09:16.2067422Z -                for segment in text.replace(',', ' , ').split(','):
2026-02-20T22:09:16.2068084Z +                for segment in text.replace(",", " , ").split(","):
2026-02-20T22:09:16.2068679Z                      segment = segment.strip()
2026-02-20T22:09:16.2069152Z                      if not segment:
2026-02-20T22:09:16.2069574Z                          continue
2026-02-20T22:09:16.2070019Z                      # Format "Position 6: xxx" ou "6: xxx"
2026-02-20T22:09:16.2070522Z -                    if ':' in segment:
2026-02-20T22:09:16.2071049Z -                        pos_part, ans_part = segment.split(':', 1)
2026-02-20T22:09:16.2071581Z +                    if ":" in segment:
2026-02-20T22:09:16.2072088Z +                        pos_part, ans_part = segment.split(":", 1)
2026-02-20T22:09:16.2072663Z                          ans_part = ans_part.strip()
2026-02-20T22:09:16.2073461Z -                        pos_digits = ''.join(c for c in pos_part if c.isdigit())
2026-02-20T22:09:16.2074193Z +                        pos_digits = "".join(c for c in pos_part if c.isdigit())
2026-02-20T22:09:16.2074922Z                          if pos_digits and ans_part and not ans_part.isdigit():
2026-02-20T22:09:16.2075882Z                              # Segment ressemble à "6:cercle rouge" ou "Position 6: cercle rouge"
2026-02-20T22:09:16.2076790Z -                            parts.append((int(pos_digits), _normalize_shape_answer(ans_part)))
2026-02-20T22:09:16.2077492Z +                            parts.append(
2026-02-20T22:09:16.2078083Z +                                (int(pos_digits), _normalize_shape_answer(ans_part))
2026-02-20T22:09:16.2078674Z +                            )
2026-02-20T22:09:16.2079052Z                              continue
2026-02-20T22:09:16.2079590Z                      parts.append((0, _normalize_shape_answer(segment)))
2026-02-20T22:09:16.2080149Z                  if parts:
2026-02-20T22:09:16.2080523Z                      return parts
2026-02-20T22:09:16.2081090Z                  return [(0, _normalize_shape_answer(text))] if text.strip() else []
2026-02-20T22:09:16.2081702Z  
2026-02-20T22:09:16.2082392Z              # Fonction helper pour parser une réponse (gère format liste Python et CSV)
2026-02-20T22:09:16.2083629Z              def parse_answer_to_list(answer: str) -> list:
2026-02-20T22:09:16.2084482Z                  """Parse une réponse en liste, gérant plusieurs formats."""
2026-02-20T22:09:16.2085110Z                  answer = str(answer).strip()
2026-02-20T22:09:16.2085545Z -                
2026-02-20T22:09:16.2086074Z +
2026-02-20T22:09:16.2086488Z                  # Format liste Python : "['Rouge', 'Vert', 'Jaune', 'Bleu']"
2026-02-20T22:09:16.2087170Z -                if answer.startswith('[') and answer.endswith(']'):
2026-02-20T22:09:16.2087815Z +                if answer.startswith("[") and answer.endswith("]"):
2026-02-20T22:09:16.2088345Z                      try:
2026-02-20T22:09:16.2088691Z                          import ast
2026-02-20T22:09:16.2089063Z +
2026-02-20T22:09:16.2089392Z                          parsed = ast.literal_eval(answer)
2026-02-20T22:09:16.2089927Z                          if isinstance(parsed, list):
2026-02-20T22:09:16.2090550Z                              return [str(item).strip().lower() for item in parsed]
2026-02-20T22:09:16.2091184Z                      except (ValueError, SyntaxError):
2026-02-20T22:09:16.2091652Z                          pass
2026-02-20T22:09:16.2092158Z                      # Fallback: retirer les crochets et parser manuellement
2026-02-20T22:09:16.2092749Z                      inner = answer[1:-1]
2026-02-20T22:09:16.2093591Z                      # Retirer les quotes autour de chaque élément
2026-02-20T22:09:16.2094125Z                      items = []
2026-02-20T22:09:16.2094540Z -                    for item in inner.split(','):
2026-02-20T22:09:16.2095048Z +                    for item in inner.split(","):
2026-02-20T22:09:16.2095635Z                          item = item.strip().strip("'").strip('"').strip().lower()
2026-02-20T22:09:16.2096214Z                          if item:
2026-02-20T22:09:16.2096636Z                              items.append(item)
2026-02-20T22:09:16.2097069Z                      return items
2026-02-20T22:09:16.2097445Z -                
2026-02-20T22:09:16.2097727Z +
2026-02-20T22:09:16.2098152Z                  # Format CSV simple : "Rouge,Vert,Jaune,Bleu" ou "O, O, X, O"
2026-02-20T22:09:16.2098742Z -                if ',' in answer:
2026-02-20T22:09:16.2099381Z -                    return [item.strip().lower() for item in answer.split(',') if item.strip()]
2026-02-20T22:09:16.2100062Z -                
2026-02-20T22:09:16.2100393Z +                if "," in answer:
2026-02-20T22:09:16.2100792Z +                    return [
2026-02-20T22:09:16.2101191Z +                        item.strip().lower()
2026-02-20T22:09:16.2101695Z +                        for item in answer.split(",")
2026-02-20T22:09:16.2102185Z +                        if item.strip()
2026-02-20T22:09:16.2102608Z +                    ]
2026-02-20T22:09:16.2102917Z +
2026-02-20T22:09:16.2103641Z                  # Séparateur espaces : "O O X O" (sans virgules)
2026-02-20T22:09:16.2104336Z                  parts = [p.strip().lower() for p in answer.split() if p.strip()]
2026-02-20T22:09:16.2104978Z                  if len(parts) > 1:
2026-02-20T22:09:16.2105399Z                      return parts
2026-02-20T22:09:16.2105773Z -                
2026-02-20T22:09:16.2106073Z +
2026-02-20T22:09:16.2106343Z                  # Valeur simple
2026-02-20T22:09:16.2106813Z                  return [answer.lower()] if answer else []
2026-02-20T22:09:16.2107293Z -            
2026-02-20T22:09:16.2107872Z -            def compare_deduction_answers(user_answer: str, correct_answer: str) -> bool:
2026-02-20T22:09:16.2108566Z +
2026-02-20T22:09:16.2108888Z +            def compare_deduction_answers(
2026-02-20T22:09:16.2109401Z +                user_answer: str, correct_answer: str
2026-02-20T22:09:16.2109871Z +            ) -> bool:
2026-02-20T22:09:16.2110202Z                  """
2026-02-20T22:09:16.2110787Z                  Compare les réponses pour les défis de déduction.
2026-02-20T22:09:16.2111549Z                  Format attendu: "Emma:Chimie:700,Lucas:Info:600,..." ou format dict-like
2026-02-20T22:09:16.2112743Z                  L'ordre des associations n'a pas d'importance, seul le contenu compte.
2026-02-20T22:09:16.2114063Z                  Normalise les ordinaux français (1er, 2ème, 3ème...) en chiffres (1, 2, 3...).
2026-02-20T22:09:16.2114768Z                  """
2026-02-20T22:09:16.2115765Z                  # Mapping ordinaux français → chiffre (frontend affiche "1er", "2ème" etc.)
2026-02-20T22:09:16.2116478Z                  _ORDINAL_NORM = {
2026-02-20T22:09:16.2117086Z -                    "1er": "1", "1ère": "1", "1e": "1", "1ere": "1",
2026-02-20T22:09:16.2117749Z -                    "2ème": "2", "2eme": "2", "2e": "2",
2026-02-20T22:09:16.2118345Z -                    "3ème": "3", "3eme": "3", "3e": "3",
2026-02-20T22:09:16.2118949Z -                    "4ème": "4", "4eme": "4", "4e": "4",
2026-02-20T22:09:16.2119541Z -                    "5ème": "5", "5eme": "5", "5e": "5",
2026-02-20T22:09:16.2120168Z -                    "6ème": "6", "6eme": "6", "6e": "6",
2026-02-20T22:09:16.2120764Z -                    "7ème": "7", "7eme": "7", "7e": "7",
2026-02-20T22:09:16.2121355Z -                    "8ème": "8", "8eme": "8", "8e": "8",
2026-02-20T22:09:16.2121952Z -                    "9ème": "9", "9eme": "9", "9e": "9",
2026-02-20T22:09:16.2122567Z -                    "10ème": "10", "10eme": "10", "10e": "10",
2026-02-20T22:09:16.2123268Z +                    "1er": "1",
2026-02-20T22:09:16.2123749Z +                    "1ère": "1",
2026-02-20T22:09:16.2124136Z +                    "1e": "1",
2026-02-20T22:09:16.2124507Z +                    "1ere": "1",
2026-02-20T22:09:16.2124964Z +                    "2ème": "2",
2026-02-20T22:09:16.2125344Z +                    "2eme": "2",
2026-02-20T22:09:16.2125710Z +                    "2e": "2",
2026-02-20T22:09:16.2126153Z +                    "3ème": "3",
2026-02-20T22:09:16.2126523Z +                    "3eme": "3",
2026-02-20T22:09:16.2126893Z +                    "3e": "3",
2026-02-20T22:09:16.2127365Z +                    "4ème": "4",
2026-02-20T22:09:16.2127749Z +                    "4eme": "4",
2026-02-20T22:09:16.2128121Z +                    "4e": "4",
2026-02-20T22:09:16.2128558Z +                    "5ème": "5",
2026-02-20T22:09:16.2128922Z +                    "5eme": "5",
2026-02-20T22:09:16.2129279Z +                    "5e": "5",
2026-02-20T22:09:16.2129723Z +                    "6ème": "6",
2026-02-20T22:09:16.2130075Z +                    "6eme": "6",
2026-02-20T22:09:16.2130436Z +                    "6e": "6",
2026-02-20T22:09:16.2130884Z +                    "7ème": "7",
2026-02-20T22:09:16.2131259Z +                    "7eme": "7",
2026-02-20T22:09:16.2131625Z +                    "7e": "7",
2026-02-20T22:09:16.2132049Z +                    "8ème": "8",
2026-02-20T22:09:16.2132412Z +                    "8eme": "8",
2026-02-20T22:09:16.2132760Z +                    "8e": "8",
2026-02-20T22:09:16.2133427Z +                    "9ème": "9",
2026-02-20T22:09:16.2133826Z +                    "9eme": "9",
2026-02-20T22:09:16.2134198Z +                    "9e": "9",
2026-02-20T22:09:16.2134642Z +                    "10ème": "10",
2026-02-20T22:09:16.2135043Z +                    "10eme": "10",
2026-02-20T22:09:16.2135429Z +                    "10e": "10",
2026-02-20T22:09:16.2135793Z                  }
2026-02-20T22:09:16.2136110Z  
2026-02-20T22:09:16.2136418Z                  def _norm_ordinal(s: str) -> str:
2026-02-20T22:09:16.2137140Z                      """Normalise un ordinal français en chiffre."""
2026-02-20T22:09:16.2137689Z                      t = s.strip().lower()
2026-02-20T22:09:16.2138109Z @@ -393,166 +509,232 @@
2026-02-20T22:09:16.2138419Z  
2026-02-20T22:09:16.2138782Z                  def parse_associations(answer: str) -> set:
2026-02-20T22:09:16.2139583Z                      """Parse les associations en set de tuples normalisés."""
2026-02-20T22:09:16.2140237Z                      answer = str(answer).strip().lower()
2026-02-20T22:09:16.2141027Z                      associations = set()
2026-02-20T22:09:16.2141447Z -                    
2026-02-20T22:09:16.2141767Z +
2026-02-20T22:09:16.2142207Z                      # Format "entité:val1:val2,..."
2026-02-20T22:09:16.2142692Z -                    if ':' in answer:
2026-02-20T22:09:16.2143353Z -                        for part in answer.split(','):
2026-02-20T22:09:16.2144098Z +                    if ":" in answer:
2026-02-20T22:09:16.2144553Z +                        for part in answer.split(","):
2026-02-20T22:09:16.2145064Z                              part = part.strip()
2026-02-20T22:09:16.2145525Z                              if part:
2026-02-20T22:09:16.2146053Z                                  # Normaliser ordinaux + tri pour ignorer l'ordre
2026-02-20T22:09:16.2146778Z -                                raw = [e.strip() for e in part.split(':') if e.strip()]
2026-02-20T22:09:16.2147559Z -                                elements = tuple(sorted([_norm_ordinal(e) for e in raw]))
2026-02-20T22:09:16.2148334Z +                                raw = [e.strip() for e in part.split(":") if e.strip()]
2026-02-20T22:09:16.2148946Z +                                elements = tuple(
2026-02-20T22:09:16.2149489Z +                                    sorted([_norm_ordinal(e) for e in raw])
2026-02-20T22:09:16.2150088Z +                                )
2026-02-20T22:09:16.2150511Z                                  if elements:
2026-02-20T22:09:16.2151013Z                                      associations.add(elements)
2026-02-20T22:09:16.2151552Z                      # Format dict-like ou JSON
2026-02-20T22:09:16.2152023Z -                    elif '{' in answer:
2026-02-20T22:09:16.2152464Z +                    elif "{" in answer:
2026-02-20T22:09:16.2152891Z                          try:
2026-02-20T22:09:16.2153474Z                              import json
2026-02-20T22:09:16.2153879Z +
2026-02-20T22:09:16.2154261Z                              data = json.loads(answer.replace("'", '"'))
2026-02-20T22:09:16.2154852Z                              if isinstance(data, dict):
2026-02-20T22:09:16.2155401Z                                  for key, values in data.items():
2026-02-20T22:09:16.2155947Z                                      if isinstance(values, dict):
2026-02-20T22:09:16.2156810Z -                                        elements = tuple(sorted([str(key).lower()] + [str(v).lower() for v in values.values()]))
2026-02-20T22:09:16.2157688Z +                                        elements = tuple(
2026-02-20T22:09:16.2158190Z +                                            sorted(
2026-02-20T22:09:16.2158700Z +                                                [str(key).lower()]
2026-02-20T22:09:16.2159205Z +                                                + [
2026-02-20T22:09:16.2159708Z +                                                    str(v).lower()
2026-02-20T22:09:16.2160260Z +                                                    for v in values.values()
2026-02-20T22:09:16.2160796Z +                                                ]
2026-02-20T22:09:16.2161477Z +                                            )
2026-02-20T22:09:16.2161909Z +                                        )
2026-02-20T22:09:16.2162334Z                                      else:
2026-02-20T22:09:16.2163163Z -                                        elements = tuple(sorted([str(key).lower(), str(values).lower()]))
2026-02-20T22:09:16.2163927Z +                                        elements = tuple(
2026-02-20T22:09:16.2164414Z +                                            sorted(
2026-02-20T22:09:16.2164973Z +                                                [str(key).lower(), str(values).lower()]
2026-02-20T22:09:16.2165531Z +                                            )
2026-02-20T22:09:16.2165970Z +                                        )
2026-02-20T22:09:16.2166460Z                                      associations.add(elements)
2026-02-20T22:09:16.2167204Z -                        except (json.JSONDecodeError, ValueError, TypeError, AttributeError):
2026-02-20T22:09:16.2167924Z +                        except (
2026-02-20T22:09:16.2168361Z +                            json.JSONDecodeError,
2026-02-20T22:09:16.2168847Z +                            ValueError,
2026-02-20T22:09:16.2169278Z +                            TypeError,
2026-02-20T22:09:16.2169719Z +                            AttributeError,
2026-02-20T22:09:16.2170424Z +                        ):
2026-02-20T22:09:16.2170794Z                              pass
2026-02-20T22:09:16.2171187Z -                    
2026-02-20T22:09:16.2171498Z +
2026-02-20T22:09:16.2171799Z                      return associations
2026-02-20T22:09:16.2172211Z -                
2026-02-20T22:09:16.2172525Z +
2026-02-20T22:09:16.2172931Z                  user_assoc = parse_associations(user_answer)
2026-02-20T22:09:16.2173830Z                  correct_assoc = parse_associations(correct_answer)
2026-02-20T22:09:16.2174358Z -                
2026-02-20T22:09:16.2175010Z -                logger.debug(f"Deduction comparison - User: {user_assoc}, Correct: {correct_assoc}")
2026-02-20T22:09:16.2175777Z -                
2026-02-20T22:09:16.2176077Z +
2026-02-20T22:09:16.2176358Z +                logger.debug(
2026-02-20T22:09:16.2176969Z +                    f"Deduction comparison - User: {user_assoc}, Correct: {correct_assoc}"
2026-02-20T22:09:16.2177625Z +                )
2026-02-20T22:09:16.2177916Z +
2026-02-20T22:09:16.2178191Z                  # Comparer les sets
2026-02-20T22:09:16.2178639Z                  return user_assoc == correct_assoc
2026-02-20T22:09:16.2179096Z -            
2026-02-20T22:09:16.2179388Z +
2026-02-20T22:09:16.2180076Z              # Déterminer le type de challenge pour choisir la méthode de comparaison
2026-02-20T22:09:16.2181128Z -            challenge_type = str(challenge.challenge_type).lower() if challenge.challenge_type else ''
2026-02-20T22:09:16.2181957Z +            challenge_type = (
2026-02-20T22:09:16.2182424Z +                str(challenge.challenge_type).lower()
2026-02-20T22:09:16.2183146Z +                if challenge.challenge_type
2026-02-20T22:09:16.2183616Z +                else ""
2026-02-20T22:09:16.2183957Z +            )
2026-02-20T22:09:16.2184231Z  
2026-02-20T22:09:16.2184766Z              # Comparaison spéciale pour les défis de déduction
2026-02-20T22:09:16.2185446Z -            if 'deduction' in challenge_type and ':' in user_solution:
2026-02-20T22:09:16.2186341Z -                is_correct = compare_deduction_answers(user_solution, challenge.correct_answer)
2026-02-20T22:09:16.2188239Z -                logger.debug(f"Comparaison déduction - User: {user_solution[:100]}, Correct: {challenge.correct_answer[:100] if challenge.correct_answer else 'None'}, Result: {is_correct}")
2026-02-20T22:09:16.2189616Z -            elif 'probability' in challenge_type:
2026-02-20T22:09:16.2190248Z +            if "deduction" in challenge_type and ":" in user_solution:
2026-02-20T22:09:16.2190871Z +                is_correct = compare_deduction_answers(
2026-02-20T22:09:16.2191437Z +                    user_solution, challenge.correct_answer
2026-02-20T22:09:16.2192177Z +                )
2026-02-20T22:09:16.2192515Z +                logger.debug(
2026-02-20T22:09:16.2194173Z +                    f"Comparaison déduction - User: {user_solution[:100]}, Correct: {challenge.correct_answer[:100] if challenge.correct_answer else 'None'}, Result: {is_correct}"
2026-02-20T22:09:16.2195430Z +                )
2026-02-20T22:09:16.2195826Z +            elif "probability" in challenge_type:
2026-02-20T22:09:16.2196276Z +
2026-02-20T22:09:16.2196692Z                  def _parse_probability_value(text: str) -> float | None:
2026-02-20T22:09:16.2197521Z                      """Parse 6/10, 3/5, 0.6, 60% → valeur décimale."""
2026-02-20T22:09:16.2198144Z                      if not text or not isinstance(text, str):
2026-02-20T22:09:16.2198657Z                          return None
2026-02-20T22:09:16.2199076Z                      t = text.strip()
2026-02-20T22:09:16.2199469Z -                    if '/' in t:
2026-02-20T22:09:16.2199886Z +                    if "/" in t:
2026-02-20T22:09:16.2200271Z                          try:
2026-02-20T22:09:16.2200677Z -                            a, b = t.split('/', 1)
2026-02-20T22:09:16.2201175Z +                            a, b = t.split("/", 1)
2026-02-20T22:09:16.2201719Z                              num, den = float(a.strip()), float(b.strip())
2026-02-20T22:09:16.2202602Z                              return num / den if den else None
2026-02-20T22:09:16.2203386Z                          except (ValueError, ZeroDivisionError):
2026-02-20T22:09:16.2203932Z                              return None
2026-02-20T22:09:16.2204374Z -                    if '%' in t:
2026-02-20T22:09:16.2204764Z +                    if "%" in t:
2026-02-20T22:09:16.2205154Z                          try:
2026-02-20T22:09:16.2205623Z -                            return float(t.replace('%', '').strip()) / 100
2026-02-20T22:09:16.2206276Z +                            return float(t.replace("%", "").strip()) / 100
2026-02-20T22:09:16.2206851Z                          except ValueError:
2026-02-20T22:09:16.2207305Z                              return None
2026-02-20T22:09:16.2207721Z                      try:
2026-02-20T22:09:16.2208136Z -                        return float(t.replace(',', '.'))
2026-02-20T22:09:16.2208684Z +                        return float(t.replace(",", "."))
2026-02-20T22:09:16.2209199Z                      except ValueError:
2026-02-20T22:09:16.2209629Z                          return None
2026-02-20T22:09:16.2210008Z  
2026-02-20T22:09:16.2210377Z                  u_val = _parse_probability_value(user_solution)
2026-02-20T22:09:16.2211082Z -                c_val = _parse_probability_value(challenge.correct_answer or '')
2026-02-20T22:09:16.2211875Z +                c_val = _parse_probability_value(challenge.correct_answer or "")
2026-02-20T22:09:16.2212508Z                  is_correct = (
2026-02-20T22:09:16.2212905Z                      u_val is not None
2026-02-20T22:09:16.2213531Z                      and c_val is not None
2026-02-20T22:09:16.2213998Z                      and abs(u_val - c_val) < 0.001
2026-02-20T22:09:16.2214445Z                  )
2026-02-20T22:09:16.2215094Z -                if not is_correct and user_solution.strip() == (challenge.correct_answer or '').strip():
2026-02-20T22:09:16.2215857Z +                if (
2026-02-20T22:09:16.2216200Z +                    not is_correct
2026-02-20T22:09:16.2216634Z +                    and user_solution.strip()
2026-02-20T22:09:16.2217151Z +                    == (challenge.correct_answer or "").strip()
2026-02-20T22:09:16.2217624Z +                ):
2026-02-20T22:09:16.2217944Z                      is_correct = True
2026-02-20T22:09:16.2219063Z -                logger.debug(f"Comparaison PROBABILITY - User: {user_solution}, Correct: {challenge.correct_answer}, Parsed: {u_val}/{c_val}, Result: {is_correct}")
2026-02-20T22:09:16.2220271Z -            elif 'chess' in challenge_type:
2026-02-20T22:09:16.2220728Z +                logger.debug(
2026-02-20T22:09:16.2222049Z +                    f"Comparaison PROBABILITY - User: {user_solution}, Correct: {challenge.correct_answer}, Parsed: {u_val}/{c_val}, Result: {is_correct}"
2026-02-20T22:09:16.2223286Z +                )
2026-02-20T22:09:16.2223640Z +            elif "chess" in challenge_type:
2026-02-20T22:09:16.2224078Z +
2026-02-20T22:09:16.2224441Z                  def _normalize_chess_answer(text: str) -> str:
2026-02-20T22:09:16.2225346Z                      """Normalise une réponse échecs pour comparaison tolérante."""
2026-02-20T22:09:16.2225621Z                      if not text or not isinstance(text, str):
2026-02-20T22:09:16.2225749Z                          return ""
2026-02-20T22:09:16.2225882Z                      import re
2026-02-20T22:09:16.2225987Z +
2026-02-20T22:09:16.2226122Z                      t = text.strip()
2026-02-20T22:09:16.2226465Z                      # Retirer numéros de coups (1. 2. 3. 1) 2) etc.)
2026-02-20T22:09:16.2226633Z -                    t = re.sub(r'\d+[.)]\s*', '', t)
2026-02-20T22:09:16.2226803Z +                    t = re.sub(r"\d+[.)]\s*", "", t)
2026-02-20T22:09:16.2227024Z                      # Collapser espaces multiples et normaliser
2026-02-20T22:09:16.2227184Z -                    t = re.sub(r'\s+', ' ', t).strip()
2026-02-20T22:09:16.2227339Z +                    t = re.sub(r"\s+", " ", t).strip()
2026-02-20T22:09:16.2228041Z                      # Notation anglaise → française (Q->D, R->T, B->F, N->C, K->R)
2026-02-20T22:09:16.2228339Z -                    _en_to_fr = {'Q': 'D', 'R': 'T', 'B': 'F', 'N': 'C', 'K': 'R', 'P': 'P'}
2026-02-20T22:09:16.2228462Z +                    _en_to_fr = {
2026-02-20T22:09:16.2228580Z +                        "Q": "D",
2026-02-20T22:09:16.2228707Z +                        "R": "T",
2026-02-20T22:09:16.2228822Z +                        "B": "F",
2026-02-20T22:09:16.2228934Z +                        "N": "C",
2026-02-20T22:09:16.2229052Z +                        "K": "R",
2026-02-20T22:09:16.2229182Z +                        "P": "P",
2026-02-20T22:09:16.2229292Z +                    }
2026-02-20T22:09:16.2229433Z                      parts = t.split()
2026-02-20T22:09:16.2229568Z                      out = []
2026-02-20T22:09:16.2229705Z                      for p in parts:
2026-02-20T22:09:16.2229929Z                          if len(p) >= 1 and p[0].upper() in _en_to_fr:
2026-02-20T22:09:16.2230185Z                              out.append(_en_to_fr[p[0].upper()] + p[1:])
2026-02-20T22:09:16.2230312Z                          else:
2026-02-20T22:09:16.2230461Z                              out.append(p)
2026-02-20T22:09:16.2230616Z -                    t = ' '.join(out).upper()
2026-02-20T22:09:16.2230775Z +                    t = " ".join(out).upper()
2026-02-20T22:09:16.2231326Z                      # Comparaison sans espaces (tolérance "Dg8+ Txg8 Cf7#" = "Dg8+Txg8Cf7#")
2026-02-20T22:09:16.2231499Z -                    return t.replace(' ', '')
2026-02-20T22:09:16.2231662Z +                    return t.replace(" ", "")
2026-02-20T22:09:16.2231778Z  
2026-02-20T22:09:16.2232001Z                  u_norm = _normalize_chess_answer(user_solution)
2026-02-20T22:09:16.2232230Z -                correct_raw = challenge.correct_answer or ''
2026-02-20T22:09:16.2232436Z +                correct_raw = challenge.correct_answer or ""
2026-02-20T22:09:16.2232868Z                  # Accepter plusieurs solutions (duals) séparées par " | "
2026-02-20T22:09:16.2233437Z -                correct_variants = [s.strip() for s in correct_raw.split('|') if s.strip()]
2026-02-20T22:09:16.2233600Z +                correct_variants = [
2026-02-20T22:09:16.2233849Z +                    s.strip() for s in correct_raw.split("|") if s.strip()
2026-02-20T22:09:16.2233965Z +                ]
2026-02-20T22:09:16.2234311Z                  correct_norms = [_normalize_chess_answer(v) for v in correct_variants]
2026-02-20T22:09:16.2234865Z -                is_correct = u_norm in correct_norms if correct_norms else u_norm == _normalize_chess_answer(correct_raw)
2026-02-20T22:09:16.2235672Z -                logger.debug(f"Comparaison CHESS - User norm: {u_norm}, Correct: {correct_norms}, Result: {is_correct}")
2026-02-20T22:09:16.2235873Z -            elif 'graph' in challenge_type:
2026-02-20T22:09:16.2236011Z +                is_correct = (
2026-02-20T22:09:16.2236171Z +                    u_norm in correct_norms
2026-02-20T22:09:16.2236334Z +                    if correct_norms
2026-02-20T22:09:16.2236576Z +                    else u_norm == _normalize_chess_answer(correct_raw)
2026-02-20T22:09:16.2236697Z +                )
2026-02-20T22:09:16.2236835Z +                logger.debug(
2026-02-20T22:09:16.2237308Z +                    f"Comparaison CHESS - User norm: {u_norm}, Correct: {correct_norms}, Result: {is_correct}"
2026-02-20T22:09:16.2237424Z +                )
2026-02-20T22:09:16.2237584Z +            elif "graph" in challenge_type:
2026-02-20T22:09:16.2238080Z                  # Liste de nœuds : accepter tout ordre (comparaison par ensemble)
2026-02-20T22:09:16.2238329Z                  user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2238667Z -                correct_list = parse_answer_to_list(challenge.correct_answer or '')
2026-02-20T22:09:16.2239002Z +                correct_list = parse_answer_to_list(challenge.correct_answer or "")
2026-02-20T22:09:16.2239534Z                  user_set = {u.strip().upper() for u in user_list if u.strip()}
2026-02-20T22:09:16.2239861Z                  correct_set = {c.strip().upper() for c in correct_list if c.strip()}
2026-02-20T22:09:16.2240500Z                  # Liste de nœuds (set) vs chemin (ordre) : si aucun élément ne contient "-", c'est un set
2026-02-20T22:09:16.2240653Z -                is_node_list = (
2026-02-20T22:09:16.2240808Z -                    len(correct_set) > 1
2026-02-20T22:09:16.2241042Z -                    and not any('-' in str(c) for c in correct_list)
2026-02-20T22:09:16.2241273Z +                is_node_list = len(correct_set) > 1 and not any(
2026-02-20T22:09:16.2241464Z +                    "-" in str(c) for c in correct_list
2026-02-20T22:09:16.2241578Z                  )
2026-02-20T22:09:16.2241721Z                  if is_node_list:
2026-02-20T22:09:16.2241906Z                      is_correct = user_set == correct_set
2026-02-20T22:09:16.2242031Z                  else:
2026-02-20T22:09:16.2242433Z                      # Chemin ou valeur unique : comparaison ordonnée
2026-02-20T22:09:16.2242633Z                      is_correct = user_list == correct_list
2026-02-20T22:09:16.2243715Z -                logger.debug(f"Comparaison GRAPH - User: {user_set if is_node_list else user_list}, Correct: {correct_set if is_node_list else correct_list}, Result: {is_correct}")
2026-02-20T22:09:16.2244048Z -            elif 'visual' in challenge_type or 'pattern' in challenge_type:
2026-02-20T22:09:16.2244192Z +                logger.debug(
2026-02-20T22:09:16.2244997Z +                    f"Comparaison GRAPH - User: {user_set if is_node_list else user_list}, Correct: {correct_set if is_node_list else correct_list}, Result: {is_correct}"
2026-02-20T22:09:16.2245147Z +                )
2026-02-20T22:09:16.2245448Z +            elif "visual" in challenge_type or "pattern" in challenge_type:
2026-02-20T22:09:16.2246116Z                  # PATTERN avec grille : source de vérité = analyse du pattern, pas correct_answer en base
2026-02-20T22:09:16.2246319Z                  computed_pattern_answer = None
2026-02-20T22:09:16.2246508Z -                if 'pattern' in challenge_type:
2026-02-20T22:09:16.2246676Z +                if "pattern" in challenge_type:
2026-02-20T22:09:16.2246842Z                      vd = challenge.visual_data
2026-02-20T22:09:16.2247067Z -                    if isinstance(vd, dict) and vd.get('grid'):
2026-02-20T22:09:16.2247275Z +                    if isinstance(vd, dict) and vd.get("grid"):
2026-02-20T22:09:16.2247528Z                          from app.services.challenge_validator import (
2026-02-20T22:09:16.2247787Z -                            analyze_pattern, compute_pattern_answers_multi)
2026-02-20T22:09:16.2248182Z -                        grid = vd['grid']
2026-02-20T22:09:16.2248346Z +                            analyze_pattern,
2026-02-20T22:09:16.2248542Z +                            compute_pattern_answers_multi,
2026-02-20T22:09:16.2248676Z +                        )
2026-02-20T22:09:16.2248793Z +
2026-02-20T22:09:16.2248935Z +                        grid = vd["grid"]
2026-02-20T22:09:16.2249413Z                          # Plusieurs "?" → format "O, O, X, O" (ordre ligne par ligne)
2026-02-20T22:09:16.2249685Z                          computed_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:16.2249839Z                          if computed_multi:
2026-02-20T22:09:16.2250144Z                              computed_pattern_answer = computed_multi
2026-02-20T22:09:16.2250275Z                          else:
2026-02-20T22:09:16.2250463Z                              for i, row in enumerate(grid):
2026-02-20T22:09:16.2250673Z                                  if not isinstance(row, (list, tuple)):
2026-02-20T22:09:16.2250840Z                                      continue
2026-02-20T22:09:16.2251028Z                                  for j, cell in enumerate(row):
2026-02-20T22:09:16.2251346Z -                                    if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:16.2251898Z -                                        computed_pattern_answer = analyze_pattern(grid, i, j)
2026-02-20T22:09:16.2252075Z +                                    if cell == "?" or (
2026-02-20T22:09:16.2252309Z +                                        isinstance(cell, str) and "?" in str(cell)
2026-02-20T22:09:16.2252448Z +                                    ):
2026-02-20T22:09:16.2252690Z +                                        computed_pattern_answer = analyze_pattern(
2026-02-20T22:09:16.2252854Z +                                            grid, i, j
2026-02-20T22:09:16.2253180Z +                                        )
2026-02-20T22:09:16.2253348Z                                          break
2026-02-20T22:09:16.2253570Z                                  if computed_pattern_answer is not None:
2026-02-20T22:09:16.2253706Z                                      break
2026-02-20T22:09:16.2254186Z -                effective_correct = (computed_pattern_answer or challenge.correct_answer or '').strip()
2026-02-20T22:09:16.2254347Z +                effective_correct = (
2026-02-20T22:09:16.2254638Z +                    computed_pattern_answer or challenge.correct_answer or ""
2026-02-20T22:09:16.2254775Z +                ).strip()
2026-02-20T22:09:16.2254932Z                  if computed_pattern_answer:
2026-02-20T22:09:16.2255629Z -                    logger.debug(f"PATTERN: réponse calculée depuis la grille = '{computed_pattern_answer}'")
2026-02-20T22:09:16.2255784Z +                    logger.debug(
2026-02-20T22:09:16.2256348Z +                        f"PATTERN: réponse calculée depuis la grille = '{computed_pattern_answer}'"
2026-02-20T22:09:16.2256485Z +                    )
2026-02-20T22:09:16.2256900Z                  # PATTERN multi-cellules : format "O, O, X, O" (liste de symboles, ordre des "?")
2026-02-20T22:09:16.2257056Z                  is_pattern_multi_csv = (
2026-02-20T22:09:16.2257225Z -                    'pattern' in challenge_type
2026-02-20T22:09:16.2257396Z +                    "pattern" in challenge_type
2026-02-20T22:09:16.2257552Z                      and effective_correct
2026-02-20T22:09:16.2257713Z -                    and ',' in effective_correct
2026-02-20T22:09:16.2257948Z -                    and 'position' not in effective_correct.lower()
2026-02-20T22:09:16.2258111Z +                    and "," in effective_correct
2026-02-20T22:09:16.2258332Z +                    and "position" not in effective_correct.lower()
2026-02-20T22:09:16.2258447Z                  )
2026-02-20T22:09:16.2258604Z                  if is_pattern_multi_csv:
2026-02-20T22:09:16.2258829Z                      user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2259322Z                      correct_list = parse_answer_to_list(effective_correct)
2026-02-20T22:09:16.2259605Z                      user_norm = [_normalize_shape_answer(u) for u in user_list]
2026-02-20T22:09:16.2259735Z @@ -561,64 +743,73 @@
2026-02-20T22:09:16.2259959Z                          u == c for u, c in zip(user_norm, correct_norm)
2026-02-20T22:09:16.2260082Z                      )
2026-02-20T22:09:16.2260201Z                  else:
2026-02-20T22:09:16.2260790Z                      # VISUAL/PATTERN : tolérance synonymes, format "Position 6: x, Position 9: y"
2026-02-20T22:09:16.2261060Z                      user_parts = _parse_multi_visual_answer(user_solution)
2026-02-20T22:09:16.2261402Z -                    correct_parts = _parse_multi_visual_answer(effective_correct or '')
2026-02-20T22:09:16.2261727Z +                    correct_parts = _parse_multi_visual_answer(effective_correct or "")
2026-02-20T22:09:16.2261884Z                      is_multi_position = (
2026-02-20T22:09:16.2262206Z                          len(correct_parts) > 1 and any(p[0] > 0 for p in correct_parts)
2026-02-20T22:09:16.2262334Z -                    ) or (
2026-02-20T22:09:16.2262607Z -                        len(user_parts) > 1 and any(p[0] > 0 for p in user_parts)
2026-02-20T22:09:16.2262724Z -                    )
2026-02-20T22:09:16.2263432Z +                    ) or (len(user_parts) > 1 and any(p[0] > 0 for p in user_parts))
2026-02-20T22:09:16.2263596Z                      if is_multi_position:
2026-02-20T22:09:16.2263849Z                          if len(correct_parts) == 1 and len(user_parts) == 1:
2026-02-20T22:09:16.2264110Z                              is_correct = user_parts[0][1] == correct_parts[0][1]
2026-02-20T22:09:16.2264327Z                          elif len(user_parts) == len(correct_parts):
2026-02-20T22:09:16.2264629Z                              correct_sorted = sorted(correct_parts, key=lambda x: x[0])
2026-02-20T22:09:16.2264895Z                              user_sorted = sorted(user_parts, key=lambda x: x[0])
2026-02-20T22:09:16.2265283Z -                            by_position = all(u[1] == c[1] for u, c in zip(user_sorted, correct_sorted))
2026-02-20T22:09:16.2265454Z +                            by_position = all(
2026-02-20T22:09:16.2265609Z +                                u[1] == c[1]
2026-02-20T22:09:16.2265848Z +                                for u, c in zip(user_sorted, correct_sorted)
2026-02-20T22:09:16.2265973Z +                            )
2026-02-20T22:09:16.2266254Z                              if not by_position and all(u[0] == 0 for u in user_parts):
2026-02-20T22:09:16.2266525Z                                  user_answers = {p[1] for p in user_parts if p[1]}
2026-02-20T22:09:16.2266869Z                                  correct_answers = {p[1] for p in correct_parts if p[1]}
2026-02-20T22:09:16.2267103Z                                  is_correct = user_answers == correct_answers
2026-02-20T22:09:16.2267249Z                              else:
2026-02-20T22:09:16.2267442Z                                  is_correct = by_position
2026-02-20T22:09:16.2267569Z                          else:
2026-02-20T22:09:16.2267826Z                              user_answers = {p[1] for p in user_parts if p[1]}
2026-02-20T22:09:16.2268114Z                              correct_answers = {p[1] for p in correct_parts if p[1]}
2026-02-20T22:09:16.2268610Z -                            is_correct = user_answers == correct_answers and len(user_answers) == len(correct_answers)
2026-02-20T22:09:16.2268887Z +                            is_correct = user_answers == correct_answers and len(
2026-02-20T22:09:16.2269038Z +                                user_answers
2026-02-20T22:09:16.2269205Z +                            ) == len(correct_answers)
2026-02-20T22:09:16.2269336Z                      else:
2026-02-20T22:09:16.2269580Z                          user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2269847Z                          correct_list = parse_answer_to_list(effective_correct)
2026-02-20T22:09:16.2270280Z -                        u = user_list[0] if user_list else ''
2026-02-20T22:09:16.2270509Z -                        c = correct_list[0] if correct_list else ''
2026-02-20T22:09:16.2270861Z -                        is_correct = _normalize_shape_answer(u) == _normalize_shape_answer(c)
2026-02-20T22:09:16.2271061Z +                        u = user_list[0] if user_list else ""
2026-02-20T22:09:16.2271275Z +                        c = correct_list[0] if correct_list else ""
2026-02-20T22:09:16.2271459Z +                        is_correct = _normalize_shape_answer(
2026-02-20T22:09:16.2271578Z +                            u
2026-02-20T22:09:16.2271763Z +                        ) == _normalize_shape_answer(c)
2026-02-20T22:09:16.2272101Z                  logger.debug(f"Comparaison VISUAL/PATTERN - Result: {is_correct}")
2026-02-20T22:09:16.2272224Z              else:
2026-02-20T22:09:16.2272446Z                  user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2272742Z                  correct_list = parse_answer_to_list(challenge.correct_answer)
2026-02-20T22:09:16.2273517Z -                logger.debug(f"Comparaison réponse - User: {user_list}, Correct: {correct_list}")
2026-02-20T22:09:16.2273660Z +                logger.debug(
2026-02-20T22:09:16.2274137Z +                    f"Comparaison réponse - User: {user_list}, Correct: {correct_list}"
2026-02-20T22:09:16.2274513Z +                )
2026-02-20T22:09:16.2274743Z                  if len(user_list) > 1 or len(correct_list) > 1:
2026-02-20T22:09:16.2274946Z                      is_correct = user_list == correct_list
2026-02-20T22:09:16.2275073Z                  else:
2026-02-20T22:09:16.2275257Z -                    u = user_list[0] if user_list else ''
2026-02-20T22:09:16.2275465Z -                    c = correct_list[0] if correct_list else ''
2026-02-20T22:09:16.2275657Z +                    u = user_list[0] if user_list else ""
2026-02-20T22:09:16.2275853Z +                    c = correct_list[0] if correct_list else ""
2026-02-20T22:09:16.2276012Z                      is_correct = u == c
2026-02-20T22:09:16.2276135Z -            
2026-02-20T22:09:16.2276244Z +
2026-02-20T22:09:16.2276848Z              # NOTE: attempt_service_translations archivé - utiliser LogicChallengeAttempt ORM
2026-02-20T22:09:16.2277167Z              from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:16.2277293Z -            
2026-02-20T22:09:16.2277400Z +
2026-02-20T22:09:16.2277545Z              attempt_data = {
2026-02-20T22:09:16.2277687Z                  "user_id": user_id,
2026-02-20T22:09:16.2277845Z                  "challenge_id": challenge_id,
2026-02-20T22:09:16.2278006Z                  "user_solution": user_solution,
2026-02-20T22:09:16.2278163Z                  "is_correct": is_correct,
2026-02-20T22:09:16.2278316Z                  "time_spent": time_spent,
2026-02-20T22:09:16.2278690Z -                "hints_used": hints_used_count  # Utiliser le nombre d'indices, pas la liste
2026-02-20T22:09:16.2279073Z +                "hints_used": hints_used_count,  # Utiliser le nombre d'indices, pas la liste
2026-02-20T22:09:16.2279187Z              }
2026-02-20T22:09:16.2279296Z -            
2026-02-20T22:09:16.2279790Z -            logger.debug(f"Tentative d'enregistrement de challenge avec attempt_data: {attempt_data}")
2026-02-20T22:09:16.2279918Z +
2026-02-20T22:09:16.2280054Z +            logger.debug(
2026-02-20T22:09:16.2280449Z +                f"Tentative d'enregistrement de challenge avec attempt_data: {attempt_data}"
2026-02-20T22:09:16.2280564Z +            )
2026-02-20T22:09:16.2280795Z              attempt = LogicChallengeAttempt(**attempt_data)
2026-02-20T22:09:16.2280930Z              db.add(attempt)
2026-02-20T22:09:16.2281066Z              db.commit()
2026-02-20T22:09:16.2281202Z              db.refresh(attempt)
2026-02-20T22:09:16.2281629Z              logger.debug(f"Tentative challenge créée: {attempt.id}")
2026-02-20T22:09:16.2281759Z @@ -626,96 +817,115 @@
2026-02-20T22:09:16.2282583Z              # Lot C / B5 : vérifier les badges (défis logiques, mixte) après une tentative correcte
2026-02-20T22:09:16.2282736Z              new_badges = []
2026-02-20T22:09:16.2282869Z              if is_correct:
2026-02-20T22:09:16.2283192Z                  try:
2026-02-20T22:09:16.2283466Z                      from app.services.badge_service import BadgeService
2026-02-20T22:09:16.2283596Z +
2026-02-20T22:09:16.2283788Z                      badge_service = BadgeService(db)
2026-02-20T22:09:16.2284085Z                      new_badges = badge_service.check_and_award_badges(user_id)
2026-02-20T22:09:16.2284261Z                  except Exception as badge_err:
2026-02-20T22:09:16.2284701Z                      logger.warning(f"Badge check après défi: {badge_err}")
2026-02-20T22:09:16.2284821Z  
2026-02-20T22:09:16.2285322Z              # Mettre à jour la série d'entraînement (streak) — toute tentative compte
2026-02-20T22:09:16.2285443Z              try:
2026-02-20T22:09:16.2285757Z                  from app.services.streak_service import update_user_streak
2026-02-20T22:09:16.2285871Z +
2026-02-20T22:09:16.2286044Z                  update_user_streak(db, user_id)
2026-02-20T22:09:16.2286189Z              except Exception:
2026-02-20T22:09:16.2286325Z                  pass
2026-02-20T22:09:16.2286432Z  
2026-02-20T22:09:16.2287212Z              # Notification « Tu approches » si pas de nouveau badge mais un proche
2026-02-20T22:09:16.2287376Z              progress_notif = None
2026-02-20T22:09:16.2287512Z              if not new_badges:
2026-02-20T22:09:16.2287633Z                  try:
2026-02-20T22:09:16.2287900Z                      from app.services.badge_service import BadgeService
2026-02-20T22:09:16.2288009Z +
2026-02-20T22:09:16.2288163Z                      svc = BadgeService(db)
2026-02-20T22:09:16.2288494Z                      progress_notif = svc.get_closest_progress_notification(user_id)
2026-02-20T22:09:16.2288649Z                  except Exception:
2026-02-20T22:09:16.2288796Z                      pass
2026-02-20T22:09:16.2288908Z  
2026-02-20T22:09:16.2289059Z              response_data = {
2026-02-20T22:09:16.2289220Z -                'is_correct': is_correct,
2026-02-20T22:09:16.2289585Z -                'explanation': challenge.solution_explanation if is_correct else None,
2026-02-20T22:09:16.2289741Z -                'new_badges': new_badges,
2026-02-20T22:09:16.2289909Z +                "is_correct": is_correct,
2026-02-20T22:09:16.2290261Z +                "explanation": challenge.solution_explanation if is_correct else None,
2026-02-20T22:09:16.2290414Z +                "new_badges": new_badges,
2026-02-20T22:09:16.2290538Z              }
2026-02-20T22:09:16.2290679Z              if progress_notif:
2026-02-20T22:09:16.2290949Z -                response_data['progress_notification'] = progress_notif
2026-02-20T22:09:16.2291071Z -            
2026-02-20T22:09:16.2291335Z +                response_data["progress_notification"] = progress_notif
2026-02-20T22:09:16.2291453Z +
2026-02-20T22:09:16.2291588Z              if not is_correct:
2026-02-20T22:09:16.2292403Z                  # Ne pas révéler la bonne réponse immédiatement, mais la donner dans l'explication après plusieurs tentatives
2026-02-20T22:09:16.2292788Z -                hints_list = challenge.hints if isinstance(challenge.hints, list) else []
2026-02-20T22:09:16.2293341Z -                response_data['hints_remaining'] = len(hints_list) - hints_used_count
2026-02-20T22:09:16.2293474Z -            
2026-02-20T22:09:16.2293607Z +                hints_list = (
2026-02-20T22:09:16.2293914Z +                    challenge.hints if isinstance(challenge.hints, list) else []
2026-02-20T22:09:16.2294043Z +                )
2026-02-20T22:09:16.2294375Z +                response_data["hints_remaining"] = len(hints_list) - hints_used_count
2026-02-20T22:09:16.2294483Z +
2026-02-20T22:09:16.2294660Z              return JSONResponse(response_data)
2026-02-20T22:09:16.2294803Z      except ValueError:
2026-02-20T22:09:16.2295557Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2295749Z      except Exception as submission_error:
2026-02-20T22:09:16.2296284Z          logger.error(f"Erreur lors de la soumission de la réponse: {submission_error}")
2026-02-20T22:09:16.2296429Z          import traceback
2026-02-20T22:09:16.2296552Z +
2026-02-20T22:09:16.2296733Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.2297178Z -        return JSONResponse({"error": get_safe_error_message(submission_error)}, status_code=500)
2026-02-20T22:09:16.2297329Z +        return JSONResponse(
2026-02-20T22:09:16.2297641Z +            {"error": get_safe_error_message(submission_error)}, status_code=500
2026-02-20T22:09:16.2297766Z +        )
2026-02-20T22:09:16.2297877Z  
2026-02-20T22:09:16.2297988Z  
2026-02-20T22:09:16.2298202Z  async def get_challenge_hint(request: Request):
2026-02-20T22:09:16.2298316Z      """
2026-02-20T22:09:16.2298625Z      Récupère un indice pour un défi logique.
2026-02-20T22:09:16.2298852Z      Route: GET /api/challenges/{challenge_id}/hint
2026-02-20T22:09:16.2298974Z      """
2026-02-20T22:09:16.2299088Z      try:
2026-02-20T22:09:16.2299378Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2299609Z -        level = int(request.query_params.get('level', 1))
2026-02-20T22:09:16.2299950Z -        
2026-02-20T22:09:16.2300245Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2300468Z +        level = int(request.query_params.get("level", 1))
2026-02-20T22:09:16.2300573Z +
2026-02-20T22:09:16.2300721Z          async with db_session() as db:
2026-02-20T22:09:16.2301046Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:16.2301194Z              if not challenge:
2026-02-20T22:09:16.2301753Z -                return JSONResponse({"error": "Défi logique non trouvé"}, status_code=404)
2026-02-20T22:09:16.2301878Z -            
2026-02-20T22:09:16.2302051Z +                return JSONResponse(
2026-02-20T22:09:16.2302432Z +                    {"error": "Défi logique non trouvé"}, status_code=404
2026-02-20T22:09:16.2302554Z +                )
2026-02-20T22:09:16.2302669Z +
2026-02-20T22:09:16.2302881Z              # Récupérer les indices
2026-02-20T22:09:16.2303208Z              hints = challenge.hints
2026-02-20T22:09:16.2303374Z              if isinstance(hints, str):
2026-02-20T22:09:16.2303502Z                  try:
2026-02-20T22:09:16.2303663Z                      hints = json.loads(hints)
2026-02-20T22:09:16.2303881Z                  except (json.JSONDecodeError, ValueError):
2026-02-20T22:09:16.2304280Z                      # Si le parsing échoue, traiter comme une liste vide
2026-02-20T22:09:16.2304410Z                      hints = []
2026-02-20T22:09:16.2304542Z              elif hints is None:
2026-02-20T22:09:16.2304669Z                  hints = []
2026-02-20T22:09:16.2304789Z -            
2026-02-20T22:09:16.2304898Z +
2026-02-20T22:09:16.2305086Z              # S'assurer que hints est une liste
2026-02-20T22:09:16.2305257Z              if not isinstance(hints, list):
2026-02-20T22:09:16.2305378Z                  hints = []
2026-02-20T22:09:16.2305484Z -            
2026-02-20T22:09:16.2305590Z +
2026-02-20T22:09:16.2305758Z              if level < 1 or level > len(hints):
2026-02-20T22:09:16.2306252Z -                return JSONResponse({"error": f"Indice de niveau {level} non disponible"}, status_code=400)
2026-02-20T22:09:16.2306371Z -            
2026-02-20T22:09:16.2306534Z +                return JSONResponse(
2026-02-20T22:09:16.2306790Z +                    {"error": f"Indice de niveau {level} non disponible"},
2026-02-20T22:09:16.2306933Z +                    status_code=400,
2026-02-20T22:09:16.2307059Z +                )
2026-02-20T22:09:16.2307167Z +
2026-02-20T22:09:16.2307651Z              # Retourner l'indice spécifique au niveau demandé (index 0-based)
2026-02-20T22:09:16.2307945Z              hint_text = hints[level - 1] if level <= len(hints) else None
2026-02-20T22:09:16.2308792Z -            return JSONResponse({"hint": hint_text})  # Retourner l'indice spécifique au niveau
2026-02-20T22:09:16.2308952Z +            return JSONResponse(
2026-02-20T22:09:16.2309090Z +                {"hint": hint_text}
2026-02-20T22:09:16.2309401Z +            )  # Retourner l'indice spécifique au niveau
2026-02-20T22:09:16.2309552Z      except ValueError:
2026-02-20T22:09:16.2310079Z          return JSONResponse({"error": "ID de défi ou niveau invalide"}, status_code=400)
2026-02-20T22:09:16.2310280Z      except Exception as hint_retrieval_error:
2026-02-20T22:09:16.2310839Z -        logger.error(f"Erreur lors de la récupération de l'indice: {hint_retrieval_error}")
2026-02-20T22:09:16.2310980Z +        logger.error(
2026-02-20T22:09:16.2311443Z +            f"Erreur lors de la récupération de l'indice: {hint_retrieval_error}"
2026-02-20T22:09:16.2311578Z +        )
2026-02-20T22:09:16.2311730Z          traceback.print_exc()
2026-02-20T22:09:16.2312222Z -        return JSONResponse({"error": get_safe_error_message(hint_retrieval_error)}, status_code=500)
2026-02-20T22:09:16.2312382Z +        return JSONResponse(
2026-02-20T22:09:16.2312708Z +            {"error": get_safe_error_message(hint_retrieval_error)}, status_code=500
2026-02-20T22:09:16.2312823Z +        )
2026-02-20T22:09:16.2313432Z  
2026-02-20T22:09:16.2313540Z  
2026-02-20T22:09:16.2313674Z  @optional_auth
2026-02-20T22:09:16.2313937Z  async def get_completed_challenges_ids(request: Request):
2026-02-20T22:09:16.2314061Z      """
2026-02-20T22:09:16.2314187Z @@ -724,17 +934,18 @@
2026-02-20T22:09:16.2314298Z      """
2026-02-20T22:09:16.2314420Z      try:
2026-02-20T22:09:16.2314588Z          current_user = request.state.user
2026-02-20T22:09:16.2314727Z          if not current_user:
2026-02-20T22:09:16.2315010Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:16.2315135Z -        
2026-02-20T22:09:16.2315241Z +
2026-02-20T22:09:16.2315408Z          user_id = current_user.get("id")
2026-02-20T22:09:16.2315546Z          if not user_id:
2026-02-20T22:09:16.2315827Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:16.2315937Z -        
2026-02-20T22:09:16.2316045Z +
2026-02-20T22:09:16.2316549Z          # Récupérer les IDs de challenges avec au moins une tentative correcte
2026-02-20T22:09:16.2316784Z          from server.database import get_db_connection
2026-02-20T22:09:16.2316898Z +
2026-02-20T22:09:16.2317044Z          conn = get_db_connection()
2026-02-20T22:09:16.2317173Z          cursor = conn.cursor()
2026-02-20T22:09:16.2317284Z          try:
2026-02-20T22:09:16.2317781Z              # D'abord, vérifier combien de tentatives existent pour cet utilisateur
2026-02-20T22:09:16.2317931Z              check_query = """
2026-02-20T22:09:16.2318051Z @@ -743,36 +954,42 @@
2026-02-20T22:09:16.2318223Z                  FROM logic_challenge_attempts 
2026-02-20T22:09:16.2318374Z                  WHERE user_id = %s
2026-02-20T22:09:16.2318501Z              """
2026-02-20T22:09:16.2318695Z              cursor.execute(check_query, (user_id,))
2026-02-20T22:09:16.2318858Z              stats = cursor.fetchone()
2026-02-20T22:09:16.2319342Z -            logger.debug(f"Statistiques pour user_id {user_id}: total={stats[0]}, correctes={stats[1]}")
2026-02-20T22:09:16.2319480Z -            
2026-02-20T22:09:16.2319619Z +            logger.debug(
2026-02-20T22:09:16.2320031Z +                f"Statistiques pour user_id {user_id}: total={stats[0]}, correctes={stats[1]}"
2026-02-20T22:09:16.2320146Z +            )
2026-02-20T22:09:16.2320254Z +
2026-02-20T22:09:16.2320653Z              # Ensuite, récupérer les IDs de challenges complétés
2026-02-20T22:09:16.2320788Z              query = """
2026-02-20T22:09:16.2320958Z                  SELECT DISTINCT challenge_id 
2026-02-20T22:09:16.2321135Z                  FROM logic_challenge_attempts 
2026-02-20T22:09:16.2321330Z                  WHERE user_id = %s AND is_correct = true
2026-02-20T22:09:16.2321683Z              """
2026-02-20T22:09:16.2321859Z              cursor.execute(query, (user_id,))
2026-02-20T22:09:16.2322018Z              rows = cursor.fetchall()
2026-02-20T22:09:16.2322254Z              completed_ids = [row[0] for row in rows] if rows else []
2026-02-20T22:09:16.2322363Z -            
2026-02-20T22:09:16.2323285Z -            logger.debug(f"Récupération de {len(completed_ids)} challenges complétés pour l'utilisateur {user_id}")
2026-02-20T22:09:16.2323400Z +
2026-02-20T22:09:16.2323531Z +            logger.debug(
2026-02-20T22:09:16.2324168Z +                f"Récupération de {len(completed_ids)} challenges complétés pour l'utilisateur {user_id}"
2026-02-20T22:09:16.2324292Z +            )
2026-02-20T22:09:16.2324642Z              logger.debug(f"IDs complétés: {completed_ids}")
2026-02-20T22:09:16.2324908Z              return JSONResponse({"completed_ids": completed_ids})
2026-02-20T22:09:16.2325038Z          finally:
2026-02-20T22:09:16.2325172Z              cursor.close()
2026-02-20T22:09:16.2325320Z              conn.close()
2026-02-20T22:09:16.2325442Z -            
2026-02-20T22:09:16.2325550Z +
2026-02-20T22:09:16.2325761Z      except Exception as completed_challenges_error:
2026-02-20T22:09:16.2326482Z -        logger.error(f"Erreur lors de la récupération des challenges complétés: {completed_challenges_error}")
2026-02-20T22:09:16.2326866Z +        logger.error(
2026-02-20T22:09:16.2327505Z +            f"Erreur lors de la récupération des challenges complétés: {completed_challenges_error}"
2026-02-20T22:09:16.2327633Z +        )
2026-02-20T22:09:16.2327826Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.2328030Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.2328206Z              error=completed_challenges_error,
2026-02-20T22:09:16.2328352Z              status_code=500,
2026-02-20T22:09:16.2328872Z -            user_message="Erreur lors de la récupération des challenges complétés."
2026-02-20T22:09:16.2329371Z +            user_message="Erreur lors de la récupération des challenges complétés.",
2026-02-20T22:09:16.2329516Z          )
2026-02-20T22:09:16.2329627Z  
2026-02-20T22:09:16.2329732Z  
2026-02-20T22:09:16.2329855Z  @require_auth
2026-02-20T22:09:16.2330052Z  async def start_challenge(request: Request):
2026-02-20T22:09:16.2330175Z @@ -780,18 +997,22 @@
2026-02-20T22:09:16.2330502Z      Handler pour démarrer un défi (placeholder).
2026-02-20T22:09:16.2330728Z      Route: POST /api/challenges/start/{challenge_id}
2026-02-20T22:09:16.2330845Z      """
2026-02-20T22:09:16.2330957Z      try:
2026-02-20T22:09:16.2331118Z          current_user = request.state.user
2026-02-20T22:09:16.2331240Z -        
2026-02-20T22:09:16.2331528Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2331687Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2332434Z -        logger.info(f"Défi {challenge_id} démarré par l'utilisateur {user_id}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2332567Z +
2026-02-20T22:09:16.2332850Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2333187Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2333337Z +        logger.info(
2026-02-20T22:09:16.2333982Z +            f"Défi {challenge_id} démarré par l'utilisateur {user_id}. Fonctionnalité en développement."
2026-02-20T22:09:16.2334118Z +        )
2026-02-20T22:09:16.2334237Z  
2026-02-20T22:09:16.2334383Z          return JSONResponse(
2026-02-20T22:09:16.2335424Z -            {"message": f"Le défi {challenge_id} a été enregistré comme démarré pour l'utilisateur {user_id}. La fonctionnalité est en cours de développement."},
2026-02-20T22:09:16.2335576Z -            status_code=200
2026-02-20T22:09:16.2335688Z +            {
2026-02-20T22:09:16.2336718Z +                "message": f"Le défi {challenge_id} a été enregistré comme démarré pour l'utilisateur {user_id}. La fonctionnalité est en cours de développement."
2026-02-20T22:09:16.2337093Z +            },
2026-02-20T22:09:16.2337229Z +            status_code=200,
2026-02-20T22:09:16.2337338Z          )
2026-02-20T22:09:16.2337479Z      except ValueError:
2026-02-20T22:09:16.2337982Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2338122Z      except Exception as e:
2026-02-20T22:09:16.2338497Z          logger.error(f"Erreur lors du démarrage du défi: {e}")
2026-02-20T22:09:16.2338636Z @@ -805,18 +1026,22 @@
2026-02-20T22:09:16.2339223Z      Handler pour récupérer la progression d'un défi pour l'utilisateur actuel (placeholder).
2026-02-20T22:09:16.2339455Z      Route: GET /api/challenges/progress/{challenge_id}
2026-02-20T22:09:16.2339573Z      """
2026-02-20T22:09:16.2339702Z      try:
2026-02-20T22:09:16.2339868Z          current_user = request.state.user
2026-02-20T22:09:16.2339980Z -        
2026-02-20T22:09:16.2340274Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2340430Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2341319Z -        logger.info(f"Accès à la progression du défi {challenge_id} pour l'utilisateur {user_id}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2341449Z +
2026-02-20T22:09:16.2341731Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2341888Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2342234Z +        logger.info(
2026-02-20T22:09:16.2343222Z +            f"Accès à la progression du défi {challenge_id} pour l'utilisateur {user_id}. Fonctionnalité en développement."
2026-02-20T22:09:16.2343352Z +        )
2026-02-20T22:09:16.2343476Z  
2026-02-20T22:09:16.2343721Z          return JSONResponse(
2026-02-20T22:09:16.2344703Z -            {"message": f"La fonctionnalité de progression pour le défi {challenge_id} pour l'utilisateur {user_id} est en cours de développement."},
2026-02-20T22:09:16.2344855Z -            status_code=200
2026-02-20T22:09:16.2344979Z +            {
2026-02-20T22:09:16.2345959Z +                "message": f"La fonctionnalité de progression pour le défi {challenge_id} pour l'utilisateur {user_id} est en cours de développement."
2026-02-20T22:09:16.2346085Z +            },
2026-02-20T22:09:16.2346223Z +            status_code=200,
2026-02-20T22:09:16.2346344Z          )
2026-02-20T22:09:16.2346484Z      except ValueError:
2026-02-20T22:09:16.2347003Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2347165Z      except Exception as e:
2026-02-20T22:09:16.2347700Z          logger.error(f"Erreur lors de la récupération de la progression du défi: {e}")
2026-02-20T22:09:16.2347837Z @@ -830,17 +1055,21 @@
2026-02-20T22:09:16.2348287Z      Handler pour récupérer les récompenses d'un défi (placeholder).
2026-02-20T22:09:16.2348510Z      Route: GET /api/challenges/rewards/{challenge_id}
2026-02-20T22:09:16.2348622Z      """
2026-02-20T22:09:16.2348733Z      try:
2026-02-20T22:09:16.2348904Z          current_user = request.state.user
2026-02-20T22:09:16.2349036Z -        
2026-02-20T22:09:16.2349325Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2350405Z -        logger.info(f"Accès aux récompenses du défi {challenge_id} par l'utilisateur {current_user.get('id')}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2350527Z +
2026-02-20T22:09:16.2350836Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2350979Z +        logger.info(
2026-02-20T22:09:16.2351871Z +            f"Accès aux récompenses du défi {challenge_id} par l'utilisateur {current_user.get('id')}. Fonctionnalité en développement."
2026-02-20T22:09:16.2351998Z +        )
2026-02-20T22:09:16.2352107Z  
2026-02-20T22:09:16.2352255Z          return JSONResponse(
2026-02-20T22:09:16.2623380Z -            {"message": f"La fonctionnalité de récompenses pour le défi {challenge_id} est en cours de développement."},
2026-02-20T22:09:16.2623659Z -            status_code=200
2026-02-20T22:09:16.2624138Z +            {
2026-02-20T22:09:16.2625036Z +                "message": f"La fonctionnalité de récompenses pour le défi {challenge_id} est en cours de développement."
2026-02-20T22:09:16.2625160Z +            },
2026-02-20T22:09:16.2625306Z +            status_code=200,
2026-02-20T22:09:16.2625416Z          )
2026-02-20T22:09:16.2625547Z      except ValueError:
2026-02-20T22:09:16.2626245Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2626402Z      except Exception as e:
2026-02-20T22:09:16.2626901Z          logger.error(f"Erreur lors de la récupération des récompenses du défi: {e}")
2026-02-20T22:09:16.2627026Z @@ -854,43 +1083,70 @@
2026-02-20T22:09:16.2627341Z      Génère un challenge avec OpenAI en streaming SSE.
2026-02-20T22:09:16.2627662Z      Délègue la logique au service challenge_ai_service.
2026-02-20T22:09:16.2627768Z      """
2026-02-20T22:09:16.2627878Z      try:
2026-02-20T22:09:16.2628050Z          current_user = request.state.user
2026-02-20T22:09:16.2628442Z -        challenge_type_raw = request.query_params.get('challenge_type', 'sequence')
2026-02-20T22:09:16.2628729Z -        age_group_raw = request.query_params.get('age_group', '10-12')
2026-02-20T22:09:16.2628976Z -        prompt_raw = request.query_params.get('prompt', '')
2026-02-20T22:09:16.2629086Z -
2026-02-20T22:09:16.2629541Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:16.2629914Z +        challenge_type_raw = request.query_params.get("challenge_type", "sequence")
2026-02-20T22:09:16.2630193Z +        age_group_raw = request.query_params.get("age_group", "10-12")
2026-02-20T22:09:16.2630423Z +        prompt_raw = request.query_params.get("prompt", "")
2026-02-20T22:09:16.2630539Z +
2026-02-20T22:09:16.2630729Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:16.2630872Z +            sanitize_user_prompt,
2026-02-20T22:09:16.2631009Z +            validate_prompt_safety,
2026-02-20T22:09:16.2631130Z +        )
2026-02-20T22:09:16.2631417Z          from app.utils.sse_utils import SSE_HEADERS, sse_error_response
2026-02-20T22:09:16.2631919Z -        from app.services.challenge_ai_service import generate_challenge_stream as svc_generate_stream
2026-02-20T22:09:16.2632153Z +        from app.services.challenge_ai_service import (
2026-02-20T22:09:16.2632385Z +            generate_challenge_stream as svc_generate_stream,
2026-02-20T22:09:16.2632494Z +        )
2026-02-20T22:09:16.2632595Z  
2026-02-20T22:09:16.2632876Z          is_safe, safety_reason = validate_prompt_safety(prompt_raw)
2026-02-20T22:09:16.2633302Z          if not is_safe:
2026-02-20T22:09:16.2633875Z              logger.warning(f"Prompt utilisateur rejeté pour sécurité: {safety_reason}")
2026-02-20T22:09:16.2634187Z              return sse_error_response(f"Prompt invalide: {safety_reason}")
2026-02-20T22:09:16.2634296Z  
2026-02-20T22:09:16.2634488Z          prompt = sanitize_user_prompt(prompt_raw)
2026-02-20T22:09:16.2634601Z  
2026-02-20T22:09:16.2634806Z          challenge_type = challenge_type_raw.lower()
2026-02-20T22:09:16.2635411Z -        valid_types = ['sequence', 'pattern', 'visual', 'puzzle', 'graph', 'riddle', 'deduction', 'chess', 'coding', 'probability']
2026-02-20T22:09:16.2635543Z +        valid_types = [
2026-02-20T22:09:16.2635671Z +            "sequence",
2026-02-20T22:09:16.2635804Z +            "pattern",
2026-02-20T22:09:16.2635921Z +            "visual",
2026-02-20T22:09:16.2636050Z +            "puzzle",
2026-02-20T22:09:16.2636159Z +            "graph",
2026-02-20T22:09:16.2636271Z +            "riddle",
2026-02-20T22:09:16.2636397Z +            "deduction",
2026-02-20T22:09:16.2636512Z +            "chess",
2026-02-20T22:09:16.2636623Z +            "coding",
2026-02-20T22:09:16.2636750Z +            "probability",
2026-02-20T22:09:16.2636868Z +        ]
2026-02-20T22:09:16.2637042Z          if challenge_type not in valid_types:
2026-02-20T22:09:16.2637800Z -            logger.warning(f"Type de challenge invalide: {challenge_type_raw}, utilisation de 'sequence' par défaut")
2026-02-20T22:09:16.2638197Z -            challenge_type = 'sequence'
2026-02-20T22:09:16.2638336Z +            logger.warning(
2026-02-20T22:09:16.2638969Z +                f"Type de challenge invalide: {challenge_type_raw}, utilisation de 'sequence' par défaut"
2026-02-20T22:09:16.2639084Z +            )
2026-02-20T22:09:16.2639483Z +            challenge_type = "sequence"
2026-02-20T22:09:16.2639592Z  
2026-02-20T22:09:16.2639862Z          normalized_age_group = normalize_age_group(age_group_raw)
2026-02-20T22:09:16.2640376Z -        age_group = normalized_age_group if normalized_age_group else constants.AgeGroups.GROUP_6_8
2026-02-20T22:09:16.2640481Z -
2026-02-20T22:09:16.2640635Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2640764Z +        age_group = (
2026-02-20T22:09:16.2640904Z +            normalized_age_group
2026-02-20T22:09:16.2641044Z +            if normalized_age_group
2026-02-20T22:09:16.2641217Z +            else constants.AgeGroups.GROUP_6_8
2026-02-20T22:09:16.2641341Z +        )
2026-02-20T22:09:16.2641447Z +
2026-02-20T22:09:16.2641596Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2641726Z          if user_id:
2026-02-20T22:09:16.2641950Z              from app.utils.rate_limiter import rate_limiter
2026-02-20T22:09:16.2642055Z +
2026-02-20T22:09:16.2642338Z              allowed, rate_limit_reason = rate_limiter.check_rate_limit(
2026-02-20T22:09:16.2642565Z                  user_id=user_id, max_per_hour=10, max_per_day=50
2026-02-20T22:09:16.2642674Z              )
2026-02-20T22:09:16.2642800Z              if not allowed:
2026-02-20T22:09:16.2643431Z -                logger.warning(f"Rate limit atteint pour utilisateur {user_id}: {rate_limit_reason}")
2026-02-20T22:09:16.2644016Z -                return sse_error_response(f"Limite de génération atteinte: {rate_limit_reason}")
2026-02-20T22:09:16.2644156Z +                logger.warning(
2026-02-20T22:09:16.2644503Z +                    f"Rate limit atteint pour utilisateur {user_id}: {rate_limit_reason}"
2026-02-20T22:09:16.2644622Z +                )
2026-02-20T22:09:16.2644765Z +                return sse_error_response(
2026-02-20T22:09:16.2645116Z +                    f"Limite de génération atteinte: {rate_limit_reason}"
2026-02-20T22:09:16.2645230Z +                )
2026-02-20T22:09:16.2645342Z  
2026-02-20T22:09:16.2645499Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:16.2645899Z              return sse_error_response("OpenAI API key non configurée")
2026-02-20T22:09:16.2646006Z  
2026-02-20T22:09:16.2646300Z          accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.3695759Z --- /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:16.3698780Z +++ /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py	2026-02-20 22:09:16.366252+00:00
2026-02-20T22:09:16.3718170Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py
2026-02-20T22:09:16.3719040Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.3719331Z  """
2026-02-20T22:09:16.3719980Z  Handlers pour les recommandations personnalisées.
2026-02-20T22:09:16.3720478Z  """
2026-02-20T22:09:16.3720746Z +
2026-02-20T22:09:16.3721014Z  import traceback
2026-02-20T22:09:16.3721417Z  from datetime import datetime, timezone
2026-02-20T22:09:16.3721836Z  
2026-02-20T22:09:16.3722163Z  from starlette.responses import JSONResponse
2026-02-20T22:09:16.3722611Z  
2026-02-20T22:09:16.3722860Z @@ -27,20 +28,26 @@
2026-02-20T22:09:16.3723485Z          user_id = current_user.get("id")
2026-02-20T22:09:16.3724490Z          if not user_id:
2026-02-20T22:09:16.3728911Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3729626Z  
2026-02-20T22:09:16.3729933Z          async with db_session() as db:
2026-02-20T22:09:16.3730723Z -            recommendations = RecommendationService.get_user_recommendations(db, user_id, limit=7)
2026-02-20T22:09:16.3732190Z +            recommendations = RecommendationService.get_user_recommendations(
2026-02-20T22:09:16.3732870Z +                db, user_id, limit=7
2026-02-20T22:09:16.3733776Z +            )
2026-02-20T22:09:16.3734071Z  
2026-02-20T22:09:16.3734663Z              # Si aucune recommandation n'existe, générer de nouvelles
2026-02-20T22:09:16.3735521Z              if not recommendations:
2026-02-20T22:09:16.3735910Z                  try:
2026-02-20T22:09:16.3736422Z                      RecommendationService.generate_recommendations(db, user_id)
2026-02-20T22:09:16.3737035Z                      db.commit()
2026-02-20T22:09:16.3737777Z -                    recommendations = RecommendationService.get_user_recommendations(db, user_id, limit=7)
2026-02-20T22:09:16.3753674Z +                    recommendations = RecommendationService.get_user_recommendations(
2026-02-20T22:09:16.3754397Z +                        db, user_id, limit=7
2026-02-20T22:09:16.3754860Z +                    )
2026-02-20T22:09:16.3755241Z                  except Exception as gen_error:
2026-02-20T22:09:16.3756255Z -                    logger.error(f"Erreur lors de la génération des recommandations: {str(gen_error)}")
2026-02-20T22:09:16.3757041Z +                    logger.error(
2026-02-20T22:09:16.3757811Z +                        f"Erreur lors de la génération des recommandations: {str(gen_error)}"
2026-02-20T22:09:16.3758492Z +                    )
2026-02-20T22:09:16.3758847Z                      traceback.print_exc()
2026-02-20T22:09:16.3759300Z                      recommendations = []
2026-02-20T22:09:16.3759710Z  
2026-02-20T22:09:16.3760417Z              # Mapping difficulté → groupe d'âge (inverse du mapping age_group → difficulty)
2026-02-20T22:09:16.3761153Z              difficulty_to_age_group = {
2026-02-20T22:09:16.3762845Z @@ -48,33 +55,37 @@
2026-02-20T22:09:16.3763949Z                  "PADAWAN": "9-11",
2026-02-20T22:09:16.3793225Z                  "CHEVALIER": "12-14",
2026-02-20T22:09:16.3793762Z                  "MAITRE": "15-17",
2026-02-20T22:09:16.3794188Z                  "GRAND_MAITRE": "adulte",
2026-02-20T22:09:16.3794602Z              }
2026-02-20T22:09:16.3794883Z -            
2026-02-20T22:09:16.3795173Z +
2026-02-20T22:09:16.3795620Z              # Sérialiser les recommandations
2026-02-20T22:09:16.3796129Z              recommendations_data = []
2026-02-20T22:09:16.3796584Z              for rec in recommendations:
2026-02-20T22:09:16.3797272Z -                difficulty_str = str(rec.difficulty).upper() if rec.difficulty else "PADAWAN"
2026-02-20T22:09:16.3798075Z +                difficulty_str = (
2026-02-20T22:09:16.3798641Z +                    str(rec.difficulty).upper() if rec.difficulty else "PADAWAN"
2026-02-20T22:09:16.3799234Z +                )
2026-02-20T22:09:16.3799711Z                  age_group = difficulty_to_age_group.get(difficulty_str, "9-11")
2026-02-20T22:09:16.3800298Z -                
2026-02-20T22:09:16.3800587Z +
2026-02-20T22:09:16.3800871Z                  rec_data = {
2026-02-20T22:09:16.3801240Z                      "id": rec.id,
2026-02-20T22:09:16.3801665Z                      "exercise_type": str(rec.exercise_type),
2026-02-20T22:09:16.3802189Z                      "difficulty": difficulty_str,
2026-02-20T22:09:16.3802662Z                      "age_group": age_group,
2026-02-20T22:09:16.3803308Z                      "reason": rec.reason or "",
2026-02-20T22:09:16.3803782Z                      "priority": rec.priority,
2026-02-20T22:09:16.3804519Z -                    "recommendation_type": getattr(rec, "recommendation_type", None) or "exercise",
2026-02-20T22:09:16.3805438Z +                    "recommendation_type": getattr(rec, "recommendation_type", None)
2026-02-20T22:09:16.3806066Z +                    or "exercise",
2026-02-20T22:09:16.3806438Z                  }
2026-02-20T22:09:16.3806737Z  
2026-02-20T22:09:16.3807127Z                  # Ajouter les informations de l'exercice si disponible
2026-02-20T22:09:16.3807943Z                  if rec.exercise_id:
2026-02-20T22:09:16.3808427Z                      rec_data["exercise_id"] = rec.exercise_id
2026-02-20T22:09:16.3809229Z                      # Optionnel: récupérer le titre et la question de l'exercice
2026-02-20T22:09:16.3809834Z                      try:
2026-02-20T22:09:16.3810352Z                          from app.services.exercise_service import ExerciseService
2026-02-20T22:09:16.3811164Z +
2026-02-20T22:09:16.3811611Z                          exercise = ExerciseService.get_exercise(db, rec.exercise_id)
2026-02-20T22:09:16.3812214Z                          if exercise:
2026-02-20T22:09:16.3812711Z                              rec_data["exercise_title"] = exercise.title
2026-02-20T22:09:16.3813516Z                              rec_data["exercise_question"] = exercise.question
2026-02-20T22:09:16.3814090Z                      except Exception:
2026-02-20T22:09:16.3814496Z @@ -82,25 +93,39 @@
2026-02-20T22:09:16.3814785Z  
2026-02-20T22:09:16.3815463Z                  # Ajouter les informations du défi si disponible (recommandation challenge)
2026-02-20T22:09:16.3816214Z                  if getattr(rec, "challenge_id", None):
2026-02-20T22:09:16.3816764Z                      rec_data["challenge_id"] = rec.challenge_id
2026-02-20T22:09:16.3817245Z                      try:
2026-02-20T22:09:16.3817847Z -                        from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:16.3818797Z -                        challenge = LogicChallengeService.get_challenge(db, rec.challenge_id)
2026-02-20T22:09:16.3819603Z +                        from app.services.logic_challenge_service import (
2026-02-20T22:09:16.3820200Z +                            LogicChallengeService,
2026-02-20T22:09:16.3820648Z +                        )
2026-02-20T22:09:16.3820980Z +
2026-02-20T22:09:16.3821360Z +                        challenge = LogicChallengeService.get_challenge(
2026-02-20T22:09:16.3821953Z +                            db, rec.challenge_id
2026-02-20T22:09:16.3822400Z +                        )
2026-02-20T22:09:16.3822767Z                          if challenge:
2026-02-20T22:09:16.3853659Z -                            rec_data["challenge_title"] = getattr(challenge, "title", None)
2026-02-20T22:09:16.3854605Z -                            rec_data["exercise_title"] = rec_data.get("exercise_title") or challenge.title
2026-02-20T22:09:16.3855423Z +                            rec_data["challenge_title"] = getattr(
2026-02-20T22:09:16.3855969Z +                                challenge, "title", None
2026-02-20T22:09:16.3856438Z +                            )
2026-02-20T22:09:16.3856845Z +                            rec_data["exercise_title"] = (
2026-02-20T22:09:16.3857449Z +                                rec_data.get("exercise_title") or challenge.title
2026-02-20T22:09:16.3857997Z +                            )
2026-02-20T22:09:16.3858372Z                      except Exception:
2026-02-20T22:09:16.3858781Z                          pass
2026-02-20T22:09:16.3859124Z  
2026-02-20T22:09:16.3859466Z                  recommendations_data.append(rec_data)
2026-02-20T22:09:16.3859917Z  
2026-02-20T22:09:16.3860253Z              return JSONResponse(recommendations_data)
2026-02-20T22:09:16.3860834Z      except Exception as recommendations_retrieval_error:
2026-02-20T22:09:16.3861964Z -        logger.error(f"Erreur lors de la récupération des recommandations: {recommendations_retrieval_error}")
2026-02-20T22:09:16.3862838Z +        logger.error(
2026-02-20T22:09:16.3863823Z +            f"Erreur lors de la récupération des recommandations: {recommendations_retrieval_error}"
2026-02-20T22:09:16.3864567Z +        )
2026-02-20T22:09:16.3864863Z          traceback.print_exc()
2026-02-20T22:09:16.3865664Z -        return JSONResponse({"error": get_safe_error_message(recommendations_retrieval_error)}, status_code=500)
2026-02-20T22:09:16.3866513Z +        return JSONResponse(
2026-02-20T22:09:16.3867060Z +            {"error": get_safe_error_message(recommendations_retrieval_error)},
2026-02-20T22:09:16.3867939Z +            status_code=500,
2026-02-20T22:09:16.3868292Z +        )
2026-02-20T22:09:16.3868561Z  
2026-02-20T22:09:16.3868802Z  
2026-02-20T22:09:16.3869060Z  @require_auth
2026-02-20T22:09:16.3869415Z  async def generate_recommendations(request):
2026-02-20T22:09:16.3869867Z      """
2026-02-20T22:09:16.3870339Z @@ -112,20 +137,29 @@
2026-02-20T22:09:16.3870704Z          user_id = current_user.get("id")
2026-02-20T22:09:16.3871140Z          if not user_id:
2026-02-20T22:09:16.3871720Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3872365Z  
2026-02-20T22:09:16.3872643Z          async with db_session() as db:
2026-02-20T22:09:16.3873528Z -            recommendations = RecommendationService.generate_recommendations(db, user_id)
2026-02-20T22:09:16.3874489Z +            recommendations = RecommendationService.generate_recommendations(
2026-02-20T22:09:16.3875130Z +                db, user_id
2026-02-20T22:09:16.3875485Z +            )
2026-02-20T22:09:16.3875773Z              db.commit()
2026-02-20T22:09:16.3876126Z -            return JSONResponse({
2026-02-20T22:09:16.3876771Z -                "message": "Recommandations générées avec succès",
2026-02-20T22:09:16.3877442Z -                "count": len(recommendations) if recommendations else 0,
2026-02-20T22:09:16.3877995Z -            })
2026-02-20T22:09:16.3878321Z +            return JSONResponse(
2026-02-20T22:09:16.3878698Z +                {
2026-02-20T22:09:16.3879242Z +                    "message": "Recommandations générées avec succès",
2026-02-20T22:09:16.3879910Z +                    "count": len(recommendations) if recommendations else 0,
2026-02-20T22:09:16.3880454Z +                }
2026-02-20T22:09:16.3880741Z +            )
2026-02-20T22:09:16.3881135Z      except Exception as recommendations_generation_error:
2026-02-20T22:09:16.3882199Z -        logger.error(f"Erreur lors de la génération des recommandations: {recommendations_generation_error}")
2026-02-20T22:09:16.3913267Z +        logger.error(
2026-02-20T22:09:16.3914163Z +            f"Erreur lors de la génération des recommandations: {recommendations_generation_error}"
2026-02-20T22:09:16.3914902Z +        )
2026-02-20T22:09:16.3915219Z          traceback.print_exc()
2026-02-20T22:09:16.3916041Z -        return JSONResponse({"error": get_safe_error_message(recommendations_generation_error)}, status_code=500)
2026-02-20T22:09:16.3916943Z +        return JSONResponse(
2026-02-20T22:09:16.3917512Z +            {"error": get_safe_error_message(recommendations_generation_error)},
2026-02-20T22:09:16.3918122Z +            status_code=500,
2026-02-20T22:09:16.3918472Z +        )
2026-02-20T22:09:16.3918730Z  
2026-02-20T22:09:16.3918973Z  
2026-02-20T22:09:16.3919219Z  @require_auth
2026-02-20T22:09:16.3919608Z  async def handle_recommendation_complete(request):
2026-02-20T22:09:16.3920093Z      """
2026-02-20T22:09:16.3920355Z @@ -140,23 +174,33 @@
2026-02-20T22:09:16.3920910Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3921561Z  
2026-02-20T22:09:16.3921849Z          data = await request.json()
2026-02-20T22:09:16.3922349Z          recommendation_id = data.get("recommendation_id")
2026-02-20T22:09:16.3922884Z          if recommendation_id is None:
2026-02-20T22:09:16.3923716Z -            return JSONResponse({"error": "recommendation_id manquant"}, status_code=400)
2026-02-20T22:09:16.3924436Z +            return JSONResponse(
2026-02-20T22:09:16.3924956Z +                {"error": "recommendation_id manquant"}, status_code=400
2026-02-20T22:09:16.3925484Z +            )
2026-02-20T22:09:16.3925767Z          try:
2026-02-20T22:09:16.3926127Z              recommendation_id = int(recommendation_id)
2026-02-20T22:09:16.3926648Z          except (TypeError, ValueError):
2026-02-20T22:09:16.3927329Z -            return JSONResponse({"error": "recommendation_id invalide"}, status_code=400)
2026-02-20T22:09:16.3928041Z +            return JSONResponse(
2026-02-20T22:09:16.3928820Z +                {"error": "recommendation_id invalide"}, status_code=400
2026-02-20T22:09:16.3929359Z +            )
2026-02-20T22:09:16.3929642Z  
2026-02-20T22:09:16.3929920Z          async with db_session() as db:
2026-02-20T22:09:16.3930389Z -            rec = db.query(Recommendation).filter(
2026-02-20T22:09:16.3931101Z -                Recommendation.id == recommendation_id,
2026-02-20T22:09:16.3931628Z -                Recommendation.user_id == user_id,
2026-02-20T22:09:16.3932078Z -            ).first()
2026-02-20T22:09:16.3932395Z +            rec = (
2026-02-20T22:09:16.3932729Z +                db.query(Recommendation)
2026-02-20T22:09:16.3933334Z +                .filter(
2026-02-20T22:09:16.3933769Z +                    Recommendation.id == recommendation_id,
2026-02-20T22:09:16.3934309Z +                    Recommendation.user_id == user_id,
2026-02-20T22:09:16.3934763Z +                )
2026-02-20T22:09:16.3935058Z +                .first()
2026-02-20T22:09:16.3935384Z +            )
2026-02-20T22:09:16.3935666Z              if not rec:
2026-02-20T22:09:16.3936455Z -                return JSONResponse({"error": "Recommandation non trouvée"}, status_code=404)
2026-02-20T22:09:16.3937176Z +                return JSONResponse(
2026-02-20T22:09:16.3937855Z +                    {"error": "Recommandation non trouvée"}, status_code=404
2026-02-20T22:09:16.3938415Z +                )
2026-02-20T22:09:16.3938734Z              rec.is_completed = True
2026-02-20T22:09:16.3939241Z              rec.completed_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.3939739Z              db.commit()
2026-02-20T22:09:16.3940082Z              db.refresh(rec)
2026-02-20T22:09:16.3940417Z  
2026-02-20T22:09:16.3940675Z @@ -166,6 +210,5 @@
2026-02-20T22:09:16.3940958Z          )
2026-02-20T22:09:16.3941253Z      except Exception as e:
2026-02-20T22:09:16.3942015Z          logger.error(f"Erreur lors de la gestion de la recommandation complétée: {e}")
2026-02-20T22:09:16.3942714Z          traceback.print_exc()
2026-02-20T22:09:16.3973606Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:16.3974270Z -
2026-02-20T22:09:16.9654240Z --- /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:16.9657053Z +++ /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py	2026-02-20 22:09:16.946229+00:00
2026-02-20T22:09:16.9659285Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.9660899Z  """
2026-02-20T22:09:16.9662841Z  Handlers pour l'espace admin (rôle archiviste).
2026-02-20T22:09:16.9664822Z  """
2026-02-20T22:09:16.9665501Z +
2026-02-20T22:09:16.9665824Z  import csv
2026-02-20T22:09:16.9666119Z  import io
2026-02-20T22:09:16.9666419Z  import json
2026-02-20T22:09:16.9666716Z  import os
2026-02-20T22:09:16.9667120Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:16.9667636Z @@ -63,16 +64,50 @@
2026-02-20T22:09:16.9668073Z      return JSONResponse({"status": "ok", "admin": True})
2026-02-20T22:09:16.9668625Z  
2026-02-20T22:09:16.9668967Z  
2026-02-20T22:09:16.9669634Z  # Schéma des paramètres globaux (connus et modifiables par l'admin)
2026-02-20T22:09:16.9670250Z  CONFIG_SCHEMA = {
2026-02-20T22:09:16.9671104Z -    "maintenance_mode": {"type": "bool", "default": False, "category": "système", "label": "Mode maintenance"},
2026-02-20T22:09:16.9672566Z -    "registration_enabled": {"type": "bool", "default": True, "category": "système", "label": "Inscriptions ouvertes"},
2026-02-20T22:09:16.9674350Z -    "feature_ai_challenges_enabled": {"type": "bool", "default": True, "category": "features", "label": "Défis IA activés"},
2026-02-20T22:09:16.9675839Z -    "feature_chat_enabled": {"type": "bool", "default": True, "category": "features", "label": "Chat IA activé"},
2026-02-20T22:09:16.9677492Z -    "max_generations_per_user_per_hour": {"type": "int", "default": 20, "min": 1, "max": 100, "category": "limites", "label": "Générations max/user/heure"},
2026-02-20T22:09:16.9679468Z -    "max_export_rows": {"type": "int", "default": 10000, "min": 100, "max": 100000, "category": "limites", "label": "Lignes max export CSV"},
2026-02-20T22:09:16.9680425Z +    "maintenance_mode": {
2026-02-20T22:09:16.9680806Z +        "type": "bool",
2026-02-20T22:09:16.9681156Z +        "default": False,
2026-02-20T22:09:16.9681622Z +        "category": "système",
2026-02-20T22:09:16.9682325Z +        "label": "Mode maintenance",
2026-02-20T22:09:16.9682743Z +    },
2026-02-20T22:09:16.9683250Z +    "registration_enabled": {
2026-02-20T22:09:16.9683654Z +        "type": "bool",
2026-02-20T22:09:16.9684019Z +        "default": True,
2026-02-20T22:09:16.9684491Z +        "category": "système",
2026-02-20T22:09:16.9684992Z +        "label": "Inscriptions ouvertes",
2026-02-20T22:09:16.9685428Z +    },
2026-02-20T22:09:16.9685748Z +    "feature_ai_challenges_enabled": {
2026-02-20T22:09:16.9686176Z +        "type": "bool",
2026-02-20T22:09:16.9686537Z +        "default": True,
2026-02-20T22:09:16.9686919Z +        "category": "features",
2026-02-20T22:09:16.9687444Z +        "label": "Défis IA activés",
2026-02-20T22:09:16.9687855Z +    },
2026-02-20T22:09:16.9688143Z +    "feature_chat_enabled": {
2026-02-20T22:09:16.9688522Z +        "type": "bool",
2026-02-20T22:09:16.9688859Z +        "default": True,
2026-02-20T22:09:16.9689221Z +        "category": "features",
2026-02-20T22:09:16.9690166Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py
2026-02-20T22:09:16.9691042Z +        "label": "Chat IA activé",
2026-02-20T22:09:16.9691431Z +    },
2026-02-20T22:09:16.9691747Z +    "max_generations_per_user_per_hour": {
2026-02-20T22:09:16.9692195Z +        "type": "int",
2026-02-20T22:09:16.9692531Z +        "default": 20,
2026-02-20T22:09:16.9692863Z +        "min": 1,
2026-02-20T22:09:16.9693371Z +        "max": 100,
2026-02-20T22:09:16.9693716Z +        "category": "limites",
2026-02-20T22:09:16.9694259Z +        "label": "Générations max/user/heure",
2026-02-20T22:09:16.9694726Z +    },
2026-02-20T22:09:16.9695008Z +    "max_export_rows": {
2026-02-20T22:09:16.9695366Z +        "type": "int",
2026-02-20T22:09:16.9695698Z +        "default": 10000,
2026-02-20T22:09:16.9696047Z +        "min": 100,
2026-02-20T22:09:16.9696362Z +        "max": 100000,
2026-02-20T22:09:16.9696696Z +        "category": "limites",
2026-02-20T22:09:16.9697118Z +        "label": "Lignes max export CSV",
2026-02-20T22:09:16.9697543Z +    },
2026-02-20T22:09:16.9697806Z  }
2026-02-20T22:09:16.9698057Z  
2026-02-20T22:09:16.9698308Z  
2026-02-20T22:09:16.9698810Z  def _parse_setting_value(value: str | None, schema: dict) -> bool | int | str:
2026-02-20T22:09:16.9699489Z      if value is None:
2026-02-20T22:09:16.9699831Z @@ -113,19 +148,21 @@
2026-02-20T22:09:16.9700159Z      result = []
2026-02-20T22:09:16.9700522Z      for key, schema in CONFIG_SCHEMA.items():
2026-02-20T22:09:16.9700986Z          row = by_key.get(key)
2026-02-20T22:09:16.9701401Z          raw = row.value if row else None
2026-02-20T22:09:16.9701892Z          value = _parse_setting_value(raw, schema)
2026-02-20T22:09:16.9702379Z -        result.append({
2026-02-20T22:09:16.9702737Z -            "key": key,
2026-02-20T22:09:16.9703288Z -            "value": value,
2026-02-20T22:09:16.9703669Z -            "type": schema["type"],
2026-02-20T22:09:16.9704143Z -            "category": schema.get("category", ""),
2026-02-20T22:09:16.9704676Z -            "label": schema.get("label", key),
2026-02-20T22:09:16.9705152Z -            "min": schema.get("min"),
2026-02-20T22:09:16.9705587Z -            "max": schema.get("max"),
2026-02-20T22:09:16.9705972Z -        })
2026-02-20T22:09:16.9706270Z +        result.append(
2026-02-20T22:09:16.9706585Z +            {
2026-02-20T22:09:16.9706882Z +                "key": key,
2026-02-20T22:09:16.9707238Z +                "value": value,
2026-02-20T22:09:16.9707717Z +                "type": schema["type"],
2026-02-20T22:09:16.9708199Z +                "category": schema.get("category", ""),
2026-02-20T22:09:16.9709017Z +                "label": schema.get("label", key),
2026-02-20T22:09:16.9709516Z +                "min": schema.get("min"),
2026-02-20T22:09:16.9709965Z +                "max": schema.get("max"),
2026-02-20T22:09:16.9710384Z +            }
2026-02-20T22:09:16.9710663Z +        )
2026-02-20T22:09:16.9711010Z      return JSONResponse({"settings": result})
2026-02-20T22:09:16.9711722Z  
2026-02-20T22:09:16.9711984Z  
2026-02-20T22:09:16.9712243Z  @require_auth
2026-02-20T22:09:16.9712546Z  @require_admin
2026-02-20T22:09:16.9712846Z @@ -139,11 +176,13 @@
2026-02-20T22:09:16.9713407Z          body = await request.json()
2026-02-20T22:09:16.9713839Z      except Exception:
2026-02-20T22:09:16.9714385Z          return JSONResponse({"detail": "Body JSON invalide"}, status_code=400)
2026-02-20T22:09:16.9715091Z      settings_in = body.get("settings") or {}
2026-02-20T22:09:16.9715587Z      if not isinstance(settings_in, dict):
2026-02-20T22:09:16.9716507Z -        return JSONResponse({"detail": "'settings' doit être un objet"}, status_code=400)
2026-02-20T22:09:16.9717254Z +        return JSONResponse(
2026-02-20T22:09:16.9717905Z +            {"detail": "'settings' doit être un objet"}, status_code=400
2026-02-20T22:09:16.9718465Z +        )
2026-02-20T22:09:16.9718735Z  
2026-02-20T22:09:16.9719031Z      async with db_session() as db:
2026-02-20T22:09:16.9719595Z          admin_user_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9720233Z          for key, value in settings_in.items():
2026-02-20T22:09:16.9720716Z              if key not in CONFIG_SCHEMA:
2026-02-20T22:09:16.9721151Z @@ -151,11 +190,15 @@
2026-02-20T22:09:16.9721568Z              schema = CONFIG_SCHEMA[key]
2026-02-20T22:09:16.9722041Z              str_val = _serialize_value(value)
2026-02-20T22:09:16.9722502Z              # Validation
2026-02-20T22:09:16.9722881Z              if schema["type"] == "int":
2026-02-20T22:09:16.9723558Z                  try:
2026-02-20T22:09:16.9724166Z -                    v = int(value) if not isinstance(value, (bool, type(None))) else schema["default"]
2026-02-20T22:09:16.9724899Z +                    v = (
2026-02-20T22:09:16.9725254Z +                        int(value)
2026-02-20T22:09:16.9725761Z +                        if not isinstance(value, (bool, type(None)))
2026-02-20T22:09:16.9726313Z +                        else schema["default"]
2026-02-20T22:09:16.9726773Z +                    )
2026-02-20T22:09:16.9727161Z                      if "min" in schema and v < schema["min"]:
2026-02-20T22:09:16.9727646Z                          v = schema["min"]
2026-02-20T22:09:16.9728133Z                      if "max" in schema and v > schema["max"]:
2026-02-20T22:09:16.9728639Z                          v = schema["max"]
2026-02-20T22:09:16.9729083Z                      str_val = str(v)
2026-02-20T22:09:16.9729487Z @@ -167,21 +210,27 @@
2026-02-20T22:09:16.9729957Z              row = db.query(Setting).filter(Setting.key == key).first()
2026-02-20T22:09:16.9730510Z              if row:
2026-02-20T22:09:16.9730880Z                  row.value = str_val
2026-02-20T22:09:16.9731409Z                  row.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9731905Z              else:
2026-02-20T22:09:16.9732241Z -                db.add(Setting(
2026-02-20T22:09:16.9732634Z -                    key=key,
2026-02-20T22:09:16.9733224Z -                    value=str_val,
2026-02-20T22:09:16.9733707Z -                    category=schema.get("category"),
2026-02-20T22:09:16.9734240Z -                    description=schema.get("label"),
2026-02-20T22:09:16.9734720Z -                    is_system=True,
2026-02-20T22:09:16.9735145Z -                    is_public=False,
2026-02-20T22:09:16.9735549Z -                ))
2026-02-20T22:09:16.9735854Z +                db.add(
2026-02-20T22:09:16.9736203Z +                    Setting(
2026-02-20T22:09:16.9736562Z +                        key=key,
2026-02-20T22:09:16.9736960Z +                        value=str_val,
2026-02-20T22:09:16.9737433Z +                        category=schema.get("category"),
2026-02-20T22:09:16.9738307Z +                        description=schema.get("label"),
2026-02-20T22:09:16.9738808Z +                        is_system=True,
2026-02-20T22:09:16.9739254Z +                        is_public=False,
2026-02-20T22:09:16.9739679Z +                    )
2026-02-20T22:09:16.9739997Z +                )
2026-02-20T22:09:16.9740563Z  
2026-02-20T22:09:16.9740877Z          _log_admin_action(
2026-02-20T22:09:16.9741371Z -            db, admin_user_id, "config_update", "settings", None,
2026-02-20T22:09:16.9741907Z +            db,
2026-02-20T22:09:16.9742228Z +            admin_user_id,
2026-02-20T22:09:16.9742593Z +            "config_update",
2026-02-20T22:09:16.9743178Z +            "settings",
2026-02-20T22:09:16.9743531Z +            None,
2026-02-20T22:09:16.9743935Z              {"updated_keys": list(settings_in.keys())},
2026-02-20T22:09:16.9744440Z          )
2026-02-20T22:09:16.9744788Z          db.commit()
2026-02-20T22:09:16.9745122Z  
2026-02-20T22:09:16.9745429Z      return JSONResponse({"status": "ok"})
2026-02-20T22:09:16.9745874Z @@ -194,22 +243,35 @@
2026-02-20T22:09:16.9746213Z      GET /api/admin/overview
2026-02-20T22:09:16.9746631Z      KPIs globaux de la plateforme.
2026-02-20T22:09:16.9747030Z      """
2026-02-20T22:09:16.9747341Z      async with db_session() as db:
2026-02-20T22:09:16.9747889Z          total_users = db.query(func.count(User.id)).scalar() or 0
2026-02-20T22:09:16.9748855Z -        total_exercises = db.query(func.count(Exercise.id)).filter(Exercise.is_archived == False).scalar() or 0
2026-02-20T22:09:16.9750218Z -        total_challenges = db.query(func.count(LogicChallenge.id)).filter(LogicChallenge.is_archived == False).scalar() or 0
2026-02-20T22:09:16.9751183Z +        total_exercises = (
2026-02-20T22:09:16.9751615Z +            db.query(func.count(Exercise.id))
2026-02-20T22:09:16.9752117Z +            .filter(Exercise.is_archived == False)
2026-02-20T22:09:16.9752586Z +            .scalar()
2026-02-20T22:09:16.9752914Z +            or 0
2026-02-20T22:09:16.9753413Z +        )
2026-02-20T22:09:16.9753726Z +        total_challenges = (
2026-02-20T22:09:16.9754161Z +            db.query(func.count(LogicChallenge.id))
2026-02-20T22:09:16.9754733Z +            .filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:16.9755224Z +            .scalar()
2026-02-20T22:09:16.9755562Z +            or 0
2026-02-20T22:09:16.9755849Z +        )
2026-02-20T22:09:16.9756170Z          # Tentatives (table attempts)
2026-02-20T22:09:16.9756642Z          from app.models.attempt import Attempt
2026-02-20T22:09:16.9757099Z +
2026-02-20T22:09:16.9757551Z          total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:16.9758141Z  
2026-02-20T22:09:16.9758436Z -    return JSONResponse({
2026-02-20T22:09:16.9758833Z -        "total_users": total_users,
2026-02-20T22:09:16.9759294Z -        "total_exercises": total_exercises,
2026-02-20T22:09:16.9759782Z -        "total_challenges": total_challenges,
2026-02-20T22:09:16.9760275Z -        "total_attempts": total_attempts,
2026-02-20T22:09:16.9760692Z -    })
2026-02-20T22:09:16.9760971Z +    return JSONResponse(
2026-02-20T22:09:16.9761300Z +        {
2026-02-20T22:09:16.9761607Z +            "total_users": total_users,
2026-02-20T22:09:16.9762062Z +            "total_exercises": total_exercises,
2026-02-20T22:09:16.9762555Z +            "total_challenges": total_challenges,
2026-02-20T22:09:16.9763236Z +            "total_attempts": total_attempts,
2026-02-20T22:09:16.9763647Z +        }
2026-02-20T22:09:16.9763908Z +    )
2026-02-20T22:09:16.9764164Z  
2026-02-20T22:09:16.9764421Z  
2026-02-20T22:09:16.9764680Z  @require_auth
2026-02-20T22:09:16.9764977Z  @require_admin
2026-02-20T22:09:16.9765325Z  async def admin_users(request: Request):
2026-02-20T22:09:16.9765776Z @@ -235,31 +297,38 @@
2026-02-20T22:09:16.9766169Z                      User.username.ilike(pattern),
2026-02-20T22:09:16.9766668Z                      User.email.ilike(pattern),
2026-02-20T22:09:16.9767441Z                      User.full_name.ilike(pattern),
2026-02-20T22:09:16.9767890Z                  )
2026-02-20T22:09:16.9768168Z              )
2026-02-20T22:09:16.9769006Z -        role_map = {"padawan": UserRole.PADAWAN, "maitre": UserRole.MAITRE, "gardien": UserRole.GARDIEN, "archiviste": UserRole.ARCHIVISTE}
2026-02-20T22:09:16.9770273Z +        role_map = {
2026-02-20T22:09:16.9770632Z +            "padawan": UserRole.PADAWAN,
2026-02-20T22:09:16.9771101Z +            "maitre": UserRole.MAITRE,
2026-02-20T22:09:16.9771555Z +            "gardien": UserRole.GARDIEN,
2026-02-20T22:09:16.9772024Z +            "archiviste": UserRole.ARCHIVISTE,
2026-02-20T22:09:16.9772484Z +        }
2026-02-20T22:09:16.9772797Z          if role and role in role_map:
2026-02-20T22:09:16.9773499Z              q = q.filter(User.role == role_map[role])
2026-02-20T22:09:16.9773994Z          if is_active_param is not None:
2026-02-20T22:09:16.9774571Z              is_active = str(is_active_param).lower() in ("true", "1", "yes")
2026-02-20T22:09:16.9775215Z              q = q.filter(User.is_active == is_active)
2026-02-20T22:09:16.9775678Z          total = q.count()
2026-02-20T22:09:16.9776227Z          users = q.order_by(User.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:16.9776837Z  
2026-02-20T22:09:16.9777093Z          items = []
2026-02-20T22:09:16.9777408Z          for u in users:
2026-02-20T22:09:16.9777765Z -            items.append({
2026-02-20T22:09:16.9778135Z -                "id": u.id,
2026-02-20T22:09:16.9778524Z -                "username": u.username,
2026-02-20T22:09:16.9778954Z -                "email": u.email,
2026-02-20T22:09:16.9779377Z -                "full_name": u.full_name,
2026-02-20T22:09:16.9779899Z -                "role": u.role.value if u.role else "padawan",
2026-02-20T22:09:16.9780431Z -                "is_active": u.is_active,
2026-02-20T22:09:16.9780933Z -                "is_email_verified": u.is_email_verified,
2026-02-20T22:09:16.9781583Z -                "created_at": u.created_at.isoformat() if u.created_at else None,
2026-02-20T22:09:16.9782200Z -            })
2026-02-20T22:09:16.9782504Z +            items.append(
2026-02-20T22:09:16.9782848Z +                {
2026-02-20T22:09:16.9783339Z +                    "id": u.id,
2026-02-20T22:09:16.9783745Z +                    "username": u.username,
2026-02-20T22:09:16.9784199Z +                    "email": u.email,
2026-02-20T22:09:16.9784635Z +                    "full_name": u.full_name,
2026-02-20T22:09:16.9785259Z +                    "role": u.role.value if u.role else "padawan",
2026-02-20T22:09:16.9785813Z +                    "is_active": u.is_active,
2026-02-20T22:09:16.9786328Z +                    "is_email_verified": u.is_email_verified,
2026-02-20T22:09:16.9787010Z +                    "created_at": u.created_at.isoformat() if u.created_at else None,
2026-02-20T22:09:16.9787634Z +                }
2026-02-20T22:09:16.9787949Z +            )
2026-02-20T22:09:16.9788226Z  
2026-02-20T22:09:16.9788626Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:16.9789132Z  
2026-02-20T22:09:16.9789393Z  
2026-02-20T22:09:16.9789650Z  @require_auth
2026-02-20T22:09:16.9789962Z @@ -287,17 +356,24 @@
2026-02-20T22:09:16.9790307Z          return JSONResponse(
2026-02-20T22:09:16.9791013Z              {"error": "Le champ is_active doit être un booléen."},
2026-02-20T22:09:16.9791588Z              status_code=400,
2026-02-20T22:09:16.9791952Z          )
2026-02-20T22:09:16.9792218Z  
2026-02-20T22:09:16.9793243Z -    role_map = {"padawan": UserRole.PADAWAN, "maitre": UserRole.MAITRE, "gardien": UserRole.GARDIEN, "archiviste": UserRole.ARCHIVISTE}
2026-02-20T22:09:16.9794169Z +    role_map = {
2026-02-20T22:09:16.9794529Z +        "padawan": UserRole.PADAWAN,
2026-02-20T22:09:16.9794988Z +        "maitre": UserRole.MAITRE,
2026-02-20T22:09:16.9795420Z +        "gardien": UserRole.GARDIEN,
2026-02-20T22:09:16.9795879Z +        "archiviste": UserRole.ARCHIVISTE,
2026-02-20T22:09:16.9796311Z +    }
2026-02-20T22:09:16.9796854Z      new_role = None
2026-02-20T22:09:16.9797185Z      if role_raw is not None:
2026-02-20T22:09:16.9797577Z          r = str(role_raw).strip().lower()
2026-02-20T22:09:16.9798027Z          if r not in role_map:
2026-02-20T22:09:16.9798405Z              return JSONResponse(
2026-02-20T22:09:16.9799212Z -                {"error": "Rôle invalide. Valeurs: padawan, maitre, gardien, archiviste."},
2026-02-20T22:09:16.9800104Z +                {
2026-02-20T22:09:16.9800824Z +                    "error": "Rôle invalide. Valeurs: padawan, maitre, gardien, archiviste."
2026-02-20T22:09:16.9801482Z +                },
2026-02-20T22:09:16.9801804Z                  status_code=400,
2026-02-20T22:09:16.9802162Z              )
2026-02-20T22:09:16.9802450Z          new_role = role_map[r]
2026-02-20T22:09:16.9802814Z  
2026-02-20T22:09:16.9803335Z      if is_active is None and new_role is None:
2026-02-20T22:09:16.9803816Z @@ -328,11 +404,18 @@
2026-02-20T22:09:16.9804127Z              )
2026-02-20T22:09:16.9804464Z          if is_active is not None:
2026-02-20T22:09:16.9804883Z              user.is_active = is_active
2026-02-20T22:09:16.9805323Z          if new_role is not None:
2026-02-20T22:09:16.9805716Z              user.role = new_role
2026-02-20T22:09:16.9806524Z -        _log_admin_action(db, current_user_id, "user_patch", "user", user_id, {"is_active": is_active, "role": role_raw})
2026-02-20T22:09:16.9807412Z +        _log_admin_action(
2026-02-20T22:09:16.9807755Z +            db,
2026-02-20T22:09:16.9808072Z +            current_user_id,
2026-02-20T22:09:16.9808448Z +            "user_patch",
2026-02-20T22:09:16.9808802Z +            "user",
2026-02-20T22:09:16.9809101Z +            user_id,
2026-02-20T22:09:16.9809480Z +            {"is_active": is_active, "role": role_raw},
2026-02-20T22:09:16.9809941Z +        )
2026-02-20T22:09:16.9810233Z          db.commit()
2026-02-20T22:09:16.9810571Z          db.refresh(user)
2026-02-20T22:09:16.9810909Z  
2026-02-20T22:09:16.9811179Z      result = {
2026-02-20T22:09:16.9811487Z          "id": user.id,
2026-02-20T22:09:16.9811831Z @@ -354,20 +437,25 @@
2026-02-20T22:09:16.9812178Z      async with db_session() as db:
2026-02-20T22:09:16.9812717Z          user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:16.9813458Z          if not user:
2026-02-20T22:09:16.9814204Z              return JSONResponse({"error": "Utilisateur non trouvé."}, status_code=404)
2026-02-20T22:09:16.9814874Z          if not user.is_active:
2026-02-20T22:09:16.9815826Z -            return JSONResponse({"error": "Compte désactivé, impossible d'envoyer l'email."}, status_code=400)
2026-02-20T22:09:16.9816709Z +            return JSONResponse(
2026-02-20T22:09:16.9817418Z +                {"error": "Compte désactivé, impossible d'envoyer l'email."},
2026-02-20T22:09:16.9818028Z +                status_code=400,
2026-02-20T22:09:16.9818412Z +            )
2026-02-20T22:09:16.9818710Z  
2026-02-20T22:09:16.9819045Z          reset_token = generate_verification_token()
2026-02-20T22:09:16.9819713Z          expires_at = datetime.now(timezone.utc) + timedelta(hours=1)
2026-02-20T22:09:16.9820363Z          user.password_reset_token = reset_token
2026-02-20T22:09:16.9820915Z          user.password_reset_expires_at = expires_at
2026-02-20T22:09:16.9821488Z          user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9821993Z          db.commit()
2026-02-20T22:09:16.9822296Z  
2026-02-20T22:09:16.9822875Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:16.9823861Z +        frontend_url = os.getenv(
2026-02-20T22:09:16.9824526Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:16.9825106Z +        )
2026-02-20T22:09:16.9825523Z          email_sent = EmailService.send_password_reset_email(
2026-02-20T22:09:16.9826073Z              to_email=user.email,
2026-02-20T22:09:16.9826493Z              username=user.username,
2026-02-20T22:09:16.9826922Z              reset_token=reset_token,
2026-02-20T22:09:16.9827677Z              frontend_url=frontend_url,
2026-02-20T22:09:16.9828093Z @@ -398,11 +486,13 @@
2026-02-20T22:09:16.9828612Z          verification_token = generate_verification_token()
2026-02-20T22:09:16.9829227Z          user.email_verification_token = verification_token
2026-02-20T22:09:16.9829905Z          user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9830742Z          db.commit()
2026-02-20T22:09:16.9831052Z  
2026-02-20T22:09:16.9831637Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:16.9832415Z +        frontend_url = os.getenv(
2026-02-20T22:09:16.9833178Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:16.9833763Z +        )
2026-02-20T22:09:16.9834161Z          email_sent = EmailService.send_verification_email(
2026-02-20T22:09:16.9834687Z              to_email=user.email,
2026-02-20T22:09:16.9835105Z              username=user.username,
2026-02-20T22:09:16.9835586Z              verification_token=verification_token,
2026-02-20T22:09:16.9836078Z              frontend_url=frontend_url,
2026-02-20T22:09:16.9836501Z @@ -455,11 +545,13 @@
2026-02-20T22:09:16.9836814Z          if ex_ids:
2026-02-20T22:09:16.9837123Z              rows = (
2026-02-20T22:09:16.9837449Z                  db.query(
2026-02-20T22:09:16.9837856Z                      Attempt.exercise_id,
2026-02-20T22:09:16.9838386Z                      func.count(Attempt.id).label("attempt_count"),
2026-02-20T22:09:16.9839188Z -                    func.sum(case((Attempt.is_correct == True, 1), else_=0)).label("correct_count"),
2026-02-20T22:09:16.9840089Z +                    func.sum(case((Attempt.is_correct == True, 1), else_=0)).label(
2026-02-20T22:09:16.9840723Z +                        "correct_count"
2026-02-20T22:09:16.9841143Z +                    ),
2026-02-20T22:09:16.9841460Z                  )
2026-02-20T22:09:16.9841847Z                  .filter(Attempt.exercise_id.in_(ex_ids))
2026-02-20T22:09:16.9842378Z                  .group_by(Attempt.exercise_id)
2026-02-20T22:09:16.9842837Z                  .all()
2026-02-20T22:09:16.9843359Z              )
2026-02-20T22:09:16.9843656Z @@ -473,21 +565,23 @@
2026-02-20T22:09:16.9843998Z          for e in exercises:
2026-02-20T22:09:16.9844581Z              stats = attempt_stats.get(e.id, {"attempt_count": 0, "correct_count": 0})
2026-02-20T22:09:16.9845291Z              a_count = stats["attempt_count"]
2026-02-20T22:09:16.9845761Z              c_count = stats["correct_count"]
2026-02-20T22:09:16.9846400Z              success_rate = round((c_count / a_count * 100), 1) if a_count > 0 else 0.0
2026-02-20T22:09:16.9847047Z -            items.append({
2026-02-20T22:09:16.9847429Z -                "id": e.id,
2026-02-20T22:09:16.9847804Z -                "title": e.title,
2026-02-20T22:09:16.9848250Z -                "exercise_type": e.exercise_type,
2026-02-20T22:09:16.9848757Z -                "difficulty": e.difficulty,
2026-02-20T22:09:16.9849232Z -                "age_group": e.age_group,
2026-02-20T22:09:16.9849707Z -                "is_archived": e.is_archived,
2026-02-20T22:09:16.9850170Z -                "attempt_count": a_count,
2026-02-20T22:09:16.9850633Z -                "success_rate": success_rate,
2026-02-20T22:09:16.9851249Z -                "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:16.9851865Z -            })
2026-02-20T22:09:16.9852185Z +            items.append(
2026-02-20T22:09:16.9852526Z +                {
2026-02-20T22:09:16.9852850Z +                    "id": e.id,
2026-02-20T22:09:16.9853435Z +                    "title": e.title,
2026-02-20T22:09:16.9853907Z +                    "exercise_type": e.exercise_type,
2026-02-20T22:09:16.9854418Z +                    "difficulty": e.difficulty,
2026-02-20T22:09:16.9854901Z +                    "age_group": e.age_group,
2026-02-20T22:09:16.9855374Z +                    "is_archived": e.is_archived,
2026-02-20T22:09:16.9856126Z +                    "attempt_count": a_count,
2026-02-20T22:09:16.9856606Z +                    "success_rate": success_rate,
2026-02-20T22:09:16.9857245Z +                    "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:16.9857865Z +                }
2026-02-20T22:09:16.9858165Z +            )
2026-02-20T22:09:16.9858695Z  
2026-02-20T22:09:16.9859077Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:16.9859590Z  
2026-02-20T22:09:16.9859841Z  
2026-02-20T22:09:16.9860142Z  def _exercise_to_detail(e) -> dict:
2026-02-20T22:09:16.9860559Z @@ -535,11 +629,13 @@
2026-02-20T22:09:16.9860876Z      if not title:
2026-02-20T22:09:16.9861441Z          return JSONResponse({"error": "Le titre est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9862126Z      if not question:
2026-02-20T22:09:16.9862735Z          return JSONResponse({"error": "La question est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9863639Z      if not correct_answer:
2026-02-20T22:09:16.9864534Z -        return JSONResponse({"error": "La réponse correcte est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9865297Z +        return JSONResponse(
2026-02-20T22:09:16.9865981Z +            {"error": "La réponse correcte est obligatoire."}, status_code=400
2026-02-20T22:09:16.9866561Z +        )
2026-02-20T22:09:16.9866846Z  
2026-02-20T22:09:16.9867139Z      async with db_session() as db:
2026-02-20T22:09:16.9867557Z          ex = Exercise(
2026-02-20T22:09:16.9867903Z              title=title,
2026-02-20T22:09:16.9868285Z              exercise_type=exercise_type,
2026-02-20T22:09:16.9868723Z @@ -554,11 +650,13 @@
2026-02-20T22:09:16.9869057Z              ai_generated=False,
2026-02-20T22:09:16.9869434Z          )
2026-02-20T22:09:16.9869705Z          db.add(ex)
2026-02-20T22:09:16.9870014Z          db.flush()
2026-02-20T22:09:16.9870417Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9871222Z -        _log_admin_action(db, admin_id, "exercise_create", "exercise", ex.id, {"title": ex.title})
2026-02-20T22:09:16.9871995Z +        _log_admin_action(
2026-02-20T22:09:16.9872548Z +            db, admin_id, "exercise_create", "exercise", ex.id, {"title": ex.title}
2026-02-20T22:09:16.9873363Z +        )
2026-02-20T22:09:16.9873652Z          db.commit()
2026-02-20T22:09:16.9873996Z          db.refresh(ex)
2026-02-20T22:09:16.9874495Z      return JSONResponse(_exercise_to_detail(ex), status_code=201)
2026-02-20T22:09:16.9875071Z  
2026-02-20T22:09:16.9875335Z  
2026-02-20T22:09:16.9875596Z @@ -583,13 +681,23 @@
2026-02-20T22:09:16.9875957Z          data = await request.json()
2026-02-20T22:09:16.9876390Z      except Exception:
2026-02-20T22:09:16.9876963Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:16.9877586Z  
2026-02-20T22:09:16.9877867Z      allowed_str = {
2026-02-20T22:09:16.9878337Z -        "title", "exercise_type", "difficulty", "age_group", "tags",
2026-02-20T22:09:16.9879055Z -        "context_theme", "complexity", "question", "correct_answer",
2026-02-20T22:09:16.9879712Z -        "explanation", "hint", "image_url", "audio_url",
2026-02-20T22:09:16.9880198Z +        "title",
2026-02-20T22:09:16.9880522Z +        "exercise_type",
2026-02-20T22:09:16.9880876Z +        "difficulty",
2026-02-20T22:09:16.9881205Z +        "age_group",
2026-02-20T22:09:16.9881590Z +        "tags",
2026-02-20T22:09:16.9881902Z +        "context_theme",
2026-02-20T22:09:16.9882250Z +        "complexity",
2026-02-20T22:09:16.9882590Z +        "question",
2026-02-20T22:09:16.9882912Z +        "correct_answer",
2026-02-20T22:09:16.9883476Z +        "explanation",
2026-02-20T22:09:16.9883815Z +        "hint",
2026-02-20T22:09:16.9884117Z +        "image_url",
2026-02-20T22:09:16.9884445Z +        "audio_url",
2026-02-20T22:09:16.9884743Z      }
2026-02-20T22:09:16.9885146Z      allowed_bool = {"is_active", "is_archived"}
2026-02-20T22:09:16.9885635Z      allowed_json = {"choices"}
2026-02-20T22:09:16.9886337Z  
2026-02-20T22:09:16.9886619Z      update_data = {}
2026-02-20T22:09:16.9886960Z @@ -607,11 +715,18 @@
2026-02-20T22:09:16.9887277Z          if not ex:
2026-02-20T22:09:16.9888020Z              return JSONResponse({"error": "Exercice non trouvé."}, status_code=404)
2026-02-20T22:09:16.9888733Z          for k, v in update_data.items():
2026-02-20T22:09:16.9889434Z              setattr(ex, k, v)
2026-02-20T22:09:16.9889937Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9890918Z -        _log_admin_action(db, admin_id, "exercise_update", "exercise", exercise_id, {"fields": list(update_data.keys())})
2026-02-20T22:09:16.9891826Z +        _log_admin_action(
2026-02-20T22:09:16.9892187Z +            db,
2026-02-20T22:09:16.9892500Z +            admin_id,
2026-02-20T22:09:16.9892841Z +            "exercise_update",
2026-02-20T22:09:16.9893437Z +            "exercise",
2026-02-20T22:09:16.9893789Z +            exercise_id,
2026-02-20T22:09:16.9894184Z +            {"fields": list(update_data.keys())},
2026-02-20T22:09:16.9894651Z +        )
2026-02-20T22:09:16.9894934Z          db.commit()
2026-02-20T22:09:16.9895264Z          db.refresh(ex)
2026-02-20T22:09:16.9895669Z      return JSONResponse(_exercise_to_detail(ex))
2026-02-20T22:09:16.9896139Z  
2026-02-20T22:09:16.9896394Z  
2026-02-20T22:09:16.9896659Z @@ -644,11 +759,18 @@
2026-02-20T22:09:16.9896998Z              is_archived=False,
2026-02-20T22:09:16.9897361Z          )
2026-02-20T22:09:16.9897634Z          db.add(copy)
2026-02-20T22:09:16.9897934Z          db.flush()
2026-02-20T22:09:16.9898362Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9899365Z -        _log_admin_action(db, admin_id, "exercise_duplicate", "exercise", copy.id, {"from_id": exercise_id, "title": copy.title})
2026-02-20T22:09:16.9900290Z +        _log_admin_action(
2026-02-20T22:09:16.9900645Z +            db,
2026-02-20T22:09:16.9900950Z +            admin_id,
2026-02-20T22:09:16.9901294Z +            "exercise_duplicate",
2026-02-20T22:09:16.9901715Z +            "exercise",
2026-02-20T22:09:16.9902065Z +            copy.id,
2026-02-20T22:09:16.9902465Z +            {"from_id": exercise_id, "title": copy.title},
2026-02-20T22:09:16.9902952Z +        )
2026-02-20T22:09:16.9903429Z          db.commit()
2026-02-20T22:09:16.9903765Z          db.refresh(copy)
2026-02-20T22:09:16.9904191Z      return JSONResponse(_exercise_to_detail(copy))
2026-02-20T22:09:16.9904668Z  
2026-02-20T22:09:16.9904915Z  
2026-02-20T22:09:16.9905186Z @@ -661,30 +783,42 @@
2026-02-20T22:09:16.9905522Z          data = await request.json()
2026-02-20T22:09:16.9905946Z      except Exception:
2026-02-20T22:09:16.9906512Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:16.9907200Z      is_archived = data.get("is_archived")
2026-02-20T22:09:16.9907697Z      if not isinstance(is_archived, bool):
2026-02-20T22:09:16.9908684Z -        return JSONResponse({"error": "Le champ is_archived doit être un booléen."}, status_code=400)
2026-02-20T22:09:16.9909508Z +        return JSONResponse(
2026-02-20T22:09:16.9910252Z +            {"error": "Le champ is_archived doit être un booléen."}, status_code=400
2026-02-20T22:09:16.9910882Z +        )
2026-02-20T22:09:16.9911159Z  
2026-02-20T22:09:16.9911447Z      async with db_session() as db:
2026-02-20T22:09:16.9912046Z          ex = db.query(Exercise).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:16.9912642Z          if not ex:
2026-02-20T22:09:16.9913561Z              return JSONResponse({"error": "Exercice non trouvé."}, status_code=404)
2026-02-20T22:09:16.9914247Z          ex.is_archived = is_archived
2026-02-20T22:09:16.9914790Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9915701Z -        _log_admin_action(db, admin_id, "exercise_archive", "exercise", exercise_id, {"is_archived": is_archived})
2026-02-20T22:09:16.9916526Z +        _log_admin_action(
2026-02-20T22:09:16.9916885Z +            db,
2026-02-20T22:09:16.9917466Z +            admin_id,
2026-02-20T22:09:16.9917816Z +            "exercise_archive",
2026-02-20T22:09:16.9918197Z +            "exercise",
2026-02-20T22:09:16.9918542Z +            exercise_id,
2026-02-20T22:09:16.9918912Z +            {"is_archived": is_archived},
2026-02-20T22:09:16.9919326Z +        )
2026-02-20T22:09:16.9919596Z          db.commit()
2026-02-20T22:09:16.9920167Z          db.refresh(ex)
2026-02-20T22:09:16.9920490Z  
2026-02-20T22:09:16.9920783Z -    return JSONResponse({
2026-02-20T22:09:16.9921159Z -        "id": ex.id,
2026-02-20T22:09:16.9921492Z -        "title": ex.title,
2026-02-20T22:09:16.9921891Z -        "is_archived": ex.is_archived,
2026-02-20T22:09:16.9922300Z -    })
2026-02-20T22:09:16.9922588Z +    return JSONResponse(
2026-02-20T22:09:16.9922929Z +        {
2026-02-20T22:09:16.9923437Z +            "id": ex.id,
2026-02-20T22:09:16.9923787Z +            "title": ex.title,
2026-02-20T22:09:16.9924197Z +            "is_archived": ex.is_archived,
2026-02-20T22:09:16.9924623Z +        }
2026-02-20T22:09:16.9924898Z +    )
2026-02-20T22:09:16.9925166Z  
2026-02-20T22:09:16.9925411Z  
2026-02-20T22:09:16.9925761Z  # ==================== ADMIN BADGES (Lot B-1) ====================
2026-02-20T22:09:16.9926251Z +
2026-02-20T22:09:16.9926505Z  
2026-02-20T22:09:16.9926863Z  def _achievement_to_detail(a: Achievement) -> dict:
2026-02-20T22:09:16.9927591Z      """Sérialise un badge pour l'édition admin."""
2026-02-20T22:09:16.9928060Z      return {
2026-02-20T22:09:16.9928359Z          "id": a.id,
2026-02-20T22:09:16.9928671Z @@ -708,11 +842,14 @@
2026-02-20T22:09:16.9928997Z      if req is None:
2026-02-20T22:09:16.9929378Z          return False, "requirements est requis"
2026-02-20T22:09:16.9929862Z      if not isinstance(req, dict):
2026-02-20T22:09:16.9930508Z          return False, "requirements doit être un objet JSON"
2026-02-20T22:09:16.9931043Z      if len(req) == 0:
2026-02-20T22:09:16.9932029Z -        return False, "requirements doit contenir au moins une clé (attempts_count, min_attempts+success_rate, etc.)"
2026-02-20T22:09:16.9933154Z +        return (
2026-02-20T22:09:16.9933486Z +            False,
2026-02-20T22:09:16.9934354Z +            "requirements doit contenir au moins une clé (attempts_count, min_attempts+success_rate, etc.)",
2026-02-20T22:09:16.9935142Z +        )
2026-02-20T22:09:16.9935420Z  
2026-02-20T22:09:16.9935673Z      # attempts_count
2026-02-20T22:09:16.9936026Z      if "attempts_count" in req:
2026-02-20T22:09:16.9936425Z          v = req.get("attempts_count")
2026-02-20T22:09:16.9936904Z          if not isinstance(v, (int, float)) or v < 1:
2026-02-20T22:09:16.9937385Z @@ -778,11 +915,13 @@
2026-02-20T22:09:16.9937698Z      """
2026-02-20T22:09:16.9937988Z      GET /api/admin/badges
2026-02-20T22:09:16.9938417Z      Liste tous les badges (actifs et inactifs).
2026-02-20T22:09:16.9938873Z      """
2026-02-20T22:09:16.9939167Z      async with db_session() as db:
2026-02-20T22:09:16.9939887Z -        badges = db.query(Achievement).order_by(Achievement.category, Achievement.code).all()
2026-02-20T22:09:16.9940637Z +        badges = (
2026-02-20T22:09:16.9941229Z +            db.query(Achievement).order_by(Achievement.category, Achievement.code).all()
2026-02-20T22:09:16.9941909Z +        )
2026-02-20T22:09:16.9942194Z          counts = (
2026-02-20T22:09:16.9942759Z              db.query(UserAchievement.achievement_id, func.count(UserAchievement.id))
2026-02-20T22:09:16.9943770Z              .group_by(UserAchievement.achievement_id)
2026-02-20T22:09:16.9944294Z              .all()
2026-02-20T22:09:16.9944604Z          )
2026-02-20T22:09:16.9964394Z @@ -812,16 +951,20 @@
2026-02-20T22:09:16.9965013Z          return JSONResponse({"error": "Le nom est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9965677Z  
2026-02-20T22:09:16.9966011Z      requirements = data.get("requirements")
2026-02-20T22:09:16.9966549Z      ok, err = _validate_requirements(requirements)
2026-02-20T22:09:16.9967015Z      if not ok:
2026-02-20T22:09:16.9967568Z -        return JSONResponse({"error": err or "Requirements invalides."}, status_code=400)
2026-02-20T22:09:16.9968557Z +        return JSONResponse(
2026-02-20T22:09:16.9969104Z +            {"error": err or "Requirements invalides."}, status_code=400
2026-02-20T22:09:16.9969670Z +        )
2026-02-20T22:09:16.9969945Z  
2026-02-20T22:09:16.9970243Z      async with db_session() as db:
2026-02-20T22:09:16.9971113Z          existing = db.query(Achievement).filter(Achievement.code == code).first()
2026-02-20T22:09:16.9971776Z          if existing:
2026-02-20T22:09:16.9972576Z -            return JSONResponse({"error": f"Le code '{code}' existe déjà."}, status_code=409)
2026-02-20T22:09:16.9973659Z +            return JSONResponse(
2026-02-20T22:09:16.9976128Z +                {"error": f"Le code '{code}' existe déjà."}, status_code=409
2026-02-20T22:09:16.9978633Z +            )
2026-02-20T22:09:16.9978957Z  
2026-02-20T22:09:16.9979237Z          a = Achievement(
2026-02-20T22:09:16.9979610Z              code=code,
2026-02-20T22:09:16.9982104Z              name=name,
2026-02-20T22:09:16.9984370Z              description=(data.get("description") or "").strip() or None,
2026-02-20T22:09:16.9986508Z @@ -835,11 +978,18 @@
2026-02-20T22:09:16.9986901Z              is_active=True,
2026-02-20T22:09:16.9987266Z          )
2026-02-20T22:09:16.9987559Z          db.add(a)
2026-02-20T22:09:16.9987894Z          db.flush()
2026-02-20T22:09:16.9988359Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9989299Z -        _log_admin_action(db, admin_id, "badge_create", "achievement", a.id, {"code": a.code, "name": a.name})
2026-02-20T22:09:16.9990114Z +        _log_admin_action(
2026-02-20T22:09:16.9990481Z +            db,
2026-02-20T22:09:16.9990779Z +            admin_id,
2026-02-20T22:09:16.9991123Z +            "badge_create",
2026-02-20T22:09:16.9991566Z +            "achievement",
2026-02-20T22:09:16.9991924Z +            a.id,
2026-02-20T22:09:16.9992264Z +            {"code": a.code, "name": a.name},
2026-02-20T22:09:16.9992707Z +        )
2026-02-20T22:09:16.9993341Z          db.commit()
2026-02-20T22:09:16.9993683Z          db.refresh(a)
2026-02-20T22:09:16.9994170Z      return JSONResponse(_achievement_to_detail(a), status_code=201)
2026-02-20T22:09:16.9994735Z  
2026-02-20T22:09:16.9995001Z  
2026-02-20T22:09:16.9995267Z @@ -851,11 +1001,16 @@
2026-02-20T22:09:16.9995637Z      async with db_session() as db:
2026-02-20T22:09:16.9996236Z          a = db.query(Achievement).filter(Achievement.id == badge_id).first()
2026-02-20T22:09:16.9996854Z          if not a:
2026-02-20T22:09:16.9997563Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:16.9998245Z          d = _achievement_to_detail(a)
2026-02-20T22:09:16.9999182Z -        user_count = db.query(func.count(UserAchievement.id)).filter(UserAchievement.achievement_id == badge_id).scalar() or 0
2026-02-20T22:09:17.0000153Z +        user_count = (
2026-02-20T22:09:17.0000578Z +            db.query(func.count(UserAchievement.id))
2026-02-20T22:09:17.0001212Z +            .filter(UserAchievement.achievement_id == badge_id)
2026-02-20T22:09:17.0001760Z +            .scalar()
2026-02-20T22:09:17.0002088Z +            or 0
2026-02-20T22:09:17.0002383Z +        )
2026-02-20T22:09:17.0002697Z          d["_user_count"] = user_count
2026-02-20T22:09:17.0003368Z          return JSONResponse(d)
2026-02-20T22:09:17.0003753Z  
2026-02-20T22:09:17.0003999Z  
2026-02-20T22:09:17.0004260Z  @require_auth
2026-02-20T22:09:17.0004563Z @@ -874,13 +1029,22 @@
2026-02-20T22:09:17.0005282Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:17.0005929Z  
2026-02-20T22:09:17.0006233Z          if "requirements" in data:
2026-02-20T22:09:17.0006775Z              ok, err = _validate_requirements(data.get("requirements"))
2026-02-20T22:09:17.0007348Z              if not ok:
2026-02-20T22:09:17.0007988Z -                return JSONResponse({"error": err or "Requirements invalides."}, status_code=400)
2026-02-20T22:09:17.0008980Z -
2026-02-20T22:09:17.0009575Z -        str_fields = ("name", "description", "icon_url", "category", "difficulty", "star_wars_title")
2026-02-20T22:09:17.0010444Z +                return JSONResponse(
2026-02-20T22:09:17.0011027Z +                    {"error": err or "Requirements invalides."}, status_code=400
2026-02-20T22:09:17.0011849Z +                )
2026-02-20T22:09:17.0012165Z +
2026-02-20T22:09:17.0012434Z +        str_fields = (
2026-02-20T22:09:17.0012779Z +            "name",
2026-02-20T22:09:17.0013320Z +            "description",
2026-02-20T22:09:17.0013681Z +            "icon_url",
2026-02-20T22:09:17.0014036Z +            "category",
2026-02-20T22:09:17.0014375Z +            "difficulty",
2026-02-20T22:09:17.0014739Z +            "star_wars_title",
2026-02-20T22:09:17.0015101Z +        )
2026-02-20T22:09:17.0015416Z          for k, v in data.items():
2026-02-20T22:09:17.0015798Z              if k == "code":
2026-02-20T22:09:17.0016144Z                  continue
2026-02-20T22:09:17.0016491Z              if k == "points_reward":
2026-02-20T22:09:17.0016992Z                  a.points_reward = int(v) if v is not None else 0
2026-02-20T22:09:17.0017510Z @@ -890,11 +1054,18 @@
2026-02-20T22:09:17.0017861Z                  a.requirements = v
2026-02-20T22:09:17.0018327Z              elif k in str_fields and v is not None:
2026-02-20T22:09:17.0018873Z                  setattr(a, k, (v or "").strip() or None)
2026-02-20T22:09:17.0019343Z  
2026-02-20T22:09:17.0019725Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0020651Z -        _log_admin_action(db, admin_id, "badge_update", "achievement", badge_id, {"fields": list(data.keys())})
2026-02-20T22:09:17.0021506Z +        _log_admin_action(
2026-02-20T22:09:17.0021867Z +            db,
2026-02-20T22:09:17.0022179Z +            admin_id,
2026-02-20T22:09:17.0022520Z +            "badge_update",
2026-02-20T22:09:17.0022898Z +            "achievement",
2026-02-20T22:09:17.0023595Z +            badge_id,
2026-02-20T22:09:17.0023965Z +            {"fields": list(data.keys())},
2026-02-20T22:09:17.0024392Z +        )
2026-02-20T22:09:17.0024696Z          db.commit()
2026-02-20T22:09:17.0025025Z          db.refresh(a)
2026-02-20T22:09:17.0025445Z      return JSONResponse(_achievement_to_detail(a))
2026-02-20T22:09:17.0025925Z  
2026-02-20T22:09:17.0026188Z  
2026-02-20T22:09:17.0026460Z @@ -909,29 +1080,47 @@
2026-02-20T22:09:17.0026807Z      async with db_session() as db:
2026-02-20T22:09:17.0027404Z          a = db.query(Achievement).filter(Achievement.id == badge_id).first()
2026-02-20T22:09:17.0028007Z          if not a:
2026-02-20T22:09:17.0028710Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:17.0029342Z  
2026-02-20T22:09:17.0030147Z -        user_count = db.query(func.count(UserAchievement.id)).filter(UserAchievement.achievement_id == badge_id).scalar() or 0
2026-02-20T22:09:17.0031125Z +        user_count = (
2026-02-20T22:09:17.0031554Z +            db.query(func.count(UserAchievement.id))
2026-02-20T22:09:17.0032172Z +            .filter(UserAchievement.achievement_id == badge_id)
2026-02-20T22:09:17.0032700Z +            .scalar()
2026-02-20T22:09:17.0033334Z +            or 0
2026-02-20T22:09:17.0033648Z +        )
2026-02-20T22:09:17.0033953Z          a.is_active = False
2026-02-20T22:09:17.0034438Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0035409Z -        _log_admin_action(db, admin_id, "badge_delete", "achievement", badge_id, {"soft": True, "user_count": user_count})
2026-02-20T22:09:17.0036313Z +        _log_admin_action(
2026-02-20T22:09:17.0036676Z +            db,
2026-02-20T22:09:17.0036989Z +            admin_id,
2026-02-20T22:09:17.0037329Z +            "badge_delete",
2026-02-20T22:09:17.0037711Z +            "achievement",
2026-02-20T22:09:17.0038062Z +            badge_id,
2026-02-20T22:09:17.0038450Z +            {"soft": True, "user_count": user_count},
2026-02-20T22:09:17.0039168Z +        )
2026-02-20T22:09:17.0039487Z          db.commit()
2026-02-20T22:09:17.0039837Z          db.refresh(a)
2026-02-20T22:09:17.0040186Z -    return JSONResponse({
2026-02-20T22:09:17.0040567Z -        "success": True,
2026-02-20T22:09:17.0040915Z -        "id": a.id,
2026-02-20T22:09:17.0041237Z -        "code": a.code,
2026-02-20T22:09:17.0041820Z -        "name": a.name,
2026-02-20T22:09:17.0042170Z -        "is_active": False,
2026-02-20T22:09:17.0042737Z -        "message": "Badge désactivé (soft delete).",
2026-02-20T22:09:17.0043468Z -    })
2026-02-20T22:09:17.0043768Z +    return JSONResponse(
2026-02-20T22:09:17.0044116Z +        {
2026-02-20T22:09:17.0044416Z +            "success": True,
2026-02-20T22:09:17.0044783Z +            "id": a.id,
2026-02-20T22:09:17.0045136Z +            "code": a.code,
2026-02-20T22:09:17.0045493Z +            "name": a.name,
2026-02-20T22:09:17.0045863Z +            "is_active": False,
2026-02-20T22:09:17.0046457Z +            "message": "Badge désactivé (soft delete).",
2026-02-20T22:09:17.0046962Z +        }
2026-02-20T22:09:17.0047228Z +    )
2026-02-20T22:09:17.0047494Z  
2026-02-20T22:09:17.0047748Z  
2026-02-20T22:09:17.0048053Z  def _challenge_to_detail(c) -> dict:
2026-02-20T22:09:17.0048670Z      """Sérialise un défi pour l'édition admin."""
2026-02-20T22:09:17.0049511Z -    ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0050343Z +    ct_val = (
2026-02-20T22:09:17.0050680Z +        c.challenge_type.value
2026-02-20T22:09:17.0051130Z +        if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0051604Z +        else str(c.challenge_type)
2026-02-20T22:09:17.0051995Z +    )
2026-02-20T22:09:17.0052510Z      ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0053378Z      return {
2026-02-20T22:09:17.0053705Z          "id": c.id,
2026-02-20T22:09:17.0054030Z          "title": c.title,
2026-02-20T22:09:17.0054445Z          "description": c.description or "",
2026-02-20T22:09:17.0054912Z @@ -972,11 +1161,13 @@
2026-02-20T22:09:17.0055401Z      age_group_raw = (data.get("age_group") or "GROUP_10_12").strip()
2026-02-20T22:09:17.0055960Z  
2026-02-20T22:09:17.0056240Z      if not title:
2026-02-20T22:09:17.0056795Z          return JSONResponse({"error": "Le titre est obligatoire."}, status_code=400)
2026-02-20T22:09:17.0057495Z      if not description:
2026-02-20T22:09:17.0058143Z -        return JSONResponse({"error": "La description est obligatoire."}, status_code=400)
2026-02-20T22:09:17.0058880Z +        return JSONResponse(
2026-02-20T22:09:17.0059438Z +            {"error": "La description est obligatoire."}, status_code=400
2026-02-20T22:09:17.0060014Z +        )
2026-02-20T22:09:17.0060329Z  
2026-02-20T22:09:17.0060594Z      try:
2026-02-20T22:09:17.0060961Z          ct = LogicChallengeType(challenge_type_raw)
2026-02-20T22:09:17.0061457Z      except ValueError:
2026-02-20T22:09:17.0061842Z          ct = LogicChallengeType.PUZZLE
2026-02-20T22:09:17.0062284Z @@ -993,18 +1184,21 @@
2026-02-20T22:09:17.0062623Z              age_group=ag,
2026-02-20T22:09:17.0063312Z              question=(data.get("question") or "").strip() or None,
2026-02-20T22:09:17.0063976Z              content=(data.get("content") or "").strip() or None,
2026-02-20T22:09:17.0064639Z              solution=(data.get("solution") or "").strip() or None,
2026-02-20T22:09:17.0065371Z              correct_answer=(data.get("correct_answer") or "").strip() or None,
2026-02-20T22:09:17.0066247Z -            solution_explanation=(data.get("solution_explanation") or "").strip() or None,
2026-02-20T22:09:17.0067167Z +            solution_explanation=(data.get("solution_explanation") or "").strip()
2026-02-20T22:09:17.0067805Z +            or None,
2026-02-20T22:09:17.0068183Z              visual_data=data.get("visual_data"),
2026-02-20T22:09:17.0068662Z              hints=data.get("hints"),
2026-02-20T22:09:17.0069072Z          )
2026-02-20T22:09:17.0069343Z          db.add(ch)
2026-02-20T22:09:17.0069901Z          db.flush()
2026-02-20T22:09:17.0070308Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0071131Z -        _log_admin_action(db, admin_id, "challenge_create", "challenge", ch.id, {"title": ch.title})
2026-02-20T22:09:17.0071905Z +        _log_admin_action(
2026-02-20T22:09:17.0072726Z +            db, admin_id, "challenge_create", "challenge", ch.id, {"title": ch.title}
2026-02-20T22:09:17.0073644Z +        )
2026-02-20T22:09:17.0073963Z          db.commit()
2026-02-20T22:09:17.0074314Z          db.refresh(ch)
2026-02-20T22:09:17.0074805Z      return JSONResponse(_challenge_to_detail(ch), status_code=201)
2026-02-20T22:09:17.0075361Z  
2026-02-20T22:09:17.0075606Z  
2026-02-20T22:09:17.0075875Z @@ -1029,13 +1223,20 @@
2026-02-20T22:09:17.0076241Z          data = await request.json()
2026-02-20T22:09:17.0076701Z      except Exception:
2026-02-20T22:09:17.0077264Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:17.0077926Z  
2026-02-20T22:09:17.0078190Z      allowed_str = {
2026-02-20T22:09:17.0078656Z -        "title", "description", "difficulty", "content", "question",
2026-02-20T22:09:17.0079359Z -        "solution", "correct_answer", "solution_explanation",
2026-02-20T22:09:17.0079908Z -        "image_url", "tags",
2026-02-20T22:09:17.0080290Z +        "title",
2026-02-20T22:09:17.0080601Z +        "description",
2026-02-20T22:09:17.0080952Z +        "difficulty",
2026-02-20T22:09:17.0081280Z +        "content",
2026-02-20T22:09:17.0081590Z +        "question",
2026-02-20T22:09:17.0081922Z +        "solution",
2026-02-20T22:09:17.0082254Z +        "correct_answer",
2026-02-20T22:09:17.0082657Z +        "solution_explanation",
2026-02-20T22:09:17.0083296Z +        "image_url",
2026-02-20T22:09:17.0083627Z +        "tags",
2026-02-20T22:09:17.0083910Z      }
2026-02-20T22:09:17.0084252Z      allowed_bool = {"is_active", "is_archived"}
2026-02-20T22:09:17.0084867Z      allowed_int = {"difficulty_rating", "estimated_time_minutes"}
2026-02-20T22:09:17.0085621Z      allowed_json = {"choices", "visual_data", "hints"}
2026-02-20T22:09:17.0086116Z  
2026-02-20T22:09:17.0086393Z @@ -1067,11 +1268,18 @@
2026-02-20T22:09:17.0086729Z          if not ch:
2026-02-20T22:09:17.0087455Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0088165Z          for k, v in update_data.items():
2026-02-20T22:09:17.0088615Z              setattr(ch, k, v)
2026-02-20T22:09:17.0089124Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0090141Z -        _log_admin_action(db, admin_id, "challenge_update", "challenge", challenge_id, {"fields": list(update_data.keys())})
2026-02-20T22:09:17.0091088Z +        _log_admin_action(
2026-02-20T22:09:17.0091463Z +            db,
2026-02-20T22:09:17.0091768Z +            admin_id,
2026-02-20T22:09:17.0092120Z +            "challenge_update",
2026-02-20T22:09:17.0092506Z +            "challenge",
2026-02-20T22:09:17.0092882Z +            challenge_id,
2026-02-20T22:09:17.0093471Z +            {"fields": list(update_data.keys())},
2026-02-20T22:09:17.0093922Z +        )
2026-02-20T22:09:17.0094200Z          db.commit()
2026-02-20T22:09:17.0094516Z          db.refresh(ch)
2026-02-20T22:09:17.0094922Z      return JSONResponse(_challenge_to_detail(ch))
2026-02-20T22:09:17.0095403Z  
2026-02-20T22:09:17.0095648Z  
2026-02-20T22:09:17.0095908Z @@ -1079,11 +1287,13 @@
2026-02-20T22:09:17.0096243Z  @require_admin
2026-02-20T22:09:17.0096665Z  async def admin_challenges_duplicate(request: Request):
2026-02-20T22:09:17.0097618Z      """POST /api/admin/challenges/{challenge_id}/duplicate — crée une copie."""
2026-02-20T22:09:17.0098439Z      challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:17.0099051Z      async with db_session() as db:
2026-02-20T22:09:17.0099747Z -        orig = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0100759Z +        orig = (
2026-02-20T22:09:17.0101334Z +            db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0102016Z +        )
2026-02-20T22:09:17.0102311Z          if not orig:
2026-02-20T22:09:17.0103271Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0104215Z          copy = LogicChallenge(
2026-02-20T22:09:17.0104644Z              title=f"{orig.title} (copie)",
2026-02-20T22:09:17.0105123Z              description=orig.description,
2026-02-20T22:09:17.0105573Z @@ -1106,11 +1316,18 @@
2026-02-20T22:09:17.0106027Z              estimated_time_minutes=orig.estimated_time_minutes,
2026-02-20T22:09:17.0106563Z          )
2026-02-20T22:09:17.0106854Z          db.add(copy)
2026-02-20T22:09:17.0107176Z          db.flush()
2026-02-20T22:09:17.0107604Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0108667Z -        _log_admin_action(db, admin_id, "challenge_duplicate", "challenge", copy.id, {"from_id": challenge_id, "title": copy.title})
2026-02-20T22:09:17.0109661Z +        _log_admin_action(
2026-02-20T22:09:17.0110025Z +            db,
2026-02-20T22:09:17.0110331Z +            admin_id,
2026-02-20T22:09:17.0110682Z +            "challenge_duplicate",
2026-02-20T22:09:17.0111091Z +            "challenge",
2026-02-20T22:09:17.0111439Z +            copy.id,
2026-02-20T22:09:17.0111854Z +            {"from_id": challenge_id, "title": copy.title},
2026-02-20T22:09:17.0112333Z +        )
2026-02-20T22:09:17.0112619Z          db.commit()
2026-02-20T22:09:17.0112944Z          db.refresh(copy)
2026-02-20T22:09:17.0113578Z      return JSONResponse(_challenge_to_detail(copy))
2026-02-20T22:09:17.0114059Z  
2026-02-20T22:09:17.0114323Z  
2026-02-20T22:09:17.0114596Z @@ -1150,51 +1367,66 @@
2026-02-20T22:09:17.0115058Z                  q = q.filter(LogicChallenge.challenge_type == ct)
2026-02-20T22:09:17.0115590Z              except ValueError:
2026-02-20T22:09:17.0115899Z                  pass
2026-02-20T22:09:17.0116169Z          if search:
2026-02-20T22:09:17.0116440Z              pattern = f"%{search}%"
2026-02-20T22:09:17.0116794Z -            q = q.filter(or_(
2026-02-20T22:09:17.0117142Z -                LogicChallenge.title.ilike(pattern),
2026-02-20T22:09:17.0117626Z -                LogicChallenge.description.ilike(pattern),
2026-02-20T22:09:17.0118063Z -            ))
2026-02-20T22:09:17.0118305Z +            q = q.filter(
2026-02-20T22:09:17.0118583Z +                or_(
2026-02-20T22:09:17.0118896Z +                    LogicChallenge.title.ilike(pattern),
2026-02-20T22:09:17.0119395Z +                    LogicChallenge.description.ilike(pattern),
2026-02-20T22:09:17.0119811Z +                )
2026-02-20T22:09:17.0120058Z +            )
2026-02-20T22:09:17.0120313Z          total = q.count()
2026-02-20T22:09:17.0120768Z          challenges = q.order_by(order_by).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0121347Z          ch_ids = [c.id for c in challenges]
2026-02-20T22:09:17.0121718Z  
2026-02-20T22:09:17.0121960Z          attempt_stats = {}
2026-02-20T22:09:17.0122270Z          if ch_ids:
2026-02-20T22:09:17.0122531Z              rows = (
2026-02-20T22:09:17.0122804Z                  db.query(
2026-02-20T22:09:17.0123389Z                      LogicChallengeAttempt.challenge_id,
2026-02-20T22:09:17.0123987Z                      func.count(LogicChallengeAttempt.id).label("attempt_count"),
2026-02-20T22:09:17.0124780Z -                    func.sum(case((LogicChallengeAttempt.is_correct == True, 1), else_=0)).label("correct_count"),
2026-02-20T22:09:17.0125488Z +                    func.sum(
2026-02-20T22:09:17.0125981Z +                        case((LogicChallengeAttempt.is_correct == True, 1), else_=0)
2026-02-20T22:09:17.0126603Z +                    ).label("correct_count"),
2026-02-20T22:09:17.0127016Z                  )
2026-02-20T22:09:17.0127492Z                  .filter(LogicChallengeAttempt.challenge_id.in_(ch_ids))
2026-02-20T22:09:17.0128177Z                  .group_by(LogicChallengeAttempt.challenge_id)
2026-02-20T22:09:17.0128981Z                  .all()
2026-02-20T22:09:17.0129307Z              )
2026-02-20T22:09:17.0129654Z              for ch_id, a_count, c_count in rows:
2026-02-20T22:09:17.0130402Z -                attempt_stats[ch_id] = {"attempt_count": a_count or 0, "correct_count": c_count or 0}
2026-02-20T22:09:17.0131398Z +                attempt_stats[ch_id] = {
2026-02-20T22:09:17.0131874Z +                    "attempt_count": a_count or 0,
2026-02-20T22:09:17.0132353Z +                    "correct_count": c_count or 0,
2026-02-20T22:09:17.0132799Z +                }
2026-02-20T22:09:17.0133278Z  
2026-02-20T22:09:17.0133536Z          items = []
2026-02-20T22:09:17.0133859Z          for c in challenges:
2026-02-20T22:09:17.0134450Z              stats = attempt_stats.get(c.id, {"attempt_count": 0, "correct_count": 0})
2026-02-20T22:09:17.0135143Z              a_count = stats["attempt_count"]
2026-02-20T22:09:17.0135621Z              c_count = stats["correct_count"]
2026-02-20T22:09:17.0136286Z              success_rate = round((c_count / a_count * 100), 1) if a_count > 0 else 0.0
2026-02-20T22:09:17.0137306Z -            ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0138370Z -            ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0139083Z -            items.append({
2026-02-20T22:09:17.0139462Z -                "id": c.id,
2026-02-20T22:09:17.0139837Z -                "title": c.title,
2026-02-20T22:09:17.0140245Z -                "challenge_type": ct_val,
2026-02-20T22:09:17.0140705Z -                "age_group": ag_val,
2026-02-20T22:09:17.0141147Z -                "is_archived": c.is_archived,
2026-02-20T22:09:17.0141616Z -                "attempt_count": a_count,
2026-02-20T22:09:17.0142075Z -                "success_rate": success_rate,
2026-02-20T22:09:17.0142696Z -                "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0143534Z -            })
2026-02-20T22:09:17.0143838Z +            ct_val = (
2026-02-20T22:09:17.0144202Z +                c.challenge_type.value
2026-02-20T22:09:17.0144677Z +                if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0145182Z +                else str(c.challenge_type)
2026-02-20T22:09:17.0145613Z +            )
2026-02-20T22:09:17.0145927Z +            ag_val = (
2026-02-20T22:09:17.0146475Z +                c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0147140Z +            )
2026-02-20T22:09:17.0147458Z +            items.append(
2026-02-20T22:09:17.0147813Z +                {
2026-02-20T22:09:17.0148135Z +                    "id": c.id,
2026-02-20T22:09:17.0148519Z +                    "title": c.title,
2026-02-20T22:09:17.0148968Z +                    "challenge_type": ct_val,
2026-02-20T22:09:17.0149426Z +                    "age_group": ag_val,
2026-02-20T22:09:17.0149886Z +                    "is_archived": c.is_archived,
2026-02-20T22:09:17.0150371Z +                    "attempt_count": a_count,
2026-02-20T22:09:17.0150851Z +                    "success_rate": success_rate,
2026-02-20T22:09:17.0151485Z +                    "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0152108Z +                }
2026-02-20T22:09:17.0152432Z +            )
2026-02-20T22:09:17.0152711Z  
2026-02-20T22:09:17.0153300Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:17.0153807Z  
2026-02-20T22:09:17.0154059Z  
2026-02-20T22:09:17.0154307Z  @require_auth
2026-02-20T22:09:17.0154596Z @@ -1206,27 +1438,38 @@
2026-02-20T22:09:17.0154942Z          data = await request.json()
2026-02-20T22:09:17.0155364Z      except Exception:
2026-02-20T22:09:17.0155901Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:17.0156573Z      is_archived = data.get("is_archived")
2026-02-20T22:09:17.0157074Z      if not isinstance(is_archived, bool):
2026-02-20T22:09:17.0158411Z -        return JSONResponse({"error": "Le champ is_archived doit être un booléen."}, status_code=400)
2026-02-20T22:09:17.0159232Z +        return JSONResponse(
2026-02-20T22:09:17.0159978Z +            {"error": "Le champ is_archived doit être un booléen."}, status_code=400
2026-02-20T22:09:17.0160869Z +        )
2026-02-20T22:09:17.0161146Z  
2026-02-20T22:09:17.0161442Z      async with db_session() as db:
2026-02-20T22:09:17.0162119Z          ch = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0162819Z          if not ch:
2026-02-20T22:09:17.0163765Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0164438Z          ch.is_archived = is_archived
2026-02-20T22:09:17.0164983Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0165944Z -        _log_admin_action(db, admin_id, "challenge_archive", "challenge", challenge_id, {"is_archived": is_archived})
2026-02-20T22:09:17.0166846Z +        _log_admin_action(
2026-02-20T22:09:17.0167218Z +            db,
2026-02-20T22:09:17.0167526Z +            admin_id,
2026-02-20T22:09:17.0167878Z +            "challenge_archive",
2026-02-20T22:09:17.0168276Z +            "challenge",
2026-02-20T22:09:17.0168643Z +            challenge_id,
2026-02-20T22:09:17.0169045Z +            {"is_archived": is_archived},
2026-02-20T22:09:17.0169465Z +        )
2026-02-20T22:09:17.0169741Z          db.commit()
2026-02-20T22:09:17.0170068Z          db.refresh(ch)
2026-02-20T22:09:17.0170391Z  
2026-02-20T22:09:17.0170687Z -    return JSONResponse({
2026-02-20T22:09:17.0171063Z -        "id": ch.id,
2026-02-20T22:09:17.0171393Z -        "title": ch.title,
2026-02-20T22:09:17.0171780Z -        "is_archived": ch.is_archived,
2026-02-20T22:09:17.0172190Z -    })
2026-02-20T22:09:17.0172494Z +    return JSONResponse(
2026-02-20T22:09:17.0172839Z +        {
2026-02-20T22:09:17.0173337Z +            "id": ch.id,
2026-02-20T22:09:17.0173783Z +            "title": ch.title,
2026-02-20T22:09:17.0174194Z +            "is_archived": ch.is_archived,
2026-02-20T22:09:17.0174573Z +        }
2026-02-20T22:09:17.0174828Z +    )
2026-02-20T22:09:17.0175067Z  
2026-02-20T22:09:17.0175303Z  
2026-02-20T22:09:17.0175551Z  @require_auth
2026-02-20T22:09:17.0175841Z  @require_admin
2026-02-20T22:09:17.0176216Z  async def admin_audit_log(request: Request):
2026-02-20T22:09:17.0176690Z @@ -1253,20 +1496,24 @@
2026-02-20T22:09:17.0177047Z          for log in logs:
2026-02-20T22:09:17.0177412Z              admin_username = None
2026-02-20T22:09:17.0177819Z              if log.admin_user_id:
2026-02-20T22:09:17.0178388Z                  u = db.query(User).filter(User.id == log.admin_user_id).first()
2026-02-20T22:09:17.0179070Z                  admin_username = u.username if u else None
2026-02-20T22:09:17.0179582Z -            items.append({
2026-02-20T22:09:17.0179947Z -                "id": log.id,
2026-02-20T22:09:17.0180370Z -                "admin_user_id": log.admin_user_id,
2026-02-20T22:09:17.0180896Z -                "admin_username": admin_username,
2026-02-20T22:09:17.0181381Z -                "action": log.action,
2026-02-20T22:09:17.0181860Z -                "resource_type": log.resource_type,
2026-02-20T22:09:17.0182373Z -                "resource_id": log.resource_id,
2026-02-20T22:09:17.0183184Z -                "details": json.loads(log.details) if log.details else None,
2026-02-20T22:09:17.0183989Z -                "created_at": log.created_at.isoformat() if log.created_at else None,
2026-02-20T22:09:17.0184633Z -            })
2026-02-20T22:09:17.0184956Z +            items.append(
2026-02-20T22:09:17.0185394Z +                {
2026-02-20T22:09:17.0185706Z +                    "id": log.id,
2026-02-20T22:09:17.0186153Z +                    "admin_user_id": log.admin_user_id,
2026-02-20T22:09:17.0186692Z +                    "admin_username": admin_username,
2026-02-20T22:09:17.0187193Z +                    "action": log.action,
2026-02-20T22:09:17.0187966Z +                    "resource_type": log.resource_type,
2026-02-20T22:09:17.0188493Z +                    "resource_id": log.resource_id,
2026-02-20T22:09:17.0189117Z +                    "details": json.loads(log.details) if log.details else None,
2026-02-20T22:09:17.0189722Z +                    "created_at": (
2026-02-20T22:09:17.0190510Z +                        log.created_at.isoformat() if log.created_at else None
2026-02-20T22:09:17.0191093Z +                    ),
2026-02-20T22:09:17.0191220Z +                }
2026-02-20T22:09:17.0191333Z +            )
2026-02-20T22:09:17.0191439Z  
2026-02-20T22:09:17.0191679Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:17.0191797Z  
2026-02-20T22:09:17.0191905Z  
2026-02-20T22:09:17.0192030Z  @require_auth
2026-02-20T22:09:17.0192161Z @@ -1281,44 +1528,75 @@
2026-02-20T22:09:17.0192364Z      skip = max(0, int(query_params.get("skip", 0)))
2026-02-20T22:09:17.0192618Z      limit = min(100, max(1, int(query_params.get("limit", 50))))
2026-02-20T22:09:17.0192739Z  
2026-02-20T22:09:17.0192887Z      from sqlalchemy import or_
2026-02-20T22:09:17.0193217Z  
2026-02-20T22:09:17.0193612Z -    result = {"exercises": [], "challenges": [], "total_exercises": 0, "total_challenges": 0}
2026-02-20T22:09:17.0193734Z +    result = {
2026-02-20T22:09:17.0193876Z +        "exercises": [],
2026-02-20T22:09:17.0194009Z +        "challenges": [],
2026-02-20T22:09:17.0194153Z +        "total_exercises": 0,
2026-02-20T22:09:17.0194291Z +        "total_challenges": 0,
2026-02-20T22:09:17.0194396Z +    }
2026-02-20T22:09:17.0194496Z  
2026-02-20T22:09:17.0194641Z      async with db_session() as db:
2026-02-20T22:09:17.0194800Z          if mod_type in ("exercises", "all"):
2026-02-20T22:09:17.0195085Z              q_ex = db.query(Exercise).filter(Exercise.ai_generated == True)
2026-02-20T22:09:17.0195286Z              result["total_exercises"] = q_ex.count()
2026-02-20T22:09:17.0195685Z -            rows_ex = q_ex.order_by(Exercise.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0195819Z +            rows_ex = (
2026-02-20T22:09:17.0196020Z +                q_ex.order_by(Exercise.created_at.desc())
2026-02-20T22:09:17.0196164Z +                .offset(skip)
2026-02-20T22:09:17.0196291Z +                .limit(limit)
2026-02-20T22:09:17.0196418Z +                .all()
2026-02-20T22:09:17.0196542Z +            )
2026-02-20T22:09:17.0196671Z              for e in rows_ex:
2026-02-20T22:09:17.0196834Z -                result["exercises"].append({
2026-02-20T22:09:17.0196968Z -                    "id": e.id,
2026-02-20T22:09:17.0197109Z -                    "title": e.title,
2026-02-20T22:09:17.0197308Z -                    "exercise_type": e.exercise_type or "",
2026-02-20T22:09:17.0197482Z -                    "age_group": e.age_group or "",
2026-02-20T22:09:17.0197656Z -                    "is_archived": e.is_archived,
2026-02-20T22:09:17.0197970Z -                    "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:17.0198094Z -                })
2026-02-20T22:09:17.0198265Z +                result["exercises"].append(
2026-02-20T22:09:17.0198381Z +                    {
2026-02-20T22:09:17.0198510Z +                        "id": e.id,
2026-02-20T22:09:17.0198652Z +                        "title": e.title,
2026-02-20T22:09:17.0198873Z +                        "exercise_type": e.exercise_type or "",
2026-02-20T22:09:17.0199050Z +                        "age_group": e.age_group or "",
2026-02-20T22:09:17.0199216Z +                        "is_archived": e.is_archived,
2026-02-20T22:09:17.0199366Z +                        "created_at": (
2026-02-20T22:09:17.0199617Z +                            e.created_at.isoformat() if e.created_at else None
2026-02-20T22:09:17.0199737Z +                        ),
2026-02-20T22:09:17.0199860Z +                    }
2026-02-20T22:09:17.0199972Z +                )
2026-02-20T22:09:17.0200079Z  
2026-02-20T22:09:17.0200250Z          if mod_type in ("challenges", "all"):
2026-02-20T22:09:17.0201053Z              # Tous les défis sont générés par IA pour le moment ; generation_parameters
2026-02-20T22:09:17.0201453Z              # est renseigné pour les créations futures via le flux IA
2026-02-20T22:09:17.0201622Z              q_ch = db.query(LogicChallenge)
2026-02-20T22:09:17.0201822Z              result["total_challenges"] = q_ch.count()
2026-02-20T22:09:17.0202593Z -            rows_ch = q_ch.order_by(LogicChallenge.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0202731Z +            rows_ch = (
2026-02-20T22:09:17.0203186Z +                q_ch.order_by(LogicChallenge.created_at.desc())
2026-02-20T22:09:17.0203336Z +                .offset(skip)
2026-02-20T22:09:17.0203531Z +                .limit(limit)
2026-02-20T22:09:17.0203705Z +                .all()
2026-02-20T22:09:17.0203826Z +            )
2026-02-20T22:09:17.0203957Z              for c in rows_ch:
2026-02-20T22:09:17.0204480Z -                ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0204915Z -                ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0205091Z -                result["challenges"].append({
2026-02-20T22:09:17.0205223Z -                    "id": c.id,
2026-02-20T22:09:17.0205382Z -                    "title": c.title,
2026-02-20T22:09:17.0205546Z -                    "challenge_type": ct_val,
2026-02-20T22:09:17.0205695Z -                    "age_group": ag_val,
2026-02-20T22:09:17.0205864Z -                    "is_archived": c.is_archived,
2026-02-20T22:09:17.0206191Z -                    "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0206306Z -                })
2026-02-20T22:09:17.0206434Z +                ct_val = (
2026-02-20T22:09:17.0206593Z +                    c.challenge_type.value
2026-02-20T22:09:17.0206790Z +                    if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0206961Z +                    else str(c.challenge_type)
2026-02-20T22:09:17.0207086Z +                )
2026-02-20T22:09:17.0207208Z +                ag_val = (
2026-02-20T22:09:17.0207348Z +                    c.age_group.value
2026-02-20T22:09:17.0207526Z +                    if hasattr(c.age_group, "value")
2026-02-20T22:09:17.0207694Z +                    else str(c.age_group)
2026-02-20T22:09:17.0207809Z +                )
2026-02-20T22:09:17.0207969Z +                result["challenges"].append(
2026-02-20T22:09:17.0208095Z +                    {
2026-02-20T22:09:17.0208223Z +                        "id": c.id,
2026-02-20T22:09:17.0208363Z +                        "title": c.title,
2026-02-20T22:09:17.0208534Z +                        "challenge_type": ct_val,
2026-02-20T22:09:17.0208715Z +                        "age_group": ag_val,
2026-02-20T22:09:17.0208891Z +                        "is_archived": c.is_archived,
2026-02-20T22:09:17.0209029Z +                        "created_at": (
2026-02-20T22:09:17.0209307Z +                            c.created_at.isoformat() if c.created_at else None
2026-02-20T22:09:17.0209430Z +                        ),
2026-02-20T22:09:17.0209547Z +                    }
2026-02-20T22:09:17.0209671Z +                )
2026-02-20T22:09:17.0209779Z  
2026-02-20T22:09:17.0209926Z      return JSONResponse(result)
2026-02-20T22:09:17.0210045Z  
2026-02-20T22:09:17.0210161Z  
2026-02-20T22:09:17.0210285Z  @require_auth
2026-02-20T22:09:17.0210411Z @@ -1340,17 +1618,21 @@
2026-02-20T22:09:17.0210575Z      days = 7 if period == "7d" else 30
2026-02-20T22:09:17.0210840Z      since = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:17.0210951Z  
2026-02-20T22:09:17.0211105Z      async with db_session() as db:
2026-02-20T22:09:17.0211532Z          # Inscriptions (nouveaux utilisateurs dans la période)
2026-02-20T22:09:17.0211975Z -        new_users = db.query(func.count(User.id)).filter(User.created_at >= since).scalar() or 0
2026-02-20T22:09:17.0212352Z +        new_users = (
2026-02-20T22:09:17.0212727Z +            db.query(func.count(User.id)).filter(User.created_at >= since).scalar() or 0
2026-02-20T22:09:17.0212846Z +        )
2026-02-20T22:09:17.0212951Z  
2026-02-20T22:09:17.0213504Z          # Tentatives exercices dans la période
2026-02-20T22:09:17.0213661Z          attempts_exercises = (
2026-02-20T22:09:17.0214016Z              db.query(
2026-02-20T22:09:17.0214214Z                  func.count(Attempt.id).label("total"),
2026-02-20T22:09:17.0214580Z -                func.sum(case((Attempt.is_correct == True, 1), else_=0)).label("correct"),
2026-02-20T22:09:17.0214889Z +                func.sum(case((Attempt.is_correct == True, 1), else_=0)).label(
2026-02-20T22:09:17.0215028Z +                    "correct"
2026-02-20T22:09:17.0215156Z +                ),
2026-02-20T22:09:17.0215269Z              )
2026-02-20T22:09:17.0215450Z              .filter(Attempt.created_at >= since)
2026-02-20T22:09:17.0215577Z              .first()
2026-02-20T22:09:17.0215711Z          )
2026-02-20T22:09:17.0215914Z          total_attempts = attempts_exercises[0] or 0
2026-02-20T22:09:17.0216042Z @@ -1373,29 +1655,40 @@
2026-02-20T22:09:17.0216167Z              or 0
2026-02-20T22:09:17.0216276Z          )
2026-02-20T22:09:17.0216382Z  
2026-02-20T22:09:17.0216953Z          # Utilisateurs actifs (au moins 1 tentative exercice ou défi dans la période)
2026-02-20T22:09:17.0217141Z          from sqlalchemy import union
2026-02-20T22:09:17.0217248Z +
2026-02-20T22:09:17.0217603Z          q1 = db.query(Attempt.user_id).filter(Attempt.created_at >= since).distinct()
2026-02-20T22:09:17.0218190Z -        q2 = db.query(LogicChallengeAttempt.user_id).filter(LogicChallengeAttempt.created_at >= since).distinct()
2026-02-20T22:09:17.0218304Z +        q2 = (
2026-02-20T22:09:17.0218503Z +            db.query(LogicChallengeAttempt.user_id)
2026-02-20T22:09:17.0218757Z +            .filter(LogicChallengeAttempt.created_at >= since)
2026-02-20T22:09:17.0218883Z +            .distinct()
2026-02-20T22:09:17.0219003Z +        )
2026-02-20T22:09:17.0219150Z          u = union(q1, q2).subquery()
2026-02-20T22:09:17.0219488Z          active_users_count = db.query(func.count()).select_from(u).scalar() or 0
2026-02-20T22:09:17.0219598Z  
2026-02-20T22:09:17.0219890Z          total_attempts_all = total_attempts + challenge_attempts_count
2026-02-20T22:09:17.0220167Z          total_correct_all = correct_attempts + challenge_correct
2026-02-20T22:09:17.0220696Z -        success_rate = round((total_correct_all / total_attempts_all * 100), 1) if total_attempts_all > 0 else 0.0
2026-02-20T22:09:17.0220806Z -
2026-02-20T22:09:17.0220958Z -    return JSONResponse({
2026-02-20T22:09:17.0221095Z -        "period": period,
2026-02-20T22:09:17.0221217Z -        "days": days,
2026-02-20T22:09:17.0221355Z -        "new_users": new_users,
2026-02-20T22:09:17.0221535Z -        "attempts_exercises": total_attempts,
2026-02-20T22:09:17.0221756Z -        "attempts_challenges": challenge_attempts_count,
2026-02-20T22:09:17.0221933Z -        "total_attempts": total_attempts_all,
2026-02-20T22:09:17.0222096Z -        "success_rate": success_rate,
2026-02-20T22:09:17.0222252Z -        "active_users": active_users_count,
2026-02-20T22:09:17.0222366Z -    })
2026-02-20T22:09:17.0222505Z +        success_rate = (
2026-02-20T22:09:17.0222756Z +            round((total_correct_all / total_attempts_all * 100), 1)
2026-02-20T22:09:17.0222911Z +            if total_attempts_all > 0
2026-02-20T22:09:17.0223260Z +            else 0.0
2026-02-20T22:09:17.0223382Z +        )
2026-02-20T22:09:17.0223483Z +
2026-02-20T22:09:17.0223619Z +    return JSONResponse(
2026-02-20T22:09:17.0223739Z +        {
2026-02-20T22:09:17.0223878Z +            "period": period,
2026-02-20T22:09:17.0224006Z +            "days": days,
2026-02-20T22:09:17.0224144Z +            "new_users": new_users,
2026-02-20T22:09:17.0224334Z +            "attempts_exercises": total_attempts,
2026-02-20T22:09:17.0224569Z +            "attempts_challenges": challenge_attempts_count,
2026-02-20T22:09:17.0225062Z +            "total_attempts": total_attempts_all,
2026-02-20T22:09:17.0225238Z +            "success_rate": success_rate,
2026-02-20T22:09:17.0225425Z +            "active_users": active_users_count,
2026-02-20T22:09:17.0225539Z +        }
2026-02-20T22:09:17.0225650Z +    )
2026-02-20T22:09:17.0225761Z  
2026-02-20T22:09:17.0226067Z  
2026-02-20T22:09:17.0226202Z  @require_auth
2026-02-20T22:09:17.0226336Z  @require_admin
2026-02-20T22:09:17.0226496Z  async def admin_export(request: Request):
2026-02-20T22:09:17.0226613Z @@ -1413,11 +1706,18 @@
2026-02-20T22:09:17.0226737Z              status_code=400,
2026-02-20T22:09:17.0226846Z          )
2026-02-20T22:09:17.0226942Z  
2026-02-20T22:09:17.0227180Z      admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0227335Z      async with db_session() as _db:
2026-02-20T22:09:17.0227802Z -        _log_admin_action(_db, admin_id, "export_csv", None, None, {"type": export_type, "period": period})
2026-02-20T22:09:17.0227951Z +        _log_admin_action(
2026-02-20T22:09:17.0228074Z +            _db,
2026-02-20T22:09:17.0228192Z +            admin_id,
2026-02-20T22:09:17.0228321Z +            "export_csv",
2026-02-20T22:09:17.0228436Z +            None,
2026-02-20T22:09:17.0228556Z +            None,
2026-02-20T22:09:17.0228746Z +            {"type": export_type, "period": period},
2026-02-20T22:09:17.0228867Z +        )
2026-02-20T22:09:17.0228996Z          _db.commit()
2026-02-20T22:09:17.0229102Z  
2026-02-20T22:09:17.0229219Z      since = None
2026-02-20T22:09:17.0229348Z      if period == "7d":
2026-02-20T22:09:17.0229614Z          since = datetime.now(timezone.utc) - timedelta(days=7)
2026-02-20T22:09:17.0229740Z @@ -1432,34 +1732,80 @@
2026-02-20T22:09:17.0229878Z              q = db.query(User)
2026-02-20T22:09:17.0230013Z              if since:
2026-02-20T22:09:17.0230207Z                  q = q.filter(User.created_at >= since)
2026-02-20T22:09:17.0230499Z              rows = q.order_by(User.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0230641Z              rows_data = [
2026-02-20T22:09:17.0231388Z -                [u.id, u.username or "", u.email or "", u.full_name or "", u.role.value if u.role else "", u.is_active, u.created_at.isoformat() if u.created_at else ""]
2026-02-20T22:09:17.0231511Z +                [
2026-02-20T22:09:17.0231642Z +                    u.id,
2026-02-20T22:09:17.0231791Z +                    u.username or "",
2026-02-20T22:09:17.0231923Z +                    u.email or "",
2026-02-20T22:09:17.0232062Z +                    u.full_name or "",
2026-02-20T22:09:17.0232245Z +                    u.role.value if u.role else "",
2026-02-20T22:09:17.0232373Z +                    u.is_active,
2026-02-20T22:09:17.0232605Z +                    u.created_at.isoformat() if u.created_at else "",
2026-02-20T22:09:17.0232709Z +                ]
2026-02-20T22:09:17.0232835Z                  for u in rows
2026-02-20T22:09:17.0232942Z              ]
2026-02-20T22:09:17.0233557Z -            headers = ["id", "username", "email", "full_name", "role", "is_active", "created_at"]
2026-02-20T22:09:17.0233709Z +            headers = [
2026-02-20T22:09:17.0233826Z +                "id",
2026-02-20T22:09:17.0233954Z +                "username",
2026-02-20T22:09:17.0234086Z +                "email",
2026-02-20T22:09:17.0234226Z +                "full_name",
2026-02-20T22:09:17.0234355Z +                "role",
2026-02-20T22:09:17.0234478Z +                "is_active",
2026-02-20T22:09:17.0234615Z +                "created_at",
2026-02-20T22:09:17.0234723Z +            ]
2026-02-20T22:09:17.0234884Z          elif export_type == "exercises":
2026-02-20T22:09:17.0235039Z              q = db.query(Exercise)
2026-02-20T22:09:17.0235170Z              if since:
2026-02-20T22:09:17.0235370Z                  q = q.filter(Exercise.created_at >= since)
2026-02-20T22:09:17.0235684Z              rows = q.order_by(Exercise.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0235835Z              rows_data = [
2026-02-20T22:09:17.0236911Z -                [e.id, (e.title or "").replace("\n", " "), e.exercise_type or "", e.difficulty or "", e.age_group or "", e.is_archived, e.created_at.isoformat() if e.created_at else ""]
2026-02-20T22:09:17.0237049Z +                [
2026-02-20T22:09:17.0237184Z +                    e.id,
2026-02-20T22:09:17.0237618Z +                    (e.title or "").replace("\n", " "),
2026-02-20T22:09:17.0237775Z +                    e.exercise_type or "",
2026-02-20T22:09:17.0237932Z +                    e.difficulty or "",
2026-02-20T22:09:17.0238073Z +                    e.age_group or "",
2026-02-20T22:09:17.0238207Z +                    e.is_archived,
2026-02-20T22:09:17.0238444Z +                    e.created_at.isoformat() if e.created_at else "",
2026-02-20T22:09:17.0238567Z +                ]
2026-02-20T22:09:17.0238702Z                  for e in rows
2026-02-20T22:09:17.0238814Z              ]
2026-02-20T22:09:17.0239288Z -            headers = ["id", "title", "exercise_type", "difficulty", "age_group", "is_archived", "created_at"]
2026-02-20T22:09:17.0239431Z +            headers = [
2026-02-20T22:09:17.0239560Z +                "id",
2026-02-20T22:09:17.0239688Z +                "title",
2026-02-20T22:09:17.0239818Z +                "exercise_type",
2026-02-20T22:09:17.0239946Z +                "difficulty",
2026-02-20T22:09:17.0240084Z +                "age_group",
2026-02-20T22:09:17.0240221Z +                "is_archived",
2026-02-20T22:09:17.0240348Z +                "created_at",
2026-02-20T22:09:17.0240457Z +            ]
2026-02-20T22:09:17.0240632Z          elif export_type == "attempts":
2026-02-20T22:09:17.0240782Z              q = db.query(Attempt)
2026-02-20T22:09:17.0240905Z              if since:
2026-02-20T22:09:17.0241099Z                  q = q.filter(Attempt.created_at >= since)
2026-02-20T22:09:17.0241402Z              rows = q.order_by(Attempt.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0241561Z              rows_data = [
2026-02-20T22:09:17.0242149Z -                [a.id, a.user_id, a.exercise_id, a.is_correct, a.time_spent or "", a.created_at.isoformat() if a.created_at else ""]
2026-02-20T22:09:17.0242302Z +                [
2026-02-20T22:09:17.0242425Z +                    a.id,
2026-02-20T22:09:17.0242554Z +                    a.user_id,
2026-02-20T22:09:17.0242697Z +                    a.exercise_id,
2026-02-20T22:09:17.0242841Z +                    a.is_correct,
2026-02-20T22:09:17.0243181Z +                    a.time_spent or "",
2026-02-20T22:09:17.0243444Z +                    a.created_at.isoformat() if a.created_at else "",
2026-02-20T22:09:17.0243567Z +                ]
2026-02-20T22:09:17.0243691Z                  for a in rows
2026-02-20T22:09:17.0243801Z              ]
2026-02-20T22:09:17.0244185Z -            headers = ["id", "user_id", "exercise_id", "is_correct", "time_spent", "created_at"]
2026-02-20T22:09:17.0244314Z +            headers = [
2026-02-20T22:09:17.0244435Z +                "id",
2026-02-20T22:09:17.0244571Z +                "user_id",
2026-02-20T22:09:17.0244708Z +                "exercise_id",
2026-02-20T22:09:17.0244832Z +                "is_correct",
2026-02-20T22:09:17.0244963Z +                "time_spent",
2026-02-20T22:09:17.0245096Z +                "created_at",
2026-02-20T22:09:17.0245209Z +            ]
2026-02-20T22:09:17.0245342Z          else:  # overview
2026-02-20T22:09:17.0245624Z              total_users = db.query(func.count(User.id)).scalar() or 0
2026-02-20T22:09:17.0245941Z              total_exercises = db.query(func.count(Exercise.id)).scalar() or 0
2026-02-20T22:09:17.0246292Z              total_challenges = db.query(func.count(LogicChallenge.id)).scalar() or 0
2026-02-20T22:09:17.0246617Z              total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:17.1643906Z --- /home/runner/work/mathakine/mathakine/server/middleware.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.1649237Z +++ /home/runner/work/mathakine/mathakine/server/middleware.py	2026-02-20 22:09:17.161827+00:00
2026-02-20T22:09:17.1660025Z would reformat /home/runner/work/mathakine/mathakine/server/middleware.py
2026-02-20T22:09:17.1665519Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.1668999Z  Middleware for Mathakine.
2026-02-20T22:09:17.1671610Z  
2026-02-20T22:09:17.1674512Z  This module centralizes Starlette middleware logic for consistent
2026-02-20T22:09:17.1677755Z  request processing across the application.
2026-02-20T22:09:17.1680507Z  """
2026-02-20T22:09:17.1683166Z +
2026-02-20T22:09:17.1686684Z  import os
2026-02-20T22:09:17.1690981Z  from typing import Callable, List
2026-02-20T22:09:17.1696069Z  
2026-02-20T22:09:17.1698708Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.1701599Z  from app.utils.settings_reader import get_setting_bool
2026-02-20T22:09:17.1704216Z @@ -36,95 +37,100 @@
2026-02-20T22:09:17.1706767Z          if any(request.url.path.startswith(p) for p in MAINTENANCE_EXEMPT_PREFIXES):
2026-02-20T22:09:17.1713612Z              return await call_next(request)
2026-02-20T22:09:17.1714106Z          try:
2026-02-20T22:09:17.1714542Z              if await get_setting_bool("maintenance_mode", False):
2026-02-20T22:09:17.1715118Z                  return JSONResponse(
2026-02-20T22:09:17.1744845Z -                    {"error": "maintenance", "message": "Le temple est en maintenance. Réessayez plus tard."},
2026-02-20T22:09:17.1747782Z +                    {
2026-02-20T22:09:17.1750181Z +                        "error": "maintenance",
2026-02-20T22:09:17.1753289Z +                        "message": "Le temple est en maintenance. Réessayez plus tard.",
2026-02-20T22:09:17.1756005Z +                    },
2026-02-20T22:09:17.1758386Z                      status_code=503,
2026-02-20T22:09:17.1760803Z                  )
2026-02-20T22:09:17.1763292Z          except Exception as e:
2026-02-20T22:09:17.1765877Z              logger.debug(f"Maintenance check failed (default: off): {e}")
2026-02-20T22:09:17.1768535Z          return await call_next(request)
2026-02-20T22:09:17.1770988Z  
2026-02-20T22:09:17.1773444Z  
2026-02-20T22:09:17.1775370Z  class AuthenticationMiddleware(BaseHTTPMiddleware):
2026-02-20T22:09:17.1804208Z      """
2026-02-20T22:09:17.1804913Z      Middleware for authenticating users.
2026-02-20T22:09:17.1805507Z -    
2026-02-20T22:09:17.1805905Z +
2026-02-20T22:09:17.1806496Z      This middleware checks for authentication tokens in cookies and
2026-02-20T22:09:17.1807397Z      redirects unauthenticated users for protected routes.
2026-02-20T22:09:17.1808071Z      """
2026-02-20T22:09:17.1808468Z -    
2026-02-20T22:09:17.1808857Z +
2026-02-20T22:09:17.1809427Z      async def dispatch(self, request: Request, call_next: Callable):
2026-02-20T22:09:17.1810133Z          """
2026-02-20T22:09:17.1810643Z          Process the request through the middleware.
2026-02-20T22:09:17.1811254Z -        
2026-02-20T22:09:17.1811669Z +
2026-02-20T22:09:17.1812019Z          Args:
2026-02-20T22:09:17.1812458Z              request: The Starlette request object
2026-02-20T22:09:17.1813357Z              call_next: The next middleware or route handler
2026-02-20T22:09:17.1814012Z -            
2026-02-20T22:09:17.1814439Z +
2026-02-20T22:09:17.1814825Z          Returns:
2026-02-20T22:09:17.1815929Z              Starlette Response
2026-02-20T22:09:17.1816658Z          """
2026-02-20T22:09:17.1817823Z          # List of routes that don't require authentication
2026-02-20T22:09:17.1818702Z          public_routes = [
2026-02-20T22:09:17.1819754Z              "/",
2026-02-20T22:09:17.1820407Z              "/metrics",
2026-02-20T22:09:17.1821480Z -            "/login", 
2026-02-20T22:09:17.1822248Z -            "/register", 
2026-02-20T22:09:17.1823536Z -            "/api/auth/login", 
2026-02-20T22:09:17.1824358Z +            "/login",
2026-02-20T22:09:17.1825389Z +            "/register",
2026-02-20T22:09:17.1826280Z +            "/api/auth/login",
2026-02-20T22:09:17.1827785Z              "/api/auth/logout",  # Permet la déconnexion même sans token valide
2026-02-20T22:09:17.1829410Z              "/api/auth/validate-token",  # Validation token pour sync-cookie (sans session)
2026-02-20T22:09:17.1830949Z              "/api/auth/csrf",  # Token CSRF (sans auth)
2026-02-20T22:09:17.1831821Z              "/api/auth/forgot-password",
2026-02-20T22:09:17.1833214Z              "/api/auth/verify-email",
2026-02-20T22:09:17.1834035Z              "/api/auth/resend-verification",
2026-02-20T22:09:17.1835524Z              "/api/users/",
2026-02-20T22:09:17.1836316Z              "/api/exercises",  # API exercises (publique)
2026-02-20T22:09:17.1837615Z              "/api/challenges",  # API challenges (publique)
2026-02-20T22:09:17.1839746Z              "/static",
2026-02-20T22:09:17.1840536Z -            "/exercises"  # On permet l'accès à la liste des exercices sans connexion
2026-02-20T22:09:17.1841576Z +            "/exercises",  # On permet l'accès à la liste des exercices sans connexion
2026-02-20T22:09:17.1842223Z          ]
2026-02-20T22:09:17.1842511Z -        
2026-02-20T22:09:17.1842803Z +
2026-02-20T22:09:17.1843291Z          # Check if the route is public
2026-02-20T22:09:17.1843991Z          is_public = any(request.url.path.startswith(route) for route in public_routes)
2026-02-20T22:09:17.1844676Z -        
2026-02-20T22:09:17.1844956Z +
2026-02-20T22:09:17.1845224Z          if is_public:
2026-02-20T22:09:17.1845623Z              response = await call_next(request)
2026-02-20T22:09:17.1846115Z              return response
2026-02-20T22:09:17.1846479Z -        
2026-02-20T22:09:17.1846739Z +
2026-02-20T22:09:17.1847035Z          # Check for authentication token
2026-02-20T22:09:17.1847578Z          access_token = request.cookies.get("access_token")
2026-02-20T22:09:17.1848114Z          if not access_token:
2026-02-20T22:09:17.1848692Z              logger.info(f"Unauthorized access attempt to {request.url.path}")
2026-02-20T22:09:17.1849451Z              # Return 401 JSON response (API backend, no HTML redirect)
2026-02-20T22:09:17.1850048Z              return JSONResponse(
2026-02-20T22:09:17.1850627Z                  {"error": "Unauthorized", "message": "Authentication required"},
2026-02-20T22:09:17.1851244Z -                status_code=401
2026-02-20T22:09:17.1851644Z +                status_code=401,
2026-02-20T22:09:17.1852033Z              )
2026-02-20T22:09:17.1852326Z -            
2026-02-20T22:09:17.1852594Z +
2026-02-20T22:09:17.1852862Z          try:
2026-02-20T22:09:17.1853361Z              # Verify the token
2026-02-20T22:09:17.1853827Z              from app.core.security import decode_token
2026-02-20T22:09:17.1854295Z +
2026-02-20T22:09:17.1854626Z              payload = decode_token(access_token)
2026-02-20T22:09:17.1855082Z -            
2026-02-20T22:09:17.1855373Z +
2026-02-20T22:09:17.1855720Z              # Continue with the request if token is valid
2026-02-20T22:09:17.1856271Z              response = await call_next(request)
2026-02-20T22:09:17.1856741Z              return response
2026-02-20T22:09:17.1857089Z -            
2026-02-20T22:09:17.1857369Z +
2026-02-20T22:09:17.1857674Z          except Exception as auth_error:
2026-02-20T22:09:17.1858343Z              logger.error(f"Invalid token for {request.url.path}: {str(auth_error)}")
2026-02-20T22:09:17.1859149Z              # Return 401 JSON response (API backend, no HTML redirect)
2026-02-20T22:09:17.1859738Z              return JSONResponse(
2026-02-20T22:09:17.1860316Z                  {"error": "Unauthorized", "message": "Invalid or expired token"},
2026-02-20T22:09:17.1860952Z -                status_code=401
2026-02-20T22:09:17.1861339Z +                status_code=401,
2026-02-20T22:09:17.1861697Z              )
2026-02-20T22:09:17.1861971Z  
2026-02-20T22:09:17.1862208Z +
2026-02-20T22:09:17.1862528Z  def get_middleware() -> List[Middleware]:
2026-02-20T22:09:17.1863154Z      """
2026-02-20T22:09:17.1863642Z      Get the list of middleware for use in Starlette app initialization.
2026-02-20T22:09:17.1864240Z -    
2026-02-20T22:09:17.1864512Z +
2026-02-20T22:09:17.1864772Z      Returns:
2026-02-20T22:09:17.1865383Z          List of Middleware instances
2026-02-20T22:09:17.1865806Z      """
2026-02-20T22:09:17.1866283Z      # Liste des origines autorisées pour CORS
2026-02-20T22:09:17.1867167Z      # IMPORTANT: Ne pas utiliser "*" quand credentials='include' est utilisé côté client
2026-02-20T22:09:17.1867874Z @@ -132,56 +138,64 @@
2026-02-20T22:09:17.1868251Z          "http://localhost:3000",
2026-02-20T22:09:17.1868964Z          "http://localhost:5173",
2026-02-20T22:09:17.1869409Z          "http://127.0.0.1:3000",
2026-02-20T22:09:17.1869824Z          "http://127.0.0.1:5173",
2026-02-20T22:09:17.1870208Z      ]
2026-02-20T22:09:17.1870480Z -    
2026-02-20T22:09:17.1870736Z +
2026-02-20T22:09:17.1871382Z      # Ajouter FRONTEND_URL + variantes www/non-www pour éviter OPTIONS 400
2026-02-20T22:09:17.1872127Z      frontend_url = os.getenv("FRONTEND_URL", "").strip()
2026-02-20T22:09:17.1872648Z      if frontend_url:
2026-02-20T22:09:17.1903303Z          allowed_origins.append(frontend_url)
2026-02-20T22:09:17.1904154Z          # Si https://mathakine.fun, ajouter https://www.mathakine.fun et inversement
2026-02-20T22:09:17.1904853Z          try:
2026-02-20T22:09:17.1905210Z              from urllib.parse import urlparse
2026-02-20T22:09:17.1905659Z +
2026-02-20T22:09:17.1905973Z              parsed = urlparse(frontend_url)
2026-02-20T22:09:17.1906717Z -            if parsed.netloc and "." in parsed.netloc and not parsed.netloc.startswith("www."):
2026-02-20T22:09:17.1907455Z +            if (
2026-02-20T22:09:17.1907789Z +                parsed.netloc
2026-02-20T22:09:17.1908194Z +                and "." in parsed.netloc
2026-02-20T22:09:17.1908706Z +                and not parsed.netloc.startswith("www.")
2026-02-20T22:09:17.1909183Z +            ):
2026-02-20T22:09:17.1909697Z                  allowed_origins.append(f"{parsed.scheme}://www.{parsed.netloc}")
2026-02-20T22:09:17.1910407Z              elif parsed.netloc.startswith("www."):
2026-02-20T22:09:17.1911097Z                  allowed_origins.append(f"{parsed.scheme}://{parsed.netloc[4:]}")
2026-02-20T22:09:17.1911770Z          except Exception:
2026-02-20T22:09:17.1912125Z              pass
2026-02-20T22:09:17.1912708Z          # Fallback Render frontend si déployé sur Render
2026-02-20T22:09:17.1913655Z          if "mathakine" in frontend_url.lower() and "render.com" not in frontend_url:
2026-02-20T22:09:17.1914585Z              allowed_origins.append("https://mathakine-frontend.onrender.com")
2026-02-20T22:09:17.1915254Z -    
2026-02-20T22:09:17.1915527Z +
2026-02-20T22:09:17.1915961Z      # Filtrer les chaînes vides et doublons
2026-02-20T22:09:17.1916598Z      allowed_origins = list(dict.fromkeys(o for o in allowed_origins if o))
2026-02-20T22:09:17.1917224Z  
2026-02-20T22:09:17.1917535Z      middleware_list = []
2026-02-20T22:09:17.1917856Z  
2026-02-20T22:09:17.1918569Z      # Prometheus métriques (audit HIGH #1) — en premier pour capturer toutes les requêtes
2026-02-20T22:09:17.1919295Z      try:
2026-02-20T22:09:17.1919753Z          from app.core.monitoring import PrometheusMetricsMiddleware
2026-02-20T22:09:17.1920358Z +
2026-02-20T22:09:17.1920842Z          middleware_list.append(Middleware(PrometheusMetricsMiddleware))
2026-02-20T22:09:17.1921493Z      except ImportError:
2026-02-20T22:09:17.1921852Z          pass
2026-02-20T22:09:17.1922145Z  
2026-02-20T22:09:17.1922436Z -    middleware_list.extend([
2026-02-20T22:09:17.1922851Z -        Middleware(
2026-02-20T22:09:17.1953841Z -            CORSMiddleware,
2026-02-20T22:09:17.1954310Z -            allow_origins=allowed_origins,
2026-02-20T22:09:17.1954954Z -            allow_methods=["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
2026-02-20T22:09:17.1955938Z -            # Audit 4.2: restreindre aux headers utilisés par le frontend
2026-02-20T22:09:17.1956613Z -            allow_headers=[
2026-02-20T22:09:17.1957013Z -                "Content-Type",
2026-02-20T22:09:17.1957430Z -                "Authorization",
2026-02-20T22:09:17.1957820Z -                "Accept",
2026-02-20T22:09:17.1958200Z -                "Accept-Language",
2026-02-20T22:09:17.1958996Z -                "X-CSRF-Token",  # Protection CSRF (audit 3.2)
2026-02-20T22:09:17.1959517Z -            ],
2026-02-20T22:09:17.1960022Z -            allow_credentials=True,  # Important pour les cookies HTTP-only
2026-02-20T22:09:17.1960640Z -        ),
2026-02-20T22:09:17.1976427Z -        Middleware(MaintenanceMiddleware),
2026-02-20T22:09:17.1977332Z -        Middleware(AuthenticationMiddleware)
2026-02-20T22:09:17.1977830Z -    ])
2026-02-20T22:09:17.1978137Z +    middleware_list.extend(
2026-02-20T22:09:17.1978517Z +        [
2026-02-20T22:09:17.1978807Z +            Middleware(
2026-02-20T22:09:17.1979181Z +                CORSMiddleware,
2026-02-20T22:09:17.1979691Z +                allow_origins=allowed_origins,
2026-02-20T22:09:17.1980359Z +                allow_methods=["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
2026-02-20T22:09:17.1981347Z +                # Audit 4.2: restreindre aux headers utilisés par le frontend
2026-02-20T22:09:17.1981998Z +                allow_headers=[
2026-02-20T22:09:17.1982411Z +                    "Content-Type",
2026-02-20T22:09:17.1982839Z +                    "Authorization",
2026-02-20T22:09:17.2013588Z +                    "Accept",
2026-02-20T22:09:17.2014023Z +                    "Accept-Language",
2026-02-20T22:09:17.2014559Z +                    "X-CSRF-Token",  # Protection CSRF (audit 3.2)
2026-02-20T22:09:17.2015096Z +                ],
2026-02-20T22:09:17.2015613Z +                allow_credentials=True,  # Important pour les cookies HTTP-only
2026-02-20T22:09:17.2016249Z +            ),
2026-02-20T22:09:17.2016611Z +            Middleware(MaintenanceMiddleware),
2026-02-20T22:09:17.2017155Z +            Middleware(AuthenticationMiddleware),
2026-02-20T22:09:17.2017626Z +        ]
2026-02-20T22:09:17.2017902Z +    )
2026-02-20T22:09:17.2018162Z  
2026-02-20T22:09:17.2018444Z      return middleware_list
2026-02-20T22:09:17.2603951Z --- /home/runner/work/mathakine/mathakine/server/exercise_generator.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:17.2605291Z +++ /home/runner/work/mathakine/mathakine/server/exercise_generator.py	2026-02-20 22:09:17.228467+00:00
2026-02-20T22:09:17.2606127Z @@ -1,15 +1,24 @@
2026-02-20T22:09:17.2606426Z  """
2026-02-20T22:09:17.2607130Z  Module de génération d'exercices pour enhanced_server.py
2026-02-20T22:09:17.2607691Z  """
2026-02-20T22:09:17.2607957Z +
2026-02-20T22:09:17.2608213Z  import json
2026-02-20T22:09:17.2608517Z  import os
2026-02-20T22:09:17.2608796Z  import random
2026-02-20T22:09:17.2609169Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:17.2609628Z  
2026-02-20T22:09:17.2609963Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.2611056Z -from app.core.constants import (DIFFICULTY_LIMITS, DifficultyLevels, ExerciseTypes, Messages, Tags, AgeGroups, normalize_age_group)
2026-02-20T22:09:17.2612139Z +from app.core.constants import (
2026-02-20T22:09:17.2612576Z +    DIFFICULTY_LIMITS,
2026-02-20T22:09:17.2612954Z +    DifficultyLevels,
2026-02-20T22:09:17.2613507Z +    ExerciseTypes,
2026-02-20T22:09:17.2613823Z +    Messages,
2026-02-20T22:09:17.2614115Z +    Tags,
2026-02-20T22:09:17.2614399Z +    AgeGroups,
2026-02-20T22:09:17.2614705Z +    normalize_age_group,
2026-02-20T22:09:17.2615052Z +)
2026-02-20T22:09:17.2615304Z  
2026-02-20T22:09:17.2615593Z  logger = get_logger(__name__)
2026-02-20T22:09:17.2616177Z  from app.core.messages import ExerciseMessages, StarWarsNarratives
2026-02-20T22:09:17.2617008Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:17.2617626Z  
2026-02-20T22:09:17.2617894Z @@ -33,20 +42,23 @@
2026-02-20T22:09:17.2618190Z  
2026-02-20T22:09:17.2618570Z      # Parcourir tous les types d'exercices et leurs alias
2026-02-20T22:09:17.2619239Z      for type_key, aliases in ExerciseTypes.TYPE_ALIASES.items():
2026-02-20T22:09:17.2619833Z          if exercise_type_lower in aliases:
2026-02-20T22:09:17.2620291Z              return type_key
2026-02-20T22:09:17.2621055Z -    
2026-02-20T22:09:17.2621333Z +
2026-02-20T22:09:17.2621986Z      # Si aucune correspondance trouvée, essayer de convertir en majuscule
2026-02-20T22:09:17.2622797Z      # et vérifier si c'est une valeur enum valide
2026-02-20T22:09:17.2623525Z      exercise_type_upper = exercise_type.upper()
2026-02-20T22:09:17.2624076Z      if exercise_type_upper in ExerciseTypes.ALL_TYPES:
2026-02-20T22:09:17.2624862Z          return exercise_type_upper
2026-02-20T22:09:17.2625228Z -    
2026-02-20T22:09:17.2634017Z +
2026-02-20T22:09:17.2634907Z      # Si toujours aucune correspondance, logger un avertissement et retourner ADDITION par défaut
2026-02-20T22:09:17.2636300Z -    logger.info(f"⚠️ Type d'exercice non reconnu: {exercise_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.2637116Z +    logger.info(
2026-02-20T22:09:17.2637893Z +        f"⚠️ Type d'exercice non reconnu: {exercise_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.2638611Z +    )
2026-02-20T22:09:17.2638943Z      return ExerciseTypes.ADDITION
2026-02-20T22:09:17.2639370Z +
2026-02-20T22:09:17.2639622Z  
2026-02-20T22:09:17.2639925Z  def normalize_difficulty(difficulty):
2026-02-20T22:09:17.2640509Z      """Normalise le niveau de difficulté"""
2026-02-20T22:09:17.2640980Z      if not difficulty:
2026-02-20T22:09:17.2641365Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2641829Z @@ -55,52 +67,60 @@
2026-02-20T22:09:17.2642121Z  
2026-02-20T22:09:17.2642671Z      # Parcourir tous les niveaux de difficulté et leurs alias
2026-02-20T22:09:17.2643684Z      for level_key, aliases in DifficultyLevels.LEVEL_ALIASES.items():
2026-02-20T22:09:17.2644342Z          if difficulty_lower in aliases:
2026-02-20T22:09:17.2644789Z              return level_key
2026-02-20T22:09:17.2645122Z -    
2026-02-20T22:09:17.2645406Z +
2026-02-20T22:09:17.2646050Z      # Si aucune correspondance trouvée, essayer de convertir en majuscule
2026-02-20T22:09:17.2646880Z      # et vérifier si c'est une valeur enum valide
2026-02-20T22:09:17.2647448Z      difficulty_upper = difficulty.upper()
2026-02-20T22:09:17.2648038Z      if difficulty_upper in DifficultyLevels.ALL_LEVELS:
2026-02-20T22:09:17.2648550Z          return difficulty_upper
2026-02-20T22:09:17.2648920Z -            
2026-02-20T22:09:17.2649188Z +
2026-02-20T22:09:17.2649936Z      # Si toujours aucune correspondance, logger un avertissement et retourner PADAWAN par défaut
2026-02-20T22:09:17.2651373Z -    logger.info(f"⚠️ Niveau de difficulté non reconnu: {difficulty}, utilisation de PADAWAN par défaut")
2026-02-20T22:09:17.2652232Z +    logger.info(
2026-02-20T22:09:17.2653225Z +        f"⚠️ Niveau de difficulté non reconnu: {difficulty}, utilisation de PADAWAN par défaut"
2026-02-20T22:09:17.2653986Z +    )
2026-02-20T22:09:17.2654311Z      return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2654732Z  
2026-02-20T22:09:17.2654982Z  
2026-02-20T22:09:17.2655738Z -def normalize_and_validate_exercise_params(exercise_type_raw: Optional[str], age_group_raw: Optional[str]) -> tuple:
2026-02-20T22:09:17.2656762Z +def normalize_and_validate_exercise_params(
2026-02-20T22:09:17.2657381Z +    exercise_type_raw: Optional[str], age_group_raw: Optional[str]
2026-02-20T22:09:17.2657965Z +) -> tuple:
2026-02-20T22:09:17.2658242Z      """
2026-02-20T22:09:17.2658883Z      Normalise et valide les paramètres d'exercice (type et groupe d'âge).
2026-02-20T22:09:17.2659800Z      Retourne le type, le groupe d'âge, et la difficulté dérivée.
2026-02-20T22:09:17.2660373Z      """
2026-02-20T22:09:17.2660784Z      from app.core.constants import ExerciseTypes, AgeGroups
2026-02-20T22:09:17.2661313Z  
2026-02-20T22:09:17.2661703Z      # Normaliser les paramètres
2026-02-20T22:09:17.2662241Z      exercise_type = normalize_exercise_type(exercise_type_raw)
2026-02-20T22:09:17.2662868Z      age_group = normalize_age_group(age_group_raw)
2026-02-20T22:09:17.2671185Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.2671769Z -    
2026-02-20T22:09:17.2672034Z +
2026-02-20T22:09:17.2672792Z      # Valider que le type normalisé est valide
2026-02-20T22:09:17.2673561Z      if exercise_type not in ExerciseTypes.ALL_TYPES:
2026-02-20T22:09:17.2674607Z -        logger.info(f"⚠️ Type normalisé invalide: {exercise_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.2675427Z +        logger.info(
2026-02-20T22:09:17.2676541Z +            f"⚠️ Type normalisé invalide: {exercise_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.2677262Z +        )
2026-02-20T22:09:17.2677599Z          exercise_type = ExerciseTypes.ADDITION
2026-02-20T22:09:17.2678020Z  
2026-02-20T22:09:17.2678473Z      # Valider que le groupe d'âge normalisé est valide
2026-02-20T22:09:17.2678985Z      if age_group not in AgeGroups.ALL_GROUPS:
2026-02-20T22:09:17.2680079Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group_raw}, utilisation de {AgeGroups.GROUP_6_8} par défaut")
2026-02-20T22:09:17.2680898Z +        logger.info(
2026-02-20T22:09:17.2681749Z +            f"⚠️ Groupe d'âge non reconnu: {age_group_raw}, utilisation de {AgeGroups.GROUP_6_8} par défaut"
2026-02-20T22:09:17.2682470Z +        )
2026-02-20T22:09:17.2682790Z          age_group = AgeGroups.GROUP_6_8
2026-02-20T22:09:17.2683596Z          derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.2684172Z -    
2026-02-20T22:09:17.2684426Z +
2026-02-20T22:09:17.2684818Z      return exercise_type, age_group, derived_difficulty
2026-02-20T22:09:17.2685317Z  
2026-02-20T22:09:17.2685563Z  
2026-02-20T22:09:17.2685952Z  def get_difficulty_from_age_group(age_group: str) -> str:
2026-02-20T22:09:17.2686466Z      """
2026-02-20T22:09:17.2687180Z      Détermine le niveau de difficulté (INITIE, PADAWAN, ...) à partir du groupe d'âge.
2026-02-20T22:09:17.2687853Z -    
2026-02-20T22:09:17.2688114Z +
2026-02-20T22:09:17.2688516Z      Mapping (aligné avec app/core/constants.py) :
2026-02-20T22:09:17.2689101Z      - 6-8 ans → INITIE (débutant)
2026-02-20T22:09:17.2689620Z      - 9-11 ans → PADAWAN (intermédiaire)
2026-02-20T22:09:17.2690187Z      - 12-14 ans → CHEVALIER (avancé)
2026-02-20T22:09:17.2690715Z      - 15-17 ans → MAITRE (expert)
2026-02-20T22:09:17.2691102Z @@ -120,482 +140,585 @@
2026-02-20T22:09:17.2691475Z          return DifficultyLevels.MAITRE
2026-02-20T22:09:17.2691932Z      elif age_group == AgeGroups.ADULT:
2026-02-20T22:09:17.2692407Z          return DifficultyLevels.GRAND_MAITRE
2026-02-20T22:09:17.2692866Z      else:
2026-02-20T22:09:17.2693603Z          # Valeur par défaut si le groupe d'âge n'est pas reconnu
2026-02-20T22:09:17.2694748Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut")
2026-02-20T22:09:17.2695629Z +        logger.info(
2026-02-20T22:09:17.2696491Z +            f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut"
2026-02-20T22:09:17.2697259Z +        )
2026-02-20T22:09:17.2697580Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2697999Z +
2026-02-20T22:09:17.2698273Z  
2026-02-20T22:09:17.2698645Z  # Fonctions de génération d'exercices
2026-02-20T22:09:17.2699158Z  def generate_ai_exercise(exercise_type, age_group):
2026-02-20T22:09:17.2699626Z      """
2026-02-20T22:09:17.2700222Z      Génère un exercice avec IA en utilisant des prompts et contextes Star Wars
2026-02-20T22:09:17.2700837Z      """
2026-02-20T22:09:17.2701246Z      normalized_type = normalize_exercise_type(exercise_type)
2026-02-20T22:09:17.2701906Z      normalized_age_group = normalize_age_group(age_group)
2026-02-20T22:09:17.2702746Z -    derived_difficulty = get_difficulty_from_age_group(normalized_age_group) # Derive difficulty
2026-02-20T22:09:17.2703651Z -    
2026-02-20T22:09:17.2704023Z +    derived_difficulty = get_difficulty_from_age_group(
2026-02-20T22:09:17.2704541Z +        normalized_age_group
2026-02-20T22:09:17.2704908Z +    )  # Derive difficulty
2026-02-20T22:09:17.2705240Z +
2026-02-20T22:09:17.2705818Z      # Récupérer les limites pour ce type d'exercice et cette difficulté
2026-02-20T22:09:17.2707266Z -    difficulty_config = DIFFICULTY_LIMITS.get(derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]) # Use derived_difficulty
2026-02-20T22:09:17.2708754Z -    type_limits = difficulty_config.get(normalized_type, difficulty_config.get("default", {"min": 1, "max": 10}))
2026-02-20T22:09:17.2709589Z -    
2026-02-20T22:09:17.2710135Z +    difficulty_config = DIFFICULTY_LIMITS.get(
2026-02-20T22:09:17.2710784Z +        derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]
2026-02-20T22:09:17.2711406Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2711817Z +    type_limits = difficulty_config.get(
2026-02-20T22:09:17.2712450Z +        normalized_type, difficulty_config.get("default", {"min": 1, "max": 10})
2026-02-20T22:09:17.2713255Z +    )
2026-02-20T22:09:17.2713498Z +
2026-02-20T22:09:17.2714121Z      # Structure de base commune pour tous les types d'exercices générés par IA
2026-02-20T22:09:17.2714748Z      exercise_data = {
2026-02-20T22:09:17.2715125Z          "exercise_type": normalized_type,
2026-02-20T22:09:17.2715636Z -        "age_group": normalized_age_group, # Store age_group
2026-02-20T22:09:17.2716234Z +        "age_group": normalized_age_group,  # Store age_group
2026-02-20T22:09:17.2716877Z          "difficulty": derived_difficulty,  # Store derived difficulty
2026-02-20T22:09:17.2717457Z          "ai_generated": True,
2026-02-20T22:09:17.2717936Z -        "tags": Tags.AI + "," + Tags.GENERATIVE + "," + Tags.STARWARS
2026-02-20T22:09:17.2718589Z +        "tags": Tags.AI + "," + Tags.GENERATIVE + "," + Tags.STARWARS,
2026-02-20T22:09:17.2719112Z      }
2026-02-20T22:09:17.2719359Z -    
2026-02-20T22:09:17.2719607Z +
2026-02-20T22:09:17.2720054Z      # Préfixe et suffixe pour enrichir l'explication
2026-02-20T22:09:17.2720985Z -    explanation_prefix = StarWarsNarratives.get_explanation_prefix(derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2722302Z -    explanation_suffix = StarWarsNarratives.get_explanation_suffix(derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2723387Z -    
2026-02-20T22:09:17.2723867Z +    explanation_prefix = StarWarsNarratives.get_explanation_prefix(
2026-02-20T22:09:17.2724478Z +        derived_difficulty
2026-02-20T22:09:17.2724851Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2725401Z +    explanation_suffix = StarWarsNarratives.get_explanation_suffix(
2026-02-20T22:09:17.2726037Z +        derived_difficulty
2026-02-20T22:09:17.2726407Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2726760Z +
2026-02-20T22:09:17.2727109Z      if normalized_type == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.2727988Z          # Utiliser les limites de difficulté pour déterminer les plages de nombres
2026-02-20T22:09:17.2728690Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.2729157Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.2729579Z -        
2026-02-20T22:09:17.2729848Z +
2026-02-20T22:09:17.2730153Z          num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2730661Z          num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2731103Z          result = num1 + num2
2026-02-20T22:09:17.2731456Z -        
2026-02-20T22:09:17.2731706Z +
2026-02-20T22:09:17.2732084Z          # Thème Star Wars pour l'addition
2026-02-20T22:09:17.2732728Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2733649Z -            question_template = random.choice([
2026-02-20T22:09:17.2734707Z -                f"Tu as trouvé {num1} cristaux Kyber et ton ami en a trouvé {num2}. Combien avez-vous de cristaux au total?",
2026-02-20T22:09:17.2736147Z -                f"Il y a {num1} droïdes dans le hangar et {num2} droïdes dans l'atelier. Combien y a-t-il de droïdes en tout?",
2026-02-20T22:09:17.2737420Z -                f"Tu as parcouru {num1} parsecs hier et {num2} parsecs aujourd'hui. Quelle distance as-tu parcourue en tout?"
2026-02-20T22:09:17.2738277Z -            ])
2026-02-20T22:09:17.2738822Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2739775Z +            question_template = random.choice(
2026-02-20T22:09:17.2740208Z +                [
2026-02-20T22:09:17.2741135Z +                    f"Tu as trouvé {num1} cristaux Kyber et ton ami en a trouvé {num2}. Combien avez-vous de cristaux au total?",
2026-02-20T22:09:17.2742839Z +                    f"Il y a {num1} droïdes dans le hangar et {num2} droïdes dans l'atelier. Combien y a-t-il de droïdes en tout?",
2026-02-20T22:09:17.2744340Z +                    f"Tu as parcouru {num1} parsecs hier et {num2} parsecs aujourd'hui. Quelle distance as-tu parcourue en tout?",
2026-02-20T22:09:17.2745202Z +                ]
2026-02-20T22:09:17.2745499Z +            )
2026-02-20T22:09:17.2746360Z              explanation_template = f"Pour trouver la réponse, tu dois additionner {num1} et {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2747290Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2747839Z -            question_template = random.choice([
2026-02-20T22:09:17.2749215Z -                f"Un escadron de {num1} X-wings et un escadron de {num2} Y-wings se préparent pour attaquer l'Étoile de la Mort. Combien de vaisseaux y a-t-il au total?",
2026-02-20T22:09:17.2751131Z -                f"L'Empire a envoyé {num1} stormtroopers sur Endor et {num2} stormtroopers sur Hoth. Combien de stormtroopers ont été déployés en tout?",
2026-02-20T22:09:17.2752877Z -                f"Un destroyer stellaire contient {num1} TIE fighters et {num2} navettes. Combien de vaisseaux sont à bord au total?"
2026-02-20T22:09:17.2753968Z -            ])
2026-02-20T22:09:17.2754370Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2754904Z +            question_template = random.choice(
2026-02-20T22:09:17.2755349Z +                [
2026-02-20T22:09:17.2756607Z +                    f"Un escadron de {num1} X-wings et un escadron de {num2} Y-wings se préparent pour attaquer l'Étoile de la Mort. Combien de vaisseaux y a-t-il au total?",
2026-02-20T22:09:17.2758653Z +                    f"L'Empire a envoyé {num1} stormtroopers sur Endor et {num2} stormtroopers sur Hoth. Combien de stormtroopers ont été déployés en tout?",
2026-02-20T22:09:17.2765368Z +                    f"Un destroyer stellaire contient {num1} TIE fighters et {num2} navettes. Combien de vaisseaux sont à bord au total?",
2026-02-20T22:09:17.2766345Z +                ]
2026-02-20T22:09:17.2766668Z +            )
2026-02-20T22:09:17.2767415Z              explanation_template = f"Pour calculer le total, on additionne les deux nombres: {num1} + {num2} = {result}."
2026-02-20T22:09:17.2768306Z -        
2026-02-20T22:09:17.2768588Z +
2026-02-20T22:09:17.2769115Z          # Générer des choix intelligents avec erreurs typiques
2026-02-20T22:09:17.2770097Z -        choices = generate_smart_choices("ADDITION", num1, num2, result, derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2770961Z -        
2026-02-20T22:09:17.2771301Z -        exercise_data.update({
2026-02-20T22:09:17.2772313Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Alliance Rebelle - Addition pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2773599Z -            "question": question_template,
2026-02-20T22:09:17.2774089Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2774541Z -            "choices": choices,
2026-02-20T22:09:17.2774934Z -            "num1": num1,
2026-02-20T22:09:17.2775288Z -            "num2": num2,
2026-02-20T22:09:17.2776135Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2777051Z -        })
2026-02-20T22:09:17.2777431Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2777961Z +        choices = generate_smart_choices(
2026-02-20T22:09:17.2778496Z +            "ADDITION", num1, num2, result, derived_difficulty
2026-02-20T22:09:17.2779295Z +        )  # Use derived_difficulty
2026-02-20T22:09:17.2779694Z +
2026-02-20T22:09:17.2780078Z +        exercise_data.update(
2026-02-20T22:09:17.2780449Z +            {
2026-02-20T22:09:17.2781397Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Alliance Rebelle - Addition pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2782740Z +                "question": question_template,
2026-02-20T22:09:17.2783446Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2783907Z +                "choices": choices,
2026-02-20T22:09:17.2784314Z +                "num1": num1,
2026-02-20T22:09:17.2784683Z +                "num2": num2,
2026-02-20T22:09:17.2785530Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2786452Z +            }
2026-02-20T22:09:17.2786727Z +        )
2026-02-20T22:09:17.2787060Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2787629Z      elif normalized_type == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.2788467Z          # Paramètres pour la soustraction avec des limites adaptatives
2026-02-20T22:09:17.2789068Z          min1 = type_limits.get("min1", 5)
2026-02-20T22:09:17.2789520Z          max1 = type_limits.get("max1", 20)
2026-02-20T22:09:17.2789994Z          min2 = type_limits.get("min2", 1)
2026-02-20T22:09:17.2790434Z          max2 = type_limits.get("max2", 5)
2026-02-20T22:09:17.2790837Z -        
2026-02-20T22:09:17.2791101Z +
2026-02-20T22:09:17.2791403Z          num1 = random.randint(min1, max1)
2026-02-20T22:09:17.2792340Z -        num2 = random.randint(min2, min(num1-1, max2))  # Eviter les soustractions avec résultat négatif
2026-02-20T22:09:17.2793320Z +        num2 = random.randint(
2026-02-20T22:09:17.2793726Z +            min2, min(num1 - 1, max2)
2026-02-20T22:09:17.2794337Z +        )  # Eviter les soustractions avec résultat négatif
2026-02-20T22:09:17.2794866Z          result = num1 - num2
2026-02-20T22:09:17.2795233Z -        
2026-02-20T22:09:17.2795501Z +
2026-02-20T22:09:17.2795898Z          # Thème Star Wars pour la soustraction
2026-02-20T22:09:17.2796585Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2797299Z -            question_template = random.choice([
2026-02-20T22:09:17.2798273Z -                f"Tu as {num1} portions de rations, mais tu en as utilisé {num2}. Combien te reste-t-il?",
2026-02-20T22:09:17.2799629Z -                f"Il y avait {num1} droïdes dans le hangar, mais {num2} sont partis en mission. Combien reste-t-il de droïdes?",
2026-02-20T22:09:17.2813797Z -                f"Tu as parcouru {num1} années-lumière, mais il te reste encore {num2} années-lumière à faire. Quelle distance as-tu déjà parcourue?"
2026-02-20T22:09:17.2814820Z -            ])
2026-02-20T22:09:17.2815354Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2816095Z +            question_template = random.choice(
2026-02-20T22:09:17.2816578Z +                [
2026-02-20T22:09:17.2817413Z +                    f"Tu as {num1} portions de rations, mais tu en as utilisé {num2}. Combien te reste-t-il?",
2026-02-20T22:09:17.2818843Z +                    f"Il y avait {num1} droïdes dans le hangar, mais {num2} sont partis en mission. Combien reste-t-il de droïdes?",
2026-02-20T22:09:17.2820565Z +                    f"Tu as parcouru {num1} années-lumière, mais il te reste encore {num2} années-lumière à faire. Quelle distance as-tu déjà parcourue?",
2026-02-20T22:09:17.2821591Z +                ]
2026-02-20T22:09:17.2821909Z +            )
2026-02-20T22:09:17.2822858Z              explanation_template = f"Pour trouver la réponse, tu dois soustraire {num2} de {num1}, ce qui donne {result}."
2026-02-20T22:09:17.2825075Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2825627Z -            question_template = random.choice([
2026-02-20T22:09:17.2826913Z -                f"La flotte rebelle comptait {num1} vaisseaux, mais {num2} ont été détruits dans la bataille. Combien de vaisseaux reste-t-il?",
2026-02-20T22:09:17.2828925Z -                f"L'Empire avait {num1} planètes sous son contrôle, mais {num2} se sont rebellées. Combien de planètes restent loyales?",
2026-02-20T22:09:17.2830704Z -                f"Le Faucon Millenium a {num1} pièces de contrebande, mais {num2} sont confisquées par les Impériaux. Combien de pièces reste-t-il?"
2026-02-20T22:09:17.2832055Z -            ])
2026-02-20T22:09:17.2832750Z -            explanation_template = f"Pour calculer ce qui reste, on soustrait: {num1} - {num2} = {result}."
2026-02-20T22:09:17.2833732Z -        
2026-02-20T22:09:17.2834102Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2834646Z +            question_template = random.choice(
2026-02-20T22:09:17.2835093Z +                [
2026-02-20T22:09:17.2836248Z +                    f"La flotte rebelle comptait {num1} vaisseaux, mais {num2} ont été détruits dans la bataille. Combien de vaisseaux reste-t-il?",
2026-02-20T22:09:17.2838016Z +                    f"L'Empire avait {num1} planètes sous son contrôle, mais {num2} se sont rebellées. Combien de planètes restent loyales?",
2026-02-20T22:09:17.2839788Z +                    f"Le Faucon Millenium a {num1} pièces de contrebande, mais {num2} sont confisquées par les Impériaux. Combien de pièces reste-t-il?",
2026-02-20T22:09:17.2840843Z +                ]
2026-02-20T22:09:17.2841138Z +            )
2026-02-20T22:09:17.2841468Z +            explanation_template = (
2026-02-20T22:09:17.2842090Z +                f"Pour calculer ce qui reste, on soustrait: {num1} - {num2} = {result}."
2026-02-20T22:09:17.2842778Z +            )
2026-02-20T22:09:17.2843265Z +
2026-02-20T22:09:17.2843747Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2844226Z          choices = [
2026-02-20T22:09:17.2844557Z              str(result),
2026-02-20T22:09:17.2844991Z              str(result + random.randint(1, min(5, max2))),
2026-02-20T22:09:17.2845626Z -            str(result - random.randint(1, min(3, result//2))),
2026-02-20T22:09:17.2846340Z -            str(num2 - num1)  # Erreur commune: inverser l'ordre de la soustraction
2026-02-20T22:09:17.2847125Z +            str(result - random.randint(1, min(3, result // 2))),
2026-02-20T22:09:17.2847879Z +            str(num2 - num1),  # Erreur commune: inverser l'ordre de la soustraction
2026-02-20T22:09:17.2848490Z          ]
2026-02-20T22:09:17.2848797Z          random.shuffle(choices)
2026-02-20T22:09:17.2849161Z -        
2026-02-20T22:09:17.2849455Z -        exercise_data.update({
2026-02-20T22:09:17.2850521Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Conflit galactique - Soustraction pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2851667Z -            "question": question_template,
2026-02-20T22:09:17.2852128Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2852509Z -            "choices": choices,
2026-02-20T22:09:17.2852882Z -            "num1": num1,
2026-02-20T22:09:17.2853411Z -            "num2": num2,
2026-02-20T22:09:17.2854248Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2855164Z -        })
2026-02-20T22:09:17.2855548Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2856050Z +
2026-02-20T22:09:17.2856331Z +        exercise_data.update(
2026-02-20T22:09:17.2856695Z +            {
2026-02-20T22:09:17.2857654Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Conflit galactique - Soustraction pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2858771Z +                "question": question_template,
2026-02-20T22:09:17.2859246Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2859688Z +                "choices": choices,
2026-02-20T22:09:17.2860077Z +                "num1": num1,
2026-02-20T22:09:17.2860671Z +                "num2": num2,
2026-02-20T22:09:17.2861547Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2862461Z +            }
2026-02-20T22:09:17.2862745Z +        )
2026-02-20T22:09:17.2863243Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2864037Z      elif normalized_type == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.2864837Z          # Utiliser des limites adaptées pour la multiplication
2026-02-20T22:09:17.2865415Z          min_val = type_limits.get("min", 2)
2026-02-20T22:09:17.2865878Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.2866303Z -        
2026-02-20T22:09:17.2866568Z +
2026-02-20T22:09:17.2866866Z          num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2867357Z          num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2867804Z          result = num1 * num2
2026-02-20T22:09:17.2868159Z -        
2026-02-20T22:09:17.2868419Z +
2026-02-20T22:09:17.2868827Z          # Thème Star Wars pour la multiplication
2026-02-20T22:09:17.2869511Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2870223Z -            question_template = random.choice([
2026-02-20T22:09:17.2871096Z -                f"Chaque Padawan a {num2} cristaux Kyber. S'il y a {num1} Padawans, combien de cristaux y a-t-il au total?",
2026-02-20T22:09:17.2872420Z -                f"Chaque droïde astromech a {num2} outils. Combien d'outils ont {num1} droïdes au total?",
2026-02-20T22:09:17.2873738Z -                f"Chaque module de formation a {num2} exercices. Combien d'exercices y a-t-il dans {num1} modules?"
2026-02-20T22:09:17.2874565Z -            ])
2026-02-20T22:09:17.2875137Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2875880Z +            question_template = random.choice(
2026-02-20T22:09:17.2876316Z +                [
2026-02-20T22:09:17.2877067Z +                    f"Chaque Padawan a {num2} cristaux Kyber. S'il y a {num1} Padawans, combien de cristaux y a-t-il au total?",
2026-02-20T22:09:17.2878437Z +                    f"Chaque droïde astromech a {num2} outils. Combien d'outils ont {num1} droïdes au total?",
2026-02-20T22:09:17.2879591Z +                    f"Chaque module de formation a {num2} exercices. Combien d'exercices y a-t-il dans {num1} modules?",
2026-02-20T22:09:17.2880478Z +                ]
2026-02-20T22:09:17.2880773Z +            )
2026-02-20T22:09:17.2881593Z              explanation_template = f"Pour trouver le total, tu dois multiplier le nombre de {num1} par {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2882590Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2883304Z -            question_template = random.choice([
2026-02-20T22:09:17.2884132Z -                f"Chaque escadron comprend {num2} X-wings. Combien de X-wings y a-t-il dans {num1} escadrons?",
2026-02-20T22:09:17.2885475Z -                f"Chaque Star Destroyer transporte {num2} TIE Fighters. Combien de TIE Fighters y a-t-il sur {num1} Star Destroyers?",
2026-02-20T22:09:17.2887047Z -                f"Chaque secteur contient {num2} systèmes stellaires. Combien de systèmes y a-t-il dans {num1} secteurs?"
2026-02-20T22:09:17.2887889Z -            ])
2026-02-20T22:09:17.2888705Z -            explanation_template = f"Pour calculer le total, on multiplie: {num1} × {num2} = {result}."
2026-02-20T22:09:17.2889451Z -        
2026-02-20T22:09:17.2889820Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2890380Z +            question_template = random.choice(
2026-02-20T22:09:17.2890806Z +                [
2026-02-20T22:09:17.2891484Z +                    f"Chaque escadron comprend {num2} X-wings. Combien de X-wings y a-t-il dans {num1} escadrons?",
2026-02-20T22:09:17.2892838Z +                    f"Chaque Star Destroyer transporte {num2} TIE Fighters. Combien de TIE Fighters y a-t-il sur {num1} Star Destroyers?",
2026-02-20T22:09:17.2894939Z +                    f"Chaque secteur contient {num2} systèmes stellaires. Combien de systèmes y a-t-il dans {num1} secteurs?",
2026-02-20T22:09:17.2895807Z +                ]
2026-02-20T22:09:17.2896099Z +            )
2026-02-20T22:09:17.2896407Z +            explanation_template = (
2026-02-20T22:09:17.2897325Z +                f"Pour calculer le total, on multiplie: {num1} × {num2} = {result}."
2026-02-20T22:09:17.2897938Z +            )
2026-02-20T22:09:17.2898201Z +
2026-02-20T22:09:17.2898624Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2899081Z          choices = [
2026-02-20T22:09:17.2899415Z              str(result),
2026-02-20T22:09:17.2899837Z              str(result + num1),  # Erreur: une fois de trop
2026-02-20T22:09:17.2900420Z              str(result - num2),  # Erreur: une fois de moins
2026-02-20T22:09:17.2901058Z -            str(num1 + num2)  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.2901789Z +            str(num1 + num2),  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.2902338Z          ]
2026-02-20T22:09:17.2902631Z          random.shuffle(choices)
2026-02-20T22:09:17.2903164Z -        
2026-02-20T22:09:17.2903462Z -        exercise_data.update({
2026-02-20T22:09:17.2904481Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Forces galactiques - Multiplication pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2905618Z -            "question": question_template,
2026-02-20T22:09:17.2906098Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2906557Z -            "choices": choices,
2026-02-20T22:09:17.2906950Z -            "num1": num1,
2026-02-20T22:09:17.2907318Z -            "num2": num2,
2026-02-20T22:09:17.2908165Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2909092Z -        })
2026-02-20T22:09:17.2909501Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2910002Z +
2026-02-20T22:09:17.2910295Z +        exercise_data.update(
2026-02-20T22:09:17.2910668Z +            {
2026-02-20T22:09:17.2911661Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Forces galactiques - Multiplication pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2912841Z +                "question": question_template,
2026-02-20T22:09:17.2913584Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2914035Z +                "choices": choices,
2026-02-20T22:09:17.2914447Z +                "num1": num1,
2026-02-20T22:09:17.2914809Z +                "num2": num2,
2026-02-20T22:09:17.2915677Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2916615Z +            }
2026-02-20T22:09:17.2916905Z +        )
2026-02-20T22:09:17.2917246Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2917807Z      elif normalized_type == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.2918497Z          # Générer une division avec reste nul
2026-02-20T22:09:17.2919035Z          min_divisor = type_limits.get("min_divisor", 2)
2026-02-20T22:09:17.2919622Z          max_divisor = type_limits.get("max_divisor", 10)
2026-02-20T22:09:17.2920217Z          min_result = type_limits.get("min_result", 1)
2026-02-20T22:09:17.2920793Z          max_result = type_limits.get("max_result", 10)
2026-02-20T22:09:17.2921267Z -        
2026-02-20T22:09:17.2921531Z +
2026-02-20T22:09:17.2922267Z          # Pour assurer une division sans reste, on génère d'abord le diviseur et le quotient
2026-02-20T22:09:17.2923324Z          num2 = random.randint(min_divisor, max_divisor)  # diviseur
2026-02-20T22:09:17.2924038Z          result = random.randint(min_result, max_result)  # quotient
2026-02-20T22:09:17.2924610Z          num1 = num2 * result  # dividende
2026-02-20T22:09:17.2925020Z -        
2026-02-20T22:09:17.2925542Z +
2026-02-20T22:09:17.2925991Z          # Thème Star Wars pour la division
2026-02-20T22:09:17.2926670Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2927400Z -            question_template = random.choice([
2026-02-20T22:09:17.2928679Z -                f"Tu as {num1} cristaux Kyber à distribuer équitablement entre {num2} Padawans. Combien de cristaux chaque Padawan recevra-t-il?",
2026-02-20T22:09:17.2930566Z -                f"Il y a {num1} droïdes à répartir dans {num2} hangars. Combien de droïdes y aura-t-il dans chaque hangar?",
2026-02-20T22:09:17.2931843Z -                f"Tu dois parcourir {num1} parsecs en {num2} jours. Combien de parsecs dois-tu parcourir chaque jour?"
2026-02-20T22:09:17.2932695Z -            ])
2026-02-20T22:09:17.2933452Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2934188Z +            question_template = random.choice(
2026-02-20T22:09:17.2934643Z +                [
2026-02-20T22:09:17.2935796Z +                    f"Tu as {num1} cristaux Kyber à distribuer équitablement entre {num2} Padawans. Combien de cristaux chaque Padawan recevra-t-il?",
2026-02-20T22:09:17.2937408Z +                    f"Il y a {num1} droïdes à répartir dans {num2} hangars. Combien de droïdes y aura-t-il dans chaque hangar?",
2026-02-20T22:09:17.2938676Z +                    f"Tu dois parcourir {num1} parsecs en {num2} jours. Combien de parsecs dois-tu parcourir chaque jour?",
2026-02-20T22:09:17.2939524Z +                ]
2026-02-20T22:09:17.2939826Z +            )
2026-02-20T22:09:17.2940758Z              explanation_template = f"Pour trouver la réponse, tu dois diviser {num1} par {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2941701Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2942257Z -            question_template = random.choice([
2026-02-20T22:09:17.2943704Z -                f"L'Alliance a {num1} soldats à répartir équitablement dans {num2} bases. Combien de soldats seront affectés à chaque base?",
2026-02-20T22:09:17.2945626Z -                f"L'Empire a fabriqué {num1} blasters qui doivent être distribués à {num2} escouades. Combien de blasters chaque escouade recevra-t-elle?",
2026-02-20T22:09:17.2947617Z -                f"Un convoi de {num1} containers doit être réparti sur {num2} vaisseaux de transport. Combien de containers chaque vaisseau transportera-t-il?"
2026-02-20T22:09:17.2948734Z -            ])
2026-02-20T22:09:17.2949575Z -            explanation_template = f"Pour calculer le résultat, on divise: {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.2950351Z -        
2026-02-20T22:09:17.2950715Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2951259Z +            question_template = random.choice(
2026-02-20T22:09:17.2951705Z +                [
2026-02-20T22:09:17.2952821Z +                    f"L'Alliance a {num1} soldats à répartir équitablement dans {num2} bases. Combien de soldats seront affectés à chaque base?",
2026-02-20T22:09:17.2954847Z +                    f"L'Empire a fabriqué {num1} blasters qui doivent être distribués à {num2} escouades. Combien de blasters chaque escouade recevra-t-elle?",
2026-02-20T22:09:17.2956870Z +                    f"Un convoi de {num1} containers doit être réparti sur {num2} vaisseaux de transport. Combien de containers chaque vaisseau transportera-t-il?",
2026-02-20T22:09:17.2958015Z +                ]
2026-02-20T22:09:17.2958332Z +            )
2026-02-20T22:09:17.2958665Z +            explanation_template = (
2026-02-20T22:09:17.2959455Z +                f"Pour calculer le résultat, on divise: {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.2960096Z +            )
2026-02-20T22:09:17.2960383Z +
2026-02-20T22:09:17.2960844Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2961344Z          choices = [
2026-02-20T22:09:17.2961674Z              str(result),
2026-02-20T22:09:17.2962127Z              str(result + random.randint(1, min(5, result))),
2026-02-20T22:09:17.2963330Z              str(result - random.randint(1, min(3, result - 1) if result > 1 else 1)),
2026-02-20T22:09:17.2964409Z -            str(num1 // (num2 + random.randint(1, 3)))  # Diviseur légèrement différent
2026-02-20T22:09:17.2965442Z +            str(num1 // (num2 + random.randint(1, 3))),  # Diviseur légèrement différent
2026-02-20T22:09:17.2966422Z          ]
2026-02-20T22:09:17.2966741Z          random.shuffle(choices)
2026-02-20T22:09:17.2967135Z -        
2026-02-20T22:09:17.2967458Z -        exercise_data.update({
2026-02-20T22:09:17.2968777Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Stratégie galactique - Division pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2969940Z -            "question": question_template,
2026-02-20T22:09:17.2970422Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2970874Z -            "choices": choices,
2026-02-20T22:09:17.2971259Z -            "num1": num1,
2026-02-20T22:09:17.2971649Z -            "num2": num2,
2026-02-20T22:09:17.2972510Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2973617Z -        })
2026-02-20T22:09:17.2973874Z +
2026-02-20T22:09:17.2974121Z +        exercise_data.update(
2026-02-20T22:09:17.2974487Z +            {
2026-02-20T22:09:17.2975696Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Stratégie galactique - Division pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2976821Z +                "question": question_template,
2026-02-20T22:09:17.2977314Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2977785Z +                "choices": choices,
2026-02-20T22:09:17.2978204Z +                "num1": num1,
2026-02-20T22:09:17.2978577Z +                "num2": num2,
2026-02-20T22:09:17.2979457Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2980467Z +            }
2026-02-20T22:09:17.2980768Z +        )
2026-02-20T22:09:17.2981100Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2981675Z      elif normalized_type == ExerciseTypes.FRACTIONS:
2026-02-20T22:09:17.2982546Z          # Génération IA d'un exercice sur les fractions avec thème Star Wars
2026-02-20T22:09:17.2983413Z          from fractions import Fraction
2026-02-20T22:09:17.2983831Z  
2026-02-20T22:09:17.2984247Z          # Paramètres selon la difficulté
2026-02-20T22:09:17.2984938Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2985848Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2986712Z              denom1, denom2 = random.choice([2, 3, 4]), random.choice([2, 3, 4])
2026-02-20T22:09:17.2987513Z -            num1, num2 = random.randint(1, denom1-1), random.randint(1, denom2-1)
2026-02-20T22:09:17.2988374Z +            num1, num2 = random.randint(1, denom1 - 1), random.randint(1, denom2 - 1)
2026-02-20T22:09:17.2989048Z              operation = "+"
2026-02-20T22:09:17.2989688Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.2990632Z -            denom1, denom2 = random.choice([2, 3, 4, 5, 6]), random.choice([2, 3, 4, 5, 6])
2026-02-20T22:09:17.2991514Z -            num1, num2 = random.randint(1, denom1-1), random.randint(1, denom2-1)
2026-02-20T22:09:17.2992402Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.2993461Z +            denom1, denom2 = random.choice([2, 3, 4, 5, 6]), random.choice(
2026-02-20T22:09:17.2994050Z +                [2, 3, 4, 5, 6]
2026-02-20T22:09:17.2994422Z +            )
2026-02-20T22:09:17.2994923Z +            num1, num2 = random.randint(1, denom1 - 1), random.randint(1, denom2 - 1)
2026-02-20T22:09:17.2995614Z              operation = random.choice(["+", "-"])
2026-02-20T22:09:17.2996608Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.2997618Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.2998492Z              denom1, denom2 = random.randint(2, 8), random.randint(2, 8)
2026-02-20T22:09:17.2999470Z              num1, num2 = random.randint(1, denom1), random.randint(1, denom2)
2026-02-20T22:09:17.3000303Z              operation = random.choice(["+", "-", "×"])
2026-02-20T22:09:17.3000858Z          else:  # MAITRE
2026-02-20T22:09:17.3001372Z              denom1, denom2 = random.randint(2, 12), random.randint(2, 12)
2026-02-20T22:09:17.3002135Z -            num1, num2 = random.randint(1, denom1*2), random.randint(1, denom2*2)
2026-02-20T22:09:17.3003154Z +            num1, num2 = random.randint(1, denom1 * 2), random.randint(1, denom2 * 2)
2026-02-20T22:09:17.3004040Z              operation = random.choice(["+", "-", "×", "÷"])
2026-02-20T22:09:17.3004536Z -        
2026-02-20T22:09:17.3004817Z +
2026-02-20T22:09:17.3005188Z          # Calcul du résultat
2026-02-20T22:09:17.3005730Z          frac1, frac2 = Fraction(num1, denom1), Fraction(num2, denom2)
2026-02-20T22:09:17.3006315Z          if operation == "+":
2026-02-20T22:09:17.3006718Z              result = frac1 + frac2
2026-02-20T22:09:17.3007164Z              op_word = "additionner"
2026-02-20T22:09:17.3007592Z          elif operation == "-":
2026-02-20T22:09:17.3008312Z -            if frac1 < frac2: frac1, frac2 = frac2, frac1  # Éviter les négatifs
2026-02-20T22:09:17.3008920Z +            if frac1 < frac2:
2026-02-20T22:09:17.3009511Z +                frac1, frac2 = frac2, frac1  # Éviter les négatifs
2026-02-20T22:09:17.3010042Z              result = frac1 - frac2
2026-02-20T22:09:17.3010468Z              op_word = "soustraire"
2026-02-20T22:09:17.3010952Z          elif operation == "×":
2026-02-20T22:09:17.3011352Z              result = frac1 * frac2
2026-02-20T22:09:17.3011751Z              op_word = "multiplier"
2026-02-20T22:09:17.3012187Z          else:  # "÷"
2026-02-20T22:09:17.3012518Z -            if num2 == 0: num2 = 1
2026-02-20T22:09:17.3012907Z +            if num2 == 0:
2026-02-20T22:09:17.3013460Z +                num2 = 1
2026-02-20T22:09:17.3013818Z              result = frac1 / frac2
2026-02-20T22:09:17.3014252Z              op_word = "diviser"
2026-02-20T22:09:17.3014618Z -        
2026-02-20T22:09:17.3014893Z +
2026-02-20T22:09:17.3015260Z          # Format du résultat
2026-02-20T22:09:17.3015663Z          if result.denominator == 1:
2026-02-20T22:09:17.3016149Z              formatted_result = str(result.numerator)
2026-02-20T22:09:17.3016623Z          else:
2026-02-20T22:09:17.3017095Z              formatted_result = f"{result.numerator}/{result.denominator}"
2026-02-20T22:09:17.3017673Z -        
2026-02-20T22:09:17.3017944Z +
2026-02-20T22:09:17.3018347Z          # Questions Star Wars selon la difficulté
2026-02-20T22:09:17.3019074Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3019799Z -            question_template = random.choice([
2026-02-20T22:09:17.3021020Z -                f"Luke mange {num1}/{denom1} de sa ration et Leia mange {num2}/{denom2} de la sienne. Quelle fraction ont-ils mangée ensemble?",
2026-02-20T22:09:17.3022662Z -                f"R2-D2 a réparé {num1}/{denom1} des systèmes et C-3PO {num2}/{denom2}. Quelle fraction totale ont-ils réparée?",
2026-02-20T22:09:17.3024646Z -                f"Dans le Faucon Millenium, {num1}/{denom1} des moteurs fonctionnent et {num2}/{denom2} des boucliers. Quelle fraction totale est opérationnelle?"
2026-02-20T22:09:17.3025769Z -            ])
2026-02-20T22:09:17.3026341Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3027088Z +            question_template = random.choice(
2026-02-20T22:09:17.3027551Z +                [
2026-02-20T22:09:17.3028635Z +                    f"Luke mange {num1}/{denom1} de sa ration et Leia mange {num2}/{denom2} de la sienne. Quelle fraction ont-ils mangée ensemble?",
2026-02-20T22:09:17.3030524Z +                    f"R2-D2 a réparé {num1}/{denom1} des systèmes et C-3PO {num2}/{denom2}. Quelle fraction totale ont-ils réparée?",
2026-02-20T22:09:17.3032306Z +                    f"Dans le Faucon Millenium, {num1}/{denom1} des moteurs fonctionnent et {num2}/{denom2} des boucliers. Quelle fraction totale est opérationnelle?",
2026-02-20T22:09:17.3033855Z +                ]
2026-02-20T22:09:17.3034166Z +            )
2026-02-20T22:09:17.3034450Z          else:
2026-02-20T22:09:17.3034802Z -            question_template = random.choice([
2026-02-20T22:09:17.3036100Z -                f"L'Étoile de la Mort a détruit {num1}/{denom1} de la flotte rebelle, puis {num2}/{denom2} de plus. Quelle fraction totale a été détruite?",
2026-02-20T22:09:17.3037864Z -                f"Yoda maîtrise {num1}/{denom1} de la Force et enseigne {num2}/{denom2} de ses connaissances. Quelle fraction a-t-il transmise?",
2026-02-20T22:09:17.3039639Z -                f"L'Empire contrôle {num1}/{denom1} de la galaxie et conquiert {num2}/{denom2} de plus. Quelle fraction contrôle-t-il maintenant?"
2026-02-20T22:09:17.3040640Z -            ])
2026-02-20T22:09:17.3040957Z -        
2026-02-20T22:09:17.3041286Z +            question_template = random.choice(
2026-02-20T22:09:17.3041774Z +                [
2026-02-20T22:09:17.3042931Z +                    f"L'Étoile de la Mort a détruit {num1}/{denom1} de la flotte rebelle, puis {num2}/{denom2} de plus. Quelle fraction totale a été détruite?",
2026-02-20T22:09:17.3044939Z +                    f"Yoda maîtrise {num1}/{denom1} de la Force et enseigne {num2}/{denom2} de ses connaissances. Quelle fraction a-t-il transmise?",
2026-02-20T22:09:17.3046727Z +                    f"L'Empire contrôle {num1}/{denom1} de la galaxie et conquiert {num2}/{denom2} de plus. Quelle fraction contrôle-t-il maintenant?",
2026-02-20T22:09:17.3047640Z +                ]
2026-02-20T22:09:17.3047949Z +            )
2026-02-20T22:09:17.3048219Z +
2026-02-20T22:09:17.3048516Z          # Choix avec erreurs typiques
2026-02-20T22:09:17.3049174Z          incorrect1 = f"{num1+num2}/{denom1+denom2}"  # Erreur: additionner num et denom
2026-02-20T22:09:17.3050153Z          incorrect2 = f"{num1}/{denom2}"  # Confusion des dénominateurs
2026-02-20T22:09:17.3050819Z          incorrect3 = f"{num2}/{denom1}"  # Inversion
2026-02-20T22:09:17.3051284Z -        
2026-02-20T22:09:17.3051566Z +
2026-02-20T22:09:17.3052010Z          choices = [formatted_result, incorrect1, incorrect2, incorrect3]
2026-02-20T22:09:17.3052656Z          random.shuffle(choices)
2026-02-20T22:09:17.3053238Z -        
2026-02-20T22:09:17.3053560Z -        exercise_data.update({
2026-02-20T22:09:17.3054498Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Fractions Jedi - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3056503Z -            "question": f"Problème galactique: {question_template.replace(f'{num1}/{denom1} {operation} {num2}/{denom2}', f'{num1}/{denom1} {operation} {num2}/{denom2}')}",
2026-02-20T22:09:17.3057765Z -            "correct_answer": formatted_result,
2026-02-20T22:09:17.3058247Z -            "choices": choices,
2026-02-20T22:09:17.3059859Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour {op_word} les fractions {num1}/{denom1} et {num2}/{denom2}, le résultat est {formatted_result}. {explanation_suffix}"
2026-02-20T22:09:17.3061206Z -        })
2026-02-20T22:09:17.3061503Z +
2026-02-20T22:09:17.3061797Z +        exercise_data.update(
2026-02-20T22:09:17.3062185Z +            {
2026-02-20T22:09:17.3063238Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Fractions Jedi - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3065230Z +                "question": f"Problème galactique: {question_template.replace(f'{num1}/{denom1} {operation} {num2}/{denom2}', f'{num1}/{denom1} {operation} {num2}/{denom2}')}",
2026-02-20T22:09:17.3066738Z +                "correct_answer": formatted_result,
2026-02-20T22:09:17.3067179Z +                "choices": choices,
2026-02-20T22:09:17.3068591Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour {op_word} les fractions {num1}/{denom1} et {num2}/{denom2}, le résultat est {formatted_result}. {explanation_suffix}",
2026-02-20T22:09:17.3069955Z +            }
2026-02-20T22:09:17.3070202Z +        )
2026-02-20T22:09:17.3070512Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3071040Z      elif normalized_type == ExerciseTypes.GEOMETRIE:
2026-02-20T22:09:17.3071774Z          # Génération IA d'un exercice de géométrie avec thème Star Wars
2026-02-20T22:09:17.3072325Z          import math
2026-02-20T22:09:17.3072622Z  
2026-02-20T22:09:17.3073222Z          # Formes et propriétés selon la difficulté
2026-02-20T22:09:17.3073881Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3074631Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3075350Z              shape = random.choice(["carré", "rectangle"])
2026-02-20T22:09:17.3075990Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3076735Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3077713Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3078718Z              shape = random.choice(["carré", "rectangle", "triangle"])
2026-02-20T22:09:17.3079495Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3080363Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3081358Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3082407Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3083520Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3084068Z          else:  # MAITRE
2026-02-20T22:09:17.3084759Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3085674Z              property = random.choice(["périmètre", "aire", "volume"])
2026-02-20T22:09:17.3086278Z -        
2026-02-20T22:09:17.3086562Z +
2026-02-20T22:09:17.3086999Z          # Génération des valeurs et calculs
2026-02-20T22:09:17.3087526Z          if shape == "carré":
2026-02-20T22:09:17.3088135Z              side = random.randint(type_limits.get("min", 3), type_limits.get("max", 15))
2026-02-20T22:09:17.3088897Z              if property == "périmètre":
2026-02-20T22:09:17.3089301Z                  result = 4 * side
2026-02-20T22:09:17.3089760Z                  formula = f"4 × {side}"
2026-02-20T22:09:17.3090139Z              else:  # aire
2026-02-20T22:09:17.3090524Z                  result = side * side
2026-02-20T22:09:17.3091007Z                  formula = f"{side}²"
2026-02-20T22:09:17.3091380Z -            
2026-02-20T22:09:17.3091722Z -            question_template = random.choice([
2026-02-20T22:09:17.3092657Z -                f"L'Étoile de la Mort a une section carrée de côté {side} km. Quel est son {property}?",
2026-02-20T22:09:17.3094074Z -                f"La base rebelle a un hangar carré de {side} m de côté. Calcule son {property}.",
2026-02-20T22:09:17.3095224Z -                f"Le Temple Jedi a une salle carrée de {side} m de côté. Quel est son {property}?"
2026-02-20T22:09:17.3095937Z -            ])
2026-02-20T22:09:17.3096223Z -            
2026-02-20T22:09:17.3096505Z +
2026-02-20T22:09:17.3096810Z +            question_template = random.choice(
2026-02-20T22:09:17.3097256Z +                [
2026-02-20T22:09:17.3098043Z +                    f"L'Étoile de la Mort a une section carrée de côté {side} km. Quel est son {property}?",
2026-02-20T22:09:17.3099506Z +                    f"La base rebelle a un hangar carré de {side} m de côté. Calcule son {property}.",
2026-02-20T22:09:17.3100660Z +                    f"Le Temple Jedi a une salle carrée de {side} m de côté. Quel est son {property}?",
2026-02-20T22:09:17.3101362Z +                ]
2026-02-20T22:09:17.3101665Z +            )
2026-02-20T22:09:17.3102161Z +
2026-02-20T22:09:17.3102448Z          elif shape == "rectangle":
2026-02-20T22:09:17.3103319Z -            length = random.randint(type_limits.get("min", 4), type_limits.get("max", 20))
2026-02-20T22:09:17.3104170Z -            width = random.randint(type_limits.get("min", 3), length-1)
2026-02-20T22:09:17.3104774Z +            length = random.randint(
2026-02-20T22:09:17.3105287Z +                type_limits.get("min", 4), type_limits.get("max", 20)
2026-02-20T22:09:17.3105808Z +            )
2026-02-20T22:09:17.3106246Z +            width = random.randint(type_limits.get("min", 3), length - 1)
2026-02-20T22:09:17.3106962Z              if property == "périmètre":
2026-02-20T22:09:17.3107440Z                  result = 2 * (length + width)
2026-02-20T22:09:17.3108022Z                  formula = f"2 × ({length} + {width})"
2026-02-20T22:09:17.3108480Z              else:  # aire
2026-02-20T22:09:17.3108853Z                  result = length * width
2026-02-20T22:09:17.3109390Z                  formula = f"{length} × {width}"
2026-02-20T22:09:17.3109829Z -            
2026-02-20T22:09:17.3110167Z -            question_template = random.choice([
2026-02-20T22:09:17.3111189Z -                f"Le Faucon Millenium a une soute rectangulaire de {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3112320Z -                f"Un Star Destroyer a un hangar de {length} km sur {width} km. Calcule son {property}.",
2026-02-20T22:09:17.3113648Z -                f"La cantina de Mos Eisley mesure {length}m × {width}m. Quel est son {property}?"
2026-02-20T22:09:17.3114373Z -            ])
2026-02-20T22:09:17.3114685Z -            
2026-02-20T22:09:17.3114989Z +
2026-02-20T22:09:17.3115311Z +            question_template = random.choice(
2026-02-20T22:09:17.3115748Z +                [
2026-02-20T22:09:17.3116666Z +                    f"Le Faucon Millenium a une soute rectangulaire de {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3117830Z +                    f"Un Star Destroyer a un hangar de {length} km sur {width} km. Calcule son {property}.",
2026-02-20T22:09:17.3119054Z +                    f"La cantina de Mos Eisley mesure {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3119775Z +                ]
2026-02-20T22:09:17.3120074Z +            )
2026-02-20T22:09:17.3120364Z +
2026-02-20T22:09:17.3120644Z          elif shape == "triangle":
2026-02-20T22:09:17.3121301Z              base = random.randint(type_limits.get("min", 4), type_limits.get("max", 15))
2026-02-20T22:09:17.3122231Z -            height = random.randint(type_limits.get("min", 3), type_limits.get("max", 12))
2026-02-20T22:09:17.3123154Z +            height = random.randint(
2026-02-20T22:09:17.3123727Z +                type_limits.get("min", 3), type_limits.get("max", 12)
2026-02-20T22:09:17.3124267Z +            )
2026-02-20T22:09:17.3124582Z              if property == "aire":
2026-02-20T22:09:17.3125000Z                  result = (base * height) / 2
2026-02-20T22:09:17.3125600Z                  formula = f"({base} × {height}) ÷ 2"
2026-02-20T22:09:17.3126197Z              else:  # périmètre approximatif
2026-02-20T22:09:17.3126791Z -                hypotenuse = round(math.sqrt(base*base + height*height), 1)
2026-02-20T22:09:17.3127540Z +                hypotenuse = round(math.sqrt(base * base + height * height), 1)
2026-02-20T22:09:17.3128182Z                  result = base + height + hypotenuse
2026-02-20T22:09:17.3128712Z                  formula = f"{base} + {height} + {hypotenuse}"
2026-02-20T22:09:17.3129175Z -            
2026-02-20T22:09:17.3129514Z -            question_template = random.choice([
2026-02-20T22:09:17.3130358Z -                f"Un X-wing a des ailes triangulaires de base {base}m et hauteur {height}m. Quelle est leur {property}?",
2026-02-20T22:09:17.3131882Z -                f"Le sabre laser de Yoda forme un triangle de base {base} cm et hauteur {height} cm. Calcule son {property}.",
2026-02-20T22:09:17.3133736Z -                f"Une voile solaire triangulaire mesure {base}km × {height}km. Quel est son {property}?"
2026-02-20T22:09:17.3134745Z -            ])
2026-02-20T22:09:17.3135030Z -            
2026-02-20T22:09:17.3135292Z +
2026-02-20T22:09:17.3135567Z +            question_template = random.choice(
2026-02-20T22:09:17.3135959Z +                [
2026-02-20T22:09:17.3136667Z +                    f"Un X-wing a des ailes triangulaires de base {base}m et hauteur {height}m. Quelle est leur {property}?",
2026-02-20T22:09:17.3137933Z +                    f"Le sabre laser de Yoda forme un triangle de base {base} cm et hauteur {height} cm. Calcule son {property}.",
2026-02-20T22:09:17.3139338Z +                    f"Une voile solaire triangulaire mesure {base}km × {height}km. Quel est son {property}?",
2026-02-20T22:09:17.3140136Z +                ]
2026-02-20T22:09:17.3140421Z +            )
2026-02-20T22:09:17.3140696Z +
2026-02-20T22:09:17.3140955Z          else:  # cercle
2026-02-20T22:09:17.3141563Z -            radius = random.randint(type_limits.get("min", 2), type_limits.get("max", 10))
2026-02-20T22:09:17.3142300Z +            radius = random.randint(
2026-02-20T22:09:17.3164650Z +                type_limits.get("min", 2), type_limits.get("max", 10)
2026-02-20T22:09:17.3165227Z +            )
2026-02-20T22:09:17.3165713Z              if property == "périmètre":
2026-02-20T22:09:17.3166218Z                  result = round(2 * math.pi * radius, 2)
2026-02-20T22:09:17.3166832Z                  formula = f"2 × π × {radius}"
2026-02-20T22:09:17.3167273Z              else:  # aire
2026-02-20T22:09:17.3167721Z                  result = round(math.pi * radius * radius, 2)
2026-02-20T22:09:17.3168320Z                  formula = f"π × {radius}²"
2026-02-20T22:09:17.3168761Z -            
2026-02-20T22:09:17.3169112Z -            question_template = random.choice([
2026-02-20T22:09:17.3169954Z -                f"L'Étoile de la Mort a un rayon de {radius} km. Quel est son {property}?",
2026-02-20T22:09:17.3171072Z -                f"La planète Tatooine a un rayon de {radius} milliers de km. Calcule son {property}.",
2026-02-20T22:09:17.3172301Z -                f"Un bouclier déflecteur circulaire a un rayon de {radius}m. Quel est son {property}?"
2026-02-20T22:09:17.3173218Z -            ])
2026-02-20T22:09:17.3173507Z -        
2026-02-20T22:09:17.3173769Z +
2026-02-20T22:09:17.3174083Z +            question_template = random.choice(
2026-02-20T22:09:17.3174520Z +                [
2026-02-20T22:09:17.3175217Z +                    f"L'Étoile de la Mort a un rayon de {radius} km. Quel est son {property}?",
2026-02-20T22:09:17.3176327Z +                    f"La planète Tatooine a un rayon de {radius} milliers de km. Calcule son {property}.",
2026-02-20T22:09:17.3177575Z +                    f"Un bouclier déflecteur circulaire a un rayon de {radius}m. Quel est son {property}?",
2026-02-20T22:09:17.3178313Z +                ]
2026-02-20T22:09:17.3178606Z +            )
2026-02-20T22:09:17.3178880Z +
2026-02-20T22:09:17.3179167Z          # Choix avec erreurs typiques
2026-02-20T22:09:17.3179607Z          choices = [
2026-02-20T22:09:17.3179992Z              str(result),
2026-02-20T22:09:17.3180461Z              str(round(result * 0.5, 2)),  # Moitié
2026-02-20T22:09:17.3180950Z -            str(round(result * 2, 2)),    # Double
2026-02-20T22:09:17.3181462Z -            str(round(result * 1.5, 2))   # 1.5 fois
2026-02-20T22:09:17.3181943Z +            str(round(result * 2, 2)),  # Double
2026-02-20T22:09:17.3182391Z +            str(round(result * 1.5, 2)),  # 1.5 fois
2026-02-20T22:09:17.3182794Z          ]
2026-02-20T22:09:17.3183259Z          random.shuffle(choices)
2026-02-20T22:09:17.3183630Z -        
2026-02-20T22:09:17.3183924Z -        exercise_data.update({
2026-02-20T22:09:17.3185387Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Géométrie Galactique - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3186433Z -            "question": question_template,
2026-02-20T22:09:17.3186904Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3187552Z -            "choices": choices,
2026-02-20T22:09:17.3188713Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour calculer le {property} d'un {shape}, on utilise: {formula} = {result}. {explanation_suffix}"
2026-02-20T22:09:17.3189904Z -        })
2026-02-20T22:09:17.3190168Z +
2026-02-20T22:09:17.3190454Z +        exercise_data.update(
2026-02-20T22:09:17.3190815Z +            {
2026-02-20T22:09:17.3191919Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Géométrie Galactique - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3193146Z +                "question": question_template,
2026-02-20T22:09:17.3193647Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3194092Z +                "choices": choices,
2026-02-20T22:09:17.3195238Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour calculer le {property} d'un {shape}, on utilise: {formula} = {result}. {explanation_suffix}",
2026-02-20T22:09:17.3195360Z +            }
2026-02-20T22:09:17.3195474Z +        )
2026-02-20T22:09:17.3195638Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3195829Z      elif normalized_type == ExerciseTypes.DIVERS:
2026-02-20T22:09:17.3196191Z          # Génération IA d'exercices divers avec thème Star Wars
2026-02-20T22:09:17.3196305Z -        
2026-02-20T22:09:17.3196411Z +
2026-02-20T22:09:17.3196694Z          # Types de problèmes selon la difficulté
2026-02-20T22:09:17.3197068Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3197427Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3197702Z              problem_type = random.choice(["age", "monnaie", "temps"])
2026-02-20T22:09:17.3198087Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3198484Z -            problem_type = random.choice(["age", "monnaie", "vitesse", "pourcentage_simple"])
2026-02-20T22:09:17.3198878Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3199258Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3199410Z +            problem_type = random.choice(
2026-02-20T22:09:17.3199629Z +                ["age", "monnaie", "vitesse", "pourcentage_simple"]
2026-02-20T22:09:17.3199751Z +            )
2026-02-20T22:09:17.3200142Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3200629Z              problem_type = random.choice(["vitesse", "pourcentage", "probabilité"])
2026-02-20T22:09:17.3200776Z          else:  # MAITRE
2026-02-20T22:09:17.3201274Z              problem_type = random.choice(["probabilité", "séquence", "logique_avancée"])
2026-02-20T22:09:17.3201388Z -        
2026-02-20T22:09:17.3201496Z +
2026-02-20T22:09:17.3201726Z          # Génération selon le type
2026-02-20T22:09:17.3201879Z          if problem_type == "age":
2026-02-20T22:09:17.3202281Z -            age_actuel = random.randint(type_limits.get("min", 8), type_limits.get("max", 25))
2026-02-20T22:09:17.3202442Z +            age_actuel = random.randint(
2026-02-20T22:09:17.3202685Z +                type_limits.get("min", 8), type_limits.get("max", 25)
2026-02-20T22:09:17.3202792Z +            )
2026-02-20T22:09:17.3203224Z              années = random.randint(1, 10)
2026-02-20T22:09:17.3203456Z              result = age_actuel + années
2026-02-20T22:09:17.3203560Z -            
2026-02-20T22:09:17.3203731Z -            question_template = random.choice([
2026-02-20T22:09:17.3204462Z -                f"Luke a {age_actuel} ans. Dans {années} ans, quel âge aura-t-il?",
2026-02-20T22:09:17.3204994Z -                f"Leia a {age_actuel} ans aujourd'hui. Quel âge aura-t-elle dans {années} ans?",
2026-02-20T22:09:17.3205483Z -                f"Anakin a {age_actuel} ans. Dans combien d'années aura-t-il {result} ans?"
2026-02-20T22:09:17.3205815Z -            ])
2026-02-20T22:09:17.3206441Z -            explanation_template = f"Pour trouver l'âge futur: {age_actuel} + {années} = {result} ans."
2026-02-20T22:09:17.3206555Z -            
2026-02-20T22:09:17.3206668Z +
2026-02-20T22:09:17.3206834Z +            question_template = random.choice(
2026-02-20T22:09:17.3206942Z +                [
2026-02-20T22:09:17.3207375Z +                    f"Luke a {age_actuel} ans. Dans {années} ans, quel âge aura-t-il?",
2026-02-20T22:09:17.3207893Z +                    f"Leia a {age_actuel} ans aujourd'hui. Quel âge aura-t-elle dans {années} ans?",
2026-02-20T22:09:17.3208424Z +                    f"Anakin a {age_actuel} ans. Dans combien d'années aura-t-il {result} ans?",
2026-02-20T22:09:17.3208540Z +                ]
2026-02-20T22:09:17.3208659Z +            )
2026-02-20T22:09:17.3208809Z +            explanation_template = (
2026-02-20T22:09:17.3209245Z +                f"Pour trouver l'âge futur: {age_actuel} + {années} = {result} ans."
2026-02-20T22:09:17.3209380Z +            )
2026-02-20T22:09:17.3209487Z +
2026-02-20T22:09:17.3209641Z          elif problem_type == "monnaie":
2026-02-20T22:09:17.3210002Z              prix = random.randint(type_limits.get("min", 5), type_limits.get("max", 50))
2026-02-20T22:09:17.3210326Z              payé = random.randint(prix + 1, prix + 20)
2026-02-20T22:09:17.3210554Z              result = payé - prix
2026-02-20T22:09:17.3210664Z -            
2026-02-20T22:09:17.3210844Z -            question_template = random.choice([
2026-02-20T22:09:17.3211468Z -                f"Tu achètes un sabre laser à {prix} crédits. Tu paies {payé} crédits. Combien de monnaie?",
2026-02-20T22:09:17.3212034Z -                f"Un droïde coûte {prix} crédits. Tu donnes {payé} crédits. Quelle est la monnaie?",
2026-02-20T22:09:17.3212664Z -                f"Des rations coûtent {prix} crédits. Tu paies avec {payé} crédits. Combien récupères-tu?"
2026-02-20T22:09:17.3212780Z -            ])
2026-02-20T22:09:17.3213634Z -            explanation_template = f"Monnaie = montant payé - prix: {payé} - {prix} = {result} crédits."
2026-02-20T22:09:17.3213755Z -            
2026-02-20T22:09:17.3213872Z +
2026-02-20T22:09:17.3214044Z +            question_template = random.choice(
2026-02-20T22:09:17.3214152Z +                [
2026-02-20T22:09:17.3214792Z +                    f"Tu achètes un sabre laser à {prix} crédits. Tu paies {payé} crédits. Combien de monnaie?",
2026-02-20T22:09:17.3215336Z +                    f"Un droïde coûte {prix} crédits. Tu donnes {payé} crédits. Quelle est la monnaie?",
2026-02-20T22:09:17.3215957Z +                    f"Des rations coûtent {prix} crédits. Tu paies avec {payé} crédits. Combien récupères-tu?",
2026-02-20T22:09:17.3216109Z +                ]
2026-02-20T22:09:17.3216215Z +            )
2026-02-20T22:09:17.3216364Z +            explanation_template = (
2026-02-20T22:09:17.3216833Z +                f"Monnaie = montant payé - prix: {payé} - {prix} = {result} crédits."
2026-02-20T22:09:17.3216973Z +            )
2026-02-20T22:09:17.3217077Z +
2026-02-20T22:09:17.3217228Z          elif problem_type == "vitesse":
2026-02-20T22:09:17.3217639Z -            distance = random.randint(type_limits.get("min", 10), type_limits.get("max", 100))
2026-02-20T22:09:17.3217786Z +            distance = random.randint(
2026-02-20T22:09:17.3218030Z +                type_limits.get("min", 10), type_limits.get("max", 100)
2026-02-20T22:09:17.3218147Z +            )
2026-02-20T22:09:17.3218305Z              temps = random.randint(2, 10)
2026-02-20T22:09:17.3218452Z              result = distance // temps
2026-02-20T22:09:17.3218558Z -            
2026-02-20T22:09:17.3218956Z -            question_template = random.choice([
2026-02-20T22:09:17.3219446Z -                f"Le Faucon Millenium parcourt {distance} parsecs en {temps} heures. Quelle est sa vitesse?",
2026-02-20T22:09:17.3219858Z -                f"Un X-wing vole {distance} km en {temps} minutes. Quelle est sa vitesse par minute?",
2026-02-20T22:09:17.3220690Z -                f"Un Star Destroyer voyage {distance} années-lumière en {temps} jours. Vitesse par jour?"
2026-02-20T22:09:17.3220807Z -            ])
2026-02-20T22:09:17.3221391Z -            explanation_template = f"Vitesse = distance ÷ temps: {distance} ÷ {temps} = {result}."
2026-02-20T22:09:17.3221503Z -            
2026-02-20T22:09:17.3221607Z +
2026-02-20T22:09:17.3221777Z +            question_template = random.choice(
2026-02-20T22:09:17.3221896Z +                [
2026-02-20T22:09:17.3222390Z +                    f"Le Faucon Millenium parcourt {distance} parsecs en {temps} heures. Quelle est sa vitesse?",
2026-02-20T22:09:17.3222823Z +                    f"Un X-wing vole {distance} km en {temps} minutes. Quelle est sa vitesse par minute?",
2026-02-20T22:09:17.3223655Z +                    f"Un Star Destroyer voyage {distance} années-lumière en {temps} jours. Vitesse par jour?",
2026-02-20T22:09:17.3223774Z +                ]
2026-02-20T22:09:17.3223881Z +            )
2026-02-20T22:09:17.3224055Z +            explanation_template = (
2026-02-20T22:09:17.3224473Z +                f"Vitesse = distance ÷ temps: {distance} ÷ {temps} = {result}."
2026-02-20T22:09:17.3224583Z +            )
2026-02-20T22:09:17.3224687Z +
2026-02-20T22:09:17.3225047Z          elif problem_type == "pourcentage" or problem_type == "pourcentage_simple":
2026-02-20T22:09:17.3225433Z -            initial = random.randint(type_limits.get("min", 20), type_limits.get("max", 100))
2026-02-20T22:09:17.3225584Z +            initial = random.randint(
2026-02-20T22:09:17.3225841Z +                type_limits.get("min", 20), type_limits.get("max", 100)
2026-02-20T22:09:17.3225967Z +            )
2026-02-20T22:09:17.3226169Z              pourcentage = random.choice([10, 20, 25, 50])
2026-02-20T22:09:17.3226400Z              result = initial + (initial * pourcentage // 100)
2026-02-20T22:09:17.3226509Z -            
2026-02-20T22:09:17.3226683Z -            question_template = random.choice([
2026-02-20T22:09:17.3227155Z -                f"L'Empire a {initial} vaisseaux. Leur nombre augmente de {pourcentage}%. Nouveau total?",
2026-02-20T22:09:17.3227818Z -                f"La Rébellion a {initial} soldats. Ils recrutent {pourcentage}% de plus. Combien maintenant?",
2026-02-20T22:09:17.3228394Z -                f"Jabba possède {initial} crédits. Il gagne {pourcentage}% de plus. Nouveau montant?"
2026-02-20T22:09:17.3228506Z -            ])
2026-02-20T22:09:17.3229126Z -            explanation_template = f"Augmentation: {initial} + ({initial} × {pourcentage}%) = {result}."
2026-02-20T22:09:17.3229236Z -            
2026-02-20T22:09:17.3229338Z +
2026-02-20T22:09:17.3229530Z +            question_template = random.choice(
2026-02-20T22:09:17.3229641Z +                [
2026-02-20T22:09:17.3230110Z +                    f"L'Empire a {initial} vaisseaux. Leur nombre augmente de {pourcentage}%. Nouveau total?",
2026-02-20T22:09:17.3230770Z +                    f"La Rébellion a {initial} soldats. Ils recrutent {pourcentage}% de plus. Combien maintenant?",
2026-02-20T22:09:17.3231356Z +                    f"Jabba possède {initial} crédits. Il gagne {pourcentage}% de plus. Nouveau montant?",
2026-02-20T22:09:17.3231468Z +                ]
2026-02-20T22:09:17.3231574Z +            )
2026-02-20T22:09:17.3231732Z +            explanation_template = (
2026-02-20T22:09:17.3232188Z +                f"Augmentation: {initial} + ({initial} × {pourcentage}%) = {result}."
2026-02-20T22:09:17.3232299Z +            )
2026-02-20T22:09:17.3232409Z +
2026-02-20T22:09:17.3232655Z          elif problem_type == "probabilité":
2026-02-20T22:09:17.3232805Z              total = random.randint(10, 30)
2026-02-20T22:09:17.3233398Z              favorables = random.randint(1, total // 3)
2026-02-20T22:09:17.3233559Z              result = f"{favorables}/{total}"
2026-02-20T22:09:17.3233664Z -            
2026-02-20T22:09:17.3233830Z -            question_template = random.choice([
2026-02-20T22:09:17.3234498Z -                f"Dans un sac, {total} cristaux dont {favorables} sont bleus. Probabilité d'un cristal bleu?",
2026-02-20T22:09:17.3235378Z -                f"Sur {total} planètes, {favorables} sont habitées. Probabilité qu'une planète soit habitée?",
2026-02-20T22:09:17.3236018Z -                f"Parmi {total} droïdes, {favorables} sont défaillants. Probabilité d'un droïde défaillant?"
2026-02-20T22:09:17.3236140Z -            ])
2026-02-20T22:09:17.3236246Z +
2026-02-20T22:09:17.3236417Z +            question_template = random.choice(
2026-02-20T22:09:17.3236527Z +                [
2026-02-20T22:09:17.3237171Z +                    f"Dans un sac, {total} cristaux dont {favorables} sont bleus. Probabilité d'un cristal bleu?",
2026-02-20T22:09:17.3237852Z +                    f"Sur {total} planètes, {favorables} sont habitées. Probabilité qu'une planète soit habitée?",
2026-02-20T22:09:17.3238522Z +                    f"Parmi {total} droïdes, {favorables} sont défaillants. Probabilité d'un droïde défaillant?",
2026-02-20T22:09:17.3238637Z +                ]
2026-02-20T22:09:17.3238766Z +            )
2026-02-20T22:09:17.3239440Z              explanation_template = f"Probabilité = cas favorables ÷ total: {favorables} ÷ {total} = {result}."
2026-02-20T22:09:17.3239555Z -            
2026-02-20T22:09:17.3239657Z +
2026-02-20T22:09:17.3239898Z          elif problem_type == "séquence":
2026-02-20T22:09:17.3240062Z              start = random.randint(2, 8)
2026-02-20T22:09:17.3240208Z              diff = random.randint(2, 5)
2026-02-20T22:09:17.3240413Z -            sequence = [start + diff*i for i in range(4)]
2026-02-20T22:09:17.3240618Z +            sequence = [start + diff * i for i in range(4)]
2026-02-20T22:09:17.3240795Z              result = sequence[-1] + diff
2026-02-20T22:09:17.3240901Z -            
2026-02-20T22:09:17.3241007Z +
2026-02-20T22:09:17.3241681Z              question_template = f"Séquence Jedi: {', '.join(map(str, sequence))}, ... Quel est le terme suivant?"
2026-02-20T22:09:17.3242302Z -            explanation_template = f"La séquence augmente de {diff}: {sequence[-1]} + {diff} = {result}."
2026-02-20T22:09:17.3242423Z -            
2026-02-20T22:09:17.3242584Z +            explanation_template = (
2026-02-20T22:09:17.3243360Z +                f"La séquence augmente de {diff}: {sequence[-1]} + {diff} = {result}."
2026-02-20T22:09:17.3243490Z +            )
2026-02-20T22:09:17.3243600Z +
2026-02-20T22:09:17.3243832Z          else:  # logique_avancée
2026-02-20T22:09:17.3244054Z              a, b = random.randint(5, 15), random.randint(2, 8)
2026-02-20T22:09:17.3244183Z              result = a * b
2026-02-20T22:09:17.3244305Z -            
2026-02-20T22:09:17.3244477Z -            question_template = random.choice([
2026-02-20T22:09:17.3245100Z -                f"Yoda dit: 'Si {a} Padawans s'entraînent {b} heures chacun, combien d'heures au total?'",
2026-02-20T22:09:17.3245636Z -                f"L'Empire déploie {a} escadrons de {b} TIE Fighters. Combien de TIE Fighters?",
2026-02-20T22:09:17.3246139Z -                f"Dans {a} systèmes, il y a {b} planètes chacun. Combien de planètes au total?"
2026-02-20T22:09:17.3246264Z -            ])
2026-02-20T22:09:17.3246371Z +
2026-02-20T22:09:17.3246549Z +            question_template = random.choice(
2026-02-20T22:09:17.3246662Z +                [
2026-02-20T22:09:17.3247269Z +                    f"Yoda dit: 'Si {a} Padawans s'entraînent {b} heures chacun, combien d'heures au total?'",
2026-02-20T22:09:17.3247824Z +                    f"L'Empire déploie {a} escadrons de {b} TIE Fighters. Combien de TIE Fighters?",
2026-02-20T22:09:17.3248331Z +                    f"Dans {a} systèmes, il y a {b} planètes chacun. Combien de planètes au total?",
2026-02-20T22:09:17.3248703Z +                ]
2026-02-20T22:09:17.3248817Z +            )
2026-02-20T22:09:17.3249149Z              explanation_template = f"Total = {a} × {b} = {result}."
2026-02-20T22:09:17.3249257Z -        
2026-02-20T22:09:17.3249355Z +
2026-02-20T22:09:17.3249652Z          # Choix appropriés selon le type de résultat
2026-02-20T22:09:17.3250045Z          if isinstance(result, str) and "/" in result:
2026-02-20T22:09:17.3250313Z              # Pour les fractions (probabilités)
2026-02-20T22:09:17.3250501Z              num, denom = map(int, result.split("/"))
2026-02-20T22:09:17.3250812Z              choices = [result, f"{num+1}/{denom}", f"{num}/{denom+1}", f"{denom}/{num}"]
2026-02-20T22:09:17.3250937Z @@ -603,619 +726,749 @@
2026-02-20T22:09:17.3251076Z              # Pour les entiers
2026-02-20T22:09:17.3251194Z              choices = [
2026-02-20T22:09:17.3251321Z                  str(result),
2026-02-20T22:09:17.3251492Z                  str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3251717Z                  str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3251849Z -                str(result * 2)
2026-02-20T22:09:17.3251978Z +                str(result * 2),
2026-02-20T22:09:17.3252090Z              ]
2026-02-20T22:09:17.3252230Z          random.shuffle(choices)
2026-02-20T22:09:17.3252336Z -        
2026-02-20T22:09:17.3252492Z -        exercise_data.update({
2026-02-20T22:09:17.3253599Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Défis Galactiques - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3253776Z -            "question": question_template,
2026-02-20T22:09:17.3253932Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3254075Z -            "choices": choices,
2026-02-20T22:09:17.3254691Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.3254805Z -        })
2026-02-20T22:09:17.3254917Z +
2026-02-20T22:09:17.3255069Z +        exercise_data.update(
2026-02-20T22:09:17.3255174Z +            {
2026-02-20T22:09:17.3256089Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Défis Galactiques - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3256272Z +                "question": question_template,
2026-02-20T22:09:17.3256437Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3256570Z +                "choices": choices,
2026-02-20T22:09:17.3257199Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.3257314Z +            }
2026-02-20T22:09:17.3257427Z +        )
2026-02-20T22:09:17.3257632Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3257828Z      elif normalized_type == ExerciseTypes.MIXTE:
2026-02-20T22:09:17.3258359Z          # Génération IA d'un exercice mixte avec PLUSIEURS opérations et thème Star Wars
2026-02-20T22:09:17.3258543Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3258707Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3258818Z -        
2026-02-20T22:09:17.3258922Z +
2026-02-20T22:09:17.3259436Z          # Choisir un pattern de calcul mixte selon la difficulté avec contexte Star Wars
2026-02-20T22:09:17.3259675Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3259965Z              # Pour les débutants: 2 opérations simples
2026-02-20T22:09:17.3260145Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3260289Z              b = random.randint(2, 6)
2026-02-20T22:09:17.3260430Z              c = random.randint(1, 4)
2026-02-20T22:09:17.3260546Z -            
2026-02-20T22:09:17.3260652Z +
2026-02-20T22:09:17.3260782Z              patterns = [
2026-02-20T22:09:17.3260963Z -                (lambda: a + b - c, f"{a} + {b} - {c}",
2026-02-20T22:09:17.3261511Z -                 f"Luke a trouvé {a} cristaux, puis {b} de plus, mais il en a donné {c} à Leia.",
2026-02-20T22:09:17.3262242Z -                 f"On calcule étape par étape: {a} + {b} = {a+b}, puis {a+b} - {c} = {a+b-c}."),
2026-02-20T22:09:17.3262513Z -                (lambda: a * b + c, f"{a} × {b} + {c}",
2026-02-20T22:09:17.3263251Z -                 f"Chaque Padawan a {b} sabres et il y a {a} Padawans, plus {c} sabres de réserve.",
2026-02-20T22:09:17.3264071Z -                 f"D'abord la multiplication: {a} × {b} = {a*b}, puis on ajoute {c}: {a*b} + {c} = {a*b+c}."),
2026-02-20T22:09:17.3264189Z +                (
2026-02-20T22:09:17.3264338Z +                    lambda: a + b - c,
2026-02-20T22:09:17.3264473Z +                    f"{a} + {b} - {c}",
2026-02-20T22:09:17.3265016Z +                    f"Luke a trouvé {a} cristaux, puis {b} de plus, mais il en a donné {c} à Leia.",
2026-02-20T22:09:17.3265521Z +                    f"On calcule étape par étape: {a} + {b} = {a+b}, puis {a+b} - {c} = {a+b-c}.",
2026-02-20T22:09:17.3265645Z +                ),
2026-02-20T22:09:17.3265770Z +                (
2026-02-20T22:09:17.3265898Z +                    lambda: a * b + c,
2026-02-20T22:09:17.3266107Z +                    f"{a} × {b} + {c}",
2026-02-20T22:09:17.3266647Z +                    f"Chaque Padawan a {b} sabres et il y a {a} Padawans, plus {c} sabres de réserve.",
2026-02-20T22:09:17.3267231Z +                    f"D'abord la multiplication: {a} × {b} = {a*b}, puis on ajoute {c}: {a*b} + {c} = {a*b+c}.",
2026-02-20T22:09:17.3267366Z +                ),
2026-02-20T22:09:17.3267470Z              ]
2026-02-20T22:09:17.3267720Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3268008Z              # Intermédiaire: priorité des opérations
2026-02-20T22:09:17.3268181Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3268325Z              b = random.randint(2, 8)
2026-02-20T22:09:17.3268462Z              c = random.randint(2, 6)
2026-02-20T22:09:17.3268569Z -            
2026-02-20T22:09:17.3268669Z +
2026-02-20T22:09:17.3268807Z              patterns = [
2026-02-20T22:09:17.3269080Z -                (lambda: a + b * c, f"{a} + {b} × {c}",
2026-02-20T22:09:17.3269440Z -                 f"L'Alliance a {a} vaisseaux, plus {b} escadrons de {c} chasseurs chacun.",
2026-02-20T22:09:17.3269989Z -                 f"Attention à la priorité! D'abord {b} × {c} = {b*c}, puis {a} + {b*c} = {a + b*c}."),
2026-02-20T22:09:17.3270273Z -                (lambda: a * b - c, f"{a} × {b} - {c}",
2026-02-20T22:09:17.3270757Z -                 f"L'Empire a {a} bataillons de {b} stormtroopers, mais {c} ont déserté.",
2026-02-20T22:09:17.3271237Z -                 f"D'abord {a} × {b} = {a*b}, puis on soustrait {c}: {a*b} - {c} = {a*b - c}."),
2026-02-20T22:09:17.3271353Z +                (
2026-02-20T22:09:17.3271496Z +                    lambda: a + b * c,
2026-02-20T22:09:17.3271706Z +                    f"{a} + {b} × {c}",
2026-02-20T22:09:17.3272068Z +                    f"L'Alliance a {a} vaisseaux, plus {b} escadrons de {c} chasseurs chacun.",
2026-02-20T22:09:17.3272636Z +                    f"Attention à la priorité! D'abord {b} × {c} = {b*c}, puis {a} + {b*c} = {a + b*c}.",
2026-02-20T22:09:17.3272751Z +                ),
2026-02-20T22:09:17.3272860Z +                (
2026-02-20T22:09:17.3273173Z +                    lambda: a * b - c,
2026-02-20T22:09:17.3273388Z +                    f"{a} × {b} - {c}",
2026-02-20T22:09:17.3273848Z +                    f"L'Empire a {a} bataillons de {b} stormtroopers, mais {c} ont déserté.",
2026-02-20T22:09:17.3274231Z +                    f"D'abord {a} × {b} = {a*b}, puis on soustrait {c}: {a*b} - {c} = {a*b - c}.",
2026-02-20T22:09:17.3274328Z +                ),
2026-02-20T22:09:17.3274419Z              ]
2026-02-20T22:09:17.3274505Z          else:
2026-02-20T22:09:17.3274762Z              # Avancé: parenthèses et opérations complexes
2026-02-20T22:09:17.3274903Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3275016Z              b = random.randint(2, 8)
2026-02-20T22:09:17.3275340Z              c = random.randint(2, 6)
2026-02-20T22:09:17.3275446Z -            
2026-02-20T22:09:17.3275534Z +
2026-02-20T22:09:17.3275835Z              # S'assurer que a > b pour éviter les résultats négatifs
2026-02-20T22:09:17.3275940Z              if a <= b:
2026-02-20T22:09:17.3276040Z                  a, b = b + 2, a
2026-02-20T22:09:17.3276287Z -            
2026-02-20T22:09:17.3276382Z +
2026-02-20T22:09:17.3276490Z              patterns = [
2026-02-20T22:09:17.3276731Z -                (lambda: (a + b) * c, f"({a} + {b}) × {c}",
2026-02-20T22:09:17.3277174Z -                 f"Luke et Leia ont ensemble {a} + {b} cristaux, chaque cristal vaut {c} crédits.",
2026-02-20T22:09:17.3277566Z -                 f"D'abord les parenthèses: ({a} + {b}) = {a+b}, puis × {c} = {(a+b)*c}."),
2026-02-20T22:09:17.3277823Z -                (lambda: (a - b) * c, f"({a} - {b}) × {c}",
2026-02-20T22:09:17.3278415Z -                 f"L'Empire avait {a} vaisseaux, {b} ont été détruits, les {a-b} restants ont {c} équipages chacun.",
2026-02-20T22:09:17.3278731Z -                 f"D'abord ({a} - {b}) = {a-b}, puis × {c} = {(a-b)*c}."),
2026-02-20T22:09:17.3278960Z -                (lambda: a * (b + c), f"{a} × ({b} + {c})",
2026-02-20T22:09:17.3279309Z -                 f"Chaque base rebelle ({a} bases) a {b} + {c} défenseurs.",
2026-02-20T22:09:17.3279659Z -                 f"D'abord ({b} + {c}) = {b+c}, puis {a} × {b+c} = {a*(b+c)}."),
2026-02-20T22:09:17.3279759Z -            ]
2026-02-20T22:09:17.3279853Z -        
2026-02-20T22:09:17.3280016Z +                (
2026-02-20T22:09:17.3280147Z +                    lambda: (a + b) * c,
2026-02-20T22:09:17.3280340Z +                    f"({a} + {b}) × {c}",
2026-02-20T22:09:17.3280789Z +                    f"Luke et Leia ont ensemble {a} + {b} cristaux, chaque cristal vaut {c} crédits.",
2026-02-20T22:09:17.3281161Z +                    f"D'abord les parenthèses: ({a} + {b}) = {a+b}, puis × {c} = {(a+b)*c}.",
2026-02-20T22:09:17.3281248Z +                ),
2026-02-20T22:09:17.3281344Z +                (
2026-02-20T22:09:17.3281456Z +                    lambda: (a - b) * c,
2026-02-20T22:09:17.3281645Z +                    f"({a} - {b}) × {c}",
2026-02-20T22:09:17.3282279Z +                    f"L'Empire avait {a} vaisseaux, {b} ont été détruits, les {a-b} restants ont {c} équipages chacun.",
2026-02-20T22:09:17.3282663Z +                    f"D'abord ({a} - {b}) = {a-b}, puis × {c} = {(a-b)*c}.",
2026-02-20T22:09:17.3282777Z +                ),
2026-02-20T22:09:17.3282889Z +                (
2026-02-20T22:09:17.3283203Z +                    lambda: a * (b + c),
2026-02-20T22:09:17.3283432Z +                    f"{a} × ({b} + {c})",
2026-02-20T22:09:17.3283831Z +                    f"Chaque base rebelle ({a} bases) a {b} + {c} défenseurs.",
2026-02-20T22:09:17.3284202Z +                    f"D'abord ({b} + {c}) = {b+c}, puis {a} × {b+c} = {a*(b+c)}.",
2026-02-20T22:09:17.3284323Z +                ),
2026-02-20T22:09:17.3284429Z +            ]
2026-02-20T22:09:17.3284550Z +
2026-02-20T22:09:17.3284837Z          calc_func, formula, context, explain = random.choice(patterns)
2026-02-20T22:09:17.3284979Z          result = calc_func()
2026-02-20T22:09:17.3285084Z -        
2026-02-20T22:09:17.3285184Z +
2026-02-20T22:09:17.3285518Z          question_template = f"{context} Combien au total? (Calcul: {formula})"
2026-02-20T22:09:17.3285683Z          explanation_template = explain
2026-02-20T22:09:17.3285787Z -        
2026-02-20T22:09:17.3285893Z +
2026-02-20T22:09:17.3286167Z          # Générer des choix avec erreurs typiques
2026-02-20T22:09:17.3286284Z          choices = [
2026-02-20T22:09:17.3286406Z              str(result),
2026-02-20T22:09:17.3286574Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3286767Z              str(max(1, result - random.randint(1, 5))),
2026-02-20T22:09:17.3286982Z -            str(a + b + c)  # Erreur courante: additionner tout
2026-02-20T22:09:17.3287203Z +            str(a + b + c),  # Erreur courante: additionner tout
2026-02-20T22:09:17.3287580Z          ]
2026-02-20T22:09:17.3287729Z          choices = list(set(choices))
2026-02-20T22:09:17.3287864Z          while len(choices) < 4:
2026-02-20T22:09:17.3288118Z              choices.append(str(result + random.randint(-10, 10)))
2026-02-20T22:09:17.3288267Z          choices = list(set(choices))[:4]
2026-02-20T22:09:17.3288567Z          random.shuffle(choices)
2026-02-20T22:09:17.3288679Z -        
2026-02-20T22:09:17.3288816Z -        exercise_data.update({
2026-02-20T22:09:17.3289498Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Opération Mixte Galactique (Niveau: {derived_difficulty})",
2026-02-20T22:09:17.3289671Z -            "question": question_template,
2026-02-20T22:09:17.3289823Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3289956Z -            "choices": choices,
2026-02-20T22:09:17.3290080Z -            "formula": formula,
2026-02-20T22:09:17.3290696Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.3290821Z -        })
2026-02-20T22:09:17.3291029Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.3291143Z +
2026-02-20T22:09:17.3291278Z +        exercise_data.update(
2026-02-20T22:09:17.3291382Z +            {
2026-02-20T22:09:17.3292084Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Opération Mixte Galactique (Niveau: {derived_difficulty})",
2026-02-20T22:09:17.3292268Z +                "question": question_template,
2026-02-20T22:09:17.3292421Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3292557Z +                "choices": choices,
2026-02-20T22:09:17.3292694Z +                "formula": formula,
2026-02-20T22:09:17.3293496Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.3293615Z +            }
2026-02-20T22:09:17.3293733Z +        )
2026-02-20T22:09:17.3293917Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3294135Z      elif normalized_type == ExerciseTypes.TEXTE:
2026-02-20T22:09:17.3294546Z          # Génération IA d'exercices textuels avec thème Star Wars
2026-02-20T22:09:17.3294658Z -        
2026-02-20T22:09:17.3294765Z +
2026-02-20T22:09:17.3295111Z          # Générer des nombres aléatoirement selon la difficulté
2026-02-20T22:09:17.3295507Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3295862Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3296021Z              base_num = random.randint(3, 8)
2026-02-20T22:09:17.3296183Z              modifier = random.randint(2, 5)
2026-02-20T22:09:17.3296343Z              large_num = random.randint(10, 20)
2026-02-20T22:09:17.3296723Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3297091Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3297264Z              base_num = random.randint(5, 12)
2026-02-20T22:09:17.3297417Z              modifier = random.randint(3, 7)
2026-02-20T22:09:17.3297565Z              large_num = random.randint(15, 30)
2026-02-20T22:09:17.3297961Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3298365Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3298520Z              base_num = random.randint(8, 15)
2026-02-20T22:09:17.3298678Z              modifier = random.randint(4, 9)
2026-02-20T22:09:17.3298833Z              large_num = random.randint(20, 50)
2026-02-20T22:09:17.3298956Z          else:  # MAITRE
2026-02-20T22:09:17.3299120Z              base_num = random.randint(10, 25)
2026-02-20T22:09:17.3299273Z              modifier = random.randint(5, 12)
2026-02-20T22:09:17.3299431Z              large_num = random.randint(30, 100)
2026-02-20T22:09:17.3299769Z -        
2026-02-20T22:09:17.3299883Z +
2026-02-20T22:09:17.3300228Z          # Choisir un type de problème selon la difficulté
2026-02-20T22:09:17.3300594Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3301016Z -            problem_types = ["simple_addition", "simple_subtraction", "simple_multiplication"]
2026-02-20T22:09:17.3301594Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3301948Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3302090Z +            problem_types = [
2026-02-20T22:09:17.3302224Z +                "simple_addition",
2026-02-20T22:09:17.3302364Z +                "simple_subtraction",
2026-02-20T22:09:17.3302516Z +                "simple_multiplication",
2026-02-20T22:09:17.3302630Z +            ]
2026-02-20T22:09:17.3303182Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3303449Z              problem_types = ["two_step", "sequence", "comparison"]
2026-02-20T22:09:17.3303846Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3304239Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3304495Z              problem_types = ["multi_step", "ratio", "logic_puzzle"]
2026-02-20T22:09:17.3304625Z          else:  # MAITRE
2026-02-20T22:09:17.3304939Z              problem_types = ["complex_multi_step", "algebraic", "advanced_logic"]
2026-02-20T22:09:17.3305046Z -        
2026-02-20T22:09:17.3305150Z +
2026-02-20T22:09:17.3305354Z          problem_type = random.choice(problem_types)
2026-02-20T22:09:17.3305460Z -        
2026-02-20T22:09:17.3305559Z +
2026-02-20T22:09:17.3305834Z          # Générer le problème selon le type
2026-02-20T22:09:17.3305999Z          if problem_type == "simple_addition":
2026-02-20T22:09:17.3306151Z              result = base_num + modifier
2026-02-20T22:09:17.3306340Z -            question_template = random.choice([
2026-02-20T22:09:17.3307103Z -                f"R2-D2 a {base_num} droïdes amis. C-3PO en a {modifier} de plus que R2-D2. Combien C-3PO a-t-il d'amis droïdes?",
2026-02-20T22:09:17.3307687Z -                f"Luke a {base_num} sabres laser. Il en trouve {modifier} autres dans un temple Jedi. Combien en a-t-il maintenant?",
2026-02-20T22:09:17.3308352Z -                f"Dans la cantina, il y a {base_num} contrebandiers et {modifier} pilotes rebelles arrivent. Combien de personnes au total?"
2026-02-20T22:09:17.3308476Z -            ])
2026-02-20T22:09:17.3308584Z -            
2026-02-20T22:09:17.3308752Z +            question_template = random.choice(
2026-02-20T22:09:17.3308871Z +                [
2026-02-20T22:09:17.3309641Z +                    f"R2-D2 a {base_num} droïdes amis. C-3PO en a {modifier} de plus que R2-D2. Combien C-3PO a-t-il d'amis droïdes?",
2026-02-20T22:09:17.3310250Z +                    f"Luke a {base_num} sabres laser. Il en trouve {modifier} autres dans un temple Jedi. Combien en a-t-il maintenant?",
2026-02-20T22:09:17.3310943Z +                    f"Dans la cantina, il y a {base_num} contrebandiers et {modifier} pilotes rebelles arrivent. Combien de personnes au total?",
2026-02-20T22:09:17.3311059Z +                ]
2026-02-20T22:09:17.3311175Z +            )
2026-02-20T22:09:17.3311286Z +
2026-02-20T22:09:17.3311468Z          elif problem_type == "simple_subtraction":
2026-02-20T22:09:17.3311625Z              result = large_num - base_num
2026-02-20T22:09:17.3311792Z -            question_template = random.choice([
2026-02-20T22:09:17.3312515Z -                f"Luke avait {large_num} sabres laser. Il en donne {base_num} à ses Padawans. Combien lui en reste-t-il?",
2026-02-20T22:09:17.3313449Z -                f"L'Empire avait {large_num} TIE Fighters. {base_num} ont été détruits par la Rébellion. Combien en reste-t-il?",
2026-02-20T22:09:17.3314261Z -                f"Yoda possédait {large_num} cristaux Kyber. Il en utilise {base_num} pour l'entraînement. Combien lui reste-t-il?"
2026-02-20T22:09:17.3314600Z -            ])
2026-02-20T22:09:17.3314706Z -            
2026-02-20T22:09:17.3314878Z +            question_template = random.choice(
2026-02-20T22:09:17.3314994Z +                [
2026-02-20T22:09:17.3315726Z +                    f"Luke avait {large_num} sabres laser. Il en donne {base_num} à ses Padawans. Combien lui en reste-t-il?",
2026-02-20T22:09:17.3316710Z +                    f"L'Empire avait {large_num} TIE Fighters. {base_num} ont été détruits par la Rébellion. Combien en reste-t-il?",
2026-02-20T22:09:17.3317528Z +                    f"Yoda possédait {large_num} cristaux Kyber. Il en utilise {base_num} pour l'entraînement. Combien lui reste-t-il?",
2026-02-20T22:09:17.3317642Z +                ]
2026-02-20T22:09:17.3317748Z +            )
2026-02-20T22:09:17.3317860Z +
2026-02-20T22:09:17.3318059Z          elif problem_type == "simple_multiplication":
2026-02-20T22:09:17.3318225Z              result = base_num * modifier
2026-02-20T22:09:17.3318417Z -            question_template = random.choice([
2026-02-20T22:09:17.3319235Z -                f"Dans la cantina, il y a {base_num} tables. Chaque table peut accueillir {modifier} personnes. Combien de personnes peuvent s'asseoir au total?",
2026-02-20T22:09:17.3319666Z -                f"Chaque X-wing a {modifier} missiles. Combien de missiles ont {base_num} X-wings?",
2026-02-20T22:09:17.3320370Z -                f"Chaque Padawan s'entraîne {modifier} heures par jour. Combien d'heures pour {base_num} Padawans?"
2026-02-20T22:09:17.3320492Z -            ])
2026-02-20T22:09:17.3320599Z -            
2026-02-20T22:09:17.3320761Z +            question_template = random.choice(
2026-02-20T22:09:17.3320878Z +                [
2026-02-20T22:09:17.3321680Z +                    f"Dans la cantina, il y a {base_num} tables. Chaque table peut accueillir {modifier} personnes. Combien de personnes peuvent s'asseoir au total?",
2026-02-20T22:09:17.3322125Z +                    f"Chaque X-wing a {modifier} missiles. Combien de missiles ont {base_num} X-wings?",
2026-02-20T22:09:17.3322848Z +                    f"Chaque Padawan s'entraîne {modifier} heures par jour. Combien d'heures pour {base_num} Padawans?",
2026-02-20T22:09:17.3323124Z +                ]
2026-02-20T22:09:17.3323252Z +            )
2026-02-20T22:09:17.3323359Z +
2026-02-20T22:09:17.3323528Z          elif problem_type == "two_step":
2026-02-20T22:09:17.3323681Z              step1_result = base_num * modifier
2026-02-20T22:09:17.3323838Z              result = step1_result - base_num
2026-02-20T22:09:17.3324013Z -            question_template = random.choice([
2026-02-20T22:09:17.3324794Z -                f"Leia a {base_num} crédits. Elle achète {modifier} blasters à {base_num} crédits chacun. Combien lui reste-t-il?",
2026-02-20T22:09:17.3325671Z -                f"Un X-wing consomme {modifier} unités de carburant par parsec. Pour un voyage de {base_num} parsecs, combien d'unités faut-il?",
2026-02-20T22:09:17.3326163Z -                f"Obi-Wan a {base_num} Padawans. Chacun a {modifier} sabres laser. Combien de sabres au total?"
2026-02-20T22:09:17.3326271Z -            ])
2026-02-20T22:09:17.3326436Z +            question_template = random.choice(
2026-02-20T22:09:17.3326552Z +                [
2026-02-20T22:09:17.3327330Z +                    f"Leia a {base_num} crédits. Elle achète {modifier} blasters à {base_num} crédits chacun. Combien lui reste-t-il?",
2026-02-20T22:09:17.3328208Z +                    f"Un X-wing consomme {modifier} unités de carburant par parsec. Pour un voyage de {base_num} parsecs, combien d'unités faut-il?",
2026-02-20T22:09:17.3328685Z +                    f"Obi-Wan a {base_num} Padawans. Chacun a {modifier} sabres laser. Combien de sabres au total?",
2026-02-20T22:09:17.3328798Z +                ]
2026-02-20T22:09:17.3328902Z +            )
2026-02-20T22:09:17.3329071Z              if "reste-t-il" in question_template:
2026-02-20T22:09:17.3329749Z -                result = base_num - step1_result if base_num > step1_result else step1_result - base_num
2026-02-20T22:09:17.3329889Z +                result = (
2026-02-20T22:09:17.3330042Z +                    base_num - step1_result
2026-02-20T22:09:17.3330206Z +                    if base_num > step1_result
2026-02-20T22:09:17.3330372Z +                    else step1_result - base_num
2026-02-20T22:09:17.3330714Z +                )
2026-02-20T22:09:17.3330837Z              else:
2026-02-20T22:09:17.3331003Z                  result = step1_result
2026-02-20T22:09:17.3331116Z -                
2026-02-20T22:09:17.3331230Z +
2026-02-20T22:09:17.3331404Z          elif problem_type == "sequence":
2026-02-20T22:09:17.3331671Z              # Séquence arithmétique
2026-02-20T22:09:17.3331808Z              start = base_num
2026-02-20T22:09:17.3331948Z              step = modifier
2026-02-20T22:09:17.3332246Z              result = start + (3 * step)  # 4ème terme
2026-02-20T22:09:17.3332579Z              sequence = f"{start}, {start + step}, {start + 2*step}, {start + 3*step}"
2026-02-20T22:09:17.3332783Z -            question_template = random.choice([
2026-02-20T22:09:17.3334007Z -                f"Yoda entraîne ses Padawans en séquence: {start}, {start + step}, {start + 2*step}... Quel est le prochain nombre dans cette séquence de la Force?",
2026-02-20T22:09:17.3335008Z -                f"Les coordonnées galactiques suivent cette séquence: {start}, {start + step}, {start + 2*step}... Quelle est la prochaine coordonnée?",
2026-02-20T22:09:17.3335704Z would reformat /home/runner/work/mathakine/mathakine/server/exercise_generator.py
2026-02-20T22:09:17.3336466Z -                f"Le code d'accès Jedi suit ce motif: {start}, {start + step}, {start + 2*step}... Quel est le nombre suivant?"
2026-02-20T22:09:17.3336594Z -            ])
2026-02-20T22:09:17.3336703Z -            
2026-02-20T22:09:17.3336891Z +            question_template = random.choice(
2026-02-20T22:09:17.3337005Z +                [
2026-02-20T22:09:17.3338040Z +                    f"Yoda entraîne ses Padawans en séquence: {start}, {start + step}, {start + 2*step}... Quel est le prochain nombre dans cette séquence de la Force?",
2026-02-20T22:09:17.3339022Z +                    f"Les coordonnées galactiques suivent cette séquence: {start}, {start + step}, {start + 2*step}... Quelle est la prochaine coordonnée?",
2026-02-20T22:09:17.3339797Z +                    f"Le code d'accès Jedi suit ce motif: {start}, {start + step}, {start + 2*step}... Quel est le nombre suivant?",
2026-02-20T22:09:17.3339923Z +                ]
2026-02-20T22:09:17.3340045Z +            )
2026-02-20T22:09:17.3340156Z +
2026-02-20T22:09:17.3340327Z          elif problem_type == "comparison":
2026-02-20T22:09:17.3340506Z              multiplier = random.randint(2, 4)
2026-02-20T22:09:17.3340668Z              result = base_num * multiplier
2026-02-20T22:09:17.3340845Z -            question_template = random.choice([
2026-02-20T22:09:17.3341808Z -                f"Dans une bataille, l'Alliance a {multiplier} fois plus de X-wings que l'Empire a de TIE Fighters. Si l'Empire a {base_num} TIE Fighters, combien l'Alliance a-t-elle de X-wings?",
2026-02-20T22:09:17.3342709Z -                f"Un destroyer stellaire transporte {multiplier} fois plus de soldats qu'une corvette. Si une corvette a {base_num} soldats, combien le destroyer en a-t-il?",
2026-02-20T22:09:17.3343697Z -                f"Jabba a {multiplier} fois plus de crédits que Han Solo. Si Han a {base_num} crédits, combien Jabba en a-t-il?"
2026-02-20T22:09:17.3343828Z -            ])
2026-02-20T22:09:17.3343950Z -            
2026-02-20T22:09:17.3344124Z +            question_template = random.choice(
2026-02-20T22:09:17.3344238Z +                [
2026-02-20T22:09:17.3345232Z +                    f"Dans une bataille, l'Alliance a {multiplier} fois plus de X-wings que l'Empire a de TIE Fighters. Si l'Empire a {base_num} TIE Fighters, combien l'Alliance a-t-elle de X-wings?",
2026-02-20T22:09:17.3346130Z +                    f"Un destroyer stellaire transporte {multiplier} fois plus de soldats qu'une corvette. Si une corvette a {base_num} soldats, combien le destroyer en a-t-il?",
2026-02-20T22:09:17.3347216Z +                    f"Jabba a {multiplier} fois plus de crédits que Han Solo. Si Han a {base_num} crédits, combien Jabba en a-t-il?",
2026-02-20T22:09:17.3347356Z +                ]
2026-02-20T22:09:17.3347698Z +            )
2026-02-20T22:09:17.3347810Z +
2026-02-20T22:09:17.3348191Z          else:  # Types plus complexes pour niveaux élevés
2026-02-20T22:09:17.3348351Z              result = base_num + modifier
2026-02-20T22:09:17.3349335Z              question_template = f"Problème Jedi complexe: La somme de deux nombres consécutifs est {result + result - 1}. Quel est le plus petit nombre?"
2026-02-20T22:09:17.3349692Z              result = base_num  # Pour les problèmes algébriques
2026-02-20T22:09:17.3349815Z -        
2026-02-20T22:09:17.3349922Z +
2026-02-20T22:09:17.3350208Z          # Générer des choix incorrects plausibles
2026-02-20T22:09:17.3350367Z          choices = [
2026-02-20T22:09:17.3350498Z              str(result),
2026-02-20T22:09:17.3350670Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3350873Z              str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3351095Z -            str(result * 2) if result < 50 else str(result // 2)
2026-02-20T22:09:17.3351342Z +            str(result * 2) if result < 50 else str(result // 2),
2026-02-20T22:09:17.3351453Z          ]
2026-02-20T22:09:17.3351606Z          random.shuffle(choices)
2026-02-20T22:09:17.3351713Z -        
2026-02-20T22:09:17.3351855Z -        exercise_data.update({
2026-02-20T22:09:17.3352710Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Énigme Jedi - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3352874Z -            "question": question_template,
2026-02-20T22:09:17.3353218Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3353364Z -            "choices": choices,
2026-02-20T22:09:17.3354782Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour résoudre ce problème, il faut analyser les données et appliquer les bonnes opérations mathématiques. {explanation_suffix}"
2026-02-20T22:09:17.3354905Z -        })
2026-02-20T22:09:17.3355032Z +
2026-02-20T22:09:17.3355261Z +        exercise_data.update(
2026-02-20T22:09:17.3355368Z +            {
2026-02-20T22:09:17.3356236Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Énigme Jedi - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3356420Z +                "question": question_template,
2026-02-20T22:09:17.3356575Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3356707Z +                "choices": choices,
2026-02-20T22:09:17.3358110Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour résoudre ce problème, il faut analyser les données et appliquer les bonnes opérations mathématiques. {explanation_suffix}",
2026-02-20T22:09:17.3358478Z +            }
2026-02-20T22:09:17.3358587Z +        )
2026-02-20T22:09:17.3358771Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3359252Z      # Si aucun type correspondant, retourner un exercice d'addition par défaut
2026-02-20T22:09:17.3359410Z      min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3359577Z      max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3359746Z      num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3359903Z      num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3360027Z      result = num1 + num2
2026-02-20T22:09:17.3360138Z -    
2026-02-20T22:09:17.3360276Z -    exercise_data.update({
2026-02-20T22:09:17.3360455Z -        "title": ExerciseMessages.TITLE_DEFAULT,
2026-02-20T22:09:17.3360833Z -        "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3360990Z -        "correct_answer": str(result),
2026-02-20T22:09:17.3361293Z -        "choices": [str(result), str(result-1), str(result+1), str(result+2)],
2026-02-20T22:09:17.3361418Z -        "num1": num1,
2026-02-20T22:09:17.3361538Z -        "num2": num2,
2026-02-20T22:09:17.3362100Z -        "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3362417Z -    })
2026-02-20T22:09:17.3362526Z -    
2026-02-20T22:09:17.3362706Z -    return _apply_test_title(exercise_data) 
2026-02-20T22:09:17.3362810Z +
2026-02-20T22:09:17.3362945Z +    exercise_data.update(
2026-02-20T22:09:17.3363241Z +        {
2026-02-20T22:09:17.3363433Z +            "title": ExerciseMessages.TITLE_DEFAULT,
2026-02-20T22:09:17.3363824Z +            "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3363982Z +            "correct_answer": str(result),
2026-02-20T22:09:17.3364320Z +            "choices": [str(result), str(result - 1), str(result + 1), str(result + 2)],
2026-02-20T22:09:17.3364454Z +            "num1": num1,
2026-02-20T22:09:17.3364578Z +            "num2": num2,
2026-02-20T22:09:17.3365139Z +            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3365251Z +        }
2026-02-20T22:09:17.3365357Z +    )
2026-02-20T22:09:17.3365476Z +
2026-02-20T22:09:17.3365647Z +    return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3365751Z +
2026-02-20T22:09:17.3365859Z  
2026-02-20T22:09:17.3366029Z  def ensure_explanation(exercise_dict):
2026-02-20T22:09:17.3366250Z      """S'assure qu'un exercice a une explication valide"""
2026-02-20T22:09:17.3366631Z      # S'assurer que l'explication est définie et n'est pas None
2026-02-20T22:09:17.3367475Z -    if 'explanation' not in exercise_dict or exercise_dict['explanation'] is None or exercise_dict['explanation'] == "None" or exercise_dict['explanation'] == "":
2026-02-20T22:09:17.3367761Z -        if exercise_dict['exercise_type'] == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3368718Z -            exercise_dict['explanation'] = f"Pour additionner {exercise_dict.get('num1', '?')} et {exercise_dict.get('num2', '?')}, il faut calculer leur somme: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3369043Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3370289Z -            exercise_dict['explanation'] = f"Pour soustraire {exercise_dict.get('num2', '?')} de {exercise_dict.get('num1', '?')}, il faut calculer leur différence: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3370627Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3371595Z -            exercise_dict['explanation'] = f"Pour multiplier {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur produit: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3371896Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3373212Z -            exercise_dict['explanation'] = f"Pour diviser {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur quotient: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3373371Z +    if (
2026-02-20T22:09:17.3373536Z +        "explanation" not in exercise_dict
2026-02-20T22:09:17.3373730Z +        or exercise_dict["explanation"] is None
2026-02-20T22:09:17.3373919Z +        or exercise_dict["explanation"] == "None"
2026-02-20T22:09:17.3374084Z +        or exercise_dict["explanation"] == ""
2026-02-20T22:09:17.3374191Z +    ):
2026-02-20T22:09:17.3374474Z +        if exercise_dict["exercise_type"] == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3374633Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3375382Z +                f"Pour additionner {exercise_dict.get('num1', '?')} et {exercise_dict.get('num2', '?')}, il faut calculer leur somme: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3375506Z +            )
2026-02-20T22:09:17.3375822Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3375980Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3377012Z +                f"Pour soustraire {exercise_dict.get('num2', '?')} de {exercise_dict.get('num1', '?')}, il faut calculer leur différence: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3377342Z +            )
2026-02-20T22:09:17.3377679Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3377846Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3378629Z +                f"Pour multiplier {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur produit: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3378740Z +            )
2026-02-20T22:09:17.3379029Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3379196Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3380033Z +                f"Pour diviser {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur quotient: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3380150Z +            )
2026-02-20T22:09:17.3380269Z          else:
2026-02-20T22:09:17.3380902Z -            exercise_dict['explanation'] = f"La réponse correcte est {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3381037Z -    
2026-02-20T22:09:17.3381173Z -    return exercise_dict 
2026-02-20T22:09:17.3381338Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3381738Z +                f"La réponse correcte est {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3381847Z +            )
2026-02-20T22:09:17.3381957Z +
2026-02-20T22:09:17.3382087Z +    return exercise_dict
2026-02-20T22:09:17.3382194Z +
2026-02-20T22:09:17.3382304Z  
2026-02-20T22:09:17.3382533Z  def generate_simple_exercise(exercise_type, age_group):
2026-02-20T22:09:17.3382780Z      """Génère un exercice simple sans IA"""
2026-02-20T22:09:17.3382900Z -    
2026-02-20T22:09:17.3383210Z +
2026-02-20T22:09:17.3383470Z      normalized_type = normalize_exercise_type(exercise_type)
2026-02-20T22:09:17.3383707Z      normalized_age_group = normalize_age_group(age_group)
2026-02-20T22:09:17.3384054Z      derived_difficulty = get_difficulty_from_age_group(normalized_age_group)
2026-02-20T22:09:17.3384179Z -    
2026-02-20T22:09:17.3384282Z +
2026-02-20T22:09:17.3384781Z      # Récupérer les limites pour ce type d'exercice et cette difficulté dérivée
2026-02-20T22:09:17.3385367Z -    difficulty_config = DIFFICULTY_LIMITS.get(derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN])
2026-02-20T22:09:17.3385935Z -    type_limits = difficulty_config.get(normalized_type, difficulty_config.get("default", {"min": 1, "max": 10}))
2026-02-20T22:09:17.3386054Z -    
2026-02-20T22:09:17.3386255Z +    difficulty_config = DIFFICULTY_LIMITS.get(
2026-02-20T22:09:17.3386576Z +        derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]
2026-02-20T22:09:17.3386984Z +    )
2026-02-20T22:09:17.3387172Z +    type_limits = difficulty_config.get(
2026-02-20T22:09:17.3387523Z +        normalized_type, difficulty_config.get("default", {"min": 1, "max": 10})
2026-02-20T22:09:17.3387639Z +    )
2026-02-20T22:09:17.3387744Z +
2026-02-20T22:09:17.3388022Z      # Structure de base commune pour tous les types d'exercices
2026-02-20T22:09:17.3388180Z      exercise_data = {
2026-02-20T22:09:17.3388338Z          "exercise_type": normalized_type,
2026-02-20T22:09:17.3388506Z          "age_group": normalized_age_group,
2026-02-20T22:09:17.3388662Z          "difficulty": derived_difficulty,
2026-02-20T22:09:17.3388796Z          "ai_generated": False,
2026-02-20T22:09:17.3388939Z -        "tags": Tags.ALGORITHMIC
2026-02-20T22:09:17.3389086Z +        "tags": Tags.ALGORITHMIC,
2026-02-20T22:09:17.3389197Z      }
2026-02-20T22:09:17.3389304Z -    
2026-02-20T22:09:17.3389418Z +
2026-02-20T22:09:17.3389629Z      if normalized_type == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3389916Z          # Génération d'une addition
2026-02-20T22:09:17.3390249Z          min_val, max_val = type_limits.get("min", 1), type_limits.get("max", 10)
2026-02-20T22:09:17.3390619Z          num1, num2 = random.randint(min_val, max_val), random.randint(min_val, max_val)
2026-02-20T22:09:17.3390971Z -        
2026-02-20T22:09:17.3391081Z +
2026-02-20T22:09:17.3391229Z          result = num1 + num2
2026-02-20T22:09:17.3391614Z          question = ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3391769Z          correct_answer = str(result)
2026-02-20T22:09:17.3391891Z -        
2026-02-20T22:09:17.3392000Z +
2026-02-20T22:09:17.3392449Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3393295Z -        error_margin = max(1, min(int(max_val * 0.1), 10))  # Marge d'erreur proportionnelle à la difficulté
2026-02-20T22:09:17.3393430Z -        
2026-02-20T22:09:17.3393571Z +        error_margin = max(
2026-02-20T22:09:17.3393740Z +            1, min(int(max_val * 0.1), 10)
2026-02-20T22:09:17.3394111Z +        )  # Marge d'erreur proportionnelle à la difficulté
2026-02-20T22:09:17.3394229Z +
2026-02-20T22:09:17.3394357Z          choices = [
2026-02-20T22:09:17.3394615Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3394847Z              str(result + random.randint(1, error_margin)),
2026-02-20T22:09:17.3395059Z              str(result - random.randint(1, error_margin)),
2026-02-20T22:09:17.3395569Z -            str(num1 * num2) if num1 * num2 != result else str(result + error_margin + 1)  # Distraction: multiplication
2026-02-20T22:09:17.3395693Z +            (
2026-02-20T22:09:17.3395824Z +                str(num1 * num2)
2026-02-20T22:09:17.3395960Z +                if num1 * num2 != result
2026-02-20T22:09:17.3396145Z +                else str(result + error_margin + 1)
2026-02-20T22:09:17.3396311Z +            ),  # Distraction: multiplication
2026-02-20T22:09:17.3396435Z          ]
2026-02-20T22:09:17.3396589Z          random.shuffle(choices)
2026-02-20T22:09:17.3396695Z  
2026-02-20T22:09:17.3396839Z -        exercise_data.update({
2026-02-20T22:09:17.3397043Z -            "title": ExerciseMessages.TITLE_ADDITION,
2026-02-20T22:09:17.3397194Z -            "question": question,
2026-02-20T22:09:17.3397361Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3397510Z -            "choices": choices,
2026-02-20T22:09:17.3397718Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3397840Z -            "num1": num1,
2026-02-20T22:09:17.3397962Z -            "num2": num2,
2026-02-20T22:09:17.3398529Z -            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3398650Z -        })
2026-02-20T22:09:17.3398790Z +        exercise_data.update(
2026-02-20T22:09:17.3398899Z +            {
2026-02-20T22:09:17.3399106Z +                "title": ExerciseMessages.TITLE_ADDITION,
2026-02-20T22:09:17.3399548Z +                "question": question,
2026-02-20T22:09:17.3399722Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3399863Z +                "choices": choices,
2026-02-20T22:09:17.3400068Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3400205Z +                "num1": num1,
2026-02-20T22:09:17.3400326Z +                "num2": num2,
2026-02-20T22:09:17.3400924Z +                "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3401042Z +            }
2026-02-20T22:09:17.3401152Z +        )
2026-02-20T22:09:17.3401341Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3401451Z  
2026-02-20T22:09:17.3401683Z      elif normalized_type == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3401972Z          # Génération d'une soustraction
2026-02-20T22:09:17.3402117Z          limits = type_limits
2026-02-20T22:09:17.3402451Z          num1 = random.randint(limits.get("min1", 5), limits.get("max1", 20))
2026-02-20T22:09:17.3402944Z -        num2 = random.randint(limits.get("min2", 1), min(num1-1, limits.get("max2", 5)))  # Assurer num2 < num1
2026-02-20T22:09:17.3403277Z -        
2026-02-20T22:09:17.3403422Z +        num2 = random.randint(
2026-02-20T22:09:17.3403937Z +            limits.get("min2", 1), min(num1 - 1, limits.get("max2", 5))
2026-02-20T22:09:17.3404088Z +        )  # Assurer num2 < num1
2026-02-20T22:09:17.3404191Z +
2026-02-20T22:09:17.3404314Z          result = num1 - num2
2026-02-20T22:09:17.3404711Z          question = ExerciseMessages.QUESTION_SUBTRACTION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3404873Z          correct_answer = str(result)
2026-02-20T22:09:17.3404984Z -        
2026-02-20T22:09:17.3405089Z +
2026-02-20T22:09:17.3405553Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3405840Z          error_margin = max(1, min(int(limits.get("max2", 5) * 0.2), 10))
2026-02-20T22:09:17.3405972Z -        
2026-02-20T22:09:17.3406084Z +
2026-02-20T22:09:17.3406208Z          choices = [
2026-02-20T22:09:17.3406462Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3406682Z              str(result + random.randint(1, error_margin)),
2026-02-20T22:09:17.3407091Z -            str(result - random.randint(1, min(error_margin, result-1) if result > 1 else 1)),
2026-02-20T22:09:17.3407527Z -            str(num2 - num1) if num2 > num1 else str(result + error_margin + 2)  # Erreur: inversion de l'ordre
2026-02-20T22:09:17.3407634Z +            str(
2026-02-20T22:09:17.3407755Z +                result
2026-02-20T22:09:17.3408062Z +                - random.randint(1, min(error_margin, result - 1) if result > 1 else 1)
2026-02-20T22:09:17.3408171Z +            ),
2026-02-20T22:09:17.3408279Z +            (
2026-02-20T22:09:17.3408560Z +                str(num2 - num1) if num2 > num1 else str(result + error_margin + 2)
2026-02-20T22:09:17.3408748Z +            ),  # Erreur: inversion de l'ordre
2026-02-20T22:09:17.3408868Z          ]
2026-02-20T22:09:17.3409021Z          random.shuffle(choices)
2026-02-20T22:09:17.3409133Z  
2026-02-20T22:09:17.3409278Z -        exercise_data.update({
2026-02-20T22:09:17.3409501Z -            "title": ExerciseMessages.TITLE_SUBTRACTION,
2026-02-20T22:09:17.3409651Z -            "question": question,
2026-02-20T22:09:17.3409810Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3409945Z -            "choices": choices,
2026-02-20T22:09:17.3410148Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3410276Z -            "num1": num1,
2026-02-20T22:09:17.3410397Z -            "num2": num2,
2026-02-20T22:09:17.3411262Z -            "explanation": f"Pour soustraire {num2} de {num1}, il faut calculer leur différence, donc {num1} - {num2} = {result}."
2026-02-20T22:09:17.3411382Z -        })
2026-02-20T22:09:17.3411540Z +        exercise_data.update(
2026-02-20T22:09:17.3411931Z +            {
2026-02-20T22:09:17.3412153Z +                "title": ExerciseMessages.TITLE_SUBTRACTION,
2026-02-20T22:09:17.3412298Z +                "question": question,
2026-02-20T22:09:17.3412476Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3412620Z +                "choices": choices,
2026-02-20T22:09:17.3412841Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3413179Z +                "num1": num1,
2026-02-20T22:09:17.3413326Z +                "num2": num2,
2026-02-20T22:09:17.3414171Z +                "explanation": f"Pour soustraire {num2} de {num1}, il faut calculer leur différence, donc {num1} - {num2} = {result}.",
2026-02-20T22:09:17.3414287Z +            }
2026-02-20T22:09:17.3414406Z +        )
2026-02-20T22:09:17.3414581Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3414686Z  
2026-02-20T22:09:17.3414933Z      elif normalized_type == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3415194Z          # Génération d'une multiplication
2026-02-20T22:09:17.3415520Z          min_val, max_val = type_limits.get("min", 1), type_limits.get("max", 10)
2026-02-20T22:09:17.3415887Z          num1, num2 = random.randint(min_val, max_val), random.randint(min_val, max_val)
2026-02-20T22:09:17.3416016Z -        
2026-02-20T22:09:17.3416120Z +
2026-02-20T22:09:17.3416519Z          result = num1 * num2
2026-02-20T22:09:17.3416945Z          question = ExerciseMessages.QUESTION_MULTIPLICATION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3417105Z          correct_answer = str(result)
2026-02-20T22:09:17.3417212Z -        
2026-02-20T22:09:17.3417315Z +
2026-02-20T22:09:17.3417744Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3417862Z          choices = [
2026-02-20T22:09:17.3418086Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3418294Z              str(result + num1),  # Erreur: une fois de trop
2026-02-20T22:09:17.3418505Z              str(result - num2),  # Erreur: une fois de moins
2026-02-20T22:09:17.3418789Z -            str(num1 + num2)  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.3419063Z +            str(num1 + num2),  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.3419178Z          ]
2026-02-20T22:09:17.3419322Z          random.shuffle(choices)
2026-02-20T22:09:17.3419441Z  
2026-02-20T22:09:17.3419586Z -        exercise_data.update({
2026-02-20T22:09:17.3419802Z -            "title": ExerciseMessages.TITLE_MULTIPLICATION,
2026-02-20T22:09:17.3419934Z -            "question": question,
2026-02-20T22:09:17.3420101Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3420229Z -            "choices": choices,
2026-02-20T22:09:17.3420425Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3420550Z -            "num1": num1,
2026-02-20T22:09:17.3420678Z -            "num2": num2,
2026-02-20T22:09:17.3421462Z -            "explanation": f"Pour multiplier {num1} par {num2}, il faut calculer leur produit, donc {num1} × {num2} = {result}."
2026-02-20T22:09:17.3421586Z -        })
2026-02-20T22:09:17.3421734Z +        exercise_data.update(
2026-02-20T22:09:17.3421838Z +            {
2026-02-20T22:09:17.3422066Z +                "title": ExerciseMessages.TITLE_MULTIPLICATION,
2026-02-20T22:09:17.3422204Z +                "question": question,
2026-02-20T22:09:17.3422386Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3422518Z +                "choices": choices,
2026-02-20T22:09:17.3422715Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3422843Z +                "num1": num1,
2026-02-20T22:09:17.3423141Z +                "num2": num2,
2026-02-20T22:09:17.3423946Z +                "explanation": f"Pour multiplier {num1} par {num2}, il faut calculer leur produit, donc {num1} × {num2} = {result}.",
2026-02-20T22:09:17.3424069Z +            }
2026-02-20T22:09:17.3424177Z +        )
2026-02-20T22:09:17.3424354Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3424669Z  
2026-02-20T22:09:17.3424893Z      elif normalized_type == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3425128Z          # Génération d'une division
2026-02-20T22:09:17.3425265Z          limits = type_limits
2026-02-20T22:09:17.3425454Z          min_divisor = limits.get("min_divisor", 2)
2026-02-20T22:09:17.3425648Z          max_divisor = limits.get("max_divisor", 5)
2026-02-20T22:09:17.3425816Z          min_result = limits.get("min_result", 1)
2026-02-20T22:09:17.3425990Z          max_result = limits.get("max_result", 5)
2026-02-20T22:09:17.3426102Z -        
2026-02-20T22:09:17.3426205Z +
2026-02-20T22:09:17.3426693Z          # Générer d'abord le diviseur et le résultat pour assurer une division exacte
2026-02-20T22:09:17.3426965Z          num2 = random.randint(min_divisor, max_divisor)  # diviseur
2026-02-20T22:09:17.3427222Z          result = random.randint(min_result, max_result)  # quotient
2026-02-20T22:09:17.3427369Z          num1 = num2 * result  # dividende
2026-02-20T22:09:17.3427493Z  
2026-02-20T22:09:17.3427862Z          question = ExerciseMessages.QUESTION_DIVISION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3428010Z          correct_answer = str(result)
2026-02-20T22:09:17.3428125Z -        
2026-02-20T22:09:17.3428231Z +
2026-02-20T22:09:17.3428635Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3428980Z          choices = [
2026-02-20T22:09:17.3429231Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3429381Z              str(result + 1),  # Une de plus
2026-02-20T22:09:17.3429605Z              str(max(1, result - 1)),  # Une de moins (minimum 1)
2026-02-20T22:09:17.3430164Z -            str(num1 // (num2 + 1)) if num2 < 9 else str(result + 2)  # Diviseur légèrement différent
2026-02-20T22:09:17.3430280Z +            (
2026-02-20T22:09:17.3430513Z +                str(num1 // (num2 + 1)) if num2 < 9 else str(result + 2)
2026-02-20T22:09:17.3430768Z +            ),  # Diviseur légèrement différent
2026-02-20T22:09:17.3430899Z          ]
2026-02-20T22:09:17.3431037Z          random.shuffle(choices)
2026-02-20T22:09:17.3431139Z  
2026-02-20T22:09:17.3431287Z -        exercise_data.update({
2026-02-20T22:09:17.3431480Z -            "title": ExerciseMessages.TITLE_DIVISION,
2026-02-20T22:09:17.3431613Z -            "question": question,
2026-02-20T22:09:17.3431795Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3431923Z -            "choices": choices,
2026-02-20T22:09:17.3432116Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3432241Z -            "num1": num1,
2026-02-20T22:09:17.3432363Z -            "num2": num2,
2026-02-20T22:09:17.3433319Z -            "explanation": f"Pour diviser {num1} par {num2}, il faut calculer leur quotient, donc {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.3433439Z -        })
2026-02-20T22:09:17.3433586Z +        exercise_data.update(
2026-02-20T22:09:17.3433695Z +            {
2026-02-20T22:09:17.3433910Z +                "title": ExerciseMessages.TITLE_DIVISION,
2026-02-20T22:09:17.3434047Z +                "question": question,
2026-02-20T22:09:17.3434220Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3434351Z +                "choices": choices,
2026-02-20T22:09:17.3434547Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3434694Z +                "num1": num1,
2026-02-20T22:09:17.3434818Z +                "num2": num2,
2026-02-20T22:09:17.3435597Z +                "explanation": f"Pour diviser {num1} par {num2}, il faut calculer leur quotient, donc {num1} ÷ {num2} = {result}.",
2026-02-20T22:09:17.3435720Z +            }
2026-02-20T22:09:17.3435826Z +        )
2026-02-20T22:09:17.3435999Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3436102Z -    
2026-02-20T22:09:17.3436211Z +
2026-02-20T22:09:17.3436404Z      elif normalized_type == ExerciseTypes.TEXTE:
2026-02-20T22:09:17.3436853Z          # Génération d'un exercice textuel (problèmes logiques, énigmes, etc.)
2026-02-20T22:09:17.3437225Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3437383Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3437491Z -        
2026-02-20T22:09:17.3437601Z +
2026-02-20T22:09:17.3438211Z          # Choisir un type de problème textuel en fonction du groupe d'âge (via la difficulté dérivée)
2026-02-20T22:09:17.3438451Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3438743Z              # Problèmes textuels simples pour débutants
2026-02-20T22:09:17.3439214Z -            problem_type = random.choice(["logique_simple", "devinette_nombre", "probleme_concret"])
2026-02-20T22:09:17.3439369Z +            problem_type = random.choice(
2026-02-20T22:09:17.3439630Z +                ["logique_simple", "devinette_nombre", "probleme_concret"]
2026-02-20T22:09:17.3439746Z +            )
2026-02-20T22:09:17.3439994Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3440573Z -            problem_type = random.choice(["logique_simple", "devinette_nombre", "probleme_concret", "sequence_simple"])
2026-02-20T22:09:17.3440740Z +            problem_type = random.choice(
2026-02-20T22:09:17.3440849Z +                [
2026-02-20T22:09:17.3440984Z +                    "logique_simple",
2026-02-20T22:09:17.3441329Z +                    "devinette_nombre",
2026-02-20T22:09:17.3441481Z +                    "probleme_concret",
2026-02-20T22:09:17.3441620Z +                    "sequence_simple",
2026-02-20T22:09:17.3441726Z +                ]
2026-02-20T22:09:17.3441844Z +            )
2026-02-20T22:09:17.3442093Z          elif derived_difficulty == DifficultyLevels.CHEVALIER:
2026-02-20T22:09:17.3442603Z -            problem_type = random.choice(["logique_avance", "enigme_math", "probleme_etapes", "sequence_avance"])
2026-02-20T22:09:17.3442770Z +            problem_type = random.choice(
2026-02-20T22:09:17.3443263Z +                ["logique_avance", "enigme_math", "probleme_etapes", "sequence_avance"]
2026-02-20T22:09:17.3443395Z +            )
2026-02-20T22:09:17.3443522Z          else:  # MAITRE
2026-02-20T22:09:17.3444093Z -            problem_type = random.choice(["logique_complexe", "enigme_complexe", "probleme_multi_etapes", "code_secret"])
2026-02-20T22:09:17.3444207Z -        
2026-02-20T22:09:17.3444359Z +            problem_type = random.choice(
2026-02-20T22:09:17.3444488Z +                [
2026-02-20T22:09:17.3444628Z +                    "logique_complexe",
2026-02-20T22:09:17.3444767Z +                    "enigme_complexe",
2026-02-20T22:09:17.3444932Z +                    "probleme_multi_etapes",
2026-02-20T22:09:17.3445062Z +                    "code_secret",
2026-02-20T22:09:17.3445176Z +                ]
2026-02-20T22:09:17.3445287Z +            )
2026-02-20T22:09:17.3445401Z +
2026-02-20T22:09:17.3445755Z          # Logique pour chaque type de problème textuel
2026-02-20T22:09:17.3445930Z          if problem_type == "logique_simple":
2026-02-20T22:09:17.3446180Z              # Problème logique simple
2026-02-20T22:09:17.3446327Z -            objets = random.choice([
2026-02-20T22:09:17.3446465Z -                ("sabres laser", "Luke"),
2026-02-20T22:09:17.3446685Z -                ("droïdes", "R2-D2"),
2026-02-20T22:09:17.3446848Z -                ("vaisseaux", "l'Alliance"),
2026-02-20T22:09:17.3446998Z -                ("cristaux", "Yoda")
2026-02-20T22:09:17.3447110Z -            ])
2026-02-20T22:09:17.3447257Z +            objets = random.choice(
2026-02-20T22:09:17.3447363Z +                [
2026-02-20T22:09:17.3447518Z +                    ("sabres laser", "Luke"),
2026-02-20T22:09:17.3447754Z +                    ("droïdes", "R2-D2"),
2026-02-20T22:09:17.3447925Z +                    ("vaisseaux", "l'Alliance"),
2026-02-20T22:09:17.3448060Z +                    ("cristaux", "Yoda"),
2026-02-20T22:09:17.3448170Z +                ]
2026-02-20T22:09:17.3448290Z +            )
2026-02-20T22:09:17.3448437Z              objet, personnage = objets
2026-02-20T22:09:17.3448795Z -            
2026-02-20T22:09:17.3448915Z +
2026-02-20T22:09:17.3449115Z              initial = random.randint(min_val, max_val)
2026-02-20T22:09:17.3449410Z -            donnés = random.randint(1, initial-1)
2026-02-20T22:09:17.3449695Z +            donnés = random.randint(1, initial - 1)
2026-02-20T22:09:17.3449925Z              result = initial - donnés
2026-02-20T22:09:17.3450053Z -            
2026-02-20T22:09:17.3450157Z +
2026-02-20T22:09:17.3450867Z              problem = f"{personnage} a {initial} {objet}. Il en donne {donnés} à ses amis. Combien lui en reste-t-il ?"
2026-02-20T22:09:17.3451767Z              explanation = f"Pour trouver ce qui reste, on soustrait ce qui a été donné du total initial. Donc {initial} - {donnés} = {result}."
2026-02-20T22:09:17.3451920Z              answer_type = "number"
2026-02-20T22:09:17.3452038Z -            
2026-02-20T22:09:17.3452149Z +
2026-02-20T22:09:17.3452337Z          elif problem_type == "devinette_nombre":
2026-02-20T22:09:17.3452505Z              # Devinette sur un nombre
2026-02-20T22:09:17.3452750Z              if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3452896Z                  # Devinette simple
2026-02-20T22:09:17.3453271Z                  nombre = random.randint(1, 10)
2026-02-20T22:09:17.3453427Z                  indices = []
2026-02-20T22:09:17.3453829Z                  if nombre % 2 == 0:
2026-02-20T22:09:17.3453997Z                      indices.append("pair")
2026-02-20T22:09:17.3454119Z                  else:
2026-02-20T22:09:17.3454290Z                      indices.append("impair")
2026-02-20T22:09:17.3454402Z -                
2026-02-20T22:09:17.3454509Z +
2026-02-20T22:09:17.3454647Z                  if nombre < 5:
2026-02-20T22:09:17.3454833Z                      indices.append("plus petit que 5")
2026-02-20T22:09:17.3454954Z                  else:
2026-02-20T22:09:17.3455132Z                      indices.append("plus grand que 4")
2026-02-20T22:09:17.3455248Z -                
2026-02-20T22:09:17.3455362Z +
2026-02-20T22:09:17.3456094Z                  problem = f"Je pense à un nombre entre 1 et 10. Il est {indices[0]} et {indices[1]}. Quel est ce nombre ?"
2026-02-20T22:09:17.3456561Z                  explanation = f"En cherchant un nombre {indices[0]} et {indices[1]}, on trouve {nombre}."
2026-02-20T22:09:17.3456706Z                  result = nombre
2026-02-20T22:09:17.3456834Z              else:
2026-02-20T22:09:17.3456996Z                  # Devinette plus complexe
2026-02-20T22:09:17.3457162Z                  nombre = random.randint(10, 50)
2026-02-20T22:09:17.3457439Z                  operation = random.choice(["addition", "multiplication"])
2026-02-20T22:09:17.3457558Z -                
2026-02-20T22:09:17.3457662Z +
2026-02-20T22:09:17.3457822Z                  if operation == "addition":
2026-02-20T22:09:17.3457988Z                      ajout = random.randint(5, 15)
2026-02-20T22:09:17.3458161Z                      resultat_op = nombre + ajout
2026-02-20T22:09:17.3458862Z                      problem = f"Je pense à un nombre. Si j'ajoute {ajout}, j'obtiens {resultat_op}. Quel est mon nombre ?"
2026-02-20T22:09:17.3459524Z                      explanation = f"Pour trouver le nombre, on soustrait {ajout} de {resultat_op}. Donc {resultat_op} - {ajout} = {nombre}."
2026-02-20T22:09:17.3459662Z                  else:
2026-02-20T22:09:17.3459842Z                      facteur = random.randint(2, 5)
2026-02-20T22:09:17.3460006Z                      resultat_op = nombre * facteur
2026-02-20T22:09:17.3460792Z                      problem = f"Je pense à un nombre. Si je le multiplie par {facteur}, j'obtiens {resultat_op}. Quel est mon nombre ?"
2026-02-20T22:09:17.3461650Z                      explanation = f"Pour trouver le nombre, on divise {resultat_op} par {facteur}. Donc {resultat_op} ÷ {facteur} = {nombre}."
2026-02-20T22:09:17.3461772Z -                
2026-02-20T22:09:17.3461887Z +
2026-02-20T22:09:17.3462022Z                  result = nombre
2026-02-20T22:09:17.3462160Z              answer_type = "number"
2026-02-20T22:09:17.3462522Z -            
2026-02-20T22:09:17.3462637Z +
2026-02-20T22:09:17.3462838Z          elif problem_type == "probleme_concret":
2026-02-20T22:09:17.3463359Z              # Problème concret avec contexte Star Wars
2026-02-20T22:09:17.3463504Z              scenarios = [
2026-02-20T22:09:17.3463617Z                  {
2026-02-20T22:09:17.3463834Z                      "context": "Dans la cantina de Mos Eisley",
2026-02-20T22:09:17.3464299Z                      "action": "Luke commande {nb1} boissons à {prix} crédits chacune",
2026-02-20T22:09:17.3464525Z                      "question": "Combien paie-t-il au total ?",
2026-02-20T22:09:17.3464709Z                      "calc": lambda nb1, prix: nb1 * prix,
2026-02-20T22:09:17.3465619Z -                    "explanation": "Pour calculer le total, on multiplie le nombre de boissons par le prix unitaire. Donc {nb1} × {prix} = {result}."
2026-02-20T22:09:17.3466553Z +                    "explanation": "Pour calculer le total, on multiplie le nombre de boissons par le prix unitaire. Donc {nb1} × {prix} = {result}.",
2026-02-20T22:09:17.3466697Z                  },
2026-02-20T22:09:17.3466811Z                  {
2026-02-20T22:09:17.3467140Z                      "context": "Sur la planète Tatooine",
2026-02-20T22:09:17.3467645Z                      "action": "Anakin trouve {nb1} pièces. Il en perd {nb2} dans le désert",
2026-02-20T22:09:17.3468111Z                      "question": "Combien lui en reste-t-il ?",
2026-02-20T22:09:17.3468314Z                      "calc": lambda nb1, nb2: nb1 - nb2,
2026-02-20T22:09:17.3468970Z -                    "explanation": "Pour trouver ce qui reste, on soustrait ce qui est perdu du total initial. Donc {nb1} - {nb2} = {result}."
2026-02-20T22:09:17.3469622Z +                    "explanation": "Pour trouver ce qui reste, on soustrait ce qui est perdu du total initial. Donc {nb1} - {nb2} = {result}.",
2026-02-20T22:09:17.3469758Z                  },
2026-02-20T22:09:17.3469869Z                  {
2026-02-20T22:09:17.3470089Z                      "context": "Dans l'escadron de X-Wings",
2026-02-20T22:09:17.3470651Z                      "action": "Il y a {nb1} pilotes répartis équitablement dans {nb2} escouades",
2026-02-20T22:09:17.3470901Z                      "question": "Combien de pilotes par escouade ?",
2026-02-20T22:09:17.3471084Z                      "calc": lambda nb1, nb2: nb1 // nb2,
2026-02-20T22:09:17.3472028Z -                    "explanation": "Pour répartir équitablement, on divise le nombre total par le nombre d'escouades. Donc {nb1} ÷ {nb2} = {result}."
2026-02-20T22:09:17.3472164Z -                }
2026-02-20T22:09:17.3472274Z -            ]
2026-02-20T22:09:17.3472382Z -            
2026-02-20T22:09:17.3473515Z +                    "explanation": "Pour répartir équitablement, on divise le nombre total par le nombre d'escouades. Donc {nb1} ÷ {nb2} = {result}.",
2026-02-20T22:09:17.3473649Z +                },
2026-02-20T22:09:17.3473756Z +            ]
2026-02-20T22:09:17.3473864Z +
2026-02-20T22:09:17.3474072Z              scenario = random.choice(scenarios)
2026-02-20T22:09:17.3474252Z              nb1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3474774Z -            nb2 = random.randint(2, min(nb1, 5)) if "divise" in scenario["explanation"] else random.randint(1, min_val)
2026-02-20T22:09:17.3474896Z -            
2026-02-20T22:09:17.3475026Z +            nb2 = (
2026-02-20T22:09:17.3475187Z +                random.randint(2, min(nb1, 5))
2026-02-20T22:09:17.3475375Z +                if "divise" in scenario["explanation"]
2026-02-20T22:09:17.3475535Z +                else random.randint(1, min_val)
2026-02-20T22:09:17.3475640Z +            )
2026-02-20T22:09:17.3475744Z +
2026-02-20T22:09:17.3476097Z              # Ajuster pour éviter les divisions impossibles
2026-02-20T22:09:17.3476535Z              if "÷" in scenario["explanation"] and nb1 % nb2 != 0:
2026-02-20T22:09:17.3476833Z                  nb1 = nb2 * random.randint(2, 5)  # Assurer une division exacte
2026-02-20T22:09:17.3477177Z -            
2026-02-20T22:09:17.3477283Z +
2026-02-20T22:09:17.3477450Z              result = scenario["calc"](nb1, nb2)
2026-02-20T22:09:17.3477555Z -            
2026-02-20T22:09:17.3477662Z +
2026-02-20T22:09:17.3478237Z              problem = f"{scenario['context']}, {scenario['action'].format(nb1=nb1, nb2=nb2, prix=nb2)}. {scenario['question']}"
2026-02-20T22:09:17.3478692Z -            explanation = scenario["explanation"].format(nb1=nb1, nb2=nb2, prix=nb2, result=result)
2026-02-20T22:09:17.3478911Z +            explanation = scenario["explanation"].format(
2026-02-20T22:09:17.3479099Z +                nb1=nb1, nb2=nb2, prix=nb2, result=result
2026-02-20T22:09:17.3479210Z +            )
2026-02-20T22:09:17.3479435Z              answer_type = "number"
2026-02-20T22:09:17.3479545Z -            
2026-02-20T22:09:17.3479647Z +
2026-02-20T22:09:17.3479818Z          elif problem_type == "sequence_simple":
2026-02-20T22:09:17.3480052Z              # Séquence simple
2026-02-20T22:09:17.3480211Z              start = random.randint(1, 5)
2026-02-20T22:09:17.3480357Z              step = random.randint(1, 3)
2026-02-20T22:09:17.3480566Z -            sequence = [start + step*i for i in range(4)]
2026-02-20T22:09:17.3480773Z +            sequence = [start + step * i for i in range(4)]
2026-02-20T22:09:17.3480921Z              result = sequence[-1] + step
2026-02-20T22:09:17.3481237Z -            
2026-02-20T22:09:17.3481341Z +
2026-02-20T22:09:17.3481865Z              problem = f"Quelle est la suite logique : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ... ?"
2026-02-20T22:09:17.3482732Z              explanation = f"Cette séquence augmente de {step} à chaque terme. Le terme suivant est donc {sequence[3]} + {step} = {result}."
2026-02-20T22:09:17.3482885Z              answer_type = "number"
2026-02-20T22:09:17.3483170Z -            
2026-02-20T22:09:17.3483280Z +
2026-02-20T22:09:17.3483400Z          else:
2026-02-20T22:09:17.3483777Z              # Problème par défaut pour les types non implémentés
2026-02-20T22:09:17.3483964Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3484132Z              b = random.randint(min_val, max_val)
2026-02-20T22:09:17.3484262Z              result = a + b
2026-02-20T22:09:17.3484368Z -            
2026-02-20T22:09:17.3484468Z +
2026-02-20T22:09:17.3485048Z              problem = f"Luke a {a} sabres laser. Leia lui en donne {b} de plus. Combien Luke a-t-il de sabres laser maintenant ?"
2026-02-20T22:09:17.3485697Z              explanation = f"Pour trouver le total, on additionne les sabres laser de Luke et ceux de Leia. Donc {a} + {b} = {result}."
2026-02-20T22:09:17.3485842Z              answer_type = "number"
2026-02-20T22:09:17.3485959Z -        
2026-02-20T22:09:17.3486063Z +
2026-02-20T22:09:17.3486307Z          # Créer des choix appropriés
2026-02-20T22:09:17.3486449Z          if answer_type == "number":
2026-02-20T22:09:17.3486580Z              choices = [
2026-02-20T22:09:17.3486707Z                  str(result),
2026-02-20T22:09:17.3486894Z                  str(result + random.randint(1, 3)),
2026-02-20T22:09:17.3487107Z                  str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3487279Z -                str(result + random.randint(4, 6))
2026-02-20T22:09:17.3487445Z +                str(result + random.randint(4, 6)),
2026-02-20T22:09:17.3487562Z              ]
2026-02-20T22:09:17.3487683Z          else:
2026-02-20T22:09:17.3487994Z              # Pour les réponses textuelles (si nécessaire)
2026-02-20T22:09:17.3488510Z -            choices = [str(result), "Autre réponse 1", "Autre réponse 2", "Autre réponse 3"]
2026-02-20T22:09:17.3488635Z -            
2026-02-20T22:09:17.3488754Z +            choices = [
2026-02-20T22:09:17.3488877Z +                str(result),
2026-02-20T22:09:17.3489095Z +                "Autre réponse 1",
2026-02-20T22:09:17.3489287Z +                "Autre réponse 2",
2026-02-20T22:09:17.3489483Z +                "Autre réponse 3",
2026-02-20T22:09:17.3489598Z +            ]
2026-02-20T22:09:17.3489912Z +
2026-02-20T22:09:17.3490062Z          random.shuffle(choices)
2026-02-20T22:09:17.3490169Z -        
2026-02-20T22:09:17.3490278Z +
2026-02-20T22:09:17.3490409Z          # Construire l'exercice
2026-02-20T22:09:17.3490546Z -        exercise_data.update({
2026-02-20T22:09:17.3490792Z -            "title": "Problème textuel",
2026-02-20T22:09:17.3490956Z -            "question": problem,
2026-02-20T22:09:17.3491109Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3491241Z -            "choices": choices,
2026-02-20T22:09:17.3491434Z -            "tags": Tags.ALGORITHMIC + "," + "texte",
2026-02-20T22:09:17.3491589Z -            "explanation": explanation,
2026-02-20T22:09:17.3491970Z -            "answer_type": answer_type  # Métadonnée pour l'interface
2026-02-20T22:09:17.3492088Z -        })
2026-02-20T22:09:17.3492193Z -        
2026-02-20T22:09:17.3492328Z +        exercise_data.update(
2026-02-20T22:09:17.3492436Z +            {
2026-02-20T22:09:17.3492684Z +                "title": "Problème textuel",
2026-02-20T22:09:17.3492834Z +                "question": problem,
2026-02-20T22:09:17.3493162Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3493310Z +                "choices": choices,
2026-02-20T22:09:17.3493496Z +                "tags": Tags.ALGORITHMIC + "," + "texte",
2026-02-20T22:09:17.3493912Z +                "explanation": explanation,
2026-02-20T22:09:17.3494325Z +                "answer_type": answer_type,  # Métadonnée pour l'interface
2026-02-20T22:09:17.3494439Z +            }
2026-02-20T22:09:17.3494545Z +        )
2026-02-20T22:09:17.3494648Z +
2026-02-20T22:09:17.3494829Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3494934Z  
2026-02-20T22:09:17.3495149Z      elif normalized_type == ExerciseTypes.FRACTIONS:
2026-02-20T22:09:17.3495435Z          # Génération d'un exercice sur les fractions
2026-02-20T22:09:17.3495588Z          from fractions import Fraction
2026-02-20T22:09:17.3495698Z -        
2026-02-20T22:09:17.3496075Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3496189Z +
2026-02-20T22:09:17.3496536Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3496707Z              denominator = random.choice([2, 3, 4])
2026-02-20T22:09:17.3496844Z              numerator = 1
2026-02-20T22:09:17.3497235Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3497606Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3497793Z              denominator = random.choice([2, 3, 4, 5])
2026-02-20T22:09:17.3498003Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3498370Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3498755Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3498953Z              denominator = random.choice([4, 5, 6, 8])
2026-02-20T22:09:17.3499163Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3499283Z          else:  # MAITRE
2026-02-20T22:09:17.3499468Z              denominator = random.choice([6, 8, 9, 12])
2026-02-20T22:09:17.3499672Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3499786Z -        
2026-02-20T22:09:17.3499899Z +
2026-02-20T22:09:17.3500620Z          question = f"Quelle fraction représente {numerator} part{'s' if numerator > 1 else ''} sur {denominator} ?"
2026-02-20T22:09:17.3500823Z          correct_answer = f"{numerator}/{denominator}"
2026-02-20T22:09:17.3500932Z -        
2026-02-20T22:09:17.3501044Z +
2026-02-20T22:09:17.3501163Z          choices = [
2026-02-20T22:09:17.3501292Z              correct_answer,
2026-02-20T22:09:17.3501476Z              f"{denominator}/{numerator}",  # Inversion
2026-02-20T22:09:17.3501857Z              f"{numerator}/{denominator + 1}",  # Dénominateur incorrect
2026-02-20T22:09:17.3502424Z -            f"{numerator + 1}/{denominator}"  # Numérateur incorrect
2026-02-20T22:09:17.3502788Z +            f"{numerator + 1}/{denominator}",  # Numérateur incorrect
2026-02-20T22:09:17.3502898Z          ]
2026-02-20T22:09:17.3503212Z          random.shuffle(choices)
2026-02-20T22:09:17.3503342Z -        
2026-02-20T22:09:17.3503500Z -        exercise_data.update({
2026-02-20T22:09:17.3503684Z -            "title": "Exercice sur les fractions",
2026-02-20T22:09:17.3503827Z -            "question": question,
2026-02-20T22:09:17.3504001Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3504135Z -            "choices": choices,
2026-02-20T22:09:17.3504345Z -            "tags": Tags.ALGORITHMIC + "," + Tags.FRACTIONS,
2026-02-20T22:09:17.3505424Z -            "explanation": f"Une fraction représente une partie d'un tout. {numerator} part{'s' if numerator > 1 else ''} sur {denominator} s'écrit {correct_answer}."
2026-02-20T22:09:17.3505573Z -        })
2026-02-20T22:09:17.3505684Z +
2026-02-20T22:09:17.3505830Z +        exercise_data.update(
2026-02-20T22:09:17.3505950Z +            {
2026-02-20T22:09:17.3506128Z +                "title": "Exercice sur les fractions",
2026-02-20T22:09:17.3506270Z +                "question": question,
2026-02-20T22:09:17.3506444Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3506886Z +                "choices": choices,
2026-02-20T22:09:17.3507110Z +                "tags": Tags.ALGORITHMIC + "," + Tags.FRACTIONS,
2026-02-20T22:09:17.3508213Z +                "explanation": f"Une fraction représente une partie d'un tout. {numerator} part{'s' if numerator > 1 else ''} sur {denominator} s'écrit {correct_answer}.",
2026-02-20T22:09:17.3508351Z +            }
2026-02-20T22:09:17.3508461Z +        )
2026-02-20T22:09:17.3508651Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3508766Z  
2026-02-20T22:09:17.3508991Z      elif normalized_type == ExerciseTypes.GEOMETRIE:
2026-02-20T22:09:17.3509299Z          # Génération d'un exercice de géométrie
2026-02-20T22:09:17.3509437Z          import math
2026-02-20T22:09:17.3509546Z -        
2026-02-20T22:09:17.3509916Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3510027Z +
2026-02-20T22:09:17.3510405Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3510752Z              shape = random.choice(["carré", "rectangle"])
2026-02-20T22:09:17.3510972Z              if shape == "carré":
2026-02-20T22:09:17.3511143Z                  side = random.randint(3, 10)
2026-02-20T22:09:17.3511511Z                  property_type = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3511794Z                  if property_type == "périmètre":
2026-02-20T22:09:17.3511947Z                      result = 4 * side
2026-02-20T22:09:17.3512462Z -                    question = f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3512633Z +                    question = (
2026-02-20T22:09:17.3513319Z +                        f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3513472Z +                    )
2026-02-20T22:09:17.3514021Z                      explanation = f"Le périmètre d'un carré = 4 × côté = 4 × {side} = {result} cm."
2026-02-20T22:09:17.3514151Z                  else:
2026-02-20T22:09:17.3514293Z                      result = side * side
2026-02-20T22:09:17.3514712Z                      question = f"Un carré a un côté de {side} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3515226Z                      explanation = f"L'aire d'un carré = côté × côté = {side} × {side} = {result} cm²."
2026-02-20T22:09:17.3515363Z @@ -1232,16 +1485,18 @@
2026-02-20T22:09:17.3515923Z                      question = f"Un rectangle mesure {length} cm de longueur et {width} cm de largeur. Quelle est son aire ?"
2026-02-20T22:09:17.3516579Z                      explanation = f"L'aire d'un rectangle = longueur × largeur = {length} × {width} = {result} cm²."
2026-02-20T22:09:17.3516951Z          else:
2026-02-20T22:09:17.3517341Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3517655Z              property_type = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3517761Z -            
2026-02-20T22:09:17.3518066Z +
2026-02-20T22:09:17.3518278Z              if shape == "carré":
2026-02-20T22:09:17.3518431Z                  side = random.randint(5, 15)
2026-02-20T22:09:17.3518687Z                  if property_type == "périmètre":
2026-02-20T22:09:17.3518822Z                      result = 4 * side
2026-02-20T22:09:17.3519298Z -                    question = f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3519427Z +                    question = (
2026-02-20T22:09:17.3519817Z +                        f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3519929Z +                    )
2026-02-20T22:09:17.3520458Z                      explanation = f"Le périmètre d'un carré = 4 × côté = 4 × {side} = {result} cm."
2026-02-20T22:09:17.3520583Z                  else:
2026-02-20T22:09:17.3520721Z                      result = side * side
2026-02-20T22:09:17.3521158Z                      question = f"Un carré a un côté de {side} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3521625Z                      explanation = f"L'aire d'un carré = côté² = {side}² = {result} cm²."
2026-02-20T22:09:17.3521744Z @@ -1262,11 +1517,11 @@
2026-02-20T22:09:17.3521897Z                  if property_type == "aire":
2026-02-20T22:09:17.3522061Z                      result = (base * height) / 2
2026-02-20T22:09:17.3522555Z                      question = f"Un triangle a une base de {base} cm et une hauteur de {height} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3523410Z                      explanation = f"L'aire d'un triangle = (base × hauteur) ÷ 2 = ({base} × {height}) ÷ 2 = {result} cm²."
2026-02-20T22:09:17.3523550Z                  else:
2026-02-20T22:09:17.3523821Z -                    hypotenuse = round(math.sqrt(base*base + height*height), 1)
2026-02-20T22:09:17.3524100Z +                    hypotenuse = round(math.sqrt(base * base + height * height), 1)
2026-02-20T22:09:17.3524297Z                      result = round(base + height + hypotenuse, 1)
2026-02-20T22:09:17.3525151Z                      question = f"Un triangle rectangle a une base de {base} cm et une hauteur de {height} cm. Quel est son périmètre approximatif ?"
2026-02-20T22:09:17.3525851Z                      explanation = f"Le périmètre ≈ base + hauteur + hypoténuse ≈ {base} + {height} + {hypotenuse} ≈ {result} cm."
2026-02-20T22:09:17.3525990Z              else:  # cercle
2026-02-20T22:09:17.3526162Z                  radius = random.randint(3, 10)
2026-02-20T22:09:17.3526288Z @@ -1276,34 +1531,36 @@
2026-02-20T22:09:17.3526901Z                      explanation = f"Le périmètre d'un cercle = 2 × π × rayon = 2 × 3.14 × {radius} ≈ {result} cm."
2026-02-20T22:09:17.3527046Z                  else:
2026-02-20T22:09:17.3527258Z                      result = round(math.pi * radius * radius, 2)
2026-02-20T22:09:17.3527846Z                      question = f"Un cercle a un rayon de {radius} cm. Quelle est son aire ? (Utilise π ≈ 3.14)"
2026-02-20T22:09:17.3528392Z                      explanation = f"L'aire d'un cercle = π × rayon² = 3.14 × {radius}² ≈ {result} cm²."
2026-02-20T22:09:17.3528520Z -        
2026-02-20T22:09:17.3528625Z +
2026-02-20T22:09:17.3528743Z          choices = [
2026-02-20T22:09:17.3528865Z              str(result),
2026-02-20T22:09:17.3528985Z              str(round(result * 0.5, 2)),
2026-02-20T22:09:17.3529123Z              str(round(result * 2, 2)),
2026-02-20T22:09:17.3529276Z -            str(round(result * 1.5, 2))
2026-02-20T22:09:17.3529413Z +            str(round(result * 1.5, 2)),
2026-02-20T22:09:17.3529524Z          ]
2026-02-20T22:09:17.3529668Z          random.shuffle(choices)
2026-02-20T22:09:17.3529775Z -        
2026-02-20T22:09:17.3530145Z -        exercise_data.update({
2026-02-20T22:09:17.3530418Z -            "title": "Exercice de géométrie",
2026-02-20T22:09:17.3530563Z -            "question": question,
2026-02-20T22:09:17.3530708Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3530832Z -            "choices": choices,
2026-02-20T22:09:17.3531215Z -            "tags": Tags.ALGORITHMIC + "," + Tags.GEOMETRY,
2026-02-20T22:09:17.3531358Z -            "explanation": explanation
2026-02-20T22:09:17.3531456Z -        })
2026-02-20T22:09:17.3531553Z +
2026-02-20T22:09:17.3531690Z +        exercise_data.update(
2026-02-20T22:09:17.3531793Z +            {
2026-02-20T22:09:17.3532048Z +                "title": "Exercice de géométrie",
2026-02-20T22:09:17.3532189Z +                "question": question,
2026-02-20T22:09:17.3532342Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3532464Z +                "choices": choices,
2026-02-20T22:09:17.3532650Z +                "tags": Tags.ALGORITHMIC + "," + Tags.GEOMETRY,
2026-02-20T22:09:17.3532815Z +                "explanation": explanation,
2026-02-20T22:09:17.3532916Z +            }
2026-02-20T22:09:17.3533206Z +        )
2026-02-20T22:09:17.3533388Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3533577Z      elif normalized_type == ExerciseTypes.MIXTE:
2026-02-20T22:09:17.3534043Z          # Génération d'un exercice mixte avec PLUSIEURS opérations combinées
2026-02-20T22:09:17.3534211Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3534372Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3534594Z          num_operations = type_limits.get("operations", 2)
2026-02-20T22:09:17.3534705Z -        
2026-02-20T22:09:17.3534817Z +
2026-02-20T22:09:17.3535125Z          # Choisir un pattern de calcul mixte selon la difficulté
2026-02-20T22:09:17.3535348Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3535780Z              # Pour les débutants: 2 opérations simples sans priorité complexe
2026-02-20T22:09:17.3535932Z              patterns = [
2026-02-20T22:09:17.3536221Z                  ("add_sub", lambda a, b, c: a + b - c, "{a} + {b} - {c}"),
2026-02-20T22:09:17.3536357Z @@ -1324,18 +1581,20 @@
2026-02-20T22:09:17.3536786Z                  ("paren_add_mult", lambda a, b, c: (a + b) * c, "({a} + {b}) × {c}"),
2026-02-20T22:09:17.3537220Z                  ("paren_sub_mult", lambda a, b, c: (a - b) * c, "({a} - {b}) × {c}"),
2026-02-20T22:09:17.3537636Z                  ("mult_paren_add", lambda a, b, c: a * (b + c), "{a} × ({b} + {c})"),
2026-02-20T22:09:17.3538034Z                  ("div_paren", lambda a, b, c: (a * b) // c, "({a} × {b}) ÷ {c}"),
2026-02-20T22:09:17.3538148Z              ]
2026-02-20T22:09:17.3538255Z -        
2026-02-20T22:09:17.3538364Z +
2026-02-20T22:09:17.3538652Z          pattern_name, calc_func, template = random.choice(patterns)
2026-02-20T22:09:17.3538761Z -        
2026-02-20T22:09:17.3538876Z +
2026-02-20T22:09:17.3539120Z          # Générer des nombres appropriés
2026-02-20T22:09:17.3539304Z          a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3539865Z -        b = random.randint(2, min(max_val, 10))  # Garder b petit pour éviter les grands résultats
2026-02-20T22:09:17.3540012Z +        b = random.randint(
2026-02-20T22:09:17.3540143Z +            2, min(max_val, 10)
2026-02-20T22:09:17.3540483Z +        )  # Garder b petit pour éviter les grands résultats
2026-02-20T22:09:17.3540668Z          c = random.randint(2, min(max_val, 10))
2026-02-20T22:09:17.3540777Z -        
2026-02-20T22:09:17.3540879Z +
2026-02-20T22:09:17.3541379Z          # Ajustements pour éviter les résultats négatifs ou les divisions impossibles
2026-02-20T22:09:17.3541635Z          if "sub" in pattern_name and "paren" not in pattern_name:
2026-02-20T22:09:17.3541814Z              # Pour a - b * c, s'assurer que a > b * c
2026-02-20T22:09:17.3541939Z              if a <= b * c:
2026-02-20T22:09:17.3542109Z                  a = b * c + random.randint(1, 10)
2026-02-20T22:09:17.3542449Z @@ -1348,62 +1607,73 @@
2026-02-20T22:09:17.3542757Z                      c = random.choice([d for d in range(2, 6) if temp % d == 0] or [1])
2026-02-20T22:09:17.3542881Z              else:
2026-02-20T22:09:17.3543303Z                  # a ÷ b doit être exact
2026-02-20T22:09:17.3543434Z                  if a % b != 0:
2026-02-20T22:09:17.3543804Z                      a = b * random.randint(2, 5)
2026-02-20T22:09:17.3543918Z -        
2026-02-20T22:09:17.3544018Z +
2026-02-20T22:09:17.3544162Z          result = calc_func(a, b, c)
2026-02-20T22:09:17.3544440Z          question = f"Calcule : {template.format(a=a, b=b, c=c)} = ?"
2026-02-20T22:09:17.3544548Z -        
2026-02-20T22:09:17.3544653Z +
2026-02-20T22:09:17.3544877Z          # Explication détaillée
2026-02-20T22:09:17.3545022Z          if "paren" in pattern_name:
2026-02-20T22:09:17.3545738Z              explanation = f"Avec les parenthèses, on calcule d'abord l'intérieur, puis le reste. Résultat : {result}."
2026-02-20T22:09:17.3545869Z          else:
2026-02-20T22:09:17.3546894Z              explanation = f"Attention à la priorité des opérations ! La multiplication/division se fait avant l'addition/soustraction. Résultat : {result}."
2026-02-20T22:09:17.3547011Z -        
2026-02-20T22:09:17.3547115Z +
2026-02-20T22:09:17.3547239Z          choices = [
2026-02-20T22:09:17.3547382Z              str(result),
2026-02-20T22:09:17.3547549Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3547741Z              str(max(1, result - random.randint(1, 5))),
2026-02-20T22:09:17.3547963Z -            str(a + b + c)  # Erreur courante: additionner tout
2026-02-20T22:09:17.3548186Z +            str(a + b + c),  # Erreur courante: additionner tout
2026-02-20T22:09:17.3548294Z          ]
2026-02-20T22:09:17.3548538Z          choices = list(set(choices))  # Supprimer les doublons
2026-02-20T22:09:17.3548676Z          while len(choices) < 4:
2026-02-20T22:09:17.3548921Z              choices.append(str(result + random.randint(-10, 10)))
2026-02-20T22:09:17.3549089Z          choices = list(set(choices))[:4]
2026-02-20T22:09:17.3549228Z          random.shuffle(choices)
2026-02-20T22:09:17.3549333Z -        
2026-02-20T22:09:17.3549472Z -        exercise_data.update({
2026-02-20T22:09:17.3549624Z -            "title": "Exercice mixte",
2026-02-20T22:09:17.3549758Z -            "question": question,
2026-02-20T22:09:17.3549914Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3550048Z -            "choices": choices,
2026-02-20T22:09:17.3550260Z -            "tags": Tags.ALGORITHMIC + "," + Tags.ADVANCED,
2026-02-20T22:09:17.3550412Z -            "explanation": explanation
2026-02-20T22:09:17.3550519Z -        })
2026-02-20T22:09:17.3550628Z +
2026-02-20T22:09:17.3550760Z +        exercise_data.update(
2026-02-20T22:09:17.3550866Z +            {
2026-02-20T22:09:17.3551017Z +                "title": "Exercice mixte",
2026-02-20T22:09:17.3551154Z +                "question": question,
2026-02-20T22:09:17.3551313Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3551454Z +                "choices": choices,
2026-02-20T22:09:17.3551659Z +                "tags": Tags.ALGORITHMIC + "," + Tags.ADVANCED,
2026-02-20T22:09:17.3551810Z +                "explanation": explanation,
2026-02-20T22:09:17.3551916Z +            }
2026-02-20T22:09:17.3552029Z +        )
2026-02-20T22:09:17.3552208Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3552308Z  
2026-02-20T22:09:17.3552507Z      elif normalized_type == ExerciseTypes.DIVERS:
2026-02-20T22:09:17.3553180Z          # Génération d'un exercice divers (logique, conversions, probabilités, etc.)
2026-02-20T22:09:17.3553640Z          # Différent de TEXTE qui est orienté problèmes concrets avec contexte
2026-02-20T22:09:17.3553799Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3553964Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3554357Z -        problem_types = ["sequence", "conversion", "comparaison", "pourcentage", "moyenne"]
2026-02-20T22:09:17.3554691Z -        
2026-02-20T22:09:17.3554842Z +        problem_types = [
2026-02-20T22:09:17.3554969Z +            "sequence",
2026-02-20T22:09:17.3555088Z +            "conversion",
2026-02-20T22:09:17.3555215Z +            "comparaison",
2026-02-20T22:09:17.3555341Z +            "pourcentage",
2026-02-20T22:09:17.3555629Z +            "moyenne",
2026-02-20T22:09:17.3555733Z +        ]
2026-02-20T22:09:17.3555846Z +
2026-02-20T22:09:17.3556075Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3556342Z              problem_type = random.choice(["sequence", "comparaison"])
2026-02-20T22:09:17.3556604Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3556938Z              problem_type = random.choice(["sequence", "conversion", "comparaison"])
2026-02-20T22:09:17.3557052Z          else:
2026-02-20T22:09:17.3557257Z              problem_type = random.choice(problem_types)
2026-02-20T22:09:17.3557370Z -        
2026-02-20T22:09:17.3557496Z +
2026-02-20T22:09:17.3557643Z          if problem_type == "sequence":
2026-02-20T22:09:17.3557997Z              # Séquence logique (plus variée selon difficulté)
2026-02-20T22:09:17.3558399Z -            if derived_difficulty in [DifficultyLevels.INITIE, DifficultyLevels.PADAWAN]:
2026-02-20T22:09:17.3558548Z +            if derived_difficulty in [
2026-02-20T22:09:17.3558724Z +                DifficultyLevels.INITIE,
2026-02-20T22:09:17.3558888Z +                DifficultyLevels.PADAWAN,
2026-02-20T22:09:17.3558994Z +            ]:
2026-02-20T22:09:17.3559155Z                  start = random.randint(1, 10)
2026-02-20T22:09:17.3559316Z                  step = random.randint(1, 5)
2026-02-20T22:09:17.3559520Z -                sequence = [start + step*i for i in range(4)]
2026-02-20T22:09:17.3559728Z +                sequence = [start + step * i for i in range(4)]
2026-02-20T22:09:17.3559883Z                  result = sequence[-1] + step
2026-02-20T22:09:17.3560396Z                  question = f"Trouve le nombre suivant : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ?"
2026-02-20T22:09:17.3561227Z                  explanation = f"C'est une suite arithmétique où on ajoute {step} à chaque fois. Donc {sequence[3]} + {step} = {result}."
2026-02-20T22:09:17.3561355Z              else:
2026-02-20T22:09:17.3561570Z                  # Séquence géométrique
2026-02-20T22:09:17.3561702Z @@ -1411,218 +1681,282 @@
2026-02-20T22:09:17.3561858Z                  factor = random.randint(2, 3)
2026-02-20T22:09:17.3562084Z                  sequence = [start * (factor**i) for i in range(4)]
2026-02-20T22:09:17.3562237Z                  result = sequence[-1] * factor
2026-02-20T22:09:17.3562740Z                  question = f"Trouve le nombre suivant : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ?"
2026-02-20T22:09:17.3563763Z                  explanation = f"C'est une suite géométrique où on multiplie par {factor} à chaque fois. Donc {sequence[3]} × {factor} = {result}."
2026-02-20T22:09:17.3563888Z -                
2026-02-20T22:09:17.3563984Z +
2026-02-20T22:09:17.3564136Z          elif problem_type == "conversion":
2026-02-20T22:09:17.3564348Z              # Conversion d'unités
2026-02-20T22:09:17.3564482Z              conversions = [
2026-02-20T22:09:17.3565117Z -                (60, "minutes", "heure", "Combien y a-t-il de minutes dans {n} heure(s) ?", "{n} × 60 = {r} minutes"),
2026-02-20T22:09:17.3565888Z -                (100, "centimètres", "mètre", "Combien y a-t-il de centimètres dans {n} mètre(s) ?", "{n} × 100 = {r} centimètres"),
2026-02-20T22:09:17.3566640Z -                (1000, "grammes", "kilogramme", "Combien y a-t-il de grammes dans {n} kilogramme(s) ?", "{n} × 1000 = {r} grammes"),
2026-02-20T22:09:17.3567233Z -                (24, "heures", "jour", "Combien y a-t-il d'heures dans {n} jour(s) ?", "{n} × 24 = {r} heures"),
2026-02-20T22:09:17.3567342Z -            ]
2026-02-20T22:09:17.3567748Z -            factor, unit_small, unit_big, q_template, exp_template = random.choice(conversions)
2026-02-20T22:09:17.3568079Z +                (
2026-02-20T22:09:17.3568203Z +                    60,
2026-02-20T22:09:17.3568323Z +                    "minutes",
2026-02-20T22:09:17.3568439Z +                    "heure",
2026-02-20T22:09:17.3568681Z +                    "Combien y a-t-il de minutes dans {n} heure(s) ?",
2026-02-20T22:09:17.3569086Z +                    "{n} × 60 = {r} minutes",
2026-02-20T22:09:17.3569197Z +                ),
2026-02-20T22:09:17.3569309Z +                (
2026-02-20T22:09:17.3569418Z +                    100,
2026-02-20T22:09:17.3569620Z +                    "centimètres",
2026-02-20T22:09:17.3569796Z +                    "mètre",
2026-02-20T22:09:17.3570168Z +                    "Combien y a-t-il de centimètres dans {n} mètre(s) ?",
2026-02-20T22:09:17.3570409Z +                    "{n} × 100 = {r} centimètres",
2026-02-20T22:09:17.3570516Z +                ),
2026-02-20T22:09:17.3570628Z +                (
2026-02-20T22:09:17.3570753Z +                    1000,
2026-02-20T22:09:17.3570871Z +                    "grammes",
2026-02-20T22:09:17.3570993Z +                    "kilogramme",
2026-02-20T22:09:17.3571257Z +                    "Combien y a-t-il de grammes dans {n} kilogramme(s) ?",
2026-02-20T22:09:17.3571485Z +                    "{n} × 1000 = {r} grammes",
2026-02-20T22:09:17.3571601Z +                ),
2026-02-20T22:09:17.3571711Z +                (
2026-02-20T22:09:17.3571821Z +                    24,
2026-02-20T22:09:17.3571939Z +                    "heures",
2026-02-20T22:09:17.3572061Z +                    "jour",
2026-02-20T22:09:17.3572287Z +                    "Combien y a-t-il d'heures dans {n} jour(s) ?",
2026-02-20T22:09:17.3572503Z +                    "{n} × 24 = {r} heures",
2026-02-20T22:09:17.3572608Z +                ),
2026-02-20T22:09:17.3572719Z +            ]
2026-02-20T22:09:17.3573239Z +            factor, unit_small, unit_big, q_template, exp_template = random.choice(
2026-02-20T22:09:17.3573372Z +                conversions
2026-02-20T22:09:17.3573502Z +            )
2026-02-20T22:09:17.3573643Z              n = random.randint(1, 5)
2026-02-20T22:09:17.3573773Z              result = n * factor
2026-02-20T22:09:17.3573932Z              question = q_template.format(n=n)
2026-02-20T22:09:17.3574253Z              explanation = exp_template.format(n=n, r=result)
2026-02-20T22:09:17.3574418Z -            
2026-02-20T22:09:17.3574572Z +
2026-02-20T22:09:17.3574879Z          elif problem_type == "comparaison":
2026-02-20T22:09:17.3575067Z              # Comparaison de nombres
2026-02-20T22:09:17.3575529Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3590950Z              b = random.randint(min_val, max_val)
2026-02-20T22:09:17.3591131Z              if a == b:
2026-02-20T22:09:17.3591304Z                  b = a + random.choice([-1, 1])
2026-02-20T22:09:17.3591439Z              result = max(a, b)
2026-02-20T22:09:17.3591714Z              question = f"Quel est le plus grand nombre : {a} ou {b} ?"
2026-02-20T22:09:17.3592056Z              explanation = f"En comparant {a} et {b}, le plus grand est {result}."
2026-02-20T22:09:17.3592165Z -            
2026-02-20T22:09:17.3592271Z +
2026-02-20T22:09:17.3592449Z          elif problem_type == "pourcentage":
2026-02-20T22:09:17.3592594Z              # Pourcentage simple
2026-02-20T22:09:17.3592770Z              base = random.choice([10, 20, 50, 100])
2026-02-20T22:09:17.3592946Z              pct = random.choice([10, 20, 25, 50])
2026-02-20T22:09:17.3593301Z              result = base * pct // 100
2026-02-20T22:09:17.3593510Z              question = f"Combien font {pct}% de {base} ?"
2026-02-20T22:09:17.3594132Z              explanation = f"Pour calculer {pct}% de {base}, on fait {base} × {pct} ÷ 100 = {result}."
2026-02-20T22:09:17.3594257Z -            
2026-02-20T22:09:17.3594358Z +
2026-02-20T22:09:17.3594487Z          else:  # moyenne
2026-02-20T22:09:17.3594626Z              # Calcul de moyenne
2026-02-20T22:09:17.3594779Z              count = random.randint(3, 5)
2026-02-20T22:09:17.3595354Z              numbers = [random.randint(min_val, max_val) for _ in range(count)]
2026-02-20T22:09:17.3595494Z              total = sum(numbers)
2026-02-20T22:09:17.3595644Z              result = total // count
2026-02-20T22:09:17.3595833Z              numbers_str = ", ".join(map(str, numbers))
2026-02-20T22:09:17.3596323Z              question = f"Quelle est la moyenne de ces nombres : {numbers_str} ?"
2026-02-20T22:09:17.3596922Z              explanation = f"La moyenne = somme ÷ nombre de valeurs = ({total}) ÷ {count} = {result}."
2026-02-20T22:09:17.3597040Z -        
2026-02-20T22:09:17.3597146Z +
2026-02-20T22:09:17.3597369Z          # Générer les choix
2026-02-20T22:09:17.3597507Z          choices = [str(result)]
2026-02-20T22:09:17.3597639Z          while len(choices) < 4:
2026-02-20T22:09:17.3597818Z              wrong = result + random.randint(-5, 10)
2026-02-20T22:09:17.3598020Z              if wrong > 0 and str(wrong) not in choices:
2026-02-20T22:09:17.3598182Z                  choices.append(str(wrong))
2026-02-20T22:09:17.3598320Z          random.shuffle(choices)
2026-02-20T22:09:17.3598435Z -        
2026-02-20T22:09:17.3598572Z -        exercise_data.update({
2026-02-20T22:09:17.3598718Z -            "title": "Exercice divers",
2026-02-20T22:09:17.3598854Z -            "question": question,
2026-02-20T22:09:17.3599022Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3599149Z -            "choices": choices,
2026-02-20T22:09:17.3599341Z -            "tags": Tags.ALGORITHMIC + "," + Tags.LOGIC,
2026-02-20T22:09:17.3599501Z -            "explanation": explanation
2026-02-20T22:09:17.3599612Z -        })
2026-02-20T22:09:17.3599718Z +
2026-02-20T22:09:17.3599852Z +        exercise_data.update(
2026-02-20T22:09:17.3599971Z +            {
2026-02-20T22:09:17.3600119Z +                "title": "Exercice divers",
2026-02-20T22:09:17.3600255Z +                "question": question,
2026-02-20T22:09:17.3600421Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3600559Z +                "choices": choices,
2026-02-20T22:09:17.3600758Z +                "tags": Tags.ALGORITHMIC + "," + Tags.LOGIC,
2026-02-20T22:09:17.3600921Z +                "explanation": explanation,
2026-02-20T22:09:17.3601031Z +            }
2026-02-20T22:09:17.3601138Z +        )
2026-02-20T22:09:17.3601273Z          return exercise_data
2026-02-20T22:09:17.3601774Z      # Si aucun type correspondant, retourner un exercice d'addition par défaut
2026-02-20T22:09:17.3602665Z -    logger.info(f"⚠️ Type d'exercice non géré dans generate_simple_exercise: {normalized_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.3602790Z +    logger.info(
2026-02-20T22:09:17.3603758Z +        f"⚠️ Type d'exercice non géré dans generate_simple_exercise: {normalized_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.3603876Z +    )
2026-02-20T22:09:17.3604030Z      min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3604185Z      max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3604359Z      num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3604517Z      num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3604648Z      result = num1 + num2
2026-02-20T22:09:17.3604761Z -    
2026-02-20T22:09:17.3604901Z -    exercise_data.update({
2026-02-20T22:09:17.3605703Z -        "title": ExerciseMessages.TITLE_DEFAULT if hasattr(ExerciseMessages, 'TITLE_DEFAULT') else "Exercice par défaut",
2026-02-20T22:09:17.3606114Z -        "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3606259Z -        "correct_answer": str(result),
2026-02-20T22:09:17.3606562Z -        "choices": [str(result), str(result-1), str(result+1), str(result+2)],
2026-02-20T22:09:17.3606690Z -        "num1": num1,
2026-02-20T22:09:17.3606803Z -        "num2": num2,
2026-02-20T22:09:17.3607368Z -        "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3607683Z -    })
2026-02-20T22:09:17.3607800Z -    
2026-02-20T22:09:17.3607898Z +
2026-02-20T22:09:17.3608033Z +    exercise_data.update(
2026-02-20T22:09:17.3608144Z +        {
2026-02-20T22:09:17.3608256Z +            "title": (
2026-02-20T22:09:17.3608423Z +                ExerciseMessages.TITLE_DEFAULT
2026-02-20T22:09:17.3608644Z +                if hasattr(ExerciseMessages, "TITLE_DEFAULT")
2026-02-20T22:09:17.3609090Z +                else "Exercice par défaut"
2026-02-20T22:09:17.3609205Z +            ),
2026-02-20T22:09:17.3609600Z +            "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3609761Z +            "correct_answer": str(result),
2026-02-20T22:09:17.3610098Z +            "choices": [str(result), str(result - 1), str(result + 1), str(result + 2)],
2026-02-20T22:09:17.3610223Z +            "num1": num1,
2026-02-20T22:09:17.3610350Z +            "num2": num2,
2026-02-20T22:09:17.3610922Z +            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3611041Z +        }
2026-02-20T22:09:17.3611149Z +    )
2026-02-20T22:09:17.3611263Z +
2026-02-20T22:09:17.3611436Z      return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3611540Z +
2026-02-20T22:09:17.3611651Z  
2026-02-20T22:09:17.3612037Z  def generate_contextual_question(operation_type, num1, num2, result, age_group):
2026-02-20T22:09:17.3612618Z      """Génère une question contextualisée selon le type d'opération et le groupe d'âge"""
2026-02-20T22:09:17.3613207Z      contexts = StarWarsNarratives.CONTEXTS_BY_TYPE.get(operation_type.upper(), {})
2026-02-20T22:09:17.3613460Z -    
2026-02-20T22:09:17.3613570Z +
2026-02-20T22:09:17.3613698Z      if not contexts:
2026-02-20T22:09:17.3613872Z          # Fallback vers les questions de base
2026-02-20T22:09:17.3614046Z          if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3614199Z              return f"Calcule {num1} + {num2}"
2026-02-20T22:09:17.3614422Z          elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3614578Z              return f"Calcule {num1} - {num2}"
2026-02-20T22:09:17.3614795Z          elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3615048Z              return f"Calcule {num1} × {num2}"
2026-02-20T22:09:17.3615238Z          elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3615488Z              return f"Calcule {num1} ÷ {num2}"
2026-02-20T22:09:17.3615597Z -    
2026-02-20T22:09:17.3615711Z +
2026-02-20T22:09:17.3616001Z      objects = contexts.get("objects", ["éléments"])
2026-02-20T22:09:17.3616212Z      actions = contexts.get("actions", ["se combinent"])
2026-02-20T22:09:17.3616472Z      locations = contexts.get("locations", ["dans la galaxie"])
2026-02-20T22:09:17.3616583Z -    
2026-02-20T22:09:17.3616688Z +
2026-02-20T22:09:17.3616831Z      obj = random.choice(objects)
2026-02-20T22:09:17.3616987Z      action = random.choice(actions)
2026-02-20T22:09:17.3617144Z      location = random.choice(locations)
2026-02-20T22:09:17.3617262Z -    
2026-02-20T22:09:17.3617371Z +
2026-02-20T22:09:17.3617653Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.3617759Z  
2026-02-20T22:09:17.3618101Z      # Templates selon la difficulté dérivée et l'opération
2026-02-20T22:09:17.3618277Z      if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3618513Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3618647Z              templates = [
2026-02-20T22:09:17.3619156Z                  f"Dans {location}, tu trouves {num1} {obj} et ton ami en trouve {num2}. Combien en avez-vous ensemble?",
2026-02-20T22:09:17.3619493Z                  f"R2-D2 compte {num1} {obj} et C-3PO en compte {num2}. Quel est le total?",
2026-02-20T22:09:17.3619791Z -                f"Luke a {num1} {obj} et Leia en a {num2}. Combien ont-ils au total?"
2026-02-20T22:09:17.3620098Z +                f"Luke a {num1} {obj} et Leia en a {num2}. Combien ont-ils au total?",
2026-02-20T22:09:17.3620430Z              ]
2026-02-20T22:09:17.3620543Z          else:
2026-02-20T22:09:17.3620665Z              templates = [
2026-02-20T22:09:17.3621056Z                  f"Dans {location}, {num1} {obj} {action} avec {num2} autres. Quel est le total?",
2026-02-20T22:09:17.3621645Z                  f"L'Alliance déploie {num1} {obj} qui {action} avec {num2} renforts. Combien au total?",
2026-02-20T22:09:17.3622162Z -                f"Sur {location}, {num1} {obj} {action} et {num2} autres arrivent. Total?"
2026-02-20T22:09:17.3622287Z -            ]
2026-02-20T22:09:17.3622395Z -    
2026-02-20T22:09:17.3622723Z +                f"Sur {location}, {num1} {obj} {action} et {num2} autres arrivent. Total?",
2026-02-20T22:09:17.3622837Z +            ]
2026-02-20T22:09:17.3622930Z +
2026-02-20T22:09:17.3623328Z      elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3623560Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3623704Z              templates = [
2026-02-20T22:09:17.3624024Z                  f"Tu avais {num1} {obj}, mais {num2} {action}. Combien te reste-t-il?",
2026-02-20T22:09:17.3624406Z                  f"Dans {location}, il y avait {num1} {obj}, mais {num2} {action}. Combien restent?",
2026-02-20T22:09:17.3624954Z -                f"Yoda possédait {num1} {obj}, mais {num2} {action}. Combien lui reste-t-il?"
2026-02-20T22:09:17.3625440Z +                f"Yoda possédait {num1} {obj}, mais {num2} {action}. Combien lui reste-t-il?",
2026-02-20T22:09:17.3625546Z              ]
2026-02-20T22:09:17.3625658Z          else:
2026-02-20T22:09:17.3625777Z              templates = [
2026-02-20T22:09:17.3626168Z                  f"L'Empire avait {num1} {obj}, mais {num2} {action} lors de {location}. Combien restent?",
2026-02-20T22:09:17.3626663Z                  f"Dans {location}, {num1} {obj} étaient présents, mais {num2} {action}. Reste?",
2026-02-20T22:09:17.3627077Z -                f"La flotte comptait {num1} {obj}, mais {num2} {action} pendant {location}. Combien survivent?"
2026-02-20T22:09:17.3627200Z -            ]
2026-02-20T22:09:17.3627306Z -    
2026-02-20T22:09:17.3627728Z +                f"La flotte comptait {num1} {obj}, mais {num2} {action} pendant {location}. Combien survivent?",
2026-02-20T22:09:17.3627838Z +            ]
2026-02-20T22:09:17.3627947Z +
2026-02-20T22:09:17.3628179Z      elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3628402Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3628520Z              templates = [
2026-02-20T22:09:17.3628875Z                  f"Chaque Padawan a {num2} {obj}. S'il y a {num1} Padawans, combien de {obj} au total?",
2026-02-20T22:09:17.3629203Z                  f"Dans chaque {location}, il y a {num2} {obj}. Combien dans {num1} {location}?",
2026-02-20T22:09:17.3629681Z -                f"Chaque droïde transporte {num2} {obj}. Combien pour {num1} droïdes?"
2026-02-20T22:09:17.3630152Z +                f"Chaque droïde transporte {num2} {obj}. Combien pour {num1} droïdes?",
2026-02-20T22:09:17.3630275Z              ]
2026-02-20T22:09:17.3630387Z          else:
2026-02-20T22:09:17.3630513Z              templates = [
2026-02-20T22:09:17.3631020Z                  f"Chaque {location} déploie {num2} {obj}. Combien pour {num1} {location}?",
2026-02-20T22:09:17.3631510Z                  f"Dans {location}, chaque unité a {num2} {obj}. Total pour {num1} unités?",
2026-02-20T22:09:17.3631920Z -                f"L'Empire organise {num1} {location} avec {num2} {obj} chacun. Combien au total?"
2026-02-20T22:09:17.3632049Z -            ]
2026-02-20T22:09:17.3632155Z -    
2026-02-20T22:09:17.3632554Z +                f"L'Empire organise {num1} {location} avec {num2} {obj} chacun. Combien au total?",
2026-02-20T22:09:17.3632675Z +            ]
2026-02-20T22:09:17.3632784Z +
2026-02-20T22:09:17.3633214Z      elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3633463Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3633851Z              templates = [
2026-02-20T22:09:17.3634403Z                  f"Tu as {num1} {obj} à distribuer entre {num2} Padawans. Combien chacun en aura?",
2026-02-20T22:09:17.3634900Z                  f"Il faut répartir {num1} {obj} dans {num2} {location}. Combien par {location}?",
2026-02-20T22:09:17.3635394Z -                f"Yoda doit partager {num1} {obj} entre {num2} élèves. Combien chacun?"
2026-02-20T22:09:17.3636044Z +                f"Yoda doit partager {num1} {obj} entre {num2} élèves. Combien chacun?",
2026-02-20T22:09:17.3636158Z              ]
2026-02-20T22:09:17.3636277Z          else:
2026-02-20T22:09:17.3636410Z              templates = [
2026-02-20T22:09:17.3637001Z                  f"L'Alliance doit répartir {num1} {obj} dans {num2} {location}. Combien par {location}?",
2026-02-20T22:09:17.3637604Z                  f"Un convoi de {num1} {obj} doit être distribué sur {num2} {location}. Combien par site?",
2026-02-20T22:09:17.3638123Z -                f"L'Empire divise {num1} {obj} entre {num2} {location}. Répartition par zone?"
2026-02-20T22:09:17.3638265Z -            ]
2026-02-20T22:09:17.3638370Z -    
2026-02-20T22:09:17.3638945Z -    return random.choice(templates) if 'templates' in locals() else f"Calcule {num1} {operation_type.lower()} {num2}"
2026-02-20T22:09:17.3639059Z -
2026-02-20T22:09:17.3639651Z -def generate_smart_choices(operation_type, num1, num2, correct_result, age_group): # Changed difficulty to age_group
2026-02-20T22:09:17.3640197Z +                f"L'Empire divise {num1} {obj} entre {num2} {location}. Répartition par zone?",
2026-02-20T22:09:17.3640314Z +            ]
2026-02-20T22:09:17.3640427Z +
2026-02-20T22:09:17.3640538Z +    return (
2026-02-20T22:09:17.3640677Z +        random.choice(templates)
2026-02-20T22:09:17.3640821Z +        if "templates" in locals()
2026-02-20T22:09:17.3641059Z +        else f"Calcule {num1} {operation_type.lower()} {num2}"
2026-02-20T22:09:17.3641165Z +    )
2026-02-20T22:09:17.3641265Z +
2026-02-20T22:09:17.3641374Z +
2026-02-20T22:09:17.3641530Z +def generate_smart_choices(
2026-02-20T22:09:17.3641751Z +    operation_type, num1, num2, correct_result, age_group
2026-02-20T22:09:17.3641910Z +):  # Changed difficulty to age_group
2026-02-20T22:09:17.3642391Z      """Génère des choix de réponses avec des erreurs typiques selon l'opération"""
2026-02-20T22:09:17.3642541Z      choices = [str(correct_result)]
2026-02-20T22:09:17.3642670Z -    
2026-02-20T22:09:17.3642779Z +
2026-02-20T22:09:17.3642949Z      if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3643322Z          # Erreurs typiques en addition
2026-02-20T22:09:17.3643463Z -        choices.extend([
2026-02-20T22:09:17.3643791Z -            str(correct_result + random.randint(1, 3)),  # Erreur de calcul simple
2026-02-20T22:09:17.3644162Z -            str(correct_result - random.randint(1, 2)),  # Oubli d'une unité
2026-02-20T22:09:17.3644716Z -            str(num1 * num2) if num1 * num2 != correct_result else str(correct_result + 5)  # Confusion avec multiplication
2026-02-20T22:09:17.3644839Z -        ])
2026-02-20T22:09:17.3644942Z -    
2026-02-20T22:09:17.3645082Z +        choices.extend(
2026-02-20T22:09:17.3645192Z +            [
2026-02-20T22:09:17.3645519Z +                str(correct_result + random.randint(1, 3)),  # Erreur de calcul simple
2026-02-20T22:09:17.3645891Z +                str(correct_result - random.randint(1, 2)),  # Oubli d'une unité
2026-02-20T22:09:17.3646021Z +                (
2026-02-20T22:09:17.3646154Z +                    str(num1 * num2)
2026-02-20T22:09:17.3646321Z +                    if num1 * num2 != correct_result
2026-02-20T22:09:17.3646494Z +                    else str(correct_result + 5)
2026-02-20T22:09:17.3646664Z +                ),  # Confusion avec multiplication
2026-02-20T22:09:17.3646771Z +            ]
2026-02-20T22:09:17.3646873Z +        )
2026-02-20T22:09:17.3646987Z +
2026-02-20T22:09:17.3647177Z      elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3647331Z          # Erreurs typiques en soustraction
2026-02-20T22:09:17.3647683Z -        choices.extend([
2026-02-20T22:09:17.3648075Z -            str(num2 - num1) if num2 != num1 else str(correct_result + 3),  # Inversion de l'ordre
2026-02-20T22:09:17.3648362Z -            str(correct_result + random.randint(1, 3)),  # Erreur de calcul
2026-02-20T22:09:17.3648939Z -            str(num1 + num2) if num1 + num2 != correct_result else str(correct_result - 2)  # Addition au lieu de soustraction
2026-02-20T22:09:17.3649286Z -        ])
2026-02-20T22:09:17.3649395Z -    
2026-02-20T22:09:17.3649533Z +        choices.extend(
2026-02-20T22:09:17.3649646Z +            [
2026-02-20T22:09:17.3649748Z +                (
2026-02-20T22:09:17.3650033Z +                    str(num2 - num1) if num2 != num1 else str(correct_result + 3)
2026-02-20T22:09:17.3650187Z +                ),  # Inversion de l'ordre
2026-02-20T22:09:17.3651054Z +                str(correct_result + random.randint(1, 3)),  # Erreur de calcul
2026-02-20T22:09:17.3651187Z +                (
2026-02-20T22:09:17.3651352Z +                    str(num1 + num2)
2026-02-20T22:09:17.3651525Z +                    if num1 + num2 != correct_result
2026-02-20T22:09:17.3651693Z +                    else str(correct_result - 2)
2026-02-20T22:09:17.3651865Z +                ),  # Addition au lieu de soustraction
2026-02-20T22:09:17.3651985Z +            ]
2026-02-20T22:09:17.3652097Z +        )
2026-02-20T22:09:17.3652201Z +
2026-02-20T22:09:17.3652421Z      elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3652587Z          # Erreurs typiques en multiplication
2026-02-20T22:09:17.3652716Z -        choices.extend([
2026-02-20T22:09:17.3652949Z -            str(num1 + num2),  # Addition au lieu de multiplication
2026-02-20T22:09:17.3653335Z -            str(correct_result + num1),  # Une fois de trop
2026-02-20T22:09:17.3653574Z -            str(max(1, correct_result - num2))  # Une fois de moins
2026-02-20T22:09:17.3653681Z -        ])
2026-02-20T22:09:17.3653793Z -    
2026-02-20T22:09:17.3653930Z +        choices.extend(
2026-02-20T22:09:17.3654038Z +            [
2026-02-20T22:09:17.3654289Z +                str(num1 + num2),  # Addition au lieu de multiplication
2026-02-20T22:09:17.3654496Z +                str(correct_result + num1),  # Une fois de trop
2026-02-20T22:09:17.3654742Z +                str(max(1, correct_result - num2)),  # Une fois de moins
2026-02-20T22:09:17.3654858Z +            ]
2026-02-20T22:09:17.3654970Z +        )
2026-02-20T22:09:17.3655072Z +
2026-02-20T22:09:17.3655252Z      elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3655405Z          # Erreurs typiques en division
2026-02-20T22:09:17.3655535Z -        choices.extend([
2026-02-20T22:09:17.3655754Z -            str(correct_result + 1),  # Erreur de calcul simple
2026-02-20T22:09:17.3656002Z -            str(max(1, correct_result - 1)),  # Erreur de calcul simple
2026-02-20T22:09:17.3656474Z -            str(num1 - num2) if num1 > num2 else str(correct_result + 2)  # Soustraction au lieu de division
2026-02-20T22:09:17.3656592Z -        ])
2026-02-20T22:09:17.3656696Z -    
2026-02-20T22:09:17.3656828Z +        choices.extend(
2026-02-20T22:09:17.3656934Z +            [
2026-02-20T22:09:17.3657156Z +                str(correct_result + 1),  # Erreur de calcul simple
2026-02-20T22:09:17.3657418Z +                str(max(1, correct_result - 1)),  # Erreur de calcul simple
2026-02-20T22:09:17.3657534Z +                (
2026-02-20T22:09:17.3657801Z +                    str(num1 - num2) if num1 > num2 else str(correct_result + 2)
2026-02-20T22:09:17.3657978Z +                ),  # Soustraction au lieu de division
2026-02-20T22:09:17.3658088Z +            ]
2026-02-20T22:09:17.3658191Z +        )
2026-02-20T22:09:17.3658297Z +
2026-02-20T22:09:17.3658578Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.3658949Z      # Ajuster selon la difficulté dérivée du groupe d'âge
2026-02-20T22:09:17.3659356Z      if derived_difficulty in [DifficultyLevels.CHEVALIER, DifficultyLevels.MAITRE]:
2026-02-20T22:09:17.3660019Z          # Pour les niveaux avancés, ajouter des erreurs plus subtiles
2026-02-20T22:09:17.3660209Z          margin = max(1, int(correct_result * 0.1))
2026-02-20T22:09:17.3660384Z          choices[1] = str(correct_result + margin)
2026-02-20T22:09:17.3660591Z          choices[2] = str(max(1, correct_result - margin))
2026-02-20T22:09:17.3660939Z -    
2026-02-20T22:09:17.3661046Z +
2026-02-20T22:09:17.3661370Z      # S'assurer qu'il n'y a pas de doublons et que tous les choix sont positifs
2026-02-20T22:09:17.3661514Z      unique_choices = []
2026-02-20T22:09:17.3661649Z      for choice in choices:
2026-02-20T22:09:17.3661759Z          try:
2026-02-20T22:09:17.3661988Z              if choice not in unique_choices and int(choice) > 0:
2026-02-20T22:09:17.3662109Z @@ -1634,9 +1968,9 @@
2026-02-20T22:09:17.3662340Z      # Compléter si nécessaire
2026-02-20T22:09:17.3662496Z      while len(unique_choices) < 4:
2026-02-20T22:09:17.3662746Z          new_choice = str(correct_result + random.randint(-3, 5))
2026-02-20T22:09:17.3663206Z          if new_choice not in unique_choices and int(new_choice) > 0:
2026-02-20T22:09:17.3663382Z              unique_choices.append(new_choice)
2026-02-20T22:09:17.3663496Z -    
2026-02-20T22:09:17.3663601Z +
2026-02-20T22:09:17.3663855Z      # Mélanger et retourner les 4 premiers
2026-02-20T22:09:17.3664013Z      random.shuffle(unique_choices)
2026-02-20T22:09:17.3664161Z -    return unique_choices[:4]
2026-02-20T22:09:17.3664295Z \ No newline at end of file
2026-02-20T22:09:17.3664432Z +    return unique_choices[:4]
2026-02-20T22:09:17.3880548Z would reformat /home/runner/work/mathakine/mathakine/server/template_handler.py
2026-02-20T22:09:17.3881081Z --- /home/runner/work/mathakine/mathakine/server/template_handler.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.3881585Z +++ /home/runner/work/mathakine/mathakine/server/template_handler.py	2026-02-20 22:09:17.385194+00:00
2026-02-20T22:09:17.3881699Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.3881876Z  Template handler module for Mathakine.
2026-02-20T22:09:17.3881985Z  
2026-02-20T22:09:17.3882299Z  This module centralizes template rendering logic, providing consistent
2026-02-20T22:09:17.3882617Z  error handling and template context preparation across the application.
2026-02-20T22:09:17.3882725Z  """
2026-02-20T22:09:17.3882824Z +
2026-02-20T22:09:17.3882949Z  import json
2026-02-20T22:09:17.3883245Z  import traceback
2026-02-20T22:09:17.3883399Z  from pathlib import Path
2026-02-20T22:09:17.3883506Z  
2026-02-20T22:09:17.3883701Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.3883823Z @@ -15,99 +16,93 @@
2026-02-20T22:09:17.3884009Z  from starlette.responses import HTMLResponse
2026-02-20T22:09:17.3884209Z  from starlette.templating import Jinja2Templates
2026-02-20T22:09:17.3884314Z  
2026-02-20T22:09:17.3884453Z  # Get templates directory
2026-02-20T22:09:17.3884643Z  BASE_DIR = Path(__file__).resolve().parent.parent
2026-02-20T22:09:17.3884818Z -TEMPLATES_DIR = str(BASE_DIR / 'templates')
2026-02-20T22:09:17.3885003Z +TEMPLATES_DIR = str(BASE_DIR / "templates")
2026-02-20T22:09:17.3885107Z  
2026-02-20T22:09:17.3885237Z  # Initialize templates
2026-02-20T22:09:17.3885467Z  templates = Jinja2Templates(directory=TEMPLATES_DIR)
2026-02-20T22:09:17.3885569Z  
2026-02-20T22:09:17.3885691Z  # Add tojson filter
2026-02-20T22:09:17.3885972Z  templates.env.filters["tojson"] = lambda obj: json.dumps(obj)
2026-02-20T22:09:17.3886080Z  
2026-02-20T22:09:17.3886181Z +
2026-02-20T22:09:17.3886306Z  def render_template(
2026-02-20T22:09:17.3886442Z -    template_name: str,
2026-02-20T22:09:17.3886563Z -    request: Request,
2026-02-20T22:09:17.3886692Z -    context: dict = None,
2026-02-20T22:09:17.3886820Z -    status_code: int = 200
2026-02-20T22:09:17.3887206Z +    template_name: str, request: Request, context: dict = None, status_code: int = 200
2026-02-20T22:09:17.3887326Z  ) -> HTMLResponse:
2026-02-20T22:09:17.3887434Z      """
2026-02-20T22:09:17.3887648Z      Render a template with consistent error handling.
2026-02-20T22:09:17.3888084Z -    
2026-02-20T22:09:17.3888190Z +
2026-02-20T22:09:17.3888301Z      Args:
2026-02-20T22:09:17.3888510Z          template_name: Name of the template to render
2026-02-20T22:09:17.3888675Z          request: The Starlette request object
2026-02-20T22:09:17.3888835Z          context: Template context dictionary
2026-02-20T22:09:17.3889232Z          status_code: HTTP status code
2026-02-20T22:09:17.3889341Z -        
2026-02-20T22:09:17.3889443Z +
2026-02-20T22:09:17.3889553Z      Returns:
2026-02-20T22:09:17.3889743Z          HTMLResponse with the rendered template
2026-02-20T22:09:17.3889856Z      """
2026-02-20T22:09:17.3889967Z      try:
2026-02-20T22:09:17.3890123Z          # Initialize context if None
2026-02-20T22:09:17.3890260Z          context = context or {}
2026-02-20T22:09:17.3890368Z -        
2026-02-20T22:09:17.3890469Z +
2026-02-20T22:09:17.3890625Z          # Ensure 'request' is in context
2026-02-20T22:09:17.3890763Z -        context['request'] = request
2026-02-20T22:09:17.3890874Z -        
2026-02-20T22:09:17.3891019Z +        context["request"] = request
2026-02-20T22:09:17.3891123Z +
2026-02-20T22:09:17.3891376Z          # Ensure current_user is set (default to unauthenticated)
2026-02-20T22:09:17.3891531Z -        if 'current_user' not in context:
2026-02-20T22:09:17.3891782Z -            context['current_user'] = {"is_authenticated": False}
2026-02-20T22:09:17.3891891Z -            
2026-02-20T22:09:17.3892036Z +        if "current_user" not in context:
2026-02-20T22:09:17.3892274Z +            context["current_user"] = {"is_authenticated": False}
2026-02-20T22:09:17.3892377Z +
2026-02-20T22:09:17.3892508Z          # Render template
2026-02-20T22:09:17.3892684Z          return templates.TemplateResponse(
2026-02-20T22:09:17.3892811Z -            template_name,
2026-02-20T22:09:17.3892939Z -            context=context,
2026-02-20T22:09:17.3893249Z -            status_code=status_code
2026-02-20T22:09:17.3893516Z +            template_name, context=context, status_code=status_code
2026-02-20T22:09:17.3893631Z          )
2026-02-20T22:09:17.3893767Z      except Exception as e:
2026-02-20T22:09:17.3894057Z          logger.error(f"Error rendering template {template_name}: {e}")
2026-02-20T22:09:17.3894196Z          traceback.print_exc()
2026-02-20T22:09:17.3894302Z -        
2026-02-20T22:09:17.3894411Z +
2026-02-20T22:09:17.3894553Z          # Render error template
2026-02-20T22:09:17.3894687Z          return render_error(
2026-02-20T22:09:17.3894818Z              request=request,
2026-02-20T22:09:17.3894969Z              error="Template Error",
2026-02-20T22:09:17.3895179Z              message=f"Error rendering template: {str(e)}",
2026-02-20T22:09:17.3895306Z -            status_code=500
2026-02-20T22:09:17.3895439Z +            status_code=500,
2026-02-20T22:09:17.3895546Z          )
2026-02-20T22:09:17.3895649Z  
2026-02-20T22:09:17.3895753Z +
2026-02-20T22:09:17.3895885Z  def render_error(
2026-02-20T22:09:17.3896008Z -    request: Request,
2026-02-20T22:09:17.3896128Z -    error: str,
2026-02-20T22:09:17.3896257Z -    message: str = None,
2026-02-20T22:09:17.3896393Z -    status_code: int = 500
2026-02-20T22:09:17.3896715Z +    request: Request, error: str, message: str = None, status_code: int = 500
2026-02-20T22:09:17.3896841Z  ) -> HTMLResponse:
2026-02-20T22:09:17.3896961Z      """
2026-02-20T22:09:17.3897101Z      Render an error template.
2026-02-20T22:09:17.3897206Z -    
2026-02-20T22:09:17.3897315Z +
2026-02-20T22:09:17.3897419Z      Args:
2026-02-20T22:09:17.3897587Z          request: The Starlette request object
2026-02-20T22:09:17.3897711Z          error: Error title
2026-02-20T22:09:17.3897850Z          message: Error message
2026-02-20T22:09:17.3897997Z          status_code: HTTP status code
2026-02-20T22:09:17.3898100Z -        
2026-02-20T22:09:17.3898211Z +
2026-02-20T22:09:17.3898320Z      Returns:
2026-02-20T22:09:17.3898521Z          HTMLResponse with the rendered error template
2026-02-20T22:09:17.3898623Z      """
2026-02-20T22:09:17.3898965Z      try:
2026-02-20T22:09:17.3899149Z          return templates.TemplateResponse(
2026-02-20T22:09:17.3899279Z              "error.html",
2026-02-20T22:09:17.3899393Z              {
2026-02-20T22:09:17.3899524Z                  "request": request,
2026-02-20T22:09:17.3899651Z                  "error": error,
2026-02-20T22:09:17.3900047Z                  "message": message or "An error occurred.",
2026-02-20T22:09:17.3900256Z -                "current_user": {"is_authenticated": False}
2026-02-20T22:09:17.3900453Z +                "current_user": {"is_authenticated": False},
2026-02-20T22:09:17.3900558Z              },
2026-02-20T22:09:17.3900701Z -            status_code=status_code
2026-02-20T22:09:17.3900839Z +            status_code=status_code,
2026-02-20T22:09:17.3900943Z          )
2026-02-20T22:09:17.3901098Z      except Exception as template_error:
2026-02-20T22:09:17.3901360Z          # If rendering error template fails, fallback to basic HTML
2026-02-20T22:09:17.3901692Z          logger.critical(f"Error rendering error template: {template_error}")
2026-02-20T22:09:17.3901869Z          logger.critical(traceback.format_exc())
2026-02-20T22:09:17.3901984Z -        
2026-02-20T22:09:17.3902086Z +
2026-02-20T22:09:17.3902222Z          return HTMLResponse(
2026-02-20T22:09:17.3902338Z              f"""
2026-02-20T22:09:17.3902453Z              <html>
2026-02-20T22:09:17.3902624Z                  <head><title>Error</title></head>
2026-02-20T22:09:17.3902740Z                  <body>
2026-02-20T22:09:17.3902862Z @@ -116,16 +111,17 @@
2026-02-20T22:09:17.3904376Z                      <p>Additionally, an error occurred while rendering the error page.</p>
2026-02-20T22:09:17.3904569Z                      <a href="/">Return to home</a>
2026-02-20T22:09:17.3905265Z                  </body>
2026-02-20T22:09:17.3905395Z              </html>
2026-02-20T22:09:17.3905504Z              """,
2026-02-20T22:09:17.3906573Z -            status_code=status_code
2026-02-20T22:09:17.3906748Z +            status_code=status_code,
2026-02-20T22:09:17.3906865Z          )
2026-02-20T22:09:17.3907498Z +
2026-02-20T22:09:17.3907618Z  
2026-02-20T22:09:17.3907795Z  def get_templates() -> Jinja2Templates:
2026-02-20T22:09:17.3907904Z      """
2026-02-20T22:09:17.3908195Z      Get the templates object for use in application initialization.
2026-02-20T22:09:17.3908313Z -    
2026-02-20T22:09:17.3908414Z +
2026-02-20T22:09:17.3908522Z      Returns:
2026-02-20T22:09:17.3908671Z          Jinja2Templates object
2026-02-20T22:09:17.3908778Z      """
2026-02-20T22:09:17.3908905Z -    return templates 
2026-02-20T22:09:17.3909041Z \ No newline at end of file
2026-02-20T22:09:17.3909171Z +    return templates
2026-02-20T22:09:17.4906355Z --- /home/runner/work/mathakine/mathakine/server/routes.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.4906871Z +++ /home/runner/work/mathakine/mathakine/server/routes.py	2026-02-20 22:09:17.488495+00:00
2026-02-20T22:09:17.4908954Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.4909203Z  Routes API pour Mathakine (backend Starlette).
2026-02-20T22:09:17.4911920Z  
2026-02-20T22:09:17.4912668Z  Ce module définit uniquement les routes API JSON utilisées par le frontend Next.js.
2026-02-20T22:09:17.4913366Z  Toutes les routes HTML/templates ont été supprimées (frontend géré par Next.js).
2026-02-20T22:09:17.4913496Z  """
2026-02-20T22:09:17.4913628Z +
2026-02-20T22:09:17.4913769Z  from typing import List
2026-02-20T22:09:17.4913886Z  
2026-02-20T22:09:17.4914098Z  from starlette.responses import PlainTextResponse
2026-02-20T22:09:17.4914276Z  from starlette.routing import Mount, Route
2026-02-20T22:09:17.4914386Z  
2026-02-20T22:09:17.4914515Z @@ -39,82 +40,104 @@
2026-02-20T22:09:17.4914626Z      admin_users,
2026-02-20T22:09:17.4914746Z      admin_users_patch,
2026-02-20T22:09:17.4914903Z      admin_users_resend_verification,
2026-02-20T22:09:17.4915046Z      admin_users_send_reset_password,
2026-02-20T22:09:17.4915154Z  )
2026-02-20T22:09:17.4915253Z +
2026-02-20T22:09:17.4915407Z  # Imports API handlers - Auth
2026-02-20T22:09:17.4916148Z -from server.handlers.auth_handlers import (api_get_current_user, api_login,
2026-02-20T22:09:17.4916375Z -                                           api_refresh_token, api_validate_token,
2026-02-20T22:09:17.4916559Z -                                           api_get_csrf_token,
2026-02-20T22:09:17.4916947Z -                                           api_logout, api_forgot_password,
2026-02-20T22:09:17.4917120Z -                                           api_reset_password,
2026-02-20T22:09:17.4917315Z -                                           resend_verification_email,
2026-02-20T22:09:17.4917471Z -                                           verify_email)
2026-02-20T22:09:17.4917649Z +from server.handlers.auth_handlers import (
2026-02-20T22:09:17.4917925Z +    api_get_current_user,
2026-02-20T22:09:17.4918464Z +    api_login,
2026-02-20T22:09:17.4918604Z +    api_refresh_token,
2026-02-20T22:09:17.4918983Z +    api_validate_token,
2026-02-20T22:09:17.4919170Z +    api_get_csrf_token,
2026-02-20T22:09:17.4919292Z +    api_logout,
2026-02-20T22:09:17.4919428Z +    api_forgot_password,
2026-02-20T22:09:17.4919559Z +    api_reset_password,
2026-02-20T22:09:17.4919714Z +    resend_verification_email,
2026-02-20T22:09:17.4919834Z +    verify_email,
2026-02-20T22:09:17.4919945Z +)
2026-02-20T22:09:17.4920064Z +
2026-02-20T22:09:17.4920220Z  # Imports API handlers - Badges
2026-02-20T22:09:17.4920517Z -from server.handlers.badge_handlers import (check_user_badges,
2026-02-20T22:09:17.4920715Z -                                            get_available_badges,
2026-02-20T22:09:17.4920892Z -                                            get_badges_rarity,
2026-02-20T22:09:17.4921062Z -                                            get_user_badges,
2026-02-20T22:09:17.4921249Z -                                            get_user_gamification_stats,
2026-02-20T22:09:17.4921434Z -                                            get_user_badges_progress,
2026-02-20T22:09:17.4921616Z -                                            patch_pinned_badges)
2026-02-20T22:09:17.4921800Z +from server.handlers.badge_handlers import (
2026-02-20T22:09:17.4921937Z +    check_user_badges,
2026-02-20T22:09:17.4922068Z +    get_available_badges,
2026-02-20T22:09:17.4922184Z +    get_badges_rarity,
2026-02-20T22:09:17.4922311Z +    get_user_badges,
2026-02-20T22:09:17.4922438Z +    get_user_gamification_stats,
2026-02-20T22:09:17.4922520Z +    get_user_badges_progress,
2026-02-20T22:09:17.4922599Z +    patch_pinned_badges,
2026-02-20T22:09:17.4922666Z +)
2026-02-20T22:09:17.4922728Z +
2026-02-20T22:09:17.4922820Z  # Imports API handlers - Challenges
2026-02-20T22:09:17.4923309Z -from server.handlers.challenge_handlers import (generate_ai_challenge_stream,
2026-02-20T22:09:17.4923446Z -                                                get_challenge,
2026-02-20T22:09:17.4923559Z -                                                get_challenge_hint,
2026-02-20T22:09:17.4923667Z -                                                get_challenges_list,
2026-02-20T22:09:17.4923799Z -                                                get_completed_challenges_ids,
2026-02-20T22:09:17.4923913Z -                                                submit_challenge_answer,
2026-02-20T22:09:17.4924014Z -                                                start_challenge,
2026-02-20T22:09:17.4924135Z -                                                get_challenge_progress,
2026-02-20T22:09:17.4924242Z -                                                get_challenge_rewards)
2026-02-20T22:09:17.4924364Z +from server.handlers.challenge_handlers import (
2026-02-20T22:09:17.4924452Z +    generate_ai_challenge_stream,
2026-02-20T22:09:17.4924524Z +    get_challenge,
2026-02-20T22:09:17.4924600Z +    get_challenge_hint,
2026-02-20T22:09:17.4924675Z +    get_challenges_list,
2026-02-20T22:09:17.4924762Z +    get_completed_challenges_ids,
2026-02-20T22:09:17.4924839Z +    submit_challenge_answer,
2026-02-20T22:09:17.4924910Z +    start_challenge,
2026-02-20T22:09:17.4925193Z +    get_challenge_progress,
2026-02-20T22:09:17.4925269Z +    get_challenge_rewards,
2026-02-20T22:09:17.4925330Z +)
2026-02-20T22:09:17.4925389Z +
2026-02-20T22:09:17.4925477Z  # Imports API handlers - Chat
2026-02-20T22:09:17.4925654Z  from server.handlers.chat_handlers import chat_api, chat_api_stream
2026-02-20T22:09:17.4925828Z +
2026-02-20T22:09:17.4925924Z  # Imports API handlers - Exercises
2026-02-20T22:09:17.4926122Z -from server.handlers.exercise_handlers import (generate_ai_exercise_stream,
2026-02-20T22:09:17.4926227Z -                                               generate_exercise,
2026-02-20T22:09:17.4926341Z -                                               generate_exercise_api,
2026-02-20T22:09:17.4926454Z -                                               get_completed_exercises_ids,
2026-02-20T22:09:17.4926560Z -                                               get_exercise, submit_answer,
2026-02-20T22:09:17.4926663Z -                                               get_exercises_list,
2026-02-20T22:09:17.4926774Z -                                               get_exercises_stats)
2026-02-20T22:09:17.4926888Z +from server.handlers.exercise_handlers import (
2026-02-20T22:09:17.4926969Z +    generate_ai_exercise_stream,
2026-02-20T22:09:17.4927046Z +    generate_exercise,
2026-02-20T22:09:17.4927121Z +    generate_exercise_api,
2026-02-20T22:09:17.4927203Z +    get_completed_exercises_ids,
2026-02-20T22:09:17.4927274Z +    get_exercise,
2026-02-20T22:09:17.4927341Z +    submit_answer,
2026-02-20T22:09:17.4927412Z +    get_exercises_list,
2026-02-20T22:09:17.4927485Z +    get_exercises_stats,
2026-02-20T22:09:17.4927552Z +)
2026-02-20T22:09:17.4927610Z +
2026-02-20T22:09:17.4927705Z  # Imports API handlers - Recommendations
2026-02-20T22:09:17.4927931Z -from server.handlers.recommendation_handlers import (generate_recommendations,
2026-02-20T22:09:17.4928046Z -                                                     get_recommendations,
2026-02-20T22:09:17.4928174Z -                                                     handle_recommendation_complete)
2026-02-20T22:09:17.4928313Z +from server.handlers.recommendation_handlers import (
2026-02-20T22:09:17.4928403Z +    generate_recommendations,
2026-02-20T22:09:17.4928479Z +    get_recommendations,
2026-02-20T22:09:17.4928568Z +    handle_recommendation_complete,
2026-02-20T22:09:17.4928638Z +)
2026-02-20T22:09:17.4928698Z +
2026-02-20T22:09:17.4928782Z  # Imports API handlers - Users
2026-02-20T22:09:17.4928986Z -from server.handlers.user_handlers import (create_user_account, get_all_users,
2026-02-20T22:09:17.4929091Z -                                           get_user_stats,
2026-02-20T22:09:17.4929198Z -                                           get_users_leaderboard,
2026-02-20T22:09:17.4929300Z -                                           get_all_user_progress,
2026-02-20T22:09:17.4929425Z -                                           get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4929538Z -                                           get_challenges_progress,
2026-02-20T22:09:17.4929635Z -                                           update_user_me,
2026-02-20T22:09:17.4929745Z -                                           update_user_password_me,
2026-02-20T22:09:17.4929838Z -                                           delete_user,
2026-02-20T22:09:17.4929928Z -                                           delete_user_me,
2026-02-20T22:09:17.4930037Z -                                           export_user_data,
2026-02-20T22:09:17.4930138Z -                                           get_user_sessions,
2026-02-20T22:09:17.4930237Z -                                           revoke_user_session)
2026-02-20T22:09:17.4930338Z +from server.handlers.user_handlers import (
2026-02-20T22:09:17.4930419Z +    create_user_account,
2026-02-20T22:09:17.4930487Z +    get_all_users,
2026-02-20T22:09:17.4930557Z +    get_user_stats,
2026-02-20T22:09:17.4930639Z +    get_users_leaderboard,
2026-02-20T22:09:17.4930713Z +    get_all_user_progress,
2026-02-20T22:09:17.4930889Z +    get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4930968Z +    get_challenges_progress,
2026-02-20T22:09:17.4931043Z +    update_user_me,
2026-02-20T22:09:17.4931120Z +    update_user_password_me,
2026-02-20T22:09:17.4931187Z +    delete_user,
2026-02-20T22:09:17.4931262Z +    delete_user_me,
2026-02-20T22:09:17.4931331Z +    export_user_data,
2026-02-20T22:09:17.4931480Z +    get_user_sessions,
2026-02-20T22:09:17.4931559Z +    revoke_user_session,
2026-02-20T22:09:17.4931621Z +)
2026-02-20T22:09:17.4931680Z  
2026-02-20T22:09:17.4931739Z  
2026-02-20T22:09:17.4931829Z  async def health_handler(request):
2026-02-20T22:09:17.4931981Z      """GET /health - Health check pour Render et load balancers."""
2026-02-20T22:09:17.4932103Z      return PlainTextResponse("ok", status_code=200)
2026-02-20T22:09:17.4932170Z  
2026-02-20T22:09:17.4932230Z  
2026-02-20T22:09:17.4932309Z  async def robots_txt(request):
2026-02-20T22:09:17.4932584Z      """robots.txt - évite les 404 des crawlers sur le backend."""
2026-02-20T22:09:17.4932686Z -    return PlainTextResponse(
2026-02-20T22:09:17.4932779Z -        "User-agent: *\nDisallow: /\n",
2026-02-20T22:09:17.4932863Z -        media_type="text/plain"
2026-02-20T22:09:17.4932926Z -    )
2026-02-20T22:09:17.4933353Z +    return PlainTextResponse("User-agent: *\nDisallow: /\n", media_type="text/plain")
2026-02-20T22:09:17.4933427Z  
2026-02-20T22:09:17.4933486Z  
2026-02-20T22:09:17.4933582Z  async def metrics_handler(request):
2026-02-20T22:09:17.4933841Z      """GET /metrics - métriques Prometheus (p50/p95/p99, taux d'erreur)."""
2026-02-20T22:09:17.4933968Z      from app.core.monitoring import metrics_endpoint
2026-02-20T22:09:17.4934032Z +
2026-02-20T22:09:17.4934124Z      return await metrics_endpoint(request)
2026-02-20T22:09:17.4934184Z  
2026-02-20T22:09:17.4934242Z  
2026-02-20T22:09:17.4934326Z  def get_routes() -> List:
2026-02-20T22:09:17.4934388Z      """
2026-02-20T22:09:17.4934456Z @@ -127,120 +150,257 @@
2026-02-20T22:09:17.4934544Z          # ========================================
2026-02-20T22:09:17.4934626Z          # AUTH API (7 routes)
2026-02-20T22:09:17.4934705Z          # ========================================
2026-02-20T22:09:17.4934866Z          Route("/api/auth/login", endpoint=api_login, methods=["POST"]),
2026-02-20T22:09:17.4935041Z          Route("/api/auth/csrf", endpoint=api_get_csrf_token, methods=["GET"]),
2026-02-20T22:09:17.4935266Z -        Route("/api/auth/validate-token", endpoint=api_validate_token, methods=["POST"]),
2026-02-20T22:09:17.4935330Z +        Route(
2026-02-20T22:09:17.4935528Z +            "/api/auth/validate-token", endpoint=api_validate_token, methods=["POST"]
2026-02-20T22:09:17.4935591Z +        ),
2026-02-20T22:09:17.4935772Z          Route("/api/auth/refresh", endpoint=api_refresh_token, methods=["POST"]),
2026-02-20T22:09:17.4935933Z          Route("/api/auth/logout", endpoint=api_logout, methods=["POST"]),
2026-02-20T22:09:17.4936161Z -        Route("/api/auth/forgot-password", endpoint=api_forgot_password, methods=["POST"]),
2026-02-20T22:09:17.4936378Z -        Route("/api/auth/reset-password", endpoint=api_reset_password, methods=["POST"]),
2026-02-20T22:09:17.4936446Z +        Route(
2026-02-20T22:09:17.4936645Z +            "/api/auth/forgot-password", endpoint=api_forgot_password, methods=["POST"]
2026-02-20T22:09:17.4936706Z +        ),
2026-02-20T22:09:17.4936770Z +        Route(
2026-02-20T22:09:17.4936968Z +            "/api/auth/reset-password", endpoint=api_reset_password, methods=["POST"]
2026-02-20T22:09:17.4937029Z +        ),
2026-02-20T22:09:17.4937212Z          Route("/api/auth/verify-email", endpoint=verify_email, methods=["GET"]),
2026-02-20T22:09:17.4937490Z -        Route("/api/auth/resend-verification", endpoint=resend_verification_email, methods=["POST"]),
2026-02-20T22:09:17.4937554Z -        
2026-02-20T22:09:17.4937616Z +        Route(
2026-02-20T22:09:17.4937723Z +            "/api/auth/resend-verification",
2026-02-20T22:09:17.4937822Z +            endpoint=resend_verification_email,
2026-02-20T22:09:17.4938052Z +            methods=["POST"],
2026-02-20T22:09:17.4938113Z +        ),
2026-02-20T22:09:17.4938204Z          # ========================================
2026-02-20T22:09:17.4938287Z          # USERS API (13 routes)
2026-02-20T22:09:17.4938365Z          # ========================================
2026-02-20T22:09:17.4938633Z          Route("/api/users/", endpoint=get_all_users, methods=["GET"]),
2026-02-20T22:09:17.4938808Z          Route("/api/users/", endpoint=create_user_account, methods=["POST"]),
2026-02-20T22:09:17.4938981Z          Route("/api/users/me", endpoint=api_get_current_user, methods=["GET"]),
2026-02-20T22:09:17.4939142Z          Route("/api/users/me", endpoint=update_user_me, methods=["PUT"]),
2026-02-20T22:09:17.4939363Z -        Route("/api/users/me/password", endpoint=update_user_password_me, methods=["PUT"]),
2026-02-20T22:09:17.4939427Z +        Route(
2026-02-20T22:09:17.4939617Z +            "/api/users/me/password", endpoint=update_user_password_me, methods=["PUT"]
2026-02-20T22:09:17.4939689Z +        ),
2026-02-20T22:09:17.4939852Z          Route("/api/users/me", endpoint=delete_user_me, methods=["DELETE"]),
2026-02-20T22:09:17.4940036Z          Route("/api/users/me/export", endpoint=export_user_data, methods=["GET"]),
2026-02-20T22:09:17.4940230Z          Route("/api/users/me/sessions", endpoint=get_user_sessions, methods=["GET"]),
2026-02-20T22:09:17.4940500Z -        Route("/api/users/me/sessions/{session_id:int}", endpoint=revoke_user_session, methods=["DELETE"]),
2026-02-20T22:09:17.4940703Z -        Route("/api/users/me/progress", endpoint=get_all_user_progress, methods=["GET"]),
2026-02-20T22:09:17.4941016Z -        Route("/api/users/me/progress/{exercise_type}", endpoint=get_user_progress_by_exercise_type, methods=["GET"]),
2026-02-20T22:09:17.4941281Z -        Route("/api/users/me/challenges/progress", endpoint=get_challenges_progress, methods=["GET"]),
2026-02-20T22:09:17.4941346Z +        Route(
2026-02-20T22:09:17.4941465Z +            "/api/users/me/sessions/{session_id:int}",
2026-02-20T22:09:17.4941558Z +            endpoint=revoke_user_session,
2026-02-20T22:09:17.4941636Z +            methods=["DELETE"],
2026-02-20T22:09:17.4941698Z +        ),
2026-02-20T22:09:17.4941766Z +        Route(
2026-02-20T22:09:17.4941954Z +            "/api/users/me/progress", endpoint=get_all_user_progress, methods=["GET"]
2026-02-20T22:09:17.4942018Z +        ),
2026-02-20T22:09:17.4942086Z +        Route(
2026-02-20T22:09:17.4942193Z +            "/api/users/me/progress/{exercise_type}",
2026-02-20T22:09:17.4942306Z +            endpoint=get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4942386Z +            methods=["GET"],
2026-02-20T22:09:17.4942446Z +        ),
2026-02-20T22:09:17.4942528Z +        Route(
2026-02-20T22:09:17.4942628Z +            "/api/users/me/challenges/progress",
2026-02-20T22:09:17.4942728Z +            endpoint=get_challenges_progress,
2026-02-20T22:09:17.4942799Z +            methods=["GET"],
2026-02-20T22:09:17.4942864Z +        ),
2026-02-20T22:09:17.4943225Z          Route("/api/users/stats", endpoint=get_user_stats, methods=["GET"]),
2026-02-20T22:09:17.4943453Z -        Route("/api/users/leaderboard", endpoint=get_users_leaderboard, methods=["GET"]),
2026-02-20T22:09:17.4943517Z +        Route(
2026-02-20T22:09:17.4943703Z +            "/api/users/leaderboard", endpoint=get_users_leaderboard, methods=["GET"]
2026-02-20T22:09:17.4943775Z +        ),
2026-02-20T22:09:17.4943958Z          Route("/api/users/{user_id:int}", endpoint=delete_user, methods=["DELETE"]),
2026-02-20T22:09:17.4944020Z -        
2026-02-20T22:09:17.4944107Z          # ========================================
2026-02-20T22:09:17.4944188Z          # EXERCISES API (9 routes)
2026-02-20T22:09:17.4944266Z          # ========================================
2026-02-20T22:09:17.4944448Z          Route("/api/exercises", endpoint=get_exercises_list, methods=["GET"]),
2026-02-20T22:09:17.4944732Z -        Route("/api/exercises/stats", endpoint=get_exercises_stats, methods=["GET"]),  # Statistiques Holocron
2026-02-20T22:09:17.4945073Z -        Route("/api/exercises/{exercise_id:int}", endpoint=get_exercise, methods=["GET"]),
2026-02-20T22:09:17.4945145Z +        Route(
2026-02-20T22:09:17.4945322Z +            "/api/exercises/stats", endpoint=get_exercises_stats, methods=["GET"]
2026-02-20T22:09:17.4945499Z +        ),  # Statistiques Holocron
2026-02-20T22:09:17.4945566Z +        Route(
2026-02-20T22:09:17.4945760Z +            "/api/exercises/{exercise_id:int}", endpoint=get_exercise, methods=["GET"]
2026-02-20T22:09:17.4945822Z +        ),
2026-02-20T22:09:17.4946020Z          Route("/api/exercises/generate", endpoint=generate_exercise, methods=["GET"]),
2026-02-20T22:09:17.4946249Z -        Route("/api/exercises/generate", endpoint=generate_exercise_api, methods=["POST"]),
2026-02-20T22:09:17.4946526Z -        Route("/api/exercises/generate-ai-stream", endpoint=generate_ai_exercise_stream, methods=["GET"]),
2026-02-20T22:09:17.4946777Z -        Route("/api/exercises/completed-ids", endpoint=get_completed_exercises_ids, methods=["GET"]),
2026-02-20T22:09:17.4947048Z -        Route("/api/exercises/{exercise_id:int}/attempt", endpoint=submit_answer, methods=["POST"]),
2026-02-20T22:09:17.4947113Z -        
2026-02-20T22:09:17.4947176Z +        Route(
2026-02-20T22:09:17.4947374Z +            "/api/exercises/generate", endpoint=generate_exercise_api, methods=["POST"]
2026-02-20T22:09:17.4947438Z +        ),
2026-02-20T22:09:17.4947499Z +        Route(
2026-02-20T22:09:17.4947597Z +            "/api/exercises/generate-ai-stream",
2026-02-20T22:09:17.4947699Z +            endpoint=generate_ai_exercise_stream,
2026-02-20T22:09:17.4947771Z +            methods=["GET"],
2026-02-20T22:09:17.4947831Z +        ),
2026-02-20T22:09:17.4947896Z +        Route(
2026-02-20T22:09:17.4947987Z +            "/api/exercises/completed-ids",
2026-02-20T22:09:17.4948081Z +            endpoint=get_completed_exercises_ids,
2026-02-20T22:09:17.4948150Z +            methods=["GET"],
2026-02-20T22:09:17.4948220Z +        ),
2026-02-20T22:09:17.4948280Z +        Route(
2026-02-20T22:09:17.4948388Z +            "/api/exercises/{exercise_id:int}/attempt",
2026-02-20T22:09:17.4948473Z +            endpoint=submit_answer,
2026-02-20T22:09:17.4948550Z +            methods=["POST"],
2026-02-20T22:09:17.4948611Z +        ),
2026-02-20T22:09:17.4948693Z          # ========================================
2026-02-20T22:09:17.4948774Z          # BADGES API (5 routes)
2026-02-20T22:09:17.4948852Z          # ========================================
2026-02-20T22:09:17.4949019Z          Route("/api/badges/user", endpoint=get_user_badges, methods=["GET"]),
2026-02-20T22:09:17.4949224Z          Route("/api/badges/available", endpoint=get_available_badges, methods=["GET"]),
2026-02-20T22:09:17.4949404Z          Route("/api/badges/check", endpoint=check_user_badges, methods=["POST"]),
2026-02-20T22:09:17.4949611Z -        Route("/api/badges/stats", endpoint=get_user_gamification_stats, methods=["GET"]),
2026-02-20T22:09:17.4949684Z +        Route(
2026-02-20T22:09:17.4949866Z +            "/api/badges/stats", endpoint=get_user_gamification_stats, methods=["GET"]
2026-02-20T22:09:17.4949926Z +        ),
2026-02-20T22:09:17.4950109Z          Route("/api/badges/rarity", endpoint=get_badges_rarity, methods=["GET"]),
2026-02-20T22:09:17.4950298Z          Route("/api/badges/pin", endpoint=patch_pinned_badges, methods=["PATCH"]),
2026-02-20T22:09:17.4950552Z -        Route("/api/challenges/badges/progress", endpoint=get_user_badges_progress, methods=["GET"]),
2026-02-20T22:09:17.4950614Z -        
2026-02-20T22:09:17.4950681Z +        Route(
2026-02-20T22:09:17.4950779Z +            "/api/challenges/badges/progress",
2026-02-20T22:09:17.4950869Z +            endpoint=get_user_badges_progress,
2026-02-20T22:09:17.4950946Z +            methods=["GET"],
2026-02-20T22:09:17.4951008Z +        ),
2026-02-20T22:09:17.4951086Z          # ========================================
2026-02-20T22:09:17.4951338Z          # ADMIN API (rôle archiviste) — Mount pour éviter conflits de routage
2026-02-20T22:09:17.4951546Z          # ========================================
2026-02-20T22:09:17.4951610Z          Mount(
2026-02-20T22:09:17.4951682Z              "/api/admin",
2026-02-20T22:09:17.4951754Z              routes=[
2026-02-20T22:09:17.4951897Z                  Route("/health", endpoint=admin_health, methods=["GET"]),
2026-02-20T22:09:17.4952122Z                  Route("/overview", endpoint=admin_overview, methods=["GET"]),
2026-02-20T22:09:17.4952262Z                  Route("/users", endpoint=admin_users, methods=["GET"]),
2026-02-20T22:09:17.4952463Z -                Route("/users/{user_id:int}", endpoint=admin_users_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4952788Z -                Route("/users/{user_id:int}/send-reset-password", endpoint=admin_users_send_reset_password, methods=["POST"]),
2026-02-20T22:09:17.4953320Z -                Route("/users/{user_id:int}/resend-verification", endpoint=admin_users_resend_verification, methods=["POST"]),
2026-02-20T22:09:17.4953404Z +                Route(
2026-02-20T22:09:17.4953491Z +                    "/users/{user_id:int}",
2026-02-20T22:09:17.4953586Z +                    endpoint=admin_users_patch,
2026-02-20T22:09:17.4953678Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4953743Z +                ),
2026-02-20T22:09:17.4953816Z +                Route(
2026-02-20T22:09:17.4953948Z +                    "/users/{user_id:int}/send-reset-password",
2026-02-20T22:09:17.4954066Z +                    endpoint=admin_users_send_reset_password,
2026-02-20T22:09:17.4954147Z +                    methods=["POST"],
2026-02-20T22:09:17.4954216Z +                ),
2026-02-20T22:09:17.4954283Z +                Route(
2026-02-20T22:09:17.4954395Z +                    "/users/{user_id:int}/resend-verification",
2026-02-20T22:09:17.4954508Z +                    endpoint=admin_users_resend_verification,
2026-02-20T22:09:17.4954592Z +                    methods=["POST"],
2026-02-20T22:09:17.4954658Z +                ),
2026-02-20T22:09:17.4954825Z                  Route("/exercises", endpoint=admin_exercises, methods=["GET"]),
2026-02-20T22:09:17.4955012Z                  Route("/exercises", endpoint=admin_exercises_post, methods=["POST"]),
2026-02-20T22:09:17.4955304Z -                Route("/exercises/{exercise_id:int}/duplicate", endpoint=admin_exercises_duplicate, methods=["POST"]),
2026-02-20T22:09:17.4955535Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercise_get, methods=["GET"]),
2026-02-20T22:09:17.4955769Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercises_put, methods=["PUT"]),
2026-02-20T22:09:17.4956007Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercises_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4956074Z +                Route(
2026-02-20T22:09:17.4956190Z +                    "/exercises/{exercise_id:int}/duplicate",
2026-02-20T22:09:17.4956296Z +                    endpoint=admin_exercises_duplicate,
2026-02-20T22:09:17.4956377Z +                    methods=["POST"],
2026-02-20T22:09:17.4956440Z +                ),
2026-02-20T22:09:17.4956512Z +                Route(
2026-02-20T22:09:17.4956607Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4956700Z +                    endpoint=admin_exercise_get,
2026-02-20T22:09:17.4956793Z +                    methods=["GET"],
2026-02-20T22:09:17.4956855Z +                ),
2026-02-20T22:09:17.4956922Z +                Route(
2026-02-20T22:09:17.4957015Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4957117Z +                    endpoint=admin_exercises_put,
2026-02-20T22:09:17.4957194Z +                    methods=["PUT"],
2026-02-20T22:09:17.4957257Z +                ),
2026-02-20T22:09:17.4957328Z +                Route(
2026-02-20T22:09:17.4957419Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4957511Z +                    endpoint=admin_exercises_patch,
2026-02-20T22:09:17.4957734Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4957798Z +                ),
2026-02-20T22:09:17.4957967Z                  Route("/challenges", endpoint=admin_challenges, methods=["GET"]),
2026-02-20T22:09:17.4958150Z                  Route("/challenges", endpoint=admin_challenges_post, methods=["POST"]),
2026-02-20T22:09:17.4958565Z -                Route("/challenges/{challenge_id:int}/duplicate", endpoint=admin_challenges_duplicate, methods=["POST"]),
2026-02-20T22:09:17.4958799Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenge_get, methods=["GET"]),
2026-02-20T22:09:17.4959035Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenges_put, methods=["PUT"]),
2026-02-20T22:09:17.4959287Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenges_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4959352Z +                Route(
2026-02-20T22:09:17.4959466Z +                    "/challenges/{challenge_id:int}/duplicate",
2026-02-20T22:09:17.4959580Z +                    endpoint=admin_challenges_duplicate,
2026-02-20T22:09:17.4959657Z +                    methods=["POST"],
2026-02-20T22:09:17.4959718Z +                ),
2026-02-20T22:09:17.4959786Z +                Route(
2026-02-20T22:09:17.4959885Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4959984Z +                    endpoint=admin_challenge_get,
2026-02-20T22:09:17.4960060Z +                    methods=["GET"],
2026-02-20T22:09:17.4960126Z +                ),
2026-02-20T22:09:17.4960189Z +                Route(
2026-02-20T22:09:17.4960282Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4960380Z +                    endpoint=admin_challenges_put,
2026-02-20T22:09:17.4960458Z +                    methods=["PUT"],
2026-02-20T22:09:17.4960518Z +                ),
2026-02-20T22:09:17.4960588Z +                Route(
2026-02-20T22:09:17.4960682Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4960782Z +                    endpoint=admin_challenges_patch,
2026-02-20T22:09:17.4960859Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4960926Z +                ),
2026-02-20T22:09:17.4961075Z                  Route("/reports", endpoint=admin_reports, methods=["GET"]),
2026-02-20T22:09:17.4961233Z                  Route("/audit-log", endpoint=admin_audit_log, methods=["GET"]),
2026-02-20T22:09:17.4961415Z                  Route("/moderation", endpoint=admin_moderation, methods=["GET"]),
2026-02-20T22:09:17.4961570Z                  Route("/config", endpoint=admin_config_get, methods=["GET"]),
2026-02-20T22:09:17.4961717Z                  Route("/config", endpoint=admin_config_put, methods=["PUT"]),
2026-02-20T22:09:17.4961864Z                  Route("/export", endpoint=admin_export, methods=["GET"]),
2026-02-20T22:09:17.4961946Z                  # Lot B-1 : CRUD badges
2026-02-20T22:09:17.4962082Z                  Route("/badges", endpoint=admin_badges, methods=["GET"]),
2026-02-20T22:09:17.4962239Z                  Route("/badges", endpoint=admin_badges_post, methods=["POST"]),
2026-02-20T22:09:17.4962439Z -                Route("/badges/{badge_id:int}", endpoint=admin_badge_get, methods=["GET"]),
2026-02-20T22:09:17.4962633Z -                Route("/badges/{badge_id:int}", endpoint=admin_badges_put, methods=["PUT"]),
2026-02-20T22:09:17.4962853Z -                Route("/badges/{badge_id:int}", endpoint=admin_badges_delete, methods=["DELETE"]),
2026-02-20T22:09:17.4962927Z +                Route(
2026-02-20T22:09:17.4963414Z +                    "/badges/{badge_id:int}", endpoint=admin_badge_get, methods=["GET"]
2026-02-20T22:09:17.4963492Z +                ),
2026-02-20T22:09:17.4963564Z +                Route(
2026-02-20T22:09:17.4963737Z +                    "/badges/{badge_id:int}", endpoint=admin_badges_put, methods=["PUT"]
2026-02-20T22:09:17.4963800Z +                ),
2026-02-20T22:09:17.4963870Z +                Route(
2026-02-20T22:09:17.4963960Z +                    "/badges/{badge_id:int}",
2026-02-20T22:09:17.4964201Z +                    endpoint=admin_badges_delete,
2026-02-20T22:09:17.4964282Z +                    methods=["DELETE"],
2026-02-20T22:09:17.4964349Z +                ),
2026-02-20T22:09:17.4964411Z              ],
2026-02-20T22:09:17.4964471Z          ),
2026-02-20T22:09:17.4964538Z -        
2026-02-20T22:09:17.4964723Z          # ========================================
2026-02-20T22:09:17.4964814Z          # RECOMMENDATIONS API (3 routes)
2026-02-20T22:09:17.4964895Z          # ========================================
2026-02-20T22:09:17.4965109Z          Route("/api/recommendations", endpoint=get_recommendations, methods=["GET"]),
2026-02-20T22:09:17.4965367Z -        Route("/api/recommendations/generate", endpoint=generate_recommendations, methods=["POST"]),
2026-02-20T22:09:17.4965647Z -        Route("/api/recommendations/complete", endpoint=handle_recommendation_complete, methods=["POST"]),
2026-02-20T22:09:17.4965716Z -        
2026-02-20T22:09:17.4965783Z +        Route(
2026-02-20T22:09:17.4965877Z +            "/api/recommendations/generate",
2026-02-20T22:09:17.4965980Z +            endpoint=generate_recommendations,
2026-02-20T22:09:17.4966056Z +            methods=["POST"],
2026-02-20T22:09:17.4966117Z +        ),
2026-02-20T22:09:17.4966183Z +        Route(
2026-02-20T22:09:17.4966286Z +            "/api/recommendations/complete",
2026-02-20T22:09:17.4966390Z +            endpoint=handle_recommendation_complete,
2026-02-20T22:09:17.4966463Z +            methods=["POST"],
2026-02-20T22:09:17.4966528Z +        ),
2026-02-20T22:09:17.4966607Z          # ========================================
2026-02-20T22:09:17.4966679Z          # CHAT API (2 routes)
2026-02-20T22:09:17.4966755Z          # ========================================
2026-02-20T22:09:17.4966895Z          Route("/api/chat", endpoint=chat_api, methods=["POST"]),
2026-02-20T22:09:17.4967069Z          Route("/api/chat/stream", endpoint=chat_api_stream, methods=["POST"]),
2026-02-20T22:09:17.4967136Z -        
2026-02-20T22:09:17.4967219Z          # ========================================
2026-02-20T22:09:17.4967449Z          # CHALLENGES API (10 routes) ⚠️ CRITIQUE pour Next.js
2026-02-20T22:09:17.4967530Z          # ========================================
2026-02-20T22:09:17.4967721Z          Route("/api/challenges", endpoint=get_challenges_list, methods=["GET"]),
2026-02-20T22:09:17.4967952Z -        Route("/api/challenges/{challenge_id:int}", endpoint=get_challenge, methods=["GET"]),
2026-02-20T22:09:17.4968241Z -        Route("/api/challenges/{challenge_id:int}/attempt", endpoint=submit_challenge_answer, methods=["POST"]),
2026-02-20T22:09:17.4968500Z -        Route("/api/challenges/{challenge_id:int}/hint", endpoint=get_challenge_hint, methods=["GET"]),
2026-02-20T22:09:17.4968760Z -        Route("/api/challenges/completed-ids", endpoint=get_completed_challenges_ids, methods=["GET"]),
2026-02-20T22:09:17.4969011Z -        Route("/api/challenges/start/{challenge_id:int}", endpoint=start_challenge, methods=["POST"]),
2026-02-20T22:09:17.4969305Z -        Route("/api/challenges/progress/{challenge_id:int}", endpoint=get_challenge_progress, methods=["GET"]),
2026-02-20T22:09:17.4969579Z -        Route("/api/challenges/rewards/{challenge_id:int}", endpoint=get_challenge_rewards, methods=["GET"]),
2026-02-20T22:09:17.4969860Z -        Route("/api/challenges/generate-ai-stream", endpoint=generate_ai_challenge_stream, methods=["GET"]),
2026-02-20T22:09:17.4969935Z +        Route(
2026-02-20T22:09:17.4970032Z +            "/api/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4970115Z +            endpoint=get_challenge,
2026-02-20T22:09:17.4970192Z +            methods=["GET"],
2026-02-20T22:09:17.4970264Z +        ),
2026-02-20T22:09:17.4970326Z +        Route(
2026-02-20T22:09:17.4970438Z +            "/api/challenges/{challenge_id:int}/attempt",
2026-02-20T22:09:17.4970536Z +            endpoint=submit_challenge_answer,
2026-02-20T22:09:17.4970611Z +            methods=["POST"],
2026-02-20T22:09:17.4970756Z +        ),
2026-02-20T22:09:17.4970818Z +        Route(
2026-02-20T22:09:17.4970930Z +            "/api/challenges/{challenge_id:int}/hint",
2026-02-20T22:09:17.4971018Z +            endpoint=get_challenge_hint,
2026-02-20T22:09:17.4971091Z +            methods=["GET"],
2026-02-20T22:09:17.4971158Z +        ),
2026-02-20T22:09:17.4971291Z +        Route(
2026-02-20T22:09:17.4971385Z +            "/api/challenges/completed-ids",
2026-02-20T22:09:17.4971484Z +            endpoint=get_completed_challenges_ids,
2026-02-20T22:09:17.4971560Z +            methods=["GET"],
2026-02-20T22:09:17.4971621Z +        ),
2026-02-20T22:09:17.4971682Z +        Route(
2026-02-20T22:09:17.4971794Z +            "/api/challenges/start/{challenge_id:int}",
2026-02-20T22:09:17.4971875Z +            endpoint=start_challenge,
2026-02-20T22:09:17.4971946Z +            methods=["POST"],
2026-02-20T22:09:17.4972011Z +        ),
2026-02-20T22:09:17.4972072Z +        Route(
2026-02-20T22:09:17.4972190Z +            "/api/challenges/progress/{challenge_id:int}",
2026-02-20T22:09:17.4972284Z +            endpoint=get_challenge_progress,
2026-02-20T22:09:17.4972361Z +            methods=["GET"],
2026-02-20T22:09:17.4972421Z +        ),
2026-02-20T22:09:17.4972482Z +        Route(
2026-02-20T22:09:17.4972594Z +            "/api/challenges/rewards/{challenge_id:int}",
2026-02-20T22:09:17.4972687Z +            endpoint=get_challenge_rewards,
2026-02-20T22:09:17.4972758Z +            methods=["GET"],
2026-02-20T22:09:17.4972817Z +        ),
2026-02-20T22:09:17.4972884Z +        Route(
2026-02-20T22:09:17.4973188Z +            "/api/challenges/generate-ai-stream",
2026-02-20T22:09:17.4973358Z +            endpoint=generate_ai_challenge_stream,
2026-02-20T22:09:17.4973489Z +            methods=["GET"],
2026-02-20T22:09:17.4973592Z +        ),
2026-02-20T22:09:17.4973656Z      ]
2026-02-20T22:09:17.4973897Z would reformat /home/runner/work/mathakine/mathakine/server/routes.py
2026-02-20T22:09:17.5468304Z --- /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.5469724Z +++ /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py	2026-02-20 22:09:17.535433+00:00
2026-02-20T22:09:17.5470569Z @@ -1,479 +1,600 @@
2026-02-20T22:09:17.5471116Z  """
2026-02-20T22:09:17.5471705Z  Handlers pour la génération d'exercices (API)
2026-02-20T22:09:17.5472207Z  """
2026-02-20T22:09:17.5472454Z +
2026-02-20T22:09:17.5472758Z  import json
2026-02-20T22:09:17.5473331Z  import traceback
2026-02-20T22:09:17.5473661Z  
2026-02-20T22:09:17.5474000Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.5474422Z  
2026-02-20T22:09:17.5474666Z  logger = get_logger(__name__)
2026-02-20T22:09:17.5475038Z  from starlette.requests import Request
2026-02-20T22:09:17.5475606Z -from starlette.responses import (JSONResponse, RedirectResponse,
2026-02-20T22:09:17.5476225Z -                                 StreamingResponse)
2026-02-20T22:09:17.5476944Z +from starlette.responses import JSONResponse, RedirectResponse, StreamingResponse
2026-02-20T22:09:17.5477613Z  
2026-02-20T22:09:17.5477910Z  from app.core.config import settings
2026-02-20T22:09:17.5478343Z  from app.core.ai_config import AIConfig
2026-02-20T22:09:17.5478796Z  from app.core.messages import SystemMessages
2026-02-20T22:09:17.5479290Z  from app.models.exercise import ExerciseType
2026-02-20T22:09:17.5479750Z +
2026-02-20T22:09:17.5480035Z  # Import du service de badges
2026-02-20T22:09:17.5480541Z  from app.services.badge_service import BadgeService
2026-02-20T22:09:17.5481086Z  from app.utils.db_utils import db_session
2026-02-20T22:09:17.5481758Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:17.5482590Z  from app.utils.error_handler import ErrorHandler, get_safe_error_message
2026-02-20T22:09:17.5483529Z  from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:17.5483967Z -from server.exercise_generator import (ensure_explanation,
2026-02-20T22:09:17.5485058Z -                                       generate_ai_exercise,
2026-02-20T22:09:17.5485529Z -                                       generate_simple_exercise)
2026-02-20T22:09:17.5485835Z +from server.exercise_generator import (
2026-02-20T22:09:17.5486088Z +    ensure_explanation,
2026-02-20T22:09:17.5486298Z +    generate_ai_exercise,
2026-02-20T22:09:17.5486666Z +    generate_simple_exercise,
2026-02-20T22:09:17.5486873Z +)
2026-02-20T22:09:17.5487020Z  
2026-02-20T22:09:17.5487156Z  
2026-02-20T22:09:17.5487326Z  async def generate_exercise(request):
2026-02-20T22:09:17.5487799Z      """Génère un nouvel exercice en utilisant le groupe d'âge."""
2026-02-20T22:09:17.5488136Z      params = request.query_params
2026-02-20T22:09:17.5488490Z -    exercise_type_raw = params.get('type') or params.get('exercise_type')
2026-02-20T22:09:17.5488923Z -    age_group_raw = params.get('age_group') # Changed from difficulty
2026-02-20T22:09:17.5489264Z -    use_ai = params.get('ai', False)
2026-02-20T22:09:17.5489494Z -    
2026-02-20T22:09:17.5489757Z +    exercise_type_raw = params.get("type") or params.get("exercise_type")
2026-02-20T22:09:17.5490178Z +    age_group_raw = params.get("age_group")  # Changed from difficulty
2026-02-20T22:09:17.5490513Z +    use_ai = params.get("ai", False)
2026-02-20T22:09:17.5490734Z +
2026-02-20T22:09:17.5490963Z      # Normaliser et valider les paramètres
2026-02-20T22:09:17.5491243Z -    from server.exercise_generator import \
2026-02-20T22:09:17.5491519Z -        normalize_and_validate_exercise_params
2026-02-20T22:09:17.5491765Z -    
2026-02-20T22:09:17.5492190Z -    exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5492703Z -    
2026-02-20T22:09:17.5493196Z +    from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5493573Z +
2026-02-20T22:09:17.5493777Z +    exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5494169Z +        normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5494521Z +    )
2026-02-20T22:09:17.5494663Z +
2026-02-20T22:09:17.5494820Z      ai_generated = False
2026-02-20T22:09:17.5495091Z -    if use_ai and str(use_ai).lower() in ['true', '1', 'yes', 'y']:
2026-02-20T22:09:17.5495463Z +    if use_ai and str(use_ai).lower() in ["true", "1", "yes", "y"]:
2026-02-20T22:09:17.5495857Z          exercise_dict = generate_ai_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5496175Z          ai_generated = True
2026-02-20T22:09:17.5496378Z      else:
2026-02-20T22:09:17.5496630Z          exercise_dict = generate_simple_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5496951Z -        
2026-02-20T22:09:17.5497098Z +
2026-02-20T22:09:17.5497298Z      exercise_dict = ensure_explanation(exercise_dict)
2026-02-20T22:09:17.5497744Z      logger.debug(f"Explication générée: {exercise_dict['explanation']}")
2026-02-20T22:09:17.5498075Z      try:
2026-02-20T22:09:17.5498246Z          # Extraire la locale
2026-02-20T22:09:17.5498531Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5498825Z +
2026-02-20T22:09:17.5499052Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5499422Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5499706Z -        
2026-02-20T22:09:17.5499858Z +
2026-02-20T22:09:17.5500045Z          async with db_session() as db:
2026-02-20T22:09:17.5500443Z              # Sauvegarder l'exercice avec age_group et la difficulté dérivée
2026-02-20T22:09:17.5500885Z              created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5501237Z                  db=db,
2026-02-20T22:09:17.5501477Z -                exercise_type=exercise_dict['exercise_type'],
2026-02-20T22:09:17.5501821Z -                age_group=exercise_dict['age_group'], # Save age_group
2026-02-20T22:09:17.5502227Z -                difficulty=exercise_dict['difficulty'], # Save derived difficulty
2026-02-20T22:09:17.5502748Z -                title=exercise_dict['title'],
2026-02-20T22:09:17.5503205Z -                question=exercise_dict['question'],
2026-02-20T22:09:17.5503522Z -                correct_answer=exercise_dict['correct_answer'],
2026-02-20T22:09:17.5503830Z -                choices=exercise_dict['choices'],
2026-02-20T22:09:17.5504256Z -                explanation=exercise_dict['explanation'],
2026-02-20T22:09:17.5504547Z -                hint=exercise_dict.get('hint'),
2026-02-20T22:09:17.5504837Z -                tags=exercise_dict.get('tags', 'generated'),
2026-02-20T22:09:17.5505154Z +                exercise_type=exercise_dict["exercise_type"],
2026-02-20T22:09:17.5505497Z +                age_group=exercise_dict["age_group"],  # Save age_group
2026-02-20T22:09:17.5505896Z +                difficulty=exercise_dict["difficulty"],  # Save derived difficulty
2026-02-20T22:09:17.5506263Z +                title=exercise_dict["title"],
2026-02-20T22:09:17.5506539Z +                question=exercise_dict["question"],
2026-02-20T22:09:17.5506838Z +                correct_answer=exercise_dict["correct_answer"],
2026-02-20T22:09:17.5507138Z +                choices=exercise_dict["choices"],
2026-02-20T22:09:17.5507421Z +                explanation=exercise_dict["explanation"],
2026-02-20T22:09:17.5507714Z +                hint=exercise_dict.get("hint"),
2026-02-20T22:09:17.5507996Z +                tags=exercise_dict.get("tags", "generated"),
2026-02-20T22:09:17.5508281Z                  ai_generated=ai_generated,
2026-02-20T22:09:17.5508528Z -                locale=locale
2026-02-20T22:09:17.5508733Z +                locale=locale,
2026-02-20T22:09:17.5508934Z              )
2026-02-20T22:09:17.5509107Z              if created_exercise:
2026-02-20T22:09:17.5509351Z -                exercise_id = created_exercise['id']
2026-02-20T22:09:17.5509626Z +                exercise_id = created_exercise["id"]
2026-02-20T22:09:17.5510028Z                  logger.info(f"Nouvel exercice créé avec ID={exercise_id}")
2026-02-20T22:09:17.5510432Z                  logger.debug(f"Explication: {exercise_dict['explanation']}")
2026-02-20T22:09:17.5510751Z              else:
2026-02-20T22:09:17.5511042Z                  logger.error("Erreur: L'exercice n'a pas été créé")
2026-02-20T22:09:17.5511373Z                  templates = request.app.state.templates
2026-02-20T22:09:17.5511713Z -                return templates.TemplateResponse("error.html", {
2026-02-20T22:09:17.5512013Z -                    "request": request,
2026-02-20T22:09:17.5512318Z -                    "error": "Erreur de génération",
2026-02-20T22:09:17.5512744Z -                    "message": "Impossible de créer l'exercice dans la base de données."
2026-02-20T22:09:17.5513393Z -                }, status_code=500)
2026-02-20T22:09:17.5513676Z +                return templates.TemplateResponse(
2026-02-20T22:09:17.5513952Z +                    "error.html",
2026-02-20T22:09:17.5514171Z +                    {
2026-02-20T22:09:17.5514374Z +                        "request": request,
2026-02-20T22:09:17.5514700Z +                        "error": "Erreur de génération",
2026-02-20T22:09:17.5515144Z +                        "message": "Impossible de créer l'exercice dans la base de données.",
2026-02-20T22:09:17.5515503Z +                    },
2026-02-20T22:09:17.5515708Z +                    status_code=500,
2026-02-20T22:09:17.5515924Z +                )
2026-02-20T22:09:17.5516228Z          return RedirectResponse(url="/exercises?generated=true", status_code=303)
2026-02-20T22:09:17.5516630Z      except Exception as exercise_generation_error:
2026-02-20T22:09:17.5517123Z -        logger.error(f"Erreur lors de la génération d'exercice: {exercise_generation_error}")
2026-02-20T22:09:17.5517517Z +        logger.error(
2026-02-20T22:09:17.5517877Z +            f"Erreur lors de la génération d'exercice: {exercise_generation_error}"
2026-02-20T22:09:17.5518212Z +        )
2026-02-20T22:09:17.5518403Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5518844Z          templates = request.app.state.templates
2026-02-20T22:09:17.5519161Z -        return templates.TemplateResponse("error.html", {
2026-02-20T22:09:17.5519462Z -            "request": request,
2026-02-20T22:09:17.5519737Z -            "error": "Erreur de génération",
2026-02-20T22:09:17.5520300Z -            "message": f"Impossible de générer l'exercice: {str(exercise_generation_error)}"
2026-02-20T22:09:17.5520680Z -        }, status_code=500)
2026-02-20T22:09:17.5520924Z +        return templates.TemplateResponse(
2026-02-20T22:09:17.5521183Z +            "error.html",
2026-02-20T22:09:17.5521370Z +            {
2026-02-20T22:09:17.5521550Z +                "request": request,
2026-02-20T22:09:17.5521837Z +                "error": "Erreur de génération",
2026-02-20T22:09:17.5522302Z +                "message": f"Impossible de générer l'exercice: {str(exercise_generation_error)}",
2026-02-20T22:09:17.5522670Z +            },
2026-02-20T22:09:17.5522855Z +            status_code=500,
2026-02-20T22:09:17.5523260Z +        )
2026-02-20T22:09:17.5523424Z +
2026-02-20T22:09:17.5523565Z  
2026-02-20T22:09:17.5523724Z  async def get_exercise(request):
2026-02-20T22:09:17.5524109Z      """Récupère un exercice par son ID avec support des traductions"""
2026-02-20T22:09:17.5524497Z -    exercise_id = request.path_params.get('exercise_id')
2026-02-20T22:09:17.5524847Z +    exercise_id = request.path_params.get("exercise_id")
2026-02-20T22:09:17.5525112Z  
2026-02-20T22:09:17.5525254Z      try:
2026-02-20T22:09:17.5525473Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5525838Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5526127Z +
2026-02-20T22:09:17.5526359Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5526727Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5527006Z -        
2026-02-20T22:09:17.5527168Z +
2026-02-20T22:09:17.5527347Z          # Utiliser le service ORM ExerciseService
2026-02-20T22:09:17.5527627Z          async with db_session() as db:
2026-02-20T22:09:17.5527898Z              from app.models.exercise import Exercise
2026-02-20T22:09:17.5528220Z              from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:17.5528529Z              from sqlalchemy import String, cast
2026-02-20T22:09:17.5528776Z  
2026-02-20T22:09:17.5529170Z              # IMPORTANT: Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:17.5529834Z              # SQLAlchemy essaie de convertir automatiquement et échoue si la DB contient des minuscules
2026-02-20T22:09:17.5530457Z              # Solution: Utiliser cast() pour forcer le chargement en string dès le début
2026-02-20T22:09:17.5530833Z -            exercise_row = db.query(
2026-02-20T22:09:17.5531074Z -                Exercise.id,
2026-02-20T22:09:17.5531285Z -                Exercise.title,
2026-02-20T22:09:17.5531518Z -                Exercise.question,
2026-02-20T22:09:17.5531757Z -                Exercise.correct_answer,
2026-02-20T22:09:17.5532004Z -                Exercise.choices,
2026-02-20T22:09:17.5532241Z -                Exercise.explanation,
2026-02-20T22:09:17.5532475Z -                Exercise.hint,
2026-02-20T22:09:17.5532689Z -                Exercise.tags,
2026-02-20T22:09:17.5532907Z -                Exercise.ai_generated,
2026-02-20T22:09:17.5533390Z -                Exercise.age_group,
2026-02-20T22:09:17.5533719Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5534143Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:17.5534500Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:17.5534762Z -            
2026-02-20T22:09:17.5534942Z +            exercise_row = (
2026-02-20T22:09:17.5535144Z +                db.query(
2026-02-20T22:09:17.5535348Z +                    Exercise.id,
2026-02-20T22:09:17.5535711Z +                    Exercise.title,
2026-02-20T22:09:17.5535948Z +                    Exercise.question,
2026-02-20T22:09:17.5536193Z +                    Exercise.correct_answer,
2026-02-20T22:09:17.5536445Z +                    Exercise.choices,
2026-02-20T22:09:17.5536688Z +                    Exercise.explanation,
2026-02-20T22:09:17.5537035Z +                    Exercise.hint,
2026-02-20T22:09:17.5537267Z +                    Exercise.tags,
2026-02-20T22:09:17.5537494Z +                    Exercise.ai_generated,
2026-02-20T22:09:17.5537739Z +                    Exercise.age_group,
2026-02-20T22:09:17.5538075Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5538518Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5538840Z +                )
2026-02-20T22:09:17.5539043Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:17.5539300Z +                .first()
2026-02-20T22:09:17.5539484Z +            )
2026-02-20T22:09:17.5539641Z +
2026-02-20T22:09:17.5539792Z              if not exercise_row:
2026-02-20T22:09:17.5540213Z -                return ErrorHandler.create_not_found_error(resource_type="Exercice", resource_id=exercise_id)
2026-02-20T22:09:17.5540644Z -            
2026-02-20T22:09:17.5540863Z +                return ErrorHandler.create_not_found_error(
2026-02-20T22:09:17.5541192Z +                    resource_type="Exercice", resource_id=exercise_id
2026-02-20T22:09:17.5541475Z +                )
2026-02-20T22:09:17.5541637Z +
2026-02-20T22:09:17.5541785Z              exercise = {
2026-02-20T22:09:17.5541989Z                  "id": exercise_row.id,
2026-02-20T22:09:17.5542227Z                  "title": exercise_row.title,
2026-02-20T22:09:17.5542715Z -                "exercise_type": exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION",
2026-02-20T22:09:17.5543651Z -                "difficulty": exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN",
2026-02-20T22:09:17.5544116Z +                "exercise_type": (
2026-02-20T22:09:17.5544379Z +                    exercise_row.exercise_type_str.upper()
2026-02-20T22:09:17.5544675Z +                    if exercise_row.exercise_type_str
2026-02-20T22:09:17.5544938Z +                    else "ADDITION"
2026-02-20T22:09:17.5545153Z +                ),
2026-02-20T22:09:17.5545338Z +                "difficulty": (
2026-02-20T22:09:17.5545580Z +                    exercise_row.difficulty_str.upper()
2026-02-20T22:09:17.5545864Z +                    if exercise_row.difficulty_str
2026-02-20T22:09:17.5546119Z +                    else "PADAWAN"
2026-02-20T22:09:17.5546333Z +                ),
2026-02-20T22:09:17.5546536Z                  "age_group": exercise_row.age_group,
2026-02-20T22:09:17.5546807Z                  "question": exercise_row.question,
2026-02-20T22:09:17.5547377Z                  # correct_answer volontairement omis pour éviter la triche (renvoyé uniquement après soumission)
2026-02-20T22:09:17.5547894Z                  "choices": safe_parse_json(exercise_row.choices, []),
2026-02-20T22:09:17.5548233Z                  "explanation": exercise_row.explanation,
2026-02-20T22:09:17.5548510Z                  "hint": exercise_row.hint,
2026-02-20T22:09:17.5548797Z                  "tags": safe_parse_json(exercise_row.tags, []),
2026-02-20T22:09:17.5549136Z -                "ai_generated": exercise_row.ai_generated or False
2026-02-20T22:09:17.5549487Z +                "ai_generated": exercise_row.ai_generated or False,
2026-02-20T22:09:17.5549771Z              }
2026-02-20T22:09:17.5549929Z -        
2026-02-20T22:09:17.5550081Z +
2026-02-20T22:09:17.5550232Z          if not exercise:
2026-02-20T22:09:17.5550610Z -            return JSONResponse({"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404)
2026-02-20T22:09:17.5551024Z -                
2026-02-20T22:09:17.5551213Z +            return JSONResponse(
2026-02-20T22:09:17.5551677Z +                {"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404
2026-02-20T22:09:17.5552012Z +            )
2026-02-20T22:09:17.5552174Z +
2026-02-20T22:09:17.5552339Z          return JSONResponse(exercise)
2026-02-20T22:09:17.5552563Z -    
2026-02-20T22:09:17.5552708Z +
2026-02-20T22:09:17.5552899Z      except Exception as exercise_retrieval_error:
2026-02-20T22:09:17.5553645Z -        logger.error(f"Erreur lors de la récupération de l'exercice: {exercise_retrieval_error}")
2026-02-20T22:09:17.5554056Z +        logger.error(
2026-02-20T22:09:17.5554420Z +            f"Erreur lors de la récupération de l'exercice: {exercise_retrieval_error}"
2026-02-20T22:09:17.5554766Z +        )
2026-02-20T22:09:17.5554955Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5555674Z -        return ErrorHandler.create_error_response(exercise_retrieval_error, status_code=500, user_message="Erreur lors de la récupération de l'exercice")
2026-02-20T22:09:17.5556323Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5556597Z +            exercise_retrieval_error,
2026-02-20T22:09:17.5556832Z +            status_code=500,
2026-02-20T22:09:17.5557175Z +            user_message="Erreur lors de la récupération de l'exercice",
2026-02-20T22:09:17.5557480Z +        )
2026-02-20T22:09:17.5557633Z +
2026-02-20T22:09:17.5557777Z  
2026-02-20T22:09:17.5557923Z  @require_auth
2026-02-20T22:09:17.5558103Z  async def submit_answer(request):
2026-02-20T22:09:17.5558431Z      """Traite la soumission d'une réponse à un exercice"""
2026-02-20T22:09:17.5558704Z      try:
2026-02-20T22:09:17.5558987Z          # Utilisateur authentifié via le décorateur @require_auth
2026-02-20T22:09:17.5559306Z          current_user = request.state.user
2026-02-20T22:09:17.5559543Z -        
2026-02-20T22:09:17.5572309Z +
2026-02-20T22:09:17.5572688Z          # Récupérer les données de la requête
2026-02-20T22:09:17.5573147Z          data = await request.json()
2026-02-20T22:09:17.5573612Z -        exercise_id = int(request.path_params.get('exercise_id')) # Get from path_params
2026-02-20T22:09:17.5574175Z -        selected_answer = data.get('answer') or data.get('selected_answer')  # Support both formats
2026-02-20T22:09:17.5574638Z -        time_spent = data.get('time_spent', 0)
2026-02-20T22:09:17.5575153Z -        user_id = current_user.get('id', 1)  # Utiliser l'ID de l'utilisateur authentifié
2026-02-20T22:09:17.5575545Z +        exercise_id = int(
2026-02-20T22:09:17.5575787Z +            request.path_params.get("exercise_id")
2026-02-20T22:09:17.5576055Z +        )  # Get from path_params
2026-02-20T22:09:17.5576326Z +        selected_answer = data.get("answer") or data.get(
2026-02-20T22:09:17.5576612Z +            "selected_answer"
2026-02-20T22:09:17.5576824Z +        )  # Support both formats
2026-02-20T22:09:17.5577061Z +        time_spent = data.get("time_spent", 0)
2026-02-20T22:09:17.5577325Z +        user_id = current_user.get(
2026-02-20T22:09:17.5577545Z +            "id", 1
2026-02-20T22:09:17.5577804Z +        )  # Utiliser l'ID de l'utilisateur authentifié
2026-02-20T22:09:17.5578065Z  
2026-02-20T22:09:17.5578276Z          # Valider les paramètres requis
2026-02-20T22:09:17.5578804Z          # exercise_id est maintenant garanti par le path_params, donc pas besoin de vérifier s'il est None
2026-02-20T22:09:17.5579240Z -        
2026-02-20T22:09:17.5579393Z +
2026-02-20T22:09:17.5579547Z          if selected_answer is None:
2026-02-20T22:09:17.5579786Z -            return JSONResponse(
2026-02-20T22:09:17.5580085Z -                {"error": "La réponse est requise."},
2026-02-20T22:09:17.5580362Z -                status_code=400
2026-02-20T22:09:17.5580563Z -            )
2026-02-20T22:09:17.5580728Z -
2026-02-20T22:09:17.5581190Z -        logger.debug(f"Traitement de la réponse: exercise_id={exercise_id}, selected_answer={selected_answer}")
2026-02-20T22:09:17.5581839Z +            return JSONResponse({"error": "La réponse est requise."}, status_code=400)
2026-02-20T22:09:17.5582392Z +
2026-02-20T22:09:17.5582537Z +        logger.debug(
2026-02-20T22:09:17.5583095Z +            f"Traitement de la réponse: exercise_id={exercise_id}, selected_answer={selected_answer}"
2026-02-20T22:09:17.5583512Z +        )
2026-02-20T22:09:17.5583669Z  
2026-02-20T22:09:17.5583880Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5584389Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5584689Z +
2026-02-20T22:09:17.5584915Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5585285Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5585567Z -        
2026-02-20T22:09:17.5585724Z +
2026-02-20T22:09:17.5586058Z          # Utiliser le service ORM ExerciseService (une seule session pour lecture + tentative + badges)
2026-02-20T22:09:17.5586499Z          async with db_session() as db:
2026-02-20T22:09:17.5586764Z              from sqlalchemy import String, cast
2026-02-20T22:09:17.5587009Z  
2026-02-20T22:09:17.5587248Z -            from app.models.exercise import (DifficultyLevel, Exercise,
2026-02-20T22:09:17.5587596Z -                                             ExerciseType)
2026-02-20T22:09:17.5587981Z +            from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:17.5588332Z  
2026-02-20T22:09:17.5588721Z              # IMPORTANT: Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:17.5589131Z -            exercise_row = db.query(
2026-02-20T22:09:17.5589366Z -                Exercise.id,
2026-02-20T22:09:17.5589582Z -                Exercise.question,
2026-02-20T22:09:17.5589814Z -                Exercise.correct_answer,
2026-02-20T22:09:17.5590058Z -                Exercise.choices,
2026-02-20T22:09:17.5590286Z -                Exercise.explanation,
2026-02-20T22:09:17.5590619Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5591039Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:17.5591397Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:17.5591662Z -            
2026-02-20T22:09:17.5591861Z +            exercise_row = (
2026-02-20T22:09:17.5592071Z +                db.query(
2026-02-20T22:09:17.5592269Z +                    Exercise.id,
2026-02-20T22:09:17.5592493Z +                    Exercise.question,
2026-02-20T22:09:17.5592733Z +                    Exercise.correct_answer,
2026-02-20T22:09:17.5593173Z +                    Exercise.choices,
2026-02-20T22:09:17.5593455Z +                    Exercise.explanation,
2026-02-20T22:09:17.5593803Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5594239Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5594561Z +                )
2026-02-20T22:09:17.5594771Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:17.5595024Z +                .first()
2026-02-20T22:09:17.5595206Z +            )
2026-02-20T22:09:17.5595359Z +
2026-02-20T22:09:17.5595512Z              if not exercise_row:
2026-02-20T22:09:17.5595909Z -                return JSONResponse({"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404)
2026-02-20T22:09:17.5596333Z -            
2026-02-20T22:09:17.5596514Z +                return JSONResponse(
2026-02-20T22:09:17.5596844Z +                    {"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404
2026-02-20T22:09:17.5597188Z +                )
2026-02-20T22:09:17.5597348Z +
2026-02-20T22:09:17.5597534Z              # Normaliser les valeurs enum en majuscules
2026-02-20T22:09:17.5598059Z -            exercise_type_normalized = exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION"
2026-02-20T22:09:17.5598809Z -            difficulty_normalized = exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN"
2026-02-20T22:09:17.5599414Z -            
2026-02-20T22:09:17.5599587Z +            exercise_type_normalized = (
2026-02-20T22:09:17.5599864Z +                exercise_row.exercise_type_str.upper()
2026-02-20T22:09:17.5600183Z +                if exercise_row.exercise_type_str
2026-02-20T22:09:17.5600446Z +                else "ADDITION"
2026-02-20T22:09:17.5600791Z +            )
2026-02-20T22:09:17.5600972Z +            difficulty_normalized = (
2026-02-20T22:09:17.5601225Z +                exercise_row.difficulty_str.upper()
2026-02-20T22:09:17.5601504Z +                if exercise_row.difficulty_str
2026-02-20T22:09:17.5601765Z +                else "PADAWAN"
2026-02-20T22:09:17.5601966Z +            )
2026-02-20T22:09:17.5602130Z +
2026-02-20T22:09:17.5602287Z              exercise = {
2026-02-20T22:09:17.5602489Z                  "id": exercise_row.id,
2026-02-20T22:09:17.5602766Z                  "exercise_type": exercise_type_normalized,
2026-02-20T22:09:17.5603184Z                  "difficulty": difficulty_normalized,
2026-02-20T22:09:17.5603501Z                  "correct_answer": exercise_row.correct_answer,
2026-02-20T22:09:17.5603802Z                  "choices": exercise_row.choices,
2026-02-20T22:09:17.5604071Z                  "question": exercise_row.question,
2026-02-20T22:09:17.5604365Z -                "explanation": exercise_row.explanation
2026-02-20T22:09:17.5604665Z +                "explanation": exercise_row.explanation,
2026-02-20T22:09:17.5604923Z              }
2026-02-20T22:09:17.5605076Z  
2026-02-20T22:09:17.5605330Z              # Déterminer si la réponse est correcte
2026-02-20T22:09:17.5605586Z              is_correct = False
2026-02-20T22:09:17.5605783Z -            
2026-02-20T22:09:17.5605933Z +
2026-02-20T22:09:17.5606145Z              # Vérifier que correct_answer existe
2026-02-20T22:09:17.5606448Z -            correct_answer = exercise.get('correct_answer')
2026-02-20T22:09:17.5606766Z +            correct_answer = exercise.get("correct_answer")
2026-02-20T22:09:17.5607052Z              if not correct_answer:
2026-02-20T22:09:17.5607400Z -                logger.error(f"ERREUR: L'exercice {exercise_id} n'a pas de correct_answer")
2026-02-20T22:09:17.5607790Z +                logger.error(
2026-02-20T22:09:17.5608080Z +                    f"ERREUR: L'exercice {exercise_id} n'a pas de correct_answer"
2026-02-20T22:09:17.5608409Z +                )
2026-02-20T22:09:17.5608640Z                  return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5609063Z                      ValueError("L'exercice n'a pas de réponse correcte définie"),
2026-02-20T22:09:17.5609401Z                      status_code=500,
2026-02-20T22:09:17.5609774Z -                    user_message="L'exercice n'a pas de réponse correcte définie."
2026-02-20T22:09:17.5610101Z -                )
2026-02-20T22:09:17.5610263Z -            
2026-02-20T22:09:17.5610586Z +                    user_message="L'exercice n'a pas de réponse correcte définie.",
2026-02-20T22:09:17.5610911Z +                )
2026-02-20T22:09:17.5611071Z +
2026-02-20T22:09:17.5611417Z              # Types d'exercices qui devraient avoir une comparaison insensible à la casse
2026-02-20T22:09:17.5611904Z              text_based_types = [ExerciseType.TEXTE.value, ExerciseType.MIXTE.value]
2026-02-20T22:09:17.5612329Z -            exercise_type_str = exercise.get('exercise_type', '')
2026-02-20T22:09:17.5612620Z -            
2026-02-20T22:09:17.5612844Z +            exercise_type_str = exercise.get("exercise_type", "")
2026-02-20T22:09:17.5613341Z +
2026-02-20T22:09:17.5613718Z              # Pour les types de questions textuelles, la comparaison est insensible à la casse
2026-02-20T22:09:17.5614138Z              if exercise_type_str in text_based_types:
2026-02-20T22:09:17.5614566Z -                is_correct = str(selected_answer).lower().strip() == str(correct_answer).lower().strip()
2026-02-20T22:09:17.5614980Z +                is_correct = (
2026-02-20T22:09:17.5615214Z +                    str(selected_answer).lower().strip()
2026-02-20T22:09:17.5615653Z +                    == str(correct_answer).lower().strip()
2026-02-20T22:09:17.5615901Z +                )
2026-02-20T22:09:17.5616064Z              else:
2026-02-20T22:09:17.5616386Z                  # Pour les questions numériques et autres, comparaison stricte
2026-02-20T22:09:17.5616814Z                  is_correct = str(selected_answer).strip() == str(correct_answer).strip()
2026-02-20T22:09:17.5617269Z -                
2026-02-20T22:09:17.5617744Z -            logger.debug(f"Réponse correcte? {is_correct} (selected: '{selected_answer}', correct: '{correct_answer}')")
2026-02-20T22:09:17.5618204Z +
2026-02-20T22:09:17.5618353Z +            logger.debug(
2026-02-20T22:09:17.5618803Z +                f"Réponse correcte? {is_correct} (selected: '{selected_answer}', correct: '{correct_answer}')"
2026-02-20T22:09:17.5619216Z +            )
2026-02-20T22:09:17.5619367Z  
2026-02-20T22:09:17.5619570Z              # Enregistrer la tentative avec PostgreSQL direct
2026-02-20T22:09:17.5619852Z              try:
2026-02-20T22:09:17.5620104Z                  # Préparer les données de la tentative
2026-02-20T22:09:17.5620365Z                  attempt_data = {
2026-02-20T22:09:17.5620587Z                      "user_id": user_id,
2026-02-20T22:09:17.5620831Z                      "exercise_id": exercise_id,
2026-02-20T22:09:17.5621107Z                      "user_answer": selected_answer,
2026-02-20T22:09:17.5621376Z                      "is_correct": is_correct,
2026-02-20T22:09:17.5621632Z -                    "time_spent": time_spent
2026-02-20T22:09:17.5621887Z +                    "time_spent": time_spent,
2026-02-20T22:09:17.5622111Z                  }
2026-02-20T22:09:17.5622274Z -                
2026-02-20T22:09:17.5622595Z -                logger.debug(f"Tentative d'enregistrement avec attempt_data: {attempt_data}")
2026-02-20T22:09:17.5623083Z +
2026-02-20T22:09:17.5623236Z +                logger.debug(
2026-02-20T22:09:17.5623539Z +                    f"Tentative d'enregistrement avec attempt_data: {attempt_data}"
2026-02-20T22:09:17.5623876Z +                )
2026-02-20T22:09:17.5624116Z                  # Utiliser le service ORM ExerciseService.record_attempt
2026-02-20T22:09:17.5624512Z                  from app.services.exercise_service import ExerciseService
2026-02-20T22:09:17.5624817Z +
2026-02-20T22:09:17.5625059Z                  attempt_obj = ExerciseService.record_attempt(db, attempt_data)
2026-02-20T22:09:17.5625531Z                  logger.debug(f"Résultat de record_attempt: {attempt_obj}")
2026-02-20T22:09:17.5625848Z -                
2026-02-20T22:09:17.5626012Z +
2026-02-20T22:09:17.5626309Z                  # Convertir l'objet Attempt en dictionnaire pour la réponse
2026-02-20T22:09:17.5626637Z                  if attempt_obj:
2026-02-20T22:09:17.5626849Z                      attempt = {
2026-02-20T22:09:17.5627073Z                          "id": attempt_obj.id,
2026-02-20T22:09:17.5627338Z                          "user_id": attempt_obj.user_id,
2026-02-20T22:09:17.5627639Z                          "exercise_id": attempt_obj.exercise_id,
2026-02-20T22:09:17.5627938Z                          "user_answer": attempt_obj.user_answer,
2026-02-20T22:09:17.5628244Z                          "is_correct": attempt_obj.is_correct,
2026-02-20T22:09:17.5628537Z                          "time_spent": attempt_obj.time_spent,
2026-02-20T22:09:17.5628984Z -                        "created_at": attempt_obj.created_at.isoformat() if attempt_obj.created_at else None
2026-02-20T22:09:17.5629405Z +                        "created_at": (
2026-02-20T22:09:17.5629670Z +                            attempt_obj.created_at.isoformat()
2026-02-20T22:09:17.5629964Z +                            if attempt_obj.created_at
2026-02-20T22:09:17.5630215Z +                            else None
2026-02-20T22:09:17.5630437Z +                        ),
2026-02-20T22:09:17.5630623Z                      }
2026-02-20T22:09:17.5630797Z                  else:
2026-02-20T22:09:17.5630990Z                      attempt = None
2026-02-20T22:09:17.5631321Z -                
2026-02-20T22:09:17.5631486Z +
2026-02-20T22:09:17.5631640Z                  if not attempt:
2026-02-20T22:09:17.5632059Z -                    logger.error("ERREUR: La tentative n'a pas été enregistrée correctement")
2026-02-20T22:09:17.5632453Z -                    return JSONResponse({
2026-02-20T22:09:17.5632822Z -                        "is_correct": is_correct,
2026-02-20T22:09:17.5633199Z -                        "correct_answer": correct_answer,
2026-02-20T22:09:17.5633523Z -                        "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5633904Z -                        "error": "Erreur lors de l'enregistrement de la tentative"
2026-02-20T22:09:17.5634233Z -                    }, status_code=500)
2026-02-20T22:09:17.5634454Z -                
2026-02-20T22:09:17.5634627Z +                    logger.error(
2026-02-20T22:09:17.5635001Z +                        "ERREUR: La tentative n'a pas été enregistrée correctement"
2026-02-20T22:09:17.5635328Z +                    )
2026-02-20T22:09:17.5635519Z +                    return JSONResponse(
2026-02-20T22:09:17.5635749Z +                        {
2026-02-20T22:09:17.5635956Z +                            "is_correct": is_correct,
2026-02-20T22:09:17.5636235Z +                            "correct_answer": correct_answer,
2026-02-20T22:09:17.5636559Z +                            "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5636950Z +                            "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5637275Z +                        },
2026-02-20T22:09:17.5637479Z +                        status_code=500,
2026-02-20T22:09:17.5637696Z +                    )
2026-02-20T22:09:17.5637864Z +
2026-02-20T22:09:17.5638129Z                  logger.info("Tentative enregistrée avec succès")
2026-02-20T22:09:17.5638402Z  
2026-02-20T22:09:17.5638720Z                  # 🎖️ NOUVEAU: Vérifier et attribuer les badges (même session)
2026-02-20T22:09:17.5639050Z                  new_badges = []
2026-02-20T22:09:17.5639258Z                  try:
2026-02-20T22:09:17.5639462Z                      badge_service = BadgeService(db)
2026-02-20T22:09:17.5639710Z -                
2026-02-20T22:09:17.5639868Z +
2026-02-20T22:09:17.5640117Z                      # Préparer les données de la tentative pour l'évaluation des badges
2026-02-20T22:09:17.5640210Z                      attempt_for_badges = {
2026-02-20T22:09:17.5640341Z -                        "exercise_type": exercise.get('exercise_type'),
2026-02-20T22:09:17.5640471Z +                        "exercise_type": exercise.get("exercise_type"),
2026-02-20T22:09:17.5640560Z                          "is_correct": is_correct,
2026-02-20T22:09:17.5640649Z                          "time_spent": time_spent,
2026-02-20T22:09:17.5640746Z                          "exercise_id": exercise_id,
2026-02-20T22:09:17.5641046Z -                        "created_at": attempt_obj.created_at.isoformat() if attempt_obj and attempt_obj.created_at else None,
2026-02-20T22:09:17.5641133Z +                        "created_at": (
2026-02-20T22:09:17.5641243Z +                            attempt_obj.created_at.isoformat()
2026-02-20T22:09:17.5641365Z +                            if attempt_obj and attempt_obj.created_at
2026-02-20T22:09:17.5641439Z +                            else None
2026-02-20T22:09:17.5641514Z +                        ),
2026-02-20T22:09:17.5641582Z                      }
2026-02-20T22:09:17.5641645Z -                    
2026-02-20T22:09:17.5641704Z +
2026-02-20T22:09:17.5641873Z                      # Vérifier et attribuer les nouveaux badges
2026-02-20T22:09:17.5642100Z -                    new_badges = badge_service.check_and_award_badges(user_id, attempt_for_badges)
2026-02-20T22:09:17.5642164Z -                
2026-02-20T22:09:17.5642292Z +                    new_badges = badge_service.check_and_award_badges(
2026-02-20T22:09:17.5642389Z +                        user_id, attempt_for_badges
2026-02-20T22:09:17.5642575Z +                    )
2026-02-20T22:09:17.5642634Z +
2026-02-20T22:09:17.5642713Z                      if new_badges:
2026-02-20T22:09:17.5643163Z -                        logger.info(f"🎖️ {len(new_badges)} nouveaux badges attribués à l'utilisateur {user_id}")
2026-02-20T22:09:17.5643245Z +                        logger.info(
2026-02-20T22:09:17.5643658Z +                            f"🎖️ {len(new_badges)} nouveaux badges attribués à l'utilisateur {user_id}"
2026-02-20T22:09:17.5643726Z +                        )
2026-02-20T22:09:17.5643815Z                          for badge in new_badges:
2026-02-20T22:09:17.5644000Z -                            logger.debug(f"   - {badge['name']} ({badge['star_wars_title']})")
2026-02-20T22:09:17.5644070Z -                    
2026-02-20T22:09:17.5644150Z +                            logger.debug(
2026-02-20T22:09:17.5644283Z +                                f"   - {badge['name']} ({badge['star_wars_title']})"
2026-02-20T22:09:17.5644359Z +                            )
2026-02-20T22:09:17.5644427Z +
2026-02-20T22:09:17.5644519Z                  except Exception as badge_error:
2026-02-20T22:09:17.5644817Z -                    logger.warning(f"⚠️ Erreur lors de la vérification des badges: {badge_error}")
2026-02-20T22:09:17.5644898Z +                    logger.warning(
2026-02-20T22:09:17.5645128Z +                        f"⚠️ Erreur lors de la vérification des badges: {badge_error}"
2026-02-20T22:09:17.5645193Z +                    )
2026-02-20T22:09:17.5645306Z                      logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5645519Z                      # Ne pas faire échouer la soumission si les badges échouent
2026-02-20T22:09:17.5645582Z  
2026-02-20T22:09:17.5645759Z                  # Mettre à jour la série d'entraînement (streak)
2026-02-20T22:09:17.5645826Z                  try:
2026-02-20T22:09:17.5645985Z                      from app.services.streak_service import update_user_streak
2026-02-20T22:09:17.5646054Z +
2026-02-20T22:09:17.5646160Z                      update_user_streak(db, user_id)
2026-02-20T22:09:17.5646254Z                  except Exception as streak_err:
2026-02-20T22:09:17.5646393Z                      logger.debug(f"Streak update skipped: {streak_err}")
2026-02-20T22:09:17.5646460Z  
2026-02-20T22:09:17.5646695Z                  # Retourner le résultat avec l'ID de tentative et les nouveaux badges
2026-02-20T22:09:17.5646846Z                  from app.utils.json_utils import make_json_serializable
2026-02-20T22:09:17.5646913Z -                
2026-02-20T22:09:17.5646972Z +
2026-02-20T22:09:17.5647047Z                  response_data = {
2026-02-20T22:09:17.5647140Z                      "is_correct": is_correct,
2026-02-20T22:09:17.5647237Z                      "correct_answer": correct_answer,
2026-02-20T22:09:17.5647368Z -                    "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5647497Z -                    "attempt_id": attempt.get('id') if attempt else None
2026-02-20T22:09:17.5647631Z +                    "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5647761Z +                    "attempt_id": attempt.get("id") if attempt else None,
2026-02-20T22:09:17.5647824Z                  }
2026-02-20T22:09:17.5647890Z -                
2026-02-20T22:09:17.5647949Z +
2026-02-20T22:09:17.5648225Z                  # Ajouter les nouveaux badges à la réponse (nettoyer pour sérialisation JSON)
2026-02-20T22:09:17.5648312Z                  if new_badges:
2026-02-20T22:09:17.5648484Z                      response_data["new_badges"] = make_json_serializable(new_badges)
2026-02-20T22:09:17.5648608Z                      response_data["badges_earned"] = len(new_badges)
2026-02-20T22:09:17.5648674Z                  else:
2026-02-20T22:09:17.5648947Z                      # Notification « Tu approches » si un badge est proche (>= 50 %, target > 0)
2026-02-20T22:09:17.5649148Z -                    progress_notif = badge_service.get_closest_progress_notification(user_id)
2026-02-20T22:09:17.5649477Z +                    progress_notif = badge_service.get_closest_progress_notification(
2026-02-20T22:09:17.5649556Z +                        user_id
2026-02-20T22:09:17.5649621Z +                    )
2026-02-20T22:09:17.5649702Z                      if progress_notif:
2026-02-20T22:09:17.5649861Z                          response_data["progress_notification"] = progress_notif
2026-02-20T22:09:17.5650000Z -                
2026-02-20T22:09:17.5650060Z +
2026-02-20T22:09:17.5650396Z                  # Nettoyer toutes les données avant sérialisation JSON (gère les MagicMock dans les tests)
2026-02-20T22:09:17.5650548Z                  response_data = make_json_serializable(response_data)
2026-02-20T22:09:17.5650610Z -                
2026-02-20T22:09:17.5650669Z +
2026-02-20T22:09:17.5650775Z                  return JSONResponse(response_data)
2026-02-20T22:09:17.5650838Z -            
2026-02-20T22:09:17.5650897Z +
2026-02-20T22:09:17.5650993Z              except Exception as db_error:
2026-02-20T22:09:17.5651186Z                  # Gérer les erreurs spécifiques à la base de données
2026-02-20T22:09:17.5651268Z                  error_msg = str(db_error)
2026-02-20T22:09:17.5651366Z                  error_type = type(db_error).__name__
2026-02-20T22:09:17.5651658Z -                logger.error(f"❌ ERREUR DB lors de l'enregistrement: {error_type}: {error_msg}")
2026-02-20T22:09:17.5651745Z +                logger.error(
2026-02-20T22:09:17.5651973Z +                    f"❌ ERREUR DB lors de l'enregistrement: {error_type}: {error_msg}"
2026-02-20T22:09:17.5652044Z +                )
2026-02-20T22:09:17.5652145Z                  logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5652207Z -                
2026-02-20T22:09:17.5652271Z +
2026-02-20T22:09:17.5652548Z                  # Retourner quand même le résultat de validation même si l'enregistrement échoue
2026-02-20T22:09:17.5652635Z -                return JSONResponse({
2026-02-20T22:09:17.5652724Z -                    "is_correct": is_correct,
2026-02-20T22:09:17.5652834Z -                    "correct_answer": correct_answer,
2026-02-20T22:09:17.5653137Z -                    "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5653348Z -                    "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5653446Z -                    "error_type": error_type,
2026-02-20T22:09:17.5653545Z -                    "error_message": error_msg
2026-02-20T22:09:17.5653621Z -                }, status_code=500)
2026-02-20T22:09:17.5653706Z +                return JSONResponse(
2026-02-20T22:09:17.5653770Z +                    {
2026-02-20T22:09:17.5653859Z +                        "is_correct": is_correct,
2026-02-20T22:09:17.5653961Z +                        "correct_answer": correct_answer,
2026-02-20T22:09:17.5654093Z +                        "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5654244Z +                        "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5654338Z +                        "error_type": error_type,
2026-02-20T22:09:17.5654439Z +                        "error_message": error_msg,
2026-02-20T22:09:17.5654504Z +                    },
2026-02-20T22:09:17.5654580Z +                    status_code=500,
2026-02-20T22:09:17.5654649Z +                )
2026-02-20T22:09:17.5654708Z  
2026-02-20T22:09:17.5654822Z      except Exception as response_processing_error:
2026-02-20T22:09:17.5655325Z -        logger.error(f"❌ ERREUR lors du traitement de la réponse: {type(response_processing_error).__name__}: {str(response_processing_error)}")
2026-02-20T22:09:17.5655403Z +        logger.error(
2026-02-20T22:09:17.5655832Z +            f"❌ ERREUR lors du traitement de la réponse: {type(response_processing_error).__name__}: {str(response_processing_error)}"
2026-02-20T22:09:17.5655896Z +        )
2026-02-20T22:09:17.5656001Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5656062Z -        
2026-02-20T22:09:17.5656122Z +
2026-02-20T22:09:17.5656437Z          # Retourner une réponse d'erreur standardisée
2026-02-20T22:09:17.5656549Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5656637Z              response_processing_error,
2026-02-20T22:09:17.5656713Z              status_code=500,
2026-02-20T22:09:17.5656911Z -            user_message="Erreur lors du traitement de la réponse"
2026-02-20T22:09:17.5657079Z -        )
2026-02-20T22:09:17.5657272Z +            user_message="Erreur lors du traitement de la réponse",
2026-02-20T22:09:17.5657341Z +        )
2026-02-20T22:09:17.5657399Z +
2026-02-20T22:09:17.5657457Z  
2026-02-20T22:09:17.5657525Z  @optional_auth
2026-02-20T22:09:17.5657617Z  async def get_exercises_list(request):
2026-02-20T22:09:17.5658010Z      """Retourne la liste des exercices avec pagination. Ordre aléatoire par défaut pour varier l'entraînement."""
2026-02-20T22:09:17.5658075Z      try:
2026-02-20T22:09:17.5658260Z          logger.debug("[STEP 1] Début de get_exercises_list")
2026-02-20T22:09:17.5658398Z -        current_user = getattr(request.state, 'user', None)
2026-02-20T22:09:17.5658518Z +        current_user = getattr(request.state, "user", None)
2026-02-20T22:09:17.5658587Z  
2026-02-20T22:09:17.5658724Z          # Récupérer les paramètres de requête
2026-02-20T22:09:17.5658840Z -        limit_param = request.query_params.get('limit')
2026-02-20T22:09:17.5658961Z +        limit_param = request.query_params.get("limit")
2026-02-20T22:09:17.5659074Z          limit = int(limit_param) if limit_param else 20
2026-02-20T22:09:17.5659183Z -        skip = int(request.query_params.get('skip', 0))
2026-02-20T22:09:17.5659358Z -        exercise_type_raw = request.query_params.get('exercise_type', None)
2026-02-20T22:09:17.5659589Z -        age_group_raw = request.query_params.get('age_group', None) # Changed from difficulty
2026-02-20T22:09:17.5659873Z -        search = request.query_params.get('search') or request.query_params.get('q')  # Support 'search' et 'q'
2026-02-20T22:09:17.5660024Z -        order = (request.query_params.get('order') or 'random').lower()
2026-02-20T22:09:17.5660265Z -        hide_completed = request.query_params.get('hide_completed', 'false').lower() == 'true'
2026-02-20T22:09:17.5660330Z -        
2026-02-20T22:09:17.5660632Z -        logger.debug(f"[STEP 2] Params: limit={limit}, skip={skip}, type={exercise_type_raw}, age_group={age_group_raw}")
2026-02-20T22:09:17.5660706Z -        
2026-02-20T22:09:17.5660818Z +        skip = int(request.query_params.get("skip", 0))
2026-02-20T22:09:17.5660988Z +        exercise_type_raw = request.query_params.get("exercise_type", None)
2026-02-20T22:09:17.5661090Z +        age_group_raw = request.query_params.get(
2026-02-20T22:09:17.5661171Z +            "age_group", None
2026-02-20T22:09:17.5661251Z +        )  # Changed from difficulty
2026-02-20T22:09:17.5661436Z +        search = request.query_params.get("search") or request.query_params.get(
2026-02-20T22:09:17.5661505Z +            "q"
2026-02-20T22:09:17.5661584Z +        )  # Support 'search' et 'q'
2026-02-20T22:09:17.5661734Z +        order = (request.query_params.get("order") or "random").lower()
2026-02-20T22:09:17.5661814Z +        hide_completed = (
2026-02-20T22:09:17.5661994Z +            request.query_params.get("hide_completed", "false").lower() == "true"
2026-02-20T22:09:17.5662057Z +        )
2026-02-20T22:09:17.5662122Z +
2026-02-20T22:09:17.5662198Z +        logger.debug(
2026-02-20T22:09:17.5662450Z +            f"[STEP 2] Params: limit={limit}, skip={skip}, type={exercise_type_raw}, age_group={age_group_raw}"
2026-02-20T22:09:17.5662511Z +        )
2026-02-20T22:09:17.5662577Z +
2026-02-20T22:09:17.5662718Z          # Normaliser les paramètres de filtrage
2026-02-20T22:09:17.5662817Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5662917Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5663326Z -        exercise_type, age_group, _ = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5663510Z -        
2026-02-20T22:09:17.5663840Z -        logger.debug(f"[STEP 3] Après normalisation: type={exercise_type}, age_group={age_group}")
2026-02-20T22:09:17.5663914Z -        
2026-02-20T22:09:17.5664120Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5664181Z +
2026-02-20T22:09:17.5664467Z +        exercise_type, age_group, _ = normalize_and_validate_exercise_params(
2026-02-20T22:09:17.5664560Z +            exercise_type_raw, age_group_raw
2026-02-20T22:09:17.5664624Z +        )
2026-02-20T22:09:17.5664685Z +
2026-02-20T22:09:17.5664764Z +        logger.debug(
2026-02-20T22:09:17.5665025Z +            f"[STEP 3] Après normalisation: type={exercise_type}, age_group={age_group}"
2026-02-20T22:09:17.5665088Z +        )
2026-02-20T22:09:17.5665154Z +
2026-02-20T22:09:17.5665394Z          # Si aucun paramètre n'était fourni, remettre à None pour ne pas filtrer
2026-02-20T22:09:17.5665478Z          if not exercise_type_raw:
2026-02-20T22:09:17.5665571Z              exercise_type = None
2026-02-20T22:09:17.5665647Z          if not age_group_raw:
2026-02-20T22:09:17.5665721Z              age_group = None
2026-02-20T22:09:17.5665781Z -        
2026-02-20T22:09:17.5665846Z +
2026-02-20T22:09:17.5665997Z          # Calculer la page à partir de skip et limit
2026-02-20T22:09:17.5666108Z          page = (skip // limit) + 1 if limit > 0 else 1
2026-02-20T22:09:17.5666183Z -        
2026-02-20T22:09:17.5666242Z +
2026-02-20T22:09:17.5666371Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5666511Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5666577Z +
2026-02-20T22:09:17.5666731Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5666865Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5666930Z -        
2026-02-20T22:09:17.5667569Z -        logger.debug(f"[STEP 4] API - Paramètres finaux: limit={limit}, skip={skip}, page={page}, exercise_type={exercise_type}, age_group={age_group}, search={search}, locale={locale}")
2026-02-20T22:09:17.5667639Z -        
2026-02-20T22:09:17.5667702Z +
2026-02-20T22:09:17.5667771Z +        logger.debug(
2026-02-20T22:09:17.5668339Z +            f"[STEP 4] API - Paramètres finaux: limit={limit}, skip={skip}, page={page}, exercise_type={exercise_type}, age_group={age_group}, search={search}, locale={locale}"
2026-02-20T22:09:17.5668407Z +        )
2026-02-20T22:09:17.5668470Z +
2026-02-20T22:09:17.5668748Z          # Utiliser le service ORM ExerciseService (100% ORM comme recommandé par l'audit)
2026-02-20T22:09:17.5668834Z          async with db_session() as db:
2026-02-20T22:09:17.5668949Z              logger.debug("[STEP 5] Session DB obtenue")
2026-02-20T22:09:17.5669107Z              logger.debug("[STEP 6] Début du bloc try DB")
2026-02-20T22:09:17.5669223Z              from sqlalchemy import String, cast, or_, text
2026-02-20T22:09:17.5669287Z  
2026-02-20T22:09:17.5669443Z -            from app.models.exercise import (DifficultyLevel, Exercise,
2026-02-20T22:09:17.5669543Z -                                             ExerciseType)
2026-02-20T22:09:17.5669736Z +            from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:17.5669800Z  
2026-02-20T22:09:17.5669950Z              logger.debug("[STEP 7] Imports effectués")
2026-02-20T22:09:17.5670044Z              from sqlalchemy import func
2026-02-20T22:09:17.5670108Z  
2026-02-20T22:09:17.5670301Z              # IDs à exclure si hide_completed et utilisateur connecté
2026-02-20T22:09:17.5670389Z              completed_ids_to_exclude = []
2026-02-20T22:09:17.5670554Z              if hide_completed and current_user and current_user.get("id"):
2026-02-20T22:09:17.5670659Z                  from app.models.attempt import Attempt
2026-02-20T22:09:17.5670776Z -                subq = db.query(Attempt.exercise_id).filter(
2026-02-20T22:09:17.5670878Z -                    Attempt.user_id == current_user["id"],
2026-02-20T22:09:17.5671065Z -                    Attempt.is_correct == True
2026-02-20T22:09:17.5671143Z -                ).distinct().all()
2026-02-20T22:09:17.5671205Z +
2026-02-20T22:09:17.5671279Z +                subq = (
2026-02-20T22:09:17.5671374Z +                    db.query(Attempt.exercise_id)
2026-02-20T22:09:17.5671443Z +                    .filter(
2026-02-20T22:09:17.5671630Z +                        Attempt.user_id == current_user["id"],
2026-02-20T22:09:17.5671731Z +                        Attempt.is_correct == True,
2026-02-20T22:09:17.5671797Z +                    )
2026-02-20T22:09:17.5671870Z +                    .distinct()
2026-02-20T22:09:17.5671946Z +                    .all()
2026-02-20T22:09:17.5672010Z +                )
2026-02-20T22:09:17.5672178Z                  completed_ids_to_exclude = [r[0] for r in subq if r[0] is not None]
2026-02-20T22:09:17.5672246Z -            
2026-02-20T22:09:17.5672306Z +
2026-02-20T22:09:17.5672431Z              # Construire la requête ORM
2026-02-20T22:09:17.5672599Z              query = db.query(Exercise).filter(Exercise.is_archived == False)
2026-02-20T22:09:17.5672764Z              logger.debug("[STEP 8] Query de base créée")
2026-02-20T22:09:17.5672827Z -            
2026-02-20T22:09:17.5672886Z +
2026-02-20T22:09:17.5673298Z              # Filtrer par type si spécifié (utiliser l'enum normalisé)
2026-02-20T22:09:17.5673391Z              if exercise_type:
2026-02-20T22:09:17.5673553Z                  query = query.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:17.5673620Z -            
2026-02-20T22:09:17.5673679Z +
2026-02-20T22:09:17.5673827Z              # Filtrer par groupe d'âge si spécifié
2026-02-20T22:09:17.5673902Z              if age_group:
2026-02-20T22:09:17.5674043Z                  query = query.filter(Exercise.age_group == age_group)
2026-02-20T22:09:17.5674104Z -            
2026-02-20T22:09:17.5674163Z +
2026-02-20T22:09:17.5674305Z              # Recherche textuelle si spécifié
2026-02-20T22:09:17.5674384Z              if search:
2026-02-20T22:09:17.5674474Z                  search_pattern = f"%{search}%"
2026-02-20T22:09:17.5674557Z                  query = query.filter(
2026-02-20T22:09:17.5674631Z                      or_(
2026-02-20T22:09:17.5674743Z                          Exercise.title.ilike(search_pattern),
2026-02-20T22:09:17.5674860Z -                        Exercise.question.ilike(search_pattern)
2026-02-20T22:09:17.5674998Z +                        Exercise.question.ilike(search_pattern),
2026-02-20T22:09:17.5675065Z                      )
2026-02-20T22:09:17.5675128Z                  )
2026-02-20T22:09:17.5675189Z  
2026-02-20T22:09:17.5675363Z              # Exclure les exercices déjà réussis si demandé
2026-02-20T22:09:17.5675451Z              if completed_ids_to_exclude:
2026-02-20T22:09:17.5675627Z                  query = query.filter(Exercise.id.notin_(completed_ids_to_exclude))
2026-02-20T22:09:17.5675697Z -            
2026-02-20T22:09:17.5675756Z +
2026-02-20T22:09:17.5675908Z              logger.debug("[STEP 9] Filtres appliqués")
2026-02-20T22:09:17.5675986Z -            
2026-02-20T22:09:17.5676045Z +
2026-02-20T22:09:17.5676120Z              # Compter le total
2026-02-20T22:09:17.5676198Z              total = query.count()
2026-02-20T22:09:17.5676373Z              logger.debug(f"[STEP 10] Total compté: {total}")
2026-02-20T22:09:17.5676444Z -            
2026-02-20T22:09:17.5676503Z +
2026-02-20T22:09:17.5676798Z              # Récupérer les exercices avec pagination (mêmes filtres que la query principale)
2026-02-20T22:09:17.5676890Z              exercises_objs_raw = db.query(
2026-02-20T22:09:17.5676964Z                  Exercise.id,
2026-02-20T22:09:17.5677042Z                  Exercise.title,
2026-02-20T22:09:17.5677129Z                  Exercise.question,
2026-02-20T22:09:17.5677198Z @@ -484,163 +605,220 @@
2026-02-20T22:09:17.5677270Z                  Exercise.tags,
2026-02-20T22:09:17.5677359Z                  Exercise.ai_generated,
2026-02-20T22:09:17.5677437Z                  Exercise.is_active,
2026-02-20T22:09:17.5677695Z                  Exercise.view_count,
2026-02-20T22:09:17.5677786Z                  Exercise.created_at,
2026-02-20T22:09:17.5677969Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5678126Z -                cast(Exercise.difficulty, String).label('difficulty_str'),
2026-02-20T22:09:17.5678425Z -                Exercise.age_group # Récupérer aussi le groupe d'âge
2026-02-20T22:09:17.5678602Z +                cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5678751Z +                cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5678946Z +                Exercise.age_group,  # Récupérer aussi le groupe d'âge
2026-02-20T22:09:17.5679057Z              ).filter(Exercise.is_archived == False)
2026-02-20T22:09:17.5679118Z -            
2026-02-20T22:09:17.5679176Z +
2026-02-20T22:09:17.5679373Z              # Appliquer les mêmes filtres que la requête principale
2026-02-20T22:09:17.5679459Z              if exercise_type:
2026-02-20T22:09:17.5679711Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:17.5679835Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5679951Z +                    Exercise.exercise_type == exercise_type
2026-02-20T22:09:17.5680024Z +                )
2026-02-20T22:09:17.5680096Z              if age_group:
2026-02-20T22:09:17.5680321Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.age_group == age_group)
2026-02-20T22:09:17.5680439Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5680534Z +                    Exercise.age_group == age_group
2026-02-20T22:09:17.5680601Z +                )
2026-02-20T22:09:17.5680670Z              if search:
2026-02-20T22:09:17.5680761Z                  search_pattern = f"%{search}%"
2026-02-20T22:09:17.5680882Z                  exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5680965Z                      or_(
2026-02-20T22:09:17.5681083Z                          Exercise.title.ilike(search_pattern),
2026-02-20T22:09:17.5681199Z -                        Exercise.question.ilike(search_pattern)
2026-02-20T22:09:17.5681326Z +                        Exercise.question.ilike(search_pattern),
2026-02-20T22:09:17.5681398Z                      )
2026-02-20T22:09:17.5681459Z                  )
2026-02-20T22:09:17.5681552Z              if completed_ids_to_exclude:
2026-02-20T22:09:17.5681819Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.id.notin_(completed_ids_to_exclude))
2026-02-20T22:09:17.5681938Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5682055Z +                    Exercise.id.notin_(completed_ids_to_exclude)
2026-02-20T22:09:17.5682124Z +                )
2026-02-20T22:09:17.5682184Z  
2026-02-20T22:09:17.5682408Z              # Ordre : aléatoire par défaut (varier l'entraînement), ou récent
2026-02-20T22:09:17.5682498Z              if order == "recent":
2026-02-20T22:09:17.5682817Z -                exercises_objs_raw = exercises_objs_raw.order_by(Exercise.created_at.desc()).limit(limit).offset(skip).all()
2026-02-20T22:09:17.5682900Z +                exercises_objs_raw = (
2026-02-20T22:09:17.5683175Z +                    exercises_objs_raw.order_by(Exercise.created_at.desc())
2026-02-20T22:09:17.5683250Z +                    .limit(limit)
2026-02-20T22:09:17.5683322Z +                    .offset(skip)
2026-02-20T22:09:17.5683391Z +                    .all()
2026-02-20T22:09:17.5683459Z +                )
2026-02-20T22:09:17.5683526Z              else:
2026-02-20T22:09:17.5683794Z -                exercises_objs_raw = exercises_objs_raw.order_by(func.random()).limit(limit).offset(skip).all()
2026-02-20T22:09:17.5684097Z -            logger.debug(f"[STEP 11] Exercices récupérés: {len(exercises_objs_raw)} éléments")
2026-02-20T22:09:17.5684161Z -            
2026-02-20T22:09:17.5684367Z +                exercises_objs_raw = (
2026-02-20T22:09:17.5684491Z +                    exercises_objs_raw.order_by(func.random())
2026-02-20T22:09:17.5684562Z +                    .limit(limit)
2026-02-20T22:09:17.5684635Z +                    .offset(skip)
2026-02-20T22:09:17.5684703Z +                    .all()
2026-02-20T22:09:17.5684873Z +                )
2026-02-20T22:09:17.5684952Z +            logger.debug(
2026-02-20T22:09:17.5685191Z +                f"[STEP 11] Exercices récupérés: {len(exercises_objs_raw)} éléments"
2026-02-20T22:09:17.5685262Z +            )
2026-02-20T22:09:17.5685324Z +
2026-02-20T22:09:17.5685406Z              import json as json_module
2026-02-20T22:09:17.5685465Z +
2026-02-20T22:09:17.5685580Z              def safe_parse_json(value, default=None):
2026-02-20T22:09:17.5685729Z -                if not value: return default if default is not None else []
2026-02-20T22:09:17.5685804Z +                if not value:
2026-02-20T22:09:17.5685941Z +                    return default if default is not None else []
2026-02-20T22:09:17.5686028Z                  if isinstance(value, str):
2026-02-20T22:09:17.5686138Z -                    try: return json_module.loads(value)
2026-02-20T22:09:17.5686433Z -                    except (json_module.JSONDecodeError, ValueError): return default if default is not None else []
2026-02-20T22:09:17.5686513Z +                    try:
2026-02-20T22:09:17.5686616Z +                        return json_module.loads(value)
2026-02-20T22:09:17.5686758Z +                    except (json_module.JSONDecodeError, ValueError):
2026-02-20T22:09:17.5686881Z +                        return default if default is not None else []
2026-02-20T22:09:17.5686955Z                  return value
2026-02-20T22:09:17.5687016Z  
2026-02-20T22:09:17.5687276Z              logger.debug("[STEP 12] Début de la construction de la liste d'exercices")
2026-02-20T22:09:17.5687350Z              exercises = []
2026-02-20T22:09:17.5687468Z              for idx, row in enumerate(exercises_objs_raw):
2026-02-20T22:09:17.5687547Z                  try:
2026-02-20T22:09:17.5687928Z -                    logger.debug(f"[STEP 12.{idx}] Processing row id={row.id}, type={type(row.exercise_type_str)}, diff={type(row.difficulty_str)}")
2026-02-20T22:09:17.5688008Z +                    logger.debug(
2026-02-20T22:09:17.5688344Z +                        f"[STEP 12.{idx}] Processing row id={row.id}, type={type(row.exercise_type_str)}, diff={type(row.difficulty_str)}"
2026-02-20T22:09:17.5688409Z +                    )
2026-02-20T22:09:17.5688490Z                      exercise_dict = {
2026-02-20T22:09:17.5688567Z                          "id": row.id,
2026-02-20T22:09:17.5688658Z                          "title": row.title,
2026-02-20T22:09:17.5688916Z -                        "exercise_type": row.exercise_type_str.upper() if row.exercise_type_str else "ADDITION",
2026-02-20T22:09:17.5689147Z -                        "difficulty": row.difficulty_str.upper() if row.difficulty_str else "PADAWAN",
2026-02-20T22:09:17.5689241Z +                        "exercise_type": (
2026-02-20T22:09:17.5689346Z +                            row.exercise_type_str.upper()
2026-02-20T22:09:17.5689445Z +                            if row.exercise_type_str
2026-02-20T22:09:17.5689543Z +                            else "ADDITION"
2026-02-20T22:09:17.5689617Z +                        ),
2026-02-20T22:09:17.5689696Z +                        "difficulty": (
2026-02-20T22:09:17.5689796Z +                            row.difficulty_str.upper()
2026-02-20T22:09:17.5689895Z +                            if row.difficulty_str
2026-02-20T22:09:17.5689974Z +                            else "PADAWAN"
2026-02-20T22:09:17.5690039Z +                        ),
2026-02-20T22:09:17.5690139Z                          "age_group": row.age_group,
2026-02-20T22:09:17.5690230Z                          "question": row.question,
2026-02-20T22:09:17.5690338Z                          "correct_answer": row.correct_answer,
2026-02-20T22:09:17.5690553Z                          "choices": safe_parse_json(row.choices, []),
2026-02-20T22:09:17.5690658Z                          "explanation": row.explanation,
2026-02-20T22:09:17.5690736Z                          "hint": row.hint,
2026-02-20T22:09:17.5690844Z                          "tags": safe_parse_json(row.tags, []),
2026-02-20T22:09:17.5691022Z                          "ai_generated": row.ai_generated,
2026-02-20T22:09:17.5691112Z                          "is_active": row.is_active,
2026-02-20T22:09:17.5691206Z -                        "view_count": row.view_count
2026-02-20T22:09:17.5691304Z +                        "view_count": row.view_count,
2026-02-20T22:09:17.5691369Z                      }
2026-02-20T22:09:17.5691465Z                      exercises.append(exercise_dict)
2026-02-20T22:09:17.5691564Z                  except Exception as row_error:
2026-02-20T22:09:17.5691739Z                      logger.error(f"[STEP 12.{idx}] ERROR processing row: {row_error}")
2026-02-20T22:09:17.5691818Z                      raise
2026-02-20T22:09:17.5692110Z -            logger.debug(f"[STEP 13] Liste d'exercices construite: {len(exercises)} éléments")
2026-02-20T22:09:17.5692183Z +            logger.debug(
2026-02-20T22:09:17.5692413Z +                f"[STEP 13] Liste d'exercices construite: {len(exercises)} éléments"
2026-02-20T22:09:17.5692482Z +            )
2026-02-20T22:09:17.5692549Z  
2026-02-20T22:09:17.5692649Z          has_more = (skip + len(exercises)) < total
2026-02-20T22:09:17.5692712Z -        
2026-02-20T22:09:17.5692776Z +
2026-02-20T22:09:17.5692847Z          response_data = {
2026-02-20T22:09:17.5692924Z              "items": exercises,
2026-02-20T22:09:17.5693168Z              "total": total,
2026-02-20T22:09:17.5693276Z              "page": page,
2026-02-20T22:09:17.5693350Z              "limit": limit,
2026-02-20T22:09:17.5693427Z -            "hasMore": has_more
2026-02-20T22:09:17.5693507Z +            "hasMore": has_more,
2026-02-20T22:09:17.5693569Z          }
2026-02-20T22:09:17.5693638Z -        
2026-02-20T22:09:17.5693698Z +
2026-02-20T22:09:17.5693796Z          return JSONResponse(response_data)
2026-02-20T22:09:17.5693855Z  
2026-02-20T22:09:17.5693955Z      except Exception as exercises_list_error:
2026-02-20T22:09:17.5694263Z -        logger.error(f"Erreur lors de la récupération des exercices: {exercises_list_error}")
2026-02-20T22:09:17.5694343Z +        logger.error(
2026-02-20T22:09:17.5694582Z +            f"Erreur lors de la récupération des exercices: {exercises_list_error}"
2026-02-20T22:09:17.5694650Z +        )
2026-02-20T22:09:17.5694747Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5695276Z -        return ErrorHandler.create_error_response(exercises_list_error, status_code=500, user_message="Erreur lors de la récupération des exercices")
2026-02-20T22:09:17.5695383Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5695466Z +            exercises_list_error,
2026-02-20T22:09:17.5695539Z +            status_code=500,
2026-02-20T22:09:17.5695756Z +            user_message="Erreur lors de la récupération des exercices",
2026-02-20T22:09:17.5695825Z +        )
2026-02-20T22:09:17.5695884Z +
2026-02-20T22:09:17.5695942Z  
2026-02-20T22:09:17.5696035Z  async def generate_exercise_api(request):
2026-02-20T22:09:17.5696299Z      """Génère un nouvel exercice via API JSON (POST) en utilisant le groupe d'âge."""
2026-02-20T22:09:17.5696371Z      try:
2026-02-20T22:09:17.5696516Z          # Récupérer les données JSON de la requête
2026-02-20T22:09:17.5696607Z          data = await request.json()
2026-02-20T22:09:17.5696717Z -        exercise_type_raw = data.get('exercise_type')
2026-02-20T22:09:17.5696872Z -        age_group_raw = data.get('age_group') # Changed from difficulty
2026-02-20T22:09:17.5696961Z -        use_ai = data.get('ai', False)
2026-02-20T22:09:17.5697022Z -        
2026-02-20T22:09:17.5697128Z +        exercise_type_raw = data.get("exercise_type")
2026-02-20T22:09:17.5697279Z +        age_group_raw = data.get("age_group")  # Changed from difficulty
2026-02-20T22:09:17.5697505Z +        use_ai = data.get("ai", False)
2026-02-20T22:09:17.5697565Z +
2026-02-20T22:09:17.5697706Z          # Normaliser et valider les paramètres
2026-02-20T22:09:17.5697813Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5697910Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5698079Z -        
2026-02-20T22:09:17.5698440Z -        exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5698503Z -        
2026-02-20T22:09:17.5698961Z -        logger.debug(f"Génération API: type={exercise_type_raw}→{exercise_type}, groupe d'âge={age_group_raw}→{age_group}, IA={use_ai}")
2026-02-20T22:09:17.5699024Z -        
2026-02-20T22:09:17.5699234Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5699295Z +
2026-02-20T22:09:17.5699414Z +        exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5699620Z +            normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5699682Z +        )
2026-02-20T22:09:17.5699740Z +
2026-02-20T22:09:17.5699820Z +        logger.debug(
2026-02-20T22:09:17.5700263Z +            f"Génération API: type={exercise_type_raw}→{exercise_type}, groupe d'âge={age_group_raw}→{age_group}, IA={use_ai}"
2026-02-20T22:09:17.5700337Z +        )
2026-02-20T22:09:17.5700397Z +
2026-02-20T22:09:17.5700520Z          # Valider les paramètres
2026-02-20T22:09:17.5700635Z          if not exercise_type_raw or not age_group_raw:
2026-02-20T22:09:17.5700718Z -            return JSONResponse({
2026-02-20T22:09:17.5700958Z -                "error": "Les paramètres 'exercise_type' et 'age_group' sont requis"
2026-02-20T22:09:17.5701033Z -            }, status_code=400)
2026-02-20T22:09:17.5701094Z -        
2026-02-20T22:09:17.5701171Z +            return JSONResponse(
2026-02-20T22:09:17.5701419Z +                {"error": "Les paramètres 'exercise_type' et 'age_group' sont requis"},
2026-02-20T22:09:17.5701504Z +                status_code=400,
2026-02-20T22:09:17.5701566Z +            )
2026-02-20T22:09:17.5701633Z +
2026-02-20T22:09:17.5701737Z          # Générer l'exercice
2026-02-20T22:09:17.5701815Z          ai_generated = False
2026-02-20T22:09:17.5701977Z -        if use_ai and str(use_ai).lower() in ['true', '1', 'yes', 'y']:
2026-02-20T22:09:17.5702116Z +        if use_ai and str(use_ai).lower() in ["true", "1", "yes", "y"]:
2026-02-20T22:09:17.5702280Z              exercise_dict = generate_ai_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5702357Z              ai_generated = True
2026-02-20T22:09:17.5702427Z          else:
2026-02-20T22:09:17.5702594Z              exercise_dict = generate_simple_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5702654Z -        
2026-02-20T22:09:17.5702720Z +
2026-02-20T22:09:17.5702840Z          exercise_dict = ensure_explanation(exercise_dict)
2026-02-20T22:09:17.5702908Z -        
2026-02-20T22:09:17.5703081Z +
2026-02-20T22:09:17.5703250Z          # Optionnellement sauvegarder en base de données
2026-02-20T22:09:17.5703342Z -        save_to_db = data.get('save', True)
2026-02-20T22:09:17.5703427Z +        save_to_db = data.get("save", True)
2026-02-20T22:09:17.5703503Z          if save_to_db:
2026-02-20T22:09:17.5703576Z              try:
2026-02-20T22:09:17.5703657Z                  # Extraire la locale
2026-02-20T22:09:17.5703812Z                  from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5703871Z +
2026-02-20T22:09:17.5704021Z                  accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5704157Z                  locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5704226Z -                
2026-02-20T22:09:17.5704284Z +
2026-02-20T22:09:17.5704374Z                  async with db_session() as db:
2026-02-20T22:09:17.5704617Z                      # Sauvegarder l'exercice avec age_group et la difficulté dérivée
2026-02-20T22:09:17.5704934Z                      created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5705006Z                          db=db,
2026-02-20T22:09:17.5705136Z -                        exercise_type=exercise_dict['exercise_type'],
2026-02-20T22:09:17.5705378Z -                        age_group=exercise_dict['age_group'], # Save age_group
2026-02-20T22:09:17.5705559Z -                        difficulty=exercise_dict['difficulty'], # Save derived difficulty
2026-02-20T22:09:17.5705655Z -                        title=exercise_dict['title'],
2026-02-20T22:09:17.5705763Z -                        question=exercise_dict['question'],
2026-02-20T22:09:17.5705884Z -                        correct_answer=exercise_dict['correct_answer'],
2026-02-20T22:09:17.5705984Z -                        choices=exercise_dict['choices'],
2026-02-20T22:09:17.5706108Z -                        explanation=exercise_dict['explanation'],
2026-02-20T22:09:17.5706216Z -                        hint=exercise_dict.get('hint'),
2026-02-20T22:09:17.5706336Z -                        tags=exercise_dict.get('tags', 'generated'),
2026-02-20T22:09:17.5706468Z +                        exercise_type=exercise_dict["exercise_type"],
2026-02-20T22:09:17.5706611Z +                        age_group=exercise_dict["age_group"],  # Save age_group
2026-02-20T22:09:17.5706710Z +                        difficulty=exercise_dict[
2026-02-20T22:09:17.5706797Z +                            "difficulty"
2026-02-20T22:09:17.5706889Z +                        ],  # Save derived difficulty
2026-02-20T22:09:17.5706981Z +                        title=exercise_dict["title"],
2026-02-20T22:09:17.5707085Z +                        question=exercise_dict["question"],
2026-02-20T22:09:17.5707216Z +                        correct_answer=exercise_dict["correct_answer"],
2026-02-20T22:09:17.5707315Z +                        choices=exercise_dict["choices"],
2026-02-20T22:09:17.5707431Z +                        explanation=exercise_dict["explanation"],
2026-02-20T22:09:17.5707538Z +                        hint=exercise_dict.get("hint"),
2026-02-20T22:09:17.5707654Z +                        tags=exercise_dict.get("tags", "generated"),
2026-02-20T22:09:17.5707748Z                          ai_generated=ai_generated,
2026-02-20T22:09:17.5707839Z -                        locale=locale
2026-02-20T22:09:17.5707914Z +                        locale=locale,
2026-02-20T22:09:17.5707978Z                      )
2026-02-20T22:09:17.5708056Z                      if created_exercise:
2026-02-20T22:09:17.5708177Z -                        exercise_dict['id'] = created_exercise['id']
2026-02-20T22:09:17.5708438Z -                        logger.info(f"Exercice sauvegardé avec ID={created_exercise['id']}")
2026-02-20T22:09:17.5708549Z +                        exercise_dict["id"] = created_exercise["id"]
2026-02-20T22:09:17.5708628Z +                        logger.info(
2026-02-20T22:09:17.5708838Z +                            f"Exercice sauvegardé avec ID={created_exercise['id']}"
2026-02-20T22:09:17.5708912Z +                        )
2026-02-20T22:09:17.5709007Z              except Exception as save_error:
2026-02-20T22:09:17.5709166Z                  logger.warning(f"Erreur lors de la sauvegarde: {save_error}")
2026-02-20T22:09:17.5709318Z                  # Continuer même si la sauvegarde échoue
2026-02-20T22:09:17.5709395Z -        
2026-02-20T22:09:17.5709455Z +
2026-02-20T22:09:17.5709575Z          # Retourner l'exercice généré
2026-02-20T22:09:17.5709665Z          return JSONResponse(exercise_dict)
2026-02-20T22:09:17.5709728Z -        
2026-02-20T22:09:17.5709786Z +
2026-02-20T22:09:17.5709885Z      except Exception as api_generation_error:
2026-02-20T22:09:17.5710179Z -        logger.error(f"Erreur lors de la génération d'exercice API: {api_generation_error}")
2026-02-20T22:09:17.5710252Z +        logger.error(
2026-02-20T22:09:17.5710485Z +            f"Erreur lors de la génération d'exercice API: {api_generation_error}"
2026-02-20T22:09:17.5710640Z +        )
2026-02-20T22:09:17.5710741Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5711259Z -        return ErrorHandler.create_error_response(api_generation_error, status_code=500, user_message="Erreur lors de la génération de l'exercice")
2026-02-20T22:09:17.5711366Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5711551Z +            api_generation_error,
2026-02-20T22:09:17.5711623Z +            status_code=500,
2026-02-20T22:09:17.5711821Z +            user_message="Erreur lors de la génération de l'exercice",
2026-02-20T22:09:17.5711888Z +        )
2026-02-20T22:09:17.5711946Z +
2026-02-20T22:09:17.5712003Z  
2026-02-20T22:09:17.5712069Z  @require_auth_sse
2026-02-20T22:09:17.5712180Z  async def generate_ai_exercise_stream(request):
2026-02-20T22:09:17.5712243Z      """
2026-02-20T22:09:17.5712402Z      Génère un exercice avec OpenAI en streaming SSE.
2026-02-20T22:09:17.5712480Z @@ -649,61 +827,101 @@
2026-02-20T22:09:17.5712549Z      try:
2026-02-20T22:09:17.5712756Z          # Utilisateur authentifié via le décorateur @require_auth_sse
2026-02-20T22:09:17.5712844Z          current_user = request.state.user
2026-02-20T22:09:17.5712906Z  
2026-02-20T22:09:17.5713159Z          # Récupérer les paramètres de la requête
2026-02-20T22:09:17.5713351Z -        exercise_type_raw = request.query_params.get('exercise_type', 'addition')
2026-02-20T22:09:17.5713550Z +        exercise_type_raw = request.query_params.get("exercise_type", "addition")
2026-02-20T22:09:17.5713796Z          # Support des deux paramètres : age_group (nouveau) et difficulty (legacy)
2026-02-20T22:09:17.5714083Z -        age_group_raw = request.query_params.get('age_group') or request.query_params.get('difficulty', '6-8')
2026-02-20T22:09:17.5714219Z -        prompt_raw = request.query_params.get('prompt', '')
2026-02-20T22:09:17.5714323Z +        age_group_raw = request.query_params.get(
2026-02-20T22:09:17.5714395Z +            "age_group"
2026-02-20T22:09:17.5714525Z +        ) or request.query_params.get("difficulty", "6-8")
2026-02-20T22:09:17.5714657Z +        prompt_raw = request.query_params.get("prompt", "")
2026-02-20T22:09:17.5714716Z  
2026-02-20T22:09:17.5714909Z          # Sanitizer le prompt utilisateur pour éviter l'injection
2026-02-20T22:09:17.5715070Z -        from app.utils.prompt_sanitizer import (sanitize_user_prompt,
2026-02-20T22:09:17.5715188Z -                                                validate_prompt_safety)
2026-02-20T22:09:17.5715291Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:17.5715376Z +            sanitize_user_prompt,
2026-02-20T22:09:17.5715457Z +            validate_prompt_safety,
2026-02-20T22:09:17.5715517Z +        )
2026-02-20T22:09:17.5715576Z +
2026-02-20T22:09:17.5715723Z          is_safe, safety_reason = validate_prompt_safety(prompt_raw)
2026-02-20T22:09:17.5715796Z          if not is_safe:
2026-02-20T22:09:17.5716064Z              logger.warning(f"Prompt utilisateur rejeté pour sécurité: {safety_reason}")
2026-02-20T22:09:17.5716205Z              from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5716266Z +
2026-02-20T22:09:17.5716425Z              return sse_error_response(f"Prompt invalide: {safety_reason}")
2026-02-20T22:09:17.5716534Z          prompt = sanitize_user_prompt(prompt_raw)
2026-02-20T22:09:17.5716602Z -        
2026-02-20T22:09:17.5716661Z +
2026-02-20T22:09:17.5716866Z          # Normaliser et valider les paramètres de manière centralisée
2026-02-20T22:09:17.5716971Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5717072Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5717133Z -        
2026-02-20T22:09:17.5717484Z -        exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5717545Z -        
2026-02-20T22:09:17.5717748Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5717933Z +
2026-02-20T22:09:17.5718053Z +        exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5718239Z +            normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5718300Z +        )
2026-02-20T22:09:17.5718363Z +
2026-02-20T22:09:17.5718514Z          # Vérifier que la clé OpenAI est configurée
2026-02-20T22:09:17.5718714Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:17.5718844Z              from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5718905Z +
2026-02-20T22:09:17.5719109Z              return sse_error_response("OpenAI API key non configurée")
2026-02-20T22:09:17.5719171Z -        
2026-02-20T22:09:17.5719236Z +
2026-02-20T22:09:17.5719313Z          async def generate():
2026-02-20T22:09:17.5719376Z              try:
2026-02-20T22:09:17.5719541Z                  # Importer OpenAI de manière conditionnelle
2026-02-20T22:09:17.5719607Z                  try:
2026-02-20T22:09:17.5719701Z                      from openai import AsyncOpenAI
2026-02-20T22:09:17.5719795Z                  except ImportError:
2026-02-20T22:09:17.5720147Z                      yield f"data: {json.dumps({'type': 'error', 'message': 'Bibliothèque OpenAI non installée'})}\n\n"
2026-02-20T22:09:17.5720217Z                      return
2026-02-20T22:09:17.5720279Z -                
2026-02-20T22:09:17.5720353Z +
2026-02-20T22:09:17.5720494Z                  client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:17.5720556Z -                
2026-02-20T22:09:17.5720620Z +
2026-02-20T22:09:17.5720803Z                  # Définir les plages de nombres selon la difficulté
2026-02-20T22:09:17.5720886Z                  difficulty_ranges = {
2026-02-20T22:09:17.5721120Z -                    "INITIE": {"min": 1, "max": 20, "desc": "nombres simples de 1 à 20"},
2026-02-20T22:09:17.5721200Z +                    "INITIE": {
2026-02-20T22:09:17.5721275Z +                        "min": 1,
2026-02-20T22:09:17.5721347Z +                        "max": 20,
2026-02-20T22:09:17.5721518Z +                        "desc": "nombres simples de 1 à 20",
2026-02-20T22:09:17.5721587Z +                    },
2026-02-20T22:09:17.5721804Z                      "PADAWAN": {"min": 1, "max": 100, "desc": "nombres jusqu'à 100"},
2026-02-20T22:09:17.5722124Z -                    "CHEVALIER": {"min": 10, "max": 500, "desc": "nombres jusqu'à 500, calculs intermédiaires"},
2026-02-20T22:09:17.5722431Z -                    "MAITRE": {"min": 50, "max": 1000, "desc": "nombres jusqu'à 1000, problèmes complexes"},
2026-02-20T22:09:17.5722723Z -                    "GRAND_MAITRE": {"min": 100, "max": 10000, "desc": "grands nombres, problèmes avancés"}
2026-02-20T22:09:17.5722807Z +                    "CHEVALIER": {
2026-02-20T22:09:17.5722876Z +                        "min": 10,
2026-02-20T22:09:17.5722946Z +                        "max": 500,
2026-02-20T22:09:17.5723402Z +                        "desc": "nombres jusqu'à 500, calculs intermédiaires",
2026-02-20T22:09:17.5723494Z +                    },
2026-02-20T22:09:17.5723568Z +                    "MAITRE": {
2026-02-20T22:09:17.5723639Z +                        "min": 50,
2026-02-20T22:09:17.5723719Z +                        "max": 1000,
2026-02-20T22:09:17.5723922Z +                        "desc": "nombres jusqu'à 1000, problèmes complexes",
2026-02-20T22:09:17.5723998Z +                    },
2026-02-20T22:09:17.5724090Z +                    "GRAND_MAITRE": {
2026-02-20T22:09:17.5724160Z +                        "min": 100,
2026-02-20T22:09:17.5724232Z +                        "max": 10000,
2026-02-20T22:09:17.5724410Z +                        "desc": "grands nombres, problèmes avancés",
2026-02-20T22:09:17.5724484Z +                    },
2026-02-20T22:09:17.5724548Z                  }
2026-02-20T22:09:17.5724789Z -                diff_info = difficulty_ranges.get(derived_difficulty, difficulty_ranges["PADAWAN"])
2026-02-20T22:09:17.5724861Z -                
2026-02-20T22:09:17.5724961Z +                diff_info = difficulty_ranges.get(
2026-02-20T22:09:17.5725233Z +                    derived_difficulty, difficulty_ranges["PADAWAN"]
2026-02-20T22:09:17.5725304Z +                )
2026-02-20T22:09:17.5725364Z +
2026-02-20T22:09:17.5725514Z                  # Déterminer le contexte thématique
2026-02-20T22:09:17.5725985Z -                has_custom_theme = prompt and any(word in prompt.lower() for word in ['thème', 'theme', 'contexte', 'histoire', 'univers', 'monde'])
2026-02-20T22:09:17.5726575Z -                default_theme = "spatial/galactique (vaisseaux, planètes, étoiles - sans références Star Wars)" if not has_custom_theme else ""
2026-02-20T22:09:17.5726643Z -                
2026-02-20T22:09:17.5726740Z +                has_custom_theme = prompt and any(
2026-02-20T22:09:17.5726834Z +                    word in prompt.lower()
2026-02-20T22:09:17.5726908Z +                    for word in [
2026-02-20T22:09:17.5727013Z +                        "thème",
2026-02-20T22:09:17.5727089Z +                        "theme",
2026-02-20T22:09:17.5727171Z +                        "contexte",
2026-02-20T22:09:17.5727241Z +                        "histoire",
2026-02-20T22:09:17.5727311Z +                        "univers",
2026-02-20T22:09:17.5727384Z +                        "monde",
2026-02-20T22:09:17.5727449Z +                    ]
2026-02-20T22:09:17.5727510Z +                )
2026-02-20T22:09:17.5727600Z +                default_theme = (
2026-02-20T22:09:17.5727901Z +                    "spatial/galactique (vaisseaux, planètes, étoiles - sans références Star Wars)"
2026-02-20T22:09:17.5727989Z +                    if not has_custom_theme
2026-02-20T22:09:17.5728060Z +                    else ""
2026-02-20T22:09:17.5728130Z +                )
2026-02-20T22:09:17.5728189Z +
2026-02-20T22:09:17.5728354Z                  # Construire le prompt système optimisé
2026-02-20T22:09:17.5728643Z                  system_prompt = f"""Tu es un créateur d'exercices mathématiques pédagogiques.
2026-02-20T22:09:17.5728704Z  
2026-02-20T22:09:17.5728791Z  ## CONTRAINTES OBLIGATOIRES
2026-02-20T22:09:17.5728973Z  - Type d'exercice : **{exercise_type}** (STRICTEMENT ce type, aucun autre)
2026-02-20T22:09:17.5729042Z @@ -734,139 +952,155 @@
2026-02-20T22:09:17.5729201Z    "correct_answer": "Réponse numérique uniquement",
2026-02-20T22:09:17.5729312Z    "choices": ["choix1", "choix2", "choix3", "choix4"],
2026-02-20T22:09:17.5729493Z    "explanation": "Explication pédagogique détaillée",
2026-02-20T22:09:17.5729624Z    "hint": "Piste sans révéler la solution"
2026-02-20T22:09:17.5729687Z  }}"""
2026-02-20T22:09:17.5729753Z -                
2026-02-20T22:09:17.5729812Z +
2026-02-20T22:09:17.5730139Z                  # Modèle : o1/o3 pour fractions/texte/mixte/divers quand OPENAI_MODEL_REASONING est défini
2026-02-20T22:09:17.5730290Z                  _reasoning_types = ("fractions", "texte", "mixte", "divers")
2026-02-20T22:09:17.5730504Z -                model = (settings.OPENAI_MODEL_REASONING if settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5730698Z -                         and exercise_type in _reasoning_types else settings.OPENAI_MODEL)
2026-02-20T22:09:17.5730769Z +                model = (
2026-02-20T22:09:17.5730871Z +                    settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5730973Z +                    if settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5731087Z +                    and exercise_type in _reasoning_types
2026-02-20T22:09:17.5731185Z +                    else settings.OPENAI_MODEL
2026-02-20T22:09:17.5731249Z +                )
2026-02-20T22:09:17.5731346Z                  use_o1 = AIConfig.is_o1_model(model)
2026-02-20T22:09:17.5731445Z                  use_o3 = AIConfig.is_o3_model(model)
2026-02-20T22:09:17.5731516Z                  if use_o1:
2026-02-20T22:09:17.5731932Z                      system_prompt += "\n\nCRITIQUE : Retourne UNIQUEMENT un objet JSON valide, sans texte ou markdown avant/après."
2026-02-20T22:09:17.5731996Z -                
2026-02-20T22:09:17.5732061Z +
2026-02-20T22:09:17.5732475Z                  # Construire le prompt utilisateur - PRIORITÉ à la description personnalisée
2026-02-20T22:09:17.5732574Z                  if prompt and prompt.strip():
2026-02-20T22:09:17.5732733Z                      # Si l'utilisateur a une description, elle est PRIORITAIRE
2026-02-20T22:09:17.5733234Z                      user_prompt = f"""INSTRUCTIONS PERSONNALISÉES DE L'UTILISATEUR (PRIORITAIRES) :
2026-02-20T22:09:17.5733456Z  "{prompt.strip()}"
2026-02-20T22:09:17.5733528Z  
2026-02-20T22:09:17.5733898Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py
2026-02-20T22:09:17.5734340Z  Crée un exercice de type {exercise_type} (niveau {derived_difficulty}) en respectant ces instructions personnalisées."""
2026-02-20T22:09:17.5734417Z                  else:
2026-02-20T22:09:17.5734670Z                      # Pas de description personnalisée, utiliser le contexte par défaut
2026-02-20T22:09:17.5735150Z                      user_prompt = f"Crée un exercice de type {exercise_type} pour le niveau {derived_difficulty} avec un contexte spatial engageant."
2026-02-20T22:09:17.5735233Z -                
2026-02-20T22:09:17.5735292Z +
2026-02-20T22:09:17.5735514Z                  # Envoyer un message de démarrage (sans afficher le JSON brut)
2026-02-20T22:09:17.5735821Z                  yield f"data: {json.dumps({'type': 'status', 'message': 'Génération en cours...'})}\n\n"
2026-02-20T22:09:17.5735901Z -                
2026-02-20T22:09:17.5735969Z +
2026-02-20T22:09:17.5736045Z                  api_kwargs = {
2026-02-20T22:09:17.5736127Z                      "model": model,
2026-02-20T22:09:17.5736202Z                      "messages": [
2026-02-20T22:09:17.5736323Z                          {"role": "system", "content": system_prompt},
2026-02-20T22:09:17.5736435Z -                        {"role": "user", "content": user_prompt}
2026-02-20T22:09:17.5736558Z +                        {"role": "user", "content": user_prompt},
2026-02-20T22:09:17.5736629Z                      ],
2026-02-20T22:09:17.5736711Z                      "stream": True,
2026-02-20T22:09:17.5736781Z                  }
2026-02-20T22:09:17.5736851Z                  if use_o1:
2026-02-20T22:09:17.5736968Z                      api_kwargs["max_completion_tokens"] = 4000
2026-02-20T22:09:17.5737045Z                  elif use_o3:
2026-02-20T22:09:17.5737194Z                      api_kwargs["response_format"] = {"type": "json_object"}
2026-02-20T22:09:17.5737307Z                      api_kwargs["max_completion_tokens"] = 4000
2026-02-20T22:09:17.5737582Z -                    api_kwargs["reasoning_effort"] = "low"  # Exercices plus simples que défis
2026-02-20T22:09:17.5737691Z +                    api_kwargs["reasoning_effort"] = (
2026-02-20T22:09:17.5737859Z +                        "low"  # Exercices plus simples que défis
2026-02-20T22:09:17.5737929Z +                    )
2026-02-20T22:09:17.5738002Z                  else:
2026-02-20T22:09:17.5738100Z                      api_kwargs["temperature"] = 0.7
2026-02-20T22:09:17.5738243Z                      api_kwargs["response_format"] = {"type": "json_object"}
2026-02-20T22:09:17.5738312Z -                
2026-02-20T22:09:17.5738371Z +
2026-02-20T22:09:17.5738528Z                  stream = await client.chat.completions.create(**api_kwargs)
2026-02-20T22:09:17.5738591Z -                
2026-02-20T22:09:17.5738665Z +
2026-02-20T22:09:17.5738743Z                  full_response = ""
2026-02-20T22:09:17.5738941Z                  # Ne pas envoyer les chunks JSON au client (pas utile pour l'utilisateur)
2026-02-20T22:09:17.5739147Z                  # On accumule juste la réponse complète en arrière-plan
2026-02-20T22:09:17.5739235Z                  async for chunk in stream:
2026-02-20T22:09:17.5739374Z                      if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:17.5739494Z                          content = chunk.choices[0].delta.content
2026-02-20T22:09:17.5739588Z                          full_response += content
2026-02-20T22:09:17.5739973Z                          # Ne plus envoyer les chunks JSON au client (masqué pour meilleure UX)
2026-02-20T22:09:17.5740042Z -                
2026-02-20T22:09:17.5740109Z +
2026-02-20T22:09:17.5740383Z                  # Parser la réponse JSON complète (o1 peut renvoyer du texte autour du JSON)
2026-02-20T22:09:17.5740529Z                  from app.utils.json_utils import extract_json_from_text
2026-02-20T22:09:17.5740675Z  
2026-02-20T22:09:17.5740743Z                  try:
2026-02-20T22:09:17.5740882Z                      exercise_data = extract_json_from_text(full_response)
2026-02-20T22:09:17.5740951Z -                    
2026-02-20T22:09:17.5741011Z +
2026-02-20T22:09:17.5741233Z                      # Normaliser les données pour correspondre au format attendu
2026-02-20T22:09:17.5741464Z                      # Utiliser les valeurs normalisées (déjà normalisées plus haut)
2026-02-20T22:09:17.5741559Z                      normalized_exercise = {
2026-02-20T22:09:17.5741744Z                          "exercise_type": exercise_type,  # Déjà normalisé
2026-02-20T22:09:17.5741933Z                          "age_group": age_group,  # Groupe d'âge normalisé
2026-02-20T22:09:17.5742207Z                          "difficulty": derived_difficulty,  # Difficulté dérivée du groupe d'âge
2026-02-20T22:09:17.5742419Z -                        "title": exercise_data.get("title", f"Exercice {exercise_type} {age_group}"),
2026-02-20T22:09:17.5742525Z +                        "title": exercise_data.get(
2026-02-20T22:09:17.5742656Z +                            "title", f"Exercice {exercise_type} {age_group}"
2026-02-20T22:09:17.5742725Z +                        ),
2026-02-20T22:09:17.5742849Z                          "question": exercise_data.get("question", ""),
2026-02-20T22:09:17.5743158Z                          "correct_answer": str(exercise_data.get("correct_answer", "")),
2026-02-20T22:09:17.5743281Z                          "choices": exercise_data.get("choices", []),
2026-02-20T22:09:17.5743417Z                          "explanation": exercise_data.get("explanation", ""),
2026-02-20T22:09:17.5743532Z                          "hint": exercise_data.get("hint", ""),
2026-02-20T22:09:17.5743628Z                          "ai_generated": True,
2026-02-20T22:09:17.5743720Z -                        "tags": "ai,generated"
2026-02-20T22:09:17.5743807Z +                        "tags": "ai,generated",
2026-02-20T22:09:17.5743883Z                      }
2026-02-20T22:09:17.5743947Z -                    
2026-02-20T22:09:17.5744007Z +
2026-02-20T22:09:17.5744197Z                      # Optionnellement sauvegarder en base de données
2026-02-20T22:09:17.5744267Z                      try:
2026-02-20T22:09:17.5744404Z                          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5744558Z                          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5744627Z +
2026-02-20T22:09:17.5744784Z                          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5744932Z                          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5745005Z -                        
2026-02-20T22:09:17.5745065Z +
2026-02-20T22:09:17.5745163Z                          async with db_session() as db:
2026-02-20T22:09:17.5745374Z -                            created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5745457Z -                                db=db,
2026-02-20T22:09:17.5745602Z -                                exercise_type=normalized_exercise['exercise_type'],
2026-02-20T22:09:17.5745726Z -                                age_group=normalized_exercise['age_group'],
2026-02-20T22:09:17.5745861Z -                                difficulty=normalized_exercise['difficulty'],
2026-02-20T22:09:17.5745972Z -                                title=normalized_exercise['title'],
2026-02-20T22:09:17.5746089Z -                                question=normalized_exercise['question'],
2026-02-20T22:09:17.5746369Z -                                correct_answer=normalized_exercise['correct_answer'],
2026-02-20T22:09:17.5746486Z -                                choices=normalized_exercise['choices'],
2026-02-20T22:09:17.5746618Z -                                explanation=normalized_exercise['explanation'],
2026-02-20T22:09:17.5746738Z -                                hint=normalized_exercise.get('hint'),
2026-02-20T22:09:17.5746990Z -                                tags=normalized_exercise.get('tags', 'ai,generated'),
2026-02-20T22:09:17.5747083Z -                                ai_generated=True,
2026-02-20T22:09:17.5747175Z -                                locale=locale
2026-02-20T22:09:17.5747266Z +                            created_exercise = (
2026-02-20T22:09:17.5747412Z +                                EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5747489Z +                                    db=db,
2026-02-20T22:09:17.5747643Z +                                    exercise_type=normalized_exercise["exercise_type"],
2026-02-20T22:09:17.5747778Z +                                    age_group=normalized_exercise["age_group"],
2026-02-20T22:09:17.5747911Z +                                    difficulty=normalized_exercise["difficulty"],
2026-02-20T22:09:17.5748031Z +                                    title=normalized_exercise["title"],
2026-02-20T22:09:17.5748160Z +                                    question=normalized_exercise["question"],
2026-02-20T22:09:17.5748271Z +                                    correct_answer=normalized_exercise[
2026-02-20T22:09:17.5748371Z +                                        "correct_answer"
2026-02-20T22:09:17.5748442Z +                                    ],
2026-02-20T22:09:17.5748557Z +                                    choices=normalized_exercise["choices"],
2026-02-20T22:09:17.5748714Z +                                    explanation=normalized_exercise["explanation"],
2026-02-20T22:09:17.5748828Z +                                    hint=normalized_exercise.get("hint"),
2026-02-20T22:09:17.5748945Z +                                    tags=normalized_exercise.get(
2026-02-20T22:09:17.5749049Z +                                        "tags", "ai,generated"
2026-02-20T22:09:17.5749120Z +                                    ),
2026-02-20T22:09:17.5749211Z +                                    ai_generated=True,
2026-02-20T22:09:17.5749299Z +                                    locale=locale,
2026-02-20T22:09:17.5749375Z +                                )
2026-02-20T22:09:17.5749446Z                              )
2026-02-20T22:09:17.5749535Z                              if created_exercise:
2026-02-20T22:09:17.5749683Z -                                normalized_exercise['id'] = created_exercise['id']
2026-02-20T22:09:17.5749819Z +                                normalized_exercise["id"] = created_exercise["id"]
2026-02-20T22:09:17.5749917Z                      except Exception as save_error:
2026-02-20T22:09:17.5750093Z                          logger.warning(f"Erreur lors de la sauvegarde: {save_error}")
2026-02-20T22:09:17.5750267Z                          # Continuer même si la sauvegarde échoue
2026-02-20T22:09:17.5750335Z -                    
2026-02-20T22:09:17.5750395Z +
2026-02-20T22:09:17.5750493Z                      # Envoyer l'exercice complet
2026-02-20T22:09:17.5750726Z                      yield f"data: {json.dumps({'type': 'exercise', 'exercise': normalized_exercise})}\n\n"
2026-02-20T22:09:17.5750800Z -                    
2026-02-20T22:09:17.5750866Z +
2026-02-20T22:09:17.5750983Z                  except json.JSONDecodeError as json_error:
2026-02-20T22:09:17.5751274Z                      yield f"data: {json.dumps({'type': 'error', 'message': f'Erreur de parsing JSON: {str(json_error)}'})}\n\n"
2026-02-20T22:09:17.5751346Z -                    
2026-02-20T22:09:17.5751408Z +
2026-02-20T22:09:17.5751514Z              except Exception as ai_generation_error:
2026-02-20T22:09:17.5751769Z                  logger.error(f"Erreur lors de la génération IA: {ai_generation_error}")
2026-02-20T22:09:17.5751970Z                  logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5752193Z                  yield f"data: {json.dumps({'type': 'error', 'message': str(ai_generation_error)})}\n\n"
2026-02-20T22:09:17.5752256Z -        
2026-02-20T22:09:17.5752322Z +
2026-02-20T22:09:17.5752479Z          return StreamingResponse(
2026-02-20T22:09:17.5752553Z              generate(),
2026-02-20T22:09:17.5752652Z              media_type="text/event-stream",
2026-02-20T22:09:17.5752721Z              headers={
2026-02-20T22:09:17.5752813Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:17.5752899Z                  "Connection": "keep-alive",
2026-02-20T22:09:17.5753396Z                  "X-Accel-Buffering": "no",  # Désactiver le buffering pour nginx
2026-02-20T22:09:17.5753467Z -            }
2026-02-20T22:09:17.5753529Z -        )
2026-02-20T22:09:17.5753599Z -        
2026-02-20T22:09:17.5753659Z +            },
2026-02-20T22:09:17.5753737Z +        )
2026-02-20T22:09:17.5753799Z +
2026-02-20T22:09:17.5753897Z      except Exception as stream_error:
2026-02-20T22:09:17.5754082Z          logger.error(f"Erreur dans generate_ai_exercise_stream: {stream_error}")
2026-02-20T22:09:17.5754177Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5754309Z          from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5754376Z +
2026-02-20T22:09:17.5754482Z          return sse_error_response(str(stream_error))
2026-02-20T22:09:17.5754542Z  
2026-02-20T22:09:17.5754605Z  
2026-02-20T22:09:17.5754672Z  @optional_auth
2026-02-20T22:09:17.5754805Z  async def get_completed_exercises_ids(request: Request):
2026-02-20T22:09:17.5754881Z @@ -877,17 +1111,18 @@
2026-02-20T22:09:17.5754946Z      try:
2026-02-20T22:09:17.5755214Z          # Utilisateur optionnellement authentifié via le décorateur @optional_auth
2026-02-20T22:09:17.5755309Z          current_user = request.state.user
2026-02-20T22:09:17.5755392Z          if not current_user:
2026-02-20T22:09:17.5755552Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:17.5755616Z -        
2026-02-20T22:09:17.5755681Z +
2026-02-20T22:09:17.5755766Z          user_id = current_user.get("id")
2026-02-20T22:09:17.5755837Z          if not user_id:
2026-02-20T22:09:17.5755988Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:17.5756055Z -        
2026-02-20T22:09:17.5756113Z +
2026-02-20T22:09:17.5756335Z          # Récupérer les IDs d'exercices avec au moins une tentative correcte
2026-02-20T22:09:17.5756470Z          from server.database import get_db_connection
2026-02-20T22:09:17.5756531Z +
2026-02-20T22:09:17.5756609Z          conn = get_db_connection()
2026-02-20T22:09:17.5756694Z          cursor = conn.cursor()
2026-02-20T22:09:17.5756758Z          try:
2026-02-20T22:09:17.5756828Z              query = """
2026-02-20T22:09:17.5756920Z                  SELECT DISTINCT exercise_id 
2026-02-20T22:09:17.5757000Z @@ -895,40 +1130,44 @@
2026-02-20T22:09:17.5757104Z                  WHERE user_id = %s AND is_correct = true
2026-02-20T22:09:17.5757167Z              """
2026-02-20T22:09:17.5757264Z              cursor.execute(query, (user_id,))
2026-02-20T22:09:17.5757348Z              rows = cursor.fetchall()
2026-02-20T22:09:17.5757487Z              completed_ids = [row[0] for row in rows] if rows else []
2026-02-20T22:09:17.5757570Z -            
2026-02-20T22:09:17.5757944Z -            logger.debug(f"Récupération de {len(completed_ids)} exercices complétés pour l'utilisateur {user_id}")
2026-02-20T22:09:17.5758006Z +
2026-02-20T22:09:17.5758081Z +            logger.debug(
2026-02-20T22:09:17.5758406Z +                f"Récupération de {len(completed_ids)} exercices complétés pour l'utilisateur {user_id}"
2026-02-20T22:09:17.5758472Z +            )
2026-02-20T22:09:17.5758608Z              return JSONResponse({"completed_ids": completed_ids})
2026-02-20T22:09:17.5758678Z          finally:
2026-02-20T22:09:17.5758905Z              cursor.close()
2026-02-20T22:09:17.5758976Z              conn.close()
2026-02-20T22:09:17.5759038Z -            
2026-02-20T22:09:17.5759103Z +
2026-02-20T22:09:17.5759214Z      except Exception as completed_retrieval_error:
2026-02-20T22:09:17.5759562Z -        logger.error(f"Erreur lors de la récupération des exercices complétés: {completed_retrieval_error}")
2026-02-20T22:09:17.5759749Z +        logger.error(
2026-02-20T22:09:17.5760053Z +            f"Erreur lors de la récupération des exercices complétés: {completed_retrieval_error}"
2026-02-20T22:09:17.5760118Z +        )
2026-02-20T22:09:17.5760225Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5760333Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5760422Z              error=completed_retrieval_error,
2026-02-20T22:09:17.5760496Z              status_code=500,
2026-02-20T22:09:17.5760748Z -            user_message="Erreur lors de la récupération des exercices complétés."
2026-02-20T22:09:17.5761001Z +            user_message="Erreur lors de la récupération des exercices complétés.",
2026-02-20T22:09:17.5761065Z          )
2026-02-20T22:09:17.5761131Z  
2026-02-20T22:09:17.5761190Z  
2026-02-20T22:09:17.5761299Z  async def get_exercises_stats(request: Request):
2026-02-20T22:09:17.5761366Z      """
2026-02-20T22:09:17.5761577Z      Statistiques globales des Épreuves de l'Académie (exercices).
2026-02-20T22:09:17.5761649Z -    
2026-02-20T22:09:17.5761709Z +
2026-02-20T22:09:17.5761797Z      Route: GET /api/exercises/stats
2026-02-20T22:09:17.5761857Z -    
2026-02-20T22:09:17.5761919Z +
2026-02-20T22:09:17.5762098Z      Retourne les statistiques sur l'ensemble des exercices disponibles :
2026-02-20T22:09:17.5762241Z      - Nombre total d'épreuves dans l'Académie
2026-02-20T22:09:17.5762395Z      - Répartition par discipline (type d'exercice)
2026-02-20T22:09:17.5762524Z      - Répartition par rang (difficulté)
2026-02-20T22:09:17.5762702Z      - Répartition par groupe d'apprentis (groupe d'âge)
2026-02-20T22:09:17.5762842Z      - Statistiques de complétion globales
2026-02-20T22:09:17.5762904Z -    
2026-02-20T22:09:17.5763158Z +
2026-02-20T22:09:17.5763379Z      Thème Académie des Sages :
2026-02-20T22:09:17.5763522Z      - Types → Disciplines mathématiques
2026-02-20T22:09:17.5763734Z      - Difficultés → Rangs de l'Académie (Initié → Grand Maître)
2026-02-20T22:09:17.5763903Z      - Groupes d'âge → Niveaux d'apprentissage
2026-02-20T22:09:17.5763966Z      """
2026-02-20T22:09:17.5764035Z @@ -937,232 +1176,353 @@
2026-02-20T22:09:17.5764137Z          logger.debug("Import des modules...")
2026-02-20T22:09:17.5764228Z          from sqlalchemy import func, case
2026-02-20T22:09:17.5764424Z          from app.models.exercise import Exercise, ExerciseType, DifficultyLevel
2026-02-20T22:09:17.5764542Z          from app.models.attempt import Attempt
2026-02-20T22:09:17.5764750Z          from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.5764811Z +
2026-02-20T22:09:17.5764906Z          logger.debug("Imports OK")
2026-02-20T22:09:17.5764975Z -        
2026-02-20T22:09:17.5765039Z +
2026-02-20T22:09:17.5765124Z          async with db_session() as db:
2026-02-20T22:09:17.5765359Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5765594Z              # 1. STATISTIQUES GÉNÉRALES - Chroniques de l'Académie (Exercices)
2026-02-20T22:09:17.5765816Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5765884Z -            
2026-02-20T22:09:17.5766051Z -            total_exercises = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5766140Z -                Exercise.is_active == True
2026-02-20T22:09:17.5766214Z -            ).scalar() or 0
2026-02-20T22:09:17.5766281Z -            
2026-02-20T22:09:17.5766428Z -            total_archived = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5766516Z -                Exercise.is_archived == True
2026-02-20T22:09:17.5766742Z -            ).scalar() or 0
2026-02-20T22:09:17.5766804Z -            
2026-02-20T22:09:17.5766964Z -            ai_generated_count = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5767055Z -                Exercise.ai_generated == True,
2026-02-20T22:09:17.5767145Z -                Exercise.is_active == True
2026-02-20T22:09:17.5767334Z -            ).scalar() or 0
2026-02-20T22:09:17.5767397Z -            
2026-02-20T22:09:17.5767462Z +
2026-02-20T22:09:17.5767539Z +            total_exercises = (
2026-02-20T22:09:17.5767640Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5767745Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5767815Z +                .scalar()
2026-02-20T22:09:17.5767881Z +                or 0
2026-02-20T22:09:17.5767945Z +            )
2026-02-20T22:09:17.5768013Z +
2026-02-20T22:09:17.5768086Z +            total_archived = (
2026-02-20T22:09:17.5768183Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5768296Z +                .filter(Exercise.is_archived == True)
2026-02-20T22:09:17.5768364Z +                .scalar()
2026-02-20T22:09:17.5768429Z +                or 0
2026-02-20T22:09:17.5768491Z +            )
2026-02-20T22:09:17.5768554Z +
2026-02-20T22:09:17.5768632Z +            ai_generated_count = (
2026-02-20T22:09:17.5768730Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5768918Z +                .filter(Exercise.ai_generated == True, Exercise.is_active == True)
2026-02-20T22:09:17.5768986Z +                .scalar()
2026-02-20T22:09:17.5769051Z +                or 0
2026-02-20T22:09:17.5769111Z +            )
2026-02-20T22:09:17.5769178Z +
2026-02-20T22:09:17.5769397Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5769580Z              # 2. RÉPARTITION PAR DISCIPLINE (Type d'exercice)
2026-02-20T22:09:17.5769797Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5769870Z -            
2026-02-20T22:09:17.5769929Z +
2026-02-20T22:09:17.5770072Z              # Noms des disciplines mathématiques
2026-02-20T22:09:17.5770153Z              discipline_names = {
2026-02-20T22:09:17.5770245Z                  "ADDITION": "Art de l'Addition",
2026-02-20T22:09:17.5770421Z                  "SOUSTRACTION": "Maîtrise de la Soustraction",
2026-02-20T22:09:17.5770564Z                  "MULTIPLICATION": "Puissance Multiplicative",
2026-02-20T22:09:17.5770663Z                  "DIVISION": "Science de la Division",
2026-02-20T22:09:17.5770758Z                  "FRACTIONS": "Sagesse des Fractions",
2026-02-20T22:09:17.5770857Z                  "GEOMETRIE": "Vision Spatiale",
2026-02-20T22:09:17.5770982Z                  "TEXTE": "Énigmes Logiques",
2026-02-20T22:09:17.5771115Z                  "MIXTE": "Épreuves Combinées",
2026-02-20T22:09:17.5771242Z -                "DIVERS": "Défis Variés"
2026-02-20T22:09:17.5771364Z +                "DIVERS": "Défis Variés",
2026-02-20T22:09:17.5771516Z              }
2026-02-20T22:09:17.5771577Z -            
2026-02-20T22:09:17.5771672Z -            by_type_query = db.query(
2026-02-20T22:09:17.5771758Z -                Exercise.exercise_type,
2026-02-20T22:09:17.5771862Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5771935Z -            ).filter(
2026-02-20T22:09:17.5772099Z -                Exercise.is_active == True
2026-02-20T22:09:17.5772206Z -            ).group_by(Exercise.exercise_type).all()
2026-02-20T22:09:17.5772268Z -            
2026-02-20T22:09:17.5772333Z +
2026-02-20T22:09:17.5772408Z +            by_type_query = (
2026-02-20T22:09:17.5772608Z +                db.query(Exercise.exercise_type, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5772711Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5772806Z +                .group_by(Exercise.exercise_type)
2026-02-20T22:09:17.5772874Z +                .all()
2026-02-20T22:09:17.5772940Z +            )
2026-02-20T22:09:17.5773247Z +
2026-02-20T22:09:17.5773335Z              by_discipline = {}
2026-02-20T22:09:17.5773459Z              for exercise_type, count in by_type_query:
2026-02-20T22:09:17.5773656Z                  type_upper = str(exercise_type).upper() if exercise_type else "DIVERS"
2026-02-20T22:09:17.5773823Z                  discipline_name = discipline_names.get(type_upper, type_upper)
2026-02-20T22:09:17.5773924Z                  by_discipline[type_upper] = {
2026-02-20T22:09:17.5774007Z                      "count": count,
2026-02-20T22:09:17.5774113Z                      "discipline_name": discipline_name,
2026-02-20T22:09:17.5774346Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5774429Z +                    "percentage": (
2026-02-20T22:09:17.5774545Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5774634Z +                        if total_exercises > 0
2026-02-20T22:09:17.5774707Z +                        else 0
2026-02-20T22:09:17.5774778Z +                    ),
2026-02-20T22:09:17.5774843Z                  }
2026-02-20T22:09:17.5774903Z -            
2026-02-20T22:09:17.5774968Z +
2026-02-20T22:09:17.5775195Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5775342Z              # 3. RÉPARTITION PAR RANG (Difficulté)
2026-02-20T22:09:17.5775564Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5775633Z -            
2026-02-20T22:09:17.5775693Z +
2026-02-20T22:09:17.5775844Z              # Rangs de l'Académie avec descriptions
2026-02-20T22:09:17.5775930Z              academy_ranks = {
2026-02-20T22:09:17.5776250Z -                "INITIE": {"name": "Initié", "description": "Premier pas vers la sagesse", "min_age": 6},
2026-02-20T22:09:17.5776477Z -                "PADAWAN": {"name": "Apprenti", "description": "En cours de formation", "min_age": 9},
2026-02-20T22:09:17.5776791Z -                "CHEVALIER": {"name": "Chevalier", "description": "Maîtrise confirmée", "min_age": 12},
2026-02-20T22:09:17.5777056Z -                "MAITRE": {"name": "Maître", "description": "Sagesse avancée", "min_age": 15},
2026-02-20T22:09:17.5777378Z -                "GRAND_MAITRE": {"name": "Grand Maître", "description": "Sommité de l'Académie", "min_age": 17}
2026-02-20T22:09:17.5777471Z +                "INITIE": {
2026-02-20T22:09:17.5777586Z +                    "name": "Initié",
2026-02-20T22:09:17.5777715Z +                    "description": "Premier pas vers la sagesse",
2026-02-20T22:09:17.5777789Z +                    "min_age": 6,
2026-02-20T22:09:17.5777858Z +                },
2026-02-20T22:09:17.5777931Z +                "PADAWAN": {
2026-02-20T22:09:17.5778012Z +                    "name": "Apprenti",
2026-02-20T22:09:17.5778131Z +                    "description": "En cours de formation",
2026-02-20T22:09:17.5778201Z +                    "min_age": 9,
2026-02-20T22:09:17.5778402Z +                },
2026-02-20T22:09:17.5778484Z +                "CHEVALIER": {
2026-02-20T22:09:17.5778566Z +                    "name": "Chevalier",
2026-02-20T22:09:17.5778727Z +                    "description": "Maîtrise confirmée",
2026-02-20T22:09:17.5778803Z +                    "min_age": 12,
2026-02-20T22:09:17.5778871Z +                },
2026-02-20T22:09:17.5779108Z +                "MAITRE": {
2026-02-20T22:09:17.5779223Z +                    "name": "Maître",
2026-02-20T22:09:17.5779378Z +                    "description": "Sagesse avancée",
2026-02-20T22:09:17.5779452Z +                    "min_age": 15,
2026-02-20T22:09:17.5779514Z +                },
2026-02-20T22:09:17.5779589Z +                "GRAND_MAITRE": {
2026-02-20T22:09:17.5779723Z +                    "name": "Grand Maître",
2026-02-20T22:09:17.5779880Z +                    "description": "Sommité de l'Académie",
2026-02-20T22:09:17.5779952Z +                    "min_age": 17,
2026-02-20T22:09:17.5780021Z +                },
2026-02-20T22:09:17.5780093Z              }
2026-02-20T22:09:17.5780153Z -            
2026-02-20T22:09:17.5780243Z -            by_difficulty_query = db.query(
2026-02-20T22:09:17.5780332Z -                Exercise.difficulty,
2026-02-20T22:09:17.5780439Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5780507Z -            ).filter(
2026-02-20T22:09:17.5780607Z -                Exercise.is_active == True
2026-02-20T22:09:17.5780709Z -            ).group_by(Exercise.difficulty).all()
2026-02-20T22:09:17.5780774Z -            
2026-02-20T22:09:17.5780841Z +
2026-02-20T22:09:17.5780923Z +            by_difficulty_query = (
2026-02-20T22:09:17.5781113Z +                db.query(Exercise.difficulty, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5781212Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5781314Z +                .group_by(Exercise.difficulty)
2026-02-20T22:09:17.5781382Z +                .all()
2026-02-20T22:09:17.5781445Z +            )
2026-02-20T22:09:17.5781515Z +
2026-02-20T22:09:17.5781587Z              by_rank = {}
2026-02-20T22:09:17.5790913Z              for difficulty, count in by_difficulty_query:
2026-02-20T22:09:17.5791151Z                  diff_upper = str(difficulty).upper() if difficulty else "PADAWAN"
2026-02-20T22:09:17.5791603Z -                rank_info = academy_ranks.get(diff_upper, {"name": diff_upper, "description": "Rang spécial", "min_age": 10})
2026-02-20T22:09:17.5791716Z +                rank_info = academy_ranks.get(
2026-02-20T22:09:17.5791793Z +                    diff_upper,
2026-02-20T22:09:17.5792033Z +                    {"name": diff_upper, "description": "Rang spécial", "min_age": 10},
2026-02-20T22:09:17.5792096Z +                )
2026-02-20T22:09:17.5792186Z                  by_rank[diff_upper] = {
2026-02-20T22:09:17.5792263Z                      "count": count,
2026-02-20T22:09:17.5792361Z                      "rank_name": rank_info["name"],
2026-02-20T22:09:17.5792486Z                      "description": rank_info["description"],
2026-02-20T22:09:17.5792592Z                      "min_age": rank_info["min_age"],
2026-02-20T22:09:17.5792828Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5792913Z +                    "percentage": (
2026-02-20T22:09:17.5793172Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5793277Z +                        if total_exercises > 0
2026-02-20T22:09:17.5793348Z +                        else 0
2026-02-20T22:09:17.5793424Z +                    ),
2026-02-20T22:09:17.5793488Z                  }
2026-02-20T22:09:17.5793551Z -            
2026-02-20T22:09:17.5793620Z +
2026-02-20T22:09:17.5793849Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5794057Z              # 4. RÉPARTITION PAR GROUPE D'APPRENTIS (Groupe d'âge)
2026-02-20T22:09:17.5794278Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5794522Z -            
2026-02-20T22:09:17.5794583Z +
2026-02-20T22:09:17.5794671Z              apprentice_groups = {
2026-02-20T22:09:17.5794945Z -                "6-8": {"name": "Novices", "description": "Futurs espoirs de l'Académie"},
2026-02-20T22:09:17.5795224Z -                "8-10": {"name": "Apprentis Débutants", "description": "En début de formation"},
2026-02-20T22:09:17.5795627Z -                "9-11": {"name": "Apprentis Juniors", "description": "Formation intermédiaire"},
2026-02-20T22:09:17.5795923Z -                "10-12": {"name": "Apprentis Confirmés", "description": "Prêts pour les épreuves"},
2026-02-20T22:09:17.5796227Z -                "11-13": {"name": "Aspirants Chevaliers", "description": "Sur le chemin de la maîtrise"},
2026-02-20T22:09:17.5796476Z -                "12-14": {"name": "Chevaliers en Devenir", "description": "Défis avancés"},
2026-02-20T22:09:17.5796752Z -                "14-16": {"name": "Élite de l'Académie", "description": "Formation d'excellence"},
2026-02-20T22:09:17.5797018Z -                "15-17": {"name": "Candidats Maîtres", "description": "Ultimes épreuves"},
2026-02-20T22:09:17.5797260Z -                "17+": {"name": "Conseil des Sages", "description": "Niveau Grand Maître"}
2026-02-20T22:09:17.5797340Z +                "6-8": {
2026-02-20T22:09:17.5797421Z +                    "name": "Novices",
2026-02-20T22:09:17.5797609Z +                    "description": "Futurs espoirs de l'Académie",
2026-02-20T22:09:17.5797675Z +                },
2026-02-20T22:09:17.5797752Z +                "8-10": {
2026-02-20T22:09:17.5797893Z +                    "name": "Apprentis Débutants",
2026-02-20T22:09:17.5798051Z +                    "description": "En début de formation",
2026-02-20T22:09:17.5798124Z +                },
2026-02-20T22:09:17.5798192Z +                "9-11": {
2026-02-20T22:09:17.5798285Z +                    "name": "Apprentis Juniors",
2026-02-20T22:09:17.5798453Z +                    "description": "Formation intermédiaire",
2026-02-20T22:09:17.5798526Z +                },
2026-02-20T22:09:17.5798593Z +                "10-12": {
2026-02-20T22:09:17.5798733Z +                    "name": "Apprentis Confirmés",
2026-02-20T22:09:17.5798906Z +                    "description": "Prêts pour les épreuves",
2026-02-20T22:09:17.5798971Z +                },
2026-02-20T22:09:17.5799047Z +                "11-13": {
2026-02-20T22:09:17.5799156Z +                    "name": "Aspirants Chevaliers",
2026-02-20T22:09:17.5799337Z +                    "description": "Sur le chemin de la maîtrise",
2026-02-20T22:09:17.5799402Z +                },
2026-02-20T22:09:17.5799471Z +                "12-14": {
2026-02-20T22:09:17.5799583Z +                    "name": "Chevaliers en Devenir",
2026-02-20T22:09:17.5799723Z +                    "description": "Défis avancés",
2026-02-20T22:09:17.5799788Z +                },
2026-02-20T22:09:17.5799862Z +                "14-16": {
2026-02-20T22:09:17.5799997Z +                    "name": "Élite de l'Académie",
2026-02-20T22:09:17.5800171Z +                    "description": "Formation d'excellence",
2026-02-20T22:09:17.5800242Z +                },
2026-02-20T22:09:17.5800307Z +                "15-17": {
2026-02-20T22:09:17.5800440Z +                    "name": "Candidats Maîtres",
2026-02-20T22:09:17.5800588Z +                    "description": "Ultimes épreuves",
2026-02-20T22:09:17.5800669Z +                },
2026-02-20T22:09:17.5800737Z +                "17+": {
2026-02-20T22:09:17.5800824Z +                    "name": "Conseil des Sages",
2026-02-20T22:09:17.5800981Z +                    "description": "Niveau Grand Maître",
2026-02-20T22:09:17.5801043Z +                },
2026-02-20T22:09:17.5801105Z              }
2026-02-20T22:09:17.5801167Z -            
2026-02-20T22:09:17.5801258Z -            by_age_query = db.query(
2026-02-20T22:09:17.5801340Z -                Exercise.age_group,
2026-02-20T22:09:17.5801444Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5801611Z -            ).filter(
2026-02-20T22:09:17.5801702Z -                Exercise.is_active == True
2026-02-20T22:09:17.5801800Z -            ).group_by(Exercise.age_group).all()
2026-02-20T22:09:17.5801870Z -            
2026-02-20T22:09:17.5801930Z +
2026-02-20T22:09:17.5802008Z +            by_age_query = (
2026-02-20T22:09:17.5802195Z +                db.query(Exercise.age_group, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5802376Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5802467Z +                .group_by(Exercise.age_group)
2026-02-20T22:09:17.5802534Z +                .all()
2026-02-20T22:09:17.5802602Z +            )
2026-02-20T22:09:17.5802662Z +
2026-02-20T22:09:17.5802746Z              by_apprentice_group = {}
2026-02-20T22:09:17.5802842Z              for age_group, count in by_age_query:
2026-02-20T22:09:17.5803106Z                  group_key = str(age_group) if age_group else "10-12"
2026-02-20T22:09:17.5803536Z -                group_info = apprentice_groups.get(group_key, {"name": f"Groupe {group_key}", "description": "Formation spéciale"})
2026-02-20T22:09:17.5803647Z +                group_info = apprentice_groups.get(
2026-02-20T22:09:17.5803727Z +                    group_key,
2026-02-20T22:09:17.5803793Z +                    {
2026-02-20T22:09:17.5803891Z +                        "name": f"Groupe {group_key}",
2026-02-20T22:09:17.5804060Z +                        "description": "Formation spéciale",
2026-02-20T22:09:17.5804129Z +                    },
2026-02-20T22:09:17.5804192Z +                )
2026-02-20T22:09:17.5804289Z                  by_apprentice_group[group_key] = {
2026-02-20T22:09:17.5804375Z                      "count": count,
2026-02-20T22:09:17.5804472Z                      "group_name": group_info["name"],
2026-02-20T22:09:17.5804585Z                      "description": group_info["description"],
2026-02-20T22:09:17.5804826Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5804909Z +                    "percentage": (
2026-02-20T22:09:17.5805021Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5805117Z +                        if total_exercises > 0
2026-02-20T22:09:17.5805187Z +                        else 0
2026-02-20T22:09:17.5805254Z +                    ),
2026-02-20T22:09:17.5805322Z                  }
2026-02-20T22:09:17.5805390Z -            
2026-02-20T22:09:17.5805450Z +
2026-02-20T22:09:17.5805672Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5805830Z              # 5. STATISTIQUES DE COMPLÉTION GLOBALES
2026-02-20T22:09:17.5806043Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5806106Z -            
2026-02-20T22:09:17.5806174Z +
2026-02-20T22:09:17.5806287Z              # Total des tentatives sur tous les exercices
2026-02-20T22:09:17.5806452Z              total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:17.5806738Z -            correct_attempts = db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:17.5806837Z -                Attempt.is_correct == True
2026-02-20T22:09:17.5806915Z -            ).scalar() or 0
2026-02-20T22:09:17.5806976Z -            
2026-02-20T22:09:17.5807264Z -            global_success_rate = round((correct_attempts / total_attempts * 100), 1) if total_attempts > 0 else 0
2026-02-20T22:09:17.5807441Z -            
2026-02-20T22:09:17.5807522Z +            correct_attempts = (
2026-02-20T22:09:17.5807623Z +                db.query(func.count(Attempt.id))
2026-02-20T22:09:17.5807728Z +                .filter(Attempt.is_correct == True)
2026-02-20T22:09:17.5807798Z +                .scalar()
2026-02-20T22:09:17.5807866Z +                or 0
2026-02-20T22:09:17.5807936Z +            )
2026-02-20T22:09:17.5807996Z +
2026-02-20T22:09:17.5808073Z +            global_success_rate = (
2026-02-20T22:09:17.5808215Z +                round((correct_attempts / total_attempts * 100), 1)
2026-02-20T22:09:17.5808302Z +                if total_attempts > 0
2026-02-20T22:09:17.5808368Z +                else 0
2026-02-20T22:09:17.5808429Z +            )
2026-02-20T22:09:17.5808499Z +
2026-02-20T22:09:17.5808632Z              # Exercices les plus populaires (plus de tentatives)
2026-02-20T22:09:17.5808715Z -            popular_query = db.query(
2026-02-20T22:09:17.5808804Z -                Exercise.id,
2026-02-20T22:09:17.5808882Z -                Exercise.title,
2026-02-20T22:09:17.5808970Z -                Exercise.exercise_type,
2026-02-20T22:09:17.5809054Z -                Exercise.difficulty,
2026-02-20T22:09:17.5809187Z -                func.count(Attempt.id).label('attempt_count')
2026-02-20T22:09:17.5809341Z -            ).join(Attempt, Attempt.exercise_id == Exercise.id).filter(
2026-02-20T22:09:17.5809430Z -                Exercise.is_active == True
2026-02-20T22:09:17.5809509Z -            ).group_by(
2026-02-20T22:09:17.5809714Z -                Exercise.id, Exercise.title, Exercise.exercise_type, Exercise.difficulty
2026-02-20T22:09:17.5809861Z -            ).order_by(func.count(Attempt.id).desc()).limit(5).all()
2026-02-20T22:09:17.5809933Z -            
2026-02-20T22:09:17.5810014Z +            popular_query = (
2026-02-20T22:09:17.5810086Z +                db.query(
2026-02-20T22:09:17.5810161Z +                    Exercise.id,
2026-02-20T22:09:17.5810248Z +                    Exercise.title,
2026-02-20T22:09:17.5810341Z +                    Exercise.exercise_type,
2026-02-20T22:09:17.5810425Z +                    Exercise.difficulty,
2026-02-20T22:09:17.5810559Z +                    func.count(Attempt.id).label("attempt_count"),
2026-02-20T22:09:17.5810625Z +                )
2026-02-20T22:09:17.5810754Z +                .join(Attempt, Attempt.exercise_id == Exercise.id)
2026-02-20T22:09:17.5810863Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5810934Z +                .group_by(
2026-02-20T22:09:17.5811008Z +                    Exercise.id,
2026-02-20T22:09:17.5811088Z +                    Exercise.title,
2026-02-20T22:09:17.5811183Z +                    Exercise.exercise_type,
2026-02-20T22:09:17.5811266Z +                    Exercise.difficulty,
2026-02-20T22:09:17.5811335Z +                )
2026-02-20T22:09:17.5811449Z +                .order_by(func.count(Attempt.id).desc())
2026-02-20T22:09:17.5811523Z +                .limit(5)
2026-02-20T22:09:17.5811589Z +                .all()
2026-02-20T22:09:17.5811655Z +            )
2026-02-20T22:09:17.5811722Z +
2026-02-20T22:09:17.5811802Z              popular_challenges = []
2026-02-20T22:09:17.5811961Z              for ex_id, title, ex_type, diff, attempt_count in popular_query:
2026-02-20T22:09:17.5812119Z                  type_upper = str(ex_type).upper() if ex_type else "DIVERS"
2026-02-20T22:09:17.5812217Z -                popular_challenges.append({
2026-02-20T22:09:17.5812288Z -                    "id": ex_id,
2026-02-20T22:09:17.5812369Z -                    "title": title,
2026-02-20T22:09:17.5812621Z -                    "discipline": discipline_names.get(type_upper, type_upper),
2026-02-20T22:09:17.5812802Z -                    "rank": academy_ranks.get(str(diff).upper(), {}).get("name", diff),
2026-02-20T22:09:17.5812914Z -                    "apprentices_trained": attempt_count
2026-02-20T22:09:17.5813201Z -                })
2026-02-20T22:09:17.5813439Z -            
2026-02-20T22:09:17.5813544Z +                popular_challenges.append(
2026-02-20T22:09:17.5813620Z +                    {
2026-02-20T22:09:17.5813697Z +                        "id": ex_id,
2026-02-20T22:09:17.5813776Z +                        "title": title,
2026-02-20T22:09:17.5813945Z +                        "discipline": discipline_names.get(type_upper, type_upper),
2026-02-20T22:09:17.5814097Z +                        "rank": academy_ranks.get(str(diff).upper(), {}).get(
2026-02-20T22:09:17.5814176Z +                            "name", diff
2026-02-20T22:09:17.5814245Z +                        ),
2026-02-20T22:09:17.5814374Z +                        "apprentices_trained": attempt_count,
2026-02-20T22:09:17.5814440Z +                    }
2026-02-20T22:09:17.5814503Z +                )
2026-02-20T22:09:17.5814569Z +
2026-02-20T22:09:17.5814805Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5814996Z              # 6. STATISTIQUES DES DÉFIS LOGIQUES (Challenges)
2026-02-20T22:09:17.5815209Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5815278Z -            
2026-02-20T22:09:17.5815483Z -            total_logic_challenges = db.query(func.count(LogicChallenge.id)).filter(
2026-02-20T22:09:17.5815591Z -                LogicChallenge.is_archived == False
2026-02-20T22:09:17.5815667Z -            ).scalar() or 0
2026-02-20T22:09:17.5815734Z -            
2026-02-20T22:09:17.5815795Z +
2026-02-20T22:09:17.5815879Z +            total_logic_challenges = (
2026-02-20T22:09:17.5815994Z +                db.query(func.count(LogicChallenge.id))
2026-02-20T22:09:17.5816130Z +                .filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:17.5816200Z +                .scalar()
2026-02-20T22:09:17.5816268Z +                or 0
2026-02-20T22:09:17.5816336Z +            )
2026-02-20T22:09:17.5816396Z +
2026-02-20T22:09:17.5816586Z              # Tous les challenges sont actuellement générés par IA
2026-02-20T22:09:17.5816712Z              ai_generated_challenges = total_logic_challenges
2026-02-20T22:09:17.5816781Z -            
2026-02-20T22:09:17.5816842Z +
2026-02-20T22:09:17.5816978Z              # Tentatives sur les défis logiques
2026-02-20T22:09:17.5817233Z -            total_challenge_attempts = db.query(func.count(LogicChallengeAttempt.id)).scalar() or 0
2026-02-20T22:09:17.5817465Z -            correct_challenge_attempts = db.query(func.count(LogicChallengeAttempt.id)).filter(
2026-02-20T22:09:17.5817579Z -                LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:17.5817663Z -            ).scalar() or 0
2026-02-20T22:09:17.5817726Z -            
2026-02-20T22:09:17.5818125Z -            challenge_success_rate = round((correct_challenge_attempts / total_challenge_attempts * 100), 1) if total_challenge_attempts > 0 else 0
2026-02-20T22:09:17.5818187Z -            
2026-02-20T22:09:17.5818281Z +            total_challenge_attempts = (
2026-02-20T22:09:17.5818449Z +                db.query(func.count(LogicChallengeAttempt.id)).scalar() or 0
2026-02-20T22:09:17.5818513Z +            )
2026-02-20T22:09:17.5818606Z +            correct_challenge_attempts = (
2026-02-20T22:09:17.5818737Z +                db.query(func.count(LogicChallengeAttempt.id))
2026-02-20T22:09:17.5818873Z +                .filter(LogicChallengeAttempt.is_correct == True)
2026-02-20T22:09:17.5818948Z +                .scalar()
2026-02-20T22:09:17.5819015Z +                or 0
2026-02-20T22:09:17.5819077Z +            )
2026-02-20T22:09:17.5819137Z +
2026-02-20T22:09:17.5819226Z +            challenge_success_rate = (
2026-02-20T22:09:17.5819537Z +                round((correct_challenge_attempts / total_challenge_attempts * 100), 1)
2026-02-20T22:09:17.5819635Z +                if total_challenge_attempts > 0
2026-02-20T22:09:17.5819711Z +                else 0
2026-02-20T22:09:17.5819773Z +            )
2026-02-20T22:09:17.5819833Z +
2026-02-20T22:09:17.5820127Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5820344Z              # 7. CONSTRUCTION DE LA RÉPONSE - Chroniques de l'Académie
2026-02-20T22:09:17.5820556Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5820618Z -            
2026-02-20T22:09:17.5820685Z +
2026-02-20T22:09:17.5820819Z              # Totaux combinés pour les stats AI
2026-02-20T22:09:17.5820984Z              total_ai_generated = ai_generated_count + ai_generated_challenges
2026-02-20T22:09:17.5821136Z              total_content = total_exercises + total_logic_challenges
2026-02-20T22:09:17.5821211Z -            
2026-02-20T22:09:17.5821270Z +
2026-02-20T22:09:17.5821347Z              response_data = {
2026-02-20T22:09:17.5821473Z                  "archive_status": "Chroniques accessibles",
2026-02-20T22:09:17.5821556Z                  "academy_statistics": {
2026-02-20T22:09:17.5821659Z                      "total_exercises": total_exercises,
2026-02-20T22:09:17.5821790Z                      "total_challenges": total_logic_challenges,
2026-02-20T22:09:17.5821886Z                      "total_content": total_content,
2026-02-20T22:09:17.5821990Z                      "archived_exercises": total_archived,
2026-02-20T22:09:17.5822091Z                      "ai_generated": total_ai_generated,
2026-02-20T22:09:17.5822208Z                      "ai_generated_exercises": ai_generated_count,
2026-02-20T22:09:17.5822337Z                      "ai_generated_challenges": ai_generated_challenges,
2026-02-20T22:09:17.5822644Z -                    "ai_generated_percentage": round((total_ai_generated / total_content * 100), 1) if total_content > 0 else 0
2026-02-20T22:09:17.5822749Z +                    "ai_generated_percentage": (
2026-02-20T22:09:17.5822887Z +                        round((total_ai_generated / total_content * 100), 1)
2026-02-20T22:09:17.5823092Z +                        if total_content > 0
2026-02-20T22:09:17.5823174Z +                        else 0
2026-02-20T22:09:17.5823250Z +                    ),
2026-02-20T22:09:17.5823312Z                  },
2026-02-20T22:09:17.5823409Z                  "by_discipline": by_discipline,
2026-02-20T22:09:17.5823489Z                  "by_rank": by_rank,
2026-02-20T22:09:17.5823604Z                  "by_apprentice_group": by_apprentice_group,
2026-02-20T22:09:17.5823685Z                  "global_performance": {
2026-02-20T22:09:17.5823850Z                      "total_attempts": total_attempts + total_challenge_attempts,
2026-02-20T22:09:17.5823954Z                      "exercise_attempts": total_attempts,
2026-02-20T22:09:17.5824079Z                      "challenge_attempts": total_challenge_attempts,
2026-02-20T22:09:17.5824283Z -                    "successful_attempts": correct_attempts + correct_challenge_attempts,
2026-02-20T22:09:17.5824388Z +                    "successful_attempts": correct_attempts
2026-02-20T22:09:17.5824481Z +                    + correct_challenge_attempts,
2026-02-20T22:09:17.5824593Z                      "mastery_rate": global_success_rate,
2026-02-20T22:09:17.5824720Z                      "challenge_mastery_rate": challenge_success_rate,
2026-02-20T22:09:17.5824850Z -                    "message": _get_mastery_message(global_success_rate)
2026-02-20T22:09:17.5824984Z +                    "message": _get_mastery_message(global_success_rate),
2026-02-20T22:09:17.5825050Z                  },
2026-02-20T22:09:17.5825159Z                  "legendary_challenges": popular_challenges,
2026-02-20T22:09:17.5825251Z -                "sage_wisdom": _get_sage_wisdom()
2026-02-20T22:09:17.5825350Z +                "sage_wisdom": _get_sage_wisdom(),
2026-02-20T22:09:17.5825533Z              }
2026-02-20T22:09:17.5825598Z -            
2026-02-20T22:09:17.5825944Z -            logger.info(f"Statistiques des épreuves récupérées: {total_exercises} épreuves actives")
2026-02-20T22:09:17.5826007Z +
2026-02-20T22:09:17.5826083Z +            logger.info(
2026-02-20T22:09:17.5826356Z +                f"Statistiques des épreuves récupérées: {total_exercises} épreuves actives"
2026-02-20T22:09:17.5826531Z +            )
2026-02-20T22:09:17.5826632Z              return JSONResponse(response_data)
2026-02-20T22:09:17.5826694Z -            
2026-02-20T22:09:17.5826758Z +
2026-02-20T22:09:17.5826836Z      except Exception as e:
2026-02-20T22:09:17.5827112Z -        logger.error(f"Erreur lors de la récupération des statistiques d'exercices: {e}")
2026-02-20T22:09:17.5827190Z +        logger.error(
2026-02-20T22:09:17.5827419Z +            f"Erreur lors de la récupération des statistiques d'exercices: {e}"
2026-02-20T22:09:17.5827482Z +        )
2026-02-20T22:09:17.5827573Z          traceback.print_exc()
2026-02-20T22:09:17.5827658Z -        return JSONResponse({
2026-02-20T22:09:17.5827775Z -            "archive_status": "Chroniques inaccessibles",
2026-02-20T22:09:17.5828051Z -            "error": "Une perturbation empêche l'accès aux archives. Réessayez plus tard.",
2026-02-20T22:09:17.5828204Z -            "details": str(e) if settings.LOG_LEVEL == "DEBUG" else None
2026-02-20T22:09:17.5828290Z -        }, status_code=500)
2026-02-20T22:09:17.5828369Z +        return JSONResponse(
2026-02-20T22:09:17.5828441Z +            {
2026-02-20T22:09:17.5828559Z +                "archive_status": "Chroniques inaccessibles",
2026-02-20T22:09:17.5828845Z +                "error": "Une perturbation empêche l'accès aux archives. Réessayez plus tard.",
2026-02-20T22:09:17.5828992Z +                "details": str(e) if settings.LOG_LEVEL == "DEBUG" else None,
2026-02-20T22:09:17.5829061Z +            },
2026-02-20T22:09:17.5829133Z +            status_code=500,
2026-02-20T22:09:17.5829202Z +        )
2026-02-20T22:09:17.5829270Z  
2026-02-20T22:09:17.5829329Z  
2026-02-20T22:09:17.5829450Z  def _get_mastery_message(success_rate: float) -> str:
2026-02-20T22:09:17.5829685Z      """Retourne un message thématique basé sur le taux de réussite global."""
2026-02-20T22:09:17.5829769Z      if success_rate >= 90:
2026-02-20T22:09:17.5829849Z @@ -1170,24 +1530,27 @@
2026-02-20T22:09:17.5829925Z      elif success_rate >= 75:
2026-02-20T22:09:17.5830103Z          return "Belle progression des apprentis. Le Conseil est satisfait."
2026-02-20T22:09:17.5830180Z      elif success_rate >= 60:
2026-02-20T22:09:17.5830366Z          return "Les apprentis progressent. La patience est une vertu des sages."
2026-02-20T22:09:17.5830446Z      elif success_rate >= 40:
2026-02-20T22:09:17.5830718Z -        return "L'entraînement doit s'intensifier. La voie de la maîtrise est exigeante."
2026-02-20T22:09:17.5830783Z +        return (
2026-02-20T22:09:17.5831030Z +            "L'entraînement doit s'intensifier. La voie de la maîtrise est exigeante."
2026-02-20T22:09:17.5831105Z +        )
2026-02-20T22:09:17.5831167Z      else:
2026-02-20T22:09:17.5831433Z          return "Beaucoup reste à apprendre. Persévérance et courage sont essentiels."
2026-02-20T22:09:17.5831508Z  
2026-02-20T22:09:17.5831567Z  
2026-02-20T22:09:17.5831652Z  def _get_sage_wisdom() -> str:
2026-02-20T22:09:17.5831816Z      """Retourne une citation de sagesse aléatoire."""
2026-02-20T22:09:17.5831893Z      import random
2026-02-20T22:09:17.5831952Z +
2026-02-20T22:09:17.5832018Z      wisdoms = [
2026-02-20T22:09:17.5832253Z          "La connaissance est le premier pas vers la sagesse. — Les Anciens",
2026-02-20T22:09:17.5832568Z          "Fais-le, ou ne le fais pas. L'hésitation est l'ennemi du progrès. — Proverbe des Maîtres",
2026-02-20T22:09:17.5832793Z          "L'erreur est le chemin de l'apprentissage. — Sagesse ancestrale",
2026-02-20T22:09:17.5833249Z          "Celui qui pose des questions ne s'égare jamais. — Dicton des Sages",
2026-02-20T22:09:17.5833645Z          "L'apprentissage est une voie sans fin. — Chroniques de l'Académie",
2026-02-20T22:09:17.5833876Z          "La patience transforme l'apprenti en maître. — Conseil des Sages",
2026-02-20T22:09:17.5834189Z          "Chaque problème résolu ouvre la porte à de nouveaux défis. — Tradition mathématique",
2026-02-20T22:09:17.5834574Z -        "La persévérance est l'arme secrète du mathématicien. — Archives de l'Académie"
2026-02-20T22:09:17.5834841Z +        "La persévérance est l'arme secrète du mathématicien. — Archives de l'Académie",
2026-02-20T22:09:17.5834905Z      ]
2026-02-20T22:09:17.5834998Z      return random.choice(wisdoms)
2026-02-20T22:09:17.8443814Z --- /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.8446102Z +++ /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py	2026-02-20 22:09:17.833240+00:00
2026-02-20T22:09:17.8447209Z @@ -1,8 +1,9 @@
2026-02-20T22:09:17.8447534Z  """
2026-02-20T22:09:17.8447946Z  Handlers pour la gestion des utilisateurs et statistiques (API)
2026-02-20T22:09:17.8448421Z  """
2026-02-20T22:09:17.8448656Z +
2026-02-20T22:09:17.8448903Z  import json
2026-02-20T22:09:17.8449187Z  import re
2026-02-20T22:09:17.8449463Z  import traceback
2026-02-20T22:09:17.8449858Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:17.8450403Z  
2026-02-20T22:09:17.8450729Z @@ -33,54 +34,67 @@
2026-02-20T22:09:17.8451441Z      Paramètres de requête:
2026-02-20T22:09:17.8452018Z          - timeRange: "7" (7 jours), "30" (30 jours), "90" (3 mois), "all" (tout)
2026-02-20T22:09:17.8452659Z      """
2026-02-20T22:09:17.8453125Z      try:
2026-02-20T22:09:17.8453486Z          current_user = request.state.user
2026-02-20T22:09:17.8453996Z -        
2026-02-20T22:09:17.8454315Z +
2026-02-20T22:09:17.8454642Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8455229Z          username = current_user.get("username")
2026-02-20T22:09:17.8455757Z -        
2026-02-20T22:09:17.8456058Z +
2026-02-20T22:09:17.8456342Z          if not user_id:
2026-02-20T22:09:17.8456830Z              logger.warning(f"ID utilisateur manquant pour {username}")
2026-02-20T22:09:17.8457437Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:17.8457806Z -        
2026-02-20T22:09:17.8457975Z +
2026-02-20T22:09:17.8458334Z          # Récupérer le paramètre timeRange depuis la requête
2026-02-20T22:09:17.8458689Z          from starlette.requests import Request
2026-02-20T22:09:17.8458948Z +
2026-02-20T22:09:17.8459130Z          query_params = dict(request.query_params)
2026-02-20T22:09:17.8459580Z          time_range = query_params.get("timeRange", "30")  # Par défaut 30 jours
2026-02-20T22:09:17.8459929Z -        
2026-02-20T22:09:17.8460219Z +
2026-02-20T22:09:17.8460484Z          # Valider timeRange
2026-02-20T22:09:17.8460866Z          valid_ranges = ["7", "30", "90", "all"]
2026-02-20T22:09:17.8461235Z          if time_range not in valid_ranges:
2026-02-20T22:09:17.8461787Z -            logger.debug(f"TimeRange invalide '{time_range}', utilisation de la valeur par défaut '30'")
2026-02-20T22:09:17.8462226Z +            logger.debug(
2026-02-20T22:09:17.8462632Z +                f"TimeRange invalide '{time_range}', utilisation de la valeur par défaut '30'"
2026-02-20T22:09:17.8463271Z +            )
2026-02-20T22:09:17.8463488Z              time_range = "30"  # Fallback sur 30 jours
2026-02-20T22:09:17.8463740Z -        
2026-02-20T22:09:17.8464513Z -        logger.debug(f"Récupération des statistiques pour l'utilisateur {username} (ID: {user_id}), période: {time_range}")
2026-02-20T22:09:17.8465413Z -        
2026-02-20T22:09:17.8465692Z +
2026-02-20T22:09:17.8465967Z +        logger.debug(
2026-02-20T22:09:17.8466872Z +            f"Récupération des statistiques pour l'utilisateur {username} (ID: {user_id}), période: {time_range}"
2026-02-20T22:09:17.8467339Z +        )
2026-02-20T22:09:17.8467491Z +
2026-02-20T22:09:17.8467656Z          async with db_session() as db:
2026-02-20T22:09:17.8468656Z -            stats = EnhancedServerAdapter.get_user_stats(db, user_id, time_range=time_range)
2026-02-20T22:09:17.8469492Z +            stats = EnhancedServerAdapter.get_user_stats(
2026-02-20T22:09:17.8470032Z +                db, user_id, time_range=time_range
2026-02-20T22:09:17.8470347Z +            )
2026-02-20T22:09:17.8470928Z              if not stats:
2026-02-20T22:09:17.8471891Z -                logger.debug(f"Aucune statistique trouvée pour l'utilisateur {username}, utilisation de valeurs par défaut")
2026-02-20T22:09:17.8472406Z +                logger.debug(
2026-02-20T22:09:17.8472918Z +                    f"Aucune statistique trouvée pour l'utilisateur {username}, utilisation de valeurs par défaut"
2026-02-20T22:09:17.8473737Z +                )
2026-02-20T22:09:17.8473926Z                  stats = {
2026-02-20T22:09:17.8474137Z                      "total_attempts": 0,
2026-02-20T22:09:17.8474392Z                      "correct_attempts": 0,
2026-02-20T22:09:17.8474655Z                      "success_rate": 0,
2026-02-20T22:09:17.8474891Z -                    "by_exercise_type": {}
2026-02-20T22:09:17.8475141Z +                    "by_exercise_type": {},
2026-02-20T22:09:17.8475364Z                  }
2026-02-20T22:09:17.8475528Z -            
2026-02-20T22:09:17.8476067Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py
2026-02-20T22:09:17.8476806Z -            logger.debug(f"Statistiques récupérées pour {username}: {stats.get('total_attempts', 0)} tentatives")
2026-02-20T22:09:17.8477273Z -            
2026-02-20T22:09:17.8477429Z +
2026-02-20T22:09:17.8477590Z +            logger.debug(
2026-02-20T22:09:17.8478038Z +                f"Statistiques récupérées pour {username}: {stats.get('total_attempts', 0)} tentatives"
2026-02-20T22:09:17.8478726Z +            )
2026-02-20T22:09:17.8479014Z +
2026-02-20T22:09:17.8479411Z              experience_points = stats.get("total_attempts", 0) * 10
2026-02-20T22:09:17.8479985Z              performance_by_type = {}
2026-02-20T22:09:17.8481064Z              # Les types sont déjà normalisés en minuscules dans user_service.py
2026-02-20T22:09:17.8481620Z              for exercise_type, type_stats in stats.get("by_exercise_type", {}).items():
2026-02-20T22:09:17.8482189Z                  # S'assurer que la clé est en minuscules (déjà normalisée mais sécurité)
2026-02-20T22:09:17.8482664Z -                type_key = str(exercise_type).lower() if exercise_type else 'unknown'
2026-02-20T22:09:17.8483329Z +                type_key = str(exercise_type).lower() if exercise_type else "unknown"
2026-02-20T22:09:17.8483703Z                  performance_by_type[type_key] = {
2026-02-20T22:09:17.8484008Z                      "completed": type_stats.get("total", 0),
2026-02-20T22:09:17.8484307Z                      "correct": type_stats.get("correct", 0),
2026-02-20T22:09:17.8484717Z -                    "success_rate": (type_stats.get("correct", 0) / type_stats.get("total", 1) * 100)
2026-02-20T22:09:17.8485151Z +                    "success_rate": (
2026-02-20T22:09:17.8485472Z +                        type_stats.get("correct", 0) / type_stats.get("total", 1) * 100
2026-02-20T22:09:17.8485798Z +                    ),
2026-02-20T22:09:17.8485977Z                  }
2026-02-20T22:09:17.8486289Z              # Récupérer l'activité récente (dernières 10 tentatives)
2026-02-20T22:09:17.8486681Z              # Filtrer selon time_range si différent de "all"
2026-02-20T22:09:17.8486964Z              recent_activity = []
2026-02-20T22:09:17.8487167Z              try:
2026-02-20T22:09:17.8487335Z @@ -93,81 +107,130 @@
2026-02-20T22:09:17.8487525Z                  if time_range != "all":
2026-02-20T22:09:17.8487766Z                      days = int(time_range)
2026-02-20T22:09:17.8488094Z                      cutoff_date = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:17.8488428Z                  else:
2026-02-20T22:09:17.8488620Z                      cutoff_date = None
2026-02-20T22:09:17.8489036Z -                
2026-02-20T22:09:17.8489209Z +
2026-02-20T22:09:17.8489468Z                  # Récupérer les tentatives d'exercices récentes
2026-02-20T22:09:17.8489855Z                  # IMPORTANT: Appliquer tous les filter() AVANT limit() et order_by()
2026-02-20T22:09:17.8490263Z                  exercise_attempts_query = db.query(Attempt).filter(
2026-02-20T22:09:17.8490716Z                      Attempt.user_id == user_id
2026-02-20T22:09:17.8490946Z                  )
2026-02-20T22:09:17.8491112Z -                
2026-02-20T22:09:17.8491275Z +
2026-02-20T22:09:17.8491424Z                  if cutoff_date:
2026-02-20T22:09:17.8491834Z -                    exercise_attempts_query = exercise_attempts_query.filter(Attempt.created_at >= cutoff_date)
2026-02-20T22:09:17.8492261Z -                
2026-02-20T22:09:17.8492637Z -                exercise_attempts = exercise_attempts_query.order_by(Attempt.created_at.desc()).limit(5).all()
2026-02-20T22:09:17.8493288Z -                
2026-02-20T22:09:17.8493567Z +                    exercise_attempts_query = exercise_attempts_query.filter(
2026-02-20T22:09:17.8493922Z +                        Attempt.created_at >= cutoff_date
2026-02-20T22:09:17.8494187Z +                    )
2026-02-20T22:09:17.8494363Z +
2026-02-20T22:09:17.8494521Z +                exercise_attempts = (
2026-02-20T22:09:17.8494848Z +                    exercise_attempts_query.order_by(Attempt.created_at.desc())
2026-02-20T22:09:17.8495170Z +                    .limit(5)
2026-02-20T22:09:17.8495372Z +                    .all()
2026-02-20T22:09:17.8495554Z +                )
2026-02-20T22:09:17.8495725Z +
2026-02-20T22:09:17.8495892Z                  for attempt in exercise_attempts:
2026-02-20T22:09:17.8496173Z -                    recent_activity.append({
2026-02-20T22:09:17.8496433Z -                        "type": "exercise",
2026-02-20T22:09:17.8496764Z -                        "description": f"Exercice complété",
2026-02-20T22:09:17.8497287Z -                        "time": attempt.created_at.isoformat() if attempt.created_at else datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8497801Z -                        "is_correct": attempt.is_correct
2026-02-20T22:09:17.8498058Z -                    })
2026-02-20T22:09:17.8498229Z -                
2026-02-20T22:09:17.8498419Z +                    recent_activity.append(
2026-02-20T22:09:17.8498659Z +                        {
2026-02-20T22:09:17.8498860Z +                            "type": "exercise",
2026-02-20T22:09:17.8499194Z +                            "description": f"Exercice complété",
2026-02-20T22:09:17.8499463Z +                            "time": (
2026-02-20T22:09:17.8499722Z +                                attempt.created_at.isoformat()
2026-02-20T22:09:17.8500015Z +                                if attempt.created_at
2026-02-20T22:09:17.8500315Z +                                else datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8500599Z +                            ),
2026-02-20T22:09:17.8500850Z +                            "is_correct": attempt.is_correct,
2026-02-20T22:09:17.8501108Z +                        }
2026-02-20T22:09:17.8501285Z +                    )
2026-02-20T22:09:17.8501450Z +
2026-02-20T22:09:17.8501704Z                  # Récupérer les tentatives de challenges récentes
2026-02-20T22:09:17.8502094Z                  # IMPORTANT: Appliquer tous les filter() AVANT limit() et order_by()
2026-02-20T22:09:17.8502554Z                  challenge_attempts_query = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8502948Z                      LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8503526Z                  )
2026-02-20T22:09:17.8503690Z -                
2026-02-20T22:09:17.8503853Z +
2026-02-20T22:09:17.8504001Z                  if cutoff_date:
2026-02-20T22:09:17.8504479Z -                    challenge_attempts_query = challenge_attempts_query.filter(LogicChallengeAttempt.created_at >= cutoff_date)
2026-02-20T22:09:17.8504966Z -                
2026-02-20T22:09:17.8505627Z -                challenge_attempts = challenge_attempts_query.order_by(LogicChallengeAttempt.created_at.desc()).limit(5).all()
2026-02-20T22:09:17.8506176Z -                
2026-02-20T22:09:17.8506661Z +                    challenge_attempts_query = challenge_attempts_query.filter(
2026-02-20T22:09:17.8507407Z +                        LogicChallengeAttempt.created_at >= cutoff_date
2026-02-20T22:09:17.8508178Z +                    )
2026-02-20T22:09:17.8508460Z +
2026-02-20T22:09:17.8508631Z +                challenge_attempts = (
2026-02-20T22:09:17.8508909Z +                    challenge_attempts_query.order_by(
2026-02-20T22:09:17.8509351Z +                        LogicChallengeAttempt.created_at.desc()
2026-02-20T22:09:17.8509811Z +                    )
2026-02-20T22:09:17.8510110Z +                    .limit(5)
2026-02-20T22:09:17.8510451Z +                    .all()
2026-02-20T22:09:17.8510771Z +                )
2026-02-20T22:09:17.8511054Z +
2026-02-20T22:09:17.8511380Z                  for attempt in challenge_attempts:
2026-02-20T22:09:17.8511848Z -                    recent_activity.append({
2026-02-20T22:09:17.8512298Z -                        "type": "challenge",
2026-02-20T22:09:17.8512893Z -                        "description": f"Défi logique complété",
2026-02-20T22:09:17.8513978Z -                        "time": attempt.created_at.isoformat() if attempt.created_at else datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8514833Z -                        "is_correct": attempt.is_correct
2026-02-20T22:09:17.8515250Z -                    })
2026-02-20T22:09:17.8515533Z -                
2026-02-20T22:09:17.8515831Z +                    recent_activity.append(
2026-02-20T22:09:17.8516222Z +                        {
2026-02-20T22:09:17.8516559Z +                            "type": "challenge",
2026-02-20T22:09:17.8517164Z +                            "description": f"Défi logique complété",
2026-02-20T22:09:17.8517639Z +                            "time": (
2026-02-20T22:09:17.8518086Z +                                attempt.created_at.isoformat()
2026-02-20T22:09:17.8518567Z +                                if attempt.created_at
2026-02-20T22:09:17.8519099Z +                                else datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8519598Z +                            ),
2026-02-20T22:09:17.8520005Z +                            "is_correct": attempt.is_correct,
2026-02-20T22:09:17.8520452Z +                        }
2026-02-20T22:09:17.8520756Z +                    )
2026-02-20T22:09:17.8521047Z +
2026-02-20T22:09:17.8521567Z                  # Trier par date décroissante et prendre les 10 plus récentes
2026-02-20T22:09:17.8522326Z                  recent_activity.sort(key=lambda x: x.get("time", ""), reverse=True)
2026-02-20T22:09:17.8523140Z                  recent_activity = recent_activity[:10]
2026-02-20T22:09:17.8523574Z -                
2026-02-20T22:09:17.8523849Z +
2026-02-20T22:09:17.8524140Z              except Exception as activity_error:
2026-02-20T22:09:17.8525026Z -                logger.error(f"Erreur lors de la récupération de l'activité récente: {activity_error}")
2026-02-20T22:09:17.8525747Z +                logger.error(
2026-02-20T22:09:17.8526433Z +                    f"Erreur lors de la récupération de l'activité récente: {activity_error}"
2026-02-20T22:09:17.8527057Z +                )
2026-02-20T22:09:17.8527370Z                  recent_activity = []
2026-02-20T22:09:17.8527748Z -            
2026-02-20T22:09:17.8528003Z +
2026-02-20T22:09:17.8528270Z              # Calculer le niveau et XP
2026-02-20T22:09:17.8528714Z              def calculate_user_level(xp: int) -> dict:
2026-02-20T22:09:17.8529135Z                  """
2026-02-20T22:09:17.8529693Z                  Calcule le niveau utilisateur basé sur les points d'expérience.
2026-02-20T22:09:17.8530225Z -                
2026-02-20T22:09:17.8530471Z +
2026-02-20T22:09:17.8530700Z                  Args:
2026-02-20T22:09:17.8531104Z                      xp: Points d'expérience totaux
2026-02-20T22:09:17.8531732Z -                
2026-02-20T22:09:17.8532000Z +
2026-02-20T22:09:17.8532228Z                  Returns:
2026-02-20T22:09:17.8532695Z                      Dictionnaire avec current, title, current_xp, next_level_xp
2026-02-20T22:09:17.8533387Z                  """
2026-02-20T22:09:17.8533738Z                  # Seuils de niveau (100 points par niveau)
2026-02-20T22:09:17.8534557Z -                level_thresholds = [0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500, 5500]
2026-02-20T22:09:17.8535156Z -                
2026-02-20T22:09:17.8535449Z +                level_thresholds = [
2026-02-20T22:09:17.8535821Z +                    0,
2026-02-20T22:09:17.8536119Z +                    100,
2026-02-20T22:09:17.8536425Z +                    300,
2026-02-20T22:09:17.8536730Z +                    600,
2026-02-20T22:09:17.8537027Z +                    1000,
2026-02-20T22:09:17.8537337Z +                    1500,
2026-02-20T22:09:17.8537638Z +                    2100,
2026-02-20T22:09:17.8537956Z +                    2800,
2026-02-20T22:09:17.8538250Z +                    3600,
2026-02-20T22:09:17.8538554Z +                    4500,
2026-02-20T22:09:17.8538855Z +                    5500,
2026-02-20T22:09:17.8539157Z +                ]
2026-02-20T22:09:17.8539424Z +
2026-02-20T22:09:17.8539684Z                  # Trouver le niveau actuel
2026-02-20T22:09:17.8540104Z                  current_level = 1
2026-02-20T22:09:17.8540558Z                  for i, threshold in enumerate(level_thresholds):
2026-02-20T22:09:17.8541052Z                      if xp >= threshold:
2026-02-20T22:09:17.8541462Z                          current_level = i + 1
2026-02-20T22:09:17.8541854Z -                
2026-02-20T22:09:17.8542110Z +
2026-02-20T22:09:17.8542456Z                  # Calculer les XP pour le niveau actuel et suivant
2026-02-20T22:09:17.8543374Z -                current_xp = xp - level_thresholds[current_level - 1] if current_level > 1 else xp
2026-02-20T22:09:17.8544656Z -                next_level_xp = level_thresholds[current_level] - level_thresholds[current_level - 1] if current_level < len(level_thresholds) else 100
2026-02-20T22:09:17.8545646Z -                
2026-02-20T22:09:17.8545930Z +                current_xp = (
2026-02-20T22:09:17.8546349Z +                    xp - level_thresholds[current_level - 1]
2026-02-20T22:09:17.8546832Z +                    if current_level > 1
2026-02-20T22:09:17.8547224Z +                    else xp
2026-02-20T22:09:17.8547539Z +                )
2026-02-20T22:09:17.8547827Z +                next_level_xp = (
2026-02-20T22:09:17.8548239Z +                    level_thresholds[current_level]
2026-02-20T22:09:17.8548729Z +                    - level_thresholds[current_level - 1]
2026-02-20T22:09:17.8549242Z +                    if current_level < len(level_thresholds)
2026-02-20T22:09:17.8549683Z +                    else 100
2026-02-20T22:09:17.8550003Z +                )
2026-02-20T22:09:17.8550262Z +
2026-02-20T22:09:17.8550521Z                  # Titres de niveau
2026-02-20T22:09:17.8550916Z                  level_titles = {
2026-02-20T22:09:17.8551278Z                      1: "Jeune Padawan",
2026-02-20T22:09:17.8551671Z                      2: "Padawan",
2026-02-20T22:09:17.8552037Z                      3: "Chevalier Jedi",
2026-02-20T22:09:17.8552412Z @@ -176,121 +239,153 @@
2026-02-20T22:09:17.8552837Z                      6: "Maître du Conseil",
2026-02-20T22:09:17.8553460Z                      7: "Légende Jedi",
2026-02-20T22:09:17.8553830Z                      8: "Gardien de la Force",
2026-02-20T22:09:17.8554245Z                      9: "Seigneur Jedi",
2026-02-20T22:09:17.8554625Z                      10: "Archiviste Jedi",
2026-02-20T22:09:17.8554995Z -                    11: "Grand Archiviste"
2026-02-20T22:09:17.8555387Z +                    11: "Grand Archiviste",
2026-02-20T22:09:17.8555763Z                  }
2026-02-20T22:09:17.8556029Z -                
2026-02-20T22:09:17.8556286Z +
2026-02-20T22:09:17.8556703Z                  title = level_titles.get(current_level, f"Niveau {current_level}")
2026-02-20T22:09:17.8557464Z -                
2026-02-20T22:09:17.8557739Z +
2026-02-20T22:09:17.8557976Z                  return {
2026-02-20T22:09:17.8558326Z                      "current": current_level,
2026-02-20T22:09:17.8558743Z                      "title": title,
2026-02-20T22:09:17.8559312Z                      "current_xp": current_xp,
2026-02-20T22:09:17.8559758Z -                    "next_level_xp": next_level_xp
2026-02-20T22:09:17.8560213Z +                    "next_level_xp": next_level_xp,
2026-02-20T22:09:17.8560628Z                  }
2026-02-20T22:09:17.8560887Z -            
2026-02-20T22:09:17.8561148Z +
2026-02-20T22:09:17.8561493Z              level_data = calculate_user_level(experience_points)
2026-02-20T22:09:17.8561982Z -            
2026-02-20T22:09:17.8562242Z +
2026-02-20T22:09:17.8562538Z              # Calculer la progression dans le temps
2026-02-20T22:09:17.8563154Z              progress_over_time = []
2026-02-20T22:09:17.8563563Z              exercises_by_day = []
2026-02-20T22:09:17.8563923Z -            
2026-02-20T22:09:17.8564172Z +
2026-02-20T22:09:17.8564406Z              try:
2026-02-20T22:09:17.8564733Z                  from collections import defaultdict
2026-02-20T22:09:17.8565272Z                  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:17.8565764Z  
2026-02-20T22:09:17.8566179Z                  # Calculer la date de début selon time_range
2026-02-20T22:09:17.8566646Z                  if time_range == "all":
2026-02-20T22:09:17.8567438Z -                    start_date = datetime.now(timezone.utc) - timedelta(days=90)  # Par défaut 90 jours
2026-02-20T22:09:17.8568213Z +                    start_date = datetime.now(timezone.utc) - timedelta(
2026-02-20T22:09:17.8568709Z +                        days=90
2026-02-20T22:09:17.8569145Z +                    )  # Par défaut 90 jours
2026-02-20T22:09:17.8569518Z                  else:
2026-02-20T22:09:17.8570037Z -                    start_date = datetime.now(timezone.utc) - timedelta(days=int(time_range))
2026-02-20T22:09:17.8570656Z -                
2026-02-20T22:09:17.8571029Z +                    start_date = datetime.now(timezone.utc) - timedelta(
2026-02-20T22:09:17.8571547Z +                        days=int(time_range)
2026-02-20T22:09:17.8571918Z +                    )
2026-02-20T22:09:17.8572205Z +
2026-02-20T22:09:17.8572580Z                  # Récupérer les tentatives par jour
2026-02-20T22:09:17.8573290Z                  daily_stats = defaultdict(lambda: {"total": 0, "correct": 0})
2026-02-20T22:09:17.8573815Z -                
2026-02-20T22:09:17.8574160Z -                attempts_query = db.query(Attempt).filter(
2026-02-20T22:09:17.8574638Z -                    Attempt.user_id == user_id,
2026-02-20T22:09:17.8575097Z -                    Attempt.created_at >= start_date
2026-02-20T22:09:17.8575529Z -                ).all()
2026-02-20T22:09:17.8575828Z -                
2026-02-20T22:09:17.8576090Z +
2026-02-20T22:09:17.8576342Z +                attempts_query = (
2026-02-20T22:09:17.8576711Z +                    db.query(Attempt)
2026-02-20T22:09:17.8577073Z +                    .filter(
2026-02-20T22:09:17.8577569Z +                        Attempt.user_id == user_id, Attempt.created_at >= start_date
2026-02-20T22:09:17.8578124Z +                    )
2026-02-20T22:09:17.8578425Z +                    .all()
2026-02-20T22:09:17.8578733Z +                )
2026-02-20T22:09:17.8578991Z +
2026-02-20T22:09:17.8579266Z                  for attempt in attempts_query:
2026-02-20T22:09:17.8579688Z                      if attempt.created_at:
2026-02-20T22:09:17.8580178Z                          day_key = attempt.created_at.date().isoformat()
2026-02-20T22:09:17.8580703Z                          daily_stats[day_key]["total"] += 1
2026-02-20T22:09:17.8581161Z                          if attempt.is_correct:
2026-02-20T22:09:17.8581623Z                              daily_stats[day_key]["correct"] += 1
2026-02-20T22:09:17.8582056Z -                
2026-02-20T22:09:17.8582493Z +
2026-02-20T22:09:17.8582889Z                  # Créer les datasets pour les graphiques
2026-02-20T22:09:17.8583556Z                  sorted_days = sorted(daily_stats.keys())
2026-02-20T22:09:17.8584004Z                  progress_over_time = {
2026-02-20T22:09:17.8584408Z                      "labels": sorted_days,
2026-02-20T22:09:17.8585038Z -                    "datasets": [{
2026-02-20T22:09:17.8585550Z -                        "label": "Taux de réussite (%)",
2026-02-20T22:09:17.8585986Z -                        "data": [
2026-02-20T22:09:17.8586516Z -                            (daily_stats[day]["correct"] / daily_stats[day]["total"] * 100) 
2026-02-20T22:09:17.8587182Z -                            if daily_stats[day]["total"] > 0 else 0
2026-02-20T22:09:17.8587674Z -                            for day in sorted_days
2026-02-20T22:09:17.8588091Z -                        ]
2026-02-20T22:09:17.8588400Z -                    }]
2026-02-20T22:09:17.8588718Z +                    "datasets": [
2026-02-20T22:09:17.8589082Z +                        {
2026-02-20T22:09:17.8589556Z +                            "label": "Taux de réussite (%)",
2026-02-20T22:09:17.8590007Z +                            "data": [
2026-02-20T22:09:17.8590373Z +                                (
2026-02-20T22:09:17.8590724Z +                                    (
2026-02-20T22:09:17.8591159Z +                                        daily_stats[day]["correct"]
2026-02-20T22:09:17.8591675Z +                                        / daily_stats[day]["total"]
2026-02-20T22:09:17.8592147Z +                                        * 100
2026-02-20T22:09:17.8592537Z +                                    )
2026-02-20T22:09:17.8593115Z +                                    if daily_stats[day]["total"] > 0
2026-02-20T22:09:17.8593578Z +                                    else 0
2026-02-20T22:09:17.8593964Z +                                )
2026-02-20T22:09:17.8594351Z +                                for day in sorted_days
2026-02-20T22:09:17.8594785Z +                            ],
2026-02-20T22:09:17.8595108Z +                        }
2026-02-20T22:09:17.8595416Z +                    ],
2026-02-20T22:09:17.8595698Z                  }
2026-02-20T22:09:17.8595969Z -                
2026-02-20T22:09:17.8596230Z +
2026-02-20T22:09:17.8596492Z                  exercises_by_day = {
2026-02-20T22:09:17.8596903Z                      "labels": sorted_days,
2026-02-20T22:09:17.8597305Z -                    "datasets": [{
2026-02-20T22:09:17.8597823Z -                        "label": "Exercices complétés",
2026-02-20T22:09:17.8598396Z -                        "data": [daily_stats[day]["total"] for day in sorted_days],
2026-02-20T22:09:17.8598990Z -                        "borderColor": "rgb(139, 92, 246)",
2026-02-20T22:09:17.8599497Z -                        "backgroundColor": "rgba(139, 92, 246, 0.1)"
2026-02-20T22:09:17.8599965Z -                    }]
2026-02-20T22:09:17.8600279Z +                    "datasets": [
2026-02-20T22:09:17.8600635Z +                        {
2026-02-20T22:09:17.8601097Z +                            "label": "Exercices complétés",
2026-02-20T22:09:17.8601665Z +                            "data": [daily_stats[day]["total"] for day in sorted_days],
2026-02-20T22:09:17.8602261Z +                            "borderColor": "rgb(139, 92, 246)",
2026-02-20T22:09:17.8602784Z +                            "backgroundColor": "rgba(139, 92, 246, 0.1)",
2026-02-20T22:09:17.8603402Z +                        }
2026-02-20T22:09:17.8603704Z +                    ],
2026-02-20T22:09:17.8604005Z                  }
2026-02-20T22:09:17.8604286Z -                
2026-02-20T22:09:17.8604546Z +
2026-02-20T22:09:17.8604882Z              except Exception as progress_calculation_error:
2026-02-20T22:09:17.8605646Z -                logger.error(f"Erreur lors du calcul de la progression: {progress_calculation_error}")
2026-02-20T22:09:17.8606363Z +                logger.error(
2026-02-20T22:09:17.8606928Z +                    f"Erreur lors du calcul de la progression: {progress_calculation_error}"
2026-02-20T22:09:17.8607710Z +                )
2026-02-20T22:09:17.8608086Z                  progress_over_time = {"labels": [], "datasets": []}
2026-02-20T22:09:17.8608654Z                  exercises_by_day = {"labels": [], "datasets": []}
2026-02-20T22:09:17.8609119Z -            
2026-02-20T22:09:17.8609511Z +
2026-02-20T22:09:17.8609874Z              # Compter les challenges complétés
2026-02-20T22:09:17.8610303Z              try:
2026-02-20T22:09:17.8610752Z                  from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:17.8611453Z -                total_challenges = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8612093Z -                    LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:17.8612646Z -                    LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:17.8613495Z -                ).count()
2026-02-20T22:09:17.8613808Z +
2026-02-20T22:09:17.8614067Z +                total_challenges = (
2026-02-20T22:09:17.8614482Z +                    db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8614883Z +                    .filter(
2026-02-20T22:09:17.8615281Z +                        LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:17.8615794Z +                        LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:17.8616237Z +                    )
2026-02-20T22:09:17.8616528Z +                    .count()
2026-02-20T22:09:17.8616843Z +                )
2026-02-20T22:09:17.8617196Z              except Exception as challenge_count_error:
2026-02-20T22:09:17.8617889Z -                logger.error(f"Erreur lors du comptage des challenges: {challenge_count_error}")
2026-02-20T22:09:17.8618511Z +                logger.error(
2026-02-20T22:09:17.8618833Z +                    f"Erreur lors du comptage des challenges: {challenge_count_error}"
2026-02-20T22:09:17.8619175Z +                )
2026-02-20T22:09:17.8619352Z                  total_challenges = 0
2026-02-20T22:09:17.8619580Z -            
2026-02-20T22:09:17.8619738Z +
2026-02-20T22:09:17.8619883Z              response_data = {
2026-02-20T22:09:17.8620153Z -                'total_exercises': stats.get("total_attempts", 0),
2026-02-20T22:09:17.8620468Z -                'total_challenges': total_challenges,
2026-02-20T22:09:17.8620793Z -                'correct_answers': stats.get("correct_attempts", 0),
2026-02-20T22:09:17.8621130Z -                'success_rate': stats.get("success_rate", 0),
2026-02-20T22:09:17.8621443Z -                'experience_points': experience_points,
2026-02-20T22:09:17.8621746Z -                'performance_by_type': performance_by_type,
2026-02-20T22:09:17.8622036Z -                'recent_activity': recent_activity,
2026-02-20T22:09:17.8622293Z -                'level': level_data,
2026-02-20T22:09:17.8622543Z -                'progress_over_time': progress_over_time,
2026-02-20T22:09:17.8622830Z -                'exercises_by_day': exercises_by_day,
2026-02-20T22:09:17.8623384Z -                'lastUpdated': datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8623740Z +                "total_exercises": stats.get("total_attempts", 0),
2026-02-20T22:09:17.8624042Z +                "total_challenges": total_challenges,
2026-02-20T22:09:17.8624346Z +                "correct_answers": stats.get("correct_attempts", 0),
2026-02-20T22:09:17.8624675Z +                "success_rate": stats.get("success_rate", 0),
2026-02-20T22:09:17.8624970Z +                "experience_points": experience_points,
2026-02-20T22:09:17.8625271Z +                "performance_by_type": performance_by_type,
2026-02-20T22:09:17.8625554Z +                "recent_activity": recent_activity,
2026-02-20T22:09:17.8625815Z +                "level": level_data,
2026-02-20T22:09:17.8626057Z +                "progress_over_time": progress_over_time,
2026-02-20T22:09:17.8626338Z +                "exercises_by_day": exercises_by_day,
2026-02-20T22:09:17.8626659Z +                "lastUpdated": datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8627118Z              }
2026-02-20T22:09:17.8627278Z -            
2026-02-20T22:09:17.8627426Z +
2026-02-20T22:09:17.8627603Z              return JSONResponse(response_data)
2026-02-20T22:09:17.8627839Z -            
2026-02-20T22:09:17.8627995Z +
2026-02-20T22:09:17.8628167Z      except Exception as stats_retrieval_error:
2026-02-20T22:09:17.8628810Z -        logger.error(f"Erreur lors de la récupération des statistiques: {stats_retrieval_error}")
2026-02-20T22:09:17.8629222Z +        logger.error(
2026-02-20T22:09:17.8629581Z +            f"Erreur lors de la récupération des statistiques: {stats_retrieval_error}"
2026-02-20T22:09:17.8629927Z +        )
2026-02-20T22:09:17.8630104Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8630623Z -        return JSONResponse({"error": "Erreur lors de la récupération des statistiques"}, status_code=500)
2026-02-20T22:09:17.8631058Z +        return JSONResponse(
2026-02-20T22:09:17.8631402Z +            {"error": "Erreur lors de la récupération des statistiques"},
2026-02-20T22:09:17.8631725Z +            status_code=500,
2026-02-20T22:09:17.8631914Z +        )
2026-02-20T22:09:17.8632061Z  
2026-02-20T22:09:17.8632193Z  
2026-02-20T22:09:17.8632345Z  @rate_limit_register
2026-02-20T22:09:17.8632564Z  async def create_user_account(request: Request):
2026-02-20T22:09:17.8632832Z      """
2026-02-20T22:09:17.8633283Z      Endpoint pour créer un nouveau compte utilisateur.
2026-02-20T22:09:17.8633577Z      Route: POST /api/users/
2026-02-20T22:09:17.8633765Z -    
2026-02-20T22:09:17.8633909Z +
2026-02-20T22:09:17.8634044Z      Body JSON:
2026-02-20T22:09:17.8634206Z      {
2026-02-20T22:09:17.8634375Z          "username": "nom_utilisateur",
2026-02-20T22:09:17.8634610Z          "email": "email@example.com",
2026-02-20T22:09:17.8634852Z          "password": "MotDePasse123",
2026-02-20T22:09:17.8635068Z @@ -303,169 +398,183 @@
2026-02-20T22:09:17.8635252Z              status_code=403,
2026-02-20T22:09:17.8635442Z          )
2026-02-20T22:09:17.8635590Z      try:
2026-02-20T22:09:17.8635822Z          # Récupérer les données JSON de la requête
2026-02-20T22:09:17.8636091Z          data = await request.json()
2026-02-20T22:09:17.8636299Z -        
2026-02-20T22:09:17.8636442Z +
2026-02-20T22:09:17.8636601Z          # Extraire les champs requis
2026-02-20T22:09:17.8636858Z -        username = data.get('username', '').strip()
2026-02-20T22:09:17.8637137Z -        email = data.get('email', '').strip()
2026-02-20T22:09:17.8637394Z -        password = data.get('password', '')
2026-02-20T22:09:17.8637688Z -        full_name = data.get('full_name', '').strip() or None
2026-02-20T22:09:17.8637952Z -        
2026-02-20T22:09:17.8638139Z +        username = data.get("username", "").strip()
2026-02-20T22:09:17.8638402Z +        email = data.get("email", "").strip()
2026-02-20T22:09:17.8638658Z +        password = data.get("password", "")
2026-02-20T22:09:17.8638941Z +        full_name = data.get("full_name", "").strip() or None
2026-02-20T22:09:17.8639205Z +
2026-02-20T22:09:17.8639412Z          # Validation basique côté serveur
2026-02-20T22:09:17.8639643Z          if not username:
2026-02-20T22:09:17.8639844Z              return JSONResponse(
2026-02-20T22:09:17.8640094Z -                {"error": "Le nom d'utilisateur est requis"},
2026-02-20T22:09:17.8640367Z -                status_code=400
2026-02-20T22:09:17.8640567Z -            )
2026-02-20T22:09:17.8640722Z -        
2026-02-20T22:09:17.8640950Z +                {"error": "Le nom d'utilisateur est requis"}, status_code=400
2026-02-20T22:09:17.8641012Z +            )
2026-02-20T22:09:17.8641070Z +
2026-02-20T22:09:17.8641147Z          if len(username) < 3:
2026-02-20T22:09:17.8641230Z              return JSONResponse(
2026-02-20T22:09:17.8641462Z                  {"error": "Le nom d'utilisateur doit contenir au moins 3 caractères"},
2026-02-20T22:09:17.8641536Z -                status_code=400
2026-02-20T22:09:17.8641603Z -            )
2026-02-20T22:09:17.8641866Z -        
2026-02-20T22:09:17.8641941Z +                status_code=400,
2026-02-20T22:09:17.8642002Z +            )
2026-02-20T22:09:17.8642065Z +
2026-02-20T22:09:17.8642132Z          if not email:
2026-02-20T22:09:17.8642208Z -            return JSONResponse(
2026-02-20T22:09:17.8642308Z -                {"error": "L'email est requis"},
2026-02-20T22:09:17.8642491Z -                status_code=400
2026-02-20T22:09:17.8642551Z -            )
2026-02-20T22:09:17.8642611Z -        
2026-02-20T22:09:17.8642800Z +            return JSONResponse({"error": "L'email est requis"}, status_code=400)
2026-02-20T22:09:17.8642859Z +
2026-02-20T22:09:17.8642943Z          # Validation email basique
2026-02-20T22:09:17.8643283Z -        email_pattern = r'^[^\s@]+@[^\s@]+\.[^\s@]+$'
2026-02-20T22:09:17.8643391Z +        email_pattern = r"^[^\s@]+@[^\s@]+\.[^\s@]+$"
2026-02-20T22:09:17.8643492Z          if not re.match(email_pattern, email):
2026-02-20T22:09:17.8643578Z -            return JSONResponse(
2026-02-20T22:09:17.8643683Z -                {"error": "Format d'email invalide"},
2026-02-20T22:09:17.8643756Z -                status_code=400
2026-02-20T22:09:17.8643817Z -            )
2026-02-20T22:09:17.8643881Z -        
2026-02-20T22:09:17.8644073Z +            return JSONResponse({"error": "Format d'email invalide"}, status_code=400)
2026-02-20T22:09:17.8644131Z +
2026-02-20T22:09:17.8644220Z          if not password:
2026-02-20T22:09:17.8644297Z              return JSONResponse(
2026-02-20T22:09:17.8644400Z -                {"error": "Le mot de passe est requis"},
2026-02-20T22:09:17.8644471Z -                status_code=400
2026-02-20T22:09:17.8644537Z -            )
2026-02-20T22:09:17.8644595Z -        
2026-02-20T22:09:17.8644730Z +                {"error": "Le mot de passe est requis"}, status_code=400
2026-02-20T22:09:17.8644796Z +            )
2026-02-20T22:09:17.8644854Z +
2026-02-20T22:09:17.8645049Z          # Validation mot de passe selon le schéma UserCreate
2026-02-20T22:09:17.8645127Z          if len(password) < 8:
2026-02-20T22:09:17.8645213Z              return JSONResponse(
2026-02-20T22:09:17.8645430Z                  {"error": "Le mot de passe doit contenir au moins 8 caractères"},
2026-02-20T22:09:17.8645501Z -                status_code=400
2026-02-20T22:09:17.8645566Z -            )
2026-02-20T22:09:17.8645623Z -        
2026-02-20T22:09:17.8645697Z +                status_code=400,
2026-02-20T22:09:17.8645763Z +            )
2026-02-20T22:09:17.8645821Z +
2026-02-20T22:09:17.8645934Z          if not any(char.isdigit() for char in password):
2026-02-20T22:09:17.8646006Z              return JSONResponse(
2026-02-20T22:09:17.8646158Z                  {"error": "Le mot de passe doit contenir au moins un chiffre"},
2026-02-20T22:09:17.8646227Z -                status_code=400
2026-02-20T22:09:17.8646285Z -            )
2026-02-20T22:09:17.8646350Z -        
2026-02-20T22:09:17.8646417Z +                status_code=400,
2026-02-20T22:09:17.8646476Z +            )
2026-02-20T22:09:17.8646536Z +
2026-02-20T22:09:17.8646656Z          if not any(char.isupper() for char in password):
2026-02-20T22:09:17.8646728Z              return JSONResponse(
2026-02-20T22:09:17.8646884Z                  {"error": "Le mot de passe doit contenir au moins une majuscule"},
2026-02-20T22:09:17.8646958Z -                status_code=400
2026-02-20T22:09:17.8647017Z -            )
2026-02-20T22:09:17.8647078Z -        
2026-02-20T22:09:17.8647146Z +                status_code=400,
2026-02-20T22:09:17.8647210Z +            )
2026-02-20T22:09:17.8647267Z +
2026-02-20T22:09:17.8647399Z          # Créer l'utilisateur via le service
2026-02-20T22:09:17.8647465Z          try:
2026-02-20T22:09:17.8647547Z              async with db_session() as db:
2026-02-20T22:09:17.8647670Z                  # Créer le schéma UserCreate
2026-02-20T22:09:17.8647757Z                  user_create = UserCreate(
2026-02-20T22:09:17.8647834Z                      username=username,
2026-02-20T22:09:17.8647902Z                      email=email,
2026-02-20T22:09:17.8648435Z                      ***
2026-02-20T22:09:17.8648521Z -                    full_name=full_name
2026-02-20T22:09:17.8648585Z -                )
2026-02-20T22:09:17.8648645Z -                
2026-02-20T22:09:17.8648744Z +                    full_name=full_name,
2026-02-20T22:09:17.8648814Z +                )
2026-02-20T22:09:17.8648875Z +
2026-02-20T22:09:17.8649123Z                  # Créer l'utilisateur
2026-02-20T22:09:17.8649226Z                  user = create_user(db, user_create)
2026-02-20T22:09:17.8649290Z -                
2026-02-20T22:09:17.8649349Z +
2026-02-20T22:09:17.8649509Z                  # Générer un token de vérification email
2026-02-20T22:09:17.8649619Z                  from datetime import datetime, timezone
2026-02-20T22:09:17.8649679Z  
2026-02-20T22:09:17.8649801Z -                from app.utils.email_verification import \
2026-02-20T22:09:17.8649894Z -                    generate_verification_token
2026-02-20T22:09:17.8649956Z -                
2026-02-20T22:09:17.8650151Z +                from app.utils.email_verification import generate_verification_token
2026-02-20T22:09:17.8650216Z +
2026-02-20T22:09:17.8650348Z                  verification_token = generate_verification_token()
2026-02-20T22:09:17.8650475Z                  user.email_verification_token = verification_token
2026-02-20T22:09:17.8650771Z                  user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:17.8651143Z                  user.is_email_verified = False  # Par défaut non vérifié
2026-02-20T22:09:17.8651252Z -                
2026-02-20T22:09:17.8651355Z +
2026-02-20T22:09:17.8651455Z                  # Sauvegarder les modifications
2026-02-20T22:09:17.8651532Z                  db.commit()
2026-02-20T22:09:17.8651606Z                  db.refresh(user)
2026-02-20T22:09:17.8651674Z -                
2026-02-20T22:09:17.8651732Z +
2026-02-20T22:09:17.8651873Z                  # Envoyer l'email de vérification
2026-02-20T22:09:17.8651945Z                  try:
2026-02-20T22:09:17.8652226Z -                    logger.info(f"Préparation envoi email de vérification à {user.email}")
2026-02-20T22:09:17.8652300Z +                    logger.info(
2026-02-20T22:09:17.8652529Z +                        f"Préparation envoi email de vérification à {user.email}"
2026-02-20T22:09:17.8652595Z +                    )
2026-02-20T22:09:17.8652676Z                      import os
2026-02-20T22:09:17.8652735Z  
2026-02-20T22:09:17.8652880Z                      from app.services.email_service import EmailService
2026-02-20T22:09:17.8653350Z -                    frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:17.8653422Z -                    
2026-02-20T22:09:17.8653661Z -                    logger.debug(f"Frontend URL: {frontend_url}, Token: {verification_token[:10]}...")
2026-02-20T22:09:17.8653726Z -                    
2026-02-20T22:09:17.8653785Z +
2026-02-20T22:09:17.8653874Z +                    frontend_url = os.getenv(
2026-02-20T22:09:17.8654055Z +                        "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:17.8654121Z +                    )
2026-02-20T22:09:17.8654179Z +
2026-02-20T22:09:17.8654261Z +                    logger.debug(
2026-02-20T22:09:17.8654441Z +                        f"Frontend URL: {frontend_url}, Token: {verification_token[:10]}..."
2026-02-20T22:09:17.8654510Z +                    )
2026-02-20T22:09:17.8654577Z +
2026-02-20T22:09:17.8654711Z                      email_sent = EmailService.send_verification_email(
2026-02-20T22:09:17.8654797Z                          to_email=user.email,
2026-02-20T22:09:17.8654886Z                          username=user.username,
2026-02-20T22:09:17.8655007Z                          verification_token=verification_token,
2026-02-20T22:09:17.8655099Z -                        frontend_url=frontend_url
2026-02-20T22:09:17.8655188Z +                        frontend_url=frontend_url,
2026-02-20T22:09:17.8655257Z                      )
2026-02-20T22:09:17.8655465Z -                    
2026-02-20T22:09:17.8655524Z +
2026-02-20T22:09:17.8655604Z                      if email_sent:
2026-02-20T22:09:17.8655908Z -                        logger.info(f"✅ Email de vérification envoyé avec succès à {user.email}")
2026-02-20T22:09:17.8655987Z +                        logger.info(
2026-02-20T22:09:17.8656226Z +                            f"✅ Email de vérification envoyé avec succès à {user.email}"
2026-02-20T22:09:17.8656408Z +                        )
2026-02-20T22:09:17.8656513Z                          if "localhost" in frontend_url:
2026-02-20T22:09:17.8656713Z                              verify_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:17.8656930Z -                            logger.info(f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}")
2026-02-20T22:09:17.8657008Z +                            logger.info(
2026-02-20T22:09:17.8657173Z +                                f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}"
2026-02-20T22:09:17.8657258Z +                            )
2026-02-20T22:09:17.8657325Z                      else:
2026-02-20T22:09:17.8657632Z -                        logger.warning(f"⚠️ Échec de l'envoi de l'email de vérification à {user.email}")
2026-02-20T22:09:17.8657961Z -                        logger.warning(f"Vérifiez la configuration SMTP dans les variables d'environnement")
2026-02-20T22:09:17.8658049Z +                        logger.warning(
2026-02-20T22:09:17.8658283Z +                            f"⚠️ Échec de l'envoi de l'email de vérification à {user.email}"
2026-02-20T22:09:17.8658347Z +                        )
2026-02-20T22:09:17.8658426Z +                        logger.warning(
2026-02-20T22:09:17.8658686Z +                            f"Vérifiez la configuration SMTP dans les variables d'environnement"
2026-02-20T22:09:17.8658753Z +                        )
2026-02-20T22:09:17.8658853Z                  except Exception as email_error:
2026-02-20T22:09:17.8659051Z                      # Ne pas faire échouer l'inscription si l'email échoue
2026-02-20T22:09:17.8659371Z -                    logger.error(f"❌ Erreur lors de l'envoi de l'email de vérification: {email_error}")
2026-02-20T22:09:17.8659453Z +                    logger.error(
2026-02-20T22:09:17.8659698Z +                        f"❌ Erreur lors de l'envoi de l'email de vérification: {email_error}"
2026-02-20T22:09:17.8659773Z +                    )
2026-02-20T22:09:17.8659885Z                      logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8659947Z -                
2026-02-20T22:09:17.8660006Z +
2026-02-20T22:09:17.8660246Z                  # Retourner les données de l'utilisateur créé (sans le mot de passe)
2026-02-20T22:09:17.8660327Z                  user_data = {
2026-02-20T22:09:17.8660398Z                      "id": user.id,
2026-02-20T22:09:17.8660488Z                      "username": user.username,
2026-02-20T22:09:17.8660571Z                      "email": user.email,
2026-02-20T22:09:17.8660668Z                      "full_name": user.full_name,
2026-02-20T22:09:17.8660869Z -                    "role": user.role.value if hasattr(user.role, 'value') else str(user.role),
2026-02-20T22:09:17.8674633Z +                    "role": (
2026-02-20T22:09:17.8674833Z +                        user.role.value
2026-02-20T22:09:17.8675028Z +                        if hasattr(user.role, "value")
2026-02-20T22:09:17.8675230Z +                        else str(user.role)
2026-02-20T22:09:17.8675338Z +                    ),
2026-02-20T22:09:17.8675480Z                      "is_active": user.is_active,
2026-02-20T22:09:17.8675672Z                      "is_email_verified": user.is_email_verified,
2026-02-20T22:09:17.8675984Z -                    "created_at": user.created_at.isoformat() if user.created_at else None,
2026-02-20T22:09:17.8676114Z +                    "created_at": (
2026-02-20T22:09:17.8676375Z +                        user.created_at.isoformat() if user.created_at else None
2026-02-20T22:09:17.8676712Z +                    ),
2026-02-20T22:09:17.8676812Z                  }
2026-02-20T22:09:17.8676913Z -                
2026-02-20T22:09:17.8677015Z +
2026-02-20T22:09:17.8677445Z                  logger.info(f"Nouvel utilisateur créé: {username} ({email})")
2026-02-20T22:09:17.8677549Z -                
2026-02-20T22:09:17.8677655Z +
2026-02-20T22:09:17.8678045Z                  return JSONResponse(user_data, status_code=201)
2026-02-20T22:09:17.8678204Z          except HTTPException as http_error:
2026-02-20T22:09:17.8678562Z              # Gérer les erreurs HTTP (ex: utilisateur déjà existant)
2026-02-20T22:09:17.8678983Z -            logger.warning(f"Erreur HTTP lors de la création de l'utilisateur: {http_error.detail}")
2026-02-20T22:09:17.8679071Z -            return JSONResponse(
2026-02-20T22:09:17.8679167Z -                {"error": http_error.detail},
2026-02-20T22:09:17.8679275Z -                status_code=http_error.status_code
2026-02-20T22:09:17.8679354Z +            logger.warning(
2026-02-20T22:09:17.8679631Z +                f"Erreur HTTP lors de la création de l'utilisateur: {http_error.detail}"
2026-02-20T22:09:17.8679705Z +            )
2026-02-20T22:09:17.8679789Z +            return JSONResponse(
2026-02-20T22:09:17.8679959Z +                {"error": http_error.detail}, status_code=http_error.status_code
2026-02-20T22:09:17.8680025Z              )
2026-02-20T22:09:17.8680139Z          except Exception as user_creation_error:
2026-02-20T22:09:17.8680439Z -            logger.error(f"Erreur lors de la création de l'utilisateur: {user_creation_error}")
2026-02-20T22:09:17.8680518Z +            logger.error(
2026-02-20T22:09:17.8680761Z +                f"Erreur lors de la création de l'utilisateur: {user_creation_error}"
2026-02-20T22:09:17.8680823Z +            )
2026-02-20T22:09:17.8680921Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8681009Z              return JSONResponse(
2026-02-20T22:09:17.8681189Z -                {"error": "Erreur lors de la création du compte"},
2026-02-20T22:09:17.8681272Z -                status_code=500
2026-02-20T22:09:17.8681339Z -            )
2026-02-20T22:09:17.8681400Z -            
2026-02-20T22:09:17.8681624Z +                {"error": "Erreur lors de la création du compte"}, status_code=500
2026-02-20T22:09:17.8681687Z +            )
2026-02-20T22:09:17.8681752Z +
2026-02-20T22:09:17.8681844Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8681926Z -        return JSONResponse(
2026-02-20T22:09:17.8682026Z -            {"error": "Format JSON invalide"},
2026-02-20T22:09:17.8682099Z -            status_code=400
2026-02-20T22:09:17.8682161Z -        )
2026-02-20T22:09:17.8682345Z +        return JSONResponse({"error": "Format JSON invalide"}, status_code=400)
2026-02-20T22:09:17.8682468Z      except Exception as unexpected_creation_error:
2026-02-20T22:09:17.8682820Z -        logger.error(f"Erreur inattendue lors de la création de l'utilisateur: {unexpected_creation_error}")
2026-02-20T22:09:17.8682895Z +        logger.error(
2026-02-20T22:09:17.8683478Z +            f"Erreur inattendue lors de la création de l'utilisateur: {unexpected_creation_error}"
2026-02-20T22:09:17.8683547Z +        )
2026-02-20T22:09:17.8683646Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8683735Z          return JSONResponse(
2026-02-20T22:09:17.8683941Z -            {"error": "Erreur lors de la création du compte"},
2026-02-20T22:09:17.8684024Z -            status_code=500
2026-02-20T22:09:17.8684240Z +            {"error": "Erreur lors de la création du compte"}, status_code=500
2026-02-20T22:09:17.8684309Z          )
2026-02-20T22:09:17.8684369Z  
2026-02-20T22:09:17.8684428Z  
2026-02-20T22:09:17.8684499Z  @require_auth
2026-02-20T22:09:17.8684596Z  async def get_all_users(request: Request):
2026-02-20T22:09:17.8684666Z @@ -473,16 +582,20 @@
2026-02-20T22:09:17.8684875Z      Handler pour récupérer tous les utilisateurs (placeholder).
2026-02-20T22:09:17.8684961Z      Route: GET /api/users/
2026-02-20T22:09:17.8685022Z      """
2026-02-20T22:09:17.8685272Z      try:
2026-02-20T22:09:17.8685375Z          current_user = request.state.user
2026-02-20T22:09:17.8685436Z -        
2026-02-20T22:09:17.8685922Z -        logger.info(f"Accès à la liste de tous les utilisateurs par {current_user.get('username')}. Fonctionnalité en développement.")
2026-02-20T22:09:17.8685990Z +
2026-02-20T22:09:17.8686168Z +        logger.info(
2026-02-20T22:09:17.8686589Z +            f"Accès à la liste de tous les utilisateurs par {current_user.get('username')}. Fonctionnalité en développement."
2026-02-20T22:09:17.8686651Z +        )
2026-02-20T22:09:17.8686716Z  
2026-02-20T22:09:17.8686795Z          return JSONResponse(
2026-02-20T22:09:17.8687077Z -            {"message": "La liste de tous les utilisateurs est en cours de développement."},
2026-02-20T22:09:17.8687160Z -            status_code=200
2026-02-20T22:09:17.8687222Z +            {
2026-02-20T22:09:17.8687491Z +                "message": "La liste de tous les utilisateurs est en cours de développement."
2026-02-20T22:09:17.8687570Z +            },
2026-02-20T22:09:17.8687644Z +            status_code=200,
2026-02-20T22:09:17.8687703Z          )
2026-02-20T22:09:17.8687781Z      except Exception as e:
2026-02-20T22:09:17.8688052Z          logger.error(f"Erreur lors de la récupération de tous les utilisateurs: {e}")
2026-02-20T22:09:17.8688137Z          traceback.print_exc()
2026-02-20T22:09:17.8688346Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8688423Z @@ -509,24 +622,32 @@
2026-02-20T22:09:17.8688586Z              users = q.order_by(User.total_points.desc()).limit(limit).all()
2026-02-20T22:09:17.8688651Z  
2026-02-20T22:09:17.8688724Z              leaderboard = []
2026-02-20T22:09:17.8688804Z              for user in users:
2026-02-20T22:09:17.8688924Z                  settings = user.accessibility_settings or {}
2026-02-20T22:09:17.8689254Z -                privacy = (settings.get("privacy_settings") or {}) if isinstance(settings.get("privacy_settings"), dict) else {}
2026-02-20T22:09:17.8689342Z +                privacy = (
2026-02-20T22:09:17.8689455Z +                    (settings.get("privacy_settings") or {})
2026-02-20T22:09:17.8689602Z +                    if isinstance(settings.get("privacy_settings"), dict)
2026-02-20T22:09:17.8689678Z +                    else {}
2026-02-20T22:09:17.8689747Z +                )
2026-02-20T22:09:17.8689877Z                  if privacy.get("show_in_leaderboards") is False:
2026-02-20T22:09:17.8689947Z                      continue
2026-02-20T22:09:17.8690042Z -                leaderboard.append({
2026-02-20T22:09:17.8690135Z -                    "username": user.username,
2026-02-20T22:09:17.8690244Z -                    "total_points": user.total_points or 0,
2026-02-20T22:09:17.8690365Z -                    "current_level": user.current_level or 1,
2026-02-20T22:09:17.8690477Z -                    "jedi_rank": user.jedi_rank or "youngling",
2026-02-20T22:09:17.8690578Z -                    "is_current_user": user.id == user_id,
2026-02-20T22:09:17.8690653Z -                })
2026-02-20T22:09:17.8690734Z +                leaderboard.append(
2026-02-20T22:09:17.8690799Z +                    {
2026-02-20T22:09:17.8690895Z +                        "username": user.username,
2026-02-20T22:09:17.8691009Z +                        "total_points": user.total_points or 0,
2026-02-20T22:09:17.8691130Z +                        "current_level": user.current_level or 1,
2026-02-20T22:09:17.8691248Z +                        "jedi_rank": user.jedi_rank or "youngling",
2026-02-20T22:09:17.8691358Z +                        "is_current_user": user.id == user_id,
2026-02-20T22:09:17.8691423Z +                    }
2026-02-20T22:09:17.8691485Z +                )
2026-02-20T22:09:17.8691607Z              for i, entry in enumerate(leaderboard, start=1):
2026-02-20T22:09:17.8691684Z                  entry["rank"] = i
2026-02-20T22:09:17.8691744Z  
2026-02-20T22:09:17.8692129Z -            logger.info(f"Classement récupéré par {current_user.get('username')}: {len(leaderboard)} utilisateurs")
2026-02-20T22:09:17.8692300Z +            logger.info(
2026-02-20T22:09:17.8692647Z +                f"Classement récupéré par {current_user.get('username')}: {len(leaderboard)} utilisateurs"
2026-02-20T22:09:17.8692710Z +            )
2026-02-20T22:09:17.8692897Z              return JSONResponse({"leaderboard": leaderboard}, status_code=200)
2026-02-20T22:09:17.8693236Z  
2026-02-20T22:09:17.8693326Z      except Exception as e:
2026-02-20T22:09:17.8693580Z          logger.error(f"Erreur lors de la récupération du classement: {e}")
2026-02-20T22:09:17.8693666Z          traceback.print_exc()
2026-02-20T22:09:17.8693734Z @@ -539,99 +660,118 @@
2026-02-20T22:09:17.8694024Z      Handler pour récupérer la progression globale de l'utilisateur avec vraies données.
2026-02-20T22:09:17.8694121Z      Route: GET /api/users/me/progress
2026-02-20T22:09:17.8694183Z      """
2026-02-20T22:09:17.8694245Z      try:
2026-02-20T22:09:17.8694341Z          current_user = request.state.user
2026-02-20T22:09:17.8694413Z -        
2026-02-20T22:09:17.8694501Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8694782Z -        logger.info(f"Récupération de la progression globale pour l'utilisateur {user_id}")
2026-02-20T22:09:17.8694849Z -        
2026-02-20T22:09:17.8694909Z +
2026-02-20T22:09:17.8694993Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8695076Z +        logger.info(
2026-02-20T22:09:17.8695313Z +            f"Récupération de la progression globale pour l'utilisateur {user_id}"
2026-02-20T22:09:17.8695375Z +        )
2026-02-20T22:09:17.8695439Z +
2026-02-20T22:09:17.8695523Z          async with db_session() as db:
2026-02-20T22:09:17.8695631Z              from app.models.attempt import Attempt
2026-02-20T22:09:17.8695739Z              from app.models.exercise import Exercise
2026-02-20T22:09:17.8695809Z -            
2026-02-20T22:09:17.8695869Z +
2026-02-20T22:09:17.8696077Z              # Récupérer toutes les tentatives avec jointure sur exercises
2026-02-20T22:09:17.8696221Z -            attempts_query = db.query(Attempt, Exercise).join(
2026-02-20T22:09:17.8696341Z -                Exercise, Attempt.exercise_id == Exercise.id
2026-02-20T22:09:17.8696407Z -            ).filter(
2026-02-20T22:09:17.8696494Z -                Attempt.user_id == user_id
2026-02-20T22:09:17.8696600Z -            ).order_by(Attempt.created_at).all()
2026-02-20T22:09:17.8696669Z -            
2026-02-20T22:09:17.8696746Z +            attempts_query = (
2026-02-20T22:09:17.8696844Z +                db.query(Attempt, Exercise)
2026-02-20T22:09:17.8696979Z +                .join(Exercise, Attempt.exercise_id == Exercise.id)
2026-02-20T22:09:17.8697078Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:17.8697178Z +                .order_by(Attempt.created_at)
2026-02-20T22:09:17.8697244Z +                .all()
2026-02-20T22:09:17.8697306Z +            )
2026-02-20T22:09:17.8697365Z +
2026-02-20T22:09:17.8697619Z              # Streak depuis la table users (série de jours consécutifs avec activité)
2026-02-20T22:09:17.8697719Z              from app.models.user import User
2026-02-20T22:09:17.8697778Z +
2026-02-20T22:09:17.8697933Z              user_row = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8698093Z              current_streak = getattr(user_row, "current_streak", None) or 0
2026-02-20T22:09:17.8698236Z              best_streak = getattr(user_row, "best_streak", None) or 0
2026-02-20T22:09:17.8698304Z  
2026-02-20T22:09:17.8698385Z              if not attempts_query:
2026-02-20T22:09:17.8698471Z -                return JSONResponse({
2026-02-20T22:09:17.8698555Z -                    "total_attempts": 0,
2026-02-20T22:09:17.8698645Z -                    "correct_attempts": 0,
2026-02-20T22:09:17.8698721Z -                    "accuracy": 0.0,
2026-02-20T22:09:17.8698802Z -                    "average_time": 0.0,
2026-02-20T22:09:17.8698897Z -                    "exercises_completed": 0,
2026-02-20T22:09:17.8699126Z -                    "highest_streak": best_streak,
2026-02-20T22:09:17.8699227Z -                    "current_streak": current_streak,
2026-02-20T22:09:17.8699304Z -                    "by_category": {}
2026-02-20T22:09:17.8699388Z -                }, status_code=200)
2026-02-20T22:09:17.8699451Z -            
2026-02-20T22:09:17.8699532Z +                return JSONResponse(
2026-02-20T22:09:17.8699708Z +                    {
2026-02-20T22:09:17.8699800Z +                        "total_attempts": 0,
2026-02-20T22:09:17.8699888Z +                        "correct_attempts": 0,
2026-02-20T22:09:17.8699964Z +                        "accuracy": 0.0,
2026-02-20T22:09:17.8700049Z +                        "average_time": 0.0,
2026-02-20T22:09:17.8700138Z +                        "exercises_completed": 0,
2026-02-20T22:09:17.8700235Z +                        "highest_streak": best_streak,
2026-02-20T22:09:17.8700337Z +                        "current_streak": current_streak,
2026-02-20T22:09:17.8700423Z +                        "by_category": {},
2026-02-20T22:09:17.8700495Z +                    },
2026-02-20T22:09:17.8700570Z +                    status_code=200,
2026-02-20T22:09:17.8700639Z +                )
2026-02-20T22:09:17.8700698Z +
2026-02-20T22:09:17.8700771Z              # Stats globales
2026-02-20T22:09:17.8700865Z              total_attempts = len(attempts_query)
2026-02-20T22:09:17.8701090Z -            correct_attempts = sum(1 for attempt, _ in attempts_query if attempt.is_correct)
2026-02-20T22:09:17.8701169Z +            correct_attempts = sum(
2026-02-20T22:09:17.8701309Z +                1 for attempt, _ in attempts_query if attempt.is_correct
2026-02-20T22:09:17.8701377Z +            )
2026-02-20T22:09:17.8701571Z              accuracy = correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8701638Z -            
2026-02-20T22:09:17.8701705Z +
2026-02-20T22:09:17.8701776Z              # Temps moyen
2026-02-20T22:09:17.8702000Z -            times = [attempt.time_spent for attempt, _ in attempts_query if attempt.time_spent]
2026-02-20T22:09:17.8702072Z +            times = [
2026-02-20T22:09:17.8702156Z +                attempt.time_spent
2026-02-20T22:09:17.8702249Z +                for attempt, _ in attempts_query
2026-02-20T22:09:17.8702328Z +                if attempt.time_spent
2026-02-20T22:09:17.8702394Z +            ]
2026-02-20T22:09:17.8702537Z              average_time = sum(times) / len(times) if times else 0.0
2026-02-20T22:09:17.8702597Z -            
2026-02-20T22:09:17.8702660Z +
2026-02-20T22:09:17.8702791Z              # Exercices uniques complétés
2026-02-20T22:09:17.8702877Z              completed_exercise_ids = set()
2026-02-20T22:09:17.8703231Z              for attempt, exercise in attempts_query:
2026-02-20T22:09:17.8703382Z                  if attempt.is_correct:
2026-02-20T22:09:17.8703507Z                      completed_exercise_ids.add(exercise.id)
2026-02-20T22:09:17.8703638Z              exercises_completed = len(completed_exercise_ids)
2026-02-20T22:09:17.8703719Z -            
2026-02-20T22:09:17.8703780Z +
2026-02-20T22:09:17.8703911Z              # Grouper par catégorie
2026-02-20T22:09:17.8703989Z              by_category = {}
2026-02-20T22:09:17.8704076Z              category_attempts = {}
2026-02-20T22:09:17.8704138Z -            
2026-02-20T22:09:17.8704198Z +
2026-02-20T22:09:17.8704325Z              for attempt, exercise in attempts_query:
2026-02-20T22:09:17.8704463Z                  exercise_type = exercise.exercise_type or "unknown"
2026-02-20T22:09:17.8704526Z -                
2026-02-20T22:09:17.8704594Z +
2026-02-20T22:09:17.8704705Z                  if exercise_type not in category_attempts:
2026-02-20T22:09:17.8704814Z                      category_attempts[exercise_type] = {
2026-02-20T22:09:17.8704887Z                          "total": 0,
2026-02-20T22:09:17.8704972Z                          "correct": 0,
2026-02-20T22:09:17.8705065Z -                        "completed_ids": set()
2026-02-20T22:09:17.8705154Z +                        "completed_ids": set(),
2026-02-20T22:09:17.8705368Z                      }
2026-02-20T22:09:17.8705431Z -                
2026-02-20T22:09:17.8705492Z +
2026-02-20T22:09:17.8705618Z                  category_attempts[exercise_type]["total"] += 1
2026-02-20T22:09:17.8705708Z                  if attempt.is_correct:
2026-02-20T22:09:17.8705836Z                      category_attempts[exercise_type]["correct"] += 1
2026-02-20T22:09:17.8706126Z                      category_attempts[exercise_type]["completed_ids"].add(exercise.id)
2026-02-20T22:09:17.8706194Z -            
2026-02-20T22:09:17.8706252Z +
2026-02-20T22:09:17.8706390Z              for exercise_type, stats in category_attempts.items():
2026-02-20T22:09:17.8706476Z                  total = stats["total"]
2026-02-20T22:09:17.8706558Z                  correct = stats["correct"]
2026-02-20T22:09:17.8706649Z                  by_category[exercise_type] = {
2026-02-20T22:09:17.8706768Z                      "completed": len(stats["completed_ids"]),
2026-02-20T22:09:17.8706928Z -                    "accuracy": round(correct / total, 2) if total > 0 else 0.0
2026-02-20T22:09:17.8707079Z +                    "accuracy": round(correct / total, 2) if total > 0 else 0.0,
2026-02-20T22:09:17.8707141Z                  }
2026-02-20T22:09:17.8707205Z -            
2026-02-20T22:09:17.8707286Z -            return JSONResponse({
2026-02-20T22:09:17.8707389Z -                "total_attempts": total_attempts,
2026-02-20T22:09:17.8707495Z -                "correct_attempts": correct_attempts,
2026-02-20T22:09:17.8707588Z -                "accuracy": round(accuracy, 2),
2026-02-20T22:09:17.8707692Z -                "average_time": round(average_time, 1),
2026-02-20T22:09:17.8707804Z -                "exercises_completed": exercises_completed,
2026-02-20T22:09:17.8707896Z -                "highest_streak": best_streak,
2026-02-20T22:09:17.8707984Z -                "current_streak": current_streak,
2026-02-20T22:09:17.8708064Z -                "by_category": by_category
2026-02-20T22:09:17.8708151Z -            }, status_code=200)
2026-02-20T22:09:17.8708211Z -            
2026-02-20T22:09:17.8708269Z +
2026-02-20T22:09:17.8708347Z +            return JSONResponse(
2026-02-20T22:09:17.8708414Z +                {
2026-02-20T22:09:17.8708509Z +                    "total_attempts": total_attempts,
2026-02-20T22:09:17.8708617Z +                    "correct_attempts": correct_attempts,
2026-02-20T22:09:17.8708716Z +                    "accuracy": round(accuracy, 2),
2026-02-20T22:09:17.8708817Z +                    "average_time": round(average_time, 1),
2026-02-20T22:09:17.8708932Z +                    "exercises_completed": exercises_completed,
2026-02-20T22:09:17.8709031Z +                    "highest_streak": best_streak,
2026-02-20T22:09:17.8709123Z +                    "current_streak": current_streak,
2026-02-20T22:09:17.8709211Z +                    "by_category": by_category,
2026-02-20T22:09:17.8709272Z +                },
2026-02-20T22:09:17.8709352Z +                status_code=200,
2026-02-20T22:09:17.8709417Z +            )
2026-02-20T22:09:17.8709476Z +
2026-02-20T22:09:17.8709559Z      except Exception as e:
2026-02-20T22:09:17.8709907Z -        logger.error(f"Erreur lors de la récupération de la progression globale de l'utilisateur: {e}")
2026-02-20T22:09:17.8709982Z +        logger.error(
2026-02-20T22:09:17.8710260Z +            f"Erreur lors de la récupération de la progression globale de l'utilisateur: {e}"
2026-02-20T22:09:17.8710328Z +        )
2026-02-20T22:09:17.8710409Z          traceback.print_exc()
2026-02-20T22:09:17.8710600Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8710665Z  
2026-02-20T22:09:17.8710722Z  
2026-02-20T22:09:17.8710786Z  @require_auth
2026-02-20T22:09:17.8710860Z @@ -640,21 +780,27 @@
2026-02-20T22:09:17.8711162Z      Handler pour récupérer la progression de l'utilisateur par type d'exercice (placeholder).
2026-02-20T22:09:17.8711276Z      Route: GET /api/users/me/progress/{exercise_type}
2026-02-20T22:09:17.8711465Z      """
2026-02-20T22:09:17.8711537Z      try:
2026-02-20T22:09:17.8711630Z          current_user = request.state.user
2026-02-20T22:09:17.8711693Z -        
2026-02-20T22:09:17.8711785Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8711935Z -        exercise_type = request.path_params.get('exercise_type')
2026-02-20T22:09:17.8712515Z -        logger.info(f"Accès à la progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}'. Fonctionnalité en développement.")
2026-02-20T22:09:17.8712585Z +
2026-02-20T22:09:17.8712666Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8712805Z +        exercise_type = request.path_params.get("exercise_type")
2026-02-20T22:09:17.8712876Z +        logger.info(
2026-02-20T22:09:17.8713799Z +            f"Accès à la progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}'. Fonctionnalité en développement."
2026-02-20T22:09:17.8713912Z +        )
2026-02-20T22:09:17.8714009Z  
2026-02-20T22:09:17.8714101Z          return JSONResponse(
2026-02-20T22:09:17.8714572Z -            {"message": f"La progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}' est en cours de développement."},
2026-02-20T22:09:17.8714648Z -            status_code=200
2026-02-20T22:09:17.8714716Z +            {
2026-02-20T22:09:17.8715179Z +                "message": f"La progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}' est en cours de développement."
2026-02-20T22:09:17.8715240Z +            },
2026-02-20T22:09:17.8715314Z +            status_code=200,
2026-02-20T22:09:17.8715389Z          )
2026-02-20T22:09:17.8715465Z      except Exception as e:
2026-02-20T22:09:17.8715772Z -        logger.error(f"Erreur lors de la récupération de la progression par type d'exercice: {e}")
2026-02-20T22:09:17.8715850Z +        logger.error(
2026-02-20T22:09:17.8716099Z +            f"Erreur lors de la récupération de la progression par type d'exercice: {e}"
2026-02-20T22:09:17.8716166Z +        )
2026-02-20T22:09:17.8716251Z          traceback.print_exc()
2026-02-20T22:09:17.8716443Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8716502Z  
2026-02-20T22:09:17.8716558Z  
2026-02-20T22:09:17.8716626Z  @require_auth
2026-02-20T22:09:17.8716692Z @@ -663,104 +809,130 @@
2026-02-20T22:09:17.8716944Z      Handler pour récupérer la progression des défis logiques de l'utilisateur.
2026-02-20T22:09:17.8717059Z      Route: GET /api/users/me/challenges/progress
2026-02-20T22:09:17.8717119Z      """
2026-02-20T22:09:17.8717179Z      try:
2026-02-20T22:09:17.8717267Z          current_user = request.state.user
2026-02-20T22:09:17.8717332Z -        
2026-02-20T22:09:17.8717412Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8717697Z -        logger.info(f"Récupération de la progression des défis pour l'utilisateur {user_id}")
2026-02-20T22:09:17.8717763Z -        
2026-02-20T22:09:17.8717820Z +
2026-02-20T22:09:17.8717909Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8717977Z +        logger.info(
2026-02-20T22:09:17.8718222Z +            f"Récupération de la progression des défis pour l'utilisateur {user_id}"
2026-02-20T22:09:17.8718282Z +        )
2026-02-20T22:09:17.8718340Z +
2026-02-20T22:09:17.8718425Z          async with db_session() as db:
2026-02-20T22:09:17.8718645Z              from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.8718704Z -            
2026-02-20T22:09:17.8718767Z +
2026-02-20T22:09:17.8718927Z              # Nombre total de défis actifs dans le système
2026-02-20T22:09:17.8719055Z -            total_challenges = db.query(LogicChallenge).filter(
2026-02-20T22:09:17.8719152Z -                LogicChallenge.is_active == True,
2026-02-20T22:09:17.8719257Z -                LogicChallenge.is_archived == False
2026-02-20T22:09:17.8719323Z -            ).count()
2026-02-20T22:09:17.8719380Z -            
2026-02-20T22:09:17.8719608Z +            total_challenges = (
2026-02-20T22:09:17.8719691Z +                db.query(LogicChallenge)
2026-02-20T22:09:17.8719759Z +                .filter(
2026-02-20T22:09:17.8719861Z +                    LogicChallenge.is_active == True,
2026-02-20T22:09:17.8719974Z +                    LogicChallenge.is_archived == False,
2026-02-20T22:09:17.8720141Z +                )
2026-02-20T22:09:17.8720207Z +                .count()
2026-02-20T22:09:17.8720271Z +            )
2026-02-20T22:09:17.8720327Z +
2026-02-20T22:09:17.8720504Z              # Récupérer toutes les tentatives de l'utilisateur
2026-02-20T22:09:17.8720650Z -            all_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8720759Z -                LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8720823Z -            ).all()
2026-02-20T22:09:17.8720882Z -            
2026-02-20T22:09:17.8720960Z +            all_attempts = (
2026-02-20T22:09:17.8721057Z +                db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8721195Z +                .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:17.8721264Z +                .all()
2026-02-20T22:09:17.8721324Z +            )
2026-02-20T22:09:17.8721380Z +
2026-02-20T22:09:17.8721453Z              if not all_attempts:
2026-02-20T22:09:17.8721540Z -                return JSONResponse({
2026-02-20T22:09:17.8721637Z -                    "completed_challenges": 0,
2026-02-20T22:09:17.8721738Z -                    "total_challenges": total_challenges,
2026-02-20T22:09:17.8721821Z -                    "success_rate": 0.0,
2026-02-20T22:09:17.8721894Z -                    "average_time": 0.0,
2026-02-20T22:09:17.8721969Z -                    "challenges": []
2026-02-20T22:09:17.8722048Z -                }, status_code=200)
2026-02-20T22:09:17.8722108Z -            
2026-02-20T22:09:17.8722185Z +                return JSONResponse(
2026-02-20T22:09:17.8722246Z +                    {
2026-02-20T22:09:17.8722342Z +                        "completed_challenges": 0,
2026-02-20T22:09:17.8722453Z +                        "total_challenges": total_challenges,
2026-02-20T22:09:17.8722534Z +                        "success_rate": 0.0,
2026-02-20T22:09:17.8722615Z +                        "average_time": 0.0,
2026-02-20T22:09:17.8722692Z +                        "challenges": [],
2026-02-20T22:09:17.8722754Z +                    },
2026-02-20T22:09:17.8722832Z +                    status_code=200,
2026-02-20T22:09:17.8722897Z +                )
2026-02-20T22:09:17.8723142Z +
2026-02-20T22:09:17.8723310Z              # Identifier les défis complétés
2026-02-20T22:09:17.8723408Z              completed_challenge_ids = set()
2026-02-20T22:09:17.8723484Z              challenge_stats = {}
2026-02-20T22:09:17.8723544Z -            
2026-02-20T22:09:17.8723601Z +
2026-02-20T22:09:17.8723687Z              for attempt in all_attempts:
2026-02-20T22:09:17.8723787Z                  challenge_id = attempt.challenge_id
2026-02-20T22:09:17.8723848Z -                
2026-02-20T22:09:17.8723918Z +
2026-02-20T22:09:17.8724023Z                  if challenge_id not in challenge_stats:
2026-02-20T22:09:17.8724120Z                      challenge_stats[challenge_id] = {
2026-02-20T22:09:17.8724201Z                          "attempts": 0,
2026-02-20T22:09:17.8724285Z                          "correct_attempts": 0,
2026-02-20T22:09:17.8724370Z                          "best_time": None,
2026-02-20T22:09:17.8724442Z -                        "times": []
2026-02-20T22:09:17.8724518Z +                        "times": [],
2026-02-20T22:09:17.8724583Z                      }
2026-02-20T22:09:17.8724643Z -                
2026-02-20T22:09:17.8724706Z +
2026-02-20T22:09:17.8724828Z                  challenge_stats[challenge_id]["attempts"] += 1
2026-02-20T22:09:17.8724887Z -                
2026-02-20T22:09:17.8724944Z +
2026-02-20T22:09:17.8725029Z                  if attempt.is_correct:
2026-02-20T22:09:17.8725172Z                      challenge_stats[challenge_id]["correct_attempts"] += 1
2026-02-20T22:09:17.8725412Z                      completed_challenge_ids.add(challenge_id)
2026-02-20T22:09:17.8725485Z -                    
2026-02-20T22:09:17.8725542Z +
2026-02-20T22:09:17.8725626Z                      if attempt.time_spent:
2026-02-20T22:09:17.8725772Z                          if challenge_stats[challenge_id]["best_time"] is None:
2026-02-20T22:09:17.8726052Z -                            challenge_stats[challenge_id]["best_time"] = attempt.time_spent
2026-02-20T22:09:17.8726155Z +                            challenge_stats[challenge_id][
2026-02-20T22:09:17.8726231Z +                                "best_time"
2026-02-20T22:09:17.8726326Z +                            ] = attempt.time_spent
2026-02-20T22:09:17.8726397Z                          else:
2026-02-20T22:09:17.8726528Z                              challenge_stats[challenge_id]["best_time"] = min(
2026-02-20T22:09:17.8726657Z                                  challenge_stats[challenge_id]["best_time"],
2026-02-20T22:09:17.8726744Z -                                attempt.time_spent
2026-02-20T22:09:17.8726837Z +                                attempt.time_spent,
2026-02-20T22:09:17.8726909Z                              )
2026-02-20T22:09:17.8726967Z -                
2026-02-20T22:09:17.8727023Z +
2026-02-20T22:09:17.8727098Z                  if attempt.time_spent:
2026-02-20T22:09:17.8727279Z                      challenge_stats[challenge_id]["times"].append(attempt.time_spent)
2026-02-20T22:09:17.8727344Z -            
2026-02-20T22:09:17.8727402Z +
2026-02-20T22:09:17.8727494Z              # Calculer le success_rate global
2026-02-20T22:09:17.8727583Z              total_attempts = len(all_attempts)
2026-02-20T22:09:17.8727734Z              correct_attempts = sum(1 for a in all_attempts if a.is_correct)
2026-02-20T22:09:17.8727938Z -            success_rate = correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8728002Z -            
2026-02-20T22:09:17.8728072Z +            success_rate = (
2026-02-20T22:09:17.8728240Z +                correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8728305Z +            )
2026-02-20T22:09:17.8728361Z +
2026-02-20T22:09:17.8728440Z              # Calculer le temps moyen
2026-02-20T22:09:17.8728596Z              all_times = [a.time_spent for a in all_attempts if a.time_spent]
2026-02-20T22:09:17.8728764Z              average_time = sum(all_times) / len(all_times) if all_times else 0.0
2026-02-20T22:09:17.8728823Z -            
2026-02-20T22:09:17.8728879Z +
2026-02-20T22:09:17.8729078Z              # Construire la liste des défis complétés avec détails
2026-02-20T22:09:17.8729154Z              challenges_list = []
2026-02-20T22:09:17.8729237Z              if completed_challenge_ids:
2026-02-20T22:09:17.8729388Z -                completed_challenges = db.query(LogicChallenge).filter(
2026-02-20T22:09:17.8729510Z -                    LogicChallenge.id.in_(completed_challenge_ids)
2026-02-20T22:09:17.8729576Z -                ).all()
2026-02-20T22:09:17.8729646Z -                
2026-02-20T22:09:17.8729728Z +                completed_challenges = (
2026-02-20T22:09:17.8729813Z +                    db.query(LogicChallenge)
2026-02-20T22:09:17.8729956Z +                    .filter(LogicChallenge.id.in_(completed_challenge_ids))
2026-02-20T22:09:17.8730028Z +                    .all()
2026-02-20T22:09:17.8730097Z +                )
2026-02-20T22:09:17.8730155Z +
2026-02-20T22:09:17.8730264Z                  for challenge in completed_challenges:
2026-02-20T22:09:17.8730384Z                      stats = challenge_stats.get(challenge.id, {})
2026-02-20T22:09:17.8730470Z -                    challenges_list.append({
2026-02-20T22:09:17.8730552Z -                        "id": challenge.id,
2026-02-20T22:09:17.8730642Z -                        "title": challenge.title,
2026-02-20T22:09:17.8730724Z -                        "is_completed": True,
2026-02-20T22:09:17.8730830Z -                        "attempts": stats.get("attempts", 0),
2026-02-20T22:09:17.8731060Z -                        "best_time": round(stats.get("best_time", 0), 2) if stats.get("best_time") else None
2026-02-20T22:09:17.8731213Z -                    })
2026-02-20T22:09:17.8731272Z -            
2026-02-20T22:09:17.8731359Z -            return JSONResponse({
2026-02-20T22:09:17.8731500Z -                "completed_challenges": len(completed_challenge_ids),
2026-02-20T22:09:17.8731676Z -                "total_challenges": total_challenges,
2026-02-20T22:09:17.8731783Z -                "success_rate": round(success_rate, 2),
2026-02-20T22:09:17.8731878Z -                "average_time": round(average_time, 1),
2026-02-20T22:09:17.8731963Z -                "challenges": challenges_list
2026-02-20T22:09:17.8732039Z -            }, status_code=200)
2026-02-20T22:09:17.8732104Z -            
2026-02-20T22:09:17.8732189Z +                    challenges_list.append(
2026-02-20T22:09:17.8732255Z +                        {
2026-02-20T22:09:17.8732348Z +                            "id": challenge.id,
2026-02-20T22:09:17.8732442Z +                            "title": challenge.title,
2026-02-20T22:09:17.8732530Z +                            "is_completed": True,
2026-02-20T22:09:17.8732640Z +                            "attempts": stats.get("attempts", 0),
2026-02-20T22:09:17.8732720Z +                            "best_time": (
2026-02-20T22:09:17.8732830Z +                                round(stats.get("best_time", 0), 2)
2026-02-20T22:09:17.8732929Z +                                if stats.get("best_time")
2026-02-20T22:09:17.8733212Z +                                else None
2026-02-20T22:09:17.8733309Z +                            ),
2026-02-20T22:09:17.8733376Z +                        }
2026-02-20T22:09:17.8733445Z +                    )
2026-02-20T22:09:17.8733502Z +
2026-02-20T22:09:17.8733583Z +            return JSONResponse(
2026-02-20T22:09:17.8733643Z +                {
2026-02-20T22:09:17.8733792Z +                    "completed_challenges": len(completed_challenge_ids),
2026-02-20T22:09:17.8733898Z +                    "total_challenges": total_challenges,
2026-02-20T22:09:17.8734001Z +                    "success_rate": round(success_rate, 2),
2026-02-20T22:09:17.8734108Z +                    "average_time": round(average_time, 1),
2026-02-20T22:09:17.8734199Z +                    "challenges": challenges_list,
2026-02-20T22:09:17.8734261Z +                },
2026-02-20T22:09:17.8734346Z +                status_code=200,
2026-02-20T22:09:17.8734407Z +            )
2026-02-20T22:09:17.8734464Z +
2026-02-20T22:09:17.8734539Z      except Exception as e:
2026-02-20T22:09:17.8734839Z          logger.error(f"Erreur lors de la récupération de la progression des défis: {e}")
2026-02-20T22:09:17.8734918Z          traceback.print_exc()
2026-02-20T22:09:17.8735107Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8735170Z  
2026-02-20T22:09:17.8735235Z @@ -768,11 +940,11 @@
2026-02-20T22:09:17.8735300Z  @require_auth
2026-02-20T22:09:17.8735395Z  async def update_user_me(request: Request):
2026-02-20T22:09:17.8735472Z      """
2026-02-20T22:09:17.8735704Z      Handler pour mettre à jour les informations de l'utilisateur actuel.
2026-02-20T22:09:17.8735783Z      Route: PUT /api/users/me
2026-02-20T22:09:17.8735850Z -    
2026-02-20T22:09:17.8735908Z +
2026-02-20T22:09:17.8735984Z      Champs modifiables :
2026-02-20T22:09:17.8736118Z      - email (avec vérification unicité)
2026-02-20T22:09:17.8736192Z      - full_name
2026-02-20T22:09:17.8736259Z      - grade_level
2026-02-20T22:09:17.8736329Z      - learning_style
2026-02-20T22:09:17.8736404Z @@ -780,137 +952,168 @@
2026-02-20T22:09:17.8736475Z      - preferred_theme
2026-02-20T22:09:17.8736562Z      - accessibility_settings (JSON)
2026-02-20T22:09:17.8736622Z      """
2026-02-20T22:09:17.8736687Z      try:
2026-02-20T22:09:17.8736778Z          from app.models.user import User
2026-02-20T22:09:17.8736838Z -        
2026-02-20T22:09:17.8736900Z +
2026-02-20T22:09:17.8736984Z          current_user = request.state.user
2026-02-20T22:09:17.8737178Z -        
2026-02-20T22:09:17.8737265Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8737331Z +
2026-02-20T22:09:17.8737409Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8737488Z          data = await request.json()
2026-02-20T22:09:17.8737695Z          logger.info(f"Mise à jour profil utilisateur {user_id}")
2026-02-20T22:09:17.8737873Z -        
2026-02-20T22:09:17.8737931Z +
2026-02-20T22:09:17.8738053Z          # Champs autorisés à modifier
2026-02-20T22:09:17.8738131Z          ALLOWED_FIELDS = {
2026-02-20T22:09:17.8738261Z -            'email', 'full_name', 'grade_level', 'learning_style',
2026-02-20T22:09:17.8738436Z -            'preferred_difficulty', 'preferred_theme', 'accessibility_settings'
2026-02-20T22:09:17.8738507Z +            "email",
2026-02-20T22:09:17.8738575Z +            "full_name",
2026-02-20T22:09:17.8738640Z +            "grade_level",
2026-02-20T22:09:17.8738715Z +            "learning_style",
2026-02-20T22:09:17.8738799Z +            "preferred_difficulty",
2026-02-20T22:09:17.8738869Z +            "preferred_theme",
2026-02-20T22:09:17.8738948Z +            "accessibility_settings",
2026-02-20T22:09:17.8739014Z          }
2026-02-20T22:09:17.8739072Z -        
2026-02-20T22:09:17.8739130Z +
2026-02-20T22:09:17.8739376Z          # Gérer les champs de confidentialité : regrouper sous privacy_settings
2026-02-20T22:09:17.8739614Z -        privacy_fields = ['is_public_profile', 'allow_friend_requests', 'show_in_leaderboards', 
2026-02-20T22:09:17.8739738Z -                          'data_retention_consent', 'marketing_consent']
2026-02-20T22:09:17.8739815Z +        privacy_fields = [
2026-02-20T22:09:17.8739891Z +            "is_public_profile",
2026-02-20T22:09:17.8739970Z +            "allow_friend_requests",
2026-02-20T22:09:17.8740045Z +            "show_in_leaderboards",
2026-02-20T22:09:17.8740126Z +            "data_retention_consent",
2026-02-20T22:09:17.8740198Z +            "marketing_consent",
2026-02-20T22:09:17.8740265Z +        ]
2026-02-20T22:09:17.8740341Z          privacy_data = {}
2026-02-20T22:09:17.8740421Z          for field in privacy_fields:
2026-02-20T22:09:17.8740491Z              if field in data:
2026-02-20T22:09:17.8740595Z                  privacy_data[field] = data.pop(field)
2026-02-20T22:09:17.8740673Z          if privacy_data:
2026-02-20T22:09:17.8740780Z -            data['privacy_settings'] = privacy_data
2026-02-20T22:09:17.8740842Z -        
2026-02-20T22:09:17.8740946Z +            data["privacy_settings"] = privacy_data
2026-02-20T22:09:17.8741003Z +
2026-02-20T22:09:17.8741203Z          # Gérer les champs stockés dans accessibility_settings (JSON)
2026-02-20T22:09:17.8741408Z          # notification_preferences, language_preference, timezone, privacy_settings
2026-02-20T22:09:17.8741677Z -        json_fields = ['notification_preferences', 'language_preference', 'timezone', 'privacy_settings']
2026-02-20T22:09:17.8741748Z +        json_fields = [
2026-02-20T22:09:17.8741832Z +            "notification_preferences",
2026-02-20T22:09:17.8742002Z +            "language_preference",
2026-02-20T22:09:17.8742071Z +            "timezone",
2026-02-20T22:09:17.8742145Z +            "privacy_settings",
2026-02-20T22:09:17.8742210Z +        ]
2026-02-20T22:09:17.8742287Z          json_overrides = {}
2026-02-20T22:09:17.8742364Z          for field in json_fields:
2026-02-20T22:09:17.8742443Z              if field in data:
2026-02-20T22:09:17.8742554Z                  json_overrides[field] = data.pop(field)
2026-02-20T22:09:17.8742614Z -        
2026-02-20T22:09:17.8742672Z +
2026-02-20T22:09:17.8742747Z          if json_overrides:
2026-02-20T22:09:17.8742849Z -            if 'accessibility_settings' not in data:
2026-02-20T22:09:17.8742943Z -                data['accessibility_settings'] = {}
2026-02-20T22:09:17.8743319Z -            if isinstance(data['accessibility_settings'], dict):
2026-02-20T22:09:17.8743469Z -                data['accessibility_settings'].update(json_overrides)
2026-02-20T22:09:17.8743577Z +            if "accessibility_settings" not in data:
2026-02-20T22:09:17.8743669Z +                data["accessibility_settings"] = {}
2026-02-20T22:09:17.8743799Z +            if isinstance(data["accessibility_settings"], dict):
2026-02-20T22:09:17.8743928Z +                data["accessibility_settings"].update(json_overrides)
2026-02-20T22:09:17.8744159Z              else:
2026-02-20T22:09:17.8744286Z -                data['accessibility_settings'] = json_overrides
2026-02-20T22:09:17.8744346Z -        
2026-02-20T22:09:17.8744459Z +                data["accessibility_settings"] = json_overrides
2026-02-20T22:09:17.8744522Z +
2026-02-20T22:09:17.8744669Z          # Filtrer les champs non autorisés
2026-02-20T22:09:17.8744832Z          update_data = {k: v for k, v in data.items() if k in ALLOWED_FIELDS}
2026-02-20T22:09:17.8744892Z -        
2026-02-20T22:09:17.8744954Z +
2026-02-20T22:09:17.8745026Z          if not update_data:
2026-02-20T22:09:17.8745104Z              return JSONResponse(
2026-02-20T22:09:17.8745292Z -                {"error": "Aucun champ valide à mettre à jour."},
2026-02-20T22:09:17.8745365Z -                status_code=400
2026-02-20T22:09:17.8745426Z -            )
2026-02-20T22:09:17.8745485Z -        
2026-02-20T22:09:17.8745708Z +                {"error": "Aucun champ valide à mettre à jour."}, status_code=400
2026-02-20T22:09:17.8745778Z +            )
2026-02-20T22:09:17.8745835Z +
2026-02-20T22:09:17.8745921Z          # Validation email si fourni
2026-02-20T22:09:17.8746000Z -        if 'email' in update_data:
2026-02-20T22:09:17.8746110Z -            email = update_data['email'].strip().lower()
2026-02-20T22:09:17.8746266Z -            if not email or not re.match(r'^[^\s@]+@[^\s@]+\.[^\s@]+$', email):
2026-02-20T22:09:17.8746346Z +        if "email" in update_data:
2026-02-20T22:09:17.8746451Z +            email = update_data["email"].strip().lower()
2026-02-20T22:09:17.8746601Z +            if not email or not re.match(r"^[^\s@]+@[^\s@]+\.[^\s@]+$", email):
2026-02-20T22:09:17.8746693Z                  return JSONResponse(
2026-02-20T22:09:17.8746796Z -                    {"error": "Adresse email invalide."},
2026-02-20T22:09:17.8746869Z -                    status_code=400
2026-02-20T22:09:17.8746937Z -                )
2026-02-20T22:09:17.8747021Z -            update_data['email'] = email
2026-02-20T22:09:17.8747085Z -        
2026-02-20T22:09:17.8747210Z +                    {"error": "Adresse email invalide."}, status_code=400
2026-02-20T22:09:17.8747276Z +                )
2026-02-20T22:09:17.8747355Z +            update_data["email"] = email
2026-02-20T22:09:17.8747411Z +
2026-02-20T22:09:17.8747491Z          # Validation full_name
2026-02-20T22:09:17.8747573Z -        if 'full_name' in update_data:
2026-02-20T22:09:17.8747786Z -            full_name = update_data['full_name'].strip() if update_data['full_name'] else None
2026-02-20T22:09:17.8747871Z +        if "full_name" in update_data:
2026-02-20T22:09:17.8747941Z +            full_name = (
2026-02-20T22:09:17.8748239Z +                update_data["full_name"].strip() if update_data["full_name"] else None
2026-02-20T22:09:17.8748300Z +            )
2026-02-20T22:09:17.8748400Z              if full_name and len(full_name) > 100:
2026-02-20T22:09:17.8748480Z                  return JSONResponse(
2026-02-20T22:09:17.8748714Z                      {"error": "Le nom complet ne peut pas dépasser 100 caractères."},
2026-02-20T22:09:17.8748797Z -                    status_code=400
2026-02-20T22:09:17.8748857Z -                )
2026-02-20T22:09:17.8748949Z -            update_data['full_name'] = full_name
2026-02-20T22:09:17.8749012Z -        
2026-02-20T22:09:17.8749082Z +                    status_code=400,
2026-02-20T22:09:17.8749142Z +                )
2026-02-20T22:09:17.8749230Z +            update_data["full_name"] = full_name
2026-02-20T22:09:17.8749292Z +
2026-02-20T22:09:17.8749369Z          # Validation grade_level
2026-02-20T22:09:17.8749451Z -        if 'grade_level' in update_data:
2026-02-20T22:09:17.8749555Z -            grade = update_data['grade_level']
2026-02-20T22:09:17.8749633Z +        if "grade_level" in update_data:
2026-02-20T22:09:17.8749718Z +            grade = update_data["grade_level"]
2026-02-20T22:09:17.8749792Z              if grade is not None:
2026-02-20T22:09:17.8749860Z                  try:
2026-02-20T22:09:17.8749933Z                      grade = int(grade)
2026-02-20T22:09:17.8750100Z                      if grade < 1 or grade > 12:
2026-02-20T22:09:17.8750191Z                          return JSONResponse(
2026-02-20T22:09:17.8750398Z                              {"error": "Le niveau scolaire doit être entre 1 et 12."},
2026-02-20T22:09:17.8750479Z -                            status_code=400
2026-02-20T22:09:17.8750559Z +                            status_code=400,
2026-02-20T22:09:17.8750623Z                          )
2026-02-20T22:09:17.8750722Z -                    update_data['grade_level'] = grade
2026-02-20T22:09:17.8750813Z +                    update_data["grade_level"] = grade
2026-02-20T22:09:17.8750917Z                  except (ValueError, TypeError):
2026-02-20T22:09:17.8750997Z                      return JSONResponse(
2026-02-20T22:09:17.8751187Z                          {"error": "Le niveau scolaire doit être un nombre."},
2026-02-20T22:09:17.8751269Z -                        status_code=400
2026-02-20T22:09:17.8751349Z +                        status_code=400,
2026-02-20T22:09:17.8751413Z                      )
2026-02-20T22:09:17.8751471Z -        
2026-02-20T22:09:17.8751533Z +
2026-02-20T22:09:17.8751608Z          # Validation learning_style
2026-02-20T22:09:17.8751816Z -        VALID_STYLES = {'visuel', 'auditif', 'kinesthésique', 'lecture'}
2026-02-20T22:09:17.8751911Z -        if 'learning_style' in update_data:
2026-02-20T22:09:17.8752005Z -            style = update_data['learning_style']
2026-02-20T22:09:17.8752204Z +        VALID_STYLES = {"visuel", "auditif", "kinesthésique", "lecture"}
2026-02-20T22:09:17.8752295Z +        if "learning_style" in update_data:
2026-02-20T22:09:17.8752393Z +            style = update_data["learning_style"]
2026-02-20T22:09:17.8752491Z              if style and style not in VALID_STYLES:
2026-02-20T22:09:17.8752571Z                  return JSONResponse(
2026-02-20T22:09:17.8752919Z -                    {"error": f"Style d'apprentissage invalide. Valeurs acceptées : {', '.join(VALID_STYLES)}"},
2026-02-20T22:09:17.8753204Z -                    status_code=400
2026-02-20T22:09:17.8753270Z -                )
2026-02-20T22:09:17.8753337Z -        
2026-02-20T22:09:17.8753401Z +                    {
2026-02-20T22:09:17.8753744Z +                        "error": f"Style d'apprentissage invalide. Valeurs acceptées : {', '.join(VALID_STYLES)}"
2026-02-20T22:09:17.8753819Z +                    },
2026-02-20T22:09:17.8753894Z +                    status_code=400,
2026-02-20T22:09:17.8753956Z +                )
2026-02-20T22:09:17.8754013Z +
2026-02-20T22:09:17.8754101Z          # Validation preferred_theme
2026-02-20T22:09:17.8754339Z -        VALID_THEMES = {'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral'}
2026-02-20T22:09:17.8754570Z -        if 'preferred_theme' in update_data:
2026-02-20T22:09:17.8754676Z -            theme = update_data['preferred_theme']
2026-02-20T22:09:17.8754749Z +        VALID_THEMES = {
2026-02-20T22:09:17.8754817Z +            "spatial",
2026-02-20T22:09:17.8754904Z +            "minimalist",
2026-02-20T22:09:17.8754967Z +            "ocean",
2026-02-20T22:09:17.8755030Z +            "dune",
2026-02-20T22:09:17.8755094Z +            "forest",
2026-02-20T22:09:17.8755164Z +            "peach",
2026-02-20T22:09:17.8755228Z +            "dino",
2026-02-20T22:09:17.8755293Z +            "neutral",
2026-02-20T22:09:17.8755358Z +        }
2026-02-20T22:09:17.8755454Z +        if "preferred_theme" in update_data:
2026-02-20T22:09:17.8755550Z +            theme = update_data["preferred_theme"]
2026-02-20T22:09:17.8755647Z              if theme and theme not in VALID_THEMES:
2026-02-20T22:09:17.8755742Z                  return JSONResponse(
2026-02-20T22:09:17.8756022Z -                    {"error": f"Thème invalide. Valeurs acceptées : {', '.join(VALID_THEMES)}"},
2026-02-20T22:09:17.8756097Z -                    status_code=400
2026-02-20T22:09:17.8756167Z -                )
2026-02-20T22:09:17.8756228Z -        
2026-02-20T22:09:17.8756289Z +                    {
2026-02-20T22:09:17.8756704Z +                        "error": f"Thème invalide. Valeurs acceptées : {', '.join(VALID_THEMES)}"
2026-02-20T22:09:17.8756776Z +                    },
2026-02-20T22:09:17.8756850Z +                    status_code=400,
2026-02-20T22:09:17.8756912Z +                )
2026-02-20T22:09:17.8756978Z +
2026-02-20T22:09:17.8757086Z          # Mise à jour en base
2026-02-20T22:09:17.8757169Z          async with db_session() as db:
2026-02-20T22:09:17.8757314Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8757386Z              if not user:
2026-02-20T22:09:17.8757592Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8757662Z -            
2026-02-20T22:09:17.8757747Z +                return JSONResponse(
2026-02-20T22:09:17.8757883Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8757944Z +                )
2026-02-20T22:09:17.8758016Z +
2026-02-20T22:09:17.8758155Z              # Vérifier unicité email si modifié
2026-02-20T22:09:17.8758312Z -            if 'email' in update_data and update_data['email'] != user.email:
2026-02-20T22:09:17.8758402Z -                existing = db.query(User).filter(
2026-02-20T22:09:17.8758510Z -                    User.email == update_data['email'],
2026-02-20T22:09:17.8758583Z -                    User.id != user_id
2026-02-20T22:09:17.8758648Z -                ).first()
2026-02-20T22:09:17.8758801Z +            if "email" in update_data and update_data["email"] != user.email:
2026-02-20T22:09:17.8758871Z +                existing = (
2026-02-20T22:09:17.8758949Z +                    db.query(User)
2026-02-20T22:09:17.8759113Z +                    .filter(User.email == update_data["email"], User.id != user_id)
2026-02-20T22:09:17.8759179Z +                    .first()
2026-02-20T22:09:17.8759239Z +                )
2026-02-20T22:09:17.8759306Z                  if existing:
2026-02-20T22:09:17.8759399Z                      return JSONResponse(
2026-02-20T22:09:17.8759586Z                          {"error": "Cette adresse email est déjà utilisée."},
2026-02-20T22:09:17.8759663Z -                        status_code=400
2026-02-20T22:09:17.8759741Z +                        status_code=400,
2026-02-20T22:09:17.8759804Z                      )
2026-02-20T22:09:17.8759862Z -            
2026-02-20T22:09:17.8759924Z +
2026-02-20T22:09:17.8760007Z              # Appliquer les modifications
2026-02-20T22:09:17.8760107Z              for field, value in update_data.items():
2026-02-20T22:09:17.8760206Z -                if field == 'accessibility_settings':
2026-02-20T22:09:17.8760397Z +                if field == "accessibility_settings":
2026-02-20T22:09:17.8760597Z                      # Merger avec les settings existants pour ne pas écraser
2026-02-20T22:09:17.8760870Z                      # IMPORTANT: créer un NOUVEAU dict pour que SQLAlchemy détecte le changement
2026-02-20T22:09:17.8761074Z                      # (les mutations in-place sur JSON ne sont pas trackées)
2026-02-20T22:09:17.8761243Z                      existing_settings = dict(user.accessibility_settings or {})
2026-02-20T22:09:17.8761334Z                      if isinstance(value, dict):
2026-02-20T22:09:17.8761407Z @@ -918,14 +1121,14 @@
2026-02-20T22:09:17.8761516Z                          setattr(user, field, existing_settings)
2026-02-20T22:09:17.8761583Z                      else:
2026-02-20T22:09:17.8761673Z                          setattr(user, field, value)
2026-02-20T22:09:17.8761744Z                  else:
2026-02-20T22:09:17.8761832Z                      setattr(user, field, value)
2026-02-20T22:09:17.8761902Z -            
2026-02-20T22:09:17.8761966Z +
2026-02-20T22:09:17.8762037Z              db.commit()
2026-02-20T22:09:17.8762109Z              db.refresh(user)
2026-02-20T22:09:17.8762167Z -            
2026-02-20T22:09:17.8762229Z +
2026-02-20T22:09:17.8762340Z              # Construire la réponse
2026-02-20T22:09:17.8762561Z              response_data = {
2026-02-20T22:09:17.8762636Z                  "id": user.id,
2026-02-20T22:09:17.8762721Z                  "username": user.username,
2026-02-20T22:09:17.8762798Z                  "email": user.email,
2026-02-20T22:09:17.8762867Z @@ -941,14 +1144,16 @@
2026-02-20T22:09:17.8763245Z                  "updated_at": user.updated_at.isoformat() if user.updated_at else None,
2026-02-20T22:09:17.8763344Z                  "total_points": user.total_points,
2026-02-20T22:09:17.8763443Z                  "current_level": user.current_level,
2026-02-20T22:09:17.8763535Z                  "jedi_rank": user.jedi_rank,
2026-02-20T22:09:17.8763602Z              }
2026-02-20T22:09:17.8763662Z -            
2026-02-20T22:09:17.8763975Z -            logger.info(f"Profil utilisateur {user_id} mis à jour : {list(update_data.keys())}")
2026-02-20T22:09:17.8764035Z +
2026-02-20T22:09:17.8764105Z +            logger.info(
2026-02-20T22:09:17.8764350Z +                f"Profil utilisateur {user_id} mis à jour : {list(update_data.keys())}"
2026-02-20T22:09:17.8764425Z +            )
2026-02-20T22:09:17.8764520Z              return JSONResponse(response_data)
2026-02-20T22:09:17.8764580Z -            
2026-02-20T22:09:17.8764644Z +
2026-02-20T22:09:17.8764727Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8764980Z          return JSONResponse({"error": "Données JSON invalides."}, status_code=400)
2026-02-20T22:09:17.8765065Z      except Exception as e:
2026-02-20T22:09:17.8765288Z          logger.error(f"Erreur lors de la mise à jour de l'utilisateur: {e}")
2026-02-20T22:09:17.8765368Z          traceback.print_exc()
2026-02-20T22:09:17.8765434Z @@ -959,75 +1164,77 @@
2026-02-20T22:09:17.8765570Z  async def update_user_password_me(request: Request):
2026-02-20T22:09:17.8765632Z      """
2026-02-20T22:09:17.8765851Z      Handler pour mettre à jour le mot de passe de l'utilisateur actuel.
2026-02-20T22:09:17.8765949Z      Route: PUT /api/users/me/password
2026-02-20T22:09:17.8766062Z      Protégé CSRF (audit 3.2).
2026-02-20T22:09:17.8766130Z -    
2026-02-20T22:09:17.8766188Z +
2026-02-20T22:09:17.8766260Z      Body attendu :
2026-02-20T22:09:17.8766358Z      - current_password: mot de passe actuel
2026-02-20T22:09:17.8766538Z      - new_password: nouveau mot de passe (min 8 caractères)
2026-02-20T22:09:17.8766605Z      """
2026-02-20T22:09:17.8766694Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:17.8766758Z      if csrf_err:
2026-02-20T22:09:17.8766836Z          return csrf_err
2026-02-20T22:09:17.8766897Z      try:
2026-02-20T22:09:17.8766983Z          from app.models.user import User
2026-02-20T22:09:17.8767146Z          from app.core.security import verify_password, get_password_hash
2026-02-20T22:09:17.8767353Z -        
2026-02-20T22:09:17.8767412Z +
2026-02-20T22:09:17.8767499Z          current_user = request.state.user
2026-02-20T22:09:17.8767569Z -        
2026-02-20T22:09:17.8767650Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8767710Z +
2026-02-20T22:09:17.8767796Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8767884Z          data = await request.json()
2026-02-20T22:09:17.8767943Z -        
2026-02-20T22:09:17.8768089Z -        current_password = data.get('current_password', '').strip()
2026-02-20T22:09:17.8768216Z -        new_password = data.get('new_password', '').strip()
2026-02-20T22:09:17.8768275Z -        
2026-02-20T22:09:17.8768332Z +
2026-02-20T22:09:17.8768473Z +        current_password = data.get("current_password", "").strip()
2026-02-20T22:09:17.8768592Z +        new_password = data.get("new_password", "").strip()
2026-02-20T22:09:17.8768649Z +
2026-02-20T22:09:17.8768713Z          # Validation
2026-02-20T22:09:17.8768805Z          if not current_password:
2026-02-20T22:09:17.8768882Z              return JSONResponse(
2026-02-20T22:09:17.8769002Z -                {"error": "Le mot de passe actuel est requis."},
2026-02-20T22:09:17.8769076Z -                status_code=400
2026-02-20T22:09:17.8769232Z +                {"error": "Le mot de passe actuel est requis."}, status_code=400
2026-02-20T22:09:17.8769402Z              )
2026-02-20T22:09:17.8769479Z          if not new_password:
2026-02-20T22:09:17.8769557Z              return JSONResponse(
2026-02-20T22:09:17.8769681Z -                {"error": "Le nouveau mot de passe est requis."},
2026-02-20T22:09:17.8769752Z -                status_code=400
2026-02-20T22:09:17.8769907Z +                {"error": "Le nouveau mot de passe est requis."}, status_code=400
2026-02-20T22:09:17.8769966Z              )
2026-02-20T22:09:17.8770041Z          if len(new_password) < 8:
2026-02-20T22:09:17.8770114Z              return JSONResponse(
2026-02-20T22:09:17.8770387Z -                {"error": "Le nouveau mot de passe doit contenir au moins 8 caractères."},
2026-02-20T22:09:17.8770462Z -                status_code=400
2026-02-20T22:09:17.8770523Z +                {
2026-02-20T22:09:17.8770772Z +                    "error": "Le nouveau mot de passe doit contenir au moins 8 caractères."
2026-02-20T22:09:17.8770842Z +                },
2026-02-20T22:09:17.8770910Z +                status_code=400,
2026-02-20T22:09:17.8770974Z              )
2026-02-20T22:09:17.8771066Z          if current_password == new_password:
2026-02-20T22:09:17.8771138Z              return JSONResponse(
2026-02-20T22:09:17.8771366Z                  {"error": "Le nouveau mot de passe doit être différent de l'ancien."},
2026-02-20T22:09:17.8771443Z -                status_code=400
2026-02-20T22:09:17.8771502Z -            )
2026-02-20T22:09:17.8771560Z -        
2026-02-20T22:09:17.8771637Z +                status_code=400,
2026-02-20T22:09:17.8771697Z +            )
2026-02-20T22:09:17.8771761Z +
2026-02-20T22:09:17.8771891Z          # Vérification et mise à jour en base
2026-02-20T22:09:17.8771978Z          async with db_session() as db:
2026-02-20T22:09:17.8772113Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8772184Z              if not user:
2026-02-20T22:09:17.8772391Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8772457Z -            
2026-02-20T22:09:17.8772534Z +                return JSONResponse(
2026-02-20T22:09:17.8772671Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8772731Z +                )
2026-02-20T22:09:17.8772789Z +
2026-02-20T22:09:17.8772915Z              # Vérifier le mot de passe actuel
2026-02-20T22:09:17.8773269Z              if not verify_password(current_password, user.hashed_password):
2026-02-20T22:09:17.8773352Z                  return JSONResponse(
2026-02-20T22:09:17.8773478Z -                    {"error": "Le mot de passe actuel est incorrect."},
2026-02-20T22:09:17.8773695Z -                    status_code=401
2026-02-20T22:09:17.8773756Z -                )
2026-02-20T22:09:17.8773813Z -            
2026-02-20T22:09:17.8773970Z +                    {"error": "Le mot de passe actuel est incorrect."}, status_code=401
2026-02-20T22:09:17.8774043Z +                )
2026-02-20T22:09:17.8774101Z +
2026-02-20T22:09:17.8774213Z              # Hasher et sauvegarder le nouveau mot de passe
2026-02-20T22:09:17.8774353Z              user.hashed_password = get_password_hash(new_password)
2026-02-20T22:09:17.8774423Z              db.commit()
2026-02-20T22:09:17.8774482Z -            
2026-02-20T22:09:17.8774758Z -            logger.info(f"Mot de passe de l'utilisateur {user_id} mis à jour avec succès")
2026-02-20T22:09:17.8774838Z -            return JSONResponse({
2026-02-20T22:09:17.8774911Z -                "success": True,
2026-02-20T22:09:17.8775081Z -                "message": "Mot de passe mis à jour avec succès."
2026-02-20T22:09:17.8775156Z -            })
2026-02-20T22:09:17.8775215Z -            
2026-02-20T22:09:17.8775272Z +
2026-02-20T22:09:17.8775349Z +            logger.info(
2026-02-20T22:09:17.8775575Z +                f"Mot de passe de l'utilisateur {user_id} mis à jour avec succès"
2026-02-20T22:09:17.8775636Z +            )
2026-02-20T22:09:17.8775831Z +            return JSONResponse(
2026-02-20T22:09:17.8776071Z +                {"success": True, "message": "Mot de passe mis à jour avec succès."}
2026-02-20T22:09:17.8776132Z +            )
2026-02-20T22:09:17.8776194Z +
2026-02-20T22:09:17.8776283Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8776535Z          return JSONResponse({"error": "Données JSON invalides."}, status_code=400)
2026-02-20T22:09:17.8776615Z      except Exception as e:
2026-02-20T22:09:17.8776843Z          logger.error(f"Erreur lors de la mise à jour du mot de passe: {e}")
2026-02-20T22:09:17.8776924Z          traceback.print_exc()
2026-02-20T22:09:17.8777000Z @@ -1038,44 +1245,45 @@
2026-02-20T22:09:17.8777098Z  async def delete_user_me(request: Request):
2026-02-20T22:09:17.8777165Z      """
2026-02-20T22:09:17.8777363Z      Handler pour supprimer le compte de l'utilisateur connecté.
2026-02-20T22:09:17.8777442Z      Route: DELETE /api/users/me
2026-02-20T22:09:17.8777559Z      Protégé CSRF (audit 3.2).
2026-02-20T22:09:17.8777629Z -    
2026-02-20T22:09:17.8777688Z +
2026-02-20T22:09:17.8777906Z      Supprime l'utilisateur et toutes ses données associées (cascade).
2026-02-20T22:09:17.8777974Z      """
2026-02-20T22:09:17.8778062Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:17.8778127Z      if csrf_err:
2026-02-20T22:09:17.8778204Z          return csrf_err
2026-02-20T22:09:17.8778264Z      try:
2026-02-20T22:09:17.8778353Z          from app.models.user import User
2026-02-20T22:09:17.8778417Z -        
2026-02-20T22:09:17.8778476Z +
2026-02-20T22:09:17.8778561Z          current_user = request.state.user
2026-02-20T22:09:17.8778620Z -        
2026-02-20T22:09:17.8778715Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8778813Z -        username = current_user.get('username')
2026-02-20T22:09:17.8778870Z -        
2026-02-20T22:09:17.8778932Z +
2026-02-20T22:09:17.8779010Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8779099Z +        username = current_user.get("username")
2026-02-20T22:09:17.8779164Z +
2026-02-20T22:09:17.8779248Z          async with db_session() as db:
2026-02-20T22:09:17.8779380Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8779450Z              if not user:
2026-02-20T22:09:17.8779656Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8779717Z -            
2026-02-20T22:09:17.8779795Z +                return JSONResponse(
2026-02-20T22:09:17.8779926Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8779992Z +                )
2026-02-20T22:09:17.8780136Z +
2026-02-20T22:09:17.8780369Z              # Suppression (les relations cascade suppriment les données liées)
2026-02-20T22:09:17.8780448Z              db.delete(user)
2026-02-20T22:09:17.8780515Z              db.commit()
2026-02-20T22:09:17.8780573Z -            
2026-02-20T22:09:17.8780634Z +
2026-02-20T22:09:17.8780877Z              logger.info(f"Compte utilisateur supprimé : {username} (ID: {user_id})")
2026-02-20T22:09:17.8780942Z -            
2026-02-20T22:09:17.8780998Z +
2026-02-20T22:09:17.8781164Z              # Créer la réponse avec suppression du cookie
2026-02-20T22:09:17.8781249Z -            response = JSONResponse({
2026-02-20T22:09:17.8781324Z -                "success": True,
2026-02-20T22:09:17.8781516Z -                "message": "Votre compte a été supprimé avec succès."
2026-02-20T22:09:17.8781577Z -            })
2026-02-20T22:09:17.8781655Z +            response = JSONResponse(
2026-02-20T22:09:17.8781895Z +                {"success": True, "message": "Votre compte a été supprimé avec succès."}
2026-02-20T22:09:17.8781969Z +            )
2026-02-20T22:09:17.8782069Z              response.delete_cookie("access_token")
2026-02-20T22:09:17.8782171Z              response.delete_cookie("refresh_token")
2026-02-20T22:09:17.8782248Z              return response
2026-02-20T22:09:17.8782306Z -            
2026-02-20T22:09:17.8782450Z +
2026-02-20T22:09:17.8782527Z      except Exception as e:
2026-02-20T22:09:17.8782686Z          logger.error(f"Erreur lors de la suppression du compte: {e}")
2026-02-20T22:09:17.8782765Z          traceback.print_exc()
2026-02-20T22:09:17.8782948Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8783217Z  
2026-02-20T22:09:17.8783357Z @@ -1086,21 +1294,25 @@
2026-02-20T22:09:17.8783502Z      Handler pour supprimer un utilisateur par ID (admin).
2026-02-20T22:09:17.8783592Z      Route: DELETE /api/users/{user_id}
2026-02-20T22:09:17.8783654Z      """
2026-02-20T22:09:17.8783714Z      try:
2026-02-20T22:09:17.8783809Z          current_user = request.state.user
2026-02-20T22:09:17.8783874Z -        
2026-02-20T22:09:17.8784019Z -        user_to_delete_id = int(request.path_params.get('user_id'))
2026-02-20T22:09:17.8784117Z -        current_user_id = current_user.get('id')
2026-02-20T22:09:17.8784184Z -        
2026-02-20T22:09:17.8784242Z +
2026-02-20T22:09:17.8784387Z +        user_to_delete_id = int(request.path_params.get("user_id"))
2026-02-20T22:09:17.8784479Z +        current_user_id = current_user.get("id")
2026-02-20T22:09:17.8784542Z +
2026-02-20T22:09:17.8784633Z          if user_to_delete_id != current_user_id:
2026-02-20T22:09:17.8784986Z -            return JSONResponse({"error": "Non autorisé à supprimer cet utilisateur"}, status_code=403)
2026-02-20T22:09:17.8785057Z -            
2026-02-20T22:09:17.8785485Z -        logger.info(f"Tentative de suppression de l'utilisateur {user_to_delete_id} - Redirigé vers DELETE /api/users/me")
2026-02-20T22:09:17.8785566Z +            return JSONResponse(
2026-02-20T22:09:17.8785816Z +                {"error": "Non autorisé à supprimer cet utilisateur"}, status_code=403
2026-02-20T22:09:17.8785877Z +            )
2026-02-20T22:09:17.8785934Z +
2026-02-20T22:09:17.8786001Z +        logger.info(
2026-02-20T22:09:17.8786361Z +            f"Tentative de suppression de l'utilisateur {user_to_delete_id} - Redirigé vers DELETE /api/users/me"
2026-02-20T22:09:17.8786429Z +        )
2026-02-20T22:09:17.8786509Z          return JSONResponse(
2026-02-20T22:09:17.8786699Z              {"message": "Utilisez DELETE /api/users/me pour supprimer votre compte."},
2026-02-20T22:09:17.8786773Z -            status_code=400
2026-02-20T22:09:17.8786842Z +            status_code=400,
2026-02-20T22:09:17.8786907Z          )
2026-02-20T22:09:17.8786979Z      except ValueError:
2026-02-20T22:09:17.8787163Z          return JSONResponse({"error": "ID utilisateur invalide"}, status_code=400)
2026-02-20T22:09:17.8787238Z      except Exception as e:
2026-02-20T22:09:17.8787419Z          logger.error(f"Erreur lors de la suppression de l'utilisateur: {e}")
2026-02-20T22:09:17.8787624Z @@ -1111,31 +1323,33 @@
2026-02-20T22:09:17.8787691Z  @require_auth
2026-02-20T22:09:17.8787800Z  async def export_user_data(request: Request):
2026-02-20T22:09:17.8787860Z      """
2026-02-20T22:09:17.8788068Z      Exporte toutes les données de l'utilisateur connecté (RGPD).
2026-02-20T22:09:17.8788159Z      Route: GET /api/users/me/export
2026-02-20T22:09:17.8788224Z -    
2026-02-20T22:09:17.8788281Z +
2026-02-20T22:09:17.8788557Z      Retourne un JSON avec : profil, exercices tentés, défis tentés, badges, progression.
2026-02-20T22:09:17.8788624Z      """
2026-02-20T22:09:17.8788684Z      try:
2026-02-20T22:09:17.8788770Z          from app.models.user import User
2026-02-20T22:09:17.8788877Z          from app.models.attempt import Attempt
2026-02-20T22:09:17.8788976Z          from app.models.exercise import Exercise
2026-02-20T22:09:17.8789177Z          from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.8789316Z          from app.models.achievement import UserAchievement
2026-02-20T22:09:17.8789419Z          from app.models.progress import Progress
2026-02-20T22:09:17.8789553Z          from app.models.recommendation import Recommendation
2026-02-20T22:09:17.8789614Z -        
2026-02-20T22:09:17.8789679Z +
2026-02-20T22:09:17.8789881Z          current_user = request.state.user
2026-02-20T22:09:17.8789940Z -        
2026-02-20T22:09:17.8790022Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8790087Z -        
2026-02-20T22:09:17.8790147Z +
2026-02-20T22:09:17.8790225Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8790290Z +
2026-02-20T22:09:17.8790370Z          async with db_session() as db:
2026-02-20T22:09:17.8790502Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8790576Z              if not user:
2026-02-20T22:09:17.8790778Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8790843Z -            
2026-02-20T22:09:17.8790921Z +                return JSONResponse(
2026-02-20T22:09:17.8791059Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8791119Z +                )
2026-02-20T22:09:17.8791176Z +
2026-02-20T22:09:17.8791276Z              # Profil utilisateur (tous les champs)
2026-02-20T22:09:17.8791351Z              profile = {
2026-02-20T22:09:17.8791423Z                  "id": user.id,
2026-02-20T22:09:17.8791504Z                  "username": user.username,
2026-02-20T22:09:17.8791584Z                  "email": user.email,
2026-02-20T22:09:17.8791648Z @@ -1147,84 +1361,138 @@
2026-02-20T22:09:17.8791778Z                  "preferred_difficulty": user.preferred_difficulty,
2026-02-20T22:09:17.8791890Z                  "preferred_theme": user.preferred_theme,
2026-02-20T22:09:17.8792030Z                  "accessibility_settings": user.accessibility_settings,
2026-02-20T22:09:17.8792120Z                  "total_points": user.total_points,
2026-02-20T22:09:17.8792229Z                  "current_level": user.current_level,
2026-02-20T22:09:17.8792481Z -                "experience_points": user.experience_points if hasattr(user, 'experience_points') else 0,
2026-02-20T22:09:17.8792561Z +                "experience_points": (
2026-02-20T22:09:17.8792747Z +                    user.experience_points if hasattr(user, "experience_points") else 0
2026-02-20T22:09:17.8792815Z +                ),
2026-02-20T22:09:17.8792900Z                  "jedi_rank": user.jedi_rank,
2026-02-20T22:09:17.8793322Z -                "avatar_url": user.avatar_url if hasattr(user, 'avatar_url') else None,
2026-02-20T22:09:17.8793505Z +                "avatar_url": user.avatar_url if hasattr(user, "avatar_url") else None,
2026-02-20T22:09:17.8793682Z                  "created_at": user.created_at.isoformat() if user.created_at else None,
2026-02-20T22:09:17.8793857Z                  "updated_at": user.updated_at.isoformat() if user.updated_at else None,
2026-02-20T22:09:17.8794050Z              }
2026-02-20T22:09:17.8794113Z -            
2026-02-20T22:09:17.8794169Z +
2026-02-20T22:09:17.8794255Z              # Tentatives d'exercices
2026-02-20T22:09:17.8794435Z              attempts = db.query(Attempt).filter(Attempt.user_id == user_id).all()
2026-02-20T22:09:17.8794512Z              exercises_data = []
2026-02-20T22:09:17.8794598Z              for a in attempts:
2026-02-20T22:09:17.8794691Z -                exercises_data.append({
2026-02-20T22:09:17.8794784Z -                    "exercise_id": a.exercise_id,
2026-02-20T22:09:17.8794942Z -                    "answer": a.user_answer if hasattr(a, 'user_answer') else None,
2026-02-20T22:09:17.8795032Z -                    "is_correct": a.is_correct,
2026-02-20T22:09:17.8795192Z -                    "time_spent": a.time_spent if hasattr(a, 'time_spent') else None,
2026-02-20T22:09:17.8795401Z -                    "attempt_number": a.attempt_number if hasattr(a, 'attempt_number') else None,
2026-02-20T22:09:17.8795566Z -                    "hints_used": a.hints_used if hasattr(a, 'hints_used') else 0,
2026-02-20T22:09:17.8795725Z -                    "created_at": a.created_at.isoformat() if a.created_at else None,
2026-02-20T22:09:17.8795788Z -                })
2026-02-20T22:09:17.8795847Z -            
2026-02-20T22:09:17.8796042Z +                exercises_data.append(
2026-02-20T22:09:17.8796109Z +                    {
2026-02-20T22:09:17.8796205Z +                        "exercise_id": a.exercise_id,
2026-02-20T22:09:17.8796372Z +                        "answer": a.user_answer if hasattr(a, "user_answer") else None,
2026-02-20T22:09:17.8796463Z +                        "is_correct": a.is_correct,
2026-02-20T22:09:17.8796539Z +                        "time_spent": (
2026-02-20T22:09:17.8796676Z +                            a.time_spent if hasattr(a, "time_spent") else None
2026-02-20T22:09:17.8796742Z +                        ),
2026-02-20T22:09:17.8796824Z +                        "attempt_number": (
2026-02-20T22:09:17.8796982Z +                            a.attempt_number if hasattr(a, "attempt_number") else None
2026-02-20T22:09:17.8797053Z +                        ),
2026-02-20T22:09:17.8797207Z +                        "hints_used": a.hints_used if hasattr(a, "hints_used") else 0,
2026-02-20T22:09:17.8797280Z +                        "created_at": (
2026-02-20T22:09:17.8797424Z +                            a.created_at.isoformat() if a.created_at else None
2026-02-20T22:09:17.8797492Z +                        ),
2026-02-20T22:09:17.8797554Z +                    }
2026-02-20T22:09:17.8797620Z +                )
2026-02-20T22:09:17.8797678Z +
2026-02-20T22:09:17.8797817Z              # Tentatives de défis logiques
2026-02-20T22:09:17.8797980Z -            challenge_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8798100Z -                LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8798166Z -            ).all()
2026-02-20T22:09:17.8798246Z +            challenge_attempts = (
2026-02-20T22:09:17.8798353Z +                db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8798486Z +                .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:17.8798552Z +                .all()
2026-02-20T22:09:17.8798612Z +            )
2026-02-20T22:09:17.8798693Z              challenges_data = []
2026-02-20T22:09:17.8798792Z              for ca in challenge_attempts:
2026-02-20T22:09:17.8798877Z -                challenges_data.append({
2026-02-20T22:09:17.8798988Z -                    "challenge_id": ca.challenge_id,
2026-02-20T22:09:17.8799086Z -                    "user_solution": ca.user_solution,
2026-02-20T22:09:17.8799175Z -                    "is_correct": ca.is_correct,
2026-02-20T22:09:17.8799268Z -                    "time_spent": ca.time_spent,
2026-02-20T22:09:17.8799351Z -                    "hints_used": ca.hints_used,
2026-02-20T22:09:17.8799518Z -                    "created_at": ca.created_at.isoformat() if ca.created_at else None,
2026-02-20T22:09:17.8799664Z -                })
2026-02-20T22:09:17.8799731Z -            
2026-02-20T22:09:17.8799812Z +                challenges_data.append(
2026-02-20T22:09:17.8799877Z +                    {
2026-02-20T22:09:17.8799986Z +                        "challenge_id": ca.challenge_id,
2026-02-20T22:09:17.8800088Z +                        "user_solution": ca.user_solution,
2026-02-20T22:09:17.8800183Z +                        "is_correct": ca.is_correct,
2026-02-20T22:09:17.8800280Z +                        "time_spent": ca.time_spent,
2026-02-20T22:09:17.8800365Z +                        "hints_used": ca.hints_used,
2026-02-20T22:09:17.8800437Z +                        "created_at": (
2026-02-20T22:09:17.8800576Z +                            ca.created_at.isoformat() if ca.created_at else None
2026-02-20T22:09:17.8800645Z +                        ),
2026-02-20T22:09:17.8800708Z +                    }
2026-02-20T22:09:17.8800768Z +                )
2026-02-20T22:09:17.8800832Z +
2026-02-20T22:09:17.8800910Z              # Badges obtenus
2026-02-20T22:09:17.8801033Z -            achievements = db.query(UserAchievement).filter(
2026-02-20T22:09:17.8801135Z -                UserAchievement.user_id == user_id
2026-02-20T22:09:17.8801198Z -            ).all()
2026-02-20T22:09:17.8801271Z +            achievements = (
2026-02-20T22:09:17.8801432Z +                db.query(UserAchievement)
2026-02-20T22:09:17.8801551Z +                .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:17.8801614Z +                .all()
2026-02-20T22:09:17.8801674Z +            )
2026-02-20T22:09:17.8801750Z              badges_data = []
2026-02-20T22:09:17.8801831Z              for ach in achievements:
2026-02-20T22:09:17.8801908Z -                badges_data.append({
2026-02-20T22:09:17.8802146Z -                    "achievement_id": ach.achievement_id if hasattr(ach, 'achievement_id') else ach.id,
2026-02-20T22:09:17.8802417Z -                    "earned_at": ach.earned_at.isoformat() if hasattr(ach, 'earned_at') and ach.earned_at else None,
2026-02-20T22:09:17.8802635Z -                    "progress_data": ach.progress_data if hasattr(ach, 'progress_data') else None,
2026-02-20T22:09:17.8802831Z -                    "is_displayed": ach.is_displayed if hasattr(ach, 'is_displayed') else True,
2026-02-20T22:09:17.8802898Z -                })
2026-02-20T22:09:17.8803123Z -            
2026-02-20T22:09:17.8803245Z +                badges_data.append(
2026-02-20T22:09:17.8803316Z +                    {
2026-02-20T22:09:17.8803405Z +                        "achievement_id": (
2026-02-20T22:09:17.8803494Z +                            ach.achievement_id
2026-02-20T22:09:17.8803603Z +                            if hasattr(ach, "achievement_id")
2026-02-20T22:09:17.8803682Z +                            else ach.id
2026-02-20T22:09:17.8803748Z +                        ),
2026-02-20T22:09:17.8803821Z +                        "earned_at": (
2026-02-20T22:09:17.8803921Z +                            ach.earned_at.isoformat()
2026-02-20T22:09:17.8804052Z +                            if hasattr(ach, "earned_at") and ach.earned_at
2026-02-20T22:09:17.8804124Z +                            else None
2026-02-20T22:09:17.8804194Z +                        ),
2026-02-20T22:09:17.8804273Z +                        "progress_data": (
2026-02-20T22:09:17.8804445Z +                            ach.progress_data if hasattr(ach, "progress_data") else None
2026-02-20T22:09:17.8804514Z +                        ),
2026-02-20T22:09:17.8804595Z +                        "is_displayed": (
2026-02-20T22:09:17.8804747Z +                            ach.is_displayed if hasattr(ach, "is_displayed") else True
2026-02-20T22:09:17.8804810Z +                        ),
2026-02-20T22:09:17.8804880Z +                    }
2026-02-20T22:09:17.8804939Z +                )
2026-02-20T22:09:17.8804996Z +
2026-02-20T22:09:17.8805095Z              # Progression par type d'exercice
2026-02-20T22:09:17.8805305Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:17.8805511Z +            progress_records = (
2026-02-20T22:09:17.8805663Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:17.8805728Z +            )
2026-02-20T22:09:17.8805803Z              progress_data = []
2026-02-20T22:09:17.8805882Z              for p in progress_records:
2026-02-20T22:09:17.8805970Z -                progress_data.append({
2026-02-20T22:09:17.8806068Z -                    "exercise_type": p.exercise_type,
2026-02-20T22:09:17.8806160Z -                    "difficulty": p.difficulty,
2026-02-20T22:09:17.8806265Z -                    "total_attempts": p.total_attempts,
2026-02-20T22:09:17.8806372Z -                    "correct_attempts": p.correct_attempts,
2026-02-20T22:09:17.8806568Z -                    "success_rate": p.success_rate if hasattr(p, 'success_rate') else None,
2026-02-20T22:09:17.8806899Z -                    "last_attempt_at": p.last_attempt_at.isoformat() if hasattr(p, 'last_attempt_at') and p.last_attempt_at else None,
2026-02-20T22:09:17.8806969Z -                })
2026-02-20T22:09:17.8807028Z -            
2026-02-20T22:09:17.8807111Z +                progress_data.append(
2026-02-20T22:09:17.8807179Z +                    {
2026-02-20T22:09:17.8807283Z +                        "exercise_type": p.exercise_type,
2026-02-20T22:09:17.8807552Z +                        "difficulty": p.difficulty,
2026-02-20T22:09:17.8807660Z +                        "total_attempts": p.total_attempts,
2026-02-20T22:09:17.8807771Z +                        "correct_attempts": p.correct_attempts,
2026-02-20T22:09:17.8807850Z +                        "success_rate": (
2026-02-20T22:09:17.8807999Z +                            p.success_rate if hasattr(p, "success_rate") else None
2026-02-20T22:09:17.8808071Z +                        ),
2026-02-20T22:09:17.8808153Z +                        "last_attempt_at": (
2026-02-20T22:09:17.8808252Z +                            p.last_attempt_at.isoformat()
2026-02-20T22:09:17.8808400Z +                            if hasattr(p, "last_attempt_at") and p.last_attempt_at
2026-02-20T22:09:17.8808471Z +                            else None
2026-02-20T22:09:17.8808533Z +                        ),
2026-02-20T22:09:17.8808600Z +                    }
2026-02-20T22:09:17.8808664Z +                )
2026-02-20T22:09:17.8808726Z +
2026-02-20T22:09:17.8808876Z              # Recommandations personnalisées
2026-02-20T22:09:17.8809147Z -            recommendations = db.query(Recommendation).filter(Recommendation.user_id == user_id).all()
2026-02-20T22:09:17.8809225Z +            recommendations = (
2026-02-20T22:09:17.8809420Z +                db.query(Recommendation).filter(Recommendation.user_id == user_id).all()
2026-02-20T22:09:17.8809487Z +            )
2026-02-20T22:09:17.8809567Z              recommendations_data = []
2026-02-20T22:09:17.8809648Z              for r in recommendations:
2026-02-20T22:09:17.8809748Z -                recommendations_data.append({
2026-02-20T22:09:17.8809949Z -                    "exercise_type": r.exercise_type if hasattr(r, 'exercise_type') else None,
2026-02-20T22:09:17.8810102Z -                    "priority": r.priority if hasattr(r, 'priority') else None,
2026-02-20T22:09:17.8810287Z -                    "is_completed": r.is_completed if hasattr(r, 'is_completed') else False,
2026-02-20T22:09:17.8810433Z -                    "reason": r.reason if hasattr(r, 'reason') else None,
2026-02-20T22:09:17.8810690Z -                    "created_at": r.created_at.isoformat() if hasattr(r, 'created_at') and r.created_at else None,
2026-02-20T22:09:17.8810751Z -                })
2026-02-20T22:09:17.8810816Z -            
2026-02-20T22:09:17.8810904Z +                recommendations_data.append(
2026-02-20T22:09:17.8810967Z +                    {
2026-02-20T22:09:17.8811053Z +                        "exercise_type": (
2026-02-20T22:09:17.8811201Z +                            r.exercise_type if hasattr(r, "exercise_type") else None
2026-02-20T22:09:17.8811349Z +                        ),
2026-02-20T22:09:17.8811505Z +                        "priority": r.priority if hasattr(r, "priority") else None,
2026-02-20T22:09:17.8811589Z +                        "is_completed": (
2026-02-20T22:09:17.8811726Z +                            r.is_completed if hasattr(r, "is_completed") else False
2026-02-20T22:09:17.8811795Z +                        ),
2026-02-20T22:09:17.8811933Z +                        "reason": r.reason if hasattr(r, "reason") else None,
2026-02-20T22:09:17.8812008Z +                        "created_at": (
2026-02-20T22:09:17.8812102Z +                            r.created_at.isoformat()
2026-02-20T22:09:17.8812223Z +                            if hasattr(r, "created_at") and r.created_at
2026-02-20T22:09:17.8812294Z +                            else None
2026-02-20T22:09:17.8812357Z +                        ),
2026-02-20T22:09:17.8812419Z +                    }
2026-02-20T22:09:17.8812486Z +                )
2026-02-20T22:09:17.8812543Z +
2026-02-20T22:09:17.8812615Z              export = {
2026-02-20T22:09:17.8812758Z                  "export_date": datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8812837Z                  "format_version": "1.1",
2026-02-20T22:09:17.8812913Z                  "profile": profile,
2026-02-20T22:09:17.8813134Z                  "exercise_attempts": exercises_data,
2026-02-20T22:09:17.8813321Z @@ -1236,16 +1504,18 @@
2026-02-20T22:09:17.8813447Z                      "total_exercise_attempts": len(exercises_data),
2026-02-20T22:09:17.8813573Z                      "total_challenge_attempts": len(challenges_data),
2026-02-20T22:09:17.8813672Z                      "total_badges": len(badges_data),
2026-02-20T22:09:17.8813790Z                      "total_progress_records": len(progress_data),
2026-02-20T22:09:17.8813920Z                      "total_recommendations": len(recommendations_data),
2026-02-20T22:09:17.8813992Z -                }
2026-02-20T22:09:17.8814052Z +                },
2026-02-20T22:09:17.8814112Z              }
2026-02-20T22:09:17.8814180Z -            
2026-02-20T22:09:17.8814756Z -            logger.info(f"Export de données pour l'utilisateur {user_id} : {len(exercises_data)} exercices, {len(challenges_data)} défis, {len(badges_data)} badges")
2026-02-20T22:09:17.8814816Z +
2026-02-20T22:09:17.8814887Z +            logger.info(
2026-02-20T22:09:17.8815396Z +                f"Export de données pour l'utilisateur {user_id} : {len(exercises_data)} exercices, {len(challenges_data)} défis, {len(badges_data)} badges"
2026-02-20T22:09:17.8815458Z +            )
2026-02-20T22:09:17.8815540Z              return JSONResponse(export)
2026-02-20T22:09:17.8815605Z -            
2026-02-20T22:09:17.8815661Z +
2026-02-20T22:09:17.8815735Z      except Exception as e:
2026-02-20T22:09:17.8815926Z          logger.error(f"Erreur lors de l'export des données: {e}")
2026-02-20T22:09:17.8816013Z          traceback.print_exc()
2026-02-20T22:09:17.8816200Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8816266Z  
2026-02-20T22:09:17.8816340Z @@ -1256,96 +1526,114 @@
2026-02-20T22:09:17.8816540Z      Handler pour récupérer les sessions actives de l'utilisateur.
2026-02-20T22:09:17.8816622Z      Route: GET /api/users/me/sessions
2026-02-20T22:09:17.8816687Z      """
2026-02-20T22:09:17.8816747Z      try:
2026-02-20T22:09:17.8816840Z          current_user = request.state.user
2026-02-20T22:09:17.8816899Z -        
2026-02-20T22:09:17.8816963Z +
2026-02-20T22:09:17.8817042Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8817101Z -        
2026-02-20T22:09:17.8817164Z +
2026-02-20T22:09:17.8817279Z          # Récupérer la session DB
2026-02-20T22:09:17.8817359Z          async with db_session() as db:
2026-02-20T22:09:17.8817481Z              from app.models.user_session import UserSession
2026-02-20T22:09:17.8817570Z              from sqlalchemy import and_
2026-02-20T22:09:17.8817631Z -            
2026-02-20T22:09:17.8817690Z +
2026-02-20T22:09:17.8817878Z              # Récupérer toutes les sessions actives non expirées
2026-02-20T22:09:17.8818105Z -            sessions = db.query(UserSession).filter(
2026-02-20T22:09:17.8818170Z -                and_(
2026-02-20T22:09:17.8818267Z -                    UserSession.user_id == user_id,
2026-02-20T22:09:17.8818375Z -                    UserSession.is_active == True,
2026-02-20T22:09:17.8818526Z -                    UserSession.expires_at > datetime.now(timezone.utc)
2026-02-20T22:09:17.8818589Z -                )
2026-02-20T22:09:17.8818721Z -            ).order_by(UserSession.last_activity.desc()).all()
2026-02-20T22:09:17.8818781Z -            
2026-02-20T22:09:17.8819091Z -            logger.debug(f"Récupération de {len(sessions)} sessions actives pour user_id={user_id}")
2026-02-20T22:09:17.8819158Z -            
2026-02-20T22:09:17.8819229Z +            sessions = (
2026-02-20T22:09:17.8819308Z +                db.query(UserSession)
2026-02-20T22:09:17.8819373Z +                .filter(
2026-02-20T22:09:17.8819446Z +                    and_(
2026-02-20T22:09:17.8819555Z +                        UserSession.user_id == user_id,
2026-02-20T22:09:17.8819654Z +                        UserSession.is_active == True,
2026-02-20T22:09:17.8819804Z +                        UserSession.expires_at > datetime.now(timezone.utc),
2026-02-20T22:09:17.8819867Z +                    )
2026-02-20T22:09:17.8820010Z +                )
2026-02-20T22:09:17.8820128Z +                .order_by(UserSession.last_activity.desc())
2026-02-20T22:09:17.8820191Z +                .all()
2026-02-20T22:09:17.8820251Z +            )
2026-02-20T22:09:17.8820309Z +
2026-02-20T22:09:17.8820386Z +            logger.debug(
2026-02-20T22:09:17.8820641Z +                f"Récupération de {len(sessions)} sessions actives pour user_id={user_id}"
2026-02-20T22:09:17.8820703Z +            )
2026-02-20T22:09:17.8820770Z +
2026-02-20T22:09:17.8821070Z              # Session la plus récente = probablement la session actuelle (requête depuis celle-ci)
2026-02-20T22:09:17.8821205Z              most_recent_id = sessions[0].id if sessions else None
2026-02-20T22:09:17.8821280Z              session_list = []
2026-02-20T22:09:17.8821366Z              for session in sessions:
2026-02-20T22:09:17.8821439Z                  session_dict = {
2026-02-20T22:09:17.8821516Z                      "id": session.id,
2026-02-20T22:09:17.8821634Z                      "device_info": session.device_info,
2026-02-20T22:09:17.8821820Z -                    "ip_address": str(session.ip_address) if session.ip_address else None,
2026-02-20T22:09:17.8821894Z +                    "ip_address": (
2026-02-20T22:09:17.8822044Z +                        str(session.ip_address) if session.ip_address else None
2026-02-20T22:09:17.8822110Z +                    ),
2026-02-20T22:09:17.8822207Z                      "user_agent": session.user_agent,
2026-02-20T22:09:17.8822313Z                      "location_data": session.location_data,
2026-02-20T22:09:17.8822410Z                      "is_active": session.is_active,
2026-02-20T22:09:17.8822546Z                      "last_activity": session.last_activity.isoformat(),
2026-02-20T22:09:17.8822663Z                      "created_at": session.created_at.isoformat(),
2026-02-20T22:09:17.8822783Z                      "expires_at": session.expires_at.isoformat(),
2026-02-20T22:09:17.8822892Z                      "is_current": session.id == most_recent_id,
2026-02-20T22:09:17.8823144Z                  }
2026-02-20T22:09:17.8823304Z                  session_list.append(session_dict)
2026-02-20T22:09:17.8823368Z -            
2026-02-20T22:09:17.8823426Z +
2026-02-20T22:09:17.8823552Z              return JSONResponse(session_list, status_code=200)
2026-02-20T22:09:17.8823618Z -    
2026-02-20T22:09:17.8823675Z +
2026-02-20T22:09:17.8823750Z      except Exception as e:
2026-02-20T22:09:17.8823987Z          logger.error(f"Erreur lors de la récupération des sessions: {e}")
2026-02-20T22:09:17.8824069Z          traceback.print_exc()
2026-02-20T22:09:17.8824404Z -        return JSONResponse({"error": "Erreur lors de la récupération des sessions"}, status_code=500)
2026-02-20T22:09:17.8824631Z +        return JSONResponse(
2026-02-20T22:09:17.8824877Z +            {"error": "Erreur lors de la récupération des sessions"}, status_code=500
2026-02-20T22:09:17.8824939Z +        )
2026-02-20T22:09:17.8824996Z  
2026-02-20T22:09:17.8825061Z  
2026-02-20T22:09:17.8825135Z  @require_auth
2026-02-20T22:09:17.8825249Z  async def revoke_user_session(request: Request):
2026-02-20T22:09:17.8825317Z      """
2026-02-20T22:09:17.8825510Z      Handler pour révoquer une session utilisateur spécifique.
2026-02-20T22:09:17.8825622Z      Route: DELETE /api/users/me/sessions/{session_id}
2026-02-20T22:09:17.8825681Z      """
2026-02-20T22:09:17.8825748Z      try:
2026-02-20T22:09:17.8825836Z          current_user = request.state.user
2026-02-20T22:09:17.8825898Z -        
2026-02-20T22:09:17.8825963Z +
2026-02-20T22:09:17.8826044Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8826179Z -        session_id = int(request.path_params.get('session_id'))
2026-02-20T22:09:17.8826249Z -        
2026-02-20T22:09:17.8826382Z +        session_id = int(request.path_params.get("session_id"))
2026-02-20T22:09:17.8826440Z +
2026-02-20T22:09:17.8826554Z          # Récupérer la session DB
2026-02-20T22:09:17.8826640Z          async with db_session() as db:
2026-02-20T22:09:17.8826877Z              from app.models.user_session import UserSession
2026-02-20T22:09:17.8826939Z -            
2026-02-20T22:09:17.8827003Z +
2026-02-20T22:09:17.8827116Z              # Récupérer la session
2026-02-20T22:09:17.8827218Z -            session = db.query(UserSession).filter(
2026-02-20T22:09:17.8827309Z -                UserSession.id == session_id,
2026-02-20T22:09:17.8827406Z -                UserSession.user_id == user_id
2026-02-20T22:09:17.8827474Z -            ).first()
2026-02-20T22:09:17.8827534Z -            
2026-02-20T22:09:17.8827608Z +            session = (
2026-02-20T22:09:17.8827687Z +                db.query(UserSession)
2026-02-20T22:09:17.8827876Z +                .filter(UserSession.id == session_id, UserSession.user_id == user_id)
2026-02-20T22:09:17.8827944Z +                .first()
2026-02-20T22:09:17.8828012Z +            )
2026-02-20T22:09:17.8828070Z +
2026-02-20T22:09:17.8828144Z              if not session:
2026-02-20T22:09:17.8828633Z -                logger.warning(f"Tentative de révocation d'une session inexistante ou non autorisée: session_id={session_id}, user_id={user_id}")
2026-02-20T22:09:17.8828719Z +                logger.warning(
2026-02-20T22:09:17.8829141Z +                    f"Tentative de révocation d'une session inexistante ou non autorisée: session_id={session_id}, user_id={user_id}"
2026-02-20T22:09:17.8829209Z +                )
2026-02-20T22:09:17.8829292Z                  return JSONResponse(
2026-02-20T22:09:17.8829591Z -                    {"error": "Session non trouvée ou vous n'avez pas l'autorisation de la révoquer"},
2026-02-20T22:09:17.8829668Z -                    status_code=404
2026-02-20T22:09:17.8829744Z -                )
2026-02-20T22:09:17.8829804Z -            
2026-02-20T22:09:17.8829867Z +                    {
2026-02-20T22:09:17.8830161Z +                        "error": "Session non trouvée ou vous n'avez pas l'autorisation de la révoquer"
2026-02-20T22:09:17.8830227Z +                    },
2026-02-20T22:09:17.8830313Z +                    status_code=404,
2026-02-20T22:09:17.8830379Z +                )
2026-02-20T22:09:17.8830438Z +
2026-02-20T22:09:17.8830531Z              # Marquer la session comme inactive
2026-02-20T22:09:17.8830612Z              session.is_active = False
2026-02-20T22:09:17.8830687Z              db.commit()
2026-02-20T22:09:17.8830747Z -            
2026-02-20T22:09:17.8830803Z +
2026-02-20T22:09:17.8831044Z              logger.info(f"Session {session_id} révoquée pour user_id={user_id}")
2026-02-20T22:09:17.8831103Z -            
2026-02-20T22:09:17.8831185Z -            return JSONResponse({
2026-02-20T22:09:17.8831258Z -                "success": True,
2026-02-20T22:09:17.8831510Z -                "message": "Session révoquée avec succès"
2026-02-20T22:09:17.8831585Z -            }, status_code=200)
2026-02-20T22:09:17.8831644Z -    
2026-02-20T22:09:17.8831711Z +
2026-02-20T22:09:17.8831785Z +            return JSONResponse(
2026-02-20T22:09:17.8831992Z +                {"success": True, "message": "Session révoquée avec succès"},
2026-02-20T22:09:17.8832072Z +                status_code=200,
2026-02-20T22:09:17.8832138Z +            )
2026-02-20T22:09:17.8832196Z +
2026-02-20T22:09:17.8832271Z      except ValueError:
2026-02-20T22:09:17.8832461Z          return JSONResponse({"error": "ID de session invalide"}, status_code=400)
2026-02-20T22:09:17.8832539Z      except Exception as e:
2026-02-20T22:09:17.8832754Z          logger.error(f"Erreur lors de la révocation de la session: {e}")
2026-02-20T22:09:17.8832843Z          traceback.print_exc()
2026-02-20T22:09:17.8833387Z -        return JSONResponse({"error": "Erreur lors de la révocation de la session"}, status_code=500)
2026-02-20T22:09:17.8833483Z \ No newline at end of file
2026-02-20T22:09:17.8833562Z +        return JSONResponse(
2026-02-20T22:09:17.8833810Z +            {"error": "Erreur lors de la révocation de la session"}, status_code=500
2026-02-20T22:09:17.8833872Z +        )
2026-02-20T22:09:17.8833912Z 
2026-02-20T22:09:17.8834160Z Oh no! 💥 💔 💥
2026-02-20T22:09:17.8834327Z 81 files would be reformatted, 6 files would be left unchanged.
2026-02-20T22:09:17.8942772Z ##[error]Process completed with exit code 1.
