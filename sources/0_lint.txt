2026-02-20T22:09:01.2422857Z Current runner version: '2.331.0'
2026-02-20T22:09:01.2459409Z ##[group]Runner Image Provisioner
2026-02-20T22:09:01.2460650Z Hosted Compute Agent
2026-02-20T22:09:01.2461735Z Version: 20260123.484
2026-02-20T22:09:01.2462696Z Commit: 6bd6555ca37d84114959e1c76d2c01448ff61c5d
2026-02-20T22:09:01.2464295Z Build Date: 2026-01-23T19:41:17Z
2026-02-20T22:09:01.2465388Z Worker ID: {edfd4234-de1f-465d-adcb-f0cc40e13154}
2026-02-20T22:09:01.2466622Z Azure Region: eastus2
2026-02-20T22:09:01.2467635Z ##[endgroup]
2026-02-20T22:09:01.2469953Z ##[group]Operating System
2026-02-20T22:09:01.2470891Z Ubuntu
2026-02-20T22:09:01.2471762Z 24.04.3
2026-02-20T22:09:01.2472574Z LTS
2026-02-20T22:09:01.2473500Z ##[endgroup]
2026-02-20T22:09:01.2474548Z ##[group]Runner Image
2026-02-20T22:09:01.2475457Z Image: ubuntu-24.04
2026-02-20T22:09:01.2476355Z Version: 20260201.15.1
2026-02-20T22:09:01.2478514Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20260201.15/images/ubuntu/Ubuntu2404-Readme.md
2026-02-20T22:09:01.2481287Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20260201.15
2026-02-20T22:09:01.2482830Z ##[endgroup]
2026-02-20T22:09:01.2487936Z ##[group]GITHUB_TOKEN Permissions
2026-02-20T22:09:01.2490816Z Actions: write
2026-02-20T22:09:01.2491726Z ArtifactMetadata: write
2026-02-20T22:09:01.2492841Z Attestations: write
2026-02-20T22:09:01.2493970Z Checks: write
2026-02-20T22:09:01.2495461Z Contents: write
2026-02-20T22:09:01.2496455Z Deployments: write
2026-02-20T22:09:01.2497375Z Discussions: write
2026-02-20T22:09:01.2498408Z Issues: write
2026-02-20T22:09:01.2499277Z Metadata: read
2026-02-20T22:09:01.2500149Z Models: read
2026-02-20T22:09:01.2501171Z Packages: write
2026-02-20T22:09:01.2502026Z Pages: write
2026-02-20T22:09:01.2503337Z PullRequests: write
2026-02-20T22:09:01.2504449Z RepositoryProjects: write
2026-02-20T22:09:01.2505372Z SecurityEvents: write
2026-02-20T22:09:01.2506294Z Statuses: write
2026-02-20T22:09:01.2507261Z ##[endgroup]
2026-02-20T22:09:01.2510490Z Secret source: Actions
2026-02-20T22:09:01.2512106Z Prepare workflow directory
2026-02-20T22:09:01.2989813Z Prepare all required actions
2026-02-20T22:09:01.3048249Z Getting action download info
2026-02-20T22:09:01.5164475Z Download action repository 'actions/checkout@v6' (SHA:de0fac2e4500dabe0009e67214ff5f5447ce83dd)
2026-02-20T22:09:01.6310243Z Download action repository 'actions/setup-python@v6' (SHA:a309ff8b426b58ec0e2a45f0f869d46889d02405)
2026-02-20T22:09:02.0099231Z Complete job name: lint
2026-02-20T22:09:02.0790724Z ##[group]Run actions/checkout@v6
2026-02-20T22:09:02.0791546Z with:
2026-02-20T22:09:02.0791953Z   repository: zyclope0/mathakine
2026-02-20T22:09:02.0792602Z   token: ***
2026-02-20T22:09:02.0793293Z   ssh-strict: true
2026-02-20T22:09:02.0793830Z   ssh-user: git
2026-02-20T22:09:02.0794238Z   persist-credentials: true
2026-02-20T22:09:02.0794684Z   clean: true
2026-02-20T22:09:02.0795094Z   sparse-checkout-cone-mode: true
2026-02-20T22:09:02.0795570Z   fetch-depth: 1
2026-02-20T22:09:02.0795981Z   fetch-tags: false
2026-02-20T22:09:02.0796372Z   show-progress: true
2026-02-20T22:09:02.0796774Z   lfs: false
2026-02-20T22:09:02.0797146Z   submodules: false
2026-02-20T22:09:02.0797546Z   set-safe-directory: true
2026-02-20T22:09:02.0798293Z ##[endgroup]
2026-02-20T22:09:02.1700114Z Syncing repository: zyclope0/mathakine
2026-02-20T22:09:02.1702030Z ##[group]Getting Git version info
2026-02-20T22:09:02.1702902Z Working directory is '/home/runner/work/mathakine/mathakine'
2026-02-20T22:09:02.1704262Z [command]/usr/bin/git version
2026-02-20T22:09:02.1773801Z git version 2.52.0
2026-02-20T22:09:02.1796475Z ##[endgroup]
2026-02-20T22:09:02.1810724Z Temporarily overriding HOME='/home/runner/work/_temp/cf54bc5f-d6b2-496a-98ef-7d41293f509f' before making global git config changes
2026-02-20T22:09:02.1812894Z Adding repository directory to the temporary git global config as a safe directory
2026-02-20T22:09:02.1816078Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/mathakine/mathakine
2026-02-20T22:09:02.1856681Z Deleting the contents of '/home/runner/work/mathakine/mathakine'
2026-02-20T22:09:02.1860269Z ##[group]Initializing the repository
2026-02-20T22:09:02.1864917Z [command]/usr/bin/git init /home/runner/work/mathakine/mathakine
2026-02-20T22:09:02.1980979Z hint: Using 'master' as the name for the initial branch. This default branch name
2026-02-20T22:09:02.1982298Z hint: will change to "main" in Git 3.0. To configure the initial branch name
2026-02-20T22:09:02.1984197Z hint: to use in all of your new repositories, which will suppress this warning,
2026-02-20T22:09:02.1985411Z hint: call:
2026-02-20T22:09:02.1986000Z hint:
2026-02-20T22:09:02.1986741Z hint: 	git config --global init.defaultBranch <name>
2026-02-20T22:09:02.1987676Z hint:
2026-02-20T22:09:02.1988364Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
2026-02-20T22:09:02.1989708Z hint: 'development'. The just-created branch can be renamed via this command:
2026-02-20T22:09:02.1990461Z hint:
2026-02-20T22:09:02.1991087Z hint: 	git branch -m <name>
2026-02-20T22:09:02.1991695Z hint:
2026-02-20T22:09:02.1992308Z hint: Disable this message with "git config set advice.defaultBranchName false"
2026-02-20T22:09:02.1994083Z Initialized empty Git repository in /home/runner/work/mathakine/mathakine/.git/
2026-02-20T22:09:02.2000158Z [command]/usr/bin/git remote add origin https://github.com/zyclope0/mathakine
2026-02-20T22:09:02.2040835Z ##[endgroup]
2026-02-20T22:09:02.2041611Z ##[group]Disabling automatic garbage collection
2026-02-20T22:09:02.2045892Z [command]/usr/bin/git config --local gc.auto 0
2026-02-20T22:09:02.2078581Z ##[endgroup]
2026-02-20T22:09:02.2079258Z ##[group]Setting up auth
2026-02-20T22:09:02.2080795Z Removing SSH command configuration
2026-02-20T22:09:02.2089515Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2026-02-20T22:09:02.2124192Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2026-02-20T22:09:02.2496546Z Removing HTTP extra header
2026-02-20T22:09:02.2504524Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2026-02-20T22:09:02.2541757Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2026-02-20T22:09:02.2784275Z Removing includeIf entries pointing to credentials config files
2026-02-20T22:09:02.2789597Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2026-02-20T22:09:02.2824470Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2026-02-20T22:09:02.3054766Z [command]/usr/bin/git config --file /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config http.https://github.com/.extraheader AUTHORIZATION: basic ***
2026-02-20T22:09:02.3090339Z [command]/usr/bin/git config --local includeIf.gitdir:/home/runner/work/mathakine/mathakine/.git.path /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:02.3118977Z [command]/usr/bin/git config --local includeIf.gitdir:/home/runner/work/mathakine/mathakine/.git/worktrees/*.path /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:02.3151164Z [command]/usr/bin/git config --local includeIf.gitdir:/github/workspace/.git.path /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:02.3188048Z [command]/usr/bin/git config --local includeIf.gitdir:/github/workspace/.git/worktrees/*.path /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:02.3218985Z ##[endgroup]
2026-02-20T22:09:02.3219690Z ##[group]Fetching the repository
2026-02-20T22:09:02.3228225Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +4bb592240b396ea910621b85086f612e8b38c81f:refs/remotes/origin/master
2026-02-20T22:09:02.7839092Z From https://github.com/zyclope0/mathakine
2026-02-20T22:09:02.7840233Z  * [new ref]         4bb592240b396ea910621b85086f612e8b38c81f -> origin/master
2026-02-20T22:09:02.7882326Z [command]/usr/bin/git branch --list --remote origin/master
2026-02-20T22:09:02.7918980Z   origin/master
2026-02-20T22:09:02.7929414Z [command]/usr/bin/git rev-parse refs/remotes/origin/master
2026-02-20T22:09:02.7955323Z 4bb592240b396ea910621b85086f612e8b38c81f
2026-02-20T22:09:02.7963926Z ##[endgroup]
2026-02-20T22:09:02.7965159Z ##[group]Determining the checkout info
2026-02-20T22:09:02.7966574Z ##[endgroup]
2026-02-20T22:09:02.7969288Z [command]/usr/bin/git sparse-checkout disable
2026-02-20T22:09:02.8015500Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2026-02-20T22:09:02.8045664Z ##[group]Checking out the ref
2026-02-20T22:09:02.8049916Z [command]/usr/bin/git checkout --progress --force -B master refs/remotes/origin/master
2026-02-20T22:09:02.8463701Z Reset branch 'master'
2026-02-20T22:09:02.8465056Z branch 'master' set up to track 'origin/master'.
2026-02-20T22:09:02.8472018Z ##[endgroup]
2026-02-20T22:09:02.8513485Z [command]/usr/bin/git log -1 --format=%H
2026-02-20T22:09:02.8537826Z 4bb592240b396ea910621b85086f612e8b38c81f
2026-02-20T22:09:02.8841911Z ##[group]Run actions/setup-python@v6
2026-02-20T22:09:02.8842704Z with:
2026-02-20T22:09:02.8843432Z   python-version: 3.12
2026-02-20T22:09:02.8844003Z   check-latest: false
2026-02-20T22:09:02.8844809Z   token: ***
2026-02-20T22:09:02.8845292Z   update-environment: true
2026-02-20T22:09:02.8845928Z   allow-prereleases: false
2026-02-20T22:09:02.8846546Z   freethreaded: false
2026-02-20T22:09:02.8847059Z ##[endgroup]
2026-02-20T22:09:03.0098311Z ##[group]Installed versions
2026-02-20T22:09:03.0241337Z Successfully set up CPython (3.12.12)
2026-02-20T22:09:03.0243602Z ##[endgroup]
2026-02-20T22:09:03.0387213Z ##[group]Run python -m pip install --upgrade pip
2026-02-20T22:09:03.0388890Z [36;1mpython -m pip install --upgrade pip[0m
2026-02-20T22:09:03.0390348Z [36;1mpip install flake8 black isort[0m
2026-02-20T22:09:03.0587181Z shell: /usr/bin/bash -e {0}
2026-02-20T22:09:03.0588383Z env:
2026-02-20T22:09:03.0589571Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:03.0591561Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib/pkgconfig
2026-02-20T22:09:03.0593772Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:03.0595541Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:03.0597290Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:03.0599077Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib
2026-02-20T22:09:03.0600574Z ##[endgroup]
2026-02-20T22:09:05.0578579Z Requirement already satisfied: pip in /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages (26.0)
2026-02-20T22:09:05.1700603Z Collecting pip
2026-02-20T22:09:05.2421074Z   Downloading pip-26.0.1-py3-none-any.whl.metadata (4.7 kB)
2026-02-20T22:09:05.2539584Z Downloading pip-26.0.1-py3-none-any.whl (1.8 MB)
2026-02-20T22:09:05.3885726Z    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.8/1.8 MB 15.8 MB/s  0:00:00
2026-02-20T22:09:05.4139247Z Installing collected packages: pip
2026-02-20T22:09:05.4140217Z   Attempting uninstall: pip
2026-02-20T22:09:05.4160675Z     Found existing installation: pip 26.0
2026-02-20T22:09:05.4826377Z     Uninstalling pip-26.0:
2026-02-20T22:09:05.4890268Z       Successfully uninstalled pip-26.0
2026-02-20T22:09:06.3983189Z Successfully installed pip-26.0.1
2026-02-20T22:09:06.9608518Z Collecting flake8
2026-02-20T22:09:07.0277977Z   Downloading flake8-7.3.0-py2.py3-none-any.whl.metadata (3.8 kB)
2026-02-20T22:09:07.0873497Z Collecting black
2026-02-20T22:09:07.0967595Z   Downloading black-26.1.0-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl.metadata (88 kB)
2026-02-20T22:09:07.1554089Z Collecting isort
2026-02-20T22:09:07.1659664Z   Downloading isort-8.0.0-py3-none-any.whl.metadata (11 kB)
2026-02-20T22:09:07.1810704Z Collecting mccabe<0.8.0,>=0.7.0 (from flake8)
2026-02-20T22:09:07.1884877Z   Downloading mccabe-0.7.0-py2.py3-none-any.whl.metadata (5.0 kB)
2026-02-20T22:09:07.2053866Z Collecting pycodestyle<2.15.0,>=2.14.0 (from flake8)
2026-02-20T22:09:07.2146218Z   Downloading pycodestyle-2.14.0-py2.py3-none-any.whl.metadata (4.5 kB)
2026-02-20T22:09:07.2320628Z Collecting pyflakes<3.5.0,>=3.4.0 (from flake8)
2026-02-20T22:09:07.2401177Z   Downloading pyflakes-3.4.0-py2.py3-none-any.whl.metadata (3.5 kB)
2026-02-20T22:09:07.2601148Z Collecting click>=8.0.0 (from black)
2026-02-20T22:09:07.2673809Z   Downloading click-8.3.1-py3-none-any.whl.metadata (2.6 kB)
2026-02-20T22:09:07.2836937Z Collecting mypy-extensions>=0.4.3 (from black)
2026-02-20T22:09:07.2907030Z   Downloading mypy_extensions-1.1.0-py3-none-any.whl.metadata (1.1 kB)
2026-02-20T22:09:07.3083225Z Collecting packaging>=22.0 (from black)
2026-02-20T22:09:07.3181320Z   Downloading packaging-26.0-py3-none-any.whl.metadata (3.3 kB)
2026-02-20T22:09:07.3382083Z Collecting pathspec>=1.0.0 (from black)
2026-02-20T22:09:07.3477242Z   Downloading pathspec-1.0.4-py3-none-any.whl.metadata (13 kB)
2026-02-20T22:09:07.3811162Z Collecting platformdirs>=2 (from black)
2026-02-20T22:09:07.3895403Z   Downloading platformdirs-4.9.2-py3-none-any.whl.metadata (4.7 kB)
2026-02-20T22:09:07.4083354Z Collecting pytokens>=0.3.0 (from black)
2026-02-20T22:09:07.4164995Z   Downloading pytokens-0.4.1-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl.metadata (3.8 kB)
2026-02-20T22:09:07.4302105Z Downloading flake8-7.3.0-py2.py3-none-any.whl (57 kB)
2026-02-20T22:09:07.4444745Z Downloading mccabe-0.7.0-py2.py3-none-any.whl (7.3 kB)
2026-02-20T22:09:07.4540411Z Downloading pycodestyle-2.14.0-py2.py3-none-any.whl (31 kB)
2026-02-20T22:09:07.4681381Z Downloading pyflakes-3.4.0-py2.py3-none-any.whl (63 kB)
2026-02-20T22:09:07.4852060Z Downloading black-26.1.0-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (1.8 MB)
2026-02-20T22:09:07.5992408Z    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.8/1.8 MB 17.2 MB/s  0:00:00
2026-02-20T22:09:07.6067046Z Downloading isort-8.0.0-py3-none-any.whl (89 kB)
2026-02-20T22:09:07.6179654Z Downloading click-8.3.1-py3-none-any.whl (108 kB)
2026-02-20T22:09:07.6293932Z Downloading mypy_extensions-1.1.0-py3-none-any.whl (5.0 kB)
2026-02-20T22:09:07.6384065Z Downloading packaging-26.0-py3-none-any.whl (74 kB)
2026-02-20T22:09:07.6489815Z Downloading pathspec-1.0.4-py3-none-any.whl (55 kB)
2026-02-20T22:09:07.6668194Z Downloading platformdirs-4.9.2-py3-none-any.whl (21 kB)
2026-02-20T22:09:07.6765294Z Downloading pytokens-0.4.1-cp312-cp312-manylinux2014_x86_64.manylinux_2_17_x86_64.manylinux_2_28_x86_64.whl (269 kB)
2026-02-20T22:09:07.7234950Z Installing collected packages: pytokens, pyflakes, pycodestyle, platformdirs, pathspec, packaging, mypy-extensions, mccabe, isort, click, flake8, black
2026-02-20T22:09:08.2994942Z 
2026-02-20T22:09:08.3013366Z Successfully installed black-26.1.0 click-8.3.1 flake8-7.3.0 isort-8.0.0 mccabe-0.7.0 mypy-extensions-1.1.0 packaging-26.0 pathspec-1.0.4 platformdirs-4.9.2 pycodestyle-2.14.0 pyflakes-3.4.0 pytokens-0.4.1
2026-02-20T22:09:08.3602000Z ##[group]Run flake8 app/ server/ --count --select=E9,F63,F7,F82 --show-source --statistics
2026-02-20T22:09:08.3602625Z [36;1mflake8 app/ server/ --count --select=E9,F63,F7,F82 --show-source --statistics[0m
2026-02-20T22:09:08.3638215Z shell: /usr/bin/bash -e {0}
2026-02-20T22:09:08.3638434Z env:
2026-02-20T22:09:08.3638676Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:08.3639084Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib/pkgconfig
2026-02-20T22:09:08.3639507Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:08.3640041Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:08.3640388Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:08.3640742Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib
2026-02-20T22:09:08.3641033Z ##[endgroup]
2026-02-20T22:09:09.9332198Z 0
2026-02-20T22:09:09.9542564Z ##[group]Run black app/ server/ --check --diff
2026-02-20T22:09:09.9542915Z [36;1mblack app/ server/ --check --diff[0m
2026-02-20T22:09:09.9575213Z shell: /usr/bin/bash -e {0}
2026-02-20T22:09:09.9575441Z env:
2026-02-20T22:09:09.9575682Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9576083Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib/pkgconfig
2026-02-20T22:09:09.9576492Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9576840Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9577198Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:09.9577558Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib
2026-02-20T22:09:09.9577850Z ##[endgroup]
2026-02-20T22:09:10.6581358Z --- /home/runner/work/mathakine/mathakine/app/core/logging_config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.6586715Z +++ /home/runner/work/mathakine/mathakine/app/core/logging_config.py	2026-02-20 22:09:10.655743+00:00
2026-02-20T22:09:10.6591294Z @@ -27,11 +27,10 @@
2026-02-20T22:09:10.6595403Z  }
2026-02-20T22:09:10.6596928Z  
2026-02-20T22:09:10.6600525Z  # Format des logs
2026-02-20T22:09:10.6601639Z  LOG_FORMAT = "<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{line}</cyan>\
2026-02-20T22:09:10.6603464Z      - <level>{message}</level>"
2026-02-20T22:09:10.6627056Z would reformat /home/runner/work/mathakine/mathakine/app/core/logging_config.py
2026-02-20T22:09:10.6627774Z -
2026-02-20T22:09:10.6628684Z  
2026-02-20T22:09:10.6628983Z  
2026-02-20T22:09:10.6629407Z  def configure_logging(remove_existing_handlers=True):
2026-02-20T22:09:10.6630166Z      """
2026-02-20T22:09:10.6630600Z      Configure la journalisation pour l'application.
2026-02-20T22:09:10.6631136Z @@ -93,10 +92,11 @@
2026-02-20T22:09:10.6631452Z          )
2026-02-20T22:09:10.6631724Z  
2026-02-20T22:09:10.6632474Z      logger.info("Journalisation configurée avec succès")
2026-02-20T22:09:10.6633331Z      logger.debug(f"Dossier des logs: {LOGS_DIR}")
2026-02-20T22:09:10.6633815Z  
2026-02-20T22:09:10.6634077Z +
2026-02-20T22:09:10.6634492Z  # Configuration automatique lors de l'importation du module
2026-02-20T22:09:10.6635070Z  configure_logging()
2026-02-20T22:09:10.6635404Z  
2026-02-20T22:09:10.6635875Z  # Fonction d'assistance pour obtenir un logger nommé
2026-02-20T22:09:10.6636382Z  
2026-02-20T22:09:10.7418760Z --- /home/runner/work/mathakine/mathakine/app/core/config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.7419889Z +++ /home/runner/work/mathakine/mathakine/app/core/config.py	2026-02-20 22:09:10.738085+00:00
2026-02-20T22:09:10.7420759Z @@ -17,139 +17,162 @@
2026-02-20T22:09:10.7421150Z  if os.getenv("ENVIRONMENT") != "production":
2026-02-20T22:09:10.7421644Z      load_dotenv(override=False)
2026-02-20T22:09:10.7422122Z  logger.info("Chargement de la configuration...")
2026-02-20T22:09:10.7422607Z  
2026-02-20T22:09:10.7423353Z  # Base de données
2026-02-20T22:09:10.7431753Z -DATABASE_URL = os.getenv("DATABASE_URL", "***localhost/mathakine")
2026-02-20T22:09:10.7432473Z +DATABASE_URL = os.getenv(
2026-02-20T22:09:10.7433512Z +    "DATABASE_URL", "***localhost/mathakine"
2026-02-20T22:09:10.7434000Z +)
2026-02-20T22:09:10.7434259Z  
2026-02-20T22:09:10.7434936Z  # Fichier temporaire supprimé, utilisation exclusive de PostgreSQL
2026-02-20T22:09:10.7435894Z  # SQLALCHEMY_DATABASE_URL = DATABASE_URL if "test" not in DATABASE_URL else DATABASE_URL
2026-02-20T22:09:10.7436662Z  
2026-02-20T22:09:10.7437145Z  # Pour les tests, utiliser une URL spécifique
2026-02-20T22:09:10.7438319Z -TEST_DATABASE_URL = os.getenv("TEST_DATABASE_URL", "***localhost/test_mathakine")
2026-02-20T22:09:10.7439419Z +TEST_DATABASE_URL = os.getenv(
2026-02-20T22:09:10.7440237Z +    "TEST_DATABASE_URL", "***localhost/test_mathakine"
2026-02-20T22:09:10.7440748Z +)
2026-02-20T22:09:10.7441018Z +
2026-02-20T22:09:10.7441270Z  
2026-02-20T22:09:10.7441905Z  # Classe de configuration
2026-02-20T22:09:10.7442309Z  class Settings:
2026-02-20T22:09:10.7442615Z      """
2026-02-20T22:09:10.7443474Z      Classe contenant les paramètres de configuration de l'application.
2026-02-20T22:09:10.7444094Z      """
2026-02-20T22:09:10.7444344Z +
2026-02-20T22:09:10.7444640Z      PROJECT_NAME: str = "Mathakine"
2026-02-20T22:09:10.7445070Z      PROJECT_VERSION: str = "1.5.0"
2026-02-20T22:09:10.7445462Z -    
2026-02-20T22:09:10.7445710Z +
2026-02-20T22:09:10.7445972Z      API_V1_STR: str = "/api"
2026-02-20T22:09:10.7446601Z would reformat /home/runner/work/mathakine/mathakine/app/core/config.py
2026-02-20T22:09:10.7447276Z      SECRET_KEY: str = os.getenv("SECRET_KEY", "")
2026-02-20T22:09:10.7447748Z      if not SECRET_KEY:
2026-02-20T22:09:10.7448065Z          if (
2026-02-20T22:09:10.7448400Z              os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7449033Z              and os.getenv("TESTING", "false").lower() != "true"
2026-02-20T22:09:10.7449528Z          ):
2026-02-20T22:09:10.7449804Z              raise ValueError(
2026-02-20T22:09:10.7450374Z                  "SECRET_KEY doit être définie en production. "
2026-02-20T22:09:10.7451260Z -                "Générer avec: python -c \"import secrets; print(secrets.token_urlsafe(32))\""
2026-02-20T22:09:10.7452309Z +                'Générer avec: python -c "import secrets; print(secrets.token_urlsafe(32))"'
2026-02-20T22:09:10.7468297Z              )
2026-02-20T22:09:10.7468760Z          SECRET_KEY = secrets.token_urlsafe(32)
2026-02-20T22:09:10.7469699Z -        logger.warning("SECRET_KEY non définie, génération automatique (DEV uniquement)")
2026-02-20T22:09:10.7470406Z -    
2026-02-20T22:09:10.7470714Z +        logger.warning(
2026-02-20T22:09:10.7471402Z +            "SECRET_KEY non définie, génération automatique (DEV uniquement)"
2026-02-20T22:09:10.7472003Z +        )
2026-02-20T22:09:10.7472265Z +
2026-02-20T22:09:10.7472863Z      # 15 minutes (best-practice: court pour limiter la fenêtre si volé)
2026-02-20T22:09:10.7473815Z      # Le refresh automatique prolonge la session sans re-login
2026-02-20T22:09:10.7474407Z      ACCESS_TOKEN_EXPIRE_MINUTES: int = 15
2026-02-20T22:09:10.7475290Z      # 7 jours (best-practice: refresh token plus long mais rotation à chaque utilisation)
2026-02-20T22:09:10.7476044Z      REFRESH_TOKEN_EXPIRE_DAYS: int = 7
2026-02-20T22:09:10.7476517Z      # Algorithme de chiffrement pour JWT
2026-02-20T22:09:10.7476967Z      ALGORITHM: str = "HS256"
2026-02-20T22:09:10.7477329Z -    
2026-02-20T22:09:10.7477587Z +
2026-02-20T22:09:10.7477987Z      # Configuration de la base de données
2026-02-20T22:09:10.7478586Z      POSTGRES_SERVER: str = os.getenv("POSTGRES_SERVER", "localhost")
2026-02-20T22:09:10.7479360Z      POSTGRES_USER: str = os.getenv("POSTGRES_USER", "postgres")
2026-02-20T22:09:10.7480126Z      POSTGRES_PASSWORD: str = os.getenv("POSTGRES_PASSWORD", "postgres")
2026-02-20T22:09:10.7480917Z      POSTGRES_DB: str = os.getenv("POSTGRES_DB", "mathakine")
2026-02-20T22:09:10.7482035Z -    DATABASE_URL: str = os.getenv("DATABASE_URL", f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@{POSTGRES_SERVER}/{POSTGRES_DB}")
2026-02-20T22:09:10.7483194Z -    
2026-02-20T22:09:10.7483495Z +    DATABASE_URL: str = os.getenv(
2026-02-20T22:09:10.7483911Z +        "DATABASE_URL",
2026-02-20T22:09:10.7484546Z +        f"postgresql://{POSTGRES_USER}:{POSTGRES_PASSWORD}@{POSTGRES_SERVER}/{POSTGRES_DB}",
2026-02-20T22:09:10.7485269Z +    )
2026-02-20T22:09:10.7485523Z +
2026-02-20T22:09:10.7485800Z      # URL pour les tests
2026-02-20T22:09:10.7486772Z -    TEST_DATABASE_URL: str = os.getenv("TEST_DATABASE_URL", "***localhost/test_mathakine")
2026-02-20T22:09:10.7487758Z -    
2026-02-20T22:09:10.7488065Z +    TEST_DATABASE_URL: str = os.getenv(
2026-02-20T22:09:10.7488863Z +        "TEST_DATABASE_URL", "***localhost/test_mathakine"
2026-02-20T22:09:10.7489372Z +    )
2026-02-20T22:09:10.7489647Z +
2026-02-20T22:09:10.7489910Z      # Mode de test
2026-02-20T22:09:10.7490606Z      TESTING: bool = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:10.7491182Z -    
2026-02-20T22:09:10.7491444Z +
2026-02-20T22:09:10.7491735Z      # Utilisez cette URL pour les tests
2026-02-20T22:09:10.7492404Z      SQLALCHEMY_DATABASE_URL: str = TEST_DATABASE_URL if TESTING else DATABASE_URL
2026-02-20T22:09:10.7493252Z -    
2026-02-20T22:09:10.7493518Z +
2026-02-20T22:09:10.7493909Z      # Utilisateurs par défaut
2026-02-20T22:09:10.7494550Z      DEFAULT_ADMIN_EMAIL: str = os.getenv("DEFAULT_ADMIN_EMAIL", "admin@mathakine.com")
2026-02-20T22:09:10.7495453Z      DEFAULT_ADMIN_PASSWORD: str = os.getenv("DEFAULT_ADMIN_PASSWORD", "admin")
2026-02-20T22:09:10.7496089Z -    
2026-02-20T22:09:10.7496365Z +
2026-02-20T22:09:10.7496699Z      # Paramètres CORS
2026-02-20T22:09:10.7497065Z      BACKEND_CORS_ORIGINS: List[str] = [
2026-02-20T22:09:10.7497526Z          "http://localhost:8000",
2026-02-20T22:09:10.7497962Z          "http://localhost:3000",
2026-02-20T22:09:10.7498390Z          "http://localhost:5173",
2026-02-20T22:09:10.7498800Z          "http://127.0.0.1:8000",
2026-02-20T22:09:10.7499188Z          "http://127.0.0.1:3000",
2026-02-20T22:09:10.7499582Z          "http://127.0.0.1:5173",
2026-02-20T22:09:10.7499982Z          os.getenv("FRONTEND_URL", ""),
2026-02-20T22:09:10.7500384Z      ]
2026-02-20T22:09:10.7500640Z -    
2026-02-20T22:09:10.7500887Z +
2026-02-20T22:09:10.7501167Z      # Configuration de logging
2026-02-20T22:09:10.7501616Z      LOG_LEVEL: str = os.getenv("LOG_LEVEL", "INFO")
2026-02-20T22:09:10.7502227Z      LOG_FILE: str = os.getenv("LOG_FILE", "logs/mathakine.log")
2026-02-20T22:09:10.7502942Z      LOG_FORMAT: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
2026-02-20T22:09:10.7503715Z -    
2026-02-20T22:09:10.7503966Z +
2026-02-20T22:09:10.7504256Z      # Nombre d'exercices par page
2026-02-20T22:09:10.7504683Z      EXERCISES_PER_PAGE: int = 10
2026-02-20T22:09:10.7505059Z -    
2026-02-20T22:09:10.7505314Z +
2026-02-20T22:09:10.7505764Z      # Nombre d'exercices générés automatiquement
2026-02-20T22:09:10.7506272Z      AUTO_GENERATE_EXERCISES: int = 50
2026-02-20T22:09:10.7506671Z -    
2026-02-20T22:09:10.7506930Z +
2026-02-20T22:09:10.7507335Z      # Pourcentage d'exercices générés par IA
2026-02-20T22:09:10.7507818Z      AI_GENERATED_PERCENT: int = 20
2026-02-20T22:09:10.7508197Z -    
2026-02-20T22:09:10.7508456Z +
2026-02-20T22:09:10.7508778Z      # Configuration d'optimisation performance
2026-02-20T22:09:10.7509510Z      ENABLE_QUERY_CACHE: bool = os.getenv("ENABLE_QUERY_CACHE", "true").lower() == "true"
2026-02-20T22:09:10.7510427Z      CACHE_TTL_SECONDS: int = int(os.getenv("CACHE_TTL_SECONDS", "300"))  # 5 minutes
2026-02-20T22:09:10.7511300Z      MAX_CONNECTIONS_POOL: int = int(os.getenv("MAX_CONNECTIONS_POOL", "20"))
2026-02-20T22:09:10.7512193Z -    POOL_RECYCLE_SECONDS: int = int(os.getenv("POOL_RECYCLE_SECONDS", "3600"))  # 1 heure
2026-02-20T22:09:10.7512870Z -    
2026-02-20T22:09:10.7513363Z +    POOL_RECYCLE_SECONDS: int = int(
2026-02-20T22:09:10.7513856Z +        os.getenv("POOL_RECYCLE_SECONDS", "3600")
2026-02-20T22:09:10.7514314Z +    )  # 1 heure
2026-02-20T22:09:10.7514607Z +
2026-02-20T22:09:10.7514971Z      # Configuration sécurité
2026-02-20T22:09:10.7515540Z      RATE_LIMIT_PER_MINUTE: int = int(os.getenv("RATE_LIMIT_PER_MINUTE", "60"))
2026-02-20T22:09:10.7516387Z      MAX_CONTENT_LENGTH: int = int(os.getenv("MAX_CONTENT_LENGTH", "16777216"))  # 16MB
2026-02-20T22:09:10.7517271Z      SECURE_HEADERS: bool = os.getenv("SECURE_HEADERS", "true").lower() == "true"
2026-02-20T22:09:10.7517891Z -    
2026-02-20T22:09:10.7518148Z +
2026-02-20T22:09:10.7518424Z      # Configuration monitoring
2026-02-20T22:09:10.7519019Z      ENABLE_METRICS: bool = os.getenv("ENABLE_METRICS", "true").lower() == "true"
2026-02-20T22:09:10.7520011Z      METRICS_PORT: int = int(os.getenv("METRICS_PORT", "9090"))
2026-02-20T22:09:10.7520532Z -    
2026-02-20T22:09:10.7520790Z +
2026-02-20T22:09:10.7521065Z      # Configuration compression
2026-02-20T22:09:10.7521822Z      ENABLE_GZIP: bool = os.getenv("ENABLE_GZIP", "true").lower() == "true"
2026-02-20T22:09:10.7522650Z      GZIP_MINIMUM_SIZE: int = int(os.getenv("GZIP_MINIMUM_SIZE", "1024"))  # 1KB
2026-02-20T22:09:10.7524711Z -    
2026-02-20T22:09:10.7525606Z +
2026-02-20T22:09:10.7527972Z      # Configuration OpenAI pour génération IA
2026-02-20T22:09:10.7541790Z      OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY", "")
2026-02-20T22:09:10.7542889Z -    OPENAI_MODEL: str = os.getenv("OPENAI_MODEL", "gpt-4o-mini")  # Modèle par défaut (exercices)
2026-02-20T22:09:10.7543911Z +    OPENAI_MODEL: str = os.getenv(
2026-02-20T22:09:10.7544346Z +        "OPENAI_MODEL", "gpt-4o-mini"
2026-02-20T22:09:10.7544913Z +    )  # Modèle par défaut (exercices)
2026-02-20T22:09:10.7545635Z      # Modèle o1/o1-mini pour raisonnement mathématique - MÊME CLÉ API
2026-02-20T22:09:10.7546868Z      # Si défini : défis logiques (séquences, patterns) + exercices fractions. o1-mini = moins cher, o1 = plus capable.
2026-02-20T22:09:10.7548092Z -    OPENAI_MODEL_REASONING: str = os.getenv("OPENAI_MODEL_REASONING", "")  # ex: "o3", "o1-mini"
2026-02-20T22:09:10.7548913Z -    
2026-02-20T22:09:10.7549254Z +    OPENAI_MODEL_REASONING: str = os.getenv(
2026-02-20T22:09:10.7549731Z +        "OPENAI_MODEL_REASONING", ""
2026-02-20T22:09:10.7550162Z +    )  # ex: "o3", "o1-mini"
2026-02-20T22:09:10.7550510Z +
2026-02-20T22:09:10.7550768Z      class Config:
2026-02-20T22:09:10.7551088Z          case_sensitive = True
2026-02-20T22:09:10.7551450Z  
2026-02-20T22:09:10.7551704Z +
2026-02-20T22:09:10.7551968Z  settings = Settings()
2026-02-20T22:09:10.7552283Z +
2026-02-20T22:09:10.7552524Z  
2026-02-20T22:09:10.7553279Z  # Validation post-initialisation pour la sécurité en production
2026-02-20T22:09:10.7561581Z  def validate_production_settings():
2026-02-20T22:09:10.7562486Z      """Valide les paramètres de sécurité en production après initialisation"""
2026-02-20T22:09:10.7563420Z      is_production = (
2026-02-20T22:09:10.7563851Z -        os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:10.7564402Z -        os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:10.7564953Z -        os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:10.7565492Z +        os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:10.7566000Z +        or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7566552Z +        or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:10.7567013Z      )
2026-02-20T22:09:10.7567273Z -    
2026-02-20T22:09:10.7567530Z +
2026-02-20T22:09:10.7567801Z      if is_production:
2026-02-20T22:09:10.7568343Z          # Forcer LOG_LEVEL à INFO minimum en production
2026-02-20T22:09:10.7568902Z          if settings.LOG_LEVEL.upper() == "DEBUG":
2026-02-20T22:09:10.7569820Z -            logger.warning("LOG_LEVEL=DEBUG détecté en production - Forcé à INFO pour sécurité")
2026-02-20T22:09:10.7570559Z +            logger.warning(
2026-02-20T22:09:10.7571290Z +                "LOG_LEVEL=DEBUG détecté en production - Forcé à INFO pour sécurité"
2026-02-20T22:09:10.7571908Z +            )
2026-02-20T22:09:10.7572234Z              settings.LOG_LEVEL = "INFO"
2026-02-20T22:09:10.7572636Z -        
2026-02-20T22:09:10.7572924Z +
2026-02-20T22:09:10.7573726Z          # SECRET_KEY : blocage au démarrage si vide (voir init Settings)
2026-02-20T22:09:10.7577151Z          # 3.3 DEFAULT_ADMIN_PASSWORD : bloquer si faible en prod (évite compte admin exploitable)
2026-02-20T22:09:10.7604629Z          # Uniquement si ENVIRONMENT=production (Render), pas MATH_TRAINER_PROFILE (peut être prod en local)
2026-02-20T22:09:10.7605476Z          if (
2026-02-20T22:09:10.7605838Z              os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:10.7606583Z @@ -162,12 +185,15 @@
2026-02-20T22:09:10.7606918Z              raise ValueError(
2026-02-20T22:09:10.7607799Z                  "DEFAULT_ADMIN_PASSWORD doit être définie et différente de 'admin' en production. "
2026-02-20T22:09:10.7609115Z                  "Définir une valeur forte dans les variables d'environnement Render."
2026-02-20T22:09:10.7609771Z              )
2026-02-20T22:09:10.7610057Z  
2026-02-20T22:09:10.7610301Z +
2026-02-20T22:09:10.7610745Z  # Valider les paramètres au chargement du module
2026-02-20T22:09:10.7611257Z  validate_production_settings()
2026-02-20T22:09:10.7611640Z  
2026-02-20T22:09:10.7611926Z  # Configuration pour les tests
2026-02-20T22:09:10.7612346Z  if settings.TESTING:
2026-02-20T22:09:10.7613546Z -    logger.info(f"Mode test détecté, utilisation de l'URL de base de données: {settings.SQLALCHEMY_DATABASE_URL}")
2026-02-20T22:09:10.7614444Z +    logger.info(
2026-02-20T22:09:10.7615291Z +        f"Mode test détecté, utilisation de l'URL de base de données: {settings.SQLALCHEMY_DATABASE_URL}"
2026-02-20T22:09:10.7616082Z +    )
2026-02-20T22:09:10.7616533Z      # Autres configurations spécifiques aux tests
2026-02-20T22:09:10.7617345Z would reformat /home/runner/work/mathakine/mathakine/app/core/ai_config.py
2026-02-20T22:09:10.7618379Z --- /home/runner/work/mathakine/mathakine/app/core/ai_config.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.7619486Z +++ /home/runner/work/mathakine/mathakine/app/core/ai_config.py	2026-02-20 22:09:10.744641+00:00
2026-02-20T22:09:10.7620247Z @@ -5,10 +5,11 @@
2026-02-20T22:09:10.7620713Z  GPT-5.2 utilise de nouveaux paramètres :
2026-02-20T22:09:10.7621622Z  - reasoning.effort : none, low, medium, high, xhigh (contrôle la profondeur de raisonnement)
2026-02-20T22:09:10.7622705Z  - text.verbosity : low, medium, high (contrôle la longueur de réponse)
2026-02-20T22:09:10.7623777Z  - temperature n'est supporté QUE si reasoning.effort = none
2026-02-20T22:09:10.7624322Z  """
2026-02-20T22:09:10.7624598Z +
2026-02-20T22:09:10.7624890Z  from typing import Dict, Optional
2026-02-20T22:09:10.7625285Z  
2026-02-20T22:09:10.7625623Z  from app.core.logging_config import get_logger
2026-02-20T22:09:10.7626091Z  
2026-02-20T22:09:10.7626366Z  logger = get_logger(__name__)
2026-02-20T22:09:10.7626737Z @@ -16,104 +17,104 @@
2026-02-20T22:09:10.7627111Z  from app.core.config import settings
2026-02-20T22:09:10.7627521Z  
2026-02-20T22:09:10.7627753Z  
2026-02-20T22:09:10.7628011Z  class AIConfig:
2026-02-20T22:09:10.7628552Z      """Configuration centralisée pour la génération IA."""
2026-02-20T22:09:10.7629070Z -    
2026-02-20T22:09:10.7629333Z +
2026-02-20T22:09:10.7629948Z      # Modèle plus capable pour défis nécessitant du raisonnement logique/spatial
2026-02-20T22:09:10.7630698Z      # GPT-5.1 : bon raisonnement logique, 400K contexte
2026-02-20T22:09:10.7631425Z      # GPT-5-mini : bon rapport qualité/prix pour tâches simples
2026-02-20T22:09:10.7632293Z -    ADVANCED_MODEL: str = "gpt-5.1"      # Modèle avancé pour défis complexes
2026-02-20T22:09:10.7663601Z -    BASIC_MODEL: str = "gpt-5-mini"       # Modèle économique pour tâches simples
2026-02-20T22:09:10.7664265Z -    
2026-02-20T22:09:10.7664898Z +    ADVANCED_MODEL: str = "gpt-5.1"  # Modèle avancé pour défis complexes
2026-02-20T22:09:10.7665841Z +    BASIC_MODEL: str = "gpt-5-mini"  # Modèle économique pour tâches simples
2026-02-20T22:09:10.7666448Z +
2026-02-20T22:09:10.7666819Z      # Modèles par type de challenge
2026-02-20T22:09:10.7667378Z      # Note: SPATIAL a été fusionné dans VISUAL
2026-02-20T22:09:10.7667850Z      MODEL_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7668631Z -        'pattern': ADVANCED_MODEL,             # Patterns nécessitent raisonnement logique
2026-02-20T22:09:10.7669621Z -        'sequence': BASIC_MODEL,               # Séquences simples OK avec mini
2026-02-20T22:09:10.7670441Z -        'puzzle': BASIC_MODEL,                 # Puzzles OK avec mini + bonne validation
2026-02-20T22:09:10.7671413Z -        'graph': ADVANCED_MODEL,               # Graphes nécessitent cohérence stricte
2026-02-20T22:09:10.7672750Z -        'visual': ADVANCED_MODEL,              # Visual (inclut spatial) NÉCESSITE raisonnement avancé
2026-02-20T22:09:10.7673966Z -        'riddle': BASIC_MODEL,                 # Énigmes textuelles OK avec mini
2026-02-20T22:09:10.7675112Z -        'deduction': ADVANCED_MODEL,           # Déduction nécessite logique stricte
2026-02-20T22:09:10.7676248Z -        'coding': ADVANCED_MODEL,              # Cryptographie nécessite raisonnement pour cohérence
2026-02-20T22:09:10.7677313Z -        'chess': ADVANCED_MODEL,               # Échecs : positions tactiques complexes
2026-02-20T22:09:10.7678285Z -        'probability': BASIC_MODEL,             # Probabilités simples OK avec mini
2026-02-20T22:09:10.7678925Z -    }
2026-02-20T22:09:10.7679184Z -    
2026-02-20T22:09:10.7679796Z +        "pattern": ADVANCED_MODEL,  # Patterns nécessitent raisonnement logique
2026-02-20T22:09:10.7680671Z +        "sequence": BASIC_MODEL,  # Séquences simples OK avec mini
2026-02-20T22:09:10.7681399Z +        "puzzle": BASIC_MODEL,  # Puzzles OK avec mini + bonne validation
2026-02-20T22:09:10.7682264Z +        "graph": ADVANCED_MODEL,  # Graphes nécessitent cohérence stricte
2026-02-20T22:09:10.7683424Z +        "visual": ADVANCED_MODEL,  # Visual (inclut spatial) NÉCESSITE raisonnement avancé
2026-02-20T22:09:10.7684359Z +        "riddle": BASIC_MODEL,  # Énigmes textuelles OK avec mini
2026-02-20T22:09:10.7685186Z +        "deduction": ADVANCED_MODEL,  # Déduction nécessite logique stricte
2026-02-20T22:09:10.7686180Z +        "coding": ADVANCED_MODEL,  # Cryptographie nécessite raisonnement pour cohérence
2026-02-20T22:09:10.7687157Z +        "chess": ADVANCED_MODEL,  # Échecs : positions tactiques complexes
2026-02-20T22:09:10.7688034Z +        "probability": BASIC_MODEL,  # Probabilités simples OK avec mini
2026-02-20T22:09:10.7688617Z +    }
2026-02-20T22:09:10.7688865Z +
2026-02-20T22:09:10.7689377Z      # Reasoning Effort : contrôle la profondeur (o3, GPT-5.2)
2026-02-20T22:09:10.7690266Z      # low = rapide/économique, medium = équilibré, high = raisonnement profond
2026-02-20T22:09:10.7691202Z      # Pas de high partout : sequence/puzzle/riddle/graph/coding suffisent avec low/medium
2026-02-20T22:09:10.7691978Z      REASONING_EFFORT_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7692545Z -        'pattern': 'high',       # Patterns logiques complexes
2026-02-20T22:09:10.7723547Z -        'sequence': 'low',       # Séquences simples
2026-02-20T22:09:10.7724120Z -        'puzzle': 'low',         # Puzzles OK en low
2026-02-20T22:09:10.7724693Z -        'graph': 'medium',      # Graphes : medium suffit
2026-02-20T22:09:10.7725518Z -        'visual': 'high',       # Visual (formes/couleurs/symétrie) demande profond
2026-02-20T22:09:10.7726365Z -        'riddle': 'low',        # Énigmes textuelles simples
2026-02-20T22:09:10.7727072Z -        'deduction': 'high',    # Déduction logique stricte
2026-02-20T22:09:10.7727832Z -        'coding': 'medium',     # Cryptographie : medium pour cohérence
2026-02-20T22:09:10.7728758Z -        'chess': 'medium',      # Échecs : medium (o3 consomme beaucoup si high)
2026-02-20T22:09:10.7729575Z -        'probability': 'low',   # Probabilités : low suffit
2026-02-20T22:09:10.7730077Z -    }
2026-02-20T22:09:10.7730352Z -    
2026-02-20T22:09:10.7730719Z +        "pattern": "high",  # Patterns logiques complexes
2026-02-20T22:09:10.7731354Z +        "sequence": "low",  # Séquences simples
2026-02-20T22:09:10.7731861Z +        "puzzle": "low",  # Puzzles OK en low
2026-02-20T22:09:10.7732368Z +        "graph": "medium",  # Graphes : medium suffit
2026-02-20T22:09:10.7733312Z +        "visual": "high",  # Visual (formes/couleurs/symétrie) demande profond
2026-02-20T22:09:10.7734131Z +        "riddle": "low",  # Énigmes textuelles simples
2026-02-20T22:09:10.7734798Z +        "deduction": "high",  # Déduction logique stricte
2026-02-20T22:09:10.7735543Z +        "coding": "medium",  # Cryptographie : medium pour cohérence
2026-02-20T22:09:10.7736647Z +        "chess": "medium",  # Échecs : medium (o3 consomme beaucoup si high)
2026-02-20T22:09:10.7737452Z +        "probability": "low",  # Probabilités : low suffit
2026-02-20T22:09:10.7737953Z +    }
2026-02-20T22:09:10.7738204Z +
2026-02-20T22:09:10.7738884Z      # GPT-5.2 Verbosity : contrôle la longueur de réponse
2026-02-20T22:09:10.7739690Z      # low = concis (bon pour JSON), medium = équilibré, high = détaillé
2026-02-20T22:09:10.7740314Z      VERBOSITY_MAP: Dict[str, str] = {
2026-02-20T22:09:10.7740771Z -        'pattern': 'low',        # JSON concis
2026-02-20T22:09:10.7741253Z -        'sequence': 'low',       # JSON concis
2026-02-20T22:09:10.7741718Z -        'puzzle': 'low',         # JSON concis
2026-02-20T22:09:10.7742188Z -        'graph': 'low',          # JSON concis
2026-02-20T22:09:10.7742646Z -        'visual': 'low',         # JSON concis
2026-02-20T22:09:10.7743341Z -        'riddle': 'medium',      # Un peu plus de contexte
2026-02-20T22:09:10.7744081Z -        'deduction': 'medium',   # Explications détaillées
2026-02-20T22:09:10.7744703Z -        'coding': 'low',         # JSON concis pour cryptographie
2026-02-20T22:09:10.7745293Z -        'chess': 'low',          # JSON concis (board 8x8)
2026-02-20T22:09:10.7745823Z -        'probability': 'low',    # JSON concis
2026-02-20T22:09:10.7746233Z -    }
2026-02-20T22:09:10.7746487Z -    
2026-02-20T22:09:10.7746782Z +        "pattern": "low",  # JSON concis
2026-02-20T22:09:10.7747224Z +        "sequence": "low",  # JSON concis
2026-02-20T22:09:10.7747653Z +        "puzzle": "low",  # JSON concis
2026-02-20T22:09:10.7748155Z +        "graph": "low",  # JSON concis
2026-02-20T22:09:10.7748568Z +        "visual": "low",  # JSON concis
2026-02-20T22:09:10.7749048Z +        "riddle": "medium",  # Un peu plus de contexte
2026-02-20T22:09:10.7749724Z +        "deduction": "medium",  # Explications détaillées
2026-02-20T22:09:10.7750309Z +        "coding": "low",  # JSON concis pour cryptographie
2026-02-20T22:09:10.7750849Z +        "chess": "low",  # JSON concis (board 8x8)
2026-02-20T22:09:10.7751324Z +        "probability": "low",  # JSON concis
2026-02-20T22:09:10.7751737Z +    }
2026-02-20T22:09:10.7751987Z +
2026-02-20T22:09:10.7752556Z      # Températures - UNIQUEMENT utilisées si reasoning.effort = none
2026-02-20T22:09:10.7783762Z      # Pour GPT-5.2 avec reasoning activé, ces valeurs sont ignorées
2026-02-20T22:09:10.7784407Z      TEMPERATURE_MAP: Dict[str, float] = {
2026-02-20T22:09:10.7784860Z -        'pattern': 0.2,
2026-02-20T22:09:10.7785227Z -        'sequence': 0.3,
2026-02-20T22:09:10.7785584Z -        'puzzle': 0.5,
2026-02-20T22:09:10.7785909Z -        'graph': 0.3,
2026-02-20T22:09:10.7786243Z -        'visual': 0.3,
2026-02-20T22:09:10.7786570Z -        'riddle': 0.7,
2026-02-20T22:09:10.7786907Z -        'deduction': 0.3,
2026-02-20T22:09:10.7787589Z -        'coding': 0.3,           # Température basse pour cohérence cryptographique
2026-02-20T22:09:10.7788429Z -        'chess': 0.3,            # Positions tactiques cohérentes
2026-02-20T22:09:10.7789086Z -        'probability': 0.4,     # Légère variété
2026-02-20T22:09:10.7789518Z -    }
2026-02-20T22:09:10.7789767Z -    
2026-02-20T22:09:10.7790044Z +        "pattern": 0.2,
2026-02-20T22:09:10.7790393Z +        "sequence": 0.3,
2026-02-20T22:09:10.7790743Z +        "puzzle": 0.5,
2026-02-20T22:09:10.7791080Z +        "graph": 0.3,
2026-02-20T22:09:10.7791406Z +        "visual": 0.3,
2026-02-20T22:09:10.7791737Z +        "riddle": 0.7,
2026-02-20T22:09:10.7792064Z +        "deduction": 0.3,
2026-02-20T22:09:10.7792750Z +        "coding": 0.3,  # Température basse pour cohérence cryptographique
2026-02-20T22:09:10.7793699Z +        "chess": 0.3,  # Positions tactiques cohérentes
2026-02-20T22:09:10.7794324Z +        "probability": 0.4,  # Légère variété
2026-02-20T22:09:10.7794743Z +    }
2026-02-20T22:09:10.7794996Z +
2026-02-20T22:09:10.7795310Z      # Max tokens adaptatif selon le type
2026-02-20T22:09:10.7796021Z      # GPT-5 avec reasoning peut consommer beaucoup de tokens - augmenter les limites
2026-02-20T22:09:10.7797444Z      # Note: avec reasoning=high, le modèle utilise plus de tokens pour "réfléchir"
2026-02-20T22:09:10.7798182Z      MAX_TOKENS_MAP: Dict[str, int] = {
2026-02-20T22:09:10.7798942Z -        'pattern': 6000,     # Patterns avec visual_data
2026-02-20T22:09:10.7799714Z -        'sequence': 4000,    # Séquences avec visual_data
2026-02-20T22:09:10.7800455Z -        'puzzle': 5000,      # Puzzles avec hints détaillés
2026-02-20T22:09:10.7801233Z -        'graph': 6000,       # Graphes avec visual_data détaillé
2026-02-20T22:09:10.7802129Z -        'visual': 8000,      # Visual (inclut spatial) avec descriptions détaillées
2026-02-20T22:09:10.7803178Z -        'riddle': 5000,      # Énigmes avec contexte
2026-02-20T22:09:10.7804049Z -        'deduction': 8000,   # Déduction avec règles et explications détaillées
2026-02-20T22:09:10.7805009Z -        'coding': 6000,      # Cryptographie avec message encodé et clé
2026-02-20T22:09:10.7805801Z -        'chess': 14000,      # o3 raisonne avant output ; board 8x8 + explication
2026-02-20T22:09:10.7806632Z -        'probability': 4000, # Probabilités simples
2026-02-20T22:09:10.7807116Z -    }
2026-02-20T22:09:10.7807382Z -    
2026-02-20T22:09:10.7807768Z +        "pattern": 6000,  # Patterns avec visual_data
2026-02-20T22:09:10.7808474Z +        "sequence": 4000,  # Séquences avec visual_data
2026-02-20T22:09:10.7809185Z +        "puzzle": 5000,  # Puzzles avec hints détaillés
2026-02-20T22:09:10.7809885Z +        "graph": 6000,  # Graphes avec visual_data détaillé
2026-02-20T22:09:10.7810749Z +        "visual": 8000,  # Visual (inclut spatial) avec descriptions détaillées
2026-02-20T22:09:10.7811537Z +        "riddle": 5000,  # Énigmes avec contexte
2026-02-20T22:09:10.7812351Z +        "deduction": 8000,  # Déduction avec règles et explications détaillées
2026-02-20T22:09:10.7843583Z +        "coding": 6000,  # Cryptographie avec message encodé et clé
2026-02-20T22:09:10.7844387Z +        "chess": 14000,  # o3 raisonne avant output ; board 8x8 + explication
2026-02-20T22:09:10.7845223Z +        "probability": 4000,  # Probabilités simples
2026-02-20T22:09:10.7845711Z +    }
2026-02-20T22:09:10.7845994Z +
2026-02-20T22:09:10.7846362Z      # Timeouts - plus longs pour GPT-5 avec reasoning
2026-02-20T22:09:10.7847150Z -    DEFAULT_TIMEOUT: float = 90.0   # 90 secondes par défaut
2026-02-20T22:09:10.7847849Z -    MAX_TIMEOUT: float = 180.0      # Maximum 3 minutes
2026-02-20T22:09:10.7848321Z -    
2026-02-20T22:09:10.7848851Z +    DEFAULT_TIMEOUT: float = 90.0  # 90 secondes par défaut
2026-02-20T22:09:10.7849435Z +    MAX_TIMEOUT: float = 180.0  # Maximum 3 minutes
2026-02-20T22:09:10.7849885Z +
2026-02-20T22:09:10.7850167Z      # Retry configuration
2026-02-20T22:09:10.7850544Z      MAX_RETRIES: int = 3
2026-02-20T22:09:10.7850928Z      RETRY_BACKOFF_MULTIPLIER: float = 1.0
2026-02-20T22:09:10.7851397Z      RETRY_MIN_WAIT: float = 2.0
2026-02-20T22:09:10.7851816Z      RETRY_MAX_WAIT: float = 10.0
2026-02-20T22:09:10.7852207Z -    
2026-02-20T22:09:10.7852473Z +
2026-02-20T22:09:10.7852724Z      @classmethod
2026-02-20T22:09:10.7853287Z      def is_o1_model(cls, model: str) -> bool:
2026-02-20T22:09:10.7854319Z          """Vérifie si le modèle est o1/o1-mini (pas de response_format JSON, pas de reasoning_effort)."""
2026-02-20T22:09:10.7855211Z          return model and model.lower().startswith("o1")
2026-02-20T22:09:10.7855711Z  
2026-02-20T22:09:10.7855991Z @@ -126,44 +127,51 @@
2026-02-20T22:09:10.7856414Z      def get_model(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7857213Z          """Retourne le modèle à utiliser pour un type de challenge."""
2026-02-20T22:09:10.7857856Z          if settings.OPENAI_MODEL_REASONING:
2026-02-20T22:09:10.7858370Z              return settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:10.7859081Z          return cls.MODEL_MAP.get(challenge_type.lower(), settings.OPENAI_MODEL)
2026-02-20T22:09:10.7859709Z -    
2026-02-20T22:09:10.7860250Z +
2026-02-20T22:09:10.7860512Z      @classmethod
2026-02-20T22:09:10.7860970Z      def get_reasoning_effort(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7861674Z          """Retourne le niveau de raisonnement pour GPT-5.2."""
2026-02-20T22:09:10.7862667Z -        return cls.REASONING_EFFORT_MAP.get(challenge_type.lower(), 'medium')
2026-02-20T22:09:10.7863554Z -    
2026-02-20T22:09:10.7864080Z +        return cls.REASONING_EFFORT_MAP.get(challenge_type.lower(), "medium")
2026-02-20T22:09:10.7864674Z +
2026-02-20T22:09:10.7864892Z      @classmethod
2026-02-20T22:09:10.7865255Z      def get_verbosity(cls, challenge_type: str) -> str:
2026-02-20T22:09:10.7865951Z          """Retourne le niveau de verbosité pour GPT-5.2."""
2026-02-20T22:09:10.7866589Z -        return cls.VERBOSITY_MAP.get(challenge_type.lower(), 'low')
2026-02-20T22:09:10.7867130Z -    
2026-02-20T22:09:10.7867519Z +        return cls.VERBOSITY_MAP.get(challenge_type.lower(), "low")
2026-02-20T22:09:10.7868000Z +
2026-02-20T22:09:10.7868247Z      @classmethod
2026-02-20T22:09:10.7868665Z      def get_temperature(cls, challenge_type: str) -> float:
2026-02-20T22:09:10.7869548Z          """Retourne la température (utilisée seulement si reasoning.effort = none)."""
2026-02-20T22:09:10.7870357Z          return cls.TEMPERATURE_MAP.get(challenge_type.lower(), 0.6)
2026-02-20T22:09:10.7870828Z -    
2026-02-20T22:09:10.7871034Z +
2026-02-20T22:09:10.7871237Z      @classmethod
2026-02-20T22:09:10.7871555Z      def get_max_tokens(cls, challenge_type: str) -> int:
2026-02-20T22:09:10.7872274Z          """Retourne le max_tokens à utiliser pour un type de challenge."""
2026-02-20T22:09:10.7883438Z          return cls.MAX_TOKENS_MAP.get(challenge_type.lower(), 2000)
2026-02-20T22:09:10.7884092Z -    
2026-02-20T22:09:10.7884360Z +
2026-02-20T22:09:10.7884626Z      @classmethod
2026-02-20T22:09:10.7885143Z      def get_timeout(cls, challenge_type: Optional[str] = None) -> float:
2026-02-20T22:09:10.7885959Z          """Retourne le timeout à utiliser."""
2026-02-20T22:09:10.7886637Z          # Timeout plus long pour types complexes avec raisonnement profond
2026-02-20T22:09:10.7887533Z -        if challenge_type in ['visual', 'deduction', 'pattern', 'graph', 'coding', 'chess']:
2026-02-20T22:09:10.7888280Z +        if challenge_type in [
2026-02-20T22:09:10.7888687Z +            "visual",
2026-02-20T22:09:10.7889030Z +            "deduction",
2026-02-20T22:09:10.7889380Z +            "pattern",
2026-02-20T22:09:10.7889716Z +            "graph",
2026-02-20T22:09:10.7890030Z +            "coding",
2026-02-20T22:09:10.7890380Z +            "chess",
2026-02-20T22:09:10.7890695Z +        ]:
2026-02-20T22:09:10.7890996Z              return cls.MAX_TIMEOUT
2026-02-20T22:09:10.7891427Z          return cls.DEFAULT_TIMEOUT
2026-02-20T22:09:10.7891813Z -    
2026-02-20T22:09:10.7892081Z +
2026-02-20T22:09:10.7892337Z      @classmethod
2026-02-20T22:09:10.7892720Z      def is_gpt5_model(cls, model: str) -> bool:
2026-02-20T22:09:10.7893599Z          """Vérifie si le modèle est un GPT-5.x."""
2026-02-20T22:09:10.7894148Z -        return model.startswith('gpt-5')
2026-02-20T22:09:10.7894580Z -    
2026-02-20T22:09:10.7894885Z +        return model.startswith("gpt-5")
2026-02-20T22:09:10.7895309Z +
2026-02-20T22:09:10.7895561Z      @classmethod
2026-02-20T22:09:10.7896022Z      def get_openai_params(cls, challenge_type: str) -> Dict:
2026-02-20T22:09:10.7896956Z          """Retourne les paramètres OpenAI complets pour un type de challenge."""
2026-02-20T22:09:10.7897691Z          model = cls.get_model(challenge_type)
2026-02-20T22:09:10.7898307Z          reasoning_effort = cls.get_reasoning_effort(challenge_type)
2026-02-20T22:09:10.7898906Z @@ -189,6 +197,5 @@
2026-02-20T22:09:10.7899414Z                  params["temperature"] = cls.get_temperature(challenge_type)
2026-02-20T22:09:10.7900024Z          else:
2026-02-20T22:09:10.7900505Z              params["temperature"] = cls.get_temperature(challenge_type)
2026-02-20T22:09:10.7901077Z  
2026-02-20T22:09:10.7901352Z          return params
2026-02-20T22:09:10.7901958Z -
2026-02-20T22:09:10.8867184Z --- /home/runner/work/mathakine/mathakine/app/core/security.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.8869031Z +++ /home/runner/work/mathakine/mathakine/app/core/security.py	2026-02-20 22:09:10.883452+00:00
2026-02-20T22:09:10.8870509Z @@ -1,8 +1,9 @@
2026-02-20T22:09:10.8871507Z would reformat /home/runner/work/mathakine/mathakine/app/core/security.py
2026-02-20T22:09:10.8872140Z  """
2026-02-20T22:09:10.8873302Z  Utilitaires de sécurité pour l'authentification
2026-02-20T22:09:10.8874106Z  """
2026-02-20T22:09:10.8874650Z +
2026-02-20T22:09:10.8875113Z  from datetime import UTC, datetime, timedelta, timezone
2026-02-20T22:09:10.8875730Z  from typing import Any, Optional, Union
2026-02-20T22:09:10.8876164Z  
2026-02-20T22:09:10.8876438Z  import bcrypt
2026-02-20T22:09:10.8879399Z  from fastapi import HTTPException
2026-02-20T22:09:10.8879912Z @@ -16,20 +17,21 @@
2026-02-20T22:09:10.8880288Z  logger = get_logger(__name__)
2026-02-20T22:09:10.8880696Z  
2026-02-20T22:09:10.8881593Z  # Clé secrète pour la signature des tokens (à mettre en variable d'environnement en production)
2026-02-20T22:09:10.8882531Z  SECRET_KEY = settings.SECRET_KEY
2026-02-20T22:09:10.8882944Z  
2026-02-20T22:09:10.8883407Z +
2026-02-20T22:09:10.8883745Z  def decode_token(token: str) -> dict:
2026-02-20T22:09:10.8909375Z      """
2026-02-20T22:09:10.8910051Z would reformat /home/runner/work/mathakine/mathakine/app/core/monitoring.py
2026-02-20T22:09:10.8910943Z      Décode et vérifie un token JWT.
2026-02-20T22:09:10.8911386Z -    
2026-02-20T22:09:10.8911654Z +
2026-02-20T22:09:10.8911930Z      Args:
2026-02-20T22:09:10.8912372Z          token: Le token JWT à décoder
2026-02-20T22:09:10.8912813Z -        
2026-02-20T22:09:10.8913441Z +
2026-02-20T22:09:10.8913719Z      Returns:
2026-02-20T22:09:10.8914175Z          Le contenu décodé du token
2026-02-20T22:09:10.8914600Z -        
2026-02-20T22:09:10.8914875Z +
2026-02-20T22:09:10.8915115Z      Raises:
2026-02-20T22:09:10.8915612Z          HTTPException: Si le token est invalide ou expiré
2026-02-20T22:09:10.8916102Z      """
2026-02-20T22:09:10.8916360Z      try:
2026-02-20T22:09:10.8916881Z          payload = jwt.decode(token, SECRET_KEY, algorithms=[SecurityConfig.ALGORITHM])
2026-02-20T22:09:10.8917580Z @@ -39,101 +41,111 @@
2026-02-20T22:09:10.8917942Z          error_msg = str(jwt_decode_error)
2026-02-20T22:09:10.8918469Z          if "Signature verification failed" in error_msg:
2026-02-20T22:09:10.8919334Z              logger.debug(f"Signature verification failed (token invalide ou expiré)")
2026-02-20T22:09:10.8919977Z          else:
2026-02-20T22:09:10.8920552Z              logger.debug(f"Erreur lors du décodage du token: {error_msg}")
2026-02-20T22:09:10.8921237Z -        raise HTTPException(
2026-02-20T22:09:10.8921622Z -            status_code=401,
2026-02-20T22:09:10.8922113Z -            detail="Token invalide ou expiré"
2026-02-20T22:09:10.8922547Z -        )
2026-02-20T22:09:10.8923323Z +        raise HTTPException(status_code=401, detail="Token invalide ou expiré")
2026-02-20T22:09:10.8924000Z +
2026-02-20T22:09:10.8924265Z  
2026-02-20T22:09:10.8924819Z  def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
2026-02-20T22:09:10.8925535Z      """
2026-02-20T22:09:10.8925975Z      Crée un token JWT d'accès
2026-02-20T22:09:10.8926361Z -    
2026-02-20T22:09:10.8926630Z +
2026-02-20T22:09:10.8926890Z      Args:
2026-02-20T22:09:10.8927335Z          data: Données à inclure dans le token
2026-02-20T22:09:10.8927936Z          expires_delta: Délai d'expiration du token
2026-02-20T22:09:10.8928383Z -    
2026-02-20T22:09:10.8928648Z +
2026-02-20T22:09:10.8928917Z      Returns:
2026-02-20T22:09:10.8929276Z          Token encodé
2026-02-20T22:09:10.8929599Z      """
2026-02-20T22:09:10.8929863Z      to_encode = data.copy()
2026-02-20T22:09:10.8930180Z -    
2026-02-20T22:09:10.8930394Z +
2026-02-20T22:09:10.8930788Z      # Convertir les objets enum en valeurs de chaîne
2026-02-20T22:09:10.8931551Z      for key, value in to_encode.items():
2026-02-20T22:09:10.8931970Z -        if hasattr(value, 'value'):
2026-02-20T22:09:10.8932361Z +        if hasattr(value, "value"):
2026-02-20T22:09:10.8932779Z              to_encode[key] = value.value
2026-02-20T22:09:10.8933357Z -    
2026-02-20T22:09:10.8933825Z +
2026-02-20T22:09:10.8934124Z      # Calculer l'expiration
2026-02-20T22:09:10.8934490Z      if expires_delta:
2026-02-20T22:09:10.8934920Z          expire = datetime.now(timezone.utc) + expires_delta
2026-02-20T22:09:10.8935403Z      else:
2026-02-20T22:09:10.8936014Z -        expire = datetime.now(timezone.utc) + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
2026-02-20T22:09:10.8936748Z -    
2026-02-20T22:09:10.8937107Z +        expire = datetime.now(timezone.utc) + timedelta(
2026-02-20T22:09:10.8937675Z +            minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES
2026-02-20T22:09:10.8938155Z +        )
2026-02-20T22:09:10.8938416Z +
2026-02-20T22:09:10.8938725Z      # Ajouter l'expiration et le type de token
2026-02-20T22:09:10.8939310Z      to_encode.update({"exp": expire, "type": "access"})
2026-02-20T22:09:10.8939782Z -    
2026-02-20T22:09:10.8940037Z +
2026-02-20T22:09:10.8940292Z      # Encoder le token
2026-02-20T22:09:10.8940928Z -    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
2026-02-20T22:09:10.8941659Z +    encoded_jwt = jwt.encode(
2026-02-20T22:09:10.8942167Z +        to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM
2026-02-20T22:09:10.8942712Z +    )
2026-02-20T22:09:10.8943136Z      return encoded_jwt
2026-02-20T22:09:10.9003427Z +
2026-02-20T22:09:10.9003706Z  
2026-02-20T22:09:10.9004219Z  def verify_password(plain_password: str, hashed_password: str) -> bool:
2026-02-20T22:09:10.9004850Z      """
2026-02-20T22:09:10.9005505Z      Vérifie si un mot de passe en clair correspond à sa version hachée.
2026-02-20T22:09:10.9006087Z -    
2026-02-20T22:09:10.9006348Z +
2026-02-20T22:09:10.9006591Z      Args:
2026-02-20T22:09:10.9006950Z          plain_password: Mot de passe en clair
2026-02-20T22:09:10.9007607Z          hashed_password: Mot de passe haché à comparer
2026-02-20T22:09:10.9008086Z -    
2026-02-20T22:09:10.9008348Z +
2026-02-20T22:09:10.9008596Z      Returns:
2026-02-20T22:09:10.9009025Z          True si les mots de passe correspondent, False sinon
2026-02-20T22:09:10.9009532Z      """
2026-02-20T22:09:10.9009971Z      logger.debug("Vérification du mot de passe")
2026-02-20T22:09:10.9010431Z -    
2026-02-20T22:09:10.9010689Z +
2026-02-20T22:09:10.9010931Z      try:
2026-02-20T22:09:10.9011468Z          # S'assurer que le mot de passe est une chaîne UTF-8 valide
2026-02-20T22:09:10.9012083Z          if not isinstance(plain_password, str):
2026-02-20T22:09:10.9012591Z              plain_password = str(plain_password)
2026-02-20T22:09:10.9013204Z -        
2026-02-20T22:09:10.9013473Z +
2026-02-20T22:09:10.9013997Z          # Limiter la longueur à 72 bytes pour bcrypt (sécurité)
2026-02-20T22:09:10.9014641Z -        password_bytes = plain_password.encode('utf-8')
2026-02-20T22:09:10.9015251Z +        password_bytes = plain_password.encode("utf-8")
2026-02-20T22:09:10.9015776Z          if len(password_bytes) > 72:
2026-02-20T22:09:10.9016707Z -            logger.warning(f"Mot de passe trop long ({len(password_bytes)} bytes), tronqué à 72 bytes")
2026-02-20T22:09:10.9017685Z -            plain_password = password_bytes[:72].decode('utf-8', errors='ignore')
2026-02-20T22:09:10.9018308Z -        
2026-02-20T22:09:10.9018604Z +            logger.warning(
2026-02-20T22:09:10.9019343Z +                f"Mot de passe trop long ({len(password_bytes)} bytes), tronqué à 72 bytes"
2026-02-20T22:09:10.9019985Z +            )
2026-02-20T22:09:10.9020475Z +            plain_password = password_bytes[:72].decode("utf-8", errors="ignore")
2026-02-20T22:09:10.9049502Z +
2026-02-20T22:09:10.9050320Z          # Utiliser bcrypt directement au lieu de passlib pour éviter les warnings de compatibilité
2026-02-20T22:09:10.9051463Z          # Convertir le hash en bytes si c'est une string
2026-02-20T22:09:10.9052023Z          if isinstance(hashed_password, str):
2026-02-20T22:09:10.9052608Z -            hashed_password_bytes = hashed_password.encode('utf-8')
2026-02-20T22:09:10.9053821Z +            hashed_password_bytes = hashed_password.encode("utf-8")
2026-02-20T22:09:10.9054391Z          else:
2026-02-20T22:09:10.9054758Z              hashed_password_bytes = hashed_password
2026-02-20T22:09:10.9055214Z -        
2026-02-20T22:09:10.9055771Z -        result = bcrypt.checkpw(plain_password.encode('utf-8'), hashed_password_bytes)
2026-02-20T22:09:10.9056449Z +
2026-02-20T22:09:10.9056963Z +        result = bcrypt.checkpw(plain_password.encode("utf-8"), hashed_password_bytes)
2026-02-20T22:09:10.9057904Z          logger.debug(f"Résultat de la vérification: {result}")
2026-02-20T22:09:10.9058440Z          return result
2026-02-20T22:09:10.9058868Z      except Exception as password_verification_error:
2026-02-20T22:09:10.9059916Z -        logger.error(f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}")
2026-02-20T22:09:10.9060741Z +        logger.error(
2026-02-20T22:09:10.9061503Z +            f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}"
2026-02-20T22:09:10.9062224Z +        )
2026-02-20T22:09:10.9062497Z          raise
2026-02-20T22:09:10.9062766Z +
2026-02-20T22:09:10.9063192Z  
2026-02-20T22:09:10.9063522Z  def get_password_hash(password: str) -> str:
2026-02-20T22:09:10.9063985Z      """
2026-02-20T22:09:10.9064407Z      Crée un hash sécurisé d'un mot de passe.
2026-02-20T22:09:10.9064845Z -    
2026-02-20T22:09:10.9065097Z +
2026-02-20T22:09:10.9065352Z      Args:
2026-02-20T22:09:10.9065655Z          password: Mot de passe en clair
2026-02-20T22:09:10.9066076Z -    
2026-02-20T22:09:10.9066331Z +
2026-02-20T22:09:10.9066577Z      Returns:
2026-02-20T22:09:10.9066978Z          Version hachée du mot de passe
2026-02-20T22:09:10.9067379Z      """
2026-02-20T22:09:10.9067904Z      logger.debug(f"Génération du hash pour le mot de passe")
2026-02-20T22:09:10.9068425Z      try:
2026-02-20T22:09:10.9069191Z          # Utiliser bcrypt directement au lieu de passlib pour éviter les warnings de compatibilité
2026-02-20T22:09:10.9070114Z          # Générer un salt et hasher le mot de passe
2026-02-20T22:09:10.9070608Z          salt = bcrypt.gensalt()
2026-02-20T22:09:10.9071148Z -        hashed_bytes = bcrypt.hashpw(password.encode('utf-8'), salt)
2026-02-20T22:09:10.9071773Z -        hashed = hashed_bytes.decode('utf-8')
2026-02-20T22:09:10.9072370Z +        hashed_bytes = bcrypt.hashpw(password.encode("utf-8"), salt)
2026-02-20T22:09:10.9073110Z +        hashed = hashed_bytes.decode("utf-8")
2026-02-20T22:09:10.9073729Z          logger.debug("Hash mot de passe généré")
2026-02-20T22:09:10.9074190Z          return hashed
2026-02-20T22:09:10.9074592Z      except Exception as password_hashing_error:
2026-02-20T22:09:10.9075477Z -        logger.error(f"Erreur lors de la génération du hash: {str(password_hashing_error)}")
2026-02-20T22:09:10.9076191Z -        raise 
2026-02-20T22:09:10.9076519Z \ No newline at end of file
2026-02-20T22:09:10.9076881Z +        logger.error(
2026-02-20T22:09:10.9077540Z +            f"Erreur lors de la génération du hash: {str(password_hashing_error)}"
2026-02-20T22:09:10.9078151Z +        )
2026-02-20T22:09:10.9078423Z +        raise
2026-02-20T22:09:10.9079064Z --- /home/runner/work/mathakine/mathakine/app/core/monitoring.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:10.9080180Z +++ /home/runner/work/mathakine/mathakine/app/core/monitoring.py	2026-02-20 22:09:10.884585+00:00
2026-02-20T22:09:10.9080949Z @@ -4,10 +4,11 @@
2026-02-20T22:09:10.9081339Z  RÉALITÉ (audit 2026-02):
2026-02-20T22:09:10.9081934Z  - sentry_sdk.init() : appelé au startup si SENTRY_DSN défini
2026-02-20T22:09:10.9082804Z  - Endpoint /metrics : exposé pour Prometheus (p50/p95/p99, taux d'erreur)
2026-02-20T22:09:10.9083711Z  - Désactivé en mode TESTING
2026-02-20T22:09:10.9084312Z  """
2026-02-20T22:09:10.9084566Z +
2026-02-20T22:09:10.9084814Z  import os
2026-02-20T22:09:10.9085097Z  import time
2026-02-20T22:09:10.9085410Z  from typing import Callable
2026-02-20T22:09:10.9085777Z  
2026-02-20T22:09:10.9086111Z  from app.core.logging_config import get_logger
2026-02-20T22:09:10.9086753Z @@ -22,10 +23,11 @@
2026-02-20T22:09:10.9087050Z          Counter,
2026-02-20T22:09:10.9087330Z          Histogram,
2026-02-20T22:09:10.9087638Z          REGISTRY,
2026-02-20T22:09:10.9087949Z          generate_latest,
2026-02-20T22:09:10.9088287Z      )
2026-02-20T22:09:10.9088537Z +
2026-02-20T22:09:10.9088827Z      _prometheus_available = True
2026-02-20T22:09:10.9089235Z  except ImportError:
2026-02-20T22:09:10.9089565Z      pass
2026-02-20T22:09:10.9089823Z  
2026-02-20T22:09:10.9090240Z  # Métriques Prometheus (créées à l'init)
2026-02-20T22:09:10.9090675Z @@ -53,11 +55,13 @@
2026-02-20T22:09:10.9090970Z      """
2026-02-20T22:09:10.9091337Z      global HTTP_REQUESTS_TOTAL, HTTP_REQUEST_DURATION
2026-02-20T22:09:10.9091854Z      initialized = False
2026-02-20T22:09:10.9092192Z  
2026-02-20T22:09:10.9092791Z      # 1. Sentry — erreurs et APM (SENTRY_DSN ou fallback NEXT_PUBLIC_SENTRY_DSN)
2026-02-20T22:09:10.9093923Z -    sentry_dsn = (os.getenv("SENTRY_DSN") or os.getenv("NEXT_PUBLIC_SENTRY_DSN") or "").strip()
2026-02-20T22:09:10.9094640Z +    sentry_dsn = (
2026-02-20T22:09:10.9095143Z +        os.getenv("SENTRY_DSN") or os.getenv("NEXT_PUBLIC_SENTRY_DSN") or ""
2026-02-20T22:09:10.9095743Z +    ).strip()
2026-02-20T22:09:10.9096157Z      testing = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:10.9096673Z  
2026-02-20T22:09:10.9096951Z      if sentry_dsn and not testing:
2026-02-20T22:09:10.9097361Z          try:
2026-02-20T22:09:10.9097660Z              import sentry_sdk
2026-02-20T22:09:10.9098021Z @@ -148,7 +152,9 @@
2026-02-20T22:09:10.9098324Z              status = 500
2026-02-20T22:09:10.9098654Z              raise
2026-02-20T22:09:10.9098974Z          finally:
2026-02-20T22:09:10.9099342Z              duration = time.perf_counter() - start
2026-02-20T22:09:10.9099907Z              if HTTP_REQUESTS_TOTAL and HTTP_REQUEST_DURATION:
2026-02-20T22:09:10.9100688Z -                HTTP_REQUESTS_TOTAL.labels(method=method, path=path, status=str(status)).inc()
2026-02-20T22:09:10.9101447Z +                HTTP_REQUESTS_TOTAL.labels(
2026-02-20T22:09:10.9101969Z +                    method=method, path=path, status=str(status)
2026-02-20T22:09:10.9102487Z +                ).inc()
2026-02-20T22:09:10.9103217Z                  HTTP_REQUEST_DURATION.labels(method=method, path=path).observe(duration)
2026-02-20T22:09:11.0077049Z --- /home/runner/work/mathakine/mathakine/app/db/base.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0082814Z +++ /home/runner/work/mathakine/mathakine/app/db/base.py	2026-02-20 22:09:11.004146+00:00
2026-02-20T22:09:11.0105424Z would reformat /home/runner/work/mathakine/mathakine/app/db/base.py
2026-02-20T22:09:11.0106047Z @@ -10,16 +10,18 @@
2026-02-20T22:09:11.0106441Z  
2026-02-20T22:09:11.0106708Z  try:
2026-02-20T22:09:11.0107522Z      # Configuration pour PostgreSQL avec pool de connexions optimisé
2026-02-20T22:09:11.0108147Z      engine = create_engine(
2026-02-20T22:09:11.0108548Z          settings.SQLALCHEMY_DATABASE_URL,
2026-02-20T22:09:11.0109574Z -        echo=settings.LOG_LEVEL == "DEBUG",  # Affiche les requêtes SQL dans les logs si niveau DEBUG
2026-02-20T22:09:11.0110400Z +        echo=settings.LOG_LEVEL
2026-02-20T22:09:11.0111141Z +        == "DEBUG",  # Affiche les requêtes SQL dans les logs si niveau DEBUG
2026-02-20T22:09:11.0112319Z          pool_pre_ping=True,  # Vérifie les connexions avant utilisation (évite les erreurs de connexion)
2026-02-20T22:09:11.0113632Z          pool_size=settings.MAX_CONNECTIONS_POOL,  # Nombre de connexions dans le pool
2026-02-20T22:09:11.0114903Z -        max_overflow=settings.MAX_CONNECTIONS_POOL * 2,  # Nombre max de connexions supplémentaires
2026-02-20T22:09:11.0115777Z +        max_overflow=settings.MAX_CONNECTIONS_POOL
2026-02-20T22:09:11.0116910Z +        * 2,  # Nombre max de connexions supplémentaires
2026-02-20T22:09:11.0117898Z          pool_recycle=settings.POOL_RECYCLE_SECONDS,  # Recycle les connexions après X secondes
2026-02-20T22:09:11.0119130Z -        pool_timeout=30  # Timeout pour obtenir une connexion du pool
2026-02-20T22:09:11.0119906Z +        pool_timeout=30,  # Timeout pour obtenir une connexion du pool
2026-02-20T22:09:11.0120485Z      )
2026-02-20T22:09:11.0121102Z      logger.success("Moteur SQLAlchemy (PostgreSQL) créé avec succès")
2026-02-20T22:09:11.0121733Z  except Exception as e:
2026-02-20T22:09:11.0122317Z      logger.error(f"Erreur lors de l'initialisation du moteur SQLAlchemy: {e}")
2026-02-20T22:09:11.0123166Z      raise
2026-02-20T22:09:11.0123462Z @@ -27,10 +29,11 @@
2026-02-20T22:09:11.0124013Z  SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
2026-02-20T22:09:11.0124885Z  logger.debug("Session SQLAlchemy configurée")
2026-02-20T22:09:11.0125373Z  
2026-02-20T22:09:11.0125676Z  Base = declarative_base()
2026-02-20T22:09:11.0126223Z  logger.debug("Base déclarative configurée")
2026-02-20T22:09:11.0126675Z +
2026-02-20T22:09:11.0126921Z  
2026-02-20T22:09:11.0127369Z  # Helper pour obtenir une session de base de données
2026-02-20T22:09:11.0127888Z  def get_db():
2026-02-20T22:09:11.0128671Z      """Générateur pour obtenir une session de base de données avec nettoyage automatique."""
2026-02-20T22:09:11.0129739Z      logger.debug("Ouverture d'une nouvelle session de base de données")
2026-02-20T22:09:11.0510721Z --- /home/runner/work/mathakine/mathakine/app/core/constants.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0511871Z +++ /home/runner/work/mathakine/mathakine/app/core/constants.py	2026-02-20 22:09:11.044988+00:00
2026-02-20T22:09:11.0512614Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.0512900Z  """
2026-02-20T22:09:11.0513725Z  Constants centralisées pour l'application Mathakine
2026-02-20T22:09:11.0514564Z  Ce fichier contient toutes les constantes utilisées dans l'application.
2026-02-20T22:09:11.0515227Z  """
2026-02-20T22:09:11.0515478Z +
2026-02-20T22:09:11.0515818Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.0516443Z  from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:11.0517074Z  from app.models.logic_challenge import AgeGroup
2026-02-20T22:09:11.0517539Z  
2026-02-20T22:09:11.0517824Z  logger = get_logger(__name__)
2026-02-20T22:09:11.0518196Z @@ -20,44 +21,85 @@
2026-02-20T22:09:11.0518565Z      GEOMETRIE = ExerciseType.GEOMETRIE.value
2026-02-20T22:09:11.0519042Z      TEXTE = ExerciseType.TEXTE.value
2026-02-20T22:09:11.0519457Z      MIXTE = ExerciseType.MIXTE.value
2026-02-20T22:09:11.0520130Z      MIXED = ExerciseType.MIXTE.value  # Alias pour compatibilité
2026-02-20T22:09:11.0520725Z      DIVERS = ExerciseType.DIVERS.value
2026-02-20T22:09:11.0521150Z -    
2026-02-20T22:09:11.0521859Z -    ALL_TYPES = [ADDITION, SUBTRACTION, MULTIPLICATION, DIVISION, FRACTIONS, GEOMETRIE, TEXTE, MIXTE, DIVERS]
2026-02-20T22:09:11.0522723Z -    
2026-02-20T22:09:11.0523177Z +
2026-02-20T22:09:11.0523446Z +    ALL_TYPES = [
2026-02-20T22:09:11.0523752Z +        ADDITION,
2026-02-20T22:09:11.0524050Z +        SUBTRACTION,
2026-02-20T22:09:11.0524403Z +        MULTIPLICATION,
2026-02-20T22:09:11.0524744Z +        DIVISION,
2026-02-20T22:09:11.0525051Z +        FRACTIONS,
2026-02-20T22:09:11.0525742Z would reformat /home/runner/work/mathakine/mathakine/app/core/constants.py
2026-02-20T22:09:11.0526388Z +        GEOMETRIE,
2026-02-20T22:09:11.0526680Z +        TEXTE,
2026-02-20T22:09:11.0526953Z +        MIXTE,
2026-02-20T22:09:11.0527229Z +        DIVERS,
2026-02-20T22:09:11.0527502Z +    ]
2026-02-20T22:09:11.0527752Z +
2026-02-20T22:09:11.0528055Z      # Mapping pour la normalisation des types
2026-02-20T22:09:11.0528523Z      TYPE_ALIASES = {
2026-02-20T22:09:11.0528952Z          ADDITION: [ADDITION, "addition", "add", "+", "plus"],
2026-02-20T22:09:11.0529724Z          SUBTRACTION: [SUBTRACTION, "soustraction", "subtract", "sub", "-", "minus"],
2026-02-20T22:09:11.0531252Z -        MULTIPLICATION: [MULTIPLICATION, "multiplication", "multiply", "mult", "times", "*", "×"],
2026-02-20T22:09:11.0532051Z +        MULTIPLICATION: [
2026-02-20T22:09:11.0532428Z +            MULTIPLICATION,
2026-02-20T22:09:11.0534867Z +            "multiplication",
2026-02-20T22:09:11.0535331Z +            "multiply",
2026-02-20T22:09:11.0535673Z +            "mult",
2026-02-20T22:09:11.0535996Z +            "times",
2026-02-20T22:09:11.0536298Z +            "*",
2026-02-20T22:09:11.0536675Z +            "×",
2026-02-20T22:09:11.0536968Z +        ],
2026-02-20T22:09:11.0537500Z          DIVISION: [DIVISION, "division", "divide", "div", "/", "÷"],
2026-02-20T22:09:11.0538197Z          FRACTIONS: [FRACTIONS, "fractions", "fraction", "frac"],
2026-02-20T22:09:11.0538853Z          GEOMETRIE: [GEOMETRIE, "geometrie", "geometry", "geo"],
2026-02-20T22:09:11.0539430Z          TEXTE: [TEXTE, "texte", "text", "question"],
2026-02-20T22:09:11.0540152Z          MIXTE: [MIXTE, "mixte", "mixed", "combiné", "combine"],
2026-02-20T22:09:11.0540739Z -        DIVERS: [DIVERS, "divers", "misc", "other"]
2026-02-20T22:09:11.0541275Z +        DIVERS: [DIVERS, "divers", "misc", "other"],
2026-02-20T22:09:11.0541731Z      }
2026-02-20T22:09:11.0542009Z +
2026-02-20T22:09:11.0542249Z  
2026-02-20T22:09:11.0542802Z  # Niveaux de difficulté - compatible avec l'enum DifficultyLevel
2026-02-20T22:09:11.0543643Z  class DifficultyLevels:
2026-02-20T22:09:11.0544064Z      INITIE = DifficultyLevel.INITIE.value
2026-02-20T22:09:11.0544565Z      PADAWAN = DifficultyLevel.PADAWAN.value
2026-02-20T22:09:11.0545116Z      CHEVALIER = DifficultyLevel.CHEVALIER.value
2026-02-20T22:09:11.0545635Z      MAITRE = DifficultyLevel.MAITRE.value
2026-02-20T22:09:11.0546170Z      GRAND_MAITRE = DifficultyLevel.GRAND_MAITRE.value
2026-02-20T22:09:11.0546739Z -    
2026-02-20T22:09:11.0547006Z +
2026-02-20T22:09:11.0547419Z      ALL_LEVELS = [INITIE, PADAWAN, CHEVALIER, MAITRE, GRAND_MAITRE]
2026-02-20T22:09:11.0547999Z -    
2026-02-20T22:09:11.0548261Z +
2026-02-20T22:09:11.0548577Z      # Mapping pour la normalisation des niveaux
2026-02-20T22:09:11.0549052Z      LEVEL_ALIASES = {
2026-02-20T22:09:11.0549768Z          INITIE: [INITIE, "initié", "initie", "easy", "facile", "debutant", "débutant"],
2026-02-20T22:09:11.0550857Z -        PADAWAN: [PADAWAN, "padawan", "medium", "moyen", "intermediaire", "intermédiaire"],
2026-02-20T22:09:11.0551568Z +        PADAWAN: [
2026-02-20T22:09:11.0551879Z +            PADAWAN,
2026-02-20T22:09:11.0552200Z +            "padawan",
2026-02-20T22:09:11.0552516Z +            "medium",
2026-02-20T22:09:11.0552828Z +            "moyen",
2026-02-20T22:09:11.0553448Z +            "intermediaire",
2026-02-20T22:09:11.0553936Z +            "intermédiaire",
2026-02-20T22:09:11.0554292Z +        ],
2026-02-20T22:09:11.0554935Z          CHEVALIER: [CHEVALIER, "chevalier", "hard", "difficile", "avance", "avancé"],
2026-02-20T22:09:11.0556022Z -        MAITRE: [MAITRE, "maitre", "maître", "expert", "très difficile", "tres difficile"],
2026-02-20T22:09:11.0557208Z -        GRAND_MAITRE: [GRAND_MAITRE, "grand maitre", "grand maître", "grandmaitre", "master", "adulte"]
2026-02-20T22:09:11.0557971Z +        MAITRE: [
2026-02-20T22:09:11.0558298Z +            MAITRE,
2026-02-20T22:09:11.0558619Z +            "maitre",
2026-02-20T22:09:11.0558969Z +            "maître",
2026-02-20T22:09:11.0559269Z +            "expert",
2026-02-20T22:09:11.0559671Z +            "très difficile",
2026-02-20T22:09:11.0560039Z +            "tres difficile",
2026-02-20T22:09:11.0560375Z +        ],
2026-02-20T22:09:11.0560655Z +        GRAND_MAITRE: [
2026-02-20T22:09:11.0560992Z +            GRAND_MAITRE,
2026-02-20T22:09:11.0561330Z +            "grand maitre",
2026-02-20T22:09:11.0561738Z +            "grand maître",
2026-02-20T22:09:11.0562081Z +            "grandmaitre",
2026-02-20T22:09:11.0562420Z +            "master",
2026-02-20T22:09:11.0562714Z +            "adulte",
2026-02-20T22:09:11.0563509Z +        ],
2026-02-20T22:09:11.0563766Z      }
2026-02-20T22:09:11.0564020Z +
2026-02-20T22:09:11.0564253Z  
2026-02-20T22:09:11.0564622Z  # Groupes d'âge pour les exercices
2026-02-20T22:09:11.0565646Z  # NOMENCLATURE OFFICIELLE : alignée avec le système scolaire français et le frontend
2026-02-20T22:09:11.0566372Z  # - 6-8 ans : CP-CE2 (cycle 2)
2026-02-20T22:09:11.0566931Z  # - 9-11 ans : CM1-CM2-6e (fin cycle 2, début cycle 3)
2026-02-20T22:09:11.0567396Z @@ -68,63 +110,116 @@
2026-02-20T22:09:11.0567715Z      GROUP_9_11 = "9-11"
2026-02-20T22:09:11.0568044Z      GROUP_12_14 = "12-14"
2026-02-20T22:09:11.0568386Z      GROUP_15_17 = "15-17"
2026-02-20T22:09:11.0568712Z      ADULT = "adulte"
2026-02-20T22:09:11.0569033Z      ALL_AGES = "tous-ages"
2026-02-20T22:09:11.0569358Z -    
2026-02-20T22:09:11.0569608Z +
2026-02-20T22:09:11.0570068Z      ALL_GROUPS = [GROUP_6_8, GROUP_9_11, GROUP_12_14, GROUP_15_17, ADULT, ALL_AGES]
2026-02-20T22:09:11.0570661Z -    
2026-02-20T22:09:11.0570925Z +
2026-02-20T22:09:11.0571362Z      # Mapping pour la normalisation des groupes d'âge
2026-02-20T22:09:11.0572157Z      # Inclut tous les formats possibles du frontend et de l'API (age_*, GROUP_* pour challenges)
2026-02-20T22:09:11.0572877Z      AGE_ALIASES = {
2026-02-20T22:09:11.0573677Z -        GROUP_6_8: ["6-8", "6-8 ans", "6 to 8 ans", "6_8", "group_6_8", "GROUP_6_8", "age_6_8", "6-8ans"],
2026-02-20T22:09:11.0574796Z -        GROUP_9_11: ["9-11", "9-11 ans", "9 to 11 ans", "9_11", "group_9_11", "GROUP_9_12", "GROUP_10_12", "age_9_12", "age_10_12", "9-11ans", "10-12"],
2026-02-20T22:09:11.0576012Z -        GROUP_12_14: ["12-14", "12-14 ans", "12 to 14 ans", "12_14", "group_12_14", "GROUP_13_15", "age_13_15", "12-14ans", "13-15"],
2026-02-20T22:09:11.0577162Z -        GROUP_15_17: ["15-17", "15-17 ans", "15 to 17 ans", "15_17", "group_15_17", "GROUP_16_18", "GROUP_15_17", "age_16_18", "15-17ans"],
2026-02-20T22:09:11.0577948Z +        GROUP_6_8: [
2026-02-20T22:09:11.0578257Z +            "6-8",
2026-02-20T22:09:11.0578557Z +            "6-8 ans",
2026-02-20T22:09:11.0578876Z +            "6 to 8 ans",
2026-02-20T22:09:11.0579197Z +            "6_8",
2026-02-20T22:09:11.0579488Z +            "group_6_8",
2026-02-20T22:09:11.0579822Z +            "GROUP_6_8",
2026-02-20T22:09:11.0580142Z +            "age_6_8",
2026-02-20T22:09:11.0580454Z +            "6-8ans",
2026-02-20T22:09:11.0580750Z +        ],
2026-02-20T22:09:11.0581024Z +        GROUP_9_11: [
2026-02-20T22:09:11.0581320Z +            "9-11",
2026-02-20T22:09:11.0581620Z +            "9-11 ans",
2026-02-20T22:09:11.0581933Z +            "9 to 11 ans",
2026-02-20T22:09:11.0582261Z +            "9_11",
2026-02-20T22:09:11.0582559Z +            "group_9_11",
2026-02-20T22:09:11.0582884Z +            "GROUP_9_12",
2026-02-20T22:09:11.0583388Z +            "GROUP_10_12",
2026-02-20T22:09:11.0583719Z +            "age_9_12",
2026-02-20T22:09:11.0584048Z +            "age_10_12",
2026-02-20T22:09:11.0584364Z +            "9-11ans",
2026-02-20T22:09:11.0584685Z +            "10-12",
2026-02-20T22:09:11.0584971Z +        ],
2026-02-20T22:09:11.0585243Z +        GROUP_12_14: [
2026-02-20T22:09:11.0585544Z +            "12-14",
2026-02-20T22:09:11.0585844Z +            "12-14 ans",
2026-02-20T22:09:11.0586174Z +            "12 to 14 ans",
2026-02-20T22:09:11.0586508Z +            "12_14",
2026-02-20T22:09:11.0586816Z +            "group_12_14",
2026-02-20T22:09:11.0587146Z +            "GROUP_13_15",
2026-02-20T22:09:11.0587480Z +            "age_13_15",
2026-02-20T22:09:11.0587794Z +            "12-14ans",
2026-02-20T22:09:11.0588113Z +            "13-15",
2026-02-20T22:09:11.0588396Z +        ],
2026-02-20T22:09:11.0588669Z +        GROUP_15_17: [
2026-02-20T22:09:11.0588977Z +            "15-17",
2026-02-20T22:09:11.0589276Z +            "15-17 ans",
2026-02-20T22:09:11.0589594Z +            "15 to 17 ans",
2026-02-20T22:09:11.0589928Z +            "15_17",
2026-02-20T22:09:11.0590234Z +            "group_15_17",
2026-02-20T22:09:11.0590829Z +            "GROUP_16_18",
2026-02-20T22:09:11.0591178Z +            "GROUP_15_17",
2026-02-20T22:09:11.0591505Z +            "age_16_18",
2026-02-20T22:09:11.0591829Z +            "15-17ans",
2026-02-20T22:09:11.0592130Z +        ],
2026-02-20T22:09:11.0592718Z          ADULT: ["adulte", "adultes", "adult", "adults", "18+", "majeur"],
2026-02-20T22:09:11.0593857Z -        ALL_AGES: ["tous-ages", "tous ages", "all ages", "all", "tous", "all_ages", "tousages"],
2026-02-20T22:09:11.0594514Z +        ALL_AGES: [
2026-02-20T22:09:11.0594866Z +            "tous-ages",
2026-02-20T22:09:11.0595219Z +            "tous ages",
2026-02-20T22:09:11.0595569Z +            "all ages",
2026-02-20T22:09:11.0595886Z +            "all",
2026-02-20T22:09:11.0596203Z +            "tous",
2026-02-20T22:09:11.0596520Z +            "all_ages",
2026-02-20T22:09:11.0596876Z +            "tousages",
2026-02-20T22:09:11.0597196Z +        ],
2026-02-20T22:09:11.0597465Z      }
2026-02-20T22:09:11.0597718Z  
2026-02-20T22:09:11.0597990Z +
2026-02-20T22:09:11.0598284Z  def normalize_age_group(age_group):
2026-02-20T22:09:11.0598710Z      """
2026-02-20T22:09:11.0599381Z      Normalise le groupe d'âge vers le format standard (6-8, 9-11, etc.)
2026-02-20T22:09:11.0599992Z -    
2026-02-20T22:09:11.0600276Z +
2026-02-20T22:09:11.0600533Z      Args:
2026-02-20T22:09:11.0601222Z          age_group: Le groupe d'âge en entrée (peut être dans différents formats)
2026-02-20T22:09:11.0601878Z -        
2026-02-20T22:09:11.0602160Z +
2026-02-20T22:09:11.0602417Z      Returns:
2026-02-20T22:09:11.0603186Z          Le groupe d'âge normalisé (ex: "6-8", "9-11", etc.)
2026-02-20T22:09:11.0603723Z      """
2026-02-20T22:09:11.0604018Z      if not age_group:
2026-02-20T22:09:11.0604726Z          return AgeGroups.GROUP_9_11  # Défaut : 9-11 ans (milieu de gamme)
2026-02-20T22:09:11.0605333Z  
2026-02-20T22:09:11.0605682Z      age_group_str = str(age_group).lower().strip()
2026-02-20T22:09:11.0606166Z -    
2026-02-20T22:09:11.0606440Z +
2026-02-20T22:09:11.0606924Z      # Nettoyer les espaces et caractères spéciaux
2026-02-20T22:09:11.0607591Z -    age_group_clean = age_group_str.replace(' ', '').replace('_', '-')
2026-02-20T22:09:11.0608347Z +    age_group_clean = age_group_str.replace(" ", "").replace("_", "-")
2026-02-20T22:09:11.0608931Z  
2026-02-20T22:09:11.0609446Z      # Parcourir tous les groupes d'âge et leurs alias
2026-02-20T22:09:11.0610093Z      for group_key, aliases in AgeGroups.AGE_ALIASES.items():
2026-02-20T22:09:11.0610864Z          # Vérifier correspondance exacte ou nettoyée
2026-02-20T22:09:11.0611370Z          for alias in aliases:
2026-02-20T22:09:11.0611916Z -            alias_clean = alias.lower().replace(' ', '').replace('_', '-')
2026-02-20T22:09:11.0612658Z +            alias_clean = alias.lower().replace(" ", "").replace("_", "-")
2026-02-20T22:09:11.0613652Z              if age_group_clean == alias_clean or age_group_str == alias.lower():
2026-02-20T22:09:11.0614305Z                  return group_key
2026-02-20T22:09:11.0614709Z -    
2026-02-20T22:09:11.0614979Z +
2026-02-20T22:09:11.0615534Z      # Tentative de correspondance partielle (ex: "9" → "9-11")
2026-02-20T22:09:11.0616165Z      for group_key in AgeGroups.ALL_GROUPS:
2026-02-20T22:09:11.0616773Z -        if group_key.startswith(age_group_clean.split('-')[0] + '-'):
2026-02-20T22:09:11.0617522Z +        if group_key.startswith(age_group_clean.split("-")[0] + "-"):
2026-02-20T22:09:11.0618098Z              return group_key
2026-02-20T22:09:11.0618457Z -    
2026-02-20T22:09:11.0618743Z +
2026-02-20T22:09:11.0619357Z      # Si aucune correspondance trouvée, retourner le groupe par défaut
2026-02-20T22:09:11.0620602Z -    logger.warning(f"Groupe d'âge non reconnu: '{age_group}', utilisation de {AgeGroups.GROUP_9_11} par défaut")
2026-02-20T22:09:11.0621458Z +    logger.warning(
2026-02-20T22:09:11.0622246Z +        f"Groupe d'âge non reconnu: '{age_group}', utilisation de {AgeGroups.GROUP_9_11} par défaut"
2026-02-20T22:09:11.0623200Z +    )
2026-02-20T22:09:11.0623650Z      return AgeGroups.GROUP_9_11
2026-02-20T22:09:11.0624354Z  
2026-02-20T22:09:11.0624624Z +
2026-02-20T22:09:11.0624996Z  def get_difficulty_from_age_group(age_group: str) -> str:
2026-02-20T22:09:11.0625512Z      """
2026-02-20T22:09:11.0626480Z      Détermine le niveau de difficulté (INITIE, PADAWAN, ...) à partir du groupe d'âge.
2026-02-20T22:09:11.0627227Z -    
2026-02-20T22:09:11.0627509Z +
2026-02-20T22:09:11.0627775Z      Mapping :
2026-02-20T22:09:11.0628241Z      - 6-8 ans → INITIE (débutant)
2026-02-20T22:09:11.0628795Z      - 9-11 ans → PADAWAN (intermédiaire)
2026-02-20T22:09:11.0629378Z      - 12-14 ans → CHEVALIER (avancé)
2026-02-20T22:09:11.0629888Z      - 15-17 ans → MAITRE (expert)
2026-02-20T22:09:11.0630283Z @@ -141,19 +236,21 @@
2026-02-20T22:09:11.0630648Z          return DifficultyLevels.MAITRE
2026-02-20T22:09:11.0631101Z      elif age_group == AgeGroups.ADULT:
2026-02-20T22:09:11.0631583Z          return DifficultyLevels.GRAND_MAITRE
2026-02-20T22:09:11.0632027Z      else:
2026-02-20T22:09:11.0632604Z          # Valeur par défaut si le groupe d'âge n'est pas reconnu
2026-02-20T22:09:11.0634038Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut")
2026-02-20T22:09:11.0634962Z +        logger.info(
2026-02-20T22:09:11.0635927Z +            f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut"
2026-02-20T22:09:11.0636749Z +        )
2026-02-20T22:09:11.0637100Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:11.0637537Z  
2026-02-20T22:09:11.0637796Z  
2026-02-20T22:09:11.0638232Z  def calculate_difficulty_for_age_group(age_group: str) -> float:
2026-02-20T22:09:11.0638808Z      """
2026-02-20T22:09:11.0639517Z      Calcule une note de difficulté numérique (1.0 à 5.0) à partir du groupe d'âge.
2026-02-20T22:09:11.0640583Z      Utilisée pour les challenges qui ont un rating de difficulté numérique.
2026-02-20T22:09:11.0641225Z -    
2026-02-20T22:09:11.0641485Z +
2026-02-20T22:09:11.0641778Z      Mapping :
2026-02-20T22:09:11.0642185Z      - 6-8 ans → 1.5 (facile)
2026-02-20T22:09:11.0642653Z      - 9-11 ans → 2.5 (moyen)
2026-02-20T22:09:11.0643340Z      - 12-14 ans → 3.5 (difficile)
2026-02-20T22:09:11.0643862Z      - 15-17 ans → 4.0 (expert)
2026-02-20T22:09:11.0644328Z @@ -168,29 +265,45 @@
2026-02-20T22:09:11.0644707Z          AgeGroups.ADULT: 4.5,
2026-02-20T22:09:11.0645117Z          AgeGroups.ALL_AGES: 2.5,
2026-02-20T22:09:11.0645598Z      }
2026-02-20T22:09:11.0645966Z      return difficulty_mapping.get(age_group, 2.5)
2026-02-20T22:09:11.0646418Z  
2026-02-20T22:09:11.0646674Z +
2026-02-20T22:09:11.0647055Z  # Rôles d'utilisateurs
2026-02-20T22:09:11.0647411Z  class UserRoles:
2026-02-20T22:09:11.0648112Z      INITIE = "initie"  # Alias pour compatibilité (niveau utilisateur, pas rôle)
2026-02-20T22:09:11.0648785Z      PADAWAN = "padawan"
2026-02-20T22:09:11.0649166Z      CHEVALIER = "chevalier"
2026-02-20T22:09:11.0649558Z      MAITRE = "maitre"
2026-02-20T22:09:11.0649925Z      GARDIEN = "gardien"
2026-02-20T22:09:11.0650310Z      ARCHIVISTE = "archiviste"
2026-02-20T22:09:11.0650689Z -    
2026-02-20T22:09:11.0650956Z +
2026-02-20T22:09:11.0651394Z      ALL_ROLES = [PADAWAN, CHEVALIER, MAITRE, GARDIEN, ARCHIVISTE]
2026-02-20T22:09:11.0651944Z -    
2026-02-20T22:09:11.0652210Z +
2026-02-20T22:09:11.0652714Z      # Mapping des permissions par rôle (hiérarchique)
2026-02-20T22:09:11.0653473Z      ROLE_PERMISSIONS = {
2026-02-20T22:09:11.0653849Z          PADAWAN: ["view_own"],
2026-02-20T22:09:11.0654307Z          CHEVALIER: ["view_own", "create_exercises"],
2026-02-20T22:09:11.0654900Z          MAITRE: ["view_own", "create_exercises", "modify_own"],
2026-02-20T22:09:11.0655680Z -        GARDIEN: ["view_own", "view_all", "create_exercises", "modify_own", "modify_all"],
2026-02-20T22:09:11.0656734Z -        ARCHIVISTE: ["view_own", "view_all", "create_exercises", "modify_own", "modify_all", "delete", "admin"]
2026-02-20T22:09:11.0657561Z +        GARDIEN: [
2026-02-20T22:09:11.0658198Z +            "view_own",
2026-02-20T22:09:11.0658555Z +            "view_all",
2026-02-20T22:09:11.0658927Z +            "create_exercises",
2026-02-20T22:09:11.0659321Z +            "modify_own",
2026-02-20T22:09:11.0659681Z +            "modify_all",
2026-02-20T22:09:11.0660022Z +        ],
2026-02-20T22:09:11.0660540Z +        ARCHIVISTE: [
2026-02-20T22:09:11.0660928Z +            "view_own",
2026-02-20T22:09:11.0661284Z +            "view_all",
2026-02-20T22:09:11.0661645Z +            "create_exercises",
2026-02-20T22:09:11.0662028Z +            "modify_own",
2026-02-20T22:09:11.0662386Z +            "modify_all",
2026-02-20T22:09:11.0662734Z +            "delete",
2026-02-20T22:09:11.0663274Z +            "admin",
2026-02-20T22:09:11.0663587Z +        ],
2026-02-20T22:09:11.0663864Z      }
2026-02-20T22:09:11.0664124Z +
2026-02-20T22:09:11.0664373Z  
2026-02-20T22:09:11.0664700Z  # Noms d'affichage pour les types et niveaux
2026-02-20T22:09:11.0665159Z  DISPLAY_NAMES = {
2026-02-20T22:09:11.0665506Z      # Types d'exercices
2026-02-20T22:09:11.0665906Z      ExerciseTypes.ADDITION: "Addition",
2026-02-20T22:09:11.0666371Z @@ -200,62 +313,97 @@
2026-02-20T22:09:11.0666759Z      ExerciseTypes.FRACTIONS: "Fractions",
2026-02-20T22:09:11.0667401Z      ExerciseTypes.GEOMETRIE: "Géométrie",
2026-02-20T22:09:11.0667954Z      ExerciseTypes.TEXTE: "Question textuelle",
2026-02-20T22:09:11.0668489Z      ExerciseTypes.MIXTE: "Exercice mixte",
2026-02-20T22:09:11.0668950Z      ExerciseTypes.DIVERS: "Divers",
2026-02-20T22:09:11.0669334Z -    
2026-02-20T22:09:11.0669698Z      # Niveaux de difficulté
2026-02-20T22:09:11.0670208Z      DifficultyLevels.INITIE: "Initié",
2026-02-20T22:09:11.0670719Z      DifficultyLevels.PADAWAN: "Padawan",
2026-02-20T22:09:11.0671239Z      DifficultyLevels.CHEVALIER: "Chevalier",
2026-02-20T22:09:11.0671860Z      DifficultyLevels.MAITRE: "Maître",
2026-02-20T22:09:11.0672518Z -    DifficultyLevels.GRAND_MAITRE: "Grand Maître"
2026-02-20T22:09:11.0673455Z +    DifficultyLevels.GRAND_MAITRE: "Grand Maître",
2026-02-20T22:09:11.0673972Z  }
2026-02-20T22:09:11.0674239Z  
2026-02-20T22:09:11.0674767Z  # Limites numériques par difficulté et type d'exercice
2026-02-20T22:09:11.0675307Z  DIFFICULTY_LIMITS = {
2026-02-20T22:09:11.0675696Z      DifficultyLevels.INITIE: {
2026-02-20T22:09:11.0676198Z          ExerciseTypes.ADDITION: {"min": 1, "max": 10},
2026-02-20T22:09:11.0676931Z          ExerciseTypes.SUBTRACTION: {"min1": 5, "max1": 20, "min2": 1, "max2": 5},
2026-02-20T22:09:11.0677715Z          ExerciseTypes.MULTIPLICATION: {"min": 1, "max": 5},
2026-02-20T22:09:11.0678585Z -        ExerciseTypes.DIVISION: {"min_divisor": 2, "max_divisor": 5, "min_result": 1, "max_result": 5},
2026-02-20T22:09:11.0679416Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0679849Z +            "min_divisor": 2,
2026-02-20T22:09:11.0680240Z +            "max_divisor": 5,
2026-02-20T22:09:11.0680621Z +            "min_result": 1,
2026-02-20T22:09:11.0681007Z +            "max_result": 5,
2026-02-20T22:09:11.0681390Z +        },
2026-02-20T22:09:11.0681862Z          ExerciseTypes.MIXTE: {"min": 1, "max": 10, "operations": 2},
2026-02-20T22:09:11.0682480Z -        "default": {"min": 1, "max": 10}
2026-02-20T22:09:11.0682941Z +        "default": {"min": 1, "max": 10},
2026-02-20T22:09:11.0683561Z      },
2026-02-20T22:09:11.0683881Z      DifficultyLevels.PADAWAN: {
2026-02-20T22:09:11.0684390Z          ExerciseTypes.ADDITION: {"min": 10, "max": 50},
2026-02-20T22:09:11.0685125Z          ExerciseTypes.SUBTRACTION: {"min1": 20, "max1": 70, "min2": 10, "max2": 20},
2026-02-20T22:09:11.0685934Z          ExerciseTypes.MULTIPLICATION: {"min": 5, "max": 10},
2026-02-20T22:09:11.0686824Z -        ExerciseTypes.DIVISION: {"min_divisor": 2, "max_divisor": 10, "min_result": 5, "max_result": 10},
2026-02-20T22:09:11.0687657Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0688098Z +            "min_divisor": 2,
2026-02-20T22:09:11.0688507Z +            "max_divisor": 10,
2026-02-20T22:09:11.0688915Z +            "min_result": 5,
2026-02-20T22:09:11.0689600Z +            "max_result": 10,
2026-02-20T22:09:11.0689967Z +        },
2026-02-20T22:09:11.0690415Z          ExerciseTypes.MIXTE: {"min": 5, "max": 20, "operations": 2},
2026-02-20T22:09:11.0691042Z -        "default": {"min": 10, "max": 50}
2026-02-20T22:09:11.0691731Z +        "default": {"min": 10, "max": 50},
2026-02-20T22:09:11.0692193Z      },
2026-02-20T22:09:11.0692512Z      DifficultyLevels.CHEVALIER: {
2026-02-20T22:09:11.0693224Z          ExerciseTypes.ADDITION: {"min": 50, "max": 200},
2026-02-20T22:09:11.0693990Z          ExerciseTypes.SUBTRACTION: {"min1": 100, "max1": 250, "min2": 50, "max2": 100},
2026-02-20T22:09:11.0694815Z          ExerciseTypes.MULTIPLICATION: {"min": 10, "max": 20},
2026-02-20T22:09:11.0695729Z -        ExerciseTypes.DIVISION: {"min_divisor": 5, "max_divisor": 15, "min_result": 8, "max_result": 20},
2026-02-20T22:09:11.0696566Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0697012Z +            "min_divisor": 5,
2026-02-20T22:09:11.0697414Z +            "max_divisor": 15,
2026-02-20T22:09:11.0697813Z +            "min_result": 8,
2026-02-20T22:09:11.0698206Z +            "max_result": 20,
2026-02-20T22:09:11.0698567Z +        },
2026-02-20T22:09:11.0699039Z          ExerciseTypes.MIXTE: {"min": 10, "max": 50, "operations": 3},
2026-02-20T22:09:11.0699663Z -        "default": {"min": 50, "max": 200}
2026-02-20T22:09:11.0700126Z +        "default": {"min": 50, "max": 200},
2026-02-20T22:09:11.0700552Z      },
2026-02-20T22:09:11.0700878Z      DifficultyLevels.MAITRE: {
2026-02-20T22:09:11.0701372Z          ExerciseTypes.ADDITION: {"min": 200, "max": 1000},
2026-02-20T22:09:11.0702154Z -        ExerciseTypes.SUBTRACTION: {"min1": 250, "max1": 1000, "min2": 100, "max2": 500},
2026-02-20T22:09:11.0702916Z +        ExerciseTypes.SUBTRACTION: {
2026-02-20T22:09:11.0703554Z +            "min1": 250,
2026-02-20T22:09:11.0703925Z +            "max1": 1000,
2026-02-20T22:09:11.0704277Z +            "min2": 100,
2026-02-20T22:09:11.0704644Z +            "max2": 500,
2026-02-20T22:09:11.0706255Z +        },
2026-02-20T22:09:11.0706689Z          ExerciseTypes.MULTIPLICATION: {"min": 20, "max": 50},
2026-02-20T22:09:11.0707605Z -        ExerciseTypes.DIVISION: {"min_divisor": 10, "max_divisor": 30, "min_result": 10, "max_result": 50},
2026-02-20T22:09:11.0719373Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0719867Z +            "min_divisor": 10,
2026-02-20T22:09:11.0720273Z +            "max_divisor": 30,
2026-02-20T22:09:11.0720665Z +            "min_result": 10,
2026-02-20T22:09:11.0721054Z +            "max_result": 50,
2026-02-20T22:09:11.0721414Z +        },
2026-02-20T22:09:11.0725744Z          ExerciseTypes.MIXTE: {"min": 20, "max": 100, "operations": 4},
2026-02-20T22:09:11.0726467Z -        "default": {"min": 200, "max": 1000}
2026-02-20T22:09:11.0726960Z +        "default": {"min": 200, "max": 1000},
2026-02-20T22:09:11.0727400Z      },
2026-02-20T22:09:11.0727729Z      DifficultyLevels.GRAND_MAITRE: {
2026-02-20T22:09:11.0728308Z          ExerciseTypes.ADDITION: {"min": 1000, "max": 10000},
2026-02-20T22:09:11.0729135Z -        ExerciseTypes.SUBTRACTION: {"min1": 1000, "max1": 10000, "min2": 500, "max2": 5000},
2026-02-20T22:09:11.0729911Z +        ExerciseTypes.SUBTRACTION: {
2026-02-20T22:09:11.0730357Z +            "min1": 1000,
2026-02-20T22:09:11.0730719Z +            "max1": 10000,
2026-02-20T22:09:11.0731089Z +            "min2": 500,
2026-02-20T22:09:11.0731430Z +            "max2": 5000,
2026-02-20T22:09:11.0731774Z +        },
2026-02-20T22:09:11.0732211Z          ExerciseTypes.MULTIPLICATION: {"min": 50, "max": 200},
2026-02-20T22:09:11.0733363Z -        ExerciseTypes.DIVISION: {"min_divisor": 20, "max_divisor": 100, "min_result": 50, "max_result": 200},
2026-02-20T22:09:11.0734264Z +        ExerciseTypes.DIVISION: {
2026-02-20T22:09:11.0734706Z +            "min_divisor": 20,
2026-02-20T22:09:11.0735118Z +            "max_divisor": 100,
2026-02-20T22:09:11.0735524Z +            "min_result": 50,
2026-02-20T22:09:11.0736207Z +            "max_result": 200,
2026-02-20T22:09:11.0736574Z +        },
2026-02-20T22:09:11.0737051Z          ExerciseTypes.MIXTE: {"min": 100, "max": 1000, "operations": 5},
2026-02-20T22:09:11.0737721Z -        "default": {"min": 1000, "max": 10000}
2026-02-20T22:09:11.0738171Z -    }
2026-02-20T22:09:11.0738715Z +        "default": {"min": 1000, "max": 10000},
2026-02-20T22:09:11.0739181Z +    },
2026-02-20T22:09:11.0739478Z  }
2026-02-20T22:09:11.0739730Z +
2026-02-20T22:09:11.0739988Z  
2026-02-20T22:09:11.0740274Z  # Tags pour les exercices
2026-02-20T22:09:11.0740645Z  class Tags:
2026-02-20T22:09:11.0740968Z      ALGORITHMIC = "algorithmique"
2026-02-20T22:09:11.0741374Z      AI = "ia"
2026-02-20T22:09:11.0741673Z @@ -267,35 +415,40 @@
2026-02-20T22:09:11.0742030Z      FRACTIONS = "fractions"
2026-02-20T22:09:11.0742422Z      GEOMETRY = "geometrie"
2026-02-20T22:09:11.0742793Z      LOGIC = "logique"
2026-02-20T22:09:11.0743401Z      PROBLEM_SOLVING = "resolution-probleme"
2026-02-20T22:09:11.0743857Z  
2026-02-20T22:09:11.0744115Z +
2026-02-20T22:09:11.0744684Z  # Messages et préfixes spécifiques
2026-02-20T22:09:11.0745142Z  class Messages:
2026-02-20T22:09:11.0745497Z      AI_EXERCISE_PREFIX = "TEST-ZAXXON"
2026-02-20T22:09:11.0746003Z      DEFAULT_ERROR = "Une erreur est survenue."
2026-02-20T22:09:11.0746650Z      DEFAULT_SUCCESS = "Opération réussie."
2026-02-20T22:09:11.0747104Z  
2026-02-20T22:09:11.0747367Z +
2026-02-20T22:09:11.0747783Z  # Paramètres de pagination
2026-02-20T22:09:11.0748184Z  class PaginationConfig:
2026-02-20T22:09:11.0748556Z      DEFAULT_PAGE_SIZE = 10
2026-02-20T22:09:11.0748910Z      MAX_PAGE_SIZE = 50
2026-02-20T22:09:11.0749256Z      DEFAULT_PAGE = 1
2026-02-20T22:09:11.0749592Z +
2026-02-20T22:09:11.0749835Z  
2026-02-20T22:09:11.0750224Z  # Paramètres de journalisation
2026-02-20T22:09:11.0750636Z  class LoggingLevels:
2026-02-20T22:09:11.0750971Z      DEBUG = "DEBUG"
2026-02-20T22:09:11.0751292Z      INFO = "INFO"
2026-02-20T22:09:11.0751630Z      WARNING = "WARNING"
2026-02-20T22:09:11.0751988Z      ERROR = "ERROR"
2026-02-20T22:09:11.0752328Z      CRITICAL = "CRITICAL"
2026-02-20T22:09:11.0752691Z  
2026-02-20T22:09:11.0752941Z +
2026-02-20T22:09:11.0753551Z  # Configuration de sécurité
2026-02-20T22:09:11.0753956Z  class SecurityConfig:
2026-02-20T22:09:11.0756874Z      TOKEN_EXPIRY_MINUTES = 60 * 24 * 7  # 7 jours (pour compatibilité)
2026-02-20T22:09:11.0763613Z      ALGORITHM = "HS256"
2026-02-20T22:09:11.0764014Z -    
2026-02-20T22:09:11.0764290Z +
2026-02-20T22:09:11.0766296Z +
2026-02-20T22:09:11.0766602Z  # Statut des exercices
2026-02-20T22:09:11.0766980Z  class ExerciseStatus:
2026-02-20T22:09:11.0767344Z      ACTIVE = True
2026-02-20T22:09:11.0767675Z      INACTIVE = False
2026-02-20T22:09:11.0768036Z      ARCHIVED = True
2026-02-20T22:09:11.0768368Z @@ -306,67 +459,84 @@
2026-02-20T22:09:11.0769018Z  # CHALLENGES - Constantes centralisées (Phase 3, Nov 2025)
2026-02-20T22:09:11.0769600Z  # ============================================================================
2026-02-20T22:09:11.0770029Z  
2026-02-20T22:09:11.0770281Z  # Types de challenges (PostgreSQL ENUM)
2026-02-20T22:09:11.0770664Z  CHALLENGE_TYPES_DB = [
2026-02-20T22:09:11.0771037Z -    'SEQUENCE', 'PATTERN', 'VISUAL', 'PUZZLE', 'GRAPH', 
2026-02-20T22:09:11.0771563Z -    'RIDDLE', 'DEDUCTION', 'CHESS', 'CODING', 'PROBABILITY'
2026-02-20T22:09:11.0771997Z +    "SEQUENCE",
2026-02-20T22:09:11.0772254Z +    "PATTERN",
2026-02-20T22:09:11.0772514Z +    "VISUAL",
2026-02-20T22:09:11.0772766Z +    "PUZZLE",
2026-02-20T22:09:11.0773245Z +    "GRAPH",
2026-02-20T22:09:11.0773493Z +    "RIDDLE",
2026-02-20T22:09:11.0773757Z +    "DEDUCTION",
2026-02-20T22:09:11.0774029Z +    "CHESS",
2026-02-20T22:09:11.0774283Z +    "CODING",
2026-02-20T22:09:11.0774531Z +    "PROBABILITY",
2026-02-20T22:09:11.0774778Z  ]
2026-02-20T22:09:11.0774995Z  
2026-02-20T22:09:11.0775235Z  CHALLENGE_TYPES_API = [
2026-02-20T22:09:11.0775658Z -    'sequence', 'pattern', 'visual', 'puzzle', 'graph',
2026-02-20T22:09:11.0776504Z -    'riddle', 'deduction', 'chess', 'coding', 'probability'
2026-02-20T22:09:11.0776992Z +    "sequence",
2026-02-20T22:09:11.0777245Z +    "pattern",
2026-02-20T22:09:11.0777489Z +    "visual",
2026-02-20T22:09:11.0777711Z +    "puzzle",
2026-02-20T22:09:11.0777929Z +    "graph",
2026-02-20T22:09:11.0778299Z +    "riddle",
2026-02-20T22:09:11.0778551Z +    "deduction",
2026-02-20T22:09:11.0778824Z +    "chess",
2026-02-20T22:09:11.0779087Z +    "coding",
2026-02-20T22:09:11.0779377Z +    "probability",
2026-02-20T22:09:11.0779680Z  ]
2026-02-20T22:09:11.0779934Z  
2026-02-20T22:09:11.0780314Z  # Mapping pour la normalisation des types de challenge
2026-02-20T22:09:11.0780858Z  CHALLENGE_TYPE_ALIASES = {
2026-02-20T22:09:11.0781466Z -    'SEQUENCE': ['sequence', 'seq', 'suite', 'séquence'],
2026-02-20T22:09:11.0782041Z -    'PATTERN': ['pattern', 'motif', 'grille'],
2026-02-20T22:09:11.0782651Z -    'VISUAL': ['visual', 'visuel', 'spatial', 'forme', 'formes'],
2026-02-20T22:09:11.0783634Z -    'PUZZLE': ['puzzle', 'casse-tete', 'casse-tête'],
2026-02-20T22:09:11.0784381Z -    'GRAPH': ['graph', 'graphe', 'reseau', 'réseau', 'chemin'],
2026-02-20T22:09:11.0785078Z -    'RIDDLE': ['riddle', 'enigme', 'énigme'],
2026-02-20T22:09:11.0785811Z -    'DEDUCTION': ['deduction', 'déduction', 'logique', 'logic'],
2026-02-20T22:09:11.0786706Z -    'CHESS': ['chess', 'echecs', 'échecs', 'echiquier', 'échiquier'],
2026-02-20T22:09:11.0787515Z -    'CODING': ['coding', 'codage', 'crypto', 'cryptographie', 'labyrinthe', 'maze'],
2026-02-20T22:09:11.0793741Z -    'PROBABILITY': ['probability', 'probabilite', 'probabilité', 'proba', 'chance'],
2026-02-20T22:09:11.0794785Z +    "SEQUENCE": ["sequence", "seq", "suite", "séquence"],
2026-02-20T22:09:11.0795371Z +    "PATTERN": ["pattern", "motif", "grille"],
2026-02-20T22:09:11.0795961Z +    "VISUAL": ["visual", "visuel", "spatial", "forme", "formes"],
2026-02-20T22:09:11.0796739Z +    "PUZZLE": ["puzzle", "casse-tete", "casse-tête"],
2026-02-20T22:09:11.0797523Z +    "GRAPH": ["graph", "graphe", "reseau", "réseau", "chemin"],
2026-02-20T22:09:11.0798217Z +    "RIDDLE": ["riddle", "enigme", "énigme"],
2026-02-20T22:09:11.0798934Z +    "DEDUCTION": ["deduction", "déduction", "logique", "logic"],
2026-02-20T22:09:11.0799806Z +    "CHESS": ["chess", "echecs", "échecs", "echiquier", "échiquier"],
2026-02-20T22:09:11.0800621Z +    "CODING": ["coding", "codage", "crypto", "cryptographie", "labyrinthe", "maze"],
2026-02-20T22:09:11.0801710Z +    "PROBABILITY": ["probability", "probabilite", "probabilité", "proba", "chance"],
2026-02-20T22:09:11.0802426Z  }
2026-02-20T22:09:11.0802689Z  
2026-02-20T22:09:11.0802948Z  
2026-02-20T22:09:11.0803655Z  def normalize_challenge_type(challenge_type):
2026-02-20T22:09:11.0804129Z      """
2026-02-20T22:09:11.0804577Z      Normalise le type de challenge vers le format DB (MAJUSCULE).
2026-02-20T22:09:11.0805140Z -    
2026-02-20T22:09:11.0805427Z +
2026-02-20T22:09:11.0805678Z      Args:
2026-02-20T22:09:11.0806449Z          challenge_type: Le type de challenge en entrée (peut être dans différents formats)
2026-02-20T22:09:11.0807196Z -        
2026-02-20T22:09:11.0807494Z +
2026-02-20T22:09:11.0807747Z      Returns:
2026-02-20T22:09:11.0808492Z          Le type de challenge normalisé en majuscule (ex: "SEQUENCE", "PATTERN", etc.)
2026-02-20T22:09:11.0809252Z          ou None si le type n'est pas reconnu
2026-02-20T22:09:11.0809699Z      """
2026-02-20T22:09:11.0810010Z      if not challenge_type:
2026-02-20T22:09:11.0810385Z          return None
2026-02-20T22:09:11.0810712Z  
2026-02-20T22:09:11.0811116Z      challenge_type_str = str(challenge_type).lower().strip()
2026-02-20T22:09:11.0811671Z -    
2026-02-20T22:09:11.0811938Z +
2026-02-20T22:09:11.0812465Z      # Vérifier correspondance directe avec les types API
2026-02-20T22:09:11.0813376Z      if challenge_type_str in CHALLENGE_TYPES_API:
2026-02-20T22:09:11.0815982Z          return challenge_type_str.upper()
2026-02-20T22:09:11.0817644Z -    
2026-02-20T22:09:11.0817988Z +
2026-02-20T22:09:11.0820102Z      # Vérifier correspondance directe avec les types DB
2026-02-20T22:09:11.0822511Z      if challenge_type_str.upper() in CHALLENGE_TYPES_DB:
2026-02-20T22:09:11.0854353Z          return challenge_type_str.upper()
2026-02-20T22:09:11.0854783Z -    
2026-02-20T22:09:11.0855077Z +
2026-02-20T22:09:11.0855610Z      # Parcourir tous les alias
2026-02-20T22:09:11.0856151Z      for type_key, aliases in CHALLENGE_TYPE_ALIASES.items():
2026-02-20T22:09:11.0856710Z          for alias in aliases:
2026-02-20T22:09:11.0857157Z              if challenge_type_str == alias.lower():
2026-02-20T22:09:11.0857632Z                  return type_key
2026-02-20T22:09:11.0857995Z -    
2026-02-20T22:09:11.0858254Z +
2026-02-20T22:09:11.0858503Z      # Type non reconnu
2026-02-20T22:09:11.0859012Z      logger.warning(f"Type de challenge non reconnu: '{challenge_type}'")
2026-02-20T22:09:11.0859574Z      return None
2026-02-20T22:09:11.0859866Z +
2026-02-20T22:09:11.0860105Z  
2026-02-20T22:09:11.0861091Z  # Groupes d'âge pour les challenges (valeurs ENUM PostgreSQL, alignées avec app.models.logic_challenge.AgeGroup)
2026-02-20T22:09:11.0862060Z  AGE_GROUPS_DB = [e.value for e in AgeGroup]
2026-02-20T22:09:11.0862499Z  
2026-02-20T22:09:11.0863249Z  # AGE_GROUP_MAPPING (These are effectively replicated now in AgeGroups.AGE_ALIASES)
2026-02-20T22:09:11.0863940Z @@ -384,6 +554,6 @@
2026-02-20T22:09:11.0864592Z  # DIFFICULTY_BY_AGE_GROUP is still used in generate_ai_challenge_stream in challenge_handlers.py
2026-02-20T22:09:11.0865420Z  # So I should keep it as is, or clarify its role.
2026-02-20T22:09:11.0865878Z  
2026-02-20T22:09:11.0866848Z  # Les fonctions normalize_challenge_type et normalize_age_group sont définies ci-dessus et utilisées pour les challenges
2026-02-20T22:09:11.0867772Z  
2026-02-20T22:09:11.0868222Z -# Remove the import of DifficultyLevel, as it's no longer used here.
2026-02-20T22:09:11.0868838Z \ No newline at end of file
2026-02-20T22:09:11.0869385Z +# Remove the import of DifficultyLevel, as it's no longer used here.
2026-02-20T22:09:11.0870394Z would reformat /home/runner/work/mathakine/mathakine/app/db/init_db.py
2026-02-20T22:09:11.0871234Z would reformat /home/runner/work/mathakine/mathakine/app/core/messages.py
2026-02-20T22:09:11.0872075Z would reformat /home/runner/work/mathakine/mathakine/app/db/adapter.py
2026-02-20T22:09:11.0873191Z --- /home/runner/work/mathakine/mathakine/app/db/init_db.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0874238Z +++ /home/runner/work/mathakine/mathakine/app/db/init_db.py	2026-02-20 22:09:11.069620+00:00
2026-02-20T22:09:11.0874942Z @@ -1,32 +1,34 @@
2026-02-20T22:09:11.0875321Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.0875772Z  
2026-02-20T22:09:11.0876054Z  logger = get_logger(__name__)
2026-02-20T22:09:11.0876408Z  
2026-02-20T22:09:11.0876706Z  from app.db.base import Base, engine
2026-02-20T22:09:11.0877098Z +
2026-02-20T22:09:11.0877731Z  # Importer les modèles pour assurer qu'ils sont enregistrés par SQLAlchemy
2026-02-20T22:09:11.0878568Z  from app.models.all_models import __all__ as models  # Import all models
2026-02-20T22:09:11.0879407Z  from app.services.db_init_service import create_tables, populate_test_data
2026-02-20T22:09:11.0880028Z  
2026-02-20T22:09:11.0880260Z  
2026-02-20T22:09:11.0880553Z  def create_tables_with_test_data():
2026-02-20T22:09:11.0881345Z      """Crée toutes les tables définies dans les modèles et ajoute des données de test.
2026-02-20T22:09:11.0882005Z -    
2026-02-20T22:09:11.0882253Z +
2026-02-20T22:09:11.0882911Z      ATTENTION : Cette fonction ne doit être appelée que dans un contexte de test (CI)
2026-02-20T22:09:11.0883982Z      ou pour initialiser une base de développement vide.
2026-02-20T22:09:11.0884530Z      Ne JAMAIS appeler en production.
2026-02-20T22:09:11.0884930Z      """
2026-02-20T22:09:11.0885190Z      import os
2026-02-20T22:09:11.0885478Z +
2026-02-20T22:09:11.0885933Z      logger.info("Initialisation de la base de données")
2026-02-20T22:09:11.0886774Z      try:
2026-02-20T22:09:11.0887584Z          # Créer les tables
2026-02-20T22:09:11.0888050Z          create_tables()
2026-02-20T22:09:11.0888622Z  
2026-02-20T22:09:11.0889457Z          # Ajouter des données de test UNIQUEMENT si TESTING=true ou base vide en dev
2026-02-20T22:09:11.0890547Z          is_testing = os.getenv("TESTING", "false").lower() == "true"
2026-02-20T22:09:11.0891484Z          environment = os.getenv("ENVIRONMENT", "development")
2026-02-20T22:09:11.0892080Z -        
2026-02-20T22:09:11.0892486Z +
2026-02-20T22:09:11.0892895Z          if is_testing:
2026-02-20T22:09:11.0893974Z              logger.info("Mode test détecté : ajout des données de test")
2026-02-20T22:09:11.0894708Z              populate_test_data()
2026-02-20T22:09:11.0895298Z          elif environment != "production":
2026-02-20T22:09:11.0896260Z              logger.info("Mode développement : ajout des données de test si base vide")
2026-02-20T22:09:11.0919117Z --- /home/runner/work/mathakine/mathakine/app/core/messages.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.0920277Z +++ /home/runner/work/mathakine/mathakine/app/core/messages.py	2026-02-20 22:09:11.060955+00:00
2026-02-20T22:09:11.0921041Z @@ -16,23 +16,24 @@
2026-02-20T22:09:11.0921603Z      ERROR_PERMISSION_DENIED = "Permission refusée"
2026-02-20T22:09:11.0922271Z      ERROR_INVALID_REQUEST = "Requête invalide"
2026-02-20T22:09:11.0923169Z      ERROR_NOT_IMPLEMENTED = "Fonctionnalité non implémentée"
2026-02-20T22:09:11.0923928Z      ERROR_RESOURCE_NOT_FOUND = "Ressource non trouvée"
2026-02-20T22:09:11.0924567Z      ERROR_DATABASE = "Erreur de base de données"
2026-02-20T22:09:11.0925020Z -    
2026-02-20T22:09:11.0925281Z +
2026-02-20T22:09:11.0925596Z      # Succès
2026-02-20T22:09:11.0926082Z      SUCCESS_OPERATION_COMPLETED = "Opération réussie"
2026-02-20T22:09:11.0926742Z      SUCCESS_CREATED = "Ressource créée avec succès"
2026-02-20T22:09:11.0927425Z      SUCCESS_UPDATED = "Ressource mise à jour avec succès"
2026-02-20T22:09:11.0928127Z      SUCCESS_DELETED = "Ressource supprimée avec succès"
2026-02-20T22:09:11.0928838Z      SUCCESS_ARCHIVED = "Exercice archivé avec succès"
2026-02-20T22:09:11.0929312Z -    
2026-02-20T22:09:11.0929576Z +
2026-02-20T22:09:11.0929844Z      # Messages d'information
2026-02-20T22:09:11.0930571Z      INFO_TRYING_CONNECTION = "Tentative de connexion à la base de données"
2026-02-20T22:09:11.0931385Z      INFO_APP_STARTING = "Démarrage de l'application"
2026-02-20T22:09:11.0931985Z      INFO_APP_READY = "Application prête"
2026-02-20T22:09:11.0932578Z      INFO_APP_STOPPING = "Arrêt de l'application"
2026-02-20T22:09:11.0933267Z +
2026-02-20T22:09:11.0933524Z  
2026-02-20T22:09:11.0933882Z  # Messages liés aux exercices
2026-02-20T22:09:11.0934284Z  class ExerciseMessages:
2026-02-20T22:09:11.0934643Z      # Titres des exercices
2026-02-20T22:09:11.0935042Z      TITLE_ADDITION = "Addition galactique"
2026-02-20T22:09:11.0935472Z @@ -42,75 +43,117 @@
2026-02-20T22:09:11.0935856Z      TITLE_FRACTIONS = "Fractions de l'hyperespace"
2026-02-20T22:09:11.0936540Z      TITLE_GEOMETRIE = "Géométrie des constellations"
2026-02-20T22:09:11.0937132Z      TITLE_DIVERS = "Défi mathématique"
2026-02-20T22:09:11.0937677Z      TITLE_DEFAULT = "Exercice mathématique"
2026-02-20T22:09:11.0938127Z      TITLE_AI_PREFIX = "TEST-ZAXXON"
2026-02-20T22:09:11.0938531Z -    
2026-02-20T22:09:11.0938792Z +
2026-02-20T22:09:11.0939137Z      # Messages de résultats
2026-02-20T22:09:11.0939771Z      RESULT_CORRECT = "Excellent travail ! Ta réponse est correcte."
2026-02-20T22:09:11.0940560Z      RESULT_INCORRECT = "Pas tout à fait ! Essaie encore."
2026-02-20T22:09:11.0941097Z      RESULT_HINT = "Indice: {hint}"
2026-02-20T22:09:11.0941477Z -    
2026-02-20T22:09:11.0941730Z +
2026-02-20T22:09:11.0941986Z      # Questions types
2026-02-20T22:09:11.0942390Z      QUESTION_ADDITION = "Calcule {num1} + {num2}"
2026-02-20T22:09:11.0943241Z      QUESTION_SUBTRACTION = "Calcule {num1} - {num2}"
2026-02-20T22:09:11.0943961Z      QUESTION_MULTIPLICATION = "Calcule {num1} × {num2}"
2026-02-20T22:09:11.0944893Z      QUESTION_DIVISION = "Calcule {num1} ÷ {num2}"
2026-02-20T22:09:11.0945558Z      QUESTION_FRACTIONS = "Calcule {num1}/{num2} {operation} {num3}/{num4}"
2026-02-20T22:09:11.0946782Z      QUESTION_GEOMETRIE = "Calcule le {property} du {shape} avec {parameter1}={value1} et {parameter2}={value2}"
2026-02-20T22:09:11.0947652Z      QUESTION_DIVERS = "{problem}"
2026-02-20T22:09:11.0948035Z -    
2026-02-20T22:09:11.0948285Z +
2026-02-20T22:09:11.0948634Z      # Textes éducatifs
2026-02-20T22:09:11.0949053Z      EXPLANATION_ADDITION = "{num1} + {num2} = {result}"
2026-02-20T22:09:11.0949652Z      EXPLANATION_SUBTRACTION = "{num1} - {num2} = {result}"
2026-02-20T22:09:11.0950353Z      EXPLANATION_MULTIPLICATION = "{num1} × {num2} = {result}"
2026-02-20T22:09:11.0951063Z      EXPLANATION_DIVISION = "{num1} ÷ {num2} = {result}"
2026-02-20T22:09:11.0952231Z      EXPLANATION_FRACTIONS = "Pour calculer {num1}/{num2} {operation} {num3}/{num4}, il faut {steps}. Le résultat est {result}."
2026-02-20T22:09:11.0954179Z      EXPLANATION_GEOMETRIE = "Pour calculer le {property} du {shape}, on utilise la formule: {formula}. Avec {parameter1}={value1} et {parameter2}={value2}, on obtient {result}."
2026-02-20T22:09:11.0955941Z -    EXPLANATION_DIVERS = "Voici comment résoudre ce problème: {steps}. La réponse est {result}."
2026-02-20T22:09:11.0956727Z -    
2026-02-20T22:09:11.0957019Z +    EXPLANATION_DIVERS = (
2026-02-20T22:09:11.0957752Z +        "Voici comment résoudre ce problème: {steps}. La réponse est {result}."
2026-02-20T22:09:11.0958363Z +    )
2026-02-20T22:09:11.0958624Z +
2026-02-20T22:09:11.0958866Z      # Tags
2026-02-20T22:09:11.0959210Z      TAGS_ALGORITHMIC = "algorithmique,simple"
2026-02-20T22:09:11.0959691Z      TAGS_AI = "ia,generatif,starwars"
2026-02-20T22:09:11.0960089Z -    
2026-02-20T22:09:11.0960333Z +
2026-02-20T22:09:11.0960650Z      # Réponses
2026-02-20T22:09:11.0961182Z      SUCCESS_ANSWER_CORRECT = "Bravo ! Ta réponse est correcte."
2026-02-20T22:09:11.0961919Z      ERROR_ANSWER_INCORRECT = "Ce n'est pas correct. Essaie encore !"
2026-02-20T22:09:11.0962479Z -    
2026-02-20T22:09:11.0962724Z +
2026-02-20T22:09:11.0963203Z      # Création
2026-02-20T22:09:11.0963721Z      SUCCESS_EXERCISE_CREATED = "Exercice créé avec succès"
2026-02-20T22:09:11.0964545Z      ERROR_EXERCISE_CREATION = "Erreur lors de la création de l'exercice"
2026-02-20T22:09:11.0965124Z -    
2026-02-20T22:09:11.0965380Z +
2026-02-20T22:09:11.0965637Z      # Autres messages
2026-02-20T22:09:11.0966118Z      INFO_EXERCISE_SUBMITTED = "Réponse soumise"
2026-02-20T22:09:11.0966715Z      INFO_EXERCISE_COMPLETE = "Exercice terminé"
2026-02-20T22:09:11.0967293Z      INFO_EXERCISE_SKIPPED = "Exercice passé"
2026-02-20T22:09:11.0967723Z  
2026-02-20T22:09:11.0967964Z +
2026-02-20T22:09:11.0968493Z  # Éléments narratifs Star Wars pour les exercices générés par IA
2026-02-20T22:09:11.0969072Z  class StarWarsNarratives:
2026-02-20T22:09:11.0969498Z      # Personnages Star Wars pour les contextes
2026-02-20T22:09:11.0969961Z      CHARACTERS = [
2026-02-20T22:09:11.0970627Z -        "Luke Skywalker", "Princesse Leia", "Han Solo", "Chewbacca", "Maître Yoda", 
2026-02-20T22:09:11.0971403Z -        "Obi-Wan Kenobi", "R2-D2", "C-3PO", "Darth Vader", "Rey", 
2026-02-20T22:09:11.0972164Z -        "Kylo Ren", "BB-8", "Finn", "Poe Dameron", "Padmé Amidala", 
2026-02-20T22:09:11.0972891Z -        "Qui-Gon Jinn", "Mace Windu", "Ahsoka Tano", "Boba Fett", "Le Mandalorien"
2026-02-20T22:09:11.0973690Z +        "Luke Skywalker",
2026-02-20T22:09:11.0974055Z +        "Princesse Leia",
2026-02-20T22:09:11.0974391Z +        "Han Solo",
2026-02-20T22:09:11.0974704Z +        "Chewbacca",
2026-02-20T22:09:11.0975080Z +        "Maître Yoda",
2026-02-20T22:09:11.0975409Z +        "Obi-Wan Kenobi",
2026-02-20T22:09:11.0975728Z +        "R2-D2",
2026-02-20T22:09:11.0976005Z +        "C-3PO",
2026-02-20T22:09:11.0976319Z +        "Darth Vader",
2026-02-20T22:09:11.0976639Z +        "Rey",
2026-02-20T22:09:11.0976934Z +        "Kylo Ren",
2026-02-20T22:09:11.0977529Z +        "BB-8",
2026-02-20T22:09:11.0977852Z +        "Finn",
2026-02-20T22:09:11.0978150Z +        "Poe Dameron",
2026-02-20T22:09:11.0978604Z +        "Padmé Amidala",
2026-02-20T22:09:11.0978969Z +        "Qui-Gon Jinn",
2026-02-20T22:09:11.0979311Z +        "Mace Windu",
2026-02-20T22:09:11.0979867Z +        "Ahsoka Tano",
2026-02-20T22:09:11.0980221Z +        "Boba Fett",
2026-02-20T22:09:11.0980545Z +        "Le Mandalorien",
2026-02-20T22:09:11.0980883Z      ]
2026-02-20T22:09:11.0981142Z -    
2026-02-20T22:09:11.0981402Z +
2026-02-20T22:09:11.0981665Z      # Objets Star Wars
2026-02-20T22:09:11.0981998Z      OBJECTS = [
2026-02-20T22:09:11.0982692Z -        "sabres laser", "vaisseaux", "blasters", "droïdes", "cristaux kyber", 
2026-02-20T22:09:11.0984039Z -        "pièces détachées", "crédits galactiques", "hologrammes", "speeders", "chasseurs X-wing", 
2026-02-20T22:09:11.0985067Z -        "chasseurs TIE", "grenades thermiques", "jetpacks", "casques de stormtrooper"
2026-02-20T22:09:11.0985784Z +        "sabres laser",
2026-02-20T22:09:11.0986147Z +        "vaisseaux",
2026-02-20T22:09:11.0986474Z +        "blasters",
2026-02-20T22:09:11.0986880Z +        "droïdes",
2026-02-20T22:09:11.0987217Z +        "cristaux kyber",
2026-02-20T22:09:11.0987679Z +        "pièces détachées",
2026-02-20T22:09:11.0988162Z +        "crédits galactiques",
2026-02-20T22:09:11.0988541Z +        "hologrammes",
2026-02-20T22:09:11.0988884Z +        "speeders",
2026-02-20T22:09:11.0989218Z +        "chasseurs X-wing",
2026-02-20T22:09:11.0989593Z +        "chasseurs TIE",
2026-02-20T22:09:11.0989955Z +        "grenades thermiques",
2026-02-20T22:09:11.0990344Z +        "jetpacks",
2026-02-20T22:09:11.0990683Z +        "casques de stormtrooper",
2026-02-20T22:09:11.0991093Z      ]
2026-02-20T22:09:11.0991367Z -    
2026-02-20T22:09:11.0991647Z +
2026-02-20T22:09:11.0991925Z      # Lieux Star Wars
2026-02-20T22:09:11.0992260Z      LOCATIONS = [
2026-02-20T22:09:11.0992684Z -        "Tatooine", "Coruscant", "Endor", "Hoth", "Dagobah", 
2026-02-20T22:09:11.0993707Z -        "Naboo", "Mustafar", "Alderaan", "Jakku", "Exegol", 
2026-02-20T22:09:11.0994727Z -        "Cantina de Mos Eisley", "Temple Jedi", "l'Étoile de la Mort", "la Base Starkiller", "Geonosis"
2026-02-20T22:09:11.0995466Z +        "Tatooine",
2026-02-20T22:09:11.0995800Z +        "Coruscant",
2026-02-20T22:09:11.0996110Z +        "Endor",
2026-02-20T22:09:11.0996391Z +        "Hoth",
2026-02-20T22:09:11.0996682Z +        "Dagobah",
2026-02-20T22:09:11.0996984Z +        "Naboo",
2026-02-20T22:09:11.0997107Z +        "Mustafar",
2026-02-20T22:09:11.0997234Z +        "Alderaan",
2026-02-20T22:09:11.0997347Z +        "Jakku",
2026-02-20T22:09:11.0997458Z +        "Exegol",
2026-02-20T22:09:11.0997605Z +        "Cantina de Mos Eisley",
2026-02-20T22:09:11.0997736Z +        "Temple Jedi",
2026-02-20T22:09:11.0997974Z +        "l'Étoile de la Mort",
2026-02-20T22:09:11.0998115Z +        "la Base Starkiller",
2026-02-20T22:09:11.0998262Z +        "Geonosis",
2026-02-20T22:09:11.0998370Z      ]
2026-02-20T22:09:11.0998479Z -    
2026-02-20T22:09:11.0998596Z +
2026-02-20T22:09:11.0999028Z      # Préfixes pour les explications - OPTIMISÉS par difficulté
2026-02-20T22:09:11.0999183Z      EXPLANATION_PREFIXES = {
2026-02-20T22:09:11.0999300Z          "INITIE": [
2026-02-20T22:09:11.0999651Z              "Jeune Padawan, comme l'enseigne Maître Yoda :",
2026-02-20T22:09:11.1000018Z              "Dans tes premiers pas vers la maîtrise de la Force :",
2026-02-20T22:09:11.1000143Z @@ -140,13 +183,13 @@
2026-02-20T22:09:11.1000451Z              "Dans la sagesse millénaire de l'Ordre :",
2026-02-20T22:09:11.1000781Z              "Les grands stratèges galactiques enseignent :",
2026-02-20T22:09:11.1001052Z              "Face aux mystères de la Force :",
2026-02-20T22:09:11.1001389Z              "Dans les décisions qui façonnent la galaxie :",
2026-02-20T22:09:11.1001681Z              "Comme l'ont prouvé les anciens Maîtres :",
2026-02-20T22:09:11.1002061Z -        ]
2026-02-20T22:09:11.1002177Z +        ],
2026-02-20T22:09:11.1002293Z      }
2026-02-20T22:09:11.1002398Z -    
2026-02-20T22:09:11.1002505Z +
2026-02-20T22:09:11.1002951Z      # Conclusions pour les explications - OPTIMISÉES par difficulté
2026-02-20T22:09:11.1003377Z      EXPLANATION_SUFFIXES = {
2026-02-20T22:09:11.1003717Z          "INITIE": [
2026-02-20T22:09:11.1003912Z              "Continue ainsi, jeune Padawan !",
2026-02-20T22:09:11.1004125Z              "Tu progresses bien dans ta formation.",
2026-02-20T22:09:11.1004252Z @@ -176,13 +219,13 @@
2026-02-20T22:09:11.1004458Z              "Tu atteins les sommets de la connaissance.",
2026-02-20T22:09:11.1004778Z              "Même Yoda approuverait ta maîtrise.",
2026-02-20T22:09:11.1005109Z              "Ta sagesse éclairera les générations futures.",
2026-02-20T22:09:11.1005308Z              "Tu incarnes l'excellence de l'Ordre Jedi.",
2026-02-20T22:09:11.1005538Z              "Que ta sagesse guide la galaxie vers la paix.",
2026-02-20T22:09:11.1005668Z -        ]
2026-02-20T22:09:11.1005781Z +        ],
2026-02-20T22:09:11.1005888Z      }
2026-02-20T22:09:11.1006005Z -    
2026-02-20T22:09:11.1006111Z +
2026-02-20T22:09:11.1006480Z      # Préfixes génériques (fallback pour compatibilité)
2026-02-20T22:09:11.1006657Z      EXPLANATION_PREFIXES_GENERIC = [
2026-02-20T22:09:11.1007423Z          "Dans l'univers Star Wars, il est important de partager équitablement les ressources, comme les armes laser.",
2026-02-20T22:09:11.1008117Z          "Les Jedi enseignent que la maîtrise des mathématiques est essentielle à l'équilibre de la Force.",
2026-02-20T22:09:11.1008685Z          "Comme le dit souvent Maître Yoda, 'Par les calculs, plus clair l'avenir devient.'",
2026-02-20T22:09:11.1008824Z @@ -190,13 +233,13 @@
2026-02-20T22:09:11.1009276Z          "Pour un futur Jedi, comprendre les nombres est aussi important que manier le sabre laser.",
2026-02-20T22:09:11.1009881Z          "La Résistance utilise quotidiennement ce type de calcul pour planifier ses missions.",
2026-02-20T22:09:11.1010611Z          "L'Ordre Jedi a toujours valorisé les connaissances mathématiques dans la formation des Padawans.",
2026-02-20T22:09:11.1011210Z          "Dans les archives du Temple Jedi, ce genre de problème est considéré comme fondamental.",
2026-02-20T22:09:11.1011881Z          "Qu'on soit du côté lumineux ou obscur de la Force, ces compétences mathématiques sont universelles.",
2026-02-20T22:09:11.1012533Z -        "Même les droïdes comme R2-D2 doivent maîtriser ces calculs pour naviguer dans l'hyperespace."
2026-02-20T22:09:11.1013334Z +        "Même les droïdes comme R2-D2 doivent maîtriser ces calculs pour naviguer dans l'hyperespace.",
2026-02-20T22:09:11.1013444Z      ]
2026-02-20T22:09:11.1013553Z -    
2026-02-20T22:09:11.1013649Z +
2026-02-20T22:09:11.1013969Z      # Suffixes génériques (fallback pour compatibilité)
2026-02-20T22:09:11.1014118Z      EXPLANATION_SUFFIXES_GENERIC = [
2026-02-20T22:09:11.1014477Z          "Cette compétence te rapproche du rang de Maître Jedi.",
2026-02-20T22:09:11.1014954Z          "En maîtrisant ces calculs, tu progresses sur le chemin de la Force.",
2026-02-20T22:09:11.1015363Z          "Que la Force des mathématiques soit avec toi, jeune Padawan.",
2026-02-20T22:09:11.1015496Z @@ -204,94 +247,165 @@
2026-02-20T22:09:11.1015765Z          "Ces connaissances te serviront dans toute la galaxie.",
2026-02-20T22:09:11.1016283Z          "Continue ainsi, et tu pourras bientôt construire ton propre sabre laser.",
2026-02-20T22:09:11.1016794Z          "La maîtrise de ces calculs te distingue des simples recrues de l'Empire.",
2026-02-20T22:09:11.1017278Z          "Même un Seigneur Sith serait impressionné par ta maîtrise des nombres.",
2026-02-20T22:09:11.1017681Z          "La Résistance a besoin de cerveaux brillants comme le tien.",
2026-02-20T22:09:11.1018179Z -        "Avec de telles compétences, même le Conseil Jedi pourrait te remarquer."
2026-02-20T22:09:11.1018676Z +        "Avec de telles compétences, même le Conseil Jedi pourrait te remarquer.",
2026-02-20T22:09:11.1019044Z      ]
2026-02-20T22:09:11.1019160Z  
2026-02-20T22:09:11.1019477Z      # Contextes spécialisés par type d'exercice
2026-02-20T22:09:11.1019625Z      CONTEXTS_BY_TYPE = {
2026-02-20T22:09:11.1019756Z          "ADDITION": {
2026-02-20T22:09:11.1020596Z -            "objects": ["cristaux Kyber", "vaisseaux rebelles", "droïdes", "soldats", "crédits"],
2026-02-20T22:09:11.1021036Z -            "actions": ["rejoignent", "s'allient", "se rassemblent", "fusionnent", "s'unissent"],
2026-02-20T22:09:11.1021447Z -            "locations": ["base rebelle", "cantina", "hangar", "temple Jedi", "station spatiale"]
2026-02-20T22:09:11.1021600Z +            "objects": [
2026-02-20T22:09:11.1021738Z +                "cristaux Kyber",
2026-02-20T22:09:11.1021894Z +                "vaisseaux rebelles",
2026-02-20T22:09:11.1022118Z +                "droïdes",
2026-02-20T22:09:11.1022254Z +                "soldats",
2026-02-20T22:09:11.1022448Z +                "crédits",
2026-02-20T22:09:11.1022584Z +            ],
2026-02-20T22:09:11.1022720Z +            "actions": [
2026-02-20T22:09:11.1022849Z +                "rejoignent",
2026-02-20T22:09:11.1023165Z +                "s'allient",
2026-02-20T22:09:11.1023315Z +                "se rassemblent",
2026-02-20T22:09:11.1023455Z +                "fusionnent",
2026-02-20T22:09:11.1023582Z +                "s'unissent",
2026-02-20T22:09:11.1023697Z +            ],
2026-02-20T22:09:11.1023830Z +            "locations": [
2026-02-20T22:09:11.1023963Z +                "base rebelle",
2026-02-20T22:09:11.1024086Z +                "cantina",
2026-02-20T22:09:11.1024217Z +                "hangar",
2026-02-20T22:09:11.1024354Z +                "temple Jedi",
2026-02-20T22:09:11.1024493Z +                "station spatiale",
2026-02-20T22:09:11.1024603Z +            ],
2026-02-20T22:09:11.1024715Z          },
2026-02-20T22:09:11.1024847Z          "SUBTRACTION": {
2026-02-20T22:09:11.1025262Z -            "objects": ["TIE Fighters", "stormtroopers", "ressources", "munitions", "vaisseaux"],
2026-02-20T22:09:11.1025930Z -            "actions": ["sont détruits", "désertent", "sont perdus", "sont confisqués", "disparaissent"],
2026-02-20T22:09:11.1026540Z -            "locations": ["bataille spatiale", "raid impérial", "mission secrète", "combat", "siège"]
2026-02-20T22:09:11.1026685Z +            "objects": [
2026-02-20T22:09:11.1026827Z +                "TIE Fighters",
2026-02-20T22:09:11.1026966Z +                "stormtroopers",
2026-02-20T22:09:11.1027089Z +                "ressources",
2026-02-20T22:09:11.1027216Z +                "munitions",
2026-02-20T22:09:11.1027346Z +                "vaisseaux",
2026-02-20T22:09:11.1027456Z +            ],
2026-02-20T22:09:11.1027579Z +            "actions": [
2026-02-20T22:09:11.1027807Z +                "sont détruits",
2026-02-20T22:09:11.1027993Z +                "désertent",
2026-02-20T22:09:11.1028124Z +                "sont perdus",
2026-02-20T22:09:11.1028337Z +                "sont confisqués",
2026-02-20T22:09:11.1028495Z +                "disparaissent",
2026-02-20T22:09:11.1028607Z +            ],
2026-02-20T22:09:11.1028735Z +            "locations": [
2026-02-20T22:09:11.1028887Z +                "bataille spatiale",
2026-02-20T22:09:11.1029102Z +                "raid impérial",
2026-02-20T22:09:11.1029327Z +                "mission secrète",
2026-02-20T22:09:11.1029456Z +                "combat",
2026-02-20T22:09:11.1029653Z +                "siège",
2026-02-20T22:09:11.1029770Z +            ],
2026-02-20T22:09:11.1029878Z          },
2026-02-20T22:09:11.1030022Z          "MULTIPLICATION": {
2026-02-20T22:09:11.1030512Z              "objects": ["escadrons", "bataillons", "flottes", "systèmes", "garnisons"],
2026-02-20T22:09:11.1031138Z -            "actions": ["se multiplient", "se déploient", "s'organisent", "se coordonnent", "s'étendent"],
2026-02-20T22:09:11.1031812Z -            "locations": ["secteur galactique", "front de guerre", "territoire", "zone d'influence", "région"]
2026-02-20T22:09:11.1032201Z +            "actions": [
2026-02-20T22:09:11.1032351Z +                "se multiplient",
2026-02-20T22:09:11.1032573Z +                "se déploient",
2026-02-20T22:09:11.1032713Z +                "s'organisent",
2026-02-20T22:09:11.1032843Z +                "se coordonnent",
2026-02-20T22:09:11.1033434Z +                "s'étendent",
2026-02-20T22:09:11.1033572Z +            ],
2026-02-20T22:09:11.1033706Z +            "locations": [
2026-02-20T22:09:11.1033856Z +                "secteur galactique",
2026-02-20T22:09:11.1033994Z +                "front de guerre",
2026-02-20T22:09:11.1034127Z +                "territoire",
2026-02-20T22:09:11.1034261Z +                "zone d'influence",
2026-02-20T22:09:11.1034476Z +                "région",
2026-02-20T22:09:11.1034598Z +            ],
2026-02-20T22:09:11.1034712Z          },
2026-02-20T22:09:11.1034838Z          "DIVISION": {
2026-02-20T22:09:11.1035451Z -            "objects": ["ressources", "troupes", "équipements", "territoires", "responsabilités"],
2026-02-20T22:09:11.1036117Z -            "actions": ["se répartissent", "se divisent", "se distribuent", "se partagent", "s'organisent"],
2026-02-20T22:09:11.1036623Z -            "locations": ["bases", "planètes", "secteurs", "commandements", "divisions"]
2026-02-20T22:09:11.1036747Z -        }
2026-02-20T22:09:11.1036899Z +            "objects": [
2026-02-20T22:09:11.1037023Z +                "ressources",
2026-02-20T22:09:11.1037137Z +                "troupes",
2026-02-20T22:09:11.1037350Z +                "équipements",
2026-02-20T22:09:11.1037484Z +                "territoires",
2026-02-20T22:09:11.1037710Z +                "responsabilités",
2026-02-20T22:09:11.1037827Z +            ],
2026-02-20T22:09:11.1037966Z +            "actions": [
2026-02-20T22:09:11.1038189Z +                "se répartissent",
2026-02-20T22:09:11.1038320Z +                "se divisent",
2026-02-20T22:09:11.1038464Z +                "se distribuent",
2026-02-20T22:09:11.1038598Z +                "se partagent",
2026-02-20T22:09:11.1038741Z +                "s'organisent",
2026-02-20T22:09:11.1038864Z +            ],
2026-02-20T22:09:11.1038991Z +            "locations": [
2026-02-20T22:09:11.1039111Z +                "bases",
2026-02-20T22:09:11.1039327Z +                "planètes",
2026-02-20T22:09:11.1039466Z +                "secteurs",
2026-02-20T22:09:11.1039613Z +                "commandements",
2026-02-20T22:09:11.1039743Z +                "divisions",
2026-02-20T22:09:11.1039865Z +            ],
2026-02-20T22:09:11.1039976Z +        },
2026-02-20T22:09:11.1040090Z      }
2026-02-20T22:09:11.1040199Z  
2026-02-20T22:09:11.1040326Z      @classmethod
2026-02-20T22:09:11.1040583Z      def get_explanation_prefix(cls, difficulty="PADAWAN"):
2026-02-20T22:09:11.1041039Z          """Récupère un préfixe d'explication adapté à la difficulté"""
2026-02-20T22:09:11.1041648Z -        prefixes = cls.EXPLANATION_PREFIXES.get(difficulty.upper(), cls.EXPLANATION_PREFIXES_GENERIC)
2026-02-20T22:09:11.1041852Z +        prefixes = cls.EXPLANATION_PREFIXES.get(
2026-02-20T22:09:11.1042131Z +            difficulty.upper(), cls.EXPLANATION_PREFIXES_GENERIC
2026-02-20T22:09:11.1042248Z +        )
2026-02-20T22:09:11.1042422Z          return random.choice(prefixes)
2026-02-20T22:09:11.1042534Z -    
2026-02-20T22:09:11.1042641Z +
2026-02-20T22:09:11.1042782Z      @classmethod
2026-02-20T22:09:11.1043223Z      def get_explanation_suffix(cls, difficulty="PADAWAN"):
2026-02-20T22:09:11.1043675Z          """Récupère un suffixe d'explication adapté à la difficulté"""
2026-02-20T22:09:11.1044185Z -        suffixes = cls.EXPLANATION_SUFFIXES.get(difficulty.upper(), cls.EXPLANATION_SUFFIXES_GENERIC)
2026-02-20T22:09:11.1044380Z +        suffixes = cls.EXPLANATION_SUFFIXES.get(
2026-02-20T22:09:11.1044630Z +            difficulty.upper(), cls.EXPLANATION_SUFFIXES_GENERIC
2026-02-20T22:09:11.1044744Z +        )
2026-02-20T22:09:11.1044910Z          return random.choice(suffixes)
2026-02-20T22:09:11.1045022Z +
2026-02-20T22:09:11.1045126Z  
2026-02-20T22:09:11.1045517Z  # Textes de l'interface
2026-02-20T22:09:11.1045652Z  class InterfaceTexts:
2026-02-20T22:09:11.1045853Z      # En-tête
2026-02-20T22:09:11.1046000Z      HEADER_TITLE = "Mathakine"
2026-02-20T22:09:11.1046163Z      HEADER_SUBTITLE = "L'API Rebelle"
2026-02-20T22:09:11.1046271Z -    
2026-02-20T22:09:11.1046580Z +
2026-02-20T22:09:11.1046739Z      # Menu principal
2026-02-20T22:09:11.1046877Z      MENU_HOME = "Accueil"
2026-02-20T22:09:11.1047028Z      MENU_EXERCISES = "Exercices"
2026-02-20T22:09:11.1047183Z      MENU_DASHBOARD = "Tableau de bord"
2026-02-20T22:09:11.1047347Z      MENU_NEW_EXERCISE = "Nouvel exercice"
2026-02-20T22:09:11.1047453Z -    
2026-02-20T22:09:11.1047561Z +
2026-02-20T22:09:11.1047691Z      # Page d'accueil
2026-02-20T22:09:11.1047850Z      HOME_TITLE = "Bienvenue sur Mathakine"
2026-02-20T22:09:11.1048389Z      HOME_SUBTITLE = "La plateforme d'entraînement mathématique pour les Padawans"
2026-02-20T22:09:11.1048705Z      HOME_START_BUTTON = "Commencer l'entraînement"
2026-02-20T22:09:11.1049025Z      HOME_DASHBOARD_BUTTON = "Consulter vos progrès"
2026-02-20T22:09:11.1049143Z -    
2026-02-20T22:09:11.1049250Z +
2026-02-20T22:09:11.1049390Z      # Page d'exercices
2026-02-20T22:09:11.1049675Z      EXERCISES_TITLE = "Bibliothèque d'exercices"
2026-02-20T22:09:11.1050094Z      EXERCISES_SUBTITLE = "Sélectionner un exercice pour commencer"
2026-02-20T22:09:11.1050309Z      EXERCISES_EMPTY = "Aucun exercice disponible"
2026-02-20T22:09:11.1050524Z      EXERCISES_FILTER_TITLE = "Filtrer les exercices"
2026-02-20T22:09:11.1050704Z      EXERCISES_FILTER_TYPE = "Type d'exercice"
2026-02-20T22:09:11.1051064Z      EXERCISES_FILTER_DIFFICULTY = "Niveau de difficulté"
2026-02-20T22:09:11.1051287Z      EXERCISES_FILTER_BUTTON = "Appliquer les filtres"
2026-02-20T22:09:11.1051659Z      EXERCISES_GENERATE_BUTTON = "Générer un nouvel exercice"
2026-02-20T22:09:11.1051930Z      EXERCISES_BACK_BUTTON = "Retour à la liste"
2026-02-20T22:09:11.1052048Z -    
2026-02-20T22:09:11.1052155Z +
2026-02-20T22:09:11.1052300Z      # Tableau de bord
2026-02-20T22:09:11.1052462Z      DASHBOARD_TITLE = "Tableau de bord"
2026-02-20T22:09:11.1053204Z      DASHBOARD_SUBTITLE = "Suivez votre progression vers la maîtrise des mathématiques"
2026-02-20T22:09:11.1053539Z      DASHBOARD_TOTAL_EXERCISES = "Exercices réalisés"
2026-02-20T22:09:11.1053865Z      DASHBOARD_CORRECT_ANSWERS = "Réponses correctes"
2026-02-20T22:09:11.1054147Z      DASHBOARD_SUCCESS_RATE = "Taux de réussite"
2026-02-20T22:09:11.1054433Z      DASHBOARD_EXPERIENCE = "Points d'expérience"
2026-02-20T22:09:11.1054613Z      DASHBOARD_PROGRESS_TITLE = "Progression"
2026-02-20T22:09:11.1054916Z      DASHBOARD_RECENT_ACTIVITY = "Activité récente"
2026-02-20T22:09:11.1055245Z      DASHBOARD_ACTIVITY_EMPTY = "Aucune activité récente"
2026-02-20T22:09:11.1055358Z -    
2026-02-20T22:09:11.1055473Z +
2026-02-20T22:09:11.1055599Z      # Pied de page
2026-02-20T22:09:11.1056111Z      FOOTER_TEXT = "Mathakine - Exerce-toi aux mathématiques de façon amusante !"
2026-02-20T22:09:11.1056288Z      FOOTER_GITHUB = "Projet GitHub"
2026-02-20T22:09:11.1056491Z      FOOTER_VERSION = "Version 3.0 - L'API Rebelle"
2026-02-20T22:09:11.1056599Z -    
2026-02-20T22:09:11.1056703Z +
2026-02-20T22:09:11.1056920Z      # Boutons génériques
2026-02-20T22:09:11.1057076Z      BUTTON_SUBMIT = "Valider"
2026-02-20T22:09:11.1057213Z      BUTTON_CANCEL = "Annuler"
2026-02-20T22:09:11.1057353Z      BUTTON_CONFIRM = "Confirmer"
2026-02-20T22:09:11.1057496Z      BUTTON_NEXT = "Suivant"
2026-02-20T22:09:11.1057612Z @@ -303,61 +417,67 @@
2026-02-20T22:09:11.1057743Z      BUTTON_BACK = "Retour"
2026-02-20T22:09:11.1057892Z      BUTTON_REFRESH = "Actualiser"
2026-02-20T22:09:11.1058104Z      BUTTON_RETRY = "Réessayer"
2026-02-20T22:09:11.1058315Z      BUTTON_GENERATE = "Générer"
2026-02-20T22:09:11.1058454Z      BUTTON_ARCHIVE = "Archiver"
2026-02-20T22:09:11.1058575Z -    
2026-02-20T22:09:11.1058681Z +
2026-02-20T22:09:11.1058912Z      # En-têtes et titres de pages
2026-02-20T22:09:11.1059365Z      PAGE_TITLE_HOME = "Accueil | Mathakine"
2026-02-20T22:09:11.1059568Z      PAGE_TITLE_EXERCISES = "Exercices | Mathakine"
2026-02-20T22:09:11.1059791Z      PAGE_TITLE_DASHBOARD = "Tableau de bord | Mathakine"
2026-02-20T22:09:11.1059955Z      PAGE_TITLE_ERROR = "Erreur | Mathakine"
2026-02-20T22:09:11.1060068Z -    
2026-02-20T22:09:11.1060434Z +
2026-02-20T22:09:11.1060574Z      # Boutons
2026-02-20T22:09:11.1060725Z      BUTTON_HOME = "Accueil"
2026-02-20T22:09:11.1060874Z      BUTTON_EXERCISES = "Exercices"
2026-02-20T22:09:11.1061034Z      BUTTON_DASHBOARD = "Tableau de bord"
2026-02-20T22:09:11.1061186Z      BUTTON_LOGIN = "Connexion"
2026-02-20T22:09:11.1061339Z      BUTTON_REGISTER = "Inscription"
2026-02-20T22:09:11.1061593Z      BUTTON_LOGOUT = "Déconnexion"
2026-02-20T22:09:11.1061702Z -    
2026-02-20T22:09:11.1061815Z +
2026-02-20T22:09:11.1061982Z      # Libellés
2026-02-20T22:09:11.1062112Z      LABEL_NAME = "Nom"
2026-02-20T22:09:11.1062252Z      LABEL_EMAIL = "Email"
2026-02-20T22:09:11.1062413Z      LABEL_PASSWORD = "Mot de passe"
2026-02-20T22:09:11.1062645Z      LABEL_CONFIRM_PASSWORD = "Confirmer le mot de passe"
2026-02-20T22:09:11.1062816Z      LABEL_EXERCISE_TYPE = "Type d'exercice"
2026-02-20T22:09:11.1063318Z      LABEL_DIFFICULTY = "Niveau de difficulté"
2026-02-20T22:09:11.1063565Z      LABEL_ANSWER = "Ta réponse"
2026-02-20T22:09:11.1063674Z -    
2026-02-20T22:09:11.1063792Z +
2026-02-20T22:09:11.1063937Z      # Textes de page d'accueil
2026-02-20T22:09:11.1064185Z      HOME_WELCOME = "Bienvenue sur Mathakine - L'API Rebelle"
2026-02-20T22:09:11.1065045Z      HOME_DESCRIPTION = "Rejoins les forces rebelles et entraîne-toi avec des exercices mathématiques amusants et interactifs."
2026-02-20T22:09:11.1065170Z -    
2026-02-20T22:09:11.1065280Z +
2026-02-20T22:09:11.1065447Z      # Messages de connexion/inscription
2026-02-20T22:09:11.1065599Z      LOGIN_TITLE = "Connexion"
2026-02-20T22:09:11.1065992Z      LOGIN_SUBTITLE = "Connecte-toi pour accéder à ton compte"
2026-02-20T22:09:11.1066164Z      REGISTER_TITLE = "Inscription"
2026-02-20T22:09:11.1066503Z      REGISTER_SUBTITLE = "Crée un compte pour commencer"
2026-02-20T22:09:11.1066613Z -    
2026-02-20T22:09:11.1066720Z +
2026-02-20T22:09:11.1066844Z      # Textes du tableau de bord
2026-02-20T22:09:11.1067421Z -    DASHBOARD_NO_DATA = "Pas encore de données disponibles. Commence à résoudre des exercices !"
2026-02-20T22:09:11.1067522Z -    
2026-02-20T22:09:11.1067650Z +    DASHBOARD_NO_DATA = (
2026-02-20T22:09:11.1068122Z +        "Pas encore de données disponibles. Commence à résoudre des exercices !"
2026-02-20T22:09:11.1068235Z +    )
2026-02-20T22:09:11.1068339Z +
2026-02-20T22:09:11.1068471Z      # Messages d'erreur
2026-02-20T22:09:11.1068736Z      ERROR_404_TITLE = "Page non trouvée"
2026-02-20T22:09:11.1069245Z      ERROR_404_MESSAGE = "La page que tu cherches n'existe pas ou a été déplacée."
2026-02-20T22:09:11.1069408Z      ERROR_500_TITLE = "Erreur serveur"
2026-02-20T22:09:11.1070035Z -    ERROR_500_MESSAGE = "Une erreur s'est produite sur le serveur. Veuillez réessayer plus tard."
2026-02-20T22:09:11.1070194Z +    ERROR_500_MESSAGE = (
2026-02-20T22:09:11.1070685Z +        "Une erreur s'est produite sur le serveur. Veuillez réessayer plus tard."
2026-02-20T22:09:11.1070808Z +    )
2026-02-20T22:09:11.1070917Z +
2026-02-20T22:09:11.1071039Z  
2026-02-20T22:09:11.1071167Z  # Notifications
2026-02-20T22:09:11.1071333Z  class NotificationMessages:
2026-02-20T22:09:11.1071583Z      INFO_LOGGED_IN = "Connexion réussie"
2026-02-20T22:09:11.1071820Z      INFO_LOGGED_OUT = "Déconnexion réussie"
2026-02-20T22:09:11.1072085Z      INFO_REGISTERED = "Inscription réussie"
2026-02-20T22:09:11.1072502Z      WARNING_SESSION_EXPIRED = "Ta session a expiré, reconnecte-toi"
2026-02-20T22:09:11.1072792Z      ERROR_INVALID_CREDENTIALS = "Email ou mot de passe incorrect"
2026-02-20T22:09:11.1073321Z      ERROR_EMAIL_EXISTS = "Cet email est déjà utilisé"
2026-02-20T22:09:11.1073449Z +
2026-02-20T22:09:11.1073556Z  
2026-02-20T22:09:11.1074151Z  # Messages spécifiques aux utilisateurs
2026-02-20T22:09:11.1074303Z  class UserMessages:
2026-02-20T22:09:11.1074449Z      # Connexion et inscription
2026-02-20T22:09:11.1074934Z      SUCCESS_REGISTRATION = "Inscription réussie ! Bienvenue dans l'Ordre Jedi."
2026-02-20T22:09:11.1075055Z @@ -366,33 +486,37 @@
2026-02-20T22:09:11.1075652Z      ERROR_INVALID_CREDENTIALS = "Les informations d'identification sont incorrectes."
2026-02-20T22:09:11.1076035Z      ERROR_USERNAME_EXISTS = "Ce nom d'utilisateur est déjà pris."
2026-02-20T22:09:11.1076385Z      ERROR_EMAIL_EXISTS = "Cette adresse email est déjà utilisée."
2026-02-20T22:09:11.1076696Z      ERROR_PASSWORD_MISMATCH = "Les mots de passe ne correspondent pas."
2026-02-20T22:09:11.1077015Z      ERROR_INACTIVE_ACCOUNT = "Ce compte a été désactivé."
2026-02-20T22:09:11.1077123Z -    
2026-02-20T22:09:11.1077227Z +
2026-02-20T22:09:11.1077368Z      # Validation des champs
2026-02-20T22:09:11.1078005Z      ERROR_PASSWORD_WEAK = "Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre."
2026-02-20T22:09:11.1078613Z      ERROR_USERNAME_INVALID = "Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores."
2026-02-20T22:09:11.1078862Z      ERROR_EMAIL_INVALID = "L'adresse email n'est pas valide."
2026-02-20T22:09:11.1078985Z -    
2026-02-20T22:09:11.1079090Z +
2026-02-20T22:09:11.1079238Z      # Profil utilisateur
2026-02-20T22:09:11.1079610Z      SUCCESS_PROFILE_UPDATE = "Profil mis à jour avec succès."
2026-02-20T22:09:11.1080021Z      SUCCESS_PASSWORD_UPDATE = "Mot de passe mis à jour avec succès."
2026-02-20T22:09:11.1080321Z      ERROR_CURRENT_PASSWORD = "Le mot de passe actuel est incorrect."
2026-02-20T22:09:11.1080427Z -    
2026-02-20T22:09:11.1080532Z +
2026-02-20T22:09:11.1080654Z      # Permissions
2026-02-20T22:09:11.1081117Z      ERROR_NOT_AUTHORIZED = "Tu n'es pas autorisé à effectuer cette action."
2026-02-20T22:09:11.1081510Z      ERROR_ADMIN_REQUIRED = "Seuls les administrateurs peuvent effectuer cette action."
2026-02-20T22:09:11.1081986Z -    ERROR_GARDIEN_REQUIRED = "Seuls les Gardiens et Archivistes peuvent effectuer cette action."
2026-02-20T22:09:11.1082655Z -    ERROR_CHEVALIER_REQUIRED = "Seuls les Chevaliers Jedi et supérieurs peuvent effectuer cette action."
2026-02-20T22:09:11.1082762Z -    
2026-02-20T22:09:11.1082916Z +    ERROR_GARDIEN_REQUIRED = (
2026-02-20T22:09:11.1083445Z +        "Seuls les Gardiens et Archivistes peuvent effectuer cette action."
2026-02-20T22:09:11.1083557Z +    )
2026-02-20T22:09:11.1083708Z +    ERROR_CHEVALIER_REQUIRED = (
2026-02-20T22:09:11.1084213Z +        "Seuls les Chevaliers Jedi et supérieurs peuvent effectuer cette action."
2026-02-20T22:09:11.1084322Z +    )
2026-02-20T22:09:11.1084424Z +
2026-02-20T22:09:11.1084543Z      # Progression
2026-02-20T22:09:11.1084965Z      SUCCESS_PROGRESS_RESET = "Ta progression a été réinitialisée."
2026-02-20T22:09:11.1085378Z      INFO_LEVEL_UP = "Félicitations ! Tu as atteint le niveau {level}."
2026-02-20T22:09:11.1085904Z      INFO_ACHIEVEMENT_UNLOCKED = "Nouvel accomplissement débloqué : {achievement}"
2026-02-20T22:09:11.1086021Z -    
2026-02-20T22:09:11.1086126Z +
2026-02-20T22:09:11.1086268Z      # Gestion des utilisateurs
2026-02-20T22:09:11.1086620Z      SUCCESS_USER_CREATED = "Utilisateur créé avec succès."
2026-02-20T22:09:11.1087019Z      SUCCESS_USER_UPDATED = "Utilisateur mis à jour avec succès."
2026-02-20T22:09:11.1087391Z      SUCCESS_USER_DELETED = "Utilisateur supprimé avec succès."
2026-02-20T22:09:11.1087696Z      ERROR_USER_NOT_FOUND = "Utilisateur non trouvé."
2026-02-20T22:09:11.1088074Z -    ERROR_CANNOT_DELETE_SELF = "Vous ne pouvez pas supprimer votre propre compte." 
2026-02-20T22:09:11.1088219Z \ No newline at end of file
2026-02-20T22:09:11.1088579Z +    ERROR_CANNOT_DELETE_SELF = "Vous ne pouvez pas supprimer votre propre compte."
2026-02-20T22:09:11.1089023Z --- /home/runner/work/mathakine/mathakine/app/db/adapter.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.1089458Z +++ /home/runner/work/mathakine/mathakine/app/db/adapter.py	2026-02-20 22:09:11.081802+00:00
2026-02-20T22:09:11.1089800Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.1089907Z  """
2026-02-20T22:09:11.1090219Z  Adaptateur de base de données pour Mathakine.
2026-02-20T22:09:11.1090952Z  Fournit une interface unifiée entre les modèles SQLAlchemy et les requêtes SQL directes.
2026-02-20T22:09:11.1091072Z  """
2026-02-20T22:09:11.1091183Z +
2026-02-20T22:09:11.1091435Z  from typing import Any, Dict, List, Optional, Type, Union
2026-02-20T22:09:11.1091537Z  
2026-02-20T22:09:11.1091726Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.1091824Z  
2026-02-20T22:09:11.1091964Z  logger = get_logger(__name__)
2026-02-20T22:09:11.1092079Z @@ -18,193 +19,221 @@
2026-02-20T22:09:11.1092190Z      """
2026-02-20T22:09:11.1092521Z      Adaptateur pour les opérations de base de données.
2026-02-20T22:09:11.1093181Z      Permet d'utiliser une approche unifiée pour les opérations sur les modèles,
2026-02-20T22:09:11.1093590Z      que ce soit via SQLAlchemy ou via des requêtes SQL directes.
2026-02-20T22:09:11.1093702Z      """
2026-02-20T22:09:11.1093806Z -    
2026-02-20T22:09:11.1093910Z +
2026-02-20T22:09:11.1094037Z      @staticmethod
2026-02-20T22:09:11.1094390Z      def get_by_id(db: Session, model_class: Type[Base], id: int) -> Optional[Base]:
2026-02-20T22:09:11.1094501Z          """
2026-02-20T22:09:11.1094740Z          Récupère un objet par son ID.
2026-02-20T22:09:11.1094850Z -        
2026-02-20T22:09:11.1094955Z +
2026-02-20T22:09:11.1095062Z          Args:
2026-02-20T22:09:11.1095300Z              db: Session de base de données
2026-02-20T22:09:11.1095588Z              model_class: Classe du modèle à récupérer
2026-02-20T22:09:11.1095816Z              id: ID de l'objet à récupérer
2026-02-20T22:09:11.1095934Z -            
2026-02-20T22:09:11.1096036Z +
2026-02-20T22:09:11.1096148Z          Returns:
2026-02-20T22:09:11.1096504Z              L'objet correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:11.1096632Z          """
2026-02-20T22:09:11.1096741Z          try:
2026-02-20T22:09:11.1097033Z              return db.query(model_class).filter(model_class.id == id).first()
2026-02-20T22:09:11.1097182Z          except Exception as e:
2026-02-20T22:09:11.1097800Z -            logger.error(f"Erreur lors de la récupération de {model_class.__name__} avec id={id}: {e}")
2026-02-20T22:09:11.1097933Z +            logger.error(
2026-02-20T22:09:11.1098440Z +                f"Erreur lors de la récupération de {model_class.__name__} avec id={id}: {e}"
2026-02-20T22:09:11.1098548Z +            )
2026-02-20T22:09:11.1098670Z              return None
2026-02-20T22:09:11.1098773Z -    
2026-02-20T22:09:11.1098895Z -    @staticmethod
2026-02-20T22:09:11.1099357Z -    def get_by_field(db: Session, model_class: Type[Base], field_name: str, value: Any) -> List[Base]:
2026-02-20T22:09:11.1099461Z +
2026-02-20T22:09:11.1099586Z +    @staticmethod
2026-02-20T22:09:11.1099710Z +    def get_by_field(
2026-02-20T22:09:11.1100005Z +        db: Session, model_class: Type[Base], field_name: str, value: Any
2026-02-20T22:09:11.1100134Z +    ) -> List[Base]:
2026-02-20T22:09:11.1100238Z          """
2026-02-20T22:09:11.1100542Z          Récupère des objets par la valeur d'un champ.
2026-02-20T22:09:11.1100649Z -        
2026-02-20T22:09:11.1100761Z +
2026-02-20T22:09:11.1100876Z          Args:
2026-02-20T22:09:11.1101112Z              db: Session de base de données
2026-02-20T22:09:11.1101393Z              model_class: Classe du modèle à récupérer
2026-02-20T22:09:11.1101637Z              field_name: Nom du champ à filtrer
2026-02-20T22:09:11.1101849Z              value: Valeur à rechercher
2026-02-20T22:09:11.1101958Z -            
2026-02-20T22:09:11.1102066Z +
2026-02-20T22:09:11.1102175Z          Returns:
2026-02-20T22:09:11.1102344Z              Liste des objets correspondants
2026-02-20T22:09:11.1102456Z          """
2026-02-20T22:09:11.1102561Z          try:
2026-02-20T22:09:11.1103145Z -            return db.query(model_class).filter(getattr(model_class, field_name) == value).all()
2026-02-20T22:09:11.1103503Z -        except Exception as e:
2026-02-20T22:09:11.1104220Z -            logger.error(f"Erreur lors de la récupération de {model_class.__name__} avec {field_name}={value}: {e}")
2026-02-20T22:09:11.1104341Z -            return []
2026-02-20T22:09:11.1104629Z -    
2026-02-20T22:09:11.1104773Z -    @staticmethod
2026-02-20T22:09:11.1105295Z -    def list_active(db: Session, model_class: Type[Base], limit: int = None, offset: int = None) -> List[Base]:
2026-02-20T22:09:11.1105413Z +            return (
2026-02-20T22:09:11.1105563Z +                db.query(model_class)
2026-02-20T22:09:11.1105794Z +                .filter(getattr(model_class, field_name) == value)
2026-02-20T22:09:11.1105907Z +                .all()
2026-02-20T22:09:11.1106016Z +            )
2026-02-20T22:09:11.1106159Z +        except Exception as e:
2026-02-20T22:09:11.1106287Z +            logger.error(
2026-02-20T22:09:11.1106899Z +                f"Erreur lors de la récupération de {model_class.__name__} avec {field_name}={value}: {e}"
2026-02-20T22:09:11.1107028Z +            )
2026-02-20T22:09:11.1107146Z +            return []
2026-02-20T22:09:11.1107249Z +
2026-02-20T22:09:11.1107362Z +    @staticmethod
2026-02-20T22:09:11.1107493Z +    def list_active(
2026-02-20T22:09:11.1107838Z +        db: Session, model_class: Type[Base], limit: int = None, offset: int = None
2026-02-20T22:09:11.1107963Z +    ) -> List[Base]:
2026-02-20T22:09:11.1108076Z          """
2026-02-20T22:09:11.1108399Z          Liste les objets actifs (non archivés) d'un modèle.
2026-02-20T22:09:11.1108506Z -        
2026-02-20T22:09:11.1108608Z +
2026-02-20T22:09:11.1108725Z          Args:
2026-02-20T22:09:11.1108959Z              db: Session de base de données
2026-02-20T22:09:11.1109221Z              model_class: Classe du modèle à lister
2026-02-20T22:09:11.1109504Z              limit: Nombre maximum d'objets à retourner
2026-02-20T22:09:11.1109762Z              offset: Décalage pour la pagination
2026-02-20T22:09:11.1109882Z -            
2026-02-20T22:09:11.1109991Z +
2026-02-20T22:09:11.1110099Z          Returns:
2026-02-20T22:09:11.1110238Z              Liste des objets actifs
2026-02-20T22:09:11.1110344Z          """
2026-02-20T22:09:11.1110456Z          try:
2026-02-20T22:09:11.1110616Z              query = db.query(model_class)
2026-02-20T22:09:11.1110721Z -            
2026-02-20T22:09:11.1110824Z +
2026-02-20T22:09:11.1111173Z              # Filtrer par is_archived si le modèle a cet attribut
2026-02-20T22:09:11.1111353Z -            if hasattr(model_class, 'is_archived'):
2026-02-20T22:09:11.1111663Z -                query = query.filter(getattr(model_class, 'is_archived') == False)
2026-02-20T22:09:11.1111779Z -            
2026-02-20T22:09:11.1111947Z +            if hasattr(model_class, "is_archived"):
2026-02-20T22:09:11.1112241Z +                query = query.filter(getattr(model_class, "is_archived") == False)
2026-02-20T22:09:11.1112353Z +
2026-02-20T22:09:11.1112634Z              # Appliquer limit et offset si spécifiés
2026-02-20T22:09:11.1112779Z              if offset is not None:
2026-02-20T22:09:11.1112936Z                  query = query.offset(offset)
2026-02-20T22:09:11.1113245Z              if limit is not None:
2026-02-20T22:09:11.1113392Z                  query = query.limit(limit)
2026-02-20T22:09:11.1113513Z -                
2026-02-20T22:09:11.1113620Z +
2026-02-20T22:09:11.1113750Z              return query.all()
2026-02-20T22:09:11.1113885Z          except Exception as e:
2026-02-20T22:09:11.1114264Z -            logger.error(f"Erreur lors de la liste des {model_class.__name__} actifs: {e}")
2026-02-20T22:09:11.1114377Z -            return []
2026-02-20T22:09:11.1114483Z -    
2026-02-20T22:09:11.1114600Z -    @staticmethod
2026-02-20T22:09:11.1115025Z -    def create(db: Session, model_class: Type[Base], data: Dict[str, Any]) -> Optional[Base]:
2026-02-20T22:09:11.1115154Z +            logger.error(
2026-02-20T22:09:11.1115447Z +                f"Erreur lors de la liste des {model_class.__name__} actifs: {e}"
2026-02-20T22:09:11.1115772Z +            )
2026-02-20T22:09:11.1115892Z +            return []
2026-02-20T22:09:11.1115997Z +
2026-02-20T22:09:11.1116111Z +    @staticmethod
2026-02-20T22:09:11.1116230Z +    def create(
2026-02-20T22:09:11.1116640Z +        db: Session, model_class: Type[Base], data: Dict[str, Any]
2026-02-20T22:09:11.1116785Z +    ) -> Optional[Base]:
2026-02-20T22:09:11.1116901Z          """
2026-02-20T22:09:11.1117218Z          Crée un nouvel objet dans la base de données.
2026-02-20T22:09:11.1117329Z -        
2026-02-20T22:09:11.1117436Z +
2026-02-20T22:09:11.1117544Z          Args:
2026-02-20T22:09:11.1117776Z              db: Session de base de données
2026-02-20T22:09:11.1118036Z              model_class: Classe du modèle à créer
2026-02-20T22:09:11.1118382Z              data: Dictionnaire contenant les données de l'objet
2026-02-20T22:09:11.1118489Z -            
2026-02-20T22:09:11.1118587Z +
2026-02-20T22:09:11.1118704Z          Returns:
2026-02-20T22:09:11.1118983Z              L'objet créé ou None en cas d'erreur
2026-02-20T22:09:11.1119088Z          """
2026-02-20T22:09:11.1119335Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.1119455Z              try:
2026-02-20T22:09:11.1119611Z                  obj = model_class(**data)
2026-02-20T22:09:11.1119745Z                  session.add(obj)
2026-02-20T22:09:11.1120055Z                  session.flush()  # Pour obtenir l'ID généré
2026-02-20T22:09:11.1120178Z                  return obj
2026-02-20T22:09:11.1120323Z              except Exception as e:
2026-02-20T22:09:11.1120818Z -                logger.error(f"Erreur lors de la création de {model_class.__name__}: {e}")
2026-02-20T22:09:11.1120955Z +                logger.error(
2026-02-20T22:09:11.1121352Z +                    f"Erreur lors de la création de {model_class.__name__}: {e}"
2026-02-20T22:09:11.1121466Z +                )
2026-02-20T22:09:11.1121597Z                  return None
2026-02-20T22:09:11.1121714Z -    
2026-02-20T22:09:11.1121818Z +
2026-02-20T22:09:11.1121936Z      @staticmethod
2026-02-20T22:09:11.1122222Z      def update(db: Session, obj: Base, data: Dict[str, Any]) -> bool:
2026-02-20T22:09:11.1122315Z          """
2026-02-20T22:09:11.1122525Z          Met à jour un objet existant.
2026-02-20T22:09:11.1122645Z -        
2026-02-20T22:09:11.1122743Z +
2026-02-20T22:09:11.1122846Z          Args:
2026-02-20T22:09:11.1123235Z              db: Session de base de données
2026-02-20T22:09:11.1123461Z              obj: Objet à mettre à jour
2026-02-20T22:09:11.1123693Z              data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:11.1123804Z -            
2026-02-20T22:09:11.1123915Z +
2026-02-20T22:09:11.1124024Z          Returns:
2026-02-20T22:09:11.1124324Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:11.1124440Z          """
2026-02-20T22:09:11.1124684Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.1124811Z              try:
2026-02-20T22:09:11.1125138Z                  # S'assurer que l'objet est attaché à la session
2026-02-20T22:09:11.1125288Z                  if obj not in session:
2026-02-20T22:09:11.1125637Z                      # Récupérer l'objet depuis la session si possible
2026-02-20T22:09:11.1125825Z -                    obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.1125998Z +                    obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.1126123Z                      if obj_id:
2026-02-20T22:09:11.1126510Z -                        obj = session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.1126643Z +                        obj = (
2026-02-20T22:09:11.1126816Z +                            session.query(obj.__class__)
2026-02-20T22:09:11.1126995Z +                            .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.1127122Z +                            .first()
2026-02-20T22:09:11.1127244Z +                        )
2026-02-20T22:09:11.1127592Z                          if not obj:
2026-02-20T22:09:11.1128219Z -                            logger.error(f"Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la session")
2026-02-20T22:09:11.1128365Z +                            logger.error(
2026-02-20T22:09:11.1129059Z +                                f"Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la session"
2026-02-20T22:09:11.1129193Z +                            )
2026-02-20T22:09:11.1129350Z                              return False
2026-02-20T22:09:11.1129469Z                      else:
2026-02-20T22:09:11.1129635Z                          # Si pas d'ID, merger l'objet
2026-02-20T22:09:11.1129799Z                          obj = session.merge(obj)
2026-02-20T22:09:11.1129908Z -                
2026-02-20T22:09:11.1130013Z +
2026-02-20T22:09:11.1130265Z                  # Mettre à jour les attributs
2026-02-20T22:09:11.1130432Z                  for key, value in data.items():
2026-02-20T22:09:11.1130575Z                      if hasattr(obj, key):
2026-02-20T22:09:11.1130733Z                          setattr(obj, key, value)
2026-02-20T22:09:11.1130870Z                  session.flush()
2026-02-20T22:09:11.1130996Z                  return True
2026-02-20T22:09:11.1131131Z              except Exception as e:
2026-02-20T22:09:11.1131864Z -                logger.error(f"Erreur lors de la mise à jour de {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}): {e}")
2026-02-20T22:09:11.1132005Z +                logger.error(
2026-02-20T22:09:11.1132628Z +                    f"Erreur lors de la mise à jour de {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}): {e}"
2026-02-20T22:09:11.1132740Z +                )
2026-02-20T22:09:11.1132872Z                  return False
2026-02-20T22:09:11.1133155Z -    
2026-02-20T22:09:11.1133263Z +
2026-02-20T22:09:11.1133385Z      @staticmethod
2026-02-20T22:09:11.1133570Z      def archive(db: Session, obj: Base) -> bool:
2026-02-20T22:09:11.1133676Z          """
2026-02-20T22:09:11.1134132Z          Archive un objet (marque comme supprimé sans suppression physique).
2026-02-20T22:09:11.1134246Z -        
2026-02-20T22:09:11.1134343Z +
2026-02-20T22:09:11.1134450Z          Args:
2026-02-20T22:09:11.1134690Z              db: Session de base de données
2026-02-20T22:09:11.1134899Z              obj: Objet à archiver
2026-02-20T22:09:11.1135007Z -            
2026-02-20T22:09:11.1135108Z +
2026-02-20T22:09:11.1135226Z          Returns:
2026-02-20T22:09:11.1135497Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:11.1135604Z          """
2026-02-20T22:09:11.1135824Z          return TransactionManager.safe_archive(db, obj)
2026-02-20T22:09:11.1135929Z -    
2026-02-20T22:09:11.1136030Z +
2026-02-20T22:09:11.1136144Z      @staticmethod
2026-02-20T22:09:11.1136328Z      def delete(db: Session, obj: Base) -> bool:
2026-02-20T22:09:11.1136432Z          """
2026-02-20T22:09:11.1136782Z          Supprime physiquement un objet de la base de données.
2026-02-20T22:09:11.1137164Z          Les suppressions en cascade sont gérées automatiquement.
2026-02-20T22:09:11.1137274Z -        
2026-02-20T22:09:11.1137378Z +
2026-02-20T22:09:11.1137487Z          Args:
2026-02-20T22:09:11.1137721Z              db: Session de base de données
2026-02-20T22:09:11.1137931Z              obj: Objet à supprimer
2026-02-20T22:09:11.1138047Z -            
2026-02-20T22:09:11.1138154Z +
2026-02-20T22:09:11.1138263Z          Returns:
2026-02-20T22:09:11.1138553Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:11.1138660Z          """
2026-02-20T22:09:11.1138872Z          return TransactionManager.safe_delete(db, obj)
2026-02-20T22:09:11.1138974Z -    
2026-02-20T22:09:11.1139090Z -    @staticmethod
2026-02-20T22:09:11.1139625Z -    def execute_query(db: Session, query: str, params: Optional[Dict[str, Any]] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:11.1139731Z +
2026-02-20T22:09:11.1139847Z +    @staticmethod
2026-02-20T22:09:11.1139983Z +    def execute_query(
2026-02-20T22:09:11.1140554Z +        db: Session, query: str, params: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.1140699Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:11.1140808Z          """
2026-02-20T22:09:11.1141105Z          Exécute une requête SQL personnalisée.
2026-02-20T22:09:11.1141213Z  
2026-02-20T22:09:11.1141878Z          SÉCURITÉ (audit 3.1) : params doit être un dict pour des paramètres nommés.
2026-02-20T22:09:11.1142409Z          Ne jamais concaténer de données utilisateur dans query. Utiliser exclusivement
2026-02-20T22:09:11.1142925Z          des paramètres nommés (ex: SELECT * FROM t WHERE id = :id avec params={"id": 1}).
2026-02-20T22:09:11.1143207Z -        
2026-02-20T22:09:11.1143321Z +
2026-02-20T22:09:11.1143432Z          Args:
2026-02-20T22:09:11.1143676Z              db: Session de base de données
2026-02-20T22:09:11.1144048Z              query: Requête SQL avec paramètres nommés (:param_name)
2026-02-20T22:09:11.1144396Z              params: Dictionnaire de paramètres nommés (ou None)
2026-02-20T22:09:11.1144524Z -            
2026-02-20T22:09:11.1144624Z +
2026-02-20T22:09:11.1144744Z          Returns:
2026-02-20T22:09:11.1145060Z              Liste de dictionnaires contenant les résultats
2026-02-20T22:09:11.1145167Z          """
2026-02-20T22:09:11.1145424Z          if params is not None and not isinstance(params, dict):
2026-02-20T22:09:11.1145577Z              raise TypeError(
2026-02-20T22:09:11.1146057Z                  "execute_query exige params de type dict pour des paramètres nommés. "
2026-02-20T22:09:11.1146551Z -                "Utiliser :param_name dans la requête et params={\"param_name\": value}."
2026-02-20T22:09:11.1147032Z +                'Utiliser :param_name dans la requête et params={"param_name": value}.'
2026-02-20T22:09:11.1147137Z              )
2026-02-20T22:09:11.1147352Z          safe_params = params if params is not None else {}
2026-02-20T22:09:11.1147463Z          try:
2026-02-20T22:09:11.1147660Z              result = db.execute(text(query), safe_params)
2026-02-20T22:09:11.1147815Z              if result.returns_rows:
2026-02-20T22:09:11.1147923Z @@ -212,6 +241,6 @@
2026-02-20T22:09:11.1148244Z                  return [dict(zip(column_names, row)) for row in result.fetchall()]
2026-02-20T22:09:11.1148367Z              return []
2026-02-20T22:09:11.1148517Z          except Exception as e:
2026-02-20T22:09:11.1148964Z              logger.error(f"Erreur lors de l'exécution de la requête SQL: {e}")
2026-02-20T22:09:11.1149094Z              db.rollback()
2026-02-20T22:09:11.1149220Z -            return [] 
2026-02-20T22:09:11.1149357Z \ No newline at end of file
2026-02-20T22:09:11.1149486Z +            return []
2026-02-20T22:09:11.1380926Z --- /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1383157Z +++ /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py	2026-02-20 22:09:11.136648+00:00
2026-02-20T22:09:11.1383309Z @@ -1,23 +1,31 @@
2026-02-20T22:09:11.1383844Z  """
2026-02-20T22:09:11.1384347Z  Modèle pour le journal d'audit des actions admin.
2026-02-20T22:09:11.1384460Z  """
2026-02-20T22:09:11.1384567Z +
2026-02-20T22:09:11.1385773Z  from sqlalchemy import Column, DateTime, ForeignKey, Integer, String, Text
2026-02-20T22:09:11.1385978Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.1386125Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.1386227Z  
2026-02-20T22:09:11.1386377Z  from app.db.base import Base
2026-02-20T22:09:11.1386481Z  
2026-02-20T22:09:11.1386587Z  
2026-02-20T22:09:11.1386721Z  class AdminAuditLog(Base):
2026-02-20T22:09:11.1387157Z      """Journal des actions effectuées par les administrateurs."""
2026-02-20T22:09:11.1387251Z +
2026-02-20T22:09:11.1387379Z      __tablename__ = "admin_audit_logs"
2026-02-20T22:09:11.1387476Z  
2026-02-20T22:09:11.1387677Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1388152Z -    admin_user_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.1388598Z -    action = Column(String(50), nullable=False, index=True)  # user_patch, exercise_create, etc.
2026-02-20T22:09:11.1389010Z -    resource_type = Column(String(30), nullable=True, index=True)  # user, exercise, challenge
2026-02-20T22:09:11.1389373Z +    admin_user_id = Column(
2026-02-20T22:09:11.1389738Z +        Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True, index=True
2026-02-20T22:09:11.1389858Z +    )
2026-02-20T22:09:11.1389976Z +    action = Column(
2026-02-20T22:09:11.1390135Z +        String(50), nullable=False, index=True
2026-02-20T22:09:11.1390291Z +    )  # user_patch, exercise_create, etc.
2026-02-20T22:09:11.1390418Z +    resource_type = Column(
2026-02-20T22:09:11.1390569Z +        String(30), nullable=True, index=True
2026-02-20T22:09:11.1390702Z +    )  # user, exercise, challenge
2026-02-20T22:09:11.1390886Z      resource_id = Column(Integer, nullable=True)
2026-02-20T22:09:11.1391393Z      details = Column(Text, nullable=True)  # JSON string avec infos complémentaires
2026-02-20T22:09:11.1391710Z      created_at = Column(DateTime(timezone=True), server_default=func.now())
2026-02-20T22:09:11.1391831Z  
2026-02-20T22:09:11.1392121Z      admin_user = relationship("User", foreign_keys=[admin_user_id])
2026-02-20T22:09:11.1392569Z would reformat /home/runner/work/mathakine/mathakine/app/models/admin_audit_log.py
2026-02-20T22:09:11.1473968Z --- /home/runner/work/mathakine/mathakine/app/db/queries.py	2026-02-20 22:09:02.808965+00:00
2026-02-20T22:09:11.1476710Z +++ /home/runner/work/mathakine/mathakine/app/db/queries.py	2026-02-20 22:09:11.136877+00:00
2026-02-20T22:09:11.1477942Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.1478173Z  """
2026-02-20T22:09:11.1478820Z  Requêtes SQL centralisées pour l'application Mathakine
2026-02-20T22:09:11.1479352Z would reformat /home/runner/work/mathakine/mathakine/app/db/queries.py
2026-02-20T22:09:11.1480042Z  Ce fichier contient toutes les requêtes SQL utilisées dans l'application.
2026-02-20T22:09:11.1480359Z  """
2026-02-20T22:09:11.1480467Z +
2026-02-20T22:09:11.1480572Z  
2026-02-20T22:09:11.1480860Z  # Requêtes pour la table 'exercises'
2026-02-20T22:09:11.1480994Z  class ExerciseQueries:
2026-02-20T22:09:11.1481271Z      # Création et modification avec optimisations
2026-02-20T22:09:11.1481416Z      CREATE_TABLE = """
2026-02-20T22:09:11.1481529Z @@ -35,137 +36,138 @@
2026-02-20T22:09:11.1482006Z      CREATE INDEX IF NOT EXISTS idx_exercises_creator ON exercises(creator_id) WHERE is_archived = false;
2026-02-20T22:09:11.1482521Z      CREATE INDEX IF NOT EXISTS idx_exercises_created_at ON exercises(created_at DESC) WHERE is_archived = false;
2026-02-20T22:09:11.1483215Z      CREATE INDEX IF NOT EXISTS idx_exercises_view_count ON exercises(view_count DESC) WHERE is_archived = false;
2026-02-20T22:09:11.1483719Z      CREATE INDEX IF NOT EXISTS idx_exercises_ai_generated ON exercises(ai_generated) WHERE is_archived = false;
2026-02-20T22:09:11.1483830Z      """
2026-02-20T22:09:11.1484183Z -    
2026-02-20T22:09:11.1484285Z +
2026-02-20T22:09:11.1484575Z      # Sélection optimisée avec LIMIT par défaut
2026-02-20T22:09:11.1484695Z      GET_ALL = """
2026-02-20T22:09:11.1484830Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1484964Z      WHERE is_archived = false
2026-02-20T22:09:11.1485113Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1485236Z      LIMIT 100
2026-02-20T22:09:11.1485344Z      """
2026-02-20T22:09:11.1485450Z -    
2026-02-20T22:09:11.1485571Z +
2026-02-20T22:09:11.1485695Z      GET_BY_ID = """
2026-02-20T22:09:11.1485828Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1485995Z      WHERE id = %s AND is_archived = false
2026-02-20T22:09:11.1486102Z      """
2026-02-20T22:09:11.1486206Z -    
2026-02-20T22:09:11.1486304Z +
2026-02-20T22:09:11.1486582Z      # Requêtes optimisées avec index hints
2026-02-20T22:09:11.1486712Z      GET_BY_TYPE = """
2026-02-20T22:09:11.1486847Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1487060Z      WHERE exercise_type = %s AND is_archived = false
2026-02-20T22:09:11.1487293Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1487404Z      LIMIT 50
2026-02-20T22:09:11.1487514Z      """
2026-02-20T22:09:11.1487630Z -    
2026-02-20T22:09:11.1487734Z +
2026-02-20T22:09:11.1487873Z      GET_BY_DIFFICULTY = """
2026-02-20T22:09:11.1488241Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1488459Z      WHERE difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1488598Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1488712Z      LIMIT 50
2026-02-20T22:09:11.1488825Z      """
2026-02-20T22:09:11.1488928Z -    
2026-02-20T22:09:11.1489031Z +
2026-02-20T22:09:11.1489186Z      GET_BY_TYPE_AND_DIFFICULTY = """
2026-02-20T22:09:11.1489312Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1489622Z      WHERE exercise_type = %s AND difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1489759Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1489876Z      LIMIT 50
2026-02-20T22:09:11.1489979Z      """
2026-02-20T22:09:11.1490091Z -    
2026-02-20T22:09:11.1490204Z +
2026-02-20T22:09:11.1490770Z      # Requêtes aléatoires optimisées avec TABLESAMPLE pour de meilleures performances
2026-02-20T22:09:11.1490896Z      GET_RANDOM = """
2026-02-20T22:09:11.1491029Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1491170Z      WHERE is_archived = false
2026-02-20T22:09:11.1491302Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1491410Z      LIMIT 1
2026-02-20T22:09:11.1491515Z      """
2026-02-20T22:09:11.1491602Z -    
2026-02-20T22:09:11.1491687Z +
2026-02-20T22:09:11.1491796Z      GET_RANDOM_BY_TYPE = """
2026-02-20T22:09:11.1491911Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1492075Z      WHERE exercise_type = %s AND is_archived = false
2026-02-20T22:09:11.1492177Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1492271Z      LIMIT 1
2026-02-20T22:09:11.1492357Z      """
2026-02-20T22:09:11.1492441Z -    
2026-02-20T22:09:11.1492528Z +
2026-02-20T22:09:11.1492654Z      GET_RANDOM_BY_DIFFICULTY = """
2026-02-20T22:09:11.1492760Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1492931Z      WHERE difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1493231Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1493320Z      LIMIT 1
2026-02-20T22:09:11.1493410Z      """
2026-02-20T22:09:11.1493497Z -    
2026-02-20T22:09:11.1493585Z +
2026-02-20T22:09:11.1493732Z      GET_RANDOM_BY_TYPE_AND_DIFFICULTY = """
2026-02-20T22:09:11.1493840Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1494097Z      WHERE exercise_type = %s AND difficulty = %s AND is_archived = false
2026-02-20T22:09:11.1494208Z      ORDER BY RANDOM() 
2026-02-20T22:09:11.1494300Z      LIMIT 1
2026-02-20T22:09:11.1494392Z      """
2026-02-20T22:09:11.1494474Z -    
2026-02-20T22:09:11.1494556Z +
2026-02-20T22:09:11.1494788Z      # Requête optimisée pour la pagination
2026-02-20T22:09:11.1494908Z      GET_PAGINATED = """
2026-02-20T22:09:11.1495019Z      SELECT * FROM exercises 
2026-02-20T22:09:11.1495138Z      WHERE is_archived = false
2026-02-20T22:09:11.1495259Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1495581Z      LIMIT %s OFFSET %s
2026-02-20T22:09:11.1495674Z      """
2026-02-20T22:09:11.1495767Z -    
2026-02-20T22:09:11.1495862Z +
2026-02-20T22:09:11.1496006Z      # Comptage optimisé
2026-02-20T22:09:11.1496114Z      COUNT_ACTIVE = """
2026-02-20T22:09:11.1496259Z      SELECT COUNT(*) FROM exercises 
2026-02-20T22:09:11.1496384Z      WHERE is_archived = false
2026-02-20T22:09:11.1496479Z      """
2026-02-20T22:09:11.1496576Z -    
2026-02-20T22:09:11.1496675Z +
2026-02-20T22:09:11.1496861Z      # Insertion avec RETURNING optimisé
2026-02-20T22:09:11.1496962Z      INSERT = """
2026-02-20T22:09:11.1497071Z      INSERT INTO exercises 
2026-02-20T22:09:11.1497404Z      (title, creator_id, exercise_type, difficulty, tags, question, correct_answer, 
2026-02-20T22:09:11.1497656Z      choices, explanation, hint, image_url, audio_url, ai_generated) 
2026-02-20T22:09:11.1497864Z      VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
2026-02-20T22:09:11.1497989Z      RETURNING id, created_at
2026-02-20T22:09:11.1498091Z      """
2026-02-20T22:09:11.1498185Z -    
2026-02-20T22:09:11.1498282Z +
2026-02-20T22:09:11.1498444Z      # Mise à jour
2026-02-20T22:09:11.1498550Z      UPDATE = """
2026-02-20T22:09:11.1498660Z      UPDATE exercises 
2026-02-20T22:09:11.1499158Z      SET title = %s, exercise_type = %s, difficulty = %s, tags = %s, question = %s, 
2026-02-20T22:09:11.1499496Z      correct_answer = %s, choices = %s, explanation = %s, hint = %s, image_url = %s, 
2026-02-20T22:09:11.1499686Z      audio_url = %s, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1499802Z      WHERE id = %s
2026-02-20T22:09:11.1499902Z      """
2026-02-20T22:09:11.1499991Z -    
2026-02-20T22:09:11.1500083Z +
2026-02-20T22:09:11.1500188Z      ARCHIVE = """
2026-02-20T22:09:11.1500294Z      UPDATE exercises 
2026-02-20T22:09:11.1500488Z      SET is_archived = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1500594Z      WHERE id = %s
2026-02-20T22:09:11.1500680Z      """
2026-02-20T22:09:11.1500772Z -    
2026-02-20T22:09:11.1500851Z +
2026-02-20T22:09:11.1500948Z      ACTIVATE = """
2026-02-20T22:09:11.1501045Z      UPDATE exercises 
2026-02-20T22:09:11.1501212Z      SET is_active = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1501335Z      WHERE id = %s
2026-02-20T22:09:11.1501444Z      """
2026-02-20T22:09:11.1501531Z -    
2026-02-20T22:09:11.1501620Z +
2026-02-20T22:09:11.1501753Z      DEACTIVATE = """
2026-02-20T22:09:11.1501865Z      UPDATE exercises 
2026-02-20T22:09:11.1502070Z      SET is_active = false, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1502185Z      WHERE id = %s
2026-02-20T22:09:11.1502278Z      """
2026-02-20T22:09:11.1502360Z -    
2026-02-20T22:09:11.1502463Z +
2026-02-20T22:09:11.1502586Z      # Suppression
2026-02-20T22:09:11.1502695Z      DELETE = """
2026-02-20T22:09:11.1502814Z      UPDATE exercises 
2026-02-20T22:09:11.1503211Z      SET is_archived = true, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1503331Z      WHERE id = %s
2026-02-20T22:09:11.1503443Z      """
2026-02-20T22:09:11.1503549Z -    
2026-02-20T22:09:11.1503657Z +
2026-02-20T22:09:11.1504158Z      # Suppression physique (pour administration avancée ou migrations)
2026-02-20T22:09:11.1504301Z      DELETE_PERMANENT = """
2026-02-20T22:09:11.1504446Z      DELETE FROM exercises 
2026-02-20T22:09:11.1504571Z      WHERE id = %s
2026-02-20T22:09:11.1504679Z      """
2026-02-20T22:09:11.1504783Z +
2026-02-20T22:09:11.1504894Z  
2026-02-20T22:09:11.1505134Z  # Requêtes pour la table 'results'
2026-02-20T22:09:11.1505269Z  class ResultQueries:
2026-02-20T22:09:11.1505490Z      # Création et modification
2026-02-20T22:09:11.1505618Z      CREATE_TABLE = """
2026-02-20T22:09:11.1505736Z @@ -176,38 +178,39 @@
2026-02-20T22:09:11.1505867Z          attempt_count INTEGER,
2026-02-20T22:09:11.1506001Z          time_spent REAL,
2026-02-20T22:09:11.1506214Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1506321Z      )
2026-02-20T22:09:11.1506433Z      """
2026-02-20T22:09:11.1506763Z -    
2026-02-20T22:09:11.1506871Z +
2026-02-20T22:09:11.1507052Z      # Sélection
2026-02-20T22:09:11.1507193Z      GET_BY_USER = """
2026-02-20T22:09:11.1507321Z      SELECT * FROM results 
2026-02-20T22:09:11.1507445Z      WHERE user_id = %s
2026-02-20T22:09:11.1507599Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1507704Z      """
2026-02-20T22:09:11.1507805Z -    
2026-02-20T22:09:11.1507912Z +
2026-02-20T22:09:11.1508050Z      GET_BY_EXERCISE = """
2026-02-20T22:09:11.1508178Z      SELECT * FROM results 
2026-02-20T22:09:11.1508306Z      WHERE exercise_id = %s
2026-02-20T22:09:11.1508451Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1508558Z      """
2026-02-20T22:09:11.1508662Z -    
2026-02-20T22:09:11.1508765Z +
2026-02-20T22:09:11.1508913Z      GET_BY_USER_AND_EXERCISE = """
2026-02-20T22:09:11.1509036Z      SELECT * FROM results 
2026-02-20T22:09:11.1509200Z      WHERE user_id = %s AND exercise_id = %s
2026-02-20T22:09:11.1509340Z      ORDER BY created_at DESC
2026-02-20T22:09:11.1509453Z      """
2026-02-20T22:09:11.1509558Z -    
2026-02-20T22:09:11.1509662Z +
2026-02-20T22:09:11.1509787Z      # Insertion
2026-02-20T22:09:11.1509903Z      INSERT = """
2026-02-20T22:09:11.1510039Z      INSERT INTO results 
2026-02-20T22:09:11.1510467Z      (exercise_id, is_correct, attempt_count, time_spent) 
2026-02-20T22:09:11.1510615Z      VALUES (%s, %s, %s, %s)
2026-02-20T22:09:11.1510735Z      RETURNING id
2026-02-20T22:09:11.1510843Z      """
2026-02-20T22:09:11.1510952Z  
2026-02-20T22:09:11.1511053Z +
2026-02-20T22:09:11.1511292Z  # Requêtes pour les statistiques
2026-02-20T22:09:11.1511437Z  class UserStatsQueries:
2026-02-20T22:09:11.1511608Z      # Statistiques globales par utilisateur
2026-02-20T22:09:11.1511742Z      GET_USER_STATS = """
2026-02-20T22:09:11.1511852Z      SELECT 
2026-02-20T22:09:11.1511973Z @@ -216,11 +219,11 @@
2026-02-20T22:09:11.1512261Z          AVG(CASE WHEN is_correct THEN 1 ELSE 0 END) * 100 as success_rate,
2026-02-20T22:09:11.1512412Z          AVG(time_taken) as avg_time_taken
2026-02-20T22:09:11.1512548Z      FROM results 
2026-02-20T22:09:11.1512671Z      WHERE user_id = %s
2026-02-20T22:09:11.1512774Z      """
2026-02-20T22:09:11.1512881Z -    
2026-02-20T22:09:11.1513195Z +
2026-02-20T22:09:11.1513367Z      # Statistiques par type d'exercice
2026-02-20T22:09:11.1513523Z      GET_USER_STATS_BY_TYPE = """
2026-02-20T22:09:11.1513640Z      SELECT 
2026-02-20T22:09:11.1513766Z          e.exercise_type,
2026-02-20T22:09:11.1513907Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1514031Z @@ -230,11 +233,11 @@
2026-02-20T22:09:11.1514149Z      FROM results r
2026-02-20T22:09:11.1514324Z      JOIN exercises e ON r.exercise_id = e.id
2026-02-20T22:09:11.1514449Z      WHERE r.user_id = %s
2026-02-20T22:09:11.1514595Z      GROUP BY e.exercise_type
2026-02-20T22:09:11.1514704Z      """
2026-02-20T22:09:11.1514808Z -    
2026-02-20T22:09:11.1514920Z +
2026-02-20T22:09:11.1515150Z      # Statistiques par niveau de difficulté
2026-02-20T22:09:11.1515309Z      GET_USER_STATS_BY_DIFFICULTY = """
2026-02-20T22:09:11.1515417Z      SELECT 
2026-02-20T22:09:11.1515549Z          e.difficulty,
2026-02-20T22:09:11.1515689Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1515801Z @@ -244,11 +247,11 @@
2026-02-20T22:09:11.1515924Z      FROM results r
2026-02-20T22:09:11.1516103Z      JOIN exercises e ON r.exercise_id = e.id
2026-02-20T22:09:11.1516229Z      WHERE r.user_id = %s
2026-02-20T22:09:11.1516361Z      GROUP BY e.difficulty
2026-02-20T22:09:11.1516474Z      """
2026-02-20T22:09:11.1516577Z -    
2026-02-20T22:09:11.1516681Z +
2026-02-20T22:09:11.1516859Z      # Progression dans le temps (par jour)
2026-02-20T22:09:11.1517007Z      GET_USER_PROGRESS_BY_DAY = """
2026-02-20T22:09:11.1517117Z      SELECT 
2026-02-20T22:09:11.1517276Z          DATE(r.created_at) as exercise_date,
2026-02-20T22:09:11.1517426Z          COUNT(*) as total_exercises,
2026-02-20T22:09:11.1517539Z @@ -268,10 +271,11 @@
2026-02-20T22:09:11.1517648Z      FROM results
2026-02-20T22:09:11.1518020Z      GROUP BY DATE(created_at)
2026-02-20T22:09:11.1518167Z      ORDER BY exercise_date DESC
2026-02-20T22:09:11.1518277Z      LIMIT 30
2026-02-20T22:09:11.1518384Z      """
2026-02-20T22:09:11.1518490Z +
2026-02-20T22:09:11.1518594Z  
2026-02-20T22:09:11.1518830Z  # Requêtes pour la table 'users'
2026-02-20T22:09:11.1518966Z  class UserQueries:
2026-02-20T22:09:11.1519172Z      # Création et modification
2026-02-20T22:09:11.1519299Z      CREATE_TABLE = """
2026-02-20T22:09:11.1519413Z @@ -284,62 +288,63 @@
2026-02-20T22:09:11.1519577Z          is_active BOOLEAN DEFAULT TRUE,
2026-02-20T22:09:11.1519720Z          is_admin BOOLEAN DEFAULT FALSE,
2026-02-20T22:09:11.1519941Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1520056Z      )
2026-02-20T22:09:11.1520168Z      """
2026-02-20T22:09:11.1520274Z -    
2026-02-20T22:09:11.1520377Z +
2026-02-20T22:09:11.1520560Z      # Sélection
2026-02-20T22:09:11.1520676Z      GET_ALL = """
2026-02-20T22:09:11.1521007Z      SELECT id, username, email, full_name, is_active, is_admin, created_at
2026-02-20T22:09:11.1521127Z      FROM users
2026-02-20T22:09:11.1521239Z      ORDER BY id
2026-02-20T22:09:11.1521341Z      """
2026-02-20T22:09:11.1521444Z -    
2026-02-20T22:09:11.1521553Z +
2026-02-20T22:09:11.1521676Z      GET_BY_ID = """
2026-02-20T22:09:11.1522184Z      SELECT id, username, email, full_name, is_active, is_admin, created_at
2026-02-20T22:09:11.1522319Z      FROM users
2026-02-20T22:09:11.1522435Z      WHERE id = %s
2026-02-20T22:09:11.1522542Z      """
2026-02-20T22:09:11.1522647Z -    
2026-02-20T22:09:11.1522756Z +
2026-02-20T22:09:11.1522892Z      GET_BY_USERNAME = """
2026-02-20T22:09:11.1523502Z      SELECT id, username, email, full_name, is_active, is_admin, created_at, hashed_password
2026-02-20T22:09:11.1523627Z      FROM users
2026-02-20T22:09:11.1523759Z      WHERE username = %s
2026-02-20T22:09:11.1523865Z      """
2026-02-20T22:09:11.1523969Z -    
2026-02-20T22:09:11.1524079Z +
2026-02-20T22:09:11.1524211Z      GET_BY_EMAIL = """
2026-02-20T22:09:11.1524610Z      SELECT id, username, email, full_name, is_active, is_admin, created_at, hashed_password
2026-02-20T22:09:11.1524727Z      FROM users
2026-02-20T22:09:11.1524849Z      WHERE email = %s
2026-02-20T22:09:11.1524954Z      """
2026-02-20T22:09:11.1525058Z -    
2026-02-20T22:09:11.1525175Z +
2026-02-20T22:09:11.1525290Z      # Insertion
2026-02-20T22:09:11.1525403Z      INSERT = """
2026-02-20T22:09:11.1525531Z      INSERT INTO users 
2026-02-20T22:09:11.1525835Z      (username, email, full_name, hashed_password, is_active, is_admin) 
2026-02-20T22:09:11.1525970Z      VALUES (%s, %s, %s, %s, %s, %s)
2026-02-20T22:09:11.1526083Z      RETURNING id
2026-02-20T22:09:11.1526197Z      """
2026-02-20T22:09:11.1526304Z -    
2026-02-20T22:09:11.1526409Z +
2026-02-20T22:09:11.1526611Z      # Mise à jour
2026-02-20T22:09:11.1526723Z      UPDATE = """
2026-02-20T22:09:11.1526840Z      UPDATE users 
2026-02-20T22:09:11.1527101Z      SET username = %s, email = %s, full_name = %s, is_active = %s
2026-02-20T22:09:11.1527238Z      WHERE id = %s
2026-02-20T22:09:11.1527349Z      """
2026-02-20T22:09:11.1527450Z -    
2026-02-20T22:09:11.1527562Z +
2026-02-20T22:09:11.1527700Z      UPDATE_PASSWORD = """
2026-02-20T22:09:11.1527813Z      UPDATE users 
2026-02-20T22:09:11.1527955Z      SET hashed_password = %s
2026-02-20T22:09:11.1528077Z      WHERE id = %s
2026-02-20T22:09:11.1528184Z      """
2026-02-20T22:09:11.1528288Z -    
2026-02-20T22:09:11.1528402Z +
2026-02-20T22:09:11.1528517Z      # Suppression
2026-02-20T22:09:11.1528635Z      DELETE = """
2026-02-20T22:09:11.1528762Z      DELETE FROM users 
2026-02-20T22:09:11.1528880Z      WHERE id = %s
2026-02-20T22:09:11.1528987Z      """
2026-02-20T22:09:11.1529090Z +
2026-02-20T22:09:11.1529200Z  
2026-02-20T22:09:11.1529440Z  # Requêtes pour la table 'settings'
2026-02-20T22:09:11.1529572Z  class SettingQueries:
2026-02-20T22:09:11.1529775Z      # Création et modification
2026-02-20T22:09:11.1529915Z      CREATE_TABLE = """
2026-02-20T22:09:11.1530244Z @@ -351,23 +356,23 @@
2026-02-20T22:09:11.1530406Z          is_active BOOLEAN DEFAULT TRUE,
2026-02-20T22:09:11.1530629Z          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
2026-02-20T22:09:11.1530845Z          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:11.1530963Z      )
2026-02-20T22:09:11.1531073Z      """
2026-02-20T22:09:11.1531184Z -    
2026-02-20T22:09:11.1531286Z +
2026-02-20T22:09:11.1531464Z      # Sélection
2026-02-20T22:09:11.1531595Z      GET_ALL = """
2026-02-20T22:09:11.1531727Z      SELECT * FROM settings
2026-02-20T22:09:11.1531858Z      WHERE is_active = true
2026-02-20T22:09:11.1531973Z      ORDER BY key
2026-02-20T22:09:11.1532084Z      """
2026-02-20T22:09:11.1532188Z -    
2026-02-20T22:09:11.1532290Z +
2026-02-20T22:09:11.1532421Z      GET_BY_KEY = """
2026-02-20T22:09:11.1532551Z      SELECT * FROM settings
2026-02-20T22:09:11.1532700Z      WHERE key = %s AND is_active = true
2026-02-20T22:09:11.1532799Z      """
2026-02-20T22:09:11.1532917Z -    
2026-02-20T22:09:11.1533195Z +
2026-02-20T22:09:11.1533314Z      # Insertion
2026-02-20T22:09:11.1533444Z      INSERT = """
2026-02-20T22:09:11.1533580Z      INSERT INTO settings 
2026-02-20T22:09:11.1533737Z      (key, value, description, is_active) 
2026-02-20T22:09:11.1534056Z      VALUES (%s, %s, %s, %s)
2026-02-20T22:09:11.1534194Z @@ -375,18 +380,18 @@
2026-02-20T22:09:11.1534363Z      DO UPDATE SET value = EXCLUDED.value, 
2026-02-20T22:09:11.1534562Z                   description = EXCLUDED.description,
2026-02-20T22:09:11.1534732Z                   updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1534846Z      RETURNING id
2026-02-20T22:09:11.1534951Z      """
2026-02-20T22:09:11.1535055Z -    
2026-02-20T22:09:11.1535166Z +
2026-02-20T22:09:11.1535362Z      # Mise à jour
2026-02-20T22:09:11.1535477Z      UPDATE = """
2026-02-20T22:09:11.1535612Z      UPDATE settings 
2026-02-20T22:09:11.1535891Z      SET value = %s, description = %s, updated_at = CURRENT_TIMESTAMP
2026-02-20T22:09:11.1536019Z      WHERE key = %s
2026-02-20T22:09:11.1536191Z      """
2026-02-20T22:09:11.1536309Z -    
2026-02-20T22:09:11.1536413Z +
2026-02-20T22:09:11.1536531Z      # Suppression
2026-02-20T22:09:11.1536649Z      DELETE = """
2026-02-20T22:09:11.1536779Z      DELETE FROM settings 
2026-02-20T22:09:11.1536905Z      WHERE key = %s
2026-02-20T22:09:11.1537014Z -    """ 
2026-02-20T22:09:11.1537164Z \ No newline at end of file
2026-02-20T22:09:11.1537269Z +    """
2026-02-20T22:09:11.1727174Z --- /home/runner/work/mathakine/mathakine/app/models/achievement.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1728990Z +++ /home/runner/work/mathakine/mathakine/app/models/achievement.py	2026-02-20 22:09:11.171493+00:00
2026-02-20T22:09:11.1730313Z @@ -1,22 +1,31 @@
2026-02-20T22:09:11.1731592Z  """
2026-02-20T22:09:11.1733423Z  Modèles SQLAlchemy pour le système de badges
2026-02-20T22:09:11.1734794Z  """
2026-02-20T22:09:11.1736449Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.1737849Z -                        Integer, String, Text)
2026-02-20T22:09:11.1758655Z +
2026-02-20T22:09:11.1758825Z +from sqlalchemy import (
2026-02-20T22:09:11.1758947Z +    JSON,
2026-02-20T22:09:11.1759063Z +    Boolean,
2026-02-20T22:09:11.1759175Z +    Column,
2026-02-20T22:09:11.1759307Z +    DateTime,
2026-02-20T22:09:11.1759438Z +    ForeignKey,
2026-02-20T22:09:11.1759552Z +    Index,
2026-02-20T22:09:11.1759665Z +    Integer,
2026-02-20T22:09:11.1759786Z +    String,
2026-02-20T22:09:11.1759901Z +    Text,
2026-02-20T22:09:11.1760006Z +)
2026-02-20T22:09:11.1760184Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.1760342Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.1760446Z  
2026-02-20T22:09:11.1760592Z  from app.db.base import Base
2026-02-20T22:09:11.1760709Z  
2026-02-20T22:09:11.1761407Z  
2026-02-20T22:09:11.1762144Z  class Achievement(Base):
2026-02-20T22:09:11.1762678Z      """Modèle pour les badges/achievements"""
2026-02-20T22:09:11.1763411Z +
2026-02-20T22:09:11.1763560Z      __tablename__ = "achievements"
2026-02-20T22:09:11.1763682Z -    __table_args__ = (
2026-02-20T22:09:11.1763903Z -        Index('idx_achievements_category', 'category'),
2026-02-20T22:09:11.1764015Z -    )
2026-02-20T22:09:11.1764309Z +    __table_args__ = (Index("idx_achievements_category", "category"),)
2026-02-20T22:09:11.1764428Z  
2026-02-20T22:09:11.1764638Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1764933Z      code = Column(String(100), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.1765113Z      name = Column(String(255), nullable=False)
2026-02-20T22:09:11.1765292Z      description = Column(Text, nullable=True)
2026-02-20T22:09:11.1765408Z @@ -29,28 +38,37 @@
2026-02-20T22:09:11.1765619Z      star_wars_title = Column(String(255), nullable=True)
2026-02-20T22:09:11.1765820Z      is_active = Column(Boolean, default=True, index=True)
2026-02-20T22:09:11.1766073Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.1766185Z  
2026-02-20T22:09:11.1766299Z      # Relations
2026-02-20T22:09:11.1766853Z -    user_achievements = relationship("UserAchievement", back_populates="achievement", cascade="all, delete-orphan")
2026-02-20T22:09:11.1767006Z +    user_achievements = relationship(
2026-02-20T22:09:11.1767604Z +        "UserAchievement", back_populates="achievement", cascade="all, delete-orphan"
2026-02-20T22:09:11.1767738Z +    )
2026-02-20T22:09:11.1767844Z  
2026-02-20T22:09:11.1767977Z      def __repr__(self):
2026-02-20T22:09:11.1768289Z          return f"<Achievement {self.code}: {self.name} ({self.difficulty})>"
2026-02-20T22:09:11.1768392Z  
2026-02-20T22:09:11.1768486Z  
2026-02-20T22:09:11.1768631Z  class UserAchievement(Base):
2026-02-20T22:09:11.1769038Z      """Modèle pour les badges obtenus par les utilisateurs"""
2026-02-20T22:09:11.1769138Z +
2026-02-20T22:09:11.1769321Z      __tablename__ = "user_achievements"
2026-02-20T22:09:11.1769427Z  
2026-02-20T22:09:11.1769641Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.1770085Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
2026-02-20T22:09:11.1770547Z -    achievement_id = Column(Integer, ForeignKey("achievements.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.1770664Z +    user_id = Column(
2026-02-20T22:09:11.1771006Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True
2026-02-20T22:09:11.1771122Z +    )
2026-02-20T22:09:11.1771254Z +    achievement_id = Column(
2026-02-20T22:09:11.1771590Z +        Integer, ForeignKey("achievements.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.1771701Z +    )
2026-02-20T22:09:11.1772056Z      earned_at = Column(DateTime(timezone=True), default=func.now(), index=True)
2026-02-20T22:09:11.1772232Z      progress_data = Column(JSON, nullable=True)
2026-02-20T22:09:11.1772413Z      is_displayed = Column(Boolean, default=True)
2026-02-20T22:09:11.1772540Z  
2026-02-20T22:09:11.1772655Z      # Relations
2026-02-20T22:09:11.1772928Z      user = relationship("User", back_populates="user_achievements")
2026-02-20T22:09:11.1773482Z      achievement = relationship("Achievement", back_populates="user_achievements")
2026-02-20T22:09:11.1773583Z  
2026-02-20T22:09:11.1773714Z      def __repr__(self):
2026-02-20T22:09:11.1774119Z -        return f"<UserAchievement: User {self.user_id}, Achievement {self.achievement_id}>"
2026-02-20T22:09:11.1774238Z +        return (
2026-02-20T22:09:11.1774573Z +            f"<UserAchievement: User {self.user_id}, Achievement {self.achievement_id}>"
2026-02-20T22:09:11.1774679Z +        )
2026-02-20T22:09:11.1775058Z would reformat /home/runner/work/mathakine/mathakine/app/models/achievement.py
2026-02-20T22:09:11.1966014Z --- /home/runner/work/mathakine/mathakine/app/models/all_models.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.1970947Z would reformat /home/runner/work/mathakine/mathakine/app/models/all_models.py
2026-02-20T22:09:11.1971772Z +++ /home/runner/work/mathakine/mathakine/app/models/all_models.py	2026-02-20 22:09:11.192082+00:00
2026-02-20T22:09:11.1971902Z @@ -5,13 +5,16 @@
2026-02-20T22:09:11.1972012Z  
2026-02-20T22:09:11.1972271Z  from app.models.admin_audit_log import AdminAuditLog
2026-02-20T22:09:11.1972578Z  from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:11.1972753Z  from app.models.attempt import Attempt
2026-02-20T22:09:11.1973298Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:11.1973605Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:11.1973792Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:11.1973980Z -                                        LogicChallengeType)
2026-02-20T22:09:11.1974163Z +from app.models.logic_challenge import (
2026-02-20T22:09:11.1974286Z +    AgeGroup,
2026-02-20T22:09:11.1974422Z +    LogicChallenge,
2026-02-20T22:09:11.1974588Z +    LogicChallengeAttempt,
2026-02-20T22:09:11.1974722Z +    LogicChallengeType,
2026-02-20T22:09:11.1974827Z +)
2026-02-20T22:09:11.1975034Z  from app.models.notification import Notification
2026-02-20T22:09:11.1975217Z  from app.models.progress import Progress
2026-02-20T22:09:11.1975663Z  from app.models.recommendation import Recommendation
2026-02-20T22:09:11.1975832Z  from app.models.setting import Setting
2026-02-20T22:09:11.1976001Z  from app.models.user import User, UserRole
2026-02-20T22:09:11.2416028Z --- /home/runner/work/mathakine/mathakine/app/models/attempt.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2424025Z would reformat /home/runner/work/mathakine/mathakine/app/models/attempt.py
2026-02-20T22:09:11.2425022Z +++ /home/runner/work/mathakine/mathakine/app/models/attempt.py	2026-02-20 22:09:11.240426+00:00
2026-02-20T22:09:11.2426506Z @@ -1,45 +1,58 @@
2026-02-20T22:09:11.2428536Z -from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Index, Integer,
2026-02-20T22:09:11.2429284Z -                        String)
2026-02-20T22:09:11.2429666Z +from sqlalchemy import (
2026-02-20T22:09:11.2430002Z +    Boolean,
2026-02-20T22:09:11.2430263Z +    Column,
2026-02-20T22:09:11.2430543Z +    DateTime,
2026-02-20T22:09:11.2430818Z +    Float,
2026-02-20T22:09:11.2431298Z +    ForeignKey,
2026-02-20T22:09:11.2431648Z +    Index,
2026-02-20T22:09:11.2432196Z +    Integer,
2026-02-20T22:09:11.2432576Z +    String,
2026-02-20T22:09:11.2432887Z +)
2026-02-20T22:09:11.2463886Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2464492Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.2465000Z  
2026-02-20T22:09:11.2465474Z  from app.db.base import Base
2026-02-20T22:09:11.2465977Z  
2026-02-20T22:09:11.2466367Z  
2026-02-20T22:09:11.2479358Z  class Attempt(Base):
2026-02-20T22:09:11.2480488Z      """Modèle pour les tentatives de résolution d'exercices (Tentatives d'Accomplissement)"""
2026-02-20T22:09:11.2481228Z +
2026-02-20T22:09:11.2481503Z      __tablename__ = "attempts"
2026-02-20T22:09:11.2481890Z -    
2026-02-20T22:09:11.2482149Z +
2026-02-20T22:09:11.2482603Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.2483314Z      __table_args__ = (
2026-02-20T22:09:11.2483808Z -        Index('ix_attempts_user_exercise', 'user_id', 'exercise_id'),
2026-02-20T22:09:11.2484535Z -        Index('ix_attempts_user_correct', 'user_id', 'is_correct'),
2026-02-20T22:09:11.2485226Z +        Index("ix_attempts_user_exercise", "user_id", "exercise_id"),
2026-02-20T22:09:11.2485905Z +        Index("ix_attempts_user_correct", "user_id", "is_correct"),
2026-02-20T22:09:11.2486420Z      )
2026-02-20T22:09:11.2486681Z  
2026-02-20T22:09:11.2487031Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.2487510Z  
2026-02-20T22:09:11.2487869Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.2488585Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.2489355Z      user = relationship("User", back_populates="attempts")
2026-02-20T22:09:11.2490558Z -    exercise_id = Column(Integer, ForeignKey("exercises.id"), nullable=False, index=True)
2026-02-20T22:09:11.2491302Z +    exercise_id = Column(
2026-02-20T22:09:11.2491845Z +        Integer, ForeignKey("exercises.id"), nullable=False, index=True
2026-02-20T22:09:11.2492424Z +    )
2026-02-20T22:09:11.2492869Z      exercise = relationship("Exercise", back_populates="attempts")
2026-02-20T22:09:11.2493591Z  
2026-02-20T22:09:11.2493980Z      # Données de tentative
2026-02-20T22:09:11.2494409Z      user_answer = Column(String, nullable=False)
2026-02-20T22:09:11.2495248Z      is_correct = Column(Boolean, nullable=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.2496170Z      time_spent = Column(Float, nullable=True)  # Temps passé en secondes
2026-02-20T22:09:11.2496737Z  
2026-02-20T22:09:11.2497031Z      # Métadonnées
2026-02-20T22:09:11.2497871Z -    attempt_number = Column(Integer, default=1)  # Numéro de tentative pour cet exercice et cet utilisateur
2026-02-20T22:09:11.2498729Z +    attempt_number = Column(
2026-02-20T22:09:11.2499121Z +        Integer, default=1
2026-02-20T22:09:11.2499776Z +    )  # Numéro de tentative pour cet exercice et cet utilisateur
2026-02-20T22:09:11.2500899Z      hints_used = Column(Integer, default=0)  # Nombre d'indices utilisés
2026-02-20T22:09:11.2501881Z      device_info = Column(String, nullable=True)  # Information sur l'appareil utilisé
2026-02-20T22:09:11.2502564Z  
2026-02-20T22:09:11.2502834Z      # Horodatage
2026-02-20T22:09:11.2503703Z -    created_at = Column(DateTime(timezone=True), default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.2504483Z -
2026-02-20T22:09:11.2504743Z -
2026-02-20T22:09:11.2505009Z +    created_at = Column(
2026-02-20T22:09:11.2505496Z +        DateTime(timezone=True), default=func.now(), index=True
2026-02-20T22:09:11.2506053Z +    )  # Tri chronologique
2026-02-20T22:09:11.2506402Z  
2026-02-20T22:09:11.2506672Z      def __repr__(self):
2026-02-20T22:09:11.2507272Z          status = "réussie" if self.is_correct else "échouée"
2026-02-20T22:09:11.2508077Z          return f"<Tentative {self.id}: Utilisateur {self.user_id}, Exercice {self.exercise_id}\
2026-02-20T22:09:11.2508787Z              , {status}>"
2026-02-20T22:09:11.2734951Z --- /home/runner/work/mathakine/mathakine/app/db/transaction.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2736644Z +++ /home/runner/work/mathakine/mathakine/app/db/transaction.py	2026-02-20 22:09:11.270721+00:00
2026-02-20T22:09:11.2737630Z @@ -1,9 +1,10 @@
2026-02-20T22:09:11.2738086Z  """
2026-02-20T22:09:11.2738738Z  Transaction management utilities for database operations in Mathakine.
2026-02-20T22:09:11.2741130Z  This module provides consistent transaction management across the application.
2026-02-20T22:09:11.2742402Z  """
2026-02-20T22:09:11.2742813Z +
2026-02-20T22:09:11.2743293Z  from contextlib import contextmanager
2026-02-20T22:09:11.2743708Z  
2026-02-20T22:09:11.2744036Z  from app.core.logging_config import get_logger
2026-02-20T22:09:11.2744500Z  
2026-02-20T22:09:11.2744765Z  logger = get_logger(__name__)
2026-02-20T22:09:11.2745157Z @@ -15,25 +16,25 @@
2026-02-20T22:09:11.2745478Z      """
2026-02-20T22:09:11.2746192Z      Gère les transactions de base de données de manière unifiée.
2026-02-20T22:09:11.2747160Z      Fournit des méthodes pour démarrer, valider et annuler des transactions,
2026-02-20T22:09:11.2748162Z      ainsi qu'un gestionnaire de contexte pour une utilisation simplifiée.
2026-02-20T22:09:11.2748799Z      """
2026-02-20T22:09:11.2749074Z -    
2026-02-20T22:09:11.2749356Z +
2026-02-20T22:09:11.2749624Z      @staticmethod
2026-02-20T22:09:11.2750036Z      @contextmanager
2026-02-20T22:09:11.2750632Z      def transaction(db_session: Session, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2751305Z          """
2026-02-20T22:09:11.2751980Z          Gestionnaire de contexte pour les transactions de base de données.
2026-02-20T22:09:11.2752625Z -        
2026-02-20T22:09:11.2753456Z +
2026-02-20T22:09:11.2753734Z          Args:
2026-02-20T22:09:11.2754255Z              db_session: Session SQLAlchemy à utiliser
2026-02-20T22:09:11.2755077Z              auto_commit: Si True, commit automatiquement à la fin du bloc
2026-02-20T22:09:11.2755943Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2756507Z -            
2026-02-20T22:09:11.2756823Z +
2026-02-20T22:09:11.2757090Z          Yields:
2026-02-20T22:09:11.2757584Z              Session: La session de base de données
2026-02-20T22:09:11.2758039Z -            
2026-02-20T22:09:11.2758332Z +
2026-02-20T22:09:11.2758590Z          Usage:
2026-02-20T22:09:11.2759042Z              with TransactionManager.transaction(db) as session:
2026-02-20T22:09:11.2759740Z                  # Effectuer des opérations
2026-02-20T22:09:11.2760209Z                  session.add(model)
2026-02-20T22:09:11.2760988Z                  # Pas besoin de faire session.commit() - c'est géré automatiquement
2026-02-20T22:09:11.2761648Z @@ -41,157 +42,187 @@
2026-02-20T22:09:11.2762304Z          # Créer un point de sauvegarde pour permettre un rollback partiel
2026-02-20T22:09:11.2763370Z          # même si nous sommes dans une transaction externe
2026-02-20T22:09:11.2763888Z          try:
2026-02-20T22:09:11.2764531Z              savepoint = db_session.begin_nested()
2026-02-20T22:09:11.2765471Z              logger.debug(f"{log_prefix}: Début de la transaction (avec savepoint)")
2026-02-20T22:09:11.2766069Z -            
2026-02-20T22:09:11.2766345Z +
2026-02-20T22:09:11.2766631Z              yield db_session
2026-02-20T22:09:11.2766989Z -            
2026-02-20T22:09:11.2767276Z +
2026-02-20T22:09:11.2767547Z              if auto_commit:
2026-02-20T22:09:11.2767946Z                  # Commit du savepoint
2026-02-20T22:09:11.2768385Z                  savepoint.commit()
2026-02-20T22:09:11.2769147Z                  # Commit de la transaction principale si nous ne sommes pas dans une transaction de test
2026-02-20T22:09:11.2769970Z                  if not savepoint.is_active:
2026-02-20T22:09:11.2770435Z                      db_session.commit()
2026-02-20T22:09:11.2771182Z                  logger.debug(f"{log_prefix}: Transaction validée (commit)")
2026-02-20T22:09:11.2771838Z          except Exception as savepoint_error:
2026-02-20T22:09:11.2772325Z              # Rollback au savepoint
2026-02-20T22:09:11.2772852Z -            if 'savepoint' in locals() and savepoint.is_active:
2026-02-20T22:09:11.2773683Z +            if "savepoint" in locals() and savepoint.is_active:
2026-02-20T22:09:11.2774246Z                  savepoint.rollback()
2026-02-20T22:09:11.2774938Z              # Également rollback de la transaction principale
2026-02-20T22:09:11.2775506Z              db_session.rollback()
2026-02-20T22:09:11.2776516Z -            logger.error(f"{log_prefix}: Transaction annulée (rollback) suite à l'erreur: {savepoint_error}")
2026-02-20T22:09:11.2777364Z +            logger.error(
2026-02-20T22:09:11.2778203Z +                f"{log_prefix}: Transaction annulée (rollback) suite à l'erreur: {savepoint_error}"
2026-02-20T22:09:11.2778953Z +            )
2026-02-20T22:09:11.2779252Z              raise
2026-02-20T22:09:11.2779553Z -    
2026-02-20T22:09:11.2779826Z +
2026-02-20T22:09:11.2780087Z      @staticmethod
2026-02-20T22:09:11.2780520Z      def commit(db_session: Session, log_prefix="DB"):
2026-02-20T22:09:11.2781158Z          """Valide les modifications de la session en cours"""
2026-02-20T22:09:11.2781674Z          try:
2026-02-20T22:09:11.2781977Z              db_session.commit()
2026-02-20T22:09:11.2782692Z              logger.debug(f"{log_prefix}: Transaction validée (commit)")
2026-02-20T22:09:11.2783496Z              return True
2026-02-20T22:09:11.2783877Z          except Exception as commit_error:
2026-02-20T22:09:11.2784328Z              db_session.rollback()
2026-02-20T22:09:11.2785160Z -            logger.error(f"{log_prefix}: Échec de commit, transaction annulée: {commit_error}")
2026-02-20T22:09:11.2786106Z -            return False
2026-02-20T22:09:11.2786440Z -    
2026-02-20T22:09:11.2786701Z +            logger.error(
2026-02-20T22:09:11.2787362Z +                f"{log_prefix}: Échec de commit, transaction annulée: {commit_error}"
2026-02-20T22:09:11.2787943Z +            )
2026-02-20T22:09:11.2788240Z +            return False
2026-02-20T22:09:11.2788550Z +
2026-02-20T22:09:11.2788799Z      @staticmethod
2026-02-20T22:09:11.2789181Z      def rollback(db_session: Session, log_prefix="DB"):
2026-02-20T22:09:11.2789772Z          """Annule les modifications de la session en cours"""
2026-02-20T22:09:11.2790268Z          try:
2026-02-20T22:09:11.2790567Z              db_session.rollback()
2026-02-20T22:09:11.2791243Z              logger.debug(f"{log_prefix}: Transaction annulée (rollback)")
2026-02-20T22:09:11.2791829Z              return True
2026-02-20T22:09:11.2792215Z          except Exception as rollback_error:
2026-02-20T22:09:11.2792949Z              logger.error(f"{log_prefix}: Échec de rollback: {rollback_error}")
2026-02-20T22:09:11.2793755Z              return False
2026-02-20T22:09:11.2794073Z -    
2026-02-20T22:09:11.2794328Z +
2026-02-20T22:09:11.2794575Z      @staticmethod
2026-02-20T22:09:11.2795097Z      def safe_delete(db_session: Session, obj, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2795978Z          """
2026-02-20T22:09:11.2796561Z          Supprime un objet de la base de données en toute sécurité.
2026-02-20T22:09:11.2797577Z          Les suppressions en cascade sont gérées automatiquement grâce aux relations SQLAlchemy.
2026-02-20T22:09:11.2798310Z -        
2026-02-20T22:09:11.2798592Z +
2026-02-20T22:09:11.2798832Z          Args:
2026-02-20T22:09:11.2799136Z              db_session: Session SQLAlchemy
2026-02-20T22:09:11.2799669Z              obj: L'objet à supprimer
2026-02-20T22:09:11.2800298Z              auto_commit: Si True, commit après la suppression
2026-02-20T22:09:11.2801084Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2801602Z -        
2026-02-20T22:09:11.2801852Z +
2026-02-20T22:09:11.2802078Z          Returns:
2026-02-20T22:09:11.2802588Z              bool: True si la suppression a réussi, False sinon
2026-02-20T22:09:11.2803240Z          """
2026-02-20T22:09:11.2803519Z          try:
2026-02-20T22:09:11.2804028Z              # Vérifier que l'objet est attaché à la session
2026-02-20T22:09:11.2804517Z -            obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.2804966Z +            obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.2805411Z              if obj not in db_session:
2026-02-20T22:09:11.2806032Z                  # Essayer de récupérer l'objet depuis la session
2026-02-20T22:09:11.2806547Z                  if obj_id:
2026-02-20T22:09:11.2807172Z -                    obj_from_db = db_session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.2807848Z +                    obj_from_db = (
2026-02-20T22:09:11.2808275Z +                        db_session.query(obj.__class__)
2026-02-20T22:09:11.2808769Z +                        .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.2809199Z +                        .first()
2026-02-20T22:09:11.2809550Z +                    )
2026-02-20T22:09:11.2809879Z                      if not obj_from_db:
2026-02-20T22:09:11.2810923Z -                        logger.error(f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données")
2026-02-20T22:09:11.2811779Z +                        logger.error(
2026-02-20T22:09:11.2812726Z +                            f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données"
2026-02-20T22:09:11.2813728Z +                        )
2026-02-20T22:09:11.2814101Z                          return False
2026-02-20T22:09:11.2814528Z                      obj = obj_from_db
2026-02-20T22:09:11.2814908Z                  else:
2026-02-20T22:09:11.2815532Z -                    logger.error(f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut id")
2026-02-20T22:09:11.2816486Z +                    logger.error(
2026-02-20T22:09:11.2817093Z +                        f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut id"
2026-02-20T22:09:11.2817783Z +                    )
2026-02-20T22:09:11.2818011Z                      return False
2026-02-20T22:09:11.2818226Z -            
2026-02-20T22:09:11.2818386Z +
2026-02-20T22:09:11.2818562Z              # Supprimer directement l'objet
2026-02-20T22:09:11.2818816Z              db_session.delete(obj)
2026-02-20T22:09:11.2819438Z -            logger.debug(f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué pour suppression")
2026-02-20T22:09:11.2819926Z -            
2026-02-20T22:09:11.2820103Z +            logger.debug(
2026-02-20T22:09:11.2820620Z +                f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué pour suppression"
2026-02-20T22:09:11.2821070Z +            )
2026-02-20T22:09:11.2821239Z +
2026-02-20T22:09:11.2821390Z              if auto_commit:
2026-02-20T22:09:11.2821746Z                  # Utiliser un savepoint pour pouvoir faire un rollback partiel en cas d'erreur
2026-02-20T22:09:11.2822129Z                  try:
2026-02-20T22:09:11.2822327Z                      db_session.commit()
2026-02-20T22:09:11.2822888Z                      logger.debug(f"{log_prefix}: Suppression confirmée avec succès")
2026-02-20T22:09:11.2823670Z                      return True
2026-02-20T22:09:11.2824115Z                  except Exception as delete_commit_error:
2026-02-20T22:09:11.2824610Z                      db_session.rollback()
2026-02-20T22:09:11.2825562Z -                    logger.error(f"{log_prefix}: Échec de la suppression lors du commit: {delete_commit_error}")
2026-02-20T22:09:11.2826300Z -                    
2026-02-20T22:09:11.2826629Z +                    logger.error(
2026-02-20T22:09:11.2827464Z +                        f"{log_prefix}: Échec de la suppression lors du commit: {delete_commit_error}"
2026-02-20T22:09:11.2828186Z +                    )
2026-02-20T22:09:11.2828494Z +
2026-02-20T22:09:11.2829200Z                      # Alternative: tenter une suppression sans cascade si la première méthode échoue
2026-02-20T22:09:11.2829907Z                      try:
2026-02-20T22:09:11.2830288Z                          from sqlalchemy import text
2026-02-20T22:09:11.2830754Z  
2026-02-20T22:09:11.2831415Z                          # Suppression directe par ID pour éviter de charger les relations
2026-02-20T22:09:11.2832297Z                          stmt = f"DELETE FROM {obj.__tablename__} WHERE id = :id"
2026-02-20T22:09:11.2832953Z                          db_session.execute(text(stmt), {"id": obj.id})
2026-02-20T22:09:11.2833839Z                          db_session.commit()
2026-02-20T22:09:11.2834977Z -                        logger.info(f"{log_prefix}: Suppression alternative réussie pour {obj.__class__.__name__}(id={obj.id})")
2026-02-20T22:09:11.2835888Z +                        logger.info(
2026-02-20T22:09:11.2836840Z +                            f"{log_prefix}: Suppression alternative réussie pour {obj.__class__.__name__}(id={obj.id})"
2026-02-20T22:09:11.2837653Z +                        )
2026-02-20T22:09:11.2838035Z                          return True
2026-02-20T22:09:11.2838499Z                      except Exception as e2:
2026-02-20T22:09:11.2838998Z                          db_session.rollback()
2026-02-20T22:09:11.2839899Z -                        logger.error(f"{log_prefix}: Échec de la suppression alternative: {e2}")
2026-02-20T22:09:11.2840616Z +                        logger.error(
2026-02-20T22:09:11.2841374Z +                            f"{log_prefix}: Échec de la suppression alternative: {e2}"
2026-02-20T22:09:11.2841960Z +                        )
2026-02-20T22:09:11.2842324Z                          return False
2026-02-20T22:09:11.2842690Z -            
2026-02-20T22:09:11.2843178Z +
2026-02-20T22:09:11.2843462Z              return True
2026-02-20T22:09:11.2843837Z          except Exception as delete_error:
2026-02-20T22:09:11.2844563Z              db_session.rollback()
2026-02-20T22:09:11.2845316Z              logger.error(f"{log_prefix}: Échec de la suppression: {delete_error}")
2026-02-20T22:09:11.2845962Z              return False
2026-02-20T22:09:11.2846294Z -    
2026-02-20T22:09:11.2846573Z +
2026-02-20T22:09:11.2846834Z      @staticmethod
2026-02-20T22:09:11.2847411Z      def safe_archive(db_session: Session, obj, *, auto_commit=True, log_prefix="DB"):
2026-02-20T22:09:11.2848078Z          """
2026-02-20T22:09:11.2848504Z          Archive un objet au lieu de le supprimer physiquement.
2026-02-20T22:09:11.2849029Z -        
2026-02-20T22:09:11.2849291Z +
2026-02-20T22:09:11.2849549Z          Args:
2026-02-20T22:09:11.2849869Z              db_session: Session SQLAlchemy
2026-02-20T22:09:11.2850604Z              obj: L'objet à archiver (doit avoir un attribut is_archived)
2026-02-20T22:09:11.2851382Z              auto_commit: Si True, commit après l'archivage
2026-02-20T22:09:11.2852159Z              log_prefix: Préfixe pour les messages de journalisation
2026-02-20T22:09:11.2852701Z -            
2026-02-20T22:09:11.2853182Z +
2026-02-20T22:09:11.2853455Z          Returns:
2026-02-20T22:09:11.2853978Z              bool: True si l'archivage a réussi, False sinon
2026-02-20T22:09:11.2854699Z          """
2026-02-20T22:09:11.2854994Z          try:
2026-02-20T22:09:11.2855336Z -            if not hasattr(obj, 'is_archived'):
2026-02-20T22:09:11.2856136Z -                logger.error(f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut is_archived")
2026-02-20T22:09:11.2856957Z +            if not hasattr(obj, "is_archived"):
2026-02-20T22:09:11.2857409Z +                logger.error(
2026-02-20T22:09:11.2858034Z +                    f"{log_prefix}: L'objet {obj.__class__.__name__} n'a pas d'attribut is_archived"
2026-02-20T22:09:11.2858687Z +                )
2026-02-20T22:09:11.2858988Z                  return False
2026-02-20T22:09:11.2859338Z -            
2026-02-20T22:09:11.2859616Z +
2026-02-20T22:09:11.2860105Z              # Vérifier que l'objet est attaché à la session
2026-02-20T22:09:11.2860641Z -            obj_id = getattr(obj, 'id', None)
2026-02-20T22:09:11.2861123Z +            obj_id = getattr(obj, "id", None)
2026-02-20T22:09:11.2861582Z              if obj not in db_session:
2026-02-20T22:09:11.2862212Z                  # Essayer de récupérer l'objet depuis la session
2026-02-20T22:09:11.2862724Z                  if obj_id:
2026-02-20T22:09:11.2863563Z -                    obj_from_db = db_session.query(obj.__class__).filter(obj.__class__.id == obj_id).first()
2026-02-20T22:09:11.2864321Z +                    obj_from_db = (
2026-02-20T22:09:11.2864768Z +                        db_session.query(obj.__class__)
2026-02-20T22:09:11.2865280Z +                        .filter(obj.__class__.id == obj_id)
2026-02-20T22:09:11.2865737Z +                        .first()
2026-02-20T22:09:11.2866105Z +                    )
2026-02-20T22:09:11.2866442Z                      if not obj_from_db:
2026-02-20T22:09:11.2867500Z -                        logger.error(f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données")
2026-02-20T22:09:11.2868390Z +                        logger.error(
2026-02-20T22:09:11.2869299Z +                            f"{log_prefix}: Objet {obj.__class__.__name__}(id={obj_id}) non trouvé dans la base de données"
2026-02-20T22:09:11.2870074Z +                        )
2026-02-20T22:09:11.2870421Z                          return False
2026-02-20T22:09:11.2870835Z                      obj = obj_from_db
2026-02-20T22:09:11.2871241Z                  else:
2026-02-20T22:09:11.2871611Z                      # Si pas d'ID, merger l'objet
2026-02-20T22:09:11.2872108Z                      obj = db_session.merge(obj)
2026-02-20T22:09:11.2872539Z -                
2026-02-20T22:09:11.2872843Z +
2026-02-20T22:09:11.2873446Z              obj.is_archived = True
2026-02-20T22:09:11.2874554Z -            logger.debug(f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué comme archivé")
2026-02-20T22:09:11.2875734Z -            
2026-02-20T22:09:11.2876046Z +            logger.debug(
2026-02-20T22:09:11.2876959Z +                f"{log_prefix}: Objet {obj.__class__.__name__}(id={getattr(obj, 'id', 'N/A')}) marqué comme archivé"
2026-02-20T22:09:11.2877725Z +            )
2026-02-20T22:09:11.2878009Z +
2026-02-20T22:09:11.2878277Z              if auto_commit:
2026-02-20T22:09:11.2878653Z                  db_session.commit()
2026-02-20T22:09:11.2879355Z                  logger.debug(f"{log_prefix}: Archivage confirmé avec succès")
2026-02-20T22:09:11.2879940Z -            
2026-02-20T22:09:11.2880216Z +
2026-02-20T22:09:11.2880479Z              return True
2026-02-20T22:09:11.2880829Z          except Exception as e:
2026-02-20T22:09:11.2881238Z              db_session.rollback()
2026-02-20T22:09:11.2881890Z              logger.error(f"{log_prefix}: Échec de l'archivage: {e}")
2026-02-20T22:09:11.2882454Z -            return False 
2026-02-20T22:09:11.2882818Z \ No newline at end of file
2026-02-20T22:09:11.2883376Z +            return False
2026-02-20T22:09:11.2884011Z would reformat /home/runner/work/mathakine/mathakine/app/models/exercise.py
2026-02-20T22:09:11.2885101Z would reformat /home/runner/work/mathakine/mathakine/app/db/transaction.py
2026-02-20T22:09:11.2886114Z --- /home/runner/work/mathakine/mathakine/app/models/exercise.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2887230Z +++ /home/runner/work/mathakine/mathakine/app/models/exercise.py	2026-02-20 22:09:11.278586+00:00
2026-02-20T22:09:11.2887979Z @@ -1,41 +1,51 @@
2026-02-20T22:09:11.2888288Z  import enum
2026-02-20T22:09:11.2888564Z  
2026-02-20T22:09:11.2889041Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Enum, ForeignKey,
2026-02-20T22:09:11.2889715Z -                        Integer, String, Text)
2026-02-20T22:09:11.2890142Z +from sqlalchemy import (
2026-02-20T22:09:11.2890476Z +    JSON,
2026-02-20T22:09:11.2890726Z +    Boolean,
2026-02-20T22:09:11.2890988Z +    Column,
2026-02-20T22:09:11.2891256Z +    DateTime,
2026-02-20T22:09:11.2891537Z +    Enum,
2026-02-20T22:09:11.2891801Z +    ForeignKey,
2026-02-20T22:09:11.2892096Z +    Integer,
2026-02-20T22:09:11.2892360Z +    String,
2026-02-20T22:09:11.2892634Z +    Text,
2026-02-20T22:09:11.2892899Z +)
2026-02-20T22:09:11.2893380Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2893852Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.2894223Z  
2026-02-20T22:09:11.2894507Z  from app.db.base import Base
2026-02-20T22:09:11.2894860Z  
2026-02-20T22:09:11.2895104Z  
2026-02-20T22:09:11.2895392Z  class DifficultyLevel(str, enum.Enum):
2026-02-20T22:09:11.2896064Z      """Niveaux de difficulté des épreuves mathématiques"""
2026-02-20T22:09:11.2896629Z -    INITIE = "INITIE"           # Facile (6-8 ans)
2026-02-20T22:09:11.2897159Z -    PADAWAN = "PADAWAN"         # Moyen (9-11 ans)
2026-02-20T22:09:11.2897708Z -    CHEVALIER = "CHEVALIER"     # Difficile (12-14 ans)
2026-02-20T22:09:11.2898425Z -    MAITRE = "MAITRE"           # Très difficile (15-17 ans)
2026-02-20T22:09:11.2898932Z +
2026-02-20T22:09:11.2899226Z +    INITIE = "INITIE"  # Facile (6-8 ans)
2026-02-20T22:09:11.2899691Z +    PADAWAN = "PADAWAN"  # Moyen (9-11 ans)
2026-02-20T22:09:11.2900213Z +    CHEVALIER = "CHEVALIER"  # Difficile (12-14 ans)
2026-02-20T22:09:11.2900859Z +    MAITRE = "MAITRE"  # Très difficile (15-17 ans)
2026-02-20T22:09:11.2901424Z      GRAND_MAITRE = "GRAND_MAITRE"  # Expert (adultes)
2026-02-20T22:09:11.2901889Z -
2026-02-20T22:09:11.2902137Z  
2026-02-20T22:09:11.2902377Z  
2026-02-20T22:09:11.2902666Z  class ExerciseType(str, enum.Enum):
2026-02-20T22:09:11.2903507Z      """Types d'épreuves mathématiques"""
2026-02-20T22:09:11.2904010Z -    ADDITION = "ADDITION"           # Additions
2026-02-20T22:09:11.2904541Z -    SOUSTRACTION = "SOUSTRACTION"   # Soustractions
2026-02-20T22:09:11.2905129Z -    MULTIPLICATION = "MULTIPLICATION" # Multiplications
2026-02-20T22:09:11.2905916Z -    DIVISION = "DIVISION"           # Divisions
2026-02-20T22:09:11.2906414Z -    FRACTIONS = "FRACTIONS"         # Fractions
2026-02-20T22:09:11.2907011Z -    GEOMETRIE = "GEOMETRIE"         # Géométrie
2026-02-20T22:09:11.2907566Z -    TEXTE = "TEXTE"                 # Questions textuelles
2026-02-20T22:09:11.2908325Z -    MIXTE = "MIXTE"                 # Combinaison de plusieurs opérations
2026-02-20T22:09:11.2909021Z -    DIVERS = "DIVERS"               # Exercices variés
2026-02-20T22:09:11.2909489Z  
2026-02-20T22:09:11.2909776Z +    ADDITION = "ADDITION"  # Additions
2026-02-20T22:09:11.2910266Z +    SOUSTRACTION = "SOUSTRACTION"  # Soustractions
2026-02-20T22:09:11.2910859Z +    MULTIPLICATION = "MULTIPLICATION"  # Multiplications
2026-02-20T22:09:11.2911393Z +    DIVISION = "DIVISION"  # Divisions
2026-02-20T22:09:11.2911839Z +    FRACTIONS = "FRACTIONS"  # Fractions
2026-02-20T22:09:11.2912382Z +    GEOMETRIE = "GEOMETRIE"  # Géométrie
2026-02-20T22:09:11.2912842Z +    TEXTE = "TEXTE"  # Questions textuelles
2026-02-20T22:09:11.2913698Z +    MIXTE = "MIXTE"  # Combinaison de plusieurs opérations
2026-02-20T22:09:11.2914327Z +    DIVERS = "DIVERS"  # Exercices variés
2026-02-20T22:09:11.2914733Z  
2026-02-20T22:09:11.2914978Z  
2026-02-20T22:09:11.2915238Z  class Exercise(Base):
2026-02-20T22:09:11.2916115Z      """Modèle de données pour les exercices mathématiques (Épreuves Jedi)"""
2026-02-20T22:09:11.2916747Z +
2026-02-20T22:09:11.2917024Z      __tablename__ = "exercises"
2026-02-20T22:09:11.2917396Z  
2026-02-20T22:09:11.2917740Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.2918216Z  
2026-02-20T22:09:11.2918538Z      # Métadonnées
2026-02-20T22:09:11.2918849Z @@ -44,21 +54,25 @@
2026-02-20T22:09:11.2919334Z      creator = relationship("User", back_populates="created_exercises")
2026-02-20T22:09:11.2920004Z      exercise_type = Column(String, nullable=False)
2026-02-20T22:09:11.2920944Z      # NOTE: La DB PostgreSQL utilise VARCHAR, pas ENUM. On garde String pour la compatibilité.
2026-02-20T22:09:11.2921750Z      difficulty = Column(String, nullable=False)
2026-02-20T22:09:11.2922540Z      tags = Column(String, nullable=True)  # Tags séparés par des virgules
2026-02-20T22:09:11.2923320Z -    
2026-02-20T22:09:11.2923588Z +
2026-02-20T22:09:11.2923899Z      # Attributs de personnalisation
2026-02-20T22:09:11.2924745Z -    age_group = Column(String, nullable=False)  # Groupe d'âge cible (8-10, 11-13, 14-16)
2026-02-20T22:09:11.2925445Z +    age_group = Column(
2026-02-20T22:09:11.2925809Z +        String, nullable=False
2026-02-20T22:09:11.2926338Z +    )  # Groupe d'âge cible (8-10, 11-13, 14-16)
2026-02-20T22:09:11.2927152Z      context_theme = Column(String, nullable=True)  # Contexte Star Wars spécifique
2026-02-20T22:09:11.2928233Z      complexity = Column(Integer, nullable=True)  # Niveau de complexité cognitive (1-5)
2026-02-20T22:09:11.2929209Z      ai_generated = Column(Boolean, default=False)  # Généré par IA
2026-02-20T22:09:11.2929835Z  
2026-02-20T22:09:11.2930126Z      # Contenu de l'exercice
2026-02-20T22:09:11.2930533Z      question = Column(Text, nullable=False)
2026-02-20T22:09:11.2931056Z      correct_answer = Column(String, nullable=False)
2026-02-20T22:09:11.2931963Z -    choices = Column(JSON, nullable=True)  # Options pour les questions à choix multiples
2026-02-20T22:09:11.2932696Z +    choices = Column(
2026-02-20T22:09:11.2933207Z +        JSON, nullable=True
2026-02-20T22:09:11.2933800Z +    )  # Options pour les questions à choix multiples
2026-02-20T22:09:11.2934475Z      explanation = Column(Text, nullable=True)  # Explication de la solution
2026-02-20T22:09:11.2935404Z      hint = Column(Text, nullable=True)  # Indice pour aider l'élève
2026-02-20T22:09:11.2935951Z  
2026-02-20T22:09:11.2936313Z      # Métadonnées du contenu
2026-02-20T22:09:11.2937000Z      image_url = Column(String, nullable=True)  # URL de l'image associée
2026-02-20T22:09:11.2937598Z @@ -69,14 +83,16 @@
2026-02-20T22:09:11.2937972Z      is_archived = Column(Boolean, default=False)
2026-02-20T22:09:11.2938691Z      view_count = Column(Integer, default=0)
2026-02-20T22:09:11.2939113Z  
2026-02-20T22:09:11.2939361Z      # Horodatage
2026-02-20T22:09:11.2939825Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.2940828Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.2941552Z +    updated_at = Column(
2026-02-20T22:09:11.2942072Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.2942628Z +    )
2026-02-20T22:09:11.2942889Z  
2026-02-20T22:09:11.2943341Z      # Relations
2026-02-20T22:09:11.2943970Z -    attempts = relationship("Attempt", back_populates="exercise", cascade="all, delete-orphan")
2026-02-20T22:09:11.2944691Z -
2026-02-20T22:09:11.2944934Z -
2026-02-20T22:09:11.2945201Z +    attempts = relationship(
2026-02-20T22:09:11.2945751Z +        "Attempt", back_populates="exercise", cascade="all, delete-orphan"
2026-02-20T22:09:11.2946339Z +    )
2026-02-20T22:09:11.2946583Z  
2026-02-20T22:09:11.2946844Z      def __repr__(self):
2026-02-20T22:09:11.2947341Z          return f"<Exercise {self.id}: {self.title} ({self.difficulty})>"
2026-02-20T22:09:11.2948223Z would reformat /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py
2026-02-20T22:09:11.2949277Z --- /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.2950417Z +++ /home/runner/work/mathakine/mathakine/app/models/legacy_tables.py	2026-02-20 22:09:11.286606+00:00
2026-02-20T22:09:11.2951171Z @@ -1,67 +1,81 @@
2026-02-20T22:09:11.2951437Z  """
2026-02-20T22:09:11.2952106Z  Modèles SQLAlchemy pour les tables héritées de l'ancienne base de données.
2026-02-20T22:09:11.2953366Z  Ces modèles sont inclus pour la compatibilité avec la base de données existante.
2026-02-20T22:09:11.2954057Z  """
2026-02-20T22:09:11.2954586Z -from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Integer,
2026-02-20T22:09:11.2955310Z -                        String, Text, text)
2026-02-20T22:09:11.2955733Z +
2026-02-20T22:09:11.2956012Z +from sqlalchemy import (
2026-02-20T22:09:11.2956375Z +    Boolean,
2026-02-20T22:09:11.2956653Z +    Column,
2026-02-20T22:09:11.2956933Z +    DateTime,
2026-02-20T22:09:11.2957232Z +    Float,
2026-02-20T22:09:11.2957519Z +    ForeignKey,
2026-02-20T22:09:11.2957816Z +    Integer,
2026-02-20T22:09:11.2958107Z +    String,
2026-02-20T22:09:11.2958390Z +    Text,
2026-02-20T22:09:11.2958654Z +    text,
2026-02-20T22:09:11.2958922Z +)
2026-02-20T22:09:11.2959230Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.2959666Z  
2026-02-20T22:09:11.2959958Z  from app.db.base import Base
2026-02-20T22:09:11.2960335Z  
2026-02-20T22:09:11.2960583Z  
2026-02-20T22:09:11.2960866Z  class Results(Base):
2026-02-20T22:09:11.2961497Z      """Modèle pour la table results (résultats d'exercices)."""
2026-02-20T22:09:11.2962080Z -    __tablename__ = 'results'
2026-02-20T22:09:11.2962467Z -    
2026-02-20T22:09:11.2962740Z +
2026-02-20T22:09:11.2963238Z +    __tablename__ = "results"
2026-02-20T22:09:11.2963602Z +
2026-02-20T22:09:11.2964003Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2964640Z      exercise_id = Column(Integer, nullable=False)
2026-02-20T22:09:11.2965215Z      is_correct = Column(Boolean, nullable=False)
2026-02-20T22:09:11.2965838Z -    attempt_count = Column(Integer, server_default=text('1'))
2026-02-20T22:09:11.2966538Z +    attempt_count = Column(Integer, server_default=text("1"))
2026-02-20T22:09:11.2966730Z      time_spent = Column(Float, nullable=True)
2026-02-20T22:09:11.2967070Z -    created_at = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2967185Z -    
2026-02-20T22:09:11.2967505Z +    created_at = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2967617Z +
2026-02-20T22:09:11.2967763Z      def __repr__(self):
2026-02-20T22:09:11.2968213Z          return f"<Result(id={self.id}, exercise_id={self.exercise_id}, correct={self.is_correct})>"
2026-02-20T22:09:11.2968579Z  
2026-02-20T22:09:11.2968697Z  
2026-02-20T22:09:11.2968845Z  class Statistics(Base):
2026-02-20T22:09:11.2969302Z      """Modèle pour la table statistics (statistiques par session)."""
2026-02-20T22:09:11.2969736Z -    __tablename__ = 'statistics'
2026-02-20T22:09:11.2969868Z -    
2026-02-20T22:09:11.2969975Z +
2026-02-20T22:09:11.2970120Z +    __tablename__ = "statistics"
2026-02-20T22:09:11.2970239Z +
2026-02-20T22:09:11.2970505Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2970685Z      user_id = Column(Integer, nullable=True)
2026-02-20T22:09:11.2970897Z      session_id = Column(String(255), nullable=False)
2026-02-20T22:09:11.2971131Z      exercise_type = Column(String(50), nullable=False)
2026-02-20T22:09:11.2971336Z      difficulty = Column(String(50), nullable=False)
2026-02-20T22:09:11.2971684Z -    total_attempts = Column(Integer, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972059Z -    correct_attempts = Column(Integer, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972346Z -    avg_time = Column(Float, server_default=text('0'), nullable=False)
2026-02-20T22:09:11.2972697Z -    last_updated = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2972822Z -    
2026-02-20T22:09:11.2973363Z +    total_attempts = Column(Integer, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2973722Z +    correct_attempts = Column(Integer, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2974012Z +    avg_time = Column(Float, server_default=text("0"), nullable=False)
2026-02-20T22:09:11.2974351Z +    last_updated = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2974462Z +
2026-02-20T22:09:11.2974598Z      def __repr__(self):
2026-02-20T22:09:11.2975114Z          return f"<Statistics(id={self.id}, session_id={self.session_id}, exercise_type={self.exercise_type})>"
2026-02-20T22:09:11.2975235Z  
2026-02-20T22:09:11.2975343Z  
2026-02-20T22:09:11.2975493Z  class UserStats(Base):
2026-02-20T22:09:11.2975940Z      """Modèle pour la table user_stats (statistiques utilisateur)."""
2026-02-20T22:09:11.2976092Z -    __tablename__ = 'user_stats'
2026-02-20T22:09:11.2976214Z -    
2026-02-20T22:09:11.2976325Z +
2026-02-20T22:09:11.2976463Z +    __tablename__ = "user_stats"
2026-02-20T22:09:11.2976572Z +
2026-02-20T22:09:11.2976834Z      id = Column(Integer, primary_key=True, autoincrement=True)
2026-02-20T22:09:11.2977049Z      exercise_type = Column(String(50), nullable=False)
2026-02-20T22:09:11.2977250Z      difficulty = Column(String(50), nullable=False)
2026-02-20T22:09:11.2977516Z -    total_attempts = Column(Integer, server_default=text('0'))
2026-02-20T22:09:11.2977788Z -    correct_attempts = Column(Integer, server_default=text('0'))
2026-02-20T22:09:11.2978133Z -    last_updated = Column(DateTime, server_default=text('CURRENT_TIMESTAMP'))
2026-02-20T22:09:11.2978258Z -    
2026-02-20T22:09:11.2978526Z +    total_attempts = Column(Integer, server_default=text("0"))
2026-02-20T22:09:11.2978797Z +    correct_attempts = Column(Integer, server_default=text("0"))
2026-02-20T22:09:11.2979131Z +    last_updated = Column(DateTime, server_default=text("CURRENT_TIMESTAMP"))
2026-02-20T22:09:11.2979256Z +
2026-02-20T22:09:11.2979387Z      def __repr__(self):
2026-02-20T22:09:11.2979903Z          return f"<UserStats(id={self.id}, exercise_type={self.exercise_type}, difficulty={self.difficulty})>"
2026-02-20T22:09:11.2980018Z  
2026-02-20T22:09:11.2980127Z  
2026-02-20T22:09:11.2980273Z  class SchemaVersion(Base):
2026-02-20T22:09:11.2980696Z      """Modèle pour la table schema_version (version du schéma)."""
2026-02-20T22:09:11.2980863Z -    __tablename__ = 'schema_version'
2026-02-20T22:09:11.2980973Z -    
2026-02-20T22:09:11.2981082Z +
2026-02-20T22:09:11.2981234Z +    __tablename__ = "schema_version"
2026-02-20T22:09:11.2981339Z +
2026-02-20T22:09:11.2981526Z      version = Column(Integer, primary_key=True)
2026-02-20T22:09:11.2981876Z -    
2026-02-20T22:09:11.2981994Z +
2026-02-20T22:09:11.2982129Z      def __repr__(self):
2026-02-20T22:09:11.2982364Z -        return f"<SchemaVersion(version={self.version})>" 
2026-02-20T22:09:11.2982514Z \ No newline at end of file
2026-02-20T22:09:11.2983165Z +        return f"<SchemaVersion(version={self.version})>"
2026-02-20T22:09:11.3444089Z --- /home/runner/work/mathakine/mathakine/app/models/notification.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3445529Z +++ /home/runner/work/mathakine/mathakine/app/models/notification.py	2026-02-20 22:09:11.343429+00:00
2026-02-20T22:09:11.3446025Z @@ -1,25 +1,36 @@
2026-02-20T22:09:11.3460174Z would reformat /home/runner/work/mathakine/mathakine/app/models/notification.py
2026-02-20T22:09:11.3460302Z  """
2026-02-20T22:09:11.3460741Z  Modèle SQLAlchemy pour les notifications
2026-02-20T22:09:11.3460855Z  """
2026-02-20T22:09:11.3461233Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.3461442Z -                        Integer, String, Text)
2026-02-20T22:09:11.3461555Z +
2026-02-20T22:09:11.3461705Z +from sqlalchemy import (
2026-02-20T22:09:11.3461822Z +    JSON,
2026-02-20T22:09:11.3461946Z +    Boolean,
2026-02-20T22:09:11.3462060Z +    Column,
2026-02-20T22:09:11.3462190Z +    DateTime,
2026-02-20T22:09:11.3462325Z +    ForeignKey,
2026-02-20T22:09:11.3462439Z +    Index,
2026-02-20T22:09:11.3462557Z +    Integer,
2026-02-20T22:09:11.3462671Z +    String,
2026-02-20T22:09:11.3462792Z +    Text,
2026-02-20T22:09:11.3462898Z +)
2026-02-20T22:09:11.3463281Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3463449Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3463560Z  
2026-02-20T22:09:11.3463711Z  from app.db.base import Base
2026-02-20T22:09:11.3463819Z  
2026-02-20T22:09:11.3463934Z  
2026-02-20T22:09:11.3464075Z  class Notification(Base):
2026-02-20T22:09:11.3464431Z      """Modèle pour les notifications utilisateur"""
2026-02-20T22:09:11.3464563Z +
2026-02-20T22:09:11.3464719Z      __tablename__ = "notifications"
2026-02-20T22:09:11.3464851Z -    __table_args__ = (
2026-02-20T22:09:11.3465048Z -        Index('idx_notifications_user', 'user_id'),
2026-02-20T22:09:11.3465166Z -    )
2026-02-20T22:09:11.3465447Z +    __table_args__ = (Index("idx_notifications_user", "user_id"),)
2026-02-20T22:09:11.3465559Z  
2026-02-20T22:09:11.3465790Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3466208Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.3466340Z +    user_id = Column(
2026-02-20T22:09:11.3466678Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.3466789Z +    )
2026-02-20T22:09:11.3467019Z      type = Column(String(50), nullable=False, index=True)
2026-02-20T22:09:11.3467203Z      title = Column(String(255), nullable=False)
2026-02-20T22:09:11.3467373Z      message = Column(Text, nullable=True)
2026-02-20T22:09:11.3467539Z      data = Column(JSON, nullable=True)
2026-02-20T22:09:11.3467746Z      action_url = Column(String(255), nullable=True)
2026-02-20T22:09:11.3467879Z @@ -42,6 +53,7 @@
2026-02-20T22:09:11.3468037Z      def is_expired(self) -> bool:
2026-02-20T22:09:11.3468374Z          """Vérifier si la notification a expiré"""
2026-02-20T22:09:11.3468529Z          if self.expires_at is None:
2026-02-20T22:09:11.3468671Z              return False
2026-02-20T22:09:11.3468854Z          from datetime import datetime, timezone
2026-02-20T22:09:11.3468966Z +
2026-02-20T22:09:11.3469215Z          return datetime.now(timezone.utc) > self.expires_at
2026-02-20T22:09:11.3846305Z would reformat /home/runner/work/mathakine/mathakine/app/models/progress.py
2026-02-20T22:09:11.3846801Z --- /home/runner/work/mathakine/mathakine/app/models/progress.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3848014Z +++ /home/runner/work/mathakine/mathakine/app/models/progress.py	2026-02-20 22:09:11.382712+00:00
2026-02-20T22:09:11.3848470Z @@ -1,76 +1,88 @@
2026-02-20T22:09:11.3848812Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Float, ForeignKey,
2026-02-20T22:09:11.3848972Z -                        Index, Integer, String)
2026-02-20T22:09:11.3849120Z +from sqlalchemy import (
2026-02-20T22:09:11.3849404Z +    JSON,
2026-02-20T22:09:11.3849523Z +    Boolean,
2026-02-20T22:09:11.3849634Z +    Column,
2026-02-20T22:09:11.3849758Z +    DateTime,
2026-02-20T22:09:11.3849872Z +    Float,
2026-02-20T22:09:11.3850056Z +    ForeignKey,
2026-02-20T22:09:11.3854717Z +    Index,
2026-02-20T22:09:11.3854874Z +    Integer,
2026-02-20T22:09:11.3855004Z +    String,
2026-02-20T22:09:11.3855119Z +)
2026-02-20T22:09:11.3855307Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3855466Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3855580Z  
2026-02-20T22:09:11.3855729Z  from app.db.base import Base
2026-02-20T22:09:11.3855929Z  from app.models.exercise import ExerciseType
2026-02-20T22:09:11.3856061Z  
2026-02-20T22:09:11.3856168Z  
2026-02-20T22:09:11.3856312Z  class Progress(Base):
2026-02-20T22:09:11.3856951Z      """Modèle pour suivre la progression des utilisateurs (Chemin vers la Maîtrise)"""
2026-02-20T22:09:11.3857081Z +
2026-02-20T22:09:11.3857231Z      __tablename__ = "progress"
2026-02-20T22:09:11.3857354Z -    
2026-02-20T22:09:11.3857473Z +
2026-02-20T22:09:11.3857823Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.3857962Z      __table_args__ = (
2026-02-20T22:09:11.3858247Z -        Index('ix_progress_user_type', 'user_id', 'exercise_type'),
2026-02-20T22:09:11.3858536Z -        Index('ix_progress_user_difficulty', 'user_id', 'difficulty'),
2026-02-20T22:09:11.3858808Z +        Index("ix_progress_user_type", "user_id", "exercise_type"),
2026-02-20T22:09:11.3859086Z +        Index("ix_progress_user_difficulty", "user_id", "difficulty"),
2026-02-20T22:09:11.3859211Z      )
2026-02-20T22:09:11.3859318Z  
2026-02-20T22:09:11.3859539Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3859663Z  
2026-02-20T22:09:11.3859869Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.3860214Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.3860504Z      user = relationship("User", back_populates="progress_records")
2026-02-20T22:09:11.3860615Z  
2026-02-20T22:09:11.3860960Z      # Données de progression (avec index pour filtrage)
2026-02-20T22:09:11.3861511Z -    exercise_type = Column(String, nullable=False, index=True)  # Type d'exercice (addition, soustraction, etc.)
2026-02-20T22:09:11.3861971Z -    difficulty = Column(String, nullable=False, index=True)     # Niveau de difficulté
2026-02-20T22:09:11.3862326Z -    total_attempts = Column(Integer, default=0)     # Nombre total de tentatives
2026-02-20T22:09:11.3862833Z -    correct_attempts = Column(Integer, default=0)   # Nombre de tentatives réussies
2026-02-20T22:09:11.3863198Z +    exercise_type = Column(
2026-02-20T22:09:11.3863377Z +        String, nullable=False, index=True
2026-02-20T22:09:11.3863599Z +    )  # Type d'exercice (addition, soustraction, etc.)
2026-02-20T22:09:11.3864066Z +    difficulty = Column(String, nullable=False, index=True)  # Niveau de difficulté
2026-02-20T22:09:11.3864422Z +    total_attempts = Column(Integer, default=0)  # Nombre total de tentatives
2026-02-20T22:09:11.3864945Z +    correct_attempts = Column(Integer, default=0)  # Nombre de tentatives réussies
2026-02-20T22:09:11.3865057Z  
2026-02-20T22:09:11.3865315Z      # Métriques de performance
2026-02-20T22:09:11.3865807Z -    average_time = Column(Float, nullable=True)        # Temps moyen pour résoudre
2026-02-20T22:09:11.3866298Z -    completion_rate = Column(Float, nullable=True)     # Taux de complétion (%)
2026-02-20T22:09:11.3866858Z -    streak = Column(Integer, default=0)                # Série actuelle d'exercices réussis
2026-02-20T22:09:11.3867282Z -    highest_streak = Column(Integer, default=0)        # Meilleure série
2026-02-20T22:09:11.3867945Z +    average_time = Column(Float, nullable=True)  # Temps moyen pour résoudre
2026-02-20T22:09:11.3868376Z +    completion_rate = Column(Float, nullable=True)  # Taux de complétion (%)
2026-02-20T22:09:11.3868977Z +    streak = Column(Integer, default=0)  # Série actuelle d'exercices réussis
2026-02-20T22:09:11.3869393Z +    highest_streak = Column(Integer, default=0)  # Meilleure série
2026-02-20T22:09:11.3869516Z  
2026-02-20T22:09:11.3869772Z      # Métriques pédagogiques avancées
2026-02-20T22:09:11.3870383Z -    concept_mastery = Column(JSON, nullable=True)       # Maîtrise fine des concepts mathématiques
2026-02-20T22:09:11.3870789Z -    learning_curve = Column(JSON, nullable=True)        # Courbe d'apprentissage en JSON
2026-02-20T22:09:11.3871409Z -    last_active_date = Column(DateTime(timezone=True), nullable=True)  # Dernière session active
2026-02-20T22:09:11.3871511Z -    
2026-02-20T22:09:11.3871645Z +    concept_mastery = Column(
2026-02-20T22:09:11.3871797Z +        JSON, nullable=True
2026-02-20T22:09:11.3872072Z +    )  # Maîtrise fine des concepts mathématiques
2026-02-20T22:09:11.3872444Z +    learning_curve = Column(JSON, nullable=True)  # Courbe d'apprentissage en JSON
2026-02-20T22:09:11.3872598Z +    last_active_date = Column(
2026-02-20T22:09:11.3872791Z +        DateTime(timezone=True), nullable=True
2026-02-20T22:09:11.3873215Z +    )  # Dernière session active
2026-02-20T22:09:11.3873331Z +
2026-02-20T22:09:11.3873717Z      # Niveau de maîtrise (compatible avec le thème Star Wars)
2026-02-20T22:09:11.3874082Z      # 1: Novice, 2: Initié, 3: Padawan, 4: Chevalier, 5: Maître
2026-02-20T22:09:11.3874263Z      mastery_level = Column(Integer, default=1)
2026-02-20T22:09:11.3874378Z  
2026-02-20T22:09:11.3874644Z      # Médailles et récompenses (format JSON)
2026-02-20T22:09:11.3874796Z      awards = Column(JSON, nullable=True)
2026-02-20T22:09:11.3874909Z  
2026-02-20T22:09:11.3875147Z      # Données analytiques et conseils
2026-02-20T22:09:11.3875647Z -    strengths = Column(String, nullable=True)        # Points forts identifiés
2026-02-20T22:09:11.3876111Z -    areas_to_improve = Column(String, nullable=True) # Domaines à améliorer
2026-02-20T22:09:11.3876552Z +    strengths = Column(String, nullable=True)  # Points forts identifiés
2026-02-20T22:09:11.3877037Z +    areas_to_improve = Column(String, nullable=True)  # Domaines à améliorer
2026-02-20T22:09:11.3877495Z      recommendations = Column(String, nullable=True)  # Exercices recommandés
2026-02-20T22:09:11.3877613Z  
2026-02-20T22:09:11.3877727Z      # Horodatage
2026-02-20T22:09:11.3878121Z -    last_updated = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3878225Z -
2026-02-20T22:09:11.3878323Z -
2026-02-20T22:09:11.3878451Z +    last_updated = Column(
2026-02-20T22:09:11.3878740Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3878862Z +    )
2026-02-20T22:09:11.3878967Z  
2026-02-20T22:09:11.3879096Z      def __repr__(self):
2026-02-20T22:09:11.3879556Z          return f"<Progression: {self.user_id}, {self.exercise_type}, Niveau {self.mastery_level}>"
2026-02-20T22:09:11.3879669Z -
2026-02-20T22:09:11.3879774Z -
2026-02-20T22:09:11.3879874Z  
2026-02-20T22:09:11.3880043Z      def calculate_completion_rate(self):
2026-02-20T22:09:11.3880327Z          """Calcule le taux de complétion"""
2026-02-20T22:09:11.3880470Z          if self.total_attempts == 0:
2026-02-20T22:09:11.3880591Z              return 0
2026-02-20T22:09:11.3880861Z          return (self.correct_attempts / self.total_attempts) * 100
2026-02-20T22:09:11.3880968Z -
2026-02-20T22:09:11.3881073Z -
2026-02-20T22:09:11.3881186Z  
2026-02-20T22:09:11.3881339Z      def update_mastery_level(self):
2026-02-20T22:09:11.3881793Z          """Met à jour le niveau de maîtrise basé sur le taux de complétion"""
2026-02-20T22:09:11.3881992Z          rate = self.calculate_completion_rate()
2026-02-20T22:09:11.3882125Z          if rate >= 95:
2026-02-20T22:09:11.3882899Z --- /home/runner/work/mathakine/mathakine/app/models/recommendation.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3883621Z +++ /home/runner/work/mathakine/mathakine/app/models/recommendation.py	2026-02-20 22:09:11.383024+00:00
2026-02-20T22:09:11.3883750Z @@ -1,59 +1,94 @@
2026-02-20T22:09:11.3884383Z -from sqlalchemy import (Boolean, Column, DateTime, ForeignKey, Index, Integer, String,
2026-02-20T22:09:11.3884539Z -                        Text)
2026-02-20T22:09:11.3884693Z +from sqlalchemy import (
2026-02-20T22:09:11.3884811Z +    Boolean,
2026-02-20T22:09:11.3884925Z +    Column,
2026-02-20T22:09:11.3885053Z +    DateTime,
2026-02-20T22:09:11.3885171Z +    ForeignKey,
2026-02-20T22:09:11.3885282Z +    Index,
2026-02-20T22:09:11.3885394Z +    Integer,
2026-02-20T22:09:11.3885517Z +    String,
2026-02-20T22:09:11.3885631Z +    Text,
2026-02-20T22:09:11.3885741Z +)
2026-02-20T22:09:11.3885930Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.3886086Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.3886201Z  
2026-02-20T22:09:11.3886348Z  from app.db.base import Base
2026-02-20T22:09:11.3886457Z  
2026-02-20T22:09:11.3886554Z  
2026-02-20T22:09:11.3886695Z  class Recommendation(Base):
2026-02-20T22:09:11.3887355Z      """Modèle pour les recommandations personnalisées d'exercices (Conseils de Maître Jedi)"""
2026-02-20T22:09:11.3887477Z +
2026-02-20T22:09:11.3887639Z      __tablename__ = "recommendations"
2026-02-20T22:09:11.3887746Z -    
2026-02-20T22:09:11.3887865Z +
2026-02-20T22:09:11.3888192Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.3888319Z      __table_args__ = (
2026-02-20T22:09:11.3888662Z -        Index('ix_recommendations_user_completed', 'user_id', 'is_completed'),
2026-02-20T22:09:11.3888951Z -        Index('ix_recommendations_user_priority', 'user_id', 'priority'),
2026-02-20T22:09:11.3889272Z +        Index("ix_recommendations_user_completed", "user_id", "is_completed"),
2026-02-20T22:09:11.3889580Z +        Index("ix_recommendations_user_priority", "user_id", "priority"),
2026-02-20T22:09:11.3889705Z      )
2026-02-20T22:09:11.3889811Z -    
2026-02-20T22:09:11.3889913Z +
2026-02-20T22:09:11.3890140Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3890245Z -    
2026-02-20T22:09:11.3890350Z +
2026-02-20T22:09:11.3890575Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.3891056Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
2026-02-20T22:09:11.3891181Z +    user_id = Column(
2026-02-20T22:09:11.3891549Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True
2026-02-20T22:09:11.3891739Z +    )
2026-02-20T22:09:11.3892023Z      user = relationship("User", back_populates="recommendations")
2026-02-20T22:09:11.3892129Z -    
2026-02-20T22:09:11.3892272Z +
2026-02-20T22:09:11.3892858Z      # Exercice recommandé (optionnel - peut être une recommandation par type)
2026-02-20T22:09:11.3893740Z -    exercise_id = Column(Integer, ForeignKey("exercises.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.3893910Z +    exercise_id = Column(
2026-02-20T22:09:11.3894026Z +        Integer,
2026-02-20T22:09:11.3894241Z +        ForeignKey("exercises.id", ondelete="SET NULL"),
2026-02-20T22:09:11.3894373Z +        nullable=True,
2026-02-20T22:09:11.3894500Z +        index=True,
2026-02-20T22:09:11.3894604Z +    )
2026-02-20T22:09:11.3894891Z      exercise = relationship("Exercise", backref="recommendations")
2026-02-20T22:09:11.3895007Z  
2026-02-20T22:09:11.3895518Z      # Défi logique recommandé (optionnel - recommandations de type "challenge")
2026-02-20T22:09:11.3896118Z -    challenge_id = Column(Integer, ForeignKey("logic_challenges.id", ondelete="SET NULL"), nullable=True, index=True)
2026-02-20T22:09:11.3896264Z +    challenge_id = Column(
2026-02-20T22:09:11.3896380Z +        Integer,
2026-02-20T22:09:11.3896628Z +        ForeignKey("logic_challenges.id", ondelete="SET NULL"),
2026-02-20T22:09:11.3897002Z +        nullable=True,
2026-02-20T22:09:11.3897128Z +        index=True,
2026-02-20T22:09:11.3897234Z +    )
2026-02-20T22:09:11.3897570Z      challenge = relationship("LogicChallenge", backref="recommendations")
2026-02-20T22:09:11.3897686Z  
2026-02-20T22:09:11.3898083Z      # Type de recommandation : "exercise" | "challenge"
2026-02-20T22:09:11.3898541Z -    recommendation_type = Column(String(20), default="exercise", nullable=False, index=True)
2026-02-20T22:09:11.3898653Z -    
2026-02-20T22:09:11.3898810Z +    recommendation_type = Column(
2026-02-20T22:09:11.3899062Z +        String(20), default="exercise", nullable=False, index=True
2026-02-20T22:09:11.3899172Z +    )
2026-02-20T22:09:11.3899288Z +
2026-02-20T22:09:11.3899725Z      # Catégorisation (toujours présent même si exercise_id est NULL)
2026-02-20T22:09:11.3899986Z      exercise_type = Column(String, nullable=False, index=True)
2026-02-20T22:09:11.3900172Z      difficulty = Column(String, nullable=False)
2026-02-20T22:09:11.3900293Z -    
2026-02-20T22:09:11.3900400Z +
2026-02-20T22:09:11.3900640Z      # Méta-données de recommandation
2026-02-20T22:09:11.3901288Z -    priority = Column(Integer, default=5, index=True)  # 1-10 (plus c'est élevé, plus c'est prioritaire)
2026-02-20T22:09:11.3901710Z -    reason = Column(Text, nullable=True)   # Raison de la recommandation en langage naturel
2026-02-20T22:09:11.3902455Z -    is_completed = Column(Boolean, default=False, index=True)  # L'utilisateur a-t-il complété cette recommandation
2026-02-20T22:09:11.3902570Z -    
2026-02-20T22:09:11.3902693Z +    priority = Column(
2026-02-20T22:09:11.3902838Z +        Integer, default=5, index=True
2026-02-20T22:09:11.3903358Z +    )  # 1-10 (plus c'est élevé, plus c'est prioritaire)
2026-02-20T22:09:11.3903490Z +    reason = Column(
2026-02-20T22:09:11.3903622Z +        Text, nullable=True
2026-02-20T22:09:11.3903825Z +    )  # Raison de la recommandation en langage naturel
2026-02-20T22:09:11.3903966Z +    is_completed = Column(
2026-02-20T22:09:11.3904141Z +        Boolean, default=False, index=True
2026-02-20T22:09:11.3904476Z +    )  # L'utilisateur a-t-il complété cette recommandation
2026-02-20T22:09:11.3904591Z +
2026-02-20T22:09:11.3904733Z      # Statistiques d'utilisation
2026-02-20T22:09:11.3905372Z -    shown_count = Column(Integer, default=0)  # Nombre de fois que cette recommandation a été affichée
2026-02-20T22:09:11.3905973Z -    clicked_count = Column(Integer, default=0)  # Nombre de fois que l'utilisateur a cliqué dessus
2026-02-20T22:09:11.3906394Z -    last_clicked_at = Column(DateTime(timezone=True), nullable=True)  # Date du dernier clic
2026-02-20T22:09:11.3906523Z +    shown_count = Column(
2026-02-20T22:09:11.3906651Z +        Integer, default=0
2026-02-20T22:09:11.3907009Z +    )  # Nombre de fois que cette recommandation a été affichée
2026-02-20T22:09:11.3907144Z +    clicked_count = Column(
2026-02-20T22:09:11.3907269Z +        Integer, default=0
2026-02-20T22:09:11.3907584Z +    )  # Nombre de fois que l'utilisateur a cliqué dessus
2026-02-20T22:09:11.3907732Z +    last_clicked_at = Column(
2026-02-20T22:09:11.3907896Z +        DateTime(timezone=True), nullable=True
2026-02-20T22:09:11.3908023Z +    )  # Date du dernier clic
2026-02-20T22:09:11.3908567Z      completed_at = Column(DateTime(timezone=True), nullable=True)  # Date de complétion
2026-02-20T22:09:11.3908676Z -    
2026-02-20T22:09:11.3908780Z +
2026-02-20T22:09:11.3908899Z      # Horodatage
2026-02-20T22:09:11.3909179Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.3909585Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3909693Z -    
2026-02-20T22:09:11.3909799Z -    
2026-02-20T22:09:11.3909902Z -    
2026-02-20T22:09:11.3910028Z +    updated_at = Column(
2026-02-20T22:09:11.3910325Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3910431Z +    )
2026-02-20T22:09:11.3910531Z +
2026-02-20T22:09:11.3910885Z      def __repr__(self):
2026-02-20T22:09:11.3911235Z          exercise_info = f", Exercice {self.exercise_id}" if self.exercise_id else ""
2026-02-20T22:09:11.3911912Z -        return f"<Recommandation: Utilisateur {self.user_id}{exercise_info}, Priorité {self.priority}>" 
2026-02-20T22:09:11.3912230Z \ No newline at end of file
2026-02-20T22:09:11.3912896Z +        return f"<Recommandation: Utilisateur {self.user_id}{exercise_info}, Priorité {self.priority}>"
2026-02-20T22:09:11.3913657Z would reformat /home/runner/work/mathakine/mathakine/app/models/recommendation.py
2026-02-20T22:09:11.3914032Z would reformat /home/runner/work/mathakine/mathakine/app/models/setting.py
2026-02-20T22:09:11.3914567Z --- /home/runner/work/mathakine/mathakine/app/models/setting.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.3915033Z +++ /home/runner/work/mathakine/mathakine/app/models/setting.py	2026-02-20 22:09:11.386021+00:00
2026-02-20T22:09:11.3915180Z @@ -4,26 +4,31 @@
2026-02-20T22:09:11.3915339Z  from app.db.base import Base
2026-02-20T22:09:11.3915472Z  
2026-02-20T22:09:11.3915584Z  
2026-02-20T22:09:11.3915725Z  class Setting(Base):
2026-02-20T22:09:11.3916254Z      """Modèle pour la configuration de l'application (Configuration du Temple)"""
2026-02-20T22:09:11.3916362Z +
2026-02-20T22:09:11.3916517Z      __tablename__ = "settings"
2026-02-20T22:09:11.3916620Z  
2026-02-20T22:09:11.3916821Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.3917093Z      key = Column(String, unique=True, index=True, nullable=False)
2026-02-20T22:09:11.3917269Z      value = Column(String, nullable=True)
2026-02-20T22:09:11.3917587Z      value_json = Column(JSON, nullable=True)  # Pour les valeurs complexes
2026-02-20T22:09:11.3917699Z  
2026-02-20T22:09:11.3917925Z      # Métadonnées
2026-02-20T22:09:11.3918119Z      description = Column(String, nullable=True)
2026-02-20T22:09:11.3918700Z -    category = Column(String, nullable=True)  # Catégorie: système, interface, exercice, etc.
2026-02-20T22:09:11.3919450Z -    is_system = Column(Boolean, default=False)  # Si c'est un paramètre système (non modifiable par l'utilisateur)
2026-02-20T22:09:11.3919791Z -    is_public = Column(Boolean, default=True)   # Si visible dans l'interface
2026-02-20T22:09:11.3919922Z +    category = Column(
2026-02-20T22:09:11.3920070Z +        String, nullable=True
2026-02-20T22:09:11.3920387Z +    )  # Catégorie: système, interface, exercice, etc.
2026-02-20T22:09:11.3920520Z +    is_system = Column(
2026-02-20T22:09:11.3920652Z +        Boolean, default=False
2026-02-20T22:09:11.3921071Z +    )  # Si c'est un paramètre système (non modifiable par l'utilisateur)
2026-02-20T22:09:11.3921392Z +    is_public = Column(Boolean, default=True)  # Si visible dans l'interface
2026-02-20T22:09:11.3921498Z  
2026-02-20T22:09:11.3921623Z      # Horodatage
2026-02-20T22:09:11.3921905Z      created_at = Column(DateTime(timezone=True), default=func.now())
2026-02-20T22:09:11.3922311Z -    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.3922430Z -
2026-02-20T22:09:11.3922542Z -
2026-02-20T22:09:11.3922674Z +    updated_at = Column(
2026-02-20T22:09:11.3923164Z +        DateTime(timezone=True), default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.3923289Z +    )
2026-02-20T22:09:11.3923394Z  
2026-02-20T22:09:11.3923535Z      def __repr__(self):
2026-02-20T22:09:11.3923786Z          return f"<Paramètre: {self.key}>"
2026-02-20T22:09:11.4524718Z --- /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4535294Z +++ /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py	2026-02-20 22:09:11.451011+00:00
2026-02-20T22:09:11.4536252Z @@ -1,60 +1,130 @@
2026-02-20T22:09:11.4536729Z  """
2026-02-20T22:09:11.4537465Z  Module regroupant tous les schémas Pydantic pour la validation de l'API Mathakine.
2026-02-20T22:09:11.4537822Z  À importer pour valider les données entrantes et sortantes.
2026-02-20T22:09:11.4537930Z  """
2026-02-20T22:09:11.4538481Z  
2026-02-20T22:09:11.4538822Z -from app.schemas.attempt import (Attempt, AttemptBase, AttemptBatch,
2026-02-20T22:09:11.4539048Z -                                 AttemptCreate, AttemptInDB, AttemptStats,
2026-02-20T22:09:11.4539198Z -                                 AttemptUpdate)
2026-02-20T22:09:11.4539731Z -from app.schemas.common import (ErrorCode, ErrorResponse, HealthCheck,
2026-02-20T22:09:11.4539991Z -                                ListResponse, PageInfo, Response, StatusCode,
2026-02-20T22:09:11.4540146Z -                                ValidationError)
2026-02-20T22:09:11.4540488Z -from app.schemas.exercise import (Exercise, ExerciseBase, ExerciseCreate,
2026-02-20T22:09:11.4540730Z -                                  ExerciseInDB, ExerciseStats, ExerciseUpdate)
2026-02-20T22:09:11.4541098Z -from app.schemas.logic_challenge import (LogicChallenge, LogicChallengeAttempt,
2026-02-20T22:09:11.4541315Z -                                         LogicChallengeAttemptBase,
2026-02-20T22:09:11.4541537Z -                                         LogicChallengeAttemptCreate,
2026-02-20T22:09:11.4541741Z -                                         LogicChallengeAttemptInDB,
2026-02-20T22:09:11.4541945Z -                                         LogicChallengeAttemptUpdate,
2026-02-20T22:09:11.4542147Z -                                         LogicChallengeBase,
2026-02-20T22:09:11.4542330Z -                                         LogicChallengeCreate,
2026-02-20T22:09:11.4542495Z -                                         LogicChallengeInDB,
2026-02-20T22:09:11.4542668Z -                                         LogicChallengeStats,
2026-02-20T22:09:11.4542840Z -                                         LogicChallengeUpdate)
2026-02-20T22:09:11.4543377Z -from app.schemas.progress import (Progress, ProgressBase, ProgressCreate,
2026-02-20T22:09:11.4543580Z -                                  ProgressInDB, ProgressUpdate,
2026-02-20T22:09:11.4543793Z -                                  UserProgressSummary)
2026-02-20T22:09:11.4544129Z -from app.schemas.user import (Token, TokenData, User, UserBase, UserCreate,
2026-02-20T22:09:11.4544305Z -                              UserInDB, UserLogin, UserUpdate)
2026-02-20T22:09:11.4544597Z -from app.schemas.user_session import (UserSession, UserSessionBase,
2026-02-20T22:09:11.4544810Z -                                      UserSessionInDB, UserSessionRevoke)
2026-02-20T22:09:11.4544960Z +from app.schemas.attempt import (
2026-02-20T22:09:11.4545070Z +    Attempt,
2026-02-20T22:09:11.4545186Z +    AttemptBase,
2026-02-20T22:09:11.4545302Z +    AttemptBatch,
2026-02-20T22:09:11.4545420Z +    AttemptCreate,
2026-02-20T22:09:11.4545530Z +    AttemptInDB,
2026-02-20T22:09:11.4545645Z +    AttemptStats,
2026-02-20T22:09:11.4545757Z +    AttemptUpdate,
2026-02-20T22:09:11.4545858Z +)
2026-02-20T22:09:11.4546004Z +from app.schemas.common import (
2026-02-20T22:09:11.4546112Z +    ErrorCode,
2026-02-20T22:09:11.4546225Z +    ErrorResponse,
2026-02-20T22:09:11.4546342Z +    HealthCheck,
2026-02-20T22:09:11.4546465Z +    ListResponse,
2026-02-20T22:09:11.4546572Z +    PageInfo,
2026-02-20T22:09:11.4546677Z +    Response,
2026-02-20T22:09:11.4546790Z +    StatusCode,
2026-02-20T22:09:11.4546908Z +    ValidationError,
2026-02-20T22:09:11.4547007Z +)
2026-02-20T22:09:11.4547155Z +from app.schemas.exercise import (
2026-02-20T22:09:11.4547273Z +    Exercise,
2026-02-20T22:09:11.4547386Z +    ExerciseBase,
2026-02-20T22:09:11.4547503Z +    ExerciseCreate,
2026-02-20T22:09:11.4547620Z +    ExerciseInDB,
2026-02-20T22:09:11.4547736Z +    ExerciseStats,
2026-02-20T22:09:11.4547860Z +    ExerciseUpdate,
2026-02-20T22:09:11.4547967Z +)
2026-02-20T22:09:11.4548153Z +from app.schemas.logic_challenge import (
2026-02-20T22:09:11.4548280Z +    LogicChallenge,
2026-02-20T22:09:11.4548424Z +    LogicChallengeAttempt,
2026-02-20T22:09:11.4548576Z +    LogicChallengeAttemptBase,
2026-02-20T22:09:11.4548722Z +    LogicChallengeAttemptCreate,
2026-02-20T22:09:11.4548858Z +    LogicChallengeAttemptInDB,
2026-02-20T22:09:11.4549281Z +    LogicChallengeAttemptUpdate,
2026-02-20T22:09:11.4549428Z +    LogicChallengeBase,
2026-02-20T22:09:11.4549564Z +    LogicChallengeCreate,
2026-02-20T22:09:11.4549692Z +    LogicChallengeInDB,
2026-02-20T22:09:11.4549824Z +    LogicChallengeStats,
2026-02-20T22:09:11.4550150Z +    LogicChallengeUpdate,
2026-02-20T22:09:11.4550264Z +)
2026-02-20T22:09:11.4550422Z +from app.schemas.progress import (
2026-02-20T22:09:11.4550545Z +    Progress,
2026-02-20T22:09:11.4550659Z +    ProgressBase,
2026-02-20T22:09:11.4550784Z +    ProgressCreate,
2026-02-20T22:09:11.4550911Z +    ProgressInDB,
2026-02-20T22:09:11.4551040Z +    ProgressUpdate,
2026-02-20T22:09:11.4551174Z +    UserProgressSummary,
2026-02-20T22:09:11.4551280Z +)
2026-02-20T22:09:11.4551426Z +from app.schemas.user import (
2026-02-20T22:09:11.4551535Z +    Token,
2026-02-20T22:09:11.4551647Z +    TokenData,
2026-02-20T22:09:11.4551760Z +    User,
2026-02-20T22:09:11.4551866Z +    UserBase,
2026-02-20T22:09:11.4551988Z +    UserCreate,
2026-02-20T22:09:11.4552089Z +    UserInDB,
2026-02-20T22:09:11.4552190Z +    UserLogin,
2026-02-20T22:09:11.4552287Z +    UserUpdate,
2026-02-20T22:09:11.4552373Z +)
2026-02-20T22:09:11.4552542Z +from app.schemas.user_session import (
2026-02-20T22:09:11.4552650Z +    UserSession,
2026-02-20T22:09:11.4552774Z +    UserSessionBase,
2026-02-20T22:09:11.4552887Z +    UserSessionInDB,
2026-02-20T22:09:11.4553219Z +    UserSessionRevoke,
2026-02-20T22:09:11.4553328Z +)
2026-02-20T22:09:11.4553436Z  
2026-02-20T22:09:11.4553573Z  # Export all schemas
2026-02-20T22:09:11.4553679Z  __all__ = [
2026-02-20T22:09:11.4553795Z      # User schemas
2026-02-20T22:09:11.4554230Z -    "UserBase", "UserCreate", "UserUpdate", "UserInDB", "User", "UserLogin", "Token", "TokenData",
2026-02-20T22:09:11.4554345Z -    
2026-02-20T22:09:11.4554460Z +    "UserBase",
2026-02-20T22:09:11.4554570Z +    "UserCreate",
2026-02-20T22:09:11.4554698Z +    "UserUpdate",
2026-02-20T22:09:11.4554811Z +    "UserInDB",
2026-02-20T22:09:11.4554927Z +    "User",
2026-02-20T22:09:11.4555035Z +    "UserLogin",
2026-02-20T22:09:11.4555142Z +    "Token",
2026-02-20T22:09:11.4555248Z +    "TokenData",
2026-02-20T22:09:11.4555375Z      # User Session schemas
2026-02-20T22:09:11.4555722Z -    "UserSessionBase", "UserSessionInDB", "UserSession", "UserSessionRevoke",
2026-02-20T22:09:11.4555821Z -
2026-02-20T22:09:11.4555948Z +    "UserSessionBase",
2026-02-20T22:09:11.4556074Z +    "UserSessionInDB",
2026-02-20T22:09:11.4556195Z +    "UserSession",
2026-02-20T22:09:11.4556326Z +    "UserSessionRevoke",
2026-02-20T22:09:11.4556447Z      # Exercise schemas
2026-02-20T22:09:11.4556915Z -    "ExerciseBase", "ExerciseCreate", "ExerciseUpdate", "ExerciseInDB", "Exercise", "ExerciseStats",
2026-02-20T22:09:11.4557029Z -
2026-02-20T22:09:11.4557155Z +    "ExerciseBase",
2026-02-20T22:09:11.4557288Z +    "ExerciseCreate",
2026-02-20T22:09:11.4557420Z +    "ExerciseUpdate",
2026-02-20T22:09:11.4557533Z +    "ExerciseInDB",
2026-02-20T22:09:11.4557655Z +    "Exercise",
2026-02-20T22:09:11.4557785Z +    "ExerciseStats",
2026-02-20T22:09:11.4557909Z      # Attempt schemas
2026-02-20T22:09:11.4558341Z -    "AttemptBase", "AttemptCreate", "AttemptUpdate", "AttemptInDB", "Attempt", "AttemptBatch"\
2026-02-20T22:09:11.4558471Z -        , "AttemptStats",
2026-02-20T22:09:11.4558581Z -
2026-02-20T22:09:11.4558694Z +    "AttemptBase",
2026-02-20T22:09:11.4558809Z +    "AttemptCreate",
2026-02-20T22:09:11.4558931Z +    "AttemptUpdate",
2026-02-20T22:09:11.4559046Z +    "AttemptInDB",
2026-02-20T22:09:11.4559157Z +    "Attempt",
2026-02-20T22:09:11.4559280Z +    "AttemptBatch",
2026-02-20T22:09:11.4559407Z +    "AttemptStats",
2026-02-20T22:09:11.4559536Z      # Progress schemas
2026-02-20T22:09:11.4559915Z -    "ProgressBase", "ProgressCreate", "ProgressUpdate", "ProgressInDB", "Progress"\
2026-02-20T22:09:11.4560068Z -        , "UserProgressSummary",
2026-02-20T22:09:11.4560174Z -
2026-02-20T22:09:11.4560294Z +    "ProgressBase",
2026-02-20T22:09:11.4560665Z +    "ProgressCreate",
2026-02-20T22:09:11.4560806Z +    "ProgressUpdate",
2026-02-20T22:09:11.4560924Z +    "ProgressInDB",
2026-02-20T22:09:11.4561030Z +    "Progress",
2026-02-20T22:09:11.4561175Z +    "UserProgressSummary",
2026-02-20T22:09:11.4561317Z      # Logic Challenge schemas
2026-02-20T22:09:11.4562002Z -    "LogicChallengeBase", "LogicChallengeCreate", "LogicChallengeUpdate", "LogicChallengeInDB"\
2026-02-20T22:09:11.4562172Z -        , "LogicChallenge",
2026-02-20T22:09:11.4562673Z -    "LogicChallengeAttemptBase", "LogicChallengeAttemptCreate", "LogicChallengeAttemptUpdate",
2026-02-20T22:09:11.4563251Z -    "LogicChallengeAttemptInDB", "LogicChallengeAttempt", "LogicChallengeStats",
2026-02-20T22:09:11.4563363Z -
2026-02-20T22:09:11.4563500Z +    "LogicChallengeBase",
2026-02-20T22:09:11.4563631Z +    "LogicChallengeCreate",
2026-02-20T22:09:11.4563774Z +    "LogicChallengeUpdate",
2026-02-20T22:09:11.4563900Z +    "LogicChallengeInDB",
2026-02-20T22:09:11.4564018Z +    "LogicChallenge",
2026-02-20T22:09:11.4564183Z +    "LogicChallengeAttemptBase",
2026-02-20T22:09:11.4564340Z +    "LogicChallengeAttemptCreate",
2026-02-20T22:09:11.4564520Z +    "LogicChallengeAttemptUpdate",
2026-02-20T22:09:11.4564666Z +    "LogicChallengeAttemptInDB",
2026-02-20T22:09:11.4564805Z +    "LogicChallengeAttempt",
2026-02-20T22:09:11.4564954Z +    "LogicChallengeStats",
2026-02-20T22:09:11.4565088Z      # Common response schemas
2026-02-20T22:09:11.4565443Z -    "Response", "ListResponse", "ErrorResponse", "StatusCode", "ErrorCode", "PageInfo"\
2026-02-20T22:09:11.4565604Z -        , "ValidationError", "HealthCheck"
2026-02-20T22:09:11.4565714Z +    "Response",
2026-02-20T22:09:11.4565838Z +    "ListResponse",
2026-02-20T22:09:11.4565971Z +    "ErrorResponse",
2026-02-20T22:09:11.4566099Z +    "StatusCode",
2026-02-20T22:09:11.4566221Z +    "ErrorCode",
2026-02-20T22:09:11.4566333Z +    "PageInfo",
2026-02-20T22:09:11.4566468Z +    "ValidationError",
2026-02-20T22:09:11.4566584Z +    "HealthCheck",
2026-02-20T22:09:11.4566701Z  ]
2026-02-20T22:09:11.4567379Z --- /home/runner/work/mathakine/mathakine/app/models/user_session.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4567890Z +++ /home/runner/work/mathakine/mathakine/app/models/user_session.py	2026-02-20 22:09:11.452858+00:00
2026-02-20T22:09:11.4568347Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/all_schemas.py
2026-02-20T22:09:11.4568731Z would reformat /home/runner/work/mathakine/mathakine/app/models/user_session.py
2026-02-20T22:09:11.4568854Z @@ -1,26 +1,37 @@
2026-02-20T22:09:11.4568964Z  """
2026-02-20T22:09:11.4569376Z  Modèle SQLAlchemy pour les sessions utilisateur
2026-02-20T22:09:11.4569495Z  """
2026-02-20T22:09:11.4569830Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, ForeignKey, Index,
2026-02-20T22:09:11.4569981Z -                        Integer, String, Text)
2026-02-20T22:09:11.4570088Z +
2026-02-20T22:09:11.4570222Z +from sqlalchemy import (
2026-02-20T22:09:11.4570325Z +    JSON,
2026-02-20T22:09:11.4570449Z +    Boolean,
2026-02-20T22:09:11.4570567Z +    Column,
2026-02-20T22:09:11.4570685Z +    DateTime,
2026-02-20T22:09:11.4570803Z +    ForeignKey,
2026-02-20T22:09:11.4570921Z +    Index,
2026-02-20T22:09:11.4571030Z +    Integer,
2026-02-20T22:09:11.4587151Z +    String,
2026-02-20T22:09:11.4587307Z +    Text,
2026-02-20T22:09:11.4587437Z +)
2026-02-20T22:09:11.4587674Z  from sqlalchemy.dialects.postgresql import INET
2026-02-20T22:09:11.4587863Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.4588019Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.4588126Z  
2026-02-20T22:09:11.4588286Z  from app.db.base import Base
2026-02-20T22:09:11.4588396Z  
2026-02-20T22:09:11.4588499Z  
2026-02-20T22:09:11.4588639Z  class UserSession(Base):
2026-02-20T22:09:11.4589015Z      """Modèle pour les sessions utilisateur"""
2026-02-20T22:09:11.4589117Z +
2026-02-20T22:09:11.4589251Z      __tablename__ = "user_sessions"
2026-02-20T22:09:11.4589385Z -    __table_args__ = (
2026-02-20T22:09:11.4589857Z -        Index('idx_user_sessions_user_id', 'user_id'),
2026-02-20T22:09:11.4589968Z -    )
2026-02-20T22:09:11.4590248Z +    __table_args__ = (Index("idx_user_sessions_user_id", "user_id"),)
2026-02-20T22:09:11.4590362Z  
2026-02-20T22:09:11.4590573Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4591176Z -    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False)
2026-02-20T22:09:11.4591321Z +    user_id = Column(
2026-02-20T22:09:11.4591640Z +        Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False
2026-02-20T22:09:11.4591748Z +    )
2026-02-20T22:09:11.4592102Z      session_token = Column(String(255), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.4592281Z      device_info = Column(JSON, nullable=True)
2026-02-20T22:09:11.4592456Z      ip_address = Column(INET, nullable=True)
2026-02-20T22:09:11.4592618Z      user_agent = Column(Text, nullable=True)
2026-02-20T22:09:11.4592806Z      location_data = Column(JSON, nullable=True)
2026-02-20T22:09:11.4592938Z @@ -36,12 +47,14 @@
2026-02-20T22:09:11.4593545Z          return f"<UserSession {self.id}: User {self.user_id}, Active: {self.is_active}>"
2026-02-20T22:09:11.4593663Z  
2026-02-20T22:09:11.4593818Z      def is_expired(self) -> bool:
2026-02-20T22:09:11.4594130Z          """Vérifier si la session a expiré"""
2026-02-20T22:09:11.4594321Z          from datetime import datetime, timezone
2026-02-20T22:09:11.4594429Z +
2026-02-20T22:09:11.4594667Z          return datetime.now(timezone.utc) > self.expires_at
2026-02-20T22:09:11.4594776Z  
2026-02-20T22:09:11.4594958Z      def extend_session(self, hours: int = 24):
2026-02-20T22:09:11.4595102Z          """Prolonger la session"""
2026-02-20T22:09:11.4595326Z          from datetime import datetime, timedelta, timezone
2026-02-20T22:09:11.4595444Z +
2026-02-20T22:09:11.4595766Z          self.expires_at = datetime.now(timezone.utc) + timedelta(hours=hours)
2026-02-20T22:09:11.4595972Z          self.last_activity = datetime.now(timezone.utc)
2026-02-20T22:09:11.4715362Z --- /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.4717473Z +++ /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py	2026-02-20 22:09:11.468429+00:00
2026-02-20T22:09:11.4719630Z @@ -1,91 +1,124 @@
2026-02-20T22:09:11.4720918Z would reformat /home/runner/work/mathakine/mathakine/app/models/logic_challenge.py
2026-02-20T22:09:11.4721673Z  from enum import Enum as PyEnum
2026-02-20T22:09:11.4724096Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:11.4727276Z  
2026-02-20T22:09:11.4734235Z -from sqlalchemy import (JSON, Boolean, Column, DateTime, Enum, Float,
2026-02-20T22:09:11.4735137Z -                        ForeignKey, Index, Integer, String, Table, Text)
2026-02-20T22:09:11.4735813Z +from sqlalchemy import (
2026-02-20T22:09:11.4736289Z +    JSON,
2026-02-20T22:09:11.4736669Z +    Boolean,
2026-02-20T22:09:11.4737057Z +    Column,
2026-02-20T22:09:11.4737444Z +    DateTime,
2026-02-20T22:09:11.4737951Z +    Enum,
2026-02-20T22:09:11.4738934Z +    Float,
2026-02-20T22:09:11.4739536Z +    ForeignKey,
2026-02-20T22:09:11.4740575Z +    Index,
2026-02-20T22:09:11.4741046Z +    Integer,
2026-02-20T22:09:11.4741449Z +    String,
2026-02-20T22:09:11.4741831Z +    Table,
2026-02-20T22:09:11.4742271Z +    Text,
2026-02-20T22:09:11.4742664Z +)
2026-02-20T22:09:11.4743272Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.4743908Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.4744389Z  
2026-02-20T22:09:11.4744773Z  from app.db.base import Base
2026-02-20T22:09:11.4745235Z  
2026-02-20T22:09:11.4745584Z  
2026-02-20T22:09:11.4745984Z  class LogicChallengeType(str, PyEnum):
2026-02-20T22:09:11.4746799Z      """Types de défis logiques"""
2026-02-20T22:09:11.4747510Z -    SEQUENCE = "sequence"          # Suites logiques (nombres, formes, etc.)
2026-02-20T22:09:11.4748378Z -    PATTERN = "pattern"            # Reconnaissance de motifs
2026-02-20T22:09:11.4749777Z -    VISUAL = "visual"              # Défis visuels et spatiaux (inclut rotation, symétrie)
2026-02-20T22:09:11.4750891Z -    PUZZLE = "puzzle"              # Puzzles interactifs (réorganisation, ordre)
2026-02-20T22:09:11.4753476Z -    RIDDLE = "riddle"              # Énigmes textuelles avec grilles
2026-02-20T22:09:11.4754575Z -    DEDUCTION = "deduction"        # Raisonnement déductif (grilles logiques)
2026-02-20T22:09:11.4755444Z -    PROBABILITY = "probability"    # Probabilités simples
2026-02-20T22:09:11.4756173Z -    GRAPH = "graph"                # Problèmes de graphes
2026-02-20T22:09:11.4756861Z -    CODING = "coding"              # Codage et décryptage
2026-02-20T22:09:11.4757528Z -    CHESS = "chess"                # Problèmes d'échecs
2026-02-20T22:09:11.4758202Z -    CUSTOM = "custom"              # Défis personnalisés
2026-02-20T22:09:11.4758673Z -
2026-02-20T22:09:11.4758923Z +
2026-02-20T22:09:11.4759343Z +    SEQUENCE = "sequence"  # Suites logiques (nombres, formes, etc.)
2026-02-20T22:09:11.4760023Z +    PATTERN = "pattern"  # Reconnaissance de motifs
2026-02-20T22:09:11.4760835Z +    VISUAL = "visual"  # Défis visuels et spatiaux (inclut rotation, symétrie)
2026-02-20T22:09:11.4761744Z +    PUZZLE = "puzzle"  # Puzzles interactifs (réorganisation, ordre)
2026-02-20T22:09:11.4762526Z +    RIDDLE = "riddle"  # Énigmes textuelles avec grilles
2026-02-20T22:09:11.4763500Z +    DEDUCTION = "deduction"  # Raisonnement déductif (grilles logiques)
2026-02-20T22:09:11.4764301Z +    PROBABILITY = "probability"  # Probabilités simples
2026-02-20T22:09:11.4764927Z +    GRAPH = "graph"  # Problèmes de graphes
2026-02-20T22:09:11.4765497Z +    CODING = "coding"  # Codage et décryptage
2026-02-20T22:09:11.4766052Z +    CHESS = "chess"  # Problèmes d'échecs
2026-02-20T22:09:11.4766627Z +    CUSTOM = "custom"  # Défis personnalisés
2026-02-20T22:09:11.4767070Z  
2026-02-20T22:09:11.4767320Z  
2026-02-20T22:09:11.4767614Z  class AgeGroup(str, PyEnum):
2026-02-20T22:09:11.4767981Z      """
2026-02-20T22:09:11.4768407Z      Groupes d'âge pour les défis logiques.
2026-02-20T22:09:11.4768832Z -    
2026-02-20T22:09:11.4769081Z +
2026-02-20T22:09:11.4769676Z      IMPORTANT: Les valeurs DOIVENT correspondre EXACTEMENT aux valeurs de l'ENUM PostgreSQL.
2026-02-20T22:09:11.4770434Z -    
2026-02-20T22:09:11.4770694Z +
2026-02-20T22:09:11.4771120Z      Mapping frontend → DB:
2026-02-20T22:09:11.4771593Z      - "6-8"      → GROUP_6_8
2026-02-20T22:09:11.4772045Z      - "9-11"     → GROUP_10_12
2026-02-20T22:09:11.4772503Z      - "12-14"    → GROUP_13_15
2026-02-20T22:09:11.4772947Z      - "15-17"    → GROUP_15_17
2026-02-20T22:09:11.4773583Z      - "adulte"   → ADULT
2026-02-20T22:09:11.4774002Z      - "tous-ages"→ ALL_AGES
2026-02-20T22:09:11.4774366Z      """
2026-02-20T22:09:11.4774640Z +
2026-02-20T22:09:11.4775122Z      # Groupes d'âge - alignés avec les valeurs PostgreSQL
2026-02-20T22:09:11.4775715Z -    GROUP_6_8 = "GROUP_6_8"      # 6-8 ans (CP-CE2)
2026-02-20T22:09:11.4776435Z -    GROUP_10_12 = "GROUP_10_12"  # 9-11 ans (CM1-CM2-6e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4777394Z -    GROUP_13_15 = "GROUP_13_15"  # 12-14 ans (5e-4e-3e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4778113Z +    GROUP_6_8 = "GROUP_6_8"  # 6-8 ans (CP-CE2)
2026-02-20T22:09:11.4778557Z +    GROUP_10_12 = (
2026-02-20T22:09:11.4779087Z +        "GROUP_10_12"  # 9-11 ans (CM1-CM2-6e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4779687Z +    )
2026-02-20T22:09:11.4779969Z +    GROUP_13_15 = (
2026-02-20T22:09:11.4780459Z +        "GROUP_13_15"  # 12-14 ans (5e-4e-3e) - legacy name, kept for compatibility
2026-02-20T22:09:11.4781067Z +    )
2026-02-20T22:09:11.4781540Z      GROUP_15_17 = "GROUP_15_17"  # 15-17 ans (Lycée)
2026-02-20T22:09:11.4782049Z -    ADULT = "ADULT"              # Adultes (18+)
2026-02-20T22:09:11.4782626Z -    ALL_AGES = "ALL_AGES"        # Tous âges
2026-02-20T22:09:11.4783268Z +    ADULT = "ADULT"  # Adultes (18+)
2026-02-20T22:09:11.4783789Z +    ALL_AGES = "ALL_AGES"  # Tous âges
2026-02-20T22:09:11.4784697Z      # AGE_9_12 = "9-12"         # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4785430Z      # AGE_12_13 = "12-13"       # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4786121Z      # AGE_13_PLUS = "13+"       # SUPPRIMÉ - n'existe pas en DB
2026-02-20T22:09:11.4786627Z  
2026-02-20T22:09:11.4787179Z  
2026-02-20T22:09:11.4787433Z -
2026-02-20T22:09:11.4787724Z  class LogicChallenge(Base):
2026-02-20T22:09:11.4788227Z      """Modèle pour les défis logiques"""
2026-02-20T22:09:11.4788649Z +
2026-02-20T22:09:11.4788938Z      __tablename__ = "logic_challenges"
2026-02-20T22:09:11.4789346Z -    
2026-02-20T22:09:11.4789598Z +
2026-02-20T22:09:11.4790109Z      # Index composites pour les requêtes de filtrage fréquentes
2026-02-20T22:09:11.4790657Z      __table_args__ = (
2026-02-20T22:09:11.4791168Z -        Index('ix_challenges_type_age', 'challenge_type', 'age_group'),
2026-02-20T22:09:11.4791957Z -        Index('ix_challenges_archived_type', 'is_archived', 'challenge_type'),
2026-02-20T22:09:11.4792745Z +        Index("ix_challenges_type_age", "challenge_type", "age_group"),
2026-02-20T22:09:11.4793700Z +        Index("ix_challenges_archived_type", "is_archived", "challenge_type"),
2026-02-20T22:09:11.4794286Z      )
2026-02-20T22:09:11.4794536Z  
2026-02-20T22:09:11.4794884Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4795351Z  
2026-02-20T22:09:11.4795669Z      # Métadonnées
2026-02-20T22:09:11.4796033Z      title = Column(String(255), nullable=False)
2026-02-20T22:09:11.4796537Z      description = Column(Text, nullable=False)
2026-02-20T22:09:11.4797527Z -    challenge_type = Column(Enum(LogicChallengeType, name="logicchallengetype", create_type=False), nullable=False, index=True)
2026-02-20T22:09:11.4798839Z -    age_group = Column(Enum(AgeGroup, name="agegroup", create_type=False), nullable=False, index=True)
2026-02-20T22:09:11.4799980Z -    difficulty = Column(String(50), nullable=True, index=True)  # Optionnel pour compatibilité
2026-02-20T22:09:11.4800694Z -    
2026-02-20T22:09:11.4800976Z +    challenge_type = Column(
2026-02-20T22:09:11.4801574Z +        Enum(LogicChallengeType, name="logicchallengetype", create_type=False),
2026-02-20T22:09:11.4802218Z +        nullable=False,
2026-02-20T22:09:11.4802549Z +        index=True,
2026-02-20T22:09:11.4802855Z +    )
2026-02-20T22:09:11.4803275Z +    age_group = Column(
2026-02-20T22:09:11.4803861Z +        Enum(AgeGroup, name="agegroup", create_type=False), nullable=False, index=True
2026-02-20T22:09:11.4804502Z +    )
2026-02-20T22:09:11.4804780Z +    difficulty = Column(
2026-02-20T22:09:11.4805154Z +        String(50), nullable=True, index=True
2026-02-20T22:09:11.4805668Z +    )  # Optionnel pour compatibilité
2026-02-20T22:09:11.4806061Z +
2026-02-20T22:09:11.4806367Z      # Contenu du défi
2026-02-20T22:09:11.4806955Z      content = Column(Text, nullable=True)  # Contenu formaté du défi
2026-02-20T22:09:11.4807884Z      question = Column(Text, nullable=True)  # Question spécifique (pour compatibilité)
2026-02-20T22:09:11.4808700Z      solution = Column(Text, nullable=True)  # Solution technique
2026-02-20T22:09:11.4809671Z -    correct_answer = Column(String(255), nullable=True)  # Réponse courte (pour compatibilité)
2026-02-20T22:09:11.4810403Z +    correct_answer = Column(
2026-02-20T22:09:11.4810771Z +        String(255), nullable=True
2026-02-20T22:09:11.4811278Z +    )  # Réponse courte (pour compatibilité)
2026-02-20T22:09:11.4811950Z      choices = Column(JSON, nullable=True)  # Choix possibles (pour les QCM)
2026-02-20T22:09:11.4813340Z -    solution_explanation = Column(Text, nullable=True)  # Explication détaillée (alias pour solution)
2026-02-20T22:09:11.4814792Z -    visual_data = Column(JSON, nullable=True)  # Données pour visualisation (graphes, formes, etc.)
2026-02-20T22:09:11.4815583Z -    
2026-02-20T22:09:11.4815900Z +    solution_explanation = Column(
2026-02-20T22:09:11.4816324Z +        Text, nullable=True
2026-02-20T22:09:11.4816909Z +    )  # Explication détaillée (alias pour solution)
2026-02-20T22:09:11.4817712Z +    visual_data = Column(
2026-02-20T22:09:11.4818091Z +        JSON, nullable=True
2026-02-20T22:09:11.4818724Z +    )  # Données pour visualisation (graphes, formes, etc.)
2026-02-20T22:09:11.4819238Z +
2026-02-20T22:09:11.4819779Z      hints = Column(JSON, nullable=True)
2026-02-20T22:09:11.4820305Z      is_active = Column(Boolean, default=True)
2026-02-20T22:09:11.4821038Z      creator_id = Column(Integer, ForeignKey("users.id"), nullable=True, index=True)
2026-02-20T22:09:11.4822147Z -    created_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.4823199Z +    created_at = Column(
2026-02-20T22:09:11.4823760Z +        DateTime(timezone=True), server_default=func.now(), index=True
2026-02-20T22:09:11.4824371Z +    )  # Tri chronologique
2026-02-20T22:09:11.4824933Z      updated_at = Column(DateTime(timezone=True), onupdate=func.now())
2026-02-20T22:09:11.4825524Z  
2026-02-20T22:09:11.4825961Z      # Métadonnées d'évaluation
2026-02-20T22:09:11.4826638Z      difficulty_rating = Column(Float, default=3.0)  # Échelle 1-5
2026-02-20T22:09:11.4827639Z      estimated_time_minutes = Column(Integer, default=15)  # Temps estimé en minutes
2026-02-20T22:09:11.4828343Z @@ -95,82 +128,93 @@
2026-02-20T22:09:11.4829022Z      image_url = Column(String, nullable=True)  # URL de l'image associée
2026-02-20T22:09:11.4829921Z      source_reference = Column(String, nullable=True)  # Source (concours, livre, etc.)
2026-02-20T22:09:11.4830979Z      tags = Column(String, nullable=True)  # Tags séparés par des virgules
2026-02-20T22:09:11.4831592Z  
2026-02-20T22:09:11.4832004Z      # Métadonnées pour la génération
2026-02-20T22:09:11.4832907Z -    is_template = Column(Boolean, default=False)  # S'il s'agit d'un template pour génération
2026-02-20T22:09:11.4833897Z +    is_template = Column(
2026-02-20T22:09:11.4834286Z +        Boolean, default=False
2026-02-20T22:09:11.4834874Z +    )  # S'il s'agit d'un template pour génération
2026-02-20T22:09:11.4835880Z      generation_parameters = Column(JSON, nullable=True)  # Paramètres pour la génération
2026-02-20T22:09:11.4836627Z  
2026-02-20T22:09:11.4836958Z      # États
2026-02-20T22:09:11.4837661Z      is_archived = Column(Boolean, default=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.4838394Z      view_count = Column(Integer, default=0)
2026-02-20T22:09:11.4838832Z  
2026-02-20T22:09:11.4839102Z      # Relations
2026-02-20T22:09:11.4839878Z -    attempts = relationship("LogicChallengeAttempt", back_populates="challenge", cascade="all, delete-orphan")
2026-02-20T22:09:11.4840811Z +    attempts = relationship(
2026-02-20T22:09:11.4841228Z +        "LogicChallengeAttempt",
2026-02-20T22:09:11.4841664Z +        back_populates="challenge",
2026-02-20T22:09:11.4842117Z +        cascade="all, delete-orphan",
2026-02-20T22:09:11.4842537Z +    )
2026-02-20T22:09:11.4843219Z      creator = relationship("User", back_populates="created_logic_challenges")
2026-02-20T22:09:11.4843907Z  
2026-02-20T22:09:11.4844229Z      def to_dict(self) -> Dict[str, Any]:
2026-02-20T22:09:11.4845093Z          """Convertit le modèle en dictionnaire avec conversion des énumérations."""
2026-02-20T22:09:11.4845837Z          from datetime import datetime, timezone
2026-02-20T22:09:11.4846290Z  
2026-02-20T22:09:11.4846712Z          from app.utils.db_helpers import get_python_enum_value
2026-02-20T22:09:11.4847299Z  
2026-02-20T22:09:11.4847729Z          # Créer le dictionnaire de base
2026-02-20T22:09:11.4848359Z          result = {c.name: getattr(self, c.name) for c in self.__table__.columns}
2026-02-20T22:09:11.4848991Z -        
2026-02-20T22:09:11.4849277Z +
2026-02-20T22:09:11.4849869Z          # Convertir les énumérations PostgreSQL vers les valeurs Python
2026-02-20T22:09:11.4850532Z -        if result.get('challenge_type'):
2026-02-20T22:09:11.4851358Z -            result['challenge_type'] = get_python_enum_value(LogicChallengeType, result['challenge_type'])
2026-02-20T22:09:11.4852434Z -        
2026-02-20T22:09:11.4852740Z -        if result.get('age_group'):
2026-02-20T22:09:11.4853585Z -            result['age_group'] = get_python_enum_value(AgeGroup, result['age_group'])
2026-02-20T22:09:11.4854240Z -        
2026-02-20T22:09:11.4854566Z +        if result.get("challenge_type"):
2026-02-20T22:09:11.4855356Z +            result["challenge_type"] = get_python_enum_value(
2026-02-20T22:09:11.4856007Z +                LogicChallengeType, result["challenge_type"]
2026-02-20T22:09:11.4856513Z +            )
2026-02-20T22:09:11.4856791Z +
2026-02-20T22:09:11.4857084Z +        if result.get("age_group"):
2026-02-20T22:09:11.4857715Z +            result["age_group"] = get_python_enum_value(AgeGroup, result["age_group"])
2026-02-20T22:09:11.4858363Z +
2026-02-20T22:09:11.4858902Z          # Gérer le champ hints (conversion JSON si nécessaire)
2026-02-20T22:09:11.4859455Z -        if result.get('hints'):
2026-02-20T22:09:11.4859905Z -            if isinstance(result['hints'], str):
2026-02-20T22:09:11.4860394Z +        if result.get("hints"):
2026-02-20T22:09:11.4860827Z +            if isinstance(result["hints"], str):
2026-02-20T22:09:11.4861539Z                  # Si c'est une chaîne, essayer de la parser en JSON
2026-02-20T22:09:11.4862076Z                  try:
2026-02-20T22:09:11.4862418Z                      import json
2026-02-20T22:09:11.4862853Z -                    result['hints'] = json.loads(result['hints'])
2026-02-20T22:09:11.4863558Z +
2026-02-20T22:09:11.4863921Z +                    result["hints"] = json.loads(result["hints"])
2026-02-20T22:09:11.4864514Z                  except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:11.4865243Z                      # Si ça échoue, transformer en liste simple
2026-02-20T22:09:11.4865821Z -                    result['hints'] = [result['hints']]
2026-02-20T22:09:11.4866380Z -            elif not isinstance(result['hints'], list):
2026-02-20T22:09:11.4866889Z -                result['hints'] = []
2026-02-20T22:09:11.4867358Z +                    result["hints"] = [result["hints"]]
2026-02-20T22:09:11.4867885Z +            elif not isinstance(result["hints"], list):
2026-02-20T22:09:11.4868381Z +                result["hints"] = []
2026-02-20T22:09:11.4868777Z          else:
2026-02-20T22:09:11.4869097Z -            result['hints'] = []
2026-02-20T22:09:11.4869486Z -        
2026-02-20T22:09:11.4869782Z +            result["hints"] = []
2026-02-20T22:09:11.4870140Z +
2026-02-20T22:09:11.4870761Z          # Gérer les dates (s'assurer qu'elles existent comme objets datetime)
2026-02-20T22:09:11.4871427Z          now = datetime.now(timezone.utc)
2026-02-20T22:09:11.4871901Z -        if not result.get('created_at'):
2026-02-20T22:09:11.4872370Z -            result['created_at'] = now
2026-02-20T22:09:11.4872832Z -        if not result.get('updated_at'):
2026-02-20T22:09:11.4873524Z -            result['updated_at'] = now
2026-02-20T22:09:11.4873951Z -            
2026-02-20T22:09:11.4874291Z +        if not result.get("created_at"):
2026-02-20T22:09:11.4874767Z +            result["created_at"] = now
2026-02-20T22:09:11.4875228Z +        if not result.get("updated_at"):
2026-02-20T22:09:11.4875700Z +            result["updated_at"] = now
2026-02-20T22:09:11.4876114Z +
2026-02-20T22:09:11.4876385Z          return result
2026-02-20T22:09:11.4876707Z  
2026-02-20T22:09:11.4876990Z      def __repr__(self):
2026-02-20T22:09:11.4877730Z          return f"<LogicChallenge {self.id}: {self.title} (Age: {self.age_group}, Type: {self.challenge_type})>"
2026-02-20T22:09:11.4878550Z  
2026-02-20T22:09:11.4878802Z  
2026-02-20T22:09:11.4879049Z -
2026-02-20T22:09:11.4879351Z  class LogicChallengeAttempt(Base):
2026-02-20T22:09:11.4880111Z      """Modèle pour les tentatives de résolution de défis logiques"""
2026-02-20T22:09:11.4880678Z +
2026-02-20T22:09:11.4881017Z      __tablename__ = "logic_challenge_attempts"
2026-02-20T22:09:11.4881471Z -    
2026-02-20T22:09:11.4881739Z +
2026-02-20T22:09:11.4882218Z      # Index composites pour les requêtes fréquentes
2026-02-20T22:09:11.4883184Z      __table_args__ = (
2026-02-20T22:09:11.4883763Z -        Index('ix_logic_attempts_user_challenge', 'user_id', 'challenge_id'),
2026-02-20T22:09:11.4884564Z -        Index('ix_logic_attempts_user_correct', 'user_id', 'is_correct'),
2026-02-20T22:09:11.4885587Z +        Index("ix_logic_attempts_user_challenge", "user_id", "challenge_id"),
2026-02-20T22:09:11.4886413Z +        Index("ix_logic_attempts_user_correct", "user_id", "is_correct"),
2026-02-20T22:09:11.4887004Z      )
2026-02-20T22:09:11.4887276Z  
2026-02-20T22:09:11.4887633Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.4888125Z  
2026-02-20T22:09:11.4888469Z      # Relations (avec index sur les FK pour les JOINs)
2026-02-20T22:09:11.4889208Z      user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
2026-02-20T22:09:11.4890067Z      user = relationship("User", back_populates="logic_challenge_attempts")
2026-02-20T22:09:11.4891121Z -    challenge_id = Column(Integer, ForeignKey("logic_challenges.id"), nullable=False, index=True)
2026-02-20T22:09:11.4891937Z +    challenge_id = Column(
2026-02-20T22:09:11.4892525Z +        Integer, ForeignKey("logic_challenges.id"), nullable=False, index=True
2026-02-20T22:09:11.4893372Z +    )
2026-02-20T22:09:11.4893864Z      challenge = relationship("LogicChallenge", back_populates="attempts")
2026-02-20T22:09:11.4894481Z  
2026-02-20T22:09:11.4894883Z      # Données de tentative
2026-02-20T22:09:11.4895318Z      user_solution = Column(Text, nullable=False)
2026-02-20T22:09:11.4896166Z      is_correct = Column(Boolean, nullable=False, index=True)  # Filtrage fréquent
2026-02-20T22:09:11.4896836Z @@ -178,15 +222,19 @@
2026-02-20T22:09:11.4897143Z  
2026-02-20T22:09:11.4897516Z      # Indices utilisés
2026-02-20T22:09:11.4897920Z      hints_used = Column(Integer, default=0)
2026-02-20T22:09:11.4898354Z  
2026-02-20T22:09:11.4898691Z      # Métadonnées
2026-02-20T22:09:11.4899559Z -    attempt_number = Column(Integer, default=1)  # Numéro de tentative pour ce défi et cet utilisateur
2026-02-20T22:09:11.4900427Z +    attempt_number = Column(
2026-02-20T22:09:11.4900824Z +        Integer, default=1
2026-02-20T22:09:11.4901455Z +    )  # Numéro de tentative pour ce défi et cet utilisateur
2026-02-20T22:09:11.4902158Z      notes = Column(Text, nullable=True)  # Notes de l'utilisateur
2026-02-20T22:09:11.4902715Z  
2026-02-20T22:09:11.4903171Z      # Horodatage
2026-02-20T22:09:11.4903905Z -    created_at = Column(DateTime(timezone=True), server_default=func.now(), index=True)  # Tri chronologique
2026-02-20T22:09:11.4904784Z +    created_at = Column(
2026-02-20T22:09:11.4905314Z +        DateTime(timezone=True), server_default=func.now(), index=True
2026-02-20T22:09:11.4905919Z +    )  # Tri chronologique
2026-02-20T22:09:11.4906263Z  
2026-02-20T22:09:11.4906541Z      def __repr__(self):
2026-02-20T22:09:11.4907146Z          status = "réussie" if self.is_correct else "échouée"
2026-02-20T22:09:11.4908202Z          return f"<Tentative Logique {self.id}: Utilisateur {self.user_id}, Défi {self.challenge_id}\
2026-02-20T22:09:11.4909018Z              , {status}>"
2026-02-20T22:09:11.5347867Z --- /home/runner/work/mathakine/mathakine/app/models/user.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5349036Z +++ /home/runner/work/mathakine/mathakine/app/models/user.py	2026-02-20 22:09:11.532883+00:00
2026-02-20T22:09:11.5349809Z @@ -1,13 +1,24 @@
2026-02-20T22:09:11.5350106Z  """
2026-02-20T22:09:11.5350644Z  Modèle SQLAlchemy pour les utilisateurs
2026-02-20T22:09:11.5351094Z  """
2026-02-20T22:09:11.5351356Z +
2026-02-20T22:09:11.5351633Z  import json
2026-02-20T22:09:11.5351985Z  from datetime import datetime, timezone
2026-02-20T22:09:11.5352463Z  from enum import Enum as PyEnum
2026-02-20T22:09:11.5352846Z  
2026-02-20T22:09:11.5353656Z -from sqlalchemy import Boolean, Column, Date, DateTime, Enum, Index, Integer, String, Text
2026-02-20T22:09:11.5354470Z +from sqlalchemy import (
2026-02-20T22:09:11.5354842Z +    Boolean,
2026-02-20T22:09:11.5355478Z +    Column,
2026-02-20T22:09:11.5355754Z +    Date,
2026-02-20T22:09:11.5356011Z +    DateTime,
2026-02-20T22:09:11.5356273Z +    Enum,
2026-02-20T22:09:11.5356535Z +    Index,
2026-02-20T22:09:11.5356809Z +    Integer,
2026-02-20T22:09:11.5357097Z +    String,
2026-02-20T22:09:11.5357370Z +    Text,
2026-02-20T22:09:11.5357870Z +)
2026-02-20T22:09:11.5358273Z  from sqlalchemy.dialects.postgresql import JSONB
2026-02-20T22:09:11.5358863Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:11.5359340Z  from sqlalchemy.sql import func
2026-02-20T22:09:11.5359821Z  from sqlalchemy.sql.expression import text
2026-02-20T22:09:11.5360352Z  from sqlalchemy.types import TypeDecorator
2026-02-20T22:09:11.5360793Z @@ -15,19 +26,20 @@
2026-02-20T22:09:11.5361125Z  from app.db.base import Base
2026-02-20T22:09:11.5361468Z  
2026-02-20T22:09:11.5361703Z  
2026-02-20T22:09:11.5361979Z  class UserRole(PyEnum):
2026-02-20T22:09:11.5362588Z      """Énumération des rôles d'utilisateur"""
2026-02-20T22:09:11.5363334Z -    PADAWAN = "padawan"     # Apprenti, niveau standard
2026-02-20T22:09:11.5364104Z -    MAITRE = "maitre"       # Enseignant, créateur d'exercices
2026-02-20T22:09:11.5364898Z -    GARDIEN = "gardien"     # Modérateur, gestion des utilisateurs
2026-02-20T22:09:11.5365473Z +
2026-02-20T22:09:11.5365870Z +    PADAWAN = "padawan"  # Apprenti, niveau standard
2026-02-20T22:09:11.5366620Z +    MAITRE = "maitre"  # Enseignant, créateur d'exercices
2026-02-20T22:09:11.5367403Z +    GARDIEN = "gardien"  # Modérateur, gestion des utilisateurs
2026-02-20T22:09:11.5368223Z      ARCHIVISTE = "archiviste"  # Administrateur, accès complet
2026-02-20T22:09:11.5368784Z -
2026-02-20T22:09:11.5369037Z  
2026-02-20T22:09:11.5369283Z  
2026-02-20T22:09:11.5369586Z  class JSONEncodedDict(TypeDecorator):
2026-02-20T22:09:11.5370275Z      """Représente un dictionnaire mappé vers une colonne TEXT"""
2026-02-20T22:09:11.5370830Z +
2026-02-20T22:09:11.5371080Z      impl = Text
2026-02-20T22:09:11.5371371Z  
2026-02-20T22:09:11.5371715Z      def process_bind_param(self, value, dialect):
2026-02-20T22:09:11.5372202Z          if value is not None:
2026-02-20T22:09:11.5372574Z              value = json.dumps(value)
2026-02-20T22:09:11.5403207Z @@ -37,30 +49,34 @@
2026-02-20T22:09:11.5403639Z          if value is not None:
2026-02-20T22:09:11.5404076Z              value = json.loads(value)
2026-02-20T22:09:11.5404493Z          return value
2026-02-20T22:09:11.5404809Z  
2026-02-20T22:09:11.5405055Z  
2026-02-20T22:09:11.5405288Z -
2026-02-20T22:09:11.5405550Z  class User(Base):
2026-02-20T22:09:11.5406176Z      """Modèle de données pour les utilisateurs de Mathakine"""
2026-02-20T22:09:11.5406716Z +
2026-02-20T22:09:11.5406990Z      __tablename__ = "users"
2026-02-20T22:09:11.5407359Z      __table_args__ = (
2026-02-20T22:09:11.5407758Z -        Index('idx_users_avatar_url', 'avatar_url'),
2026-02-20T22:09:11.5408295Z -        Index('idx_users_jedi_rank', 'jedi_rank'),
2026-02-20T22:09:11.5408843Z -        Index('idx_users_total_points', 'total_points'),
2026-02-20T22:09:11.5409416Z +        Index("idx_users_avatar_url", "avatar_url"),
2026-02-20T22:09:11.5409948Z +        Index("idx_users_jedi_rank", "jedi_rank"),
2026-02-20T22:09:11.5410474Z +        Index("idx_users_total_points", "total_points"),
2026-02-20T22:09:11.5410964Z      )
2026-02-20T22:09:11.5411226Z  
2026-02-20T22:09:11.5411574Z      id = Column(Integer, primary_key=True, index=True)
2026-02-20T22:09:11.5412258Z      username = Column(String(50), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.5413209Z      email = Column(String(100), unique=True, nullable=False, index=True)
2026-02-20T22:09:11.5413933Z      hashed_password = Column(String(255), nullable=False)
2026-02-20T22:09:11.5414494Z      full_name = Column(String(100))
2026-02-20T22:09:11.5415334Z -    role = Column(Enum(UserRole, name="userrole", create_type=False), default=UserRole.PADAWAN)
2026-02-20T22:09:11.5416132Z +    role = Column(
2026-02-20T22:09:11.5416712Z +        Enum(UserRole, name="userrole", create_type=False), default=UserRole.PADAWAN
2026-02-20T22:09:11.5417672Z +    )
2026-02-20T22:09:11.5418026Z      is_active = Column(Boolean, default=True)
2026-02-20T22:09:11.5418699Z      created_at = Column(DateTime(timezone=True), server_default=func.now())
2026-02-20T22:09:11.5419871Z -    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
2026-02-20T22:09:11.5420651Z -    
2026-02-20T22:09:11.5420935Z +    updated_at = Column(
2026-02-20T22:09:11.5421510Z +        DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
2026-02-20T22:09:11.5422137Z +    )
2026-02-20T22:09:11.5422396Z +
2026-02-20T22:09:11.5422776Z      # Vérification email
2026-02-20T22:09:11.5423507Z      is_email_verified = Column(Boolean, default=False, nullable=False)
2026-02-20T22:09:11.5424338Z      email_verification_token = Column(String(255), nullable=True, index=True)
2026-02-20T22:09:11.5425227Z      email_verification_sent_at = Column(DateTime(timezone=True), nullable=True)
2026-02-20T22:09:11.5425879Z  
2026-02-20T22:09:11.5426131Z @@ -79,33 +95,51 @@
2026-02-20T22:09:11.5426431Z  
2026-02-20T22:09:11.5426871Z      # Colonnes de gamification (système de badges)
2026-02-20T22:09:11.5427754Z      pinned_badge_ids = Column(JSONB, nullable=True)  # A-4: max 3 badge IDs épinglés
2026-02-20T22:09:11.5428799Z      current_streak = Column(Integer, default=0)  # Jours consécutifs avec activité
2026-02-20T22:09:11.5429700Z      best_streak = Column(Integer, default=0)  # Record de série
2026-02-20T22:09:11.5430583Z -    last_activity_date = Column(Date, nullable=True)  # Dernier jour calendaire avec activité
2026-02-20T22:09:11.5431296Z +    last_activity_date = Column(
2026-02-20T22:09:11.5431686Z +        Date, nullable=True
2026-02-20T22:09:11.5432150Z +    )  # Dernier jour calendaire avec activité
2026-02-20T22:09:11.5432664Z      total_points = Column(Integer, default=0)
2026-02-20T22:09:11.5463514Z      current_level = Column(Integer, default=1)
2026-02-20T22:09:11.5464131Z      experience_points = Column(Integer, default=0)
2026-02-20T22:09:11.5464740Z -    jedi_rank = Column(String(50), default='youngling')
2026-02-20T22:09:11.5465344Z +    jedi_rank = Column(String(50), default="youngling")
2026-02-20T22:09:11.5465917Z      avatar_url = Column(String(255), nullable=True)
2026-02-20T22:09:11.5466390Z  
2026-02-20T22:09:11.5466651Z      # Relations
2026-02-20T22:09:11.5467367Z -    created_exercises = relationship("Exercise", back_populates="creator", cascade="all, delete-orphan")
2026-02-20T22:09:11.5468528Z -    attempts = relationship("Attempt", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5469640Z -    progress_records = relationship("Progress", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5470854Z -    recommendations = relationship("Recommendation", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5471815Z +    created_exercises = relationship(
2026-02-20T22:09:11.5472414Z +        "Exercise", back_populates="creator", cascade="all, delete-orphan"
2026-02-20T22:09:11.5473270Z +    )
2026-02-20T22:09:11.5473572Z +    attempts = relationship(
2026-02-20T22:09:11.5474111Z +        "Attempt", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5474673Z +    )
2026-02-20T22:09:11.5474992Z +    progress_records = relationship(
2026-02-20T22:09:11.5475572Z +        "Progress", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5476138Z +    )
2026-02-20T22:09:11.5476438Z +    recommendations = relationship(
2026-02-20T22:09:11.5477048Z +        "Recommendation", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5477666Z +    )
2026-02-20T22:09:11.5477912Z  
2026-02-20T22:09:11.5478342Z      # Relations avec les défis logiques
2026-02-20T22:09:11.5479280Z -    created_logic_challenges = relationship("LogicChallenge", back_populates="creator", cascade="all, delete-orphan")
2026-02-20T22:09:11.5480754Z -    logic_challenge_attempts = relationship("LogicChallengeAttempt", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5482177Z +    created_logic_challenges = relationship(
2026-02-20T22:09:11.5482880Z +        "LogicChallenge", back_populates="creator", cascade="all, delete-orphan"
2026-02-20T22:09:11.5483704Z +    )
2026-02-20T22:09:11.5484238Z +    logic_challenge_attempts = relationship(
2026-02-20T22:09:11.5484968Z +        "LogicChallengeAttempt", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5485642Z +    )
2026-02-20T22:09:11.5485900Z  
2026-02-20T22:09:11.5486312Z      # Relations avec le système de badges
2026-02-20T22:09:11.5487191Z -    user_achievements = relationship("UserAchievement", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5488101Z +    user_achievements = relationship(
2026-02-20T22:09:11.5488728Z +        "UserAchievement", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5489354Z +    )
2026-02-20T22:09:11.5489610Z  
2026-02-20T22:09:11.5489948Z      # Relations avec les sessions et notifications
2026-02-20T22:09:11.5490794Z -    user_sessions = relationship("UserSession", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5492002Z -    notifications = relationship("Notification", back_populates="user", cascade="all, delete-orphan")
2026-02-20T22:09:11.5492805Z -
2026-02-20T22:09:11.5523345Z -
2026-02-20T22:09:11.5523706Z +    user_sessions = relationship(
2026-02-20T22:09:11.5524314Z +        "UserSession", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5524916Z +    )
2026-02-20T22:09:11.5525218Z +    notifications = relationship(
2026-02-20T22:09:11.5525816Z +        "Notification", back_populates="user", cascade="all, delete-orphan"
2026-02-20T22:09:11.5526427Z +    )
2026-02-20T22:09:11.5526690Z  
2026-02-20T22:09:11.5526964Z      def __repr__(self):
2026-02-20T22:09:11.5527404Z          return f"<User {self.username}, Role: {self.role}>"
2026-02-20T22:09:11.5528147Z would reformat /home/runner/work/mathakine/mathakine/app/models/user.py
2026-02-20T22:09:11.5858408Z --- /home/runner/work/mathakine/mathakine/app/schemas/common.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5859605Z +++ /home/runner/work/mathakine/mathakine/app/schemas/common.py	2026-02-20 22:09:11.583442+00:00
2026-02-20T22:09:11.5860379Z @@ -3,104 +3,114 @@
2026-02-20T22:09:11.5860891Z  from typing import Any, Dict, Generic, List, Optional, TypeVar, Union
2026-02-20T22:09:11.5861446Z  
2026-02-20T22:09:11.5861743Z  from pydantic import BaseModel, Field
2026-02-20T22:09:11.5862118Z  
2026-02-20T22:09:11.5862644Z  # Type générique pour les réponses
2026-02-20T22:09:11.5863266Z -T = TypeVar('T')
2026-02-20T22:09:11.5863563Z -
2026-02-20T22:09:11.5863801Z +T = TypeVar("T")
2026-02-20T22:09:11.5864080Z  
2026-02-20T22:09:11.5864296Z  
2026-02-20T22:09:11.5864566Z  class StatusCode(str, Enum):
2026-02-20T22:09:11.5865278Z      """Codes d'état standardisés pour l'API (Codes de Transmission)"""
2026-02-20T22:09:11.5865886Z +
2026-02-20T22:09:11.5866262Z      SUCCESS = "success"  # Succès
2026-02-20T22:09:11.5866643Z -    ERROR = "error"      # Erreur
2026-02-20T22:09:11.5867048Z +    ERROR = "error"  # Erreur
2026-02-20T22:09:11.5867453Z      WARNING = "warning"  # Avertissement
2026-02-20T22:09:11.5867942Z -    INFO = "info"        # Information
2026-02-20T22:09:11.5868347Z -
2026-02-20T22:09:11.5868644Z +    INFO = "info"  # Information
2026-02-20T22:09:11.5869028Z  
2026-02-20T22:09:11.5869284Z  
2026-02-20T22:09:11.5869583Z  class ErrorCode(str, Enum):
2026-02-20T22:09:11.5870262Z      """Codes d'erreur standardisés (Codes de Défaillance)"""
2026-02-20T22:09:11.5871104Z -    NOT_FOUND = "not_found"                 # Ressource non trouvée
2026-02-20T22:09:11.5872061Z -    ALREADY_EXISTS = "already_exists"       # Conflit, ressource déjà existante
2026-02-20T22:09:11.5873339Z -    VALIDATION_ERROR = "validation_error"   # Erreur de validation des données
2026-02-20T22:09:11.5874221Z -    AUTHENTICATION_ERROR = "auth_error"     # Erreur d'authentification
2026-02-20T22:09:11.5875479Z -    PERMISSION_ERROR = "permission_error"   # Erreur de permission
2026-02-20T22:09:11.5876243Z -    SERVER_ERROR = "server_error"           # Erreur serveur interne
2026-02-20T22:09:11.5877428Z -    DATABASE_ERROR = "database_error"       # Erreur de base de données
2026-02-20T22:09:11.5878243Z -    EXTERNAL_API_ERROR = "external_error"   # Erreur d'API externe
2026-02-20T22:09:11.5879161Z -    RATE_LIMIT_ERROR = "rate_limit"         # Limite de taux dépassée
2026-02-20T22:09:11.5879573Z -    INVALID_OPERATION = "invalid_operation" # Opération invalide
2026-02-20T22:09:11.5879688Z  
2026-02-20T22:09:11.5880000Z +    NOT_FOUND = "not_found"  # Ressource non trouvée
2026-02-20T22:09:11.5880467Z +    ALREADY_EXISTS = "already_exists"  # Conflit, ressource déjà existante
2026-02-20T22:09:11.5880944Z +    VALIDATION_ERROR = "validation_error"  # Erreur de validation des données
2026-02-20T22:09:11.5881248Z +    AUTHENTICATION_ERROR = "auth_error"  # Erreur d'authentification
2026-02-20T22:09:11.5881561Z +    PERMISSION_ERROR = "permission_error"  # Erreur de permission
2026-02-20T22:09:11.5881813Z +    SERVER_ERROR = "server_error"  # Erreur serveur interne
2026-02-20T22:09:11.5882245Z +    DATABASE_ERROR = "database_error"  # Erreur de base de données
2026-02-20T22:09:11.5882524Z +    EXTERNAL_API_ERROR = "external_error"  # Erreur d'API externe
2026-02-20T22:09:11.5882920Z +    RATE_LIMIT_ERROR = "rate_limit"  # Limite de taux dépassée
2026-02-20T22:09:11.5891821Z +    INVALID_OPERATION = "invalid_operation"  # Opération invalide
2026-02-20T22:09:11.5891952Z  
2026-02-20T22:09:11.5892071Z  
2026-02-20T22:09:11.5892228Z  class PageInfo(BaseModel):
2026-02-20T22:09:11.5892633Z      """Information de pagination (Coordonnées de Navigation)"""
2026-02-20T22:09:11.5892750Z +
2026-02-20T22:09:11.5893388Z      page: int = Field(..., ge=1, description="Page actuelle")
2026-02-20T22:09:11.5893934Z      page_size: int = Field(..., ge=1, description="Nombre d'éléments par page")
2026-02-20T22:09:11.5894300Z      total_pages: int = Field(..., ge=0, description="Nombre total de pages")
2026-02-20T22:09:11.5894787Z      total_items: int = Field(..., ge=0, description="Nombre total d'éléments")
2026-02-20T22:09:11.5895121Z      has_next: bool = Field(..., description="S'il existe une page suivante")
2026-02-20T22:09:11.5895572Z      has_prev: bool = Field(..., description="S'il existe une page précédente")
2026-02-20T22:09:11.5895694Z  
2026-02-20T22:09:11.5895799Z  
2026-02-20T22:09:11.5895905Z -
2026-02-20T22:09:11.5896065Z  class ResponseMeta(BaseModel):
2026-02-20T22:09:11.5896439Z      """Métadonnées de réponse (Données de Transmission)"""
2026-02-20T22:09:11.5896549Z +
2026-02-20T22:09:11.5896679Z      code: StatusCode
2026-02-20T22:09:11.5897244Z -    message: str = Field(..., description="Message décrivant le résultat de l'opération")
2026-02-20T22:09:11.5897692Z -    error_code: Optional[ErrorCode] = Field(None, description="Code d'erreur si applicable")
2026-02-20T22:09:11.5898230Z -    pagination: Optional[PageInfo] = Field(None, description="Information de pagination si applicable")
2026-02-20T22:09:11.5899033Z -    debug_info: Optional[Dict[str, Any]] = Field(None, description="Informations de débogage (en mode debug uniquement)")
2026-02-20T22:09:11.5899165Z -
2026-02-20T22:09:11.5899308Z +    message: str = Field(
2026-02-20T22:09:11.5899726Z +        ..., description="Message décrivant le résultat de l'opération"
2026-02-20T22:09:11.5899847Z +    )
2026-02-20T22:09:11.5900023Z +    error_code: Optional[ErrorCode] = Field(
2026-02-20T22:09:11.5900238Z +        None, description="Code d'erreur si applicable"
2026-02-20T22:09:11.5900359Z +    )
2026-02-20T22:09:11.5900540Z +    pagination: Optional[PageInfo] = Field(
2026-02-20T22:09:11.5900823Z +        None, description="Information de pagination si applicable"
2026-02-20T22:09:11.5900944Z +    )
2026-02-20T22:09:11.5901138Z +    debug_info: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.5901968Z +        None, description="Informations de débogage (en mode debug uniquement)"
2026-02-20T22:09:11.5902083Z +    )
2026-02-20T22:09:11.5902207Z  
2026-02-20T22:09:11.5902322Z  
2026-02-20T22:09:11.5902499Z  class Response(BaseModel, Generic[T]):
2026-02-20T22:09:11.5903345Z      """Réponse API standard (Transmission Galactique)"""
2026-02-20T22:09:11.5903499Z +
2026-02-20T22:09:11.5903648Z      meta: ResponseMeta
2026-02-20T22:09:11.5905662Z      data: Optional[T] = Field(None, description="Données de la réponse")
2026-02-20T22:09:11.5905905Z  
2026-02-20T22:09:11.5906019Z  
2026-02-20T22:09:11.5907259Z -
2026-02-20T22:09:11.5933363Z  class ListResponse(Response[List[T]], Generic[T]):
2026-02-20T22:09:11.5933879Z      """Réponse API pour listes paginées (Liste de Transmission)"""
2026-02-20T22:09:11.5934002Z +
2026-02-20T22:09:11.5934398Z      data: List[T] = Field(..., description="Liste des éléments")
2026-02-20T22:09:11.5934523Z -
2026-02-20T22:09:11.5934636Z  
2026-02-20T22:09:11.5934769Z  
2026-02-20T22:09:11.5934936Z  class ValidationError(BaseModel):
2026-02-20T22:09:11.5935328Z      """Détails d'une erreur de validation (Rapport d'Anomalie)"""
2026-02-20T22:09:11.5935436Z +
2026-02-20T22:09:11.5935878Z      field: str = Field(..., description="Champ concerné par l'erreur")
2026-02-20T22:09:11.5936168Z      message: str = Field(..., description="Message d'erreur")
2026-02-20T22:09:11.5936648Z      code: Optional[str] = Field(None, description="Code d'erreur spécifique")
2026-02-20T22:09:11.5936763Z  
2026-02-20T22:09:11.5936875Z  
2026-02-20T22:09:11.5936980Z -
2026-02-20T22:09:11.5937144Z  class ErrorResponse(BaseModel):
2026-02-20T22:09:11.5937539Z      """Réponse d'erreur détaillée (Rapport de Défaillance)"""
2026-02-20T22:09:11.5937650Z +
2026-02-20T22:09:11.5937791Z      meta: ResponseMeta
2026-02-20T22:09:11.5938556Z -    errors: Optional[List[ValidationError]] = Field(None, description="Liste détaillée des erreurs de validation")
2026-02-20T22:09:11.5938676Z -
2026-02-20T22:09:11.5938913Z +    errors: Optional[List[ValidationError]] = Field(
2026-02-20T22:09:11.5939336Z +        None, description="Liste détaillée des erreurs de validation"
2026-02-20T22:09:11.5939459Z +    )
2026-02-20T22:09:11.5939568Z  
2026-02-20T22:09:11.5939676Z  
2026-02-20T22:09:11.5939829Z  class HealthCheck(BaseModel):
2026-02-20T22:09:11.5940169Z      """État de santé de l'API (État des Systèmes)"""
2026-02-20T22:09:11.5940279Z +
2026-02-20T22:09:11.5940662Z      status: str = Field(..., description="État général du service")
2026-02-20T22:09:11.5940925Z      version: str = Field(..., description="Version de l'API")
2026-02-20T22:09:11.5941280Z      uptime: float = Field(..., description="Temps de fonctionnement en secondes")
2026-02-20T22:09:11.5941770Z      database_status: str = Field(..., description="État de la base de données")
2026-02-20T22:09:11.5942225Z      environment: str = Field(..., description="Environnement d'exécution")
2026-02-20T22:09:11.5942790Z -    dependencies: Dict[str, str] = Field(..., description="État des dépendances externes")
2026-02-20T22:09:11.5942926Z -
2026-02-20T22:09:11.5943322Z +    dependencies: Dict[str, str] = Field(
2026-02-20T22:09:11.5943661Z +        ..., description="État des dépendances externes"
2026-02-20T22:09:11.5943769Z +    )
2026-02-20T22:09:11.5943869Z  
2026-02-20T22:09:11.5943988Z  
2026-02-20T22:09:11.5944134Z  class PaginationParams:
2026-02-20T22:09:11.5944244Z      """
2026-02-20T22:09:11.5944633Z      Paramètres de pagination standards pour les requêtes API.
2026-02-20T22:09:11.5945056Z      Peut être utilisé comme dépendance FastAPI pour les endpoints.
2026-02-20T22:09:11.5945171Z      """
2026-02-20T22:09:11.5945284Z -
2026-02-20T22:09:11.5945399Z  
2026-02-20T22:09:11.5945523Z      def __init__(
2026-02-20T22:09:11.5945637Z          self,
2026-02-20T22:09:11.5945763Z          skip: int = 0,
2026-02-20T22:09:11.5945897Z          limit: int = 100,
2026-02-20T22:09:11.5946297Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/common.py
2026-02-20T22:09:11.5983427Z --- /home/runner/work/mathakine/mathakine/app/schemas/attempt.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.5983923Z +++ /home/runner/work/mathakine/mathakine/app/schemas/attempt.py	2026-02-20 22:09:11.596180+00:00
2026-02-20T22:09:11.5984052Z @@ -4,112 +4,114 @@
2026-02-20T22:09:11.5984630Z  from pydantic import BaseModel, ConfigDict, Field, field_validator
2026-02-20T22:09:11.5984761Z  
2026-02-20T22:09:11.5985169Z  # Schémas pour la manipulation des tentatives d'exercices
2026-02-20T22:09:11.5985281Z  
2026-02-20T22:09:11.5985394Z  
2026-02-20T22:09:11.5985491Z -
2026-02-20T22:09:11.5985640Z  class AttemptBase(BaseModel):
2026-02-20T22:09:11.5986090Z      """Schéma de base pour les tentatives (Tentatives d'Accomplissement)"""
2026-02-20T22:09:11.5986203Z +
2026-02-20T22:09:11.5986605Z      exercise_id: int = Field(..., description="ID de l'exercice tenté")
2026-02-20T22:09:11.5987064Z      user_answer: str = Field(..., description="Réponse fournie par l'utilisateur")
2026-02-20T22:09:11.5987295Z -    time_spent: Optional[float] = Field(None, ge=0.0,
2026-02-20T22:09:11.5987638Z -                                     description="Temps passé en secondes")
2026-02-20T22:09:11.5987820Z -    hints_used: Optional[int] = Field(0, ge=0,
2026-02-20T22:09:11.5988188Z -                                   description="Nombre d'indices utilisés")
2026-02-20T22:09:11.5988349Z -    device_info: Optional[str] = Field(None,
2026-02-20T22:09:11.5988718Z -                                    description="Information sur l'appareil utilisé")
2026-02-20T22:09:11.5988869Z +    time_spent: Optional[float] = Field(
2026-02-20T22:09:11.5989209Z +        None, ge=0.0, description="Temps passé en secondes"
2026-02-20T22:09:11.5989321Z +    )
2026-02-20T22:09:11.5989844Z +    hints_used: Optional[int] = Field(0, ge=0, description="Nombre d'indices utilisés")
2026-02-20T22:09:11.5990013Z +    device_info: Optional[str] = Field(
2026-02-20T22:09:11.5990354Z +        None, description="Information sur l'appareil utilisé"
2026-02-20T22:09:11.5990479Z +    )
2026-02-20T22:09:11.5990597Z  
2026-02-20T22:09:11.5990752Z -    @field_validator('user_answer')
2026-02-20T22:09:11.5990896Z +    @field_validator("user_answer")
2026-02-20T22:09:11.5991016Z      @classmethod
2026-02-20T22:09:11.5991125Z -
2026-02-20T22:09:11.5991232Z -
2026-02-20T22:09:11.5991395Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.5991544Z          if not v or v.isspace():
2026-02-20T22:09:11.5991935Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.5992054Z          return v
2026-02-20T22:09:11.5992168Z  
2026-02-20T22:09:11.5992271Z  
2026-02-20T22:09:11.5992376Z -
2026-02-20T22:09:11.5992530Z  class AttemptCreate(AttemptBase):
2026-02-20T22:09:11.5993222Z      """Schéma pour la création d'une tentative (Enregistrement d'une Tentative)"""
2026-02-20T22:09:11.5993331Z +
2026-02-20T22:09:11.5993444Z      pass
2026-02-20T22:09:11.5993552Z -
2026-02-20T22:09:11.5993648Z  
2026-02-20T22:09:11.5993746Z  
2026-02-20T22:09:11.5994184Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/attempt.py
2026-02-20T22:09:11.5994349Z  class AttemptUpdate(BaseModel):
2026-02-20T22:09:11.5994718Z      """Schéma pour la mise à jour d'une tentative (rare)"""
2026-02-20T22:09:11.5994837Z +
2026-02-20T22:09:11.5995016Z      is_correct: Optional[bool] = None
2026-02-20T22:09:11.5995231Z      time_spent: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.5995428Z      hints_used: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.5995543Z  
2026-02-20T22:09:11.5995693Z -    @field_validator('time_spent')
2026-02-20T22:09:11.5995835Z +    @field_validator("time_spent")
2026-02-20T22:09:11.5995958Z      @classmethod
2026-02-20T22:09:11.5996064Z -
2026-02-20T22:09:11.5996168Z -
2026-02-20T22:09:11.5996326Z      def time_spent_positive(cls, v):
2026-02-20T22:09:11.5996474Z          if v is not None and v < 0:
2026-02-20T22:09:11.5996897Z              raise ValueError("Le temps passé ne peut pas être négatif")
2026-02-20T22:09:11.5997263Z          return v
2026-02-20T22:09:11.5997373Z  
2026-02-20T22:09:11.5997469Z  
2026-02-20T22:09:11.5997565Z -
2026-02-20T22:09:11.5997722Z  class AttemptInDB(AttemptBase):
2026-02-20T22:09:11.5998229Z      """Schéma pour une tentative en base de données (Archives des Tentatives)"""
2026-02-20T22:09:11.5998551Z +
2026-02-20T22:09:11.5998687Z      id: int
2026-02-20T22:09:11.5998816Z      user_id: int
2026-02-20T22:09:11.5998948Z      is_correct: bool
2026-02-20T22:09:11.5999086Z      attempt_number: int
2026-02-20T22:09:11.5999223Z      created_at: datetime
2026-02-20T22:09:11.5999337Z  
2026-02-20T22:09:11.5999548Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.5999656Z  
2026-02-20T22:09:11.5999771Z  
2026-02-20T22:09:11.5999875Z -
2026-02-20T22:09:11.6000023Z  class Attempt(AttemptInDB):
2026-02-20T22:09:11.6000414Z      """Schéma pour une tentative complète (Journal de Bord)"""
2026-02-20T22:09:11.6000527Z +
2026-02-20T22:09:11.6000689Z      exercise_title: Optional[str] = None
2026-02-20T22:09:11.6000861Z      exercise_type: Optional[str] = None
2026-02-20T22:09:11.6001052Z      exercise_difficulty: Optional[str] = None
2026-02-20T22:09:11.6001159Z  
2026-02-20T22:09:11.6001366Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6001479Z  
2026-02-20T22:09:11.6001592Z  
2026-02-20T22:09:11.6001696Z -
2026-02-20T22:09:11.6001847Z  class AttemptBatch(BaseModel):
2026-02-20T22:09:11.6002289Z      """Schéma pour l'envoi de plusieurs tentatives (Rapport de Mission)"""
2026-02-20T22:09:11.6002473Z -    attempts: list[AttemptCreate] = Field(...,
2026-02-20T22:09:11.6002890Z -                                       description="Liste des tentatives à enregistrer")
2026-02-20T22:09:11.6003200Z  
2026-02-20T22:09:11.6003356Z -    @field_validator('attempts')
2026-02-20T22:09:11.6003520Z +    attempts: list[AttemptCreate] = Field(
2026-02-20T22:09:11.6003866Z +        ..., description="Liste des tentatives à enregistrer"
2026-02-20T22:09:11.6003991Z +    )
2026-02-20T22:09:11.6004096Z +
2026-02-20T22:09:11.6004237Z +    @field_validator("attempts")
2026-02-20T22:09:11.6004358Z      @classmethod
2026-02-20T22:09:11.6004456Z -
2026-02-20T22:09:11.6004558Z -
2026-02-20T22:09:11.6004698Z      def validate_batch(cls, v):
2026-02-20T22:09:11.6004828Z          if not v:
2026-02-20T22:09:11.6005242Z              raise ValueError("Le lot de tentatives ne peut pas être vide")
2026-02-20T22:09:11.6005365Z          if len(v) > 50:
2026-02-20T22:09:11.6005590Z              raise ValueError("Maximum 50 tentatives par lot")
2026-02-20T22:09:11.6005702Z          return v
2026-02-20T22:09:11.6005805Z  
2026-02-20T22:09:11.6005908Z  
2026-02-20T22:09:11.6006014Z -
2026-02-20T22:09:11.6006161Z  class AttemptStats(BaseModel):
2026-02-20T22:09:11.6006590Z      """Statistiques sur les tentatives d'un utilisateur (Analyse de Performance)"""
2026-02-20T22:09:11.6006702Z +
2026-02-20T22:09:11.6006835Z      total_attempts: int
2026-02-20T22:09:11.6006969Z      correct_attempts: int
2026-02-20T22:09:11.6007107Z      success_rate: float
2026-02-20T22:09:11.6007273Z      average_time: Optional[float] = None
2026-02-20T22:09:11.6007428Z      fastest_time: Optional[float] = None
2026-02-20T22:09:11.6007577Z      slowest_time: Optional[float] = None
2026-02-20T22:09:11.6007739Z      streak: Optional[int] = None
2026-02-20T22:09:11.6007843Z  
2026-02-20T22:09:11.6008045Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6008154Z  
2026-02-20T22:09:11.6008252Z +
2026-02-20T22:09:11.6008405Z  class AttemptResponse(BaseModel):
2026-02-20T22:09:11.6008766Z      """Schéma pour la réponse à une tentative d'exercice"""
2026-02-20T22:09:11.6008877Z +
2026-02-20T22:09:11.6009296Z      is_correct: bool = Field(..., description="Si la réponse est correcte")
2026-02-20T22:09:11.6009897Z -    correct_answer: Optional[str] = Field(None, description="La réponse correcte (si incorrecte)")
2026-02-20T22:09:11.6010068Z +    correct_answer: Optional[str] = Field(
2026-02-20T22:09:11.6010666Z +        None, description="La réponse correcte (si incorrecte)"
2026-02-20T22:09:11.6010772Z +    )
2026-02-20T22:09:11.6011055Z      feedback: str = Field(..., description="Retour sur la tentative")
2026-02-20T22:09:11.6011754Z      time_spent: Optional[float] = Field(None, description="Temps passé en secondes")
2026-02-20T22:09:11.6012406Z -    mastery_progress: Optional[int] = Field(None, description="Progression dans la maîtrise du sujet")
2026-02-20T22:09:11.6012511Z -    
2026-02-20T22:09:11.6012693Z +    mastery_progress: Optional[int] = Field(
2026-02-20T22:09:11.6013257Z +        None, description="Progression dans la maîtrise du sujet"
2026-02-20T22:09:11.6013373Z +    )
2026-02-20T22:09:11.6013486Z +
2026-02-20T22:09:11.6013695Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6589744Z --- /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.6590632Z +++ /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py	2026-02-20 22:09:11.657896+00:00
2026-02-20T22:09:11.6591040Z @@ -4,42 +4,55 @@
2026-02-20T22:09:11.6591289Z  from pydantic import BaseModel, ConfigDict, Field
2026-02-20T22:09:11.6591407Z  
2026-02-20T22:09:11.6591526Z  
2026-02-20T22:09:11.6591704Z  class RecommendationBase(BaseModel):
2026-02-20T22:09:11.6592259Z      """Schéma de base pour les recommandations d'exercices"""
2026-02-20T22:09:11.6592377Z +
2026-02-20T22:09:11.6592869Z      exercise_type: str = Field(..., description="Type d'exercice recommandé")
2026-02-20T22:09:11.6593607Z      difficulty: str = Field(..., description="Niveau de difficulté recommandé")
2026-02-20T22:09:11.6594229Z -    priority: int = Field(5, ge=1, le=10, description="Priorité de la recommandation (1-10)")
2026-02-20T22:09:11.6594446Z +    priority: int = Field(
2026-02-20T22:09:11.6594927Z +        5, ge=1, le=10, description="Priorité de la recommandation (1-10)"
2026-02-20T22:09:11.6595042Z +    )
2026-02-20T22:09:11.6595429Z      reason: Optional[str] = Field(None, description="Raison de la recommandation")
2026-02-20T22:09:11.6595567Z +
2026-02-20T22:09:11.6595675Z  
2026-02-20T22:09:11.6595903Z  class RecommendationCreate(RecommendationBase):
2026-02-20T22:09:11.6596227Z      """Schéma pour la création de recommandations"""
2026-02-20T22:09:11.6596340Z +
2026-02-20T22:09:11.6596586Z      user_id: int = Field(..., description="ID de l'utilisateur")
2026-02-20T22:09:11.6597163Z -    exercise_id: Optional[int] = Field(None, description="ID de l'exercice recommandé (optionnel)")
2026-02-20T22:09:11.6597281Z -    
2026-02-20T22:09:11.6597444Z +    exercise_id: Optional[int] = Field(
2026-02-20T22:09:11.6597859Z +        None, description="ID de l'exercice recommandé (optionnel)"
2026-02-20T22:09:11.6597974Z +    )
2026-02-20T22:09:11.6598083Z +
2026-02-20T22:09:11.6598198Z +
2026-02-20T22:09:11.6598373Z  class RecommendationUpdate(BaseModel):
2026-02-20T22:09:11.6598712Z      """Schéma pour la mise à jour de recommandations"""
2026-02-20T22:09:11.6598839Z +
2026-02-20T22:09:11.6599383Z      is_completed: Optional[bool] = Field(None, description="Marqué comme complété")
2026-02-20T22:09:11.6599746Z      shown_count: Optional[int] = Field(None, description="Nombre d'affichages")
2026-02-20T22:09:11.6600102Z      clicked_count: Optional[int] = Field(None, description="Nombre de clics")
2026-02-20T22:09:11.6600219Z  
2026-02-20T22:09:11.6600317Z +
2026-02-20T22:09:11.6600511Z  class RecommendationInDB(RecommendationBase):
2026-02-20T22:09:11.6600931Z      """Schéma pour les recommandations stockées en base de données"""
2026-02-20T22:09:11.6601050Z +
2026-02-20T22:09:11.6601264Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6601380Z -    
2026-02-20T22:09:11.6601498Z +
2026-02-20T22:09:11.6601612Z      id: int
2026-02-20T22:09:11.6602074Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/recommendation.py
2026-02-20T22:09:11.6602204Z      user_id: int
2026-02-20T22:09:11.6602368Z      exercise_id: Optional[int] = None
2026-02-20T22:09:11.6602920Z      is_completed: bool
2026-02-20T22:09:11.6603253Z      shown_count: int
2026-02-20T22:09:11.6603394Z      clicked_count: int
2026-02-20T22:09:11.6603528Z      created_at: datetime
2026-02-20T22:09:11.6603658Z      updated_at: datetime
2026-02-20T22:09:11.6603773Z  
2026-02-20T22:09:11.6604118Z +
2026-02-20T22:09:11.6604375Z  class RecommendationResponse(RecommendationBase):
2026-02-20T22:09:11.6604770Z      """Schéma pour la réponse API de recommandations"""
2026-02-20T22:09:11.6604896Z +
2026-02-20T22:09:11.6605114Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.6605225Z -    
2026-02-20T22:09:11.6605341Z +
2026-02-20T22:09:11.6605455Z      id: int
2026-02-20T22:09:11.6605615Z      exercise_id: Optional[int] = None
2026-02-20T22:09:11.6605777Z      exercise_title: Optional[str] = None
2026-02-20T22:09:11.6605968Z -    exercise_question: Optional[str] = None 
2026-02-20T22:09:11.6606117Z \ No newline at end of file
2026-02-20T22:09:11.6606294Z +    exercise_question: Optional[str] = None
2026-02-20T22:09:11.7708743Z --- /home/runner/work/mathakine/mathakine/app/schemas/exercise.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.7716941Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/exercise.py
2026-02-20T22:09:11.7734097Z +++ /home/runner/work/mathakine/mathakine/app/schemas/exercise.py	2026-02-20 22:09:11.768236+00:00
2026-02-20T22:09:11.7735247Z @@ -5,114 +5,134 @@
2026-02-20T22:09:11.7735820Z  
2026-02-20T22:09:11.7736302Z  from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:11.7736860Z  
2026-02-20T22:09:11.7737486Z  # Schémas pour la manipulation des exercices
2026-02-20T22:09:11.7737930Z  
2026-02-20T22:09:11.7738175Z +
2026-02-20T22:09:11.7738447Z  class ExerciseBase(BaseModel):
2026-02-20T22:09:11.7739065Z      """Schéma de base pour les exercices (Épreuves Jedi)"""
2026-02-20T22:09:11.7739681Z -    title: str = Field(..., min_length=3, max_length=100,
2026-02-20T22:09:11.7740438Z -                    description="Titre de l'exercice (3-100 caractères)")
2026-02-20T22:09:11.7741119Z -    exercise_type: Union[str, ExerciseType] = Field(...,
2026-02-20T22:09:11.7741860Z -                                     description="Type d'exercice mathématique")
2026-02-20T22:09:11.7742517Z -    difficulty: Union[str, DifficultyLevel] = Field(...,
2026-02-20T22:09:11.7743453Z -                                     description="Niveau de difficulté")
2026-02-20T22:09:11.7744012Z -    question: str = Field(..., min_length=5,
2026-02-20T22:09:11.7744762Z -                       description="Question de l'exercice (min 5 caractères)")
2026-02-20T22:09:11.7745361Z -    correct_answer: str = Field(...,
2026-02-20T22:09:11.7745996Z -                             description="Réponse correcte à la question")
2026-02-20T22:09:11.7746575Z -    choices: Optional[List[str]] = Field(None,
2026-02-20T22:09:11.7747379Z -                                     description="Options pour les questions à choix multiples")
2026-02-20T22:09:11.7748070Z -    explanation: Optional[str] = Field(None,
2026-02-20T22:09:11.7748692Z -                                    description="Explication de la solution")
2026-02-20T22:09:11.7749238Z -    hint: Optional[str] = Field(None,
2026-02-20T22:09:11.7749867Z -                             description="Indice pour aider l'élève")
2026-02-20T22:09:11.7750395Z -    tags: Optional[str] = Field(None,
2026-02-20T22:09:11.7751015Z -                             description="Tags séparés par des virgules")
2026-02-20T22:09:11.7751522Z -
2026-02-20T22:09:11.7751811Z -    @field_validator('exercise_type')
2026-02-20T22:09:11.7752209Z +
2026-02-20T22:09:11.7752462Z +    title: str = Field(
2026-02-20T22:09:11.7752793Z +        ...,
2026-02-20T22:09:11.7753219Z +        min_length=3,
2026-02-20T22:09:11.7753549Z +        max_length=100,
2026-02-20T22:09:11.7754116Z +        description="Titre de l'exercice (3-100 caractères)",
2026-02-20T22:09:11.7754617Z +    )
2026-02-20T22:09:11.7754969Z +    exercise_type: Union[str, ExerciseType] = Field(
2026-02-20T22:09:11.7756054Z +        ..., description="Type d'exercice mathématique"
2026-02-20T22:09:11.7756521Z +    )
2026-02-20T22:09:11.7756870Z +    difficulty: Union[str, DifficultyLevel] = Field(
2026-02-20T22:09:11.7757488Z +        ..., description="Niveau de difficulté"
2026-02-20T22:09:11.7758118Z +    )
2026-02-20T22:09:11.7758406Z +    question: str = Field(
2026-02-20T22:09:11.7759101Z +        ..., min_length=5, description="Question de l'exercice (min 5 caractères)"
2026-02-20T22:09:11.7759705Z +    )
2026-02-20T22:09:11.7760323Z +    correct_answer: str = Field(..., description="Réponse correcte à la question")
2026-02-20T22:09:11.7760994Z +    choices: Optional[List[str]] = Field(
2026-02-20T22:09:11.7761706Z +        None, description="Options pour les questions à choix multiples"
2026-02-20T22:09:11.7762274Z +    )
2026-02-20T22:09:11.7762798Z +    explanation: Optional[str] = Field(None, description="Explication de la solution")
2026-02-20T22:09:11.7764000Z +    hint: Optional[str] = Field(None, description="Indice pour aider l'élève")
2026-02-20T22:09:11.7764995Z +    tags: Optional[str] = Field(None, description="Tags séparés par des virgules")
2026-02-20T22:09:11.7765620Z +
2026-02-20T22:09:11.7765899Z +    @field_validator("exercise_type")
2026-02-20T22:09:11.7766327Z      @classmethod
2026-02-20T22:09:11.7766661Z      def validate_exercise_type(cls, v):
2026-02-20T22:09:11.7767318Z          # Si c'est déjà un objet ExerciseType, retourner sa valeur
2026-02-20T22:09:11.7767881Z          if isinstance(v, ExerciseType):
2026-02-20T22:09:11.7768310Z              return v.value
2026-02-20T22:09:11.7768643Z  
2026-02-20T22:09:11.7769188Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7769787Z          if isinstance(v, str):
2026-02-20T22:09:11.7770337Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7770954Z              v_upper = v.upper()
2026-02-20T22:09:11.7771579Z -            valid_types = [t.value for t in ExerciseType]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7772264Z +            valid_types = [
2026-02-20T22:09:11.7772662Z +                t.value for t in ExerciseType
2026-02-20T22:09:11.7773404Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7774175Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7774795Z              if v_upper in valid_types:
2026-02-20T22:09:11.7775209Z                  return v_upper
2026-02-20T22:09:11.7775553Z              else:
2026-02-20T22:09:11.7776267Z -                raise ValueError(f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}")
2026-02-20T22:09:11.7791825Z -
2026-02-20T22:09:11.7792276Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7792787Z -
2026-02-20T22:09:11.7810072Z -    @field_validator('difficulty')
2026-02-20T22:09:11.7810569Z +                raise ValueError(
2026-02-20T22:09:11.7811299Z +                    f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}"
2026-02-20T22:09:11.7812034Z +                )
2026-02-20T22:09:11.7812331Z +
2026-02-20T22:09:11.7812692Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7813519Z +
2026-02-20T22:09:11.7813821Z +    @field_validator("difficulty")
2026-02-20T22:09:11.7814218Z      @classmethod
2026-02-20T22:09:11.7814558Z      def validate_difficulty(cls, v):
2026-02-20T22:09:11.7815311Z          # Si c'est déjà un objet DifficultyLevel, retourner sa valeur
2026-02-20T22:09:11.7815915Z          if isinstance(v, DifficultyLevel):
2026-02-20T22:09:11.7816363Z              return v.value
2026-02-20T22:09:11.7816692Z  
2026-02-20T22:09:11.7817255Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7817861Z          if isinstance(v, str):
2026-02-20T22:09:11.7818426Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7819337Z              v_upper = v.upper()
2026-02-20T22:09:11.7820035Z -            valid_difficulties = [d.value for d in DifficultyLevel]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7820805Z +            valid_difficulties = [
2026-02-20T22:09:11.7821438Z +                d.value for d in DifficultyLevel
2026-02-20T22:09:11.7821943Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7822705Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7823548Z              if v_upper in valid_difficulties:
2026-02-20T22:09:11.7823990Z                  return v_upper
2026-02-20T22:09:11.7824349Z              else:
2026-02-20T22:09:11.7825299Z -                raise ValueError(f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}")
2026-02-20T22:09:11.7826152Z -
2026-02-20T22:09:11.7826514Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7826998Z -
2026-02-20T22:09:11.7827292Z -    @field_validator('correct_answer')
2026-02-20T22:09:11.7827719Z +                raise ValueError(
2026-02-20T22:09:11.7828590Z +                    f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}"
2026-02-20T22:09:11.7829334Z +                )
2026-02-20T22:09:11.7829620Z +
2026-02-20T22:09:11.7829967Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7830425Z +
2026-02-20T22:09:11.7830707Z +    @field_validator("correct_answer")
2026-02-20T22:09:11.7831112Z      @classmethod
2026-02-20T22:09:11.7831449Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.7831851Z          if not v or v.isspace():
2026-02-20T22:09:11.7832521Z              raise ValueError("La réponse correcte ne peut pas être vide")
2026-02-20T22:09:11.7833239Z          return v
2026-02-20T22:09:11.7833527Z  
2026-02-20T22:09:11.7833799Z -    @field_validator('choices')
2026-02-20T22:09:11.7834217Z +    @field_validator("choices")
2026-02-20T22:09:11.7834595Z      @classmethod
2026-02-20T22:09:11.7834923Z      def validate_choices(cls, v, info):
2026-02-20T22:09:11.7835355Z          if v is not None:
2026-02-20T22:09:11.7835850Z              # Vérifier qu'il y a au moins 2 choix
2026-02-20T22:09:11.7836313Z              if len(v) < 2:
2026-02-20T22:09:11.7836841Z                  raise ValueError("Il doit y avoir au moins 2 choix pour un QCM")
2026-02-20T22:09:11.7837434Z  
2026-02-20T22:09:11.7837901Z              # Vérifier que la réponse correcte est dans les choix
2026-02-20T22:09:11.7838430Z              values = info.data
2026-02-20T22:09:11.7838985Z -            if 'correct_answer' in values and values['correct_answer'] not in v:
2026-02-20T22:09:11.7839950Z -                raise ValueError("La réponse correcte doit être présente dans les choix")
2026-02-20T22:09:11.7840794Z +            if "correct_answer" in values and values["correct_answer"] not in v:
2026-02-20T22:09:11.7841399Z +                raise ValueError(
2026-02-20T22:09:11.7842040Z +                    "La réponse correcte doit être présente dans les choix"
2026-02-20T22:09:11.7842566Z +                )
2026-02-20T22:09:11.7842846Z  
2026-02-20T22:09:11.7843385Z              # Vérifier que les choix sont uniques
2026-02-20T22:09:11.7843860Z              if len(v) != len(set(v)):
2026-02-20T22:09:11.7844477Z                  raise ValueError("Les choix doivent être uniques")
2026-02-20T22:09:11.7844972Z  
2026-02-20T22:09:11.7845222Z          return v
2026-02-20T22:09:11.7845492Z  
2026-02-20T22:09:11.7845758Z -    @field_validator('question')
2026-02-20T22:09:11.7846153Z +    @field_validator("question")
2026-02-20T22:09:11.7846530Z      @classmethod
2026-02-20T22:09:11.7846844Z      def validate_question(cls, v):
2026-02-20T22:09:11.7847849Z          # Vérifier que la question contient un point d'interrogation, deux points, point d'exclamation ou point final
2026-02-20T22:09:11.7848804Z -        if not any(mark in v for mark in ['?', ':', '!', '.']):
2026-02-20T22:09:11.7849801Z -            raise ValueError("La question doit contenir une ponctuation finale (?, :, !, .)")
2026-02-20T22:09:11.7850496Z -        return v
2026-02-20T22:09:11.7850879Z +        if not any(mark in v for mark in ["?", ":", "!", "."]):
2026-02-20T22:09:11.7851562Z +            raise ValueError(
2026-02-20T22:09:11.7852097Z +                "La question doit contenir une ponctuation finale (?, :, !, .)"
2026-02-20T22:09:11.7852670Z +            )
2026-02-20T22:09:11.7852948Z +        return v
2026-02-20T22:09:11.7853371Z +
2026-02-20T22:09:11.7853612Z  
2026-02-20T22:09:11.7853890Z  class ExerciseCreate(ExerciseBase):
2026-02-20T22:09:11.7854606Z      """Schéma pour la création d'un exercice (Création d'une Épreuve)"""
2026-02-20T22:09:11.7855218Z -    image_url: Optional[str] = Field(None,
2026-02-20T22:09:11.7855858Z -                                  description="URL de l'image associée")
2026-02-20T22:09:11.7856383Z -    audio_url: Optional[str] = Field(None,
2026-02-20T22:09:11.7857095Z -                                  description="URL audio pour accessibilité")
2026-02-20T22:09:11.7857652Z +
2026-02-20T22:09:11.7858315Z +    image_url: Optional[str] = Field(None, description="URL de l'image associée")
2026-02-20T22:09:11.7859430Z +    audio_url: Optional[str] = Field(None, description="URL audio pour accessibilité")
2026-02-20T22:09:11.7860125Z +
2026-02-20T22:09:11.7860394Z  
2026-02-20T22:09:11.7860686Z  class ExerciseUpdate(BaseModel):
2026-02-20T22:09:11.7861490Z      """Schéma pour la mise à jour d'un exercice (Modification d'une Épreuve)"""
2026-02-20T22:09:11.7862120Z +
2026-02-20T22:09:11.7862554Z      title: Optional[str] = Field(None, min_length=3, max_length=100)
2026-02-20T22:09:11.7864587Z      exercise_type: Optional[Union[str, ExerciseType]] = None
2026-02-20T22:09:11.7897332Z      difficulty: Optional[Union[str, DifficultyLevel]] = None
2026-02-20T22:09:11.7898082Z      question: Optional[str] = Field(None, min_length=5)
2026-02-20T22:09:11.7898673Z      correct_answer: Optional[str] = None
2026-02-20T22:09:11.7899129Z @@ -123,11 +143,11 @@
2026-02-20T22:09:11.7899493Z      image_url: Optional[str] = None
2026-02-20T22:09:11.7899946Z      audio_url: Optional[str] = None
2026-02-20T22:09:11.7900400Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.7900879Z      is_archived: Optional[bool] = None
2026-02-20T22:09:11.7901319Z  
2026-02-20T22:09:11.7901625Z -    @field_validator('exercise_type')
2026-02-20T22:09:11.7902096Z +    @field_validator("exercise_type")
2026-02-20T22:09:11.7902513Z      @classmethod
2026-02-20T22:09:11.7902867Z      def validate_exercise_type(cls, v):
2026-02-20T22:09:11.7903598Z          if v is None:
2026-02-20T22:09:11.7903938Z              return None
2026-02-20T22:09:11.7904269Z  
2026-02-20T22:09:11.7904542Z @@ -137,20 +157,24 @@
2026-02-20T22:09:11.7904839Z  
2026-02-20T22:09:11.7905513Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7906175Z          if isinstance(v, str):
2026-02-20T22:09:11.7906769Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7907418Z              v_upper = v.upper()
2026-02-20T22:09:11.7908066Z -            valid_types = [t.value for t in ExerciseType]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7908794Z +            valid_types = [
2026-02-20T22:09:11.7909204Z +                t.value for t in ExerciseType
2026-02-20T22:09:11.7909711Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7910548Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7911224Z              if v_upper in valid_types:
2026-02-20T22:09:11.7911665Z                  return v_upper
2026-02-20T22:09:11.7912036Z              else:
2026-02-20T22:09:11.7912791Z -                raise ValueError(f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}")
2026-02-20T22:09:11.7913844Z -
2026-02-20T22:09:11.7914494Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7914995Z -
2026-02-20T22:09:11.7915303Z -    @field_validator('difficulty')
2026-02-20T22:09:11.7915733Z +                raise ValueError(
2026-02-20T22:09:11.7916710Z +                    f"Le type d'exercice '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_types)}"
2026-02-20T22:09:11.7917488Z +                )
2026-02-20T22:09:11.7917793Z +
2026-02-20T22:09:11.7918161Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7918637Z +
2026-02-20T22:09:11.7918930Z +    @field_validator("difficulty")
2026-02-20T22:09:11.7919336Z      @classmethod
2026-02-20T22:09:11.7919681Z      def validate_difficulty(cls, v):
2026-02-20T22:09:11.7920094Z          if v is None:
2026-02-20T22:09:11.7920432Z              return None
2026-02-20T22:09:11.7920765Z  
2026-02-20T22:09:11.7921027Z @@ -160,27 +184,33 @@
2026-02-20T22:09:11.7921331Z  
2026-02-20T22:09:11.7921953Z          # Si c'est une chaîne, vérifier qu'elle correspond à une valeur valide
2026-02-20T22:09:11.7922606Z          if isinstance(v, str):
2026-02-20T22:09:11.7929554Z              # Convertir en majuscules pour comparaison avec les valeurs d'enum
2026-02-20T22:09:11.7934266Z              v_upper = v.upper()
2026-02-20T22:09:11.7935035Z -            valid_difficulties = [d.value for d in DifficultyLevel]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7935843Z +            valid_difficulties = [
2026-02-20T22:09:11.7936307Z +                d.value for d in DifficultyLevel
2026-02-20T22:09:11.7936802Z +            ]  # Les valeurs sont en MAJUSCULES
2026-02-20T22:09:11.7937663Z              # Vérifier si la valeur (en majuscules) correspond à une valeur valide
2026-02-20T22:09:11.7938363Z              if v_upper in valid_difficulties:
2026-02-20T22:09:11.7938820Z                  return v_upper
2026-02-20T22:09:11.7939166Z              else:
2026-02-20T22:09:11.7940133Z -                raise ValueError(f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}")
2026-02-20T22:09:11.7941052Z -
2026-02-20T22:09:11.7941437Z -        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7941941Z -
2026-02-20T22:09:11.7942231Z -    @field_validator('question')
2026-02-20T22:09:11.7942673Z +                raise ValueError(
2026-02-20T22:09:11.7943840Z +                    f"La difficulté '{v}' n'est pas valide. Valeurs possibles: {', '.join(valid_difficulties)}"
2026-02-20T22:09:11.7946158Z +                )
2026-02-20T22:09:11.7947507Z +
2026-02-20T22:09:11.7973548Z +        raise ValueError(f"Type non valide: {type(v)}")
2026-02-20T22:09:11.7974073Z +
2026-02-20T22:09:11.7974377Z +    @field_validator("question")
2026-02-20T22:09:11.7974791Z      @classmethod
2026-02-20T22:09:11.7975130Z      def validate_question(cls, v):
2026-02-20T22:09:11.7975755Z -        if v is not None and not any(mark in v for mark in ['?', ':', '!', '.']):
2026-02-20T22:09:11.7976684Z -            raise ValueError("La question doit contenir une ponctuation finale (?, :, !, .)")
2026-02-20T22:09:11.7977432Z -        return v
2026-02-20T22:09:11.7977730Z -
2026-02-20T22:09:11.7978027Z -    @field_validator('choices')
2026-02-20T22:09:11.7978602Z +        if v is not None and not any(mark in v for mark in ["?", ":", "!", "."]):
2026-02-20T22:09:11.7979252Z +            raise ValueError(
2026-02-20T22:09:11.7979806Z +                "La question doit contenir une ponctuation finale (?, :, !, .)"
2026-02-20T22:09:11.7980404Z +            )
2026-02-20T22:09:11.7980705Z +        return v
2026-02-20T22:09:11.7980994Z +
2026-02-20T22:09:11.7981285Z +    @field_validator("choices")
2026-02-20T22:09:11.7981667Z      @classmethod
2026-02-20T22:09:11.7982014Z      def validate_choices(cls, v, info):
2026-02-20T22:09:11.7982445Z          if v is not None:
2026-02-20T22:09:11.7983216Z              # Vérifier qu'il y a au moins 2 choix
2026-02-20T22:09:11.7983710Z              if len(v) < 2:
2026-02-20T22:09:11.7984065Z @@ -190,12 +220,14 @@
2026-02-20T22:09:11.7984705Z              if len(v) != len(set(v)):
2026-02-20T22:09:11.7985397Z                  raise ValueError("Les choix doivent être uniques")
2026-02-20T22:09:11.7985926Z  
2026-02-20T22:09:11.7986184Z          return v
2026-02-20T22:09:11.7986483Z  
2026-02-20T22:09:11.7986718Z +
2026-02-20T22:09:11.7987239Z  class ExerciseInDB(ExerciseBase):
2026-02-20T22:09:11.7988054Z      """Schéma pour un exercice en base de données (Archives des Épreuves)"""
2026-02-20T22:09:11.7988672Z +
2026-02-20T22:09:11.7988939Z      id: int
2026-02-20T22:09:11.7989269Z      creator_id: Optional[int] = None
2026-02-20T22:09:11.7989724Z      image_url: Optional[str] = None
2026-02-20T22:09:11.7990167Z      audio_url: Optional[str] = None
2026-02-20T22:09:11.7990689Z      is_active: bool
2026-02-20T22:09:11.7991023Z @@ -204,18 +236,22 @@
2026-02-20T22:09:11.7991369Z      created_at: datetime
2026-02-20T22:09:11.7991738Z      updated_at: datetime
2026-02-20T22:09:11.7992088Z  
2026-02-20T22:09:11.7992444Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8023214Z  
2026-02-20T22:09:11.8023546Z +
2026-02-20T22:09:11.8023856Z  class Exercise(ExerciseInDB):
2026-02-20T22:09:11.8024594Z      """Schéma pour un exercice complet (Holocron d'Épreuve)"""
2026-02-20T22:09:11.8025150Z +
2026-02-20T22:09:11.8025549Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8026041Z +
2026-02-20T22:09:11.8026300Z  
2026-02-20T22:09:11.8026585Z  class ExerciseStats(BaseModel):
2026-02-20T22:09:11.8027251Z      """Statistiques sur un exercice (Données de l'Holocron)"""
2026-02-20T22:09:11.8027780Z +
2026-02-20T22:09:11.8028056Z      exercise_id: int
2026-02-20T22:09:11.8028397Z      view_count: int
2026-02-20T22:09:11.8028727Z      attempt_count: int
2026-02-20T22:09:11.8029086Z      success_rate: float
2026-02-20T22:09:11.8029470Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8029902Z  
2026-02-20T22:09:11.8030250Z -    model_config = ConfigDict(from_attributes=True) 
2026-02-20T22:09:11.8030796Z \ No newline at end of file
2026-02-20T22:09:11.8031231Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8032037Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/progress.py
2026-02-20T22:09:11.8033332Z --- /home/runner/work/mathakine/mathakine/app/schemas/progress.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.8034511Z +++ /home/runner/work/mathakine/mathakine/app/schemas/progress.py	2026-02-20 22:09:11.776861+00:00
2026-02-20T22:09:11.8035302Z @@ -4,41 +4,47 @@
2026-02-20T22:09:11.8035802Z  from pydantic import BaseModel, ConfigDict, Field, field_validator
2026-02-20T22:09:11.8036392Z  
2026-02-20T22:09:11.8036888Z  # Schémas pour la manipulation des progressions
2026-02-20T22:09:11.8037369Z  
2026-02-20T22:09:11.8037628Z  
2026-02-20T22:09:11.8037881Z -
2026-02-20T22:09:11.8038183Z  class ProgressBase(BaseModel):
2026-02-20T22:09:11.8038920Z      """Schéma de base pour les progressions (Chemin vers la Maîtrise)"""
2026-02-20T22:09:11.8039876Z -    exercise_type: str = Field(..., description="Type d'exercice (addition, soustraction, etc.)")
2026-02-20T22:09:11.8040637Z +
2026-02-20T22:09:11.8040931Z +    exercise_type: str = Field(
2026-02-20T22:09:11.8041511Z +        ..., description="Type d'exercice (addition, soustraction, etc.)"
2026-02-20T22:09:11.8042102Z +    )
2026-02-20T22:09:11.8042716Z      difficulty: str = Field(..., description="Niveau de difficulté")
2026-02-20T22:09:11.8043752Z      total_attempts: int = Field(0, ge=0, description="Nombre total de tentatives")
2026-02-20T22:09:11.8044862Z      correct_attempts: int = Field(0, ge=0, description="Nombre de tentatives réussies")
2026-02-20T22:09:11.8046125Z -    average_time: Optional[float] = Field(None, ge=0.0, description="Temps moyen pour résoudre (secondes)")
2026-02-20T22:09:11.8047478Z -    completion_rate: Optional[float] = Field(None, ge=0.0, le=100.0, description="Taux de complétion (%)")
2026-02-20T22:09:11.8048209Z +    average_time: Optional[float] = Field(
2026-02-20T22:09:11.8049127Z +        None, ge=0.0, description="Temps moyen pour résoudre (secondes)"
2026-02-20T22:09:11.8049665Z +    )
2026-02-20T22:09:11.8049982Z +    completion_rate: Optional[float] = Field(
2026-02-20T22:09:11.8050640Z +        None, ge=0.0, le=100.0, description="Taux de complétion (%)"
2026-02-20T22:09:11.8051311Z +    )
2026-02-20T22:09:11.8051870Z      mastery_level: int = Field(1, description="Niveau de maîtrise (1-5)")
2026-02-20T22:09:11.8052437Z  
2026-02-20T22:09:11.8052716Z -    @field_validator('correct_attempts')
2026-02-20T22:09:11.8083505Z +    @field_validator("correct_attempts")
2026-02-20T22:09:11.8083966Z      @classmethod
2026-02-20T22:09:11.8084281Z -
2026-02-20T22:09:11.8084545Z -
2026-02-20T22:09:11.8084905Z      def correct_not_greater_than_total(cls, v, info):
2026-02-20T22:09:11.8085434Z          values = info.data
2026-02-20T22:09:11.8085961Z -        if 'total_attempts' in values and v > values['total_attempts']:
2026-02-20T22:09:11.8087222Z -            raise ValueError("Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives")
2026-02-20T22:09:11.8088290Z +        if "total_attempts" in values and v > values["total_attempts"]:
2026-02-20T22:09:11.8088907Z +            raise ValueError(
2026-02-20T22:09:11.8089878Z +                "Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives"
2026-02-20T22:09:11.8090628Z +            )
2026-02-20T22:09:11.8090926Z          return v
2026-02-20T22:09:11.8091216Z -
2026-02-20T22:09:11.8091473Z  
2026-02-20T22:09:11.8091720Z  
2026-02-20T22:09:11.8092033Z  class ProgressCreate(ProgressBase):
2026-02-20T22:09:11.8092792Z      """Schéma pour la création d'un enregistrement de progression"""
2026-02-20T22:09:11.8093553Z +
2026-02-20T22:09:11.8094142Z      user_id: int = Field(..., description="ID de l'utilisateur associé")
2026-02-20T22:09:11.8094726Z -
2026-02-20T22:09:11.8094994Z  
2026-02-20T22:09:11.8095231Z  
2026-02-20T22:09:11.8095530Z  class ProgressUpdate(BaseModel):
2026-02-20T22:09:11.8096307Z      """Schéma pour la mise à jour d'un enregistrement de progression"""
2026-02-20T22:09:11.8096906Z +
2026-02-20T22:09:11.8097267Z      total_attempts: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8097882Z      correct_attempts: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8098495Z      average_time: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.8099178Z      completion_rate: Optional[float] = Field(None, ge=0.0, le=100.0)
2026-02-20T22:09:11.8099828Z      streak: Optional[int] = Field(None, ge=0)
2026-02-20T22:09:11.8100281Z @@ -47,36 +53,44 @@
2026-02-20T22:09:11.8100648Z      awards: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8101113Z      strengths: Optional[str] = None
2026-02-20T22:09:11.8101577Z      areas_to_improve: Optional[str] = None
2026-02-20T22:09:11.8102065Z      recommendations: Optional[str] = None
2026-02-20T22:09:11.8102494Z  
2026-02-20T22:09:11.8102799Z -    @field_validator('correct_attempts')
2026-02-20T22:09:11.8103494Z +    @field_validator("correct_attempts")
2026-02-20T22:09:11.8103925Z      @classmethod
2026-02-20T22:09:11.8104216Z -
2026-02-20T22:09:11.8104470Z -
2026-02-20T22:09:11.8104808Z      def correct_not_greater_than_total(cls, v, info):
2026-02-20T22:09:11.8105314Z          values = info.data
2026-02-20T22:09:11.8105974Z -        if v is not None and 'total_attempts' in values and values['total_attempts'] is not None\
2026-02-20T22:09:11.8106754Z -            and v > values['total_attempts']:
2026-02-20T22:09:11.8107854Z -            raise ValueError("Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives")
2026-02-20T22:09:11.8108718Z +        if (
2026-02-20T22:09:11.8109025Z +            v is not None
2026-02-20T22:09:11.8109402Z +            and "total_attempts" in values
2026-02-20T22:09:11.8109899Z +            and values["total_attempts"] is not None
2026-02-20T22:09:11.8110411Z +            and v > values["total_attempts"]
2026-02-20T22:09:11.8110845Z +        ):
2026-02-20T22:09:11.8111410Z +            raise ValueError(
2026-02-20T22:09:11.8112291Z +                "Le nombre de tentatives réussies ne peut pas dépasser le nombre total de tentatives"
2026-02-20T22:09:11.8143276Z +            )
2026-02-20T22:09:11.8143654Z          return v
2026-02-20T22:09:11.8143974Z  
2026-02-20T22:09:11.8144537Z -    @field_validator('highest_streak')
2026-02-20T22:09:11.8145061Z +    @field_validator("highest_streak")
2026-02-20T22:09:11.8145490Z      @classmethod
2026-02-20T22:09:11.8145795Z -
2026-02-20T22:09:11.8146048Z -
2026-02-20T22:09:11.8146441Z      def highest_streak_not_less_than_streak(cls, v, info):
2026-02-20T22:09:11.8146980Z          values = info.data
2026-02-20T22:09:11.8147542Z -        if v is not None and 'streak' in values and values['streak'] is not None\
2026-02-20T22:09:11.8148191Z -            and v < values['streak']:
2026-02-20T22:09:11.8149169Z -            raise ValueError("La meilleure série ne peut pas être inférieure à la série actuelle")
2026-02-20T22:09:11.8149983Z +        if (
2026-02-20T22:09:11.8150297Z +            v is not None
2026-02-20T22:09:11.8150677Z +            and "streak" in values
2026-02-20T22:09:11.8151120Z +            and values["streak"] is not None
2026-02-20T22:09:11.8151591Z +            and v < values["streak"]
2026-02-20T22:09:11.8152015Z +        ):
2026-02-20T22:09:11.8152326Z +            raise ValueError(
2026-02-20T22:09:11.8153292Z +                "La meilleure série ne peut pas être inférieure à la série actuelle"
2026-02-20T22:09:11.8153947Z +            )
2026-02-20T22:09:11.8154248Z          return v
2026-02-20T22:09:11.8154537Z -
2026-02-20T22:09:11.8154800Z  
2026-02-20T22:09:11.8155046Z  
2026-02-20T22:09:11.8155349Z  class ProgressInDB(ProgressBase):
2026-02-20T22:09:11.8156113Z      """Schéma pour un enregistrement de progression en base de données"""
2026-02-20T22:09:11.8156723Z +
2026-02-20T22:09:11.8156982Z      id: int
2026-02-20T22:09:11.8157279Z      user_id: int
2026-02-20T22:09:11.8157624Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8158112Z      completion_rate: Optional[float] = None
2026-02-20T22:09:11.8158520Z      streak: int
2026-02-20T22:09:11.8158799Z @@ -89,24 +103,26 @@
2026-02-20T22:09:11.8159117Z      last_updated: datetime
2026-02-20T22:09:11.8159433Z  
2026-02-20T22:09:11.8159760Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8160199Z  
2026-02-20T22:09:11.8160424Z  
2026-02-20T22:09:11.8160639Z -
2026-02-20T22:09:11.8160919Z  class Progress(ProgressInDB):
2026-02-20T22:09:11.8161665Z      """Schéma pour un enregistrement de progression complet (Carte de Progression)"""
2026-02-20T22:09:11.8162302Z +
2026-02-20T22:09:11.8162574Z      user_name: Optional[str] = None
2026-02-20T22:09:11.8162941Z  
2026-02-20T22:09:11.8163420Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8163853Z  
2026-02-20T22:09:11.8164087Z  
2026-02-20T22:09:11.8164306Z -
2026-02-20T22:09:11.8164593Z  class UserProgressSummary(BaseModel):
2026-02-20T22:09:11.8165319Z      """Résumé de la progression d'un utilisateur (Rapport du Conseil Jedi)"""
2026-02-20T22:09:11.8165879Z +
2026-02-20T22:09:11.8166115Z      user_id: int
2026-02-20T22:09:11.8166398Z      user_name: str
2026-02-20T22:09:11.8167147Z -    overall_mastery: float = Field(..., ge=0.0, le=5.0, description="Niveau de maîtrise global (0-5)")
2026-02-20T22:09:11.8167869Z +    overall_mastery: float = Field(
2026-02-20T22:09:11.8168507Z +        ..., ge=0.0, le=5.0, description="Niveau de maîtrise global (0-5)"
2026-02-20T22:09:11.8169010Z +    )
2026-02-20T22:09:11.8169289Z      total_exercises_completed: int
2026-02-20T22:09:11.8169695Z      strongest_area: Optional[str] = None
2026-02-20T22:09:11.8170129Z      weakest_area: Optional[str] = None
2026-02-20T22:09:11.8170616Z      recent_progress: Optional[List[Dict[str, Any]]] = None
2026-02-20T22:09:11.8171234Z      next_recommended_exercise_types: Optional[List[str]] = None
2026-02-20T22:09:11.8171749Z @@ -114,26 +130,33 @@
2026-02-20T22:09:11.8172336Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8172776Z  
2026-02-20T22:09:11.8203283Z  
2026-02-20T22:09:11.8203677Z  class ProgressResponse(ProgressBase):
2026-02-20T22:09:11.8204429Z      """Schéma pour la réponse de progrès utilisateur"""
2026-02-20T22:09:11.8205690Z -    last_updated: Optional[str] = Field(None, description="Date de dernière mise à jour")
2026-02-20T22:09:11.8206445Z -    
2026-02-20T22:09:11.8206729Z +
2026-02-20T22:09:11.8207040Z +    last_updated: Optional[str] = Field(
2026-02-20T22:09:11.8207723Z +        None, description="Date de dernière mise à jour"
2026-02-20T22:09:11.8208228Z +    )
2026-02-20T22:09:11.8208499Z +
2026-02-20T22:09:11.8208864Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8209350Z  
2026-02-20T22:09:11.8209612Z  
2026-02-20T22:09:11.8209906Z  class RecentAttempt(BaseModel):
2026-02-20T22:09:11.8210500Z      """Schéma pour les tentatives récentes"""
2026-02-20T22:09:11.8210940Z +
2026-02-20T22:09:11.8211389Z      exercise_id: int = Field(..., description="ID de l'exercice")
2026-02-20T22:09:11.8212152Z      exercise_title: str = Field(..., description="Titre de l'exercice")
2026-02-20T22:09:11.8213170Z      is_correct: bool = Field(..., description="Si la tentative est correcte")
2026-02-20T22:09:11.8214185Z      time_spent: float = Field(..., description="Temps passé (secondes)")
2026-02-20T22:09:11.8214978Z      date: Optional[str] = Field(None, description="Date de la tentative")
2026-02-20T22:09:11.8215581Z  
2026-02-20T22:09:11.8215831Z  
2026-02-20T22:09:11.8216149Z  class ProgressDetail(ProgressResponse):
2026-02-20T22:09:11.8216849Z      """Schéma détaillé pour les progrès utilisateur"""
2026-02-20T22:09:11.8217348Z +
2026-02-20T22:09:11.8217973Z      streak: int = Field(0, description="Série actuelle d'exercices réussis")
2026-02-20T22:09:11.8218898Z      highest_streak: int = Field(0, description="Meilleure série")
2026-02-20T22:09:11.8219876Z      strengths: Optional[str] = Field(None, description="Points forts identifiés")
2026-02-20T22:09:11.8221004Z      areas_to_improve: Optional[str] = Field(None, description="Domaines à améliorer")
2026-02-20T22:09:11.8222297Z -    recent_attempts: List[RecentAttempt] = Field(default_factory=list, description="Tentatives récentes")
2026-02-20T22:09:11.8223473Z +    recent_attempts: List[RecentAttempt] = Field(
2026-02-20T22:09:11.8224247Z +        default_factory=list, description="Tentatives récentes"
2026-02-20T22:09:11.8224809Z +    )
2026-02-20T22:09:11.8225472Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py
2026-02-20T22:09:11.8226607Z --- /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py	2026-02-20 22:09:02.809965+00:00
2026-02-20T22:09:11.8227847Z +++ /home/runner/work/mathakine/mathakine/app/schemas/logic_challenge.py	2026-02-20 22:09:11.813484+00:00
2026-02-20T22:09:11.8228677Z @@ -5,71 +5,87 @@
2026-02-20T22:09:11.8228984Z  
2026-02-20T22:09:11.8229306Z  from app.models.logic_challenge import AgeGroup, LogicChallengeType
2026-02-20T22:09:11.8229432Z  
2026-02-20T22:09:11.8229775Z  # Schémas pour la manipulation des défis logiques
2026-02-20T22:09:11.8229886Z  
2026-02-20T22:09:11.8229994Z +
2026-02-20T22:09:11.8230164Z  class LogicChallengeBase(BaseModel):
2026-02-20T22:09:11.8230648Z      """Schéma de base pour les défis de logique (Épreuves du Conseil Jedi)"""
2026-02-20T22:09:11.8230886Z -    title: str = Field(..., min_length=3, max_length=100,
2026-02-20T22:09:11.8231264Z -                    description="Titre du défi (3-100 caractères)")
2026-02-20T22:09:11.8231487Z -    challenge_type: LogicChallengeType = Field(...,
2026-02-20T22:09:11.8231856Z -                                           description="Type de défi logique")
2026-02-20T22:09:11.8232010Z -    age_group: AgeGroup = Field(...,
2026-02-20T22:09:11.8232322Z -                             description="Groupe d'âge cible")
2026-02-20T22:09:11.8232524Z -    description: str = Field(..., min_length=10,
2026-02-20T22:09:11.8232928Z -                         description="Énoncé du problème (min 10 caractères)")
2026-02-20T22:09:11.8263647Z -    correct_answer: str = Field(...,
2026-02-20T22:09:11.8264066Z -                             description="Réponse correcte au défi")
2026-02-20T22:09:11.8264490Z -    solution_explanation: str = Field(..., min_length=10,
2026-02-20T22:09:11.8264918Z -                                  description="Explication détaillée de la solution")
2026-02-20T22:09:11.8265036Z +
2026-02-20T22:09:11.8265172Z +    title: str = Field(
2026-02-20T22:09:11.8265281Z +        ...,
2026-02-20T22:09:11.8265405Z +        min_length=3,
2026-02-20T22:09:11.8265536Z +        max_length=100,
2026-02-20T22:09:11.8265846Z +        description="Titre du défi (3-100 caractères)",
2026-02-20T22:09:11.8265952Z +    )
2026-02-20T22:09:11.8266504Z +    challenge_type: LogicChallengeType = Field(..., description="Type de défi logique")
2026-02-20T22:09:11.8266900Z +    age_group: AgeGroup = Field(..., description="Groupe d'âge cible")
2026-02-20T22:09:11.8267059Z +    description: str = Field(
2026-02-20T22:09:11.8267504Z +        ..., min_length=10, description="Énoncé du problème (min 10 caractères)"
2026-02-20T22:09:11.8267619Z +    )
2026-02-20T22:09:11.8268051Z +    correct_answer: str = Field(..., description="Réponse correcte au défi")
2026-02-20T22:09:11.8268218Z +    solution_explanation: str = Field(
2026-02-20T22:09:11.8268648Z +        ..., min_length=10, description="Explication détaillée de la solution"
2026-02-20T22:09:11.8268751Z +    )
2026-02-20T22:09:11.8268854Z  
2026-02-20T22:09:11.8268990Z      # Champs optionnels
2026-02-20T22:09:11.8269157Z -    hints: Optional[List[str]] = Field(None,
2026-02-20T22:09:11.8269431Z -                                    description="Liste des indices (aide progressive)")
2026-02-20T22:09:11.8269655Z -    difficulty_rating: float = Field(3.0, ge=1.0, le=5.0,
2026-02-20T22:09:11.8270005Z -                                 description="Niveau de difficulté (1-5)")
2026-02-20T22:09:11.8270231Z -    estimated_time_minutes: int = Field(15, ge=1, le=120,
2026-02-20T22:09:11.8270651Z -                                     description="Temps estimé pour résoudre (en minutes)")
2026-02-20T22:09:11.8270811Z -    tags: Optional[str] = Field(None,
2026-02-20T22:09:11.8271166Z -                             description="Tags séparés par des virgules")
2026-02-20T22:09:11.8271273Z -
2026-02-20T22:09:11.8271431Z -    @field_validator('correct_answer')
2026-02-20T22:09:11.8271578Z +    hints: Optional[List[str]] = Field(
2026-02-20T22:09:11.8271823Z +        None, description="Liste des indices (aide progressive)"
2026-02-20T22:09:11.8271926Z +    )
2026-02-20T22:09:11.8272078Z +    difficulty_rating: float = Field(
2026-02-20T22:09:11.8272431Z +        3.0, ge=1.0, le=5.0, description="Niveau de difficulté (1-5)"
2026-02-20T22:09:11.8272533Z +    )
2026-02-20T22:09:11.8272686Z +    estimated_time_minutes: int = Field(
2026-02-20T22:09:11.8273271Z +        15, ge=1, le=120, description="Temps estimé pour résoudre (en minutes)"
2026-02-20T22:09:11.8273394Z +    )
2026-02-20T22:09:11.8273880Z +    tags: Optional[str] = Field(None, description="Tags séparés par des virgules")
2026-02-20T22:09:11.8273984Z +
2026-02-20T22:09:11.8274131Z +    @field_validator("correct_answer")
2026-02-20T22:09:11.8274251Z      @classmethod
2026-02-20T22:09:11.8274418Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8274556Z          if not v or v.isspace():
2026-02-20T22:09:11.8274961Z              raise ValueError("La réponse correcte ne peut pas être vide")
2026-02-20T22:09:11.8275083Z          return v
2026-02-20T22:09:11.8275186Z  
2026-02-20T22:09:11.8275337Z -    @field_validator('description')
2026-02-20T22:09:11.8275477Z +    @field_validator("description")
2026-02-20T22:09:11.8275597Z      @classmethod
2026-02-20T22:09:11.8275760Z      def description_not_too_short(cls, v):
2026-02-20T22:09:11.8275885Z          if len(v) < 10:
2026-02-20T22:09:11.8276355Z              raise ValueError("La description doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8276666Z          return v
2026-02-20T22:09:11.8276761Z  
2026-02-20T22:09:11.8276933Z -    @field_validator('solution_explanation')
2026-02-20T22:09:11.8277100Z +    @field_validator("solution_explanation")
2026-02-20T22:09:11.8277206Z      @classmethod
2026-02-20T22:09:11.8277499Z      def explanation_not_too_short(cls, v):
2026-02-20T22:09:11.8277630Z          if len(v) < 10:
2026-02-20T22:09:11.8278188Z -            raise ValueError("L'explication de la solution doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8278296Z -        return v
2026-02-20T22:09:11.8278429Z +            raise ValueError(
2026-02-20T22:09:11.8278860Z +                "L'explication de la solution doit contenir au moins 10 caractères"
2026-02-20T22:09:11.8278964Z +            )
2026-02-20T22:09:11.8279069Z +        return v
2026-02-20T22:09:11.8279171Z +
2026-02-20T22:09:11.8279272Z  
2026-02-20T22:09:11.8279475Z  class LogicChallengeCreate(LogicChallengeBase):
2026-02-20T22:09:11.8279773Z      """Schéma pour la création d'un défi logique"""
2026-02-20T22:09:11.8279980Z -    visual_data: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.8280519Z -                                             description="Données pour visualisation (graphes, formes, etc.)")
2026-02-20T22:09:11.8280695Z -    image_url: Optional[str] = Field(None,
2026-02-20T22:09:11.8281008Z -                                 description="URL de l'image associée")
2026-02-20T22:09:11.8281196Z -    source_reference: Optional[str] = Field(None,
2026-02-20T22:09:11.8281444Z -                                        description="Source (concours, livre, etc.)")
2026-02-20T22:09:11.8281595Z -    is_template: bool = Field(False,
2026-02-20T22:09:11.8281994Z -                           description="S'il s'agit d'un template pour génération")
2026-02-20T22:09:11.8282268Z -    generation_parameters: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.8282689Z -                                                       description="Paramètres pour la génération")
2026-02-20T22:09:11.8282797Z +
2026-02-20T22:09:11.8283149Z +    visual_data: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.8283592Z +        None, description="Données pour visualisation (graphes, formes, etc.)"
2026-02-20T22:09:11.8283692Z +    )
2026-02-20T22:09:11.8284161Z +    image_url: Optional[str] = Field(None, description="URL de l'image associée")
2026-02-20T22:09:11.8284328Z +    source_reference: Optional[str] = Field(
2026-02-20T22:09:11.8284531Z +        None, description="Source (concours, livre, etc.)"
2026-02-20T22:09:11.8284637Z +    )
2026-02-20T22:09:11.8284774Z +    is_template: bool = Field(
2026-02-20T22:09:11.8285170Z +        False, description="S'il s'agit d'un template pour génération"
2026-02-20T22:09:11.8285275Z +    )
2026-02-20T22:09:11.8285522Z +    generation_parameters: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.8285852Z +        None, description="Paramètres pour la génération"
2026-02-20T22:09:11.8285958Z +    )
2026-02-20T22:09:11.8286079Z +
2026-02-20T22:09:11.8286181Z  
2026-02-20T22:09:11.8286357Z  class LogicChallengeUpdate(BaseModel):
2026-02-20T22:09:11.8286655Z      """Schéma pour la mise à jour d'un défi logique"""
2026-02-20T22:09:11.8286757Z +
2026-02-20T22:09:11.8287131Z      title: Optional[str] = Field(None, min_length=3, max_length=100)
2026-02-20T22:09:11.8287370Z      challenge_type: Optional[LogicChallengeType] = None
2026-02-20T22:09:11.8287530Z      age_group: Optional[AgeGroup] = None
2026-02-20T22:09:11.8287767Z      description: Optional[str] = Field(None, min_length=10)
2026-02-20T22:09:11.8287925Z      correct_answer: Optional[str] = None
2026-02-20T22:09:11.8288038Z @@ -84,26 +100,30 @@
2026-02-20T22:09:11.8288186Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.8288343Z      is_archived: Optional[bool] = None
2026-02-20T22:09:11.8288490Z      is_template: Optional[bool] = None
2026-02-20T22:09:11.8288724Z      generation_parameters: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8289054Z  
2026-02-20T22:09:11.8289207Z -    @field_validator('description')
2026-02-20T22:09:11.8289350Z +    @field_validator("description")
2026-02-20T22:09:11.8289467Z      @classmethod
2026-02-20T22:09:11.8289642Z      def description_not_too_short(cls, v):
2026-02-20T22:09:11.8289952Z          if v is not None and len(v) < 10:
2026-02-20T22:09:11.8290463Z              raise ValueError("La description doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8290586Z          return v
2026-02-20T22:09:11.8290687Z  
2026-02-20T22:09:11.8290864Z -    @field_validator('solution_explanation')
2026-02-20T22:09:11.8291029Z +    @field_validator("solution_explanation")
2026-02-20T22:09:11.8291148Z      @classmethod
2026-02-20T22:09:11.8291313Z      def explanation_not_too_short(cls, v):
2026-02-20T22:09:11.8291460Z          if v is not None and len(v) < 10:
2026-02-20T22:09:11.8292048Z -            raise ValueError("L'explication de la solution doit contenir au moins 10 caractères")
2026-02-20T22:09:11.8292175Z -        return v
2026-02-20T22:09:11.8292307Z +            raise ValueError(
2026-02-20T22:09:11.8292755Z +                "L'explication de la solution doit contenir au moins 10 caractères"
2026-02-20T22:09:11.8292863Z +            )
2026-02-20T22:09:11.8323189Z +        return v
2026-02-20T22:09:11.8323341Z +
2026-02-20T22:09:11.8323471Z  
2026-02-20T22:09:11.8323694Z  class LogicChallengeInDB(LogicChallengeBase):
2026-02-20T22:09:11.8324076Z      """Schéma pour un défi logique en base de données"""
2026-02-20T22:09:11.8324190Z +
2026-02-20T22:09:11.8324304Z      id: int
2026-02-20T22:09:11.8324457Z      creator_id: Optional[int] = None
2026-02-20T22:09:11.8324644Z      visual_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8324799Z      image_url: Optional[str] = None
2026-02-20T22:09:11.8324960Z      source_reference: Optional[str] = None
2026-02-20T22:09:11.8325078Z @@ -116,83 +136,111 @@
2026-02-20T22:09:11.8325217Z      created_at: datetime
2026-02-20T22:09:11.8325345Z      updated_at: datetime
2026-02-20T22:09:11.8325460Z  
2026-02-20T22:09:11.8325664Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8325776Z  
2026-02-20T22:09:11.8325877Z +
2026-02-20T22:09:11.8326055Z  class LogicChallenge(LogicChallengeInDB):
2026-02-20T22:09:11.8326346Z      """Schéma pour un défi logique complet"""
2026-02-20T22:09:11.8326549Z -    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8326652Z +
2026-02-20T22:09:11.8326846Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8326958Z +
2026-02-20T22:09:11.8327060Z  
2026-02-20T22:09:11.8327321Z  # Schémas pour les tentatives de résolution
2026-02-20T22:09:11.8327432Z +
2026-02-20T22:09:11.8327535Z  
2026-02-20T22:09:11.8327725Z  class LogicChallengeAttemptBase(BaseModel):
2026-02-20T22:09:11.8328170Z      """Schéma de base pour les tentatives de résolution de défis logiques"""
2026-02-20T22:09:11.8328274Z +
2026-02-20T22:09:11.8328669Z      challenge_id: int = Field(..., description="ID du défi logique")
2026-02-20T22:09:11.8329177Z      user_solution: str = Field(..., description="Réponse fournie par l'utilisateur")
2026-02-20T22:09:11.8329391Z -    time_spent: Optional[float] = Field(None, ge=0.0,
2026-02-20T22:09:11.8329735Z -                                     description="Temps passé en secondes")
2026-02-20T22:09:11.8330381Z -    hints_used: Optional[List[int]] = Field(None, description="Liste des indices utilisés (ex: [1, 2])")
2026-02-20T22:09:11.8330783Z -    notes: Optional[str] = Field(None, description="Notes personnelles de l'utilisateur")
2026-02-20T22:09:11.8330888Z -
2026-02-20T22:09:11.8331042Z -    @field_validator('user_solution')
2026-02-20T22:09:11.8331207Z +    time_spent: Optional[float] = Field(
2026-02-20T22:09:11.8331536Z +        None, ge=0.0, description="Temps passé en secondes"
2026-02-20T22:09:11.8331644Z +    )
2026-02-20T22:09:11.8331813Z +    hints_used: Optional[List[int]] = Field(
2026-02-20T22:09:11.8332192Z +        None, description="Liste des indices utilisés (ex: [1, 2])"
2026-02-20T22:09:11.8332529Z +    )
2026-02-20T22:09:11.8332676Z +    notes: Optional[str] = Field(
2026-02-20T22:09:11.8332940Z +        None, description="Notes personnelles de l'utilisateur"
2026-02-20T22:09:11.8333216Z +    )
2026-02-20T22:09:11.8333323Z +
2026-02-20T22:09:11.8333651Z +    @field_validator("user_solution")
2026-02-20T22:09:11.8333786Z      @classmethod
2026-02-20T22:09:11.8333935Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8334073Z          if not v or v.isspace():
2026-02-20T22:09:11.8334453Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.8334566Z          return v
2026-02-20T22:09:11.8334670Z  
2026-02-20T22:09:11.8334772Z +
2026-02-20T22:09:11.8335080Z  class LogicChallengeAttemptCreate(LogicChallengeAttemptBase):
2026-02-20T22:09:11.8335536Z      """Schéma pour la création d'une tentative de résolution de défi logique"""
2026-02-20T22:09:11.8335649Z +
2026-02-20T22:09:11.8335773Z      pass
2026-02-20T22:09:11.8335875Z +
2026-02-20T22:09:11.8335995Z  
2026-02-20T22:09:11.8336214Z  class LogicChallengeAttemptUpdate(BaseModel):
2026-02-20T22:09:11.8336590Z      """Schéma pour la mise à jour d'une tentative de résolution"""
2026-02-20T22:09:11.8336695Z +
2026-02-20T22:09:11.8336852Z      user_solution: Optional[str] = None
2026-02-20T22:09:11.8337030Z      is_correct: Optional[bool] = None
2026-02-20T22:09:11.8337234Z      time_spent: Optional[float] = Field(None, ge=0.0)
2026-02-20T22:09:11.8337394Z      hints_used: Optional[List[int]] = None
2026-02-20T22:09:11.8337550Z      notes: Optional[str] = None
2026-02-20T22:09:11.8337655Z  
2026-02-20T22:09:11.8337806Z -    @field_validator('user_solution')
2026-02-20T22:09:11.8337952Z +    @field_validator("user_solution")
2026-02-20T22:09:11.8338074Z      @classmethod
2026-02-20T22:09:11.8338215Z      def answer_not_empty(cls, v):
2026-02-20T22:09:11.8338403Z          if v is not None and (not v or v.isspace()):
2026-02-20T22:09:11.8338759Z              raise ValueError("La réponse ne peut pas être vide")
2026-02-20T22:09:11.8338887Z          return v
2026-02-20T22:09:11.8338988Z  
2026-02-20T22:09:11.8339090Z +
2026-02-20T22:09:11.8339386Z  class LogicChallengeAttemptInDB(LogicChallengeAttemptBase):
2026-02-20T22:09:11.8339772Z      """Schéma pour une tentative de résolution en base de données"""
2026-02-20T22:09:11.8339888Z +
2026-02-20T22:09:11.8340008Z      id: int
2026-02-20T22:09:11.8340123Z      user_id: int
2026-02-20T22:09:11.8340248Z      is_correct: bool
2026-02-20T22:09:11.8340384Z      attempt_number: int
2026-02-20T22:09:11.8340513Z      created_at: datetime
2026-02-20T22:09:11.8340616Z  
2026-02-20T22:09:11.8340816Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8340927Z  
2026-02-20T22:09:11.8341028Z +
2026-02-20T22:09:11.8341284Z  class LogicChallengeAttempt(LogicChallengeAttemptInDB):
2026-02-20T22:09:11.8341613Z      """Schéma pour une tentative de résolution complète"""
2026-02-20T22:09:11.8341715Z +
2026-02-20T22:09:11.8341873Z      challenge_title: Optional[str] = None
2026-02-20T22:09:11.8342109Z      challenge_type: Optional[LogicChallengeType] = None
2026-02-20T22:09:11.8342272Z      age_group: Optional[AgeGroup] = None
2026-02-20T22:09:11.8342376Z  
2026-02-20T22:09:11.8342575Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8342698Z  
2026-02-20T22:09:11.8342803Z +
2026-02-20T22:09:11.8343214Z  class LogicChallengeStats(BaseModel):
2026-02-20T22:09:11.8343478Z      """Statistiques sur un défi logique"""
2026-02-20T22:09:11.8343592Z +
2026-02-20T22:09:11.8343720Z      challenge_id: int
2026-02-20T22:09:11.8343841Z      view_count: int
2026-02-20T22:09:11.8343980Z      attempt_count: int
2026-02-20T22:09:11.8344108Z      success_rate: float
2026-02-20T22:09:11.8344260Z      average_time: Optional[float] = None
2026-02-20T22:09:11.8344721Z -    hint_usage_rate: Optional[Dict[str, float]] = None  # Taux d'utilisation de chaque niveau d'indice
2026-02-20T22:09:11.8344833Z -
2026-02-20T22:09:11.8345030Z -    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8345467Z +    hint_usage_rate: Optional[Dict[str, float]] = (
2026-02-20T22:09:11.8345705Z +        None  # Taux d'utilisation de chaque niveau d'indice
2026-02-20T22:09:11.8345811Z +    )
2026-02-20T22:09:11.8345914Z +
2026-02-20T22:09:11.8346274Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8346384Z +
2026-02-20T22:09:11.8346490Z  
2026-02-20T22:09:11.8346693Z  class LogicChallengeAttemptResult(BaseModel):
2026-02-20T22:09:11.8347093Z      """Résultat d'une tentative de résolution d'un défi logique"""
2026-02-20T22:09:11.8347196Z +
2026-02-20T22:09:11.8347618Z      is_correct: bool = Field(..., description="Si la réponse est correcte")
2026-02-20T22:09:11.8347906Z      feedback: str = Field(..., description="Retour sur la tentative")
2026-02-20T22:09:11.8348381Z -    explanation: Optional[str] = Field(None, description="Explication de la solution (si correct)")
2026-02-20T22:09:11.8348795Z -    hints: Optional[List[str]] = Field(None, description="Indices pour aider (si incorrect)")
2026-02-20T22:09:11.8348927Z -
2026-02-20T22:09:11.8349132Z -    model_config = ConfigDict(from_attributes=True) 
2026-02-20T22:09:11.8349270Z \ No newline at end of file
2026-02-20T22:09:11.8349427Z +    explanation: Optional[str] = Field(
2026-02-20T22:09:11.8349718Z +        None, description="Explication de la solution (si correct)"
2026-02-20T22:09:11.8349825Z +    )
2026-02-20T22:09:11.8349976Z +    hints: Optional[List[str]] = Field(
2026-02-20T22:09:11.8350218Z +        None, description="Indices pour aider (si incorrect)"
2026-02-20T22:09:11.8350324Z +    )
2026-02-20T22:09:11.8350425Z +
2026-02-20T22:09:11.8350624Z +    model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8351059Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/user_session.py
2026-02-20T22:09:11.8351561Z --- /home/runner/work/mathakine/mathakine/app/schemas/user_session.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.8352051Z +++ /home/runner/work/mathakine/mathakine/app/schemas/user_session.py	2026-02-20 22:09:11.825999+00:00
2026-02-20T22:09:11.8352182Z @@ -1,24 +1,27 @@
2026-02-20T22:09:11.8352286Z  """
2026-02-20T22:09:11.8352570Z  Schémas Pydantic pour les sessions utilisateur
2026-02-20T22:09:11.8352694Z  """
2026-02-20T22:09:11.8352797Z +
2026-02-20T22:09:11.8383128Z  from datetime import datetime
2026-02-20T22:09:11.8383337Z  from typing import Any, Dict, Optional
2026-02-20T22:09:11.8383443Z  
2026-02-20T22:09:11.8383616Z  from pydantic import BaseModel, ConfigDict
2026-02-20T22:09:11.8383720Z  
2026-02-20T22:09:11.8383839Z  
2026-02-20T22:09:11.8383994Z  class UserSessionBase(BaseModel):
2026-02-20T22:09:11.8384323Z      """Schéma de base pour une session utilisateur"""
2026-02-20T22:09:11.8384437Z +
2026-02-20T22:09:11.8384623Z      device_info: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8384774Z      ip_address: Optional[str] = None
2026-02-20T22:09:11.8384919Z      user_agent: Optional[str] = None
2026-02-20T22:09:11.8385132Z      location_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8385238Z  
2026-02-20T22:09:11.8385344Z  
2026-02-20T22:09:11.8385525Z  class UserSessionInDB(UserSessionBase):
2026-02-20T22:09:11.8385954Z      """Schéma pour une session en base de données (avec tous les champs)"""
2026-02-20T22:09:11.8386145Z +
2026-02-20T22:09:11.8386261Z      id: int
2026-02-20T22:09:11.8386386Z      user_id: int
2026-02-20T22:09:11.8386517Z      session_token: str
2026-02-20T22:09:11.8386637Z      is_active: bool
2026-02-20T22:09:11.8386787Z      last_activity: datetime
2026-02-20T22:09:11.8386901Z @@ -28,10 +31,11 @@
2026-02-20T22:09:11.8387098Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8387203Z  
2026-02-20T22:09:11.8387314Z  
2026-02-20T22:09:11.8387458Z  class UserSession(BaseModel):
2026-02-20T22:09:11.8387793Z      """Schéma pour une session utilisateur (réponse API)"""
2026-02-20T22:09:11.8387908Z +
2026-02-20T22:09:11.8388014Z      id: int
2026-02-20T22:09:11.8388457Z      device_info: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8388618Z      ip_address: Optional[str] = None
2026-02-20T22:09:11.8388764Z      user_agent: Optional[str] = None
2026-02-20T22:09:11.8388954Z      location_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:11.8389066Z @@ -44,7 +48,8 @@
2026-02-20T22:09:11.8389437Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.8389547Z  
2026-02-20T22:09:11.8389651Z  
2026-02-20T22:09:11.8389817Z  class UserSessionRevoke(BaseModel):
2026-02-20T22:09:11.8390100Z      """Schéma pour la révocation d'une session"""
2026-02-20T22:09:11.8390203Z +
2026-02-20T22:09:11.8390319Z      success: bool
2026-02-20T22:09:11.8390442Z      message: str
2026-02-20T22:09:11.9422064Z --- /home/runner/work/mathakine/mathakine/app/schemas/user.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:11.9422546Z +++ /home/runner/work/mathakine/mathakine/app/schemas/user.py	2026-02-20 22:09:11.939488+00:00
2026-02-20T22:09:11.9422675Z @@ -8,55 +8,81 @@
2026-02-20T22:09:11.9422875Z  from app.models.user import UserRole
2026-02-20T22:09:11.9423148Z  
2026-02-20T22:09:11.9423659Z  # Schémas pour la manipulation des utilisateurs
2026-02-20T22:09:11.9423771Z  
2026-02-20T22:09:11.9423873Z  
2026-02-20T22:09:11.9423985Z -
2026-02-20T22:09:11.9424145Z  class UserBase(BaseModel):
2026-02-20T22:09:11.9424569Z      """Schéma de base pour les utilisateurs (Les bases d'un Padawan)"""
2026-02-20T22:09:11.9424784Z -    username: str = Field(..., min_length=3, max_length=50,
2026-02-20T22:09:11.9425182Z -                        description="Nom d'utilisateur unique (3-50 caractères)")
2026-02-20T22:09:11.9425285Z +
2026-02-20T22:09:11.9425411Z +    username: str = Field(
2026-02-20T22:09:11.9425519Z +        ...,
2026-02-20T22:09:11.9425627Z +        min_length=3,
2026-02-20T22:09:11.9425732Z +        max_length=50,
2026-02-20T22:09:11.9426097Z +        description="Nom d'utilisateur unique (3-50 caractères)",
2026-02-20T22:09:11.9426208Z +    )
2026-02-20T22:09:11.9426513Z      email: EmailStr = Field(..., description="Adresse email valide")
2026-02-20T22:09:11.9426815Z -    full_name: Optional[str] = Field(None, min_length=2, max_length=100,
2026-02-20T22:09:11.9427042Z -                                  description="Nom complet de l'utilisateur")
2026-02-20T22:09:11.9427253Z -    role: Optional[UserRole] = Field(default="PADAWAN",
2026-02-20T22:09:11.9427674Z -                                  description="Rôle dans l'Ordre Jedi des Mathématiques")
2026-02-20T22:09:11.9427891Z -    grade_level: Optional[int] = Field(None, ge=1, le=12,
2026-02-20T22:09:11.9428088Z -                                    description="Niveau scolaire (1-12)")
2026-02-20T22:09:11.9428255Z -    learning_style: Optional[str] = Field(None,
2026-02-20T22:09:11.9428607Z -                                      description="Style d'apprentissage préféré")
2026-02-20T22:09:11.9428800Z -    preferred_difficulty: Optional[str] = Field(None,
2026-02-20T22:09:11.9429134Z -                                           description="Difficulté préférée")
2026-02-20T22:09:11.9429355Z -    preferred_theme: Optional[str] = Field("spatial",
2026-02-20T22:09:11.9429955Z -                                      description="Thème préféré: spatial, minimalist, ocean, dune, forest, peach")
2026-02-20T22:09:11.9430271Z -    accessibility_settings: Optional[Dict[str, Any]] = Field(None,
2026-02-20T22:09:11.9430804Z -                                                        description="Paramètres d'accessibilité personnalisés")
2026-02-20T22:09:11.9430923Z -
2026-02-20T22:09:11.9431073Z -    @field_validator('username')
2026-02-20T22:09:11.9431228Z +    full_name: Optional[str] = Field(
2026-02-20T22:09:11.9431589Z +        None, min_length=2, max_length=100, description="Nom complet de l'utilisateur"
2026-02-20T22:09:11.9431697Z +    )
2026-02-20T22:09:11.9431845Z +    role: Optional[UserRole] = Field(
2026-02-20T22:09:11.9432338Z +        default="PADAWAN", description="Rôle dans l'Ordre Jedi des Mathématiques"
2026-02-20T22:09:11.9432879Z +    )
2026-02-20T22:09:11.9433248Z +    grade_level: Optional[int] = Field(
2026-02-20T22:09:11.9433490Z +        None, ge=1, le=12, description="Niveau scolaire (1-12)"
2026-02-20T22:09:11.9433607Z +    )
2026-02-20T22:09:11.9433772Z +    learning_style: Optional[str] = Field(
2026-02-20T22:09:11.9434362Z +        None, description="Style d'apprentissage préféré"
2026-02-20T22:09:11.9434831Z would reformat /home/runner/work/mathakine/mathakine/app/schemas/user.py
2026-02-20T22:09:11.9434944Z +    )
2026-02-20T22:09:11.9435526Z +    preferred_difficulty: Optional[str] = Field(None, description="Difficulté préférée")
2026-02-20T22:09:11.9435701Z +    preferred_theme: Optional[str] = Field(
2026-02-20T22:09:11.9435832Z +        "spatial",
2026-02-20T22:09:11.9436324Z +        description="Thème préféré: spatial, minimalist, ocean, dune, forest, peach",
2026-02-20T22:09:11.9436437Z +    )
2026-02-20T22:09:11.9436707Z +    accessibility_settings: Optional[Dict[str, Any]] = Field(
2026-02-20T22:09:11.9437124Z +        None, description="Paramètres d'accessibilité personnalisés"
2026-02-20T22:09:11.9437232Z +    )
2026-02-20T22:09:11.9437345Z +
2026-02-20T22:09:11.9437492Z +    @field_validator("username")
2026-02-20T22:09:11.9437608Z      @classmethod
2026-02-20T22:09:11.9437758Z      def username_alphanumeric(cls, v):
2026-02-20T22:09:11.9438003Z -        if not v.replace('_', '').replace('-', '').isalnum():
2026-02-20T22:09:11.9438562Z -            raise ValueError("Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores")
2026-02-20T22:09:11.9438678Z -        return v
2026-02-20T22:09:11.9438799Z -
2026-02-20T22:09:11.9438956Z -    @field_validator('preferred_theme')
2026-02-20T22:09:11.9439165Z +        if not v.replace("_", "").replace("-", "").isalnum():
2026-02-20T22:09:11.9439300Z +            raise ValueError(
2026-02-20T22:09:11.9439738Z +                "Le nom d'utilisateur ne peut contenir que des lettres, chiffres, tirets et underscores"
2026-02-20T22:09:11.9439857Z +            )
2026-02-20T22:09:11.9439967Z +        return v
2026-02-20T22:09:11.9440076Z +
2026-02-20T22:09:11.9440229Z +    @field_validator("preferred_theme")
2026-02-20T22:09:11.9440345Z      @classmethod
2026-02-20T22:09:11.9440480Z      def theme_valid(cls, v):
2026-02-20T22:09:11.9441429Z          # Accepter les thèmes UI (light/dark) et les thèmes visuels (spatial, minimalist, ocean, dune, forest, peach, dino; neutral pour rétrocompat)
2026-02-20T22:09:11.9441963Z -        valid_themes = ['light', 'dark', 'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral']
2026-02-20T22:09:11.9442102Z +        valid_themes = [
2026-02-20T22:09:11.9442215Z +            "light",
2026-02-20T22:09:11.9442327Z +            "dark",
2026-02-20T22:09:11.9442445Z +            "spatial",
2026-02-20T22:09:11.9442580Z +            "minimalist",
2026-02-20T22:09:11.9442690Z +            "ocean",
2026-02-20T22:09:11.9442797Z +            "dune",
2026-02-20T22:09:11.9442916Z +            "forest",
2026-02-20T22:09:11.9443223Z +            "peach",
2026-02-20T22:09:11.9443340Z +            "dino",
2026-02-20T22:09:11.9443457Z +            "neutral",
2026-02-20T22:09:11.9443574Z +        ]
2026-02-20T22:09:11.9443768Z          if v is not None and v not in valid_themes:
2026-02-20T22:09:11.9444347Z -            raise ValueError(f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}")
2026-02-20T22:09:11.9444471Z -        return v
2026-02-20T22:09:11.9444576Z -
2026-02-20T22:09:11.9444707Z +            raise ValueError(
2026-02-20T22:09:11.9445135Z +                f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}"
2026-02-20T22:09:11.9445250Z +            )
2026-02-20T22:09:11.9445357Z +        return v
2026-02-20T22:09:11.9445457Z  
2026-02-20T22:09:11.9445566Z  
2026-02-20T22:09:11.9445705Z  class UserCreate(UserBase):
2026-02-20T22:09:11.9446140Z      """Schéma pour la création d'un utilisateur (Recrutement d'un Padawan)"""
2026-02-20T22:09:11.9446317Z -    password: str = Field(..., min_length=8, 
2026-02-20T22:09:11.9446963Z -                        description="Mot de passe (8 caractères minimum)")
2026-02-20T22:09:11.9447069Z -    
2026-02-20T22:09:11.9447220Z -    @field_validator('password')
2026-02-20T22:09:11.9447330Z +
2026-02-20T22:09:11.9447466Z +    password: str = Field(
2026-02-20T22:09:11.9448087Z +        ..., min_length=8, description="Mot de passe (8 caractères minimum)"
2026-02-20T22:09:11.9448211Z +    )
2026-02-20T22:09:11.9448317Z +
2026-02-20T22:09:11.9448466Z +    @field_validator("password")
2026-02-20T22:09:11.9448584Z      @classmethod
2026-02-20T22:09:11.9448744Z      def password_strength(cls, v):
2026-02-20T22:09:11.9449105Z          """Vérifie que le mot de passe est suffisamment fort"""
2026-02-20T22:09:11.9449226Z          if len(v) < 8:
2026-02-20T22:09:11.9449681Z              raise ValueError("Le mot de passe doit faire au moins 8 caractères")
2026-02-20T22:09:11.9449792Z @@ -65,41 +91,72 @@
2026-02-20T22:09:11.9449970Z          if not any(char.isupper() for char in v):
2026-02-20T22:09:11.9450313Z              raise ValueError("Le mot de passe doit contenir au moins une majuscule")
2026-02-20T22:09:11.9450434Z          return v
2026-02-20T22:09:11.9450536Z  
2026-02-20T22:09:11.9450637Z  
2026-02-20T22:09:11.9450744Z -
2026-02-20T22:09:11.9450908Z  class UserUpdate(BaseModel):
2026-02-20T22:09:11.9451217Z      """Schéma pour la mise à jour d'un utilisateur"""
2026-02-20T22:09:11.9451322Z +
2026-02-20T22:09:11.9451477Z      email: Optional[EmailStr] = None
2026-02-20T22:09:11.9451622Z      full_name: Optional[str] = None
2026-02-20T22:09:11.9451767Z      password: Optional[str] = None
2026-02-20T22:09:11.9451924Z      is_active: Optional[bool] = None
2026-02-20T22:09:11.9452059Z      grade_level: Optional[int] = None
2026-02-20T22:09:11.9452210Z      learning_style: Optional[str] = None
2026-02-20T22:09:11.9452401Z      preferred_difficulty: Optional[str] = None
2026-02-20T22:09:11.9454981Z -    preferred_theme: Optional[str] = Field(None, description="Thème préféré (spatial, minimalist, ocean, dune, forest, peach, dino)")
2026-02-20T22:09:11.9455734Z -    accessibility_settings: Optional[Dict[str, bool]] = Field(None, description="Paramètres d'accessibilité")
2026-02-20T22:09:11.9455920Z +    preferred_theme: Optional[str] = Field(
2026-02-20T22:09:11.9456045Z +        None,
2026-02-20T22:09:11.9456601Z +        description="Thème préféré (spatial, minimalist, ocean, dune, forest, peach, dino)",
2026-02-20T22:09:11.9456712Z +    )
2026-02-20T22:09:11.9456983Z +    accessibility_settings: Optional[Dict[str, bool]] = Field(
2026-02-20T22:09:11.9457292Z +        None, description="Paramètres d'accessibilité"
2026-02-20T22:09:11.9457402Z +    )
2026-02-20T22:09:11.9457614Z      # Paramètres Settings
2026-02-20T22:09:11.9458686Z -    notification_preferences: Optional[Dict[str, bool]] = Field(None, description="Préférences de notifications (achievements, progress, recommendations, news)")
2026-02-20T22:09:11.9459259Z -    language_preference: Optional[str] = Field(None, description="Langue préférée (fr, en)")
2026-02-20T22:09:11.9459561Z +    notification_preferences: Optional[Dict[str, bool]] = Field(
2026-02-20T22:09:11.9459674Z +        None,
2026-02-20T22:09:11.9460307Z +        description="Préférences de notifications (achievements, progress, recommendations, news)",
2026-02-20T22:09:11.9460431Z +    )
2026-02-20T22:09:11.9460628Z +    language_preference: Optional[str] = Field(
2026-02-20T22:09:11.9460923Z +        None, description="Langue préférée (fr, en)"
2026-02-20T22:09:11.9461032Z +    )
2026-02-20T22:09:11.9461353Z      timezone: Optional[str] = Field(None, description="Fuseau horaire")
2026-02-20T22:09:11.9461715Z      is_public_profile: Optional[bool] = Field(None, description="Profil public")
2026-02-20T22:09:11.9462181Z -    allow_friend_requests: Optional[bool] = Field(None, description="Autoriser les demandes d'amis")
2026-02-20T22:09:11.9462650Z -    show_in_leaderboards: Optional[bool] = Field(None, description="Afficher dans les classements")
2026-02-20T22:09:11.9463761Z -    data_retention_consent: Optional[bool] = Field(None, description="Consentement conservation données")
2026-02-20T22:09:11.9464181Z -    marketing_consent: Optional[bool] = Field(None, description="Consentement marketing")
2026-02-20T22:09:11.9464298Z -    
2026-02-20T22:09:11.9464686Z +    allow_friend_requests: Optional[bool] = Field(
2026-02-20T22:09:11.9464911Z +        None, description="Autoriser les demandes d'amis"
2026-02-20T22:09:11.9465018Z +    )
2026-02-20T22:09:11.9465222Z +    show_in_leaderboards: Optional[bool] = Field(
2026-02-20T22:09:11.9465431Z +        None, description="Afficher dans les classements"
2026-02-20T22:09:11.9465538Z +    )
2026-02-20T22:09:11.9465737Z +    data_retention_consent: Optional[bool] = Field(
2026-02-20T22:09:11.9466104Z +        None, description="Consentement conservation données"
2026-02-20T22:09:11.9466212Z +    )
2026-02-20T22:09:11.9466380Z +    marketing_consent: Optional[bool] = Field(
2026-02-20T22:09:11.9466582Z +        None, description="Consentement marketing"
2026-02-20T22:09:11.9466685Z +    )
2026-02-20T22:09:11.9466787Z +
2026-02-20T22:09:11.9466948Z      @field_validator("preferred_theme")
2026-02-20T22:09:11.9467063Z      @classmethod
2026-02-20T22:09:11.9467205Z      def validate_theme(cls, v):
2026-02-20T22:09:11.9468185Z          # Accepter les thèmes UI (light/dark) et les thèmes visuels (spatial, minimalist, ocean, dune, forest, peach, dino; neutral pour rétrocompat)
2026-02-20T22:09:11.9468729Z -        valid_themes = ['light', 'dark', 'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral']
2026-02-20T22:09:11.9468862Z +        valid_themes = [
2026-02-20T22:09:11.9468975Z +            "light",
2026-02-20T22:09:11.9469090Z +            "dark",
2026-02-20T22:09:11.9469206Z +            "spatial",
2026-02-20T22:09:11.9469330Z +            "minimalist",
2026-02-20T22:09:11.9469448Z +            "ocean",
2026-02-20T22:09:11.9469553Z +            "dune",
2026-02-20T22:09:11.9469678Z +            "forest",
2026-02-20T22:09:11.9469791Z +            "peach",
2026-02-20T22:09:11.9469908Z +            "dino",
2026-02-20T22:09:11.9470019Z +            "neutral",
2026-02-20T22:09:11.9470124Z +        ]
2026-02-20T22:09:11.9470318Z          if v is not None and v not in valid_themes:
2026-02-20T22:09:11.9470895Z -            raise ValueError(f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}")
2026-02-20T22:09:11.9471003Z -        return v
2026-02-20T22:09:11.9471110Z -    
2026-02-20T22:09:11.9471235Z +            raise ValueError(
2026-02-20T22:09:11.9471640Z +                f"Le thème doit être l'un des suivants: {', '.join(valid_themes)}"
2026-02-20T22:09:11.9471748Z +            )
2026-02-20T22:09:11.9471867Z +        return v
2026-02-20T22:09:11.9471971Z +
2026-02-20T22:09:11.9472093Z      model_config = {
2026-02-20T22:09:11.9472242Z          "json_schema_extra": {
2026-02-20T22:09:11.9472361Z              "example": {
2026-02-20T22:09:11.9472505Z                  "email": "luke@jedi.com",
2026-02-20T22:09:11.9472673Z                  "full_name": "Luke Skywalker",
2026-02-20T22:09:11.9472796Z @@ -107,47 +164,44 @@
2026-02-20T22:09:11.9472925Z                  "is_active": True,
2026-02-20T22:09:11.9473240Z                  "grade_level": 5,
2026-02-20T22:09:11.9473411Z                  "learning_style": "visuel",
2026-02-20T22:09:11.9473594Z                  "preferred_difficulty": "chevalier",
2026-02-20T22:09:11.9473752Z                  "preferred_theme": "spatial",
2026-02-20T22:09:11.9474104Z -                "accessibility_settings": {"high_contrast": True, "large_text": False}
2026-02-20T22:09:11.9474450Z +                "accessibility_settings": {"high_contrast": True, "large_text": False},
2026-02-20T22:09:11.9474559Z              }
2026-02-20T22:09:11.9474667Z          },
2026-02-20T22:09:11.9474803Z -        "json_encoders": {
2026-02-20T22:09:11.9474953Z -            dict: lambda v: json.dumps(v)
2026-02-20T22:09:11.9475060Z -        }
2026-02-20T22:09:11.9475508Z +        "json_encoders": {dict: lambda v: json.dumps(v)},
2026-02-20T22:09:11.9475611Z      }
2026-02-20T22:09:11.9475710Z -
2026-02-20T22:09:11.9475815Z  
2026-02-20T22:09:11.9475924Z  
2026-02-20T22:09:11.9476055Z  class User(UserBase):
2026-02-20T22:09:11.9476599Z      """Schéma pour un utilisateur (Membre de l'Ordre Jedi)"""
2026-02-20T22:09:11.9476724Z +
2026-02-20T22:09:11.9476839Z      id: int
2026-02-20T22:09:11.9476955Z      is_active: bool
2026-02-20T22:09:11.9477079Z      created_at: datetime
2026-02-20T22:09:11.9477216Z      updated_at: datetime
2026-02-20T22:09:11.9477320Z  
2026-02-20T22:09:11.9477525Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.9477641Z  
2026-02-20T22:09:11.9477742Z  
2026-02-20T22:09:11.9477847Z -
2026-02-20T22:09:11.9477985Z  class UserInDB(UserBase):
2026-02-20T22:09:11.9478410Z      """Schéma pour un utilisateur en base de données (Archives Jedi)"""
2026-02-20T22:09:11.9478515Z +
2026-02-20T22:09:11.9478624Z      id: int
2026-02-20T22:09:11.9478768Z      is_active: bool
2026-02-20T22:09:11.9478898Z      created_at: datetime
2026-02-20T22:09:11.9479025Z      updated_at: datetime
2026-02-20T22:09:11.9479128Z  
2026-02-20T22:09:11.9479328Z      model_config = ConfigDict(from_attributes=True)
2026-02-20T22:09:11.9479431Z  
2026-02-20T22:09:11.9479532Z  
2026-02-20T22:09:11.9479657Z -
2026-02-20T22:09:11.9479799Z  class UserLogin(BaseModel):
2026-02-20T22:09:11.9480182Z      """Schéma pour l'authentification (Vérification d'identité)"""
2026-02-20T22:09:11.9480290Z +
2026-02-20T22:09:11.9480416Z      username: str
2026-02-20T22:09:11.9480533Z      password: str
2026-02-20T22:09:11.9480635Z -
2026-02-20T22:09:11.9480747Z  
2026-02-20T22:09:11.9480849Z  
2026-02-20T22:09:11.9480998Z  class SchemaUserRole(str, Enum):
2026-02-20T22:09:11.9481131Z      PADAWAN = "padawan"
2026-02-20T22:09:11.9481273Z      CHEVALIER = "chevalier"
2026-02-20T22:09:11.9481388Z @@ -158,36 +212,46 @@
2026-02-20T22:09:11.9481514Z      access_token: str
2026-02-20T22:09:11.9481657Z      refresh_token: str
2026-02-20T22:09:11.9481791Z      token_type: str = "bearer"
2026-02-20T22:09:11.9481935Z      user_id: Optional[int] = None
2026-02-20T22:09:11.9482034Z  
2026-02-20T22:09:11.9482143Z +
2026-02-20T22:09:11.9482310Z  class RefreshTokenResponse(BaseModel):
2026-02-20T22:09:11.9482679Z      """Schéma pour la réponse de rafraîchissement de token"""
2026-02-20T22:09:11.9482793Z +
2026-02-20T22:09:11.9482917Z      access_token: str
2026-02-20T22:09:11.9483268Z      token_type: str = "bearer"
2026-02-20T22:09:11.9483381Z +
2026-02-20T22:09:11.9483497Z  
2026-02-20T22:09:11.9483630Z  class TokenData(BaseModel):
2026-02-20T22:09:11.9483732Z      username: str
2026-02-20T22:09:11.9483872Z      role: Optional[str] = None
2026-02-20T22:09:11.9484013Z      exp: Optional[int] = None
2026-02-20T22:09:11.9484114Z +
2026-02-20T22:09:11.9484224Z  
2026-02-20T22:09:11.9484385Z  class TokenPayload(BaseModel):
2026-02-20T22:09:11.9484496Z      sub: str
2026-02-20T22:09:11.9484608Z      exp: int
2026-02-20T22:09:11.9484780Z      type: str  # "access" ou "refresh"
2026-02-20T22:09:11.9484920Z      role: Optional[str] = None
2026-02-20T22:09:11.9485026Z  
2026-02-20T22:09:11.9485135Z +
2026-02-20T22:09:11.9485316Z  class RefreshTokenRequest(BaseModel):
2026-02-20T22:09:11.9485730Z      """Schéma pour la requête de rafraîchissement de token"""
2026-02-20T22:09:11.9485842Z +
2026-02-20T22:09:11.9486384Z      refresh_token: str = Field(..., description="Token de rafraîchissement à utiliser")
2026-02-20T22:09:11.9486498Z +
2026-02-20T22:09:11.9486600Z  
2026-02-20T22:09:11.9486769Z  class UserPasswordUpdate(BaseModel):
2026-02-20T22:09:11.9487175Z      """Schéma pour la mise à jour du mot de passe d'un utilisateur"""
2026-02-20T22:09:11.9487279Z +
2026-02-20T22:09:11.9487581Z      current_password: str = Field(..., description="Mot de passe actuel")
2026-02-20T22:09:11.9488206Z -    new_password: str = Field(..., min_length=8, description="Nouveau mot de passe (8 caractères minimum)")
2026-02-20T22:09:11.9488615Z -    
2026-02-20T22:09:11.9488777Z -    @field_validator('new_password')
2026-02-20T22:09:11.9488932Z +    new_password: str = Field(
2026-02-20T22:09:11.9489444Z +        ..., min_length=8, description="Nouveau mot de passe (8 caractères minimum)"
2026-02-20T22:09:11.9489558Z +    )
2026-02-20T22:09:11.9489656Z +
2026-02-20T22:09:11.9490013Z +    @field_validator("new_password")
2026-02-20T22:09:11.9490145Z      @classmethod
2026-02-20T22:09:11.9490305Z      def password_strength(cls, v):
2026-02-20T22:09:11.9490672Z          """Vérifie que le mot de passe est suffisamment fort"""
2026-02-20T22:09:11.9490793Z          if len(v) < 8:
2026-02-20T22:09:11.9491244Z              raise ValueError("Le mot de passe doit faire au moins 8 caractères")
2026-02-20T22:09:11.9491365Z @@ -195,13 +259,17 @@
2026-02-20T22:09:11.9491689Z              raise ValueError("Le mot de passe doit contenir au moins un chiffre")
2026-02-20T22:09:11.9491864Z          if not any(char.isupper() for char in v):
2026-02-20T22:09:11.9492215Z              raise ValueError("Le mot de passe doit contenir au moins une majuscule")
2026-02-20T22:09:11.9492340Z          return v
2026-02-20T22:09:11.9492446Z  
2026-02-20T22:09:11.9492549Z +
2026-02-20T22:09:11.9492727Z  class ForgotPasswordRequest(BaseModel):
2026-02-20T22:09:11.9493319Z      """Schéma pour la demande de réinitialisation de mot de passe"""
2026-02-20T22:09:11.9493431Z +
2026-02-20T22:09:11.9493913Z      email: EmailStr = Field(..., description="Adresse email associée au compte")
2026-02-20T22:09:11.9494026Z +
2026-02-20T22:09:11.9494131Z  
2026-02-20T22:09:11.9494311Z  class ForgotPasswordResponse(BaseModel):
2026-02-20T22:09:11.9494687Z      """Schéma pour la réponse de demande de réinitialisation"""
2026-02-20T22:09:11.9494794Z +
2026-02-20T22:09:11.9495080Z      message: str = Field(..., description="Message de confirmation")
2026-02-20T22:09:11.9495349Z      success: bool = Field(..., description="Statut de la demande")
2026-02-20T22:09:12.1599904Z --- /home/runner/work/mathakine/mathakine/app/services/auth_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.1601127Z +++ /home/runner/work/mathakine/mathakine/app/services/auth_service.py	2026-02-20 22:09:12.154114+00:00
2026-02-20T22:09:12.1601948Z @@ -1,143 +1,161 @@
2026-02-20T22:09:12.1602238Z  """
2026-02-20T22:09:12.1603244Z  Service d'authentification pour gérer les utilisateurs et les connexions
2026-02-20T22:09:12.1603865Z  """
2026-02-20T22:09:12.1604125Z +
2026-02-20T22:09:12.1604476Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:12.1604988Z  from typing import Optional
2026-02-20T22:09:12.1605333Z  
2026-02-20T22:09:12.1620853Z  from fastapi import HTTPException, status
2026-02-20T22:09:12.1621372Z  from jose import JWTError, jwt
2026-02-20T22:09:12.1621804Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.1622215Z  
2026-02-20T22:09:12.1622509Z  from app.core.config import settings
2026-02-20T22:09:12.1623234Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.1623932Z -from app.core.security import (create_access_token, decode_token,
2026-02-20T22:09:12.1624606Z -                               get_password_hash, verify_password)
2026-02-20T22:09:12.1625132Z +from app.core.security import (
2026-02-20T22:09:12.1625550Z +    create_access_token,
2026-02-20T22:09:12.1625924Z +    decode_token,
2026-02-20T22:09:12.1626245Z +    get_password_hash,
2026-02-20T22:09:12.1626595Z +    verify_password,
2026-02-20T22:09:12.1626894Z +)
2026-02-20T22:09:12.1627218Z  from app.models.user import User, UserRole
2026-02-20T22:09:12.1627817Z  from app.schemas.user import TokenData, UserCreate, UserUpdate
2026-02-20T22:09:12.1628562Z  from app.utils.db_helpers import adapt_enum_for_db, get_enum_value
2026-02-20T22:09:12.1629122Z  
2026-02-20T22:09:12.1629408Z  logger = get_logger(__name__)
2026-02-20T22:09:12.1629762Z  
2026-02-20T22:09:12.1630010Z +
2026-02-20T22:09:12.1630469Z  def get_user_by_username(db: Session, username: str) -> Optional[User]:
2026-02-20T22:09:12.1631064Z      """
2026-02-20T22:09:12.1632086Z      Récupère un utilisateur par son nom d'utilisateur.
2026-02-20T22:09:12.1632577Z -    
2026-02-20T22:09:12.1632846Z +
2026-02-20T22:09:12.1633286Z      Args:
2026-02-20T22:09:12.1633733Z          db: Session de base de données
2026-02-20T22:09:12.1634602Z          username: Nom d'utilisateur à rechercher
2026-02-20T22:09:12.1635103Z -    
2026-02-20T22:09:12.1635383Z +
2026-02-20T22:09:12.1635647Z      Returns:
2026-02-20T22:09:12.1636068Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1636550Z      """
2026-02-20T22:09:12.1636953Z      user = db.query(User).filter(User.username == username).first()
2026-02-20T22:09:12.1637954Z -    logger.debug(f"Recherche utilisateur {username}: {'trouvé' if user else 'non trouvé'}")
2026-02-20T22:09:12.1638723Z +    logger.debug(
2026-02-20T22:09:12.1639433Z +        f"Recherche utilisateur {username}: {'trouvé' if user else 'non trouvé'}"
2026-02-20T22:09:12.1640089Z +    )
2026-02-20T22:09:12.1640376Z      return user
2026-02-20T22:09:12.1640678Z  
2026-02-20T22:09:12.1640925Z +
2026-02-20T22:09:12.1641348Z  def get_user_by_email(db: Session, email: str) -> Optional[User]:
2026-02-20T22:09:12.1641903Z      """
2026-02-20T22:09:12.1642322Z      Récupère un utilisateur par son email.
2026-02-20T22:09:12.1642760Z -    
2026-02-20T22:09:12.1643219Z +
2026-02-20T22:09:12.1643468Z      Args:
2026-02-20T22:09:12.1643841Z          db: Session de base de données
2026-02-20T22:09:12.1644359Z          email: Email à rechercher
2026-02-20T22:09:12.1644730Z -    
2026-02-20T22:09:12.1644994Z +
2026-02-20T22:09:12.1645241Z      Returns:
2026-02-20T22:09:12.1645654Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1646170Z      """
2026-02-20T22:09:12.1646576Z      return db.query(User).filter(User.email == email).first()
2026-02-20T22:09:12.1647093Z  
2026-02-20T22:09:12.1647327Z +
2026-02-20T22:09:12.1647736Z  def get_user_by_id(db: Session, user_id: int) -> Optional[User]:
2026-02-20T22:09:12.1648287Z      """
2026-02-20T22:09:12.1648693Z      Récupère un utilisateur par son ID.
2026-02-20T22:09:12.1649107Z -    
2026-02-20T22:09:12.1649367Z +
2026-02-20T22:09:12.1649610Z      Args:
2026-02-20T22:09:12.1649996Z          db: Session de base de données
2026-02-20T22:09:12.1650584Z          user_id: ID de l'utilisateur à rechercher
2026-02-20T22:09:12.1651023Z -    
2026-02-20T22:09:12.1651278Z +
2026-02-20T22:09:12.1651520Z      Returns:
2026-02-20T22:09:12.1651928Z          Instance de User ou None si l'utilisateur n'existe pas
2026-02-20T22:09:12.1652437Z      """
2026-02-20T22:09:12.1652828Z      return db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.1683253Z  
2026-02-20T22:09:12.1683582Z +
2026-02-20T22:09:12.1684149Z  def authenticate_user(db: Session, username: str, password: str) -> Optional[User]:
2026-02-20T22:09:12.1684859Z      """
2026-02-20T22:09:12.1685613Z      Authentifie un utilisateur en vérifiant son nom d'utilisateur et mot de passe.
2026-02-20T22:09:12.1686315Z -    
2026-02-20T22:09:12.1686586Z +
2026-02-20T22:09:12.1686838Z      Args:
2026-02-20T22:09:12.1687237Z          db: Session de base de données
2026-02-20T22:09:12.1687681Z          username: Nom d'utilisateur
2026-02-20T22:09:12.1688141Z          password: Mot de passe en clair
2026-02-20T22:09:12.1688543Z -    
2026-02-20T22:09:12.1688792Z +
2026-02-20T22:09:12.1689023Z      Returns:
2026-02-20T22:09:12.1689583Z          Instance de User si l'authentification réussit, None sinon
2026-02-20T22:09:12.1690145Z      """
2026-02-20T22:09:12.1690662Z      logger.debug(f"Tentative d'authentification pour l'utilisateur: {username}")
2026-02-20T22:09:12.1691325Z -    
2026-02-20T22:09:12.1691581Z +
2026-02-20T22:09:12.1691895Z      user = get_user_by_username(db, username)
2026-02-20T22:09:12.1692336Z      if not user:
2026-02-20T22:09:12.1692887Z          logger.warning(f"Utilisateur non trouvé: {username}")
2026-02-20T22:09:12.1693609Z          return None
2026-02-20T22:09:12.1693922Z  
2026-02-20T22:09:12.1694480Z      if not user.is_active:
2026-02-20T22:09:12.1695075Z          logger.warning(f"Compte désactivé: {username}")
2026-02-20T22:09:12.1695578Z          return None
2026-02-20T22:09:12.1695883Z -        
2026-02-20T22:09:12.1696150Z +
2026-02-20T22:09:12.1696790Z      logger.debug(f"Utilisateur trouvé: {username}")
2026-02-20T22:09:12.1697292Z -    
2026-02-20T22:09:12.1697551Z +
2026-02-20T22:09:12.1697803Z      try:
2026-02-20T22:09:12.1698224Z          is_valid = verify_password(password, user.hashed_password)
2026-02-20T22:09:12.1699146Z          logger.debug(f"Résultat de la vérification du mot de passe: {is_valid}")
2026-02-20T22:09:12.1699769Z -        
2026-02-20T22:09:12.1700039Z +
2026-02-20T22:09:12.1700312Z          if not is_valid:
2026-02-20T22:09:12.1700884Z              logger.warning(f"Mot de passe incorrect pour l'utilisateur: {username}")
2026-02-20T22:09:12.1701560Z              return None
2026-02-20T22:09:12.1701894Z -            
2026-02-20T22:09:12.1702164Z +
2026-02-20T22:09:12.1702801Z          logger.info(f"Authentification réussie pour l'utilisateur: {username}")
2026-02-20T22:09:12.1703633Z          return user
2026-02-20T22:09:12.1704045Z      except Exception as password_verification_error:
2026-02-20T22:09:12.1705096Z -        logger.error(f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}")
2026-02-20T22:09:12.1705921Z +        logger.error(
2026-02-20T22:09:12.1706701Z +            f"Erreur lors de la vérification du mot de passe: {str(password_verification_error)}"
2026-02-20T22:09:12.1707415Z +        )
2026-02-20T22:09:12.1707690Z          return None
2026-02-20T22:09:12.1707986Z  
2026-02-20T22:09:12.1708231Z +
2026-02-20T22:09:12.1708616Z  def create_user(db: Session, user_in: UserCreate) -> User:
2026-02-20T22:09:12.1709137Z      """
2026-02-20T22:09:12.1709513Z      Crée un nouvel utilisateur.
2026-02-20T22:09:12.1709890Z -    
2026-02-20T22:09:12.1710137Z +
2026-02-20T22:09:12.1710389Z      Args:
2026-02-20T22:09:12.1710784Z          db: Session de base de données
2026-02-20T22:09:12.1711406Z          user_in: Données pour la création de l'utilisateur
2026-02-20T22:09:12.1711898Z -    
2026-02-20T22:09:12.1712148Z +
2026-02-20T22:09:12.1712405Z      Returns:
2026-02-20T22:09:12.1712819Z          Instance du nouvel utilisateur créé
2026-02-20T22:09:12.1743543Z -    
2026-02-20T22:09:12.1743814Z +
2026-02-20T22:09:12.1744076Z      Raises:
2026-02-20T22:09:12.1744775Z          HTTPException: Si un utilisateur avec le même nom ou email existe déjà
2026-02-20T22:09:12.1745413Z      """
2026-02-20T22:09:12.1745988Z      # Vérifier si un utilisateur avec le même nom ou email existe déjà
2026-02-20T22:09:12.1747088Z      # Message uniforme (anti-énumération) : ne pas révéler si c'est le username ou l'email qui existe
2026-02-20T22:09:12.1747943Z      if get_user_by_username(db, user_in.username):
2026-02-20T22:09:12.1748857Z -        logger.warning(f"Tentative de création avec nom déjà utilisé: {user_in.username}")
2026-02-20T22:09:12.1749611Z +        logger.warning(
2026-02-20T22:09:12.1750289Z +            f"Tentative de création avec nom déjà utilisé: {user_in.username}"
2026-02-20T22:09:12.1750895Z +        )
2026-02-20T22:09:12.1751186Z          raise HTTPException(
2026-02-20T22:09:12.1751631Z              status_code=status.HTTP_409_CONFLICT,
2026-02-20T22:09:12.1752330Z -            detail="Un compte avec ces informations existe déjà"
2026-02-20T22:09:12.1752857Z -        )
2026-02-20T22:09:12.1753308Z -    
2026-02-20T22:09:12.1753817Z +            detail="Un compte avec ces informations existe déjà",
2026-02-20T22:09:12.1754341Z +        )
2026-02-20T22:09:12.1754590Z +
2026-02-20T22:09:12.1754895Z      if get_user_by_email(db, user_in.email):
2026-02-20T22:09:12.1755757Z -        logger.warning(f"Tentative de création avec email déjà utilisé: {user_in.email}")
2026-02-20T22:09:12.1756475Z +        logger.warning(
2026-02-20T22:09:12.1757129Z +            f"Tentative de création avec email déjà utilisé: {user_in.email}"
2026-02-20T22:09:12.1758001Z +        )
2026-02-20T22:09:12.1758308Z          raise HTTPException(
2026-02-20T22:09:12.1758733Z              status_code=status.HTTP_409_CONFLICT,
2026-02-20T22:09:12.1759433Z -            detail="Un compte avec ces informations existe déjà"
2026-02-20T22:09:12.1759944Z -        )
2026-02-20T22:09:12.1760430Z -    
2026-02-20T22:09:12.1760962Z +            detail="Un compte avec ces informations existe déjà",
2026-02-20T22:09:12.1761489Z +        )
2026-02-20T22:09:12.1761819Z +
2026-02-20T22:09:12.1762542Z      # Par défaut, les nouveaux utilisateurs sont des Padawans sauf spécification contraire
2026-02-20T22:09:12.1763448Z      if user_in.role:
2026-02-20T22:09:12.1764127Z          # Utiliser le rôle fourni (déjà une énumération grâce au schéma Pydantic)
2026-02-20T22:09:12.1764787Z          user_role = user_in.role
2026-02-20T22:09:12.1765165Z      else:
2026-02-20T22:09:12.1765528Z          # Rôle par défaut
2026-02-20T22:09:12.1765902Z          user_role = UserRole.PADAWAN
2026-02-20T22:09:12.1766321Z -    
2026-02-20T22:09:12.1766567Z +
2026-02-20T22:09:12.1767019Z      # Créer l'utilisateur avec les données fournies
2026-02-20T22:09:12.1767547Z      current_time = datetime.now(timezone.utc)
2026-02-20T22:09:12.1767988Z      user = User(
2026-02-20T22:09:12.1768337Z          username=user_in.username,
2026-02-20T22:09:12.1768744Z          email=user_in.email,
2026-02-20T22:09:12.1769113Z @@ -149,253 +167,273 @@
2026-02-20T22:09:12.1769542Z          preferred_difficulty=user_in.preferred_difficulty,
2026-02-20T22:09:12.1770119Z          preferred_theme=user_in.preferred_theme,
2026-02-20T22:09:12.1770703Z          accessibility_settings=user_in.accessibility_settings,
2026-02-20T22:09:12.1771247Z          is_active=True,
2026-02-20T22:09:12.1771593Z          created_at=current_time,
2026-02-20T22:09:12.1771993Z -        updated_at=current_time
2026-02-20T22:09:12.1772397Z +        updated_at=current_time,
2026-02-20T22:09:12.1772757Z      )
2026-02-20T22:09:12.1803238Z -    
2026-02-20T22:09:12.1803560Z +
2026-02-20T22:09:12.1804034Z      # Ajouter l'utilisateur à la base de données
2026-02-20T22:09:12.1804500Z      db.add(user)
2026-02-20T22:09:12.1804804Z      db.commit()
2026-02-20T22:09:12.1805110Z      db.refresh(user)
2026-02-20T22:09:12.1805417Z -    
2026-02-20T22:09:12.1805669Z +
2026-02-20T22:09:12.1806293Z      logger.info(f"Nouvel utilisateur créé: {user.username} (ID: {user.id})")
2026-02-20T22:09:12.1806926Z      return user
2026-02-20T22:09:12.1807211Z  
2026-02-20T22:09:12.1807451Z +
2026-02-20T22:09:12.1807750Z  def create_user_token(user: User) -> dict:
2026-02-20T22:09:12.1808182Z      """
2026-02-20T22:09:12.1808730Z      Crée un token d'accès et un refresh token pour un utilisateur.
2026-02-20T22:09:12.1809278Z -    
2026-02-20T22:09:12.1809528Z +
2026-02-20T22:09:12.1809781Z      Args:
2026-02-20T22:09:12.1810078Z          user: Instance de l'utilisateur
2026-02-20T22:09:12.1810481Z -    
2026-02-20T22:09:12.1810725Z +
2026-02-20T22:09:12.1810966Z      Returns:
2026-02-20T22:09:12.1811867Z          Dictionnaire contenant le token d'accès, le refresh token et leur type
2026-02-20T22:09:12.1812496Z      """
2026-02-20T22:09:12.1813188Z      # Créer un access token avec une durée d'expiration courte
2026-02-20T22:09:12.1813995Z      access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
2026-02-20T22:09:12.1814901Z      refresh_token_expires = timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
2026-02-20T22:09:12.1815526Z -    
2026-02-20T22:09:12.1815786Z +
2026-02-20T22:09:12.1816347Z      # Données pour les tokens - gérer le cas où role est string ou enum
2026-02-20T22:09:12.1817135Z      role_value = user.role if isinstance(user.role, str) else user.role.value
2026-02-20T22:09:12.1817766Z -    token_data = {
2026-02-20T22:09:12.1818088Z -        "sub": user.username, 
2026-02-20T22:09:12.1818470Z -        "role": role_value
2026-02-20T22:09:12.1818803Z -    }
2026-02-20T22:09:12.1819059Z -    
2026-02-20T22:09:12.1819430Z +    token_data = {"sub": user.username, "role": role_value}
2026-02-20T22:09:12.1819940Z +
2026-02-20T22:09:12.1820291Z      # Créer le token d'accès
2026-02-20T22:09:12.1820692Z      access_token = create_access_token(
2026-02-20T22:09:12.1821121Z -        data=token_data,
2026-02-20T22:09:12.1821758Z -        expires_delta=access_token_expires
2026-02-20T22:09:12.1822329Z +        data=token_data, expires_delta=access_token_expires
2026-02-20T22:09:12.1822796Z      )
2026-02-20T22:09:12.1823210Z -    
2026-02-20T22:09:12.1823448Z +
2026-02-20T22:09:12.1823885Z      # Données pour le token de rafraîchissement
2026-02-20T22:09:12.1824369Z      refresh_data = token_data.copy()
2026-02-20T22:09:12.1824807Z      refresh_data["type"] = "refresh"
2026-02-20T22:09:12.1825183Z -    
2026-02-20T22:09:12.1825435Z +
2026-02-20T22:09:12.1825881Z      # Créer le token de rafraîchissement manuellement
2026-02-20T22:09:12.1826378Z      refresh_token = jwt.encode(
2026-02-20T22:09:12.1826758Z -        {
2026-02-20T22:09:12.1827039Z -            **refresh_data,
2026-02-20T22:09:12.1827552Z -            "exp": datetime.now(timezone.utc) + refresh_token_expires
2026-02-20T22:09:12.1828082Z -        },
2026-02-20T22:09:12.1828574Z +        {**refresh_data, "exp": datetime.now(timezone.utc) + refresh_token_expires},
2026-02-20T22:09:12.1829249Z          settings.SECRET_KEY,
2026-02-20T22:09:12.1829653Z -        algorithm=settings.ALGORITHM
2026-02-20T22:09:12.1830093Z +        algorithm=settings.ALGORITHM,
2026-02-20T22:09:12.1830481Z      )
2026-02-20T22:09:12.1830737Z -    
2026-02-20T22:09:12.1830983Z +
2026-02-20T22:09:12.1831417Z      # Vérifier que le refresh_token est bien créé
2026-02-20T22:09:12.1831898Z      if not refresh_token:
2026-02-20T22:09:12.1832676Z -        logger.error(f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1863658Z +        logger.error(
2026-02-20T22:09:12.1864412Z +            f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}"
2026-02-20T22:09:12.1865064Z +        )
2026-02-20T22:09:12.1865330Z      else:
2026-02-20T22:09:12.1866190Z -        logger.debug(f"Refresh token créé (longueur: {len(refresh_token)}) pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1867003Z -    
2026-02-20T22:09:12.1867291Z +        logger.debug(
2026-02-20T22:09:12.1868121Z +            f"Refresh token créé (longueur: {len(refresh_token)}) pour l'utilisateur: {user.username}"
2026-02-20T22:09:12.1868875Z +        )
2026-02-20T22:09:12.1869139Z +
2026-02-20T22:09:12.1869704Z      logger.info(f"Tokens créés pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.1870286Z      return {
2026-02-20T22:09:12.1870605Z          "access_token": access_token,
2026-02-20T22:09:12.1871046Z          "refresh_token": refresh_token,
2026-02-20T22:09:12.1871476Z          "token_type": "bearer",
2026-02-20T22:09:12.1871931Z -        "user_id": user.id
2026-02-20T22:09:12.1872287Z +        "user_id": user.id,
2026-02-20T22:09:12.1872629Z      }
2026-02-20T22:09:12.1872874Z  
2026-02-20T22:09:12.1873560Z +
2026-02-20T22:09:12.1873999Z  def refresh_access_token(db: Session, refresh_token: str) -> dict:
2026-02-20T22:09:12.1874576Z      """
2026-02-20T22:09:12.1875274Z      Rafraîchit un token d'accès JWT en utilisant un token de rafraîchissement valide.
2026-02-20T22:09:12.1875949Z -    
2026-02-20T22:09:12.1876233Z +
2026-02-20T22:09:12.1876483Z      Args:
2026-02-20T22:09:12.1876880Z          db: Session de base de données
2026-02-20T22:09:12.1877500Z          refresh_token: Token de rafraîchissement à valider
2026-02-20T22:09:12.1877997Z -    
2026-02-20T22:09:12.1878252Z +
2026-02-20T22:09:12.1878500Z      Returns:
2026-02-20T22:09:12.1879148Z          Dictionnaire contenant le nouveau token d'accès JWT et le type de token
2026-02-20T22:09:12.1879790Z -        
2026-02-20T22:09:12.1880059Z +
2026-02-20T22:09:12.1880296Z      Raises:
2026-02-20T22:09:12.1880998Z          HTTPException: Si le token est invalide, expiré, ou si l'utilisateur n'existe plus
2026-02-20T22:09:12.1881804Z          RuntimeError: Si une erreur inattendue se produit
2026-02-20T22:09:12.1882321Z      """
2026-02-20T22:09:12.1882575Z      try:
2026-02-20T22:09:12.1882858Z          # Log pour diagnostic
2026-02-20T22:09:12.1883895Z -        logger.debug(f"Tentative de décodage du refresh_token (longueur: {len(refresh_token)})")
2026-02-20T22:09:12.1884918Z -        
2026-02-20T22:09:12.1885225Z +        logger.debug(
2026-02-20T22:09:12.1885941Z +            f"Tentative de décodage du refresh_token (longueur: {len(refresh_token)})"
2026-02-20T22:09:12.1886600Z +        )
2026-02-20T22:09:12.1886858Z +
2026-02-20T22:09:12.1887334Z          # Décoder le token avec vérification de l'expiration
2026-02-20T22:09:12.1888124Z          # Si le token est expiré, jwt.ExpiredSignatureError sera levée
2026-02-20T22:09:12.1888691Z          try:
2026-02-20T22:09:12.1888999Z              payload = jwt.decode(
2026-02-20T22:09:12.1889401Z -                refresh_token, 
2026-02-20T22:09:12.1889807Z -                settings.SECRET_KEY, 
2026-02-20T22:09:12.1890253Z +                refresh_token,
2026-02-20T22:09:12.1890709Z +                settings.SECRET_KEY,
2026-02-20T22:09:12.1891161Z                  algorithms=[settings.ALGORITHM],
2026-02-20T22:09:12.1891665Z -                options={"verify_exp": True}
2026-02-20T22:09:12.1892150Z +                options={"verify_exp": True},
2026-02-20T22:09:12.1892575Z              )
2026-02-20T22:09:12.1892890Z          except JWTError as decode_error:
2026-02-20T22:09:12.1923916Z              logger.error(f"Erreur de décodage JWT: {str(decode_error)}")
2026-02-20T22:09:12.1925227Z -            logger.debug(f"Token reçu (premiers 50 caractères): {refresh_token[:50] if len(refresh_token) > 50 else refresh_token}")
2026-02-20T22:09:12.1926179Z +            logger.debug(
2026-02-20T22:09:12.1927148Z +                f"Token reçu (premiers 50 caractères): {refresh_token[:50] if len(refresh_token) > 50 else refresh_token}"
2026-02-20T22:09:12.1927972Z +            )
2026-02-20T22:09:12.1928293Z              raise HTTPException(
2026-02-20T22:09:12.1928778Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1929444Z -                detail="Token JWT invalide ou malformé"
2026-02-20T22:09:12.1930095Z +                detail="Token JWT invalide ou malformé",
2026-02-20T22:09:12.1930566Z              )
2026-02-20T22:09:12.1930962Z          except jwt.InvalidSignatureError as sig_error:
2026-02-20T22:09:12.1931605Z              logger.error(f"Signature JWT invalide: {str(sig_error)}")
2026-02-20T22:09:12.1932752Z -            logger.warning("Le SECRET_KEY utilisé pour décoder ne correspond pas à celui utilisé pour encoder")
2026-02-20T22:09:12.1933769Z +            logger.warning(
2026-02-20T22:09:12.1934612Z +                "Le SECRET_KEY utilisé pour décoder ne correspond pas à celui utilisé pour encoder"
2026-02-20T22:09:12.1935314Z +            )
2026-02-20T22:09:12.1935636Z              raise HTTPException(
2026-02-20T22:09:12.1936105Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1936943Z -                detail="Token invalide (signature incorrecte)"
2026-02-20T22:09:12.1937456Z -            )
2026-02-20T22:09:12.1937728Z -        
2026-02-20T22:09:12.1938112Z +                detail="Token invalide (signature incorrecte)",
2026-02-20T22:09:12.1938612Z +            )
2026-02-20T22:09:12.1938890Z +
2026-02-20T22:09:12.1939391Z          # Vérifier que c'est bien un token de rafraîchissement
2026-02-20T22:09:12.1939962Z          token_type = payload.get("type")
2026-02-20T22:09:12.1940628Z          logger.debug(f"Type de token décodé: {token_type}")
2026-02-20T22:09:12.1941168Z          if token_type != "refresh":
2026-02-20T22:09:12.1942232Z -            logger.warning(f"Tentative de rafraîchissement avec un token non-refresh: {token_type}. Payload: {payload}")
2026-02-20T22:09:12.1943317Z +            logger.warning(
2026-02-20T22:09:12.1944243Z +                f"Tentative de rafraîchissement avec un token non-refresh: {token_type}. Payload: {payload}"
2026-02-20T22:09:12.1945043Z +            )
2026-02-20T22:09:12.1945361Z              raise HTTPException(
2026-02-20T22:09:12.1945831Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1946508Z -                detail=f"Token de rafraîchissement invalide (type: {token_type})"
2026-02-20T22:09:12.1947216Z -            )
2026-02-20T22:09:12.1947460Z -        
2026-02-20T22:09:12.1947958Z +                detail=f"Token de rafraîchissement invalide (type: {token_type})",
2026-02-20T22:09:12.1948467Z +            )
2026-02-20T22:09:12.1948698Z +
2026-02-20T22:09:12.1948945Z          # Extraire les informations utilisateur
2026-02-20T22:09:12.1949348Z          username = payload.get("sub")
2026-02-20T22:09:12.1949707Z          if not username:
2026-02-20T22:09:12.1950348Z              logger.warning("Tentative de rafraîchissement avec un token sans sujet")
2026-02-20T22:09:12.1950984Z              raise HTTPException(
2026-02-20T22:09:12.1951370Z -                status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1951815Z -                detail="Token invalide"
2026-02-20T22:09:12.1952155Z -            )
2026-02-20T22:09:12.1952415Z -        
2026-02-20T22:09:12.1952849Z +                status_code=status.HTTP_401_UNAUTHORIZED, detail="Token invalide"
2026-02-20T22:09:12.1983775Z +            )
2026-02-20T22:09:12.1984078Z +
2026-02-20T22:09:12.1984546Z          # Vérifier que l'utilisateur existe toujours
2026-02-20T22:09:12.1985100Z          user = get_user_by_username(db, username)
2026-02-20T22:09:12.1985558Z          if not user:
2026-02-20T22:09:12.1986473Z -            logger.warning(f"Tentative de rafraîchissement pour un utilisateur qui n'existe pas: {username}")
2026-02-20T22:09:12.1987326Z +            logger.warning(
2026-02-20T22:09:12.1988135Z +                f"Tentative de rafraîchissement pour un utilisateur qui n'existe pas: {username}"
2026-02-20T22:09:12.1988860Z +            )
2026-02-20T22:09:12.1989189Z              raise HTTPException(
2026-02-20T22:09:12.1989680Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1990302Z -                detail="Utilisateur non trouvé"
2026-02-20T22:09:12.1990753Z -            )
2026-02-20T22:09:12.1991028Z -        
2026-02-20T22:09:12.1991459Z +                detail="Utilisateur non trouvé",
2026-02-20T22:09:12.1991900Z +            )
2026-02-20T22:09:12.1992187Z +
2026-02-20T22:09:12.1992636Z          # Vérifier que l'utilisateur est toujours actif
2026-02-20T22:09:12.1993318Z          if not user.is_active:
2026-02-20T22:09:12.1994205Z -            logger.warning(f"Tentative de rafraîchissement pour un utilisateur inactif: {username}")
2026-02-20T22:09:12.1994984Z +            logger.warning(
2026-02-20T22:09:12.1995718Z +                f"Tentative de rafraîchissement pour un utilisateur inactif: {username}"
2026-02-20T22:09:12.1996365Z +            )
2026-02-20T22:09:12.1996677Z              raise HTTPException(
2026-02-20T22:09:12.1997131Z                  status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.1998040Z -                detail="Compte utilisateur désactivé"
2026-02-20T22:09:12.1998501Z -            )
2026-02-20T22:09:12.1998775Z -        
2026-02-20T22:09:12.1999224Z +                detail="Compte utilisateur désactivé",
2026-02-20T22:09:12.1999677Z +            )
2026-02-20T22:09:12.1999963Z +
2026-02-20T22:09:12.2000550Z          # Générer un nouveau token d'accès ET un nouveau refresh token (rotation)
2026-02-20T22:09:12.2001504Z          # Best-practice: chaque refresh invalide l'ancien en émettant un nouveau
2026-02-20T22:09:12.2002279Z          # Gérer le cas où role est string ou enum
2026-02-20T22:09:12.2002933Z          role_value = user.role if isinstance(user.role, str) else user.role.value
2026-02-20T22:09:12.2003805Z          new_token_data = create_user_token(user)
2026-02-20T22:09:12.2004246Z          return {
2026-02-20T22:09:12.2004665Z              "access_token": new_token_data.get("access_token"),
2026-02-20T22:09:12.2005652Z -            "refresh_token": new_token_data.get("refresh_token"),  # Rotation: nouveau à chaque refresh
2026-02-20T22:09:12.2006468Z +            "refresh_token": new_token_data.get(
2026-02-20T22:09:12.2006922Z +                "refresh_token"
2026-02-20T22:09:12.2007451Z +            ),  # Rotation: nouveau à chaque refresh
2026-02-20T22:09:12.2008117Z              "token_type": "bearer",
2026-02-20T22:09:12.2008527Z          }
2026-02-20T22:09:12.2008788Z -        
2026-02-20T22:09:12.2009048Z -        
2026-02-20T22:09:12.2009311Z +
2026-02-20T22:09:12.2009743Z          # ... (le code précédent reste le même) ...
2026-02-20T22:09:12.2010194Z -        
2026-02-20T22:09:12.2010443Z +
2026-02-20T22:09:12.2010744Z      except jwt.ExpiredSignatureError:
2026-02-20T22:09:12.2011495Z          logger.warning("Tentative de rafraîchissement avec un token expiré")
2026-02-20T22:09:12.2012141Z          raise HTTPException(
2026-02-20T22:09:12.2012579Z              status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2043847Z -            detail="Token de rafraîchissement expiré"
2026-02-20T22:09:12.2044498Z +            detail="Token de rafraîchissement expiré",
2026-02-20T22:09:12.2044949Z          )
2026-02-20T22:09:12.2045272Z      except JWTError as jwt_err:
2026-02-20T22:09:12.2046376Z -        logger.warning(f"Tentative de rafraîchissement avec un token JWT invalide: {type(jwt_err).__name__}: {str(jwt_err)}")
2026-02-20T22:09:12.2047348Z -        raise HTTPException(
2026-02-20T22:09:12.2047800Z -            status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2048297Z -            detail="Token invalide"
2026-02-20T22:09:12.2048719Z +        logger.warning(
2026-02-20T22:09:12.2049631Z +            f"Tentative de rafraîchissement avec un token JWT invalide: {type(jwt_err).__name__}: {str(jwt_err)}"
2026-02-20T22:09:12.2050447Z +        )
2026-02-20T22:09:12.2050737Z +        raise HTTPException(
2026-02-20T22:09:12.2051307Z +            status_code=status.HTTP_401_UNAUTHORIZED, detail="Token invalide"
2026-02-20T22:09:12.2051918Z          )
2026-02-20T22:09:12.2052218Z      except HTTPException:
2026-02-20T22:09:12.2053216Z          # Re-lancer les HTTPException sans les modifier (elles ont déjà le bon code de statut)
2026-02-20T22:09:12.2053949Z          raise
2026-02-20T22:09:12.2054258Z      except RuntimeError:
2026-02-20T22:09:12.2054870Z          # Ne pas intercepter les RuntimeError pour permettre aux tests de les attraper
2026-02-20T22:09:12.2055887Z          logger.error("Erreur RuntimeError lors du rafraîchissement du token")
2026-02-20T22:09:12.2056512Z          raise
2026-02-20T22:09:12.2056856Z      except Exception as token_refresh_error:
2026-02-20T22:09:12.2057741Z -        logger.error(f"Erreur lors du rafraîchissement du token: {str(token_refresh_error)}")
2026-02-20T22:09:12.2058487Z +        logger.error(
2026-02-20T22:09:12.2059165Z +            f"Erreur lors du rafraîchissement du token: {str(token_refresh_error)}"
2026-02-20T22:09:12.2059788Z +        )
2026-02-20T22:09:12.2060089Z          raise HTTPException(
2026-02-20T22:09:12.2060818Z              status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
2026-02-20T22:09:12.2061391Z -            detail="Erreur interne du serveur"
2026-02-20T22:09:12.2061887Z -        )
2026-02-20T22:09:12.2062211Z +            detail="Erreur interne du serveur",
2026-02-20T22:09:12.2062656Z +        )
2026-02-20T22:09:12.2062913Z +
2026-02-20T22:09:12.2063329Z  
2026-02-20T22:09:12.2063769Z  def update_user(db: Session, user: User, user_in: UserUpdate) -> User:
2026-02-20T22:09:12.2064365Z      """
2026-02-20T22:09:12.2064872Z      Met à jour les informations d'un utilisateur existant.
2026-02-20T22:09:12.2065381Z -    
2026-02-20T22:09:12.2065640Z +
2026-02-20T22:09:12.2065881Z      Args:
2026-02-20T22:09:12.2066266Z          db: Session de base de données
2026-02-20T22:09:12.2066872Z          user: Instance de l'utilisateur à mettre à jour
2026-02-20T22:09:12.2067490Z          user_in: Données pour la mise à jour
2026-02-20T22:09:12.2067917Z -    
2026-02-20T22:09:12.2068187Z +
2026-02-20T22:09:12.2068429Z      Returns:
2026-02-20T22:09:12.2068853Z          Instance de l'utilisateur mise à jour
2026-02-20T22:09:12.2069277Z      """
2026-02-20T22:09:12.2069689Z      # Mettre à jour le mot de passe si fourni
2026-02-20T22:09:12.2070137Z      if user_in.password:
2026-02-20T22:09:12.2070837Z          user.hashed_password = get_password_hash(user_in.password)
2026-02-20T22:09:12.2071399Z -    
2026-02-20T22:09:12.2071658Z +
2026-02-20T22:09:12.2072070Z      # Mettre à jour les autres champs si fournis
2026-02-20T22:09:12.2072755Z      update_data = user_in.model_dump(exclude_unset=True, exclude={"password"})
2026-02-20T22:09:12.2103730Z      for field, value in update_data.items():
2026-02-20T22:09:12.2104206Z          if value is not None:
2026-02-20T22:09:12.2104617Z              setattr(user, field, value)
2026-02-20T22:09:12.2105016Z -    
2026-02-20T22:09:12.2105280Z +
2026-02-20T22:09:12.2105532Z      db.add(user)
2026-02-20T22:09:12.2105837Z      db.commit()
2026-02-20T22:09:12.2106156Z      db.refresh(user)
2026-02-20T22:09:12.2106466Z -    
2026-02-20T22:09:12.2106711Z +
2026-02-20T22:09:12.2107331Z      logger.info(f"Utilisateur mis à jour: {user.username} (ID: {user.id})")
2026-02-20T22:09:12.2107960Z      return user
2026-02-20T22:09:12.2108245Z  
2026-02-20T22:09:12.2108884Z -def update_user_password(db: Session, user: User, current_password: str, new_password: str) -> bool:
2026-02-20T22:09:12.2109663Z +
2026-02-20T22:09:12.2109815Z +def update_user_password(
2026-02-20T22:09:12.2110098Z +    db: Session, user: User, current_password: str, new_password: str
2026-02-20T22:09:12.2110212Z +) -> bool:
2026-02-20T22:09:12.2110318Z      """
2026-02-20T22:09:12.2110881Z      Met à jour le mot de passe d'un utilisateur après vérification du mot de passe actuel.
2026-02-20T22:09:12.2110988Z -    
2026-02-20T22:09:12.2111091Z +
2026-02-20T22:09:12.2111207Z      Args:
2026-02-20T22:09:12.2111434Z          db: Session de base de données
2026-02-20T22:09:12.2111586Z          user: Instance de l'utilisateur
2026-02-20T22:09:12.2111983Z          current_password: Mot de passe actuel (pour vérification)
2026-02-20T22:09:12.2112155Z          new_password: Nouveau mot de passe
2026-02-20T22:09:12.2112256Z -    
2026-02-20T22:09:12.2112357Z +
2026-02-20T22:09:12.2112475Z      Returns:
2026-02-20T22:09:12.2112769Z          True si la mise à jour a réussi, False sinon
2026-02-20T22:09:12.2112881Z -        
2026-02-20T22:09:12.2113154Z +
2026-02-20T22:09:12.2113274Z      Raises:
2026-02-20T22:09:12.2113533Z          HTTPException: Si le mot de passe actuel est incorrect
2026-02-20T22:09:12.2113638Z      """
2026-02-20T22:09:12.2113884Z      # Vérifier le mot de passe actuel
2026-02-20T22:09:12.2114174Z      if not verify_password(current_password, user.hashed_password):
2026-02-20T22:09:12.2114776Z -        logger.warning(f"Tentative de changement de mot de passe avec mot de passe actuel incorrect pour {user.username}")
2026-02-20T22:09:12.2114919Z +        logger.warning(
2026-02-20T22:09:12.2115657Z +            f"Tentative de changement de mot de passe avec mot de passe actuel incorrect pour {user.username}"
2026-02-20T22:09:12.2115768Z +        )
2026-02-20T22:09:12.2115912Z          raise HTTPException(
2026-02-20T22:09:12.2116110Z              status_code=status.HTTP_401_UNAUTHORIZED,
2026-02-20T22:09:12.2116300Z -            detail="Mot de passe actuel incorrect"
2026-02-20T22:09:12.2116409Z -        )
2026-02-20T22:09:12.2116517Z -    
2026-02-20T22:09:12.2116701Z +            detail="Mot de passe actuel incorrect",
2026-02-20T22:09:12.2116804Z +        )
2026-02-20T22:09:12.2116910Z +
2026-02-20T22:09:12.2117211Z      # Mettre à jour avec le nouveau mot de passe
2026-02-20T22:09:12.2117455Z      user.hashed_password = get_password_hash(new_password)
2026-02-20T22:09:12.2117647Z      user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:12.2117756Z -    
2026-02-20T22:09:12.2117856Z +
2026-02-20T22:09:12.2117972Z      db.add(user)
2026-02-20T22:09:12.2118086Z      db.commit()
2026-02-20T22:09:12.2118227Z      db.refresh(user)
2026-02-20T22:09:12.2118329Z -    
2026-02-20T22:09:12.2118428Z +
2026-02-20T22:09:12.2118907Z      logger.info(f"Mot de passe mis à jour pour l'utilisateur: {user.username}")
2026-02-20T22:09:12.2119024Z -    return True 
2026-02-20T22:09:12.2119356Z \ No newline at end of file
2026-02-20T22:09:12.2119484Z +    return True
2026-02-20T22:09:12.2119938Z would reformat /home/runner/work/mathakine/mathakine/app/services/auth_service.py
2026-02-20T22:09:12.5230944Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.5234560Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_service.py	2026-02-20 22:09:12.516193+00:00
2026-02-20T22:09:12.5236969Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_service.py
2026-02-20T22:09:12.5240087Z @@ -4,23 +4,26 @@
2026-02-20T22:09:12.5242655Z  Ce service remplace challenge_service_translations.py qui utilisait du raw SQL.
2026-02-20T22:09:12.5252363Z  Utilise uniquement SQLAlchemy ORM pour la maintenabilité.
2026-02-20T22:09:12.5255611Z  
2026-02-20T22:09:12.5257999Z  Créé : Phase 4 (20 Nov 2025)
2026-02-20T22:09:12.5260835Z  """
2026-02-20T22:09:12.5261101Z +
2026-02-20T22:09:12.5262696Z  from datetime import datetime, timezone
2026-02-20T22:09:12.5264618Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:12.5266294Z  
2026-02-20T22:09:12.5267855Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.5269547Z  
2026-02-20T22:09:12.5272147Z  logger = get_logger(__name__)
2026-02-20T22:09:12.5306020Z  from sqlalchemy import and_, or_, func, case
2026-02-20T22:09:12.5306666Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.5307063Z  
2026-02-20T22:09:12.5307485Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:12.5308135Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:12.5308659Z -                                        LogicChallengeType)
2026-02-20T22:09:12.5309103Z -
2026-02-20T22:09:12.5309417Z +from app.models.logic_challenge import (
2026-02-20T22:09:12.5309843Z +    AgeGroup,
2026-02-20T22:09:12.5310132Z +    LogicChallenge,
2026-02-20T22:09:12.5310459Z +    LogicChallengeAttempt,
2026-02-20T22:09:12.5310833Z +    LogicChallengeType,
2026-02-20T22:09:12.5311149Z +)
2026-02-20T22:09:12.5311384Z  
2026-02-20T22:09:12.5311691Z  # ============================================================================
2026-02-20T22:09:12.5312406Z  # MAPPING DES GROUPES D'ÂGE (après migration ENUM)
2026-02-20T22:09:12.5312948Z  # ============================================================================
2026-02-20T22:09:12.5313909Z  # PostgreSQL ENUM `agegroup` contient (après migration):
2026-02-20T22:09:12.5314410Z @@ -36,16 +39,16 @@
2026-02-20T22:09:12.5314758Z  # ============================================================================
2026-02-20T22:09:12.5315209Z  
2026-02-20T22:09:12.5315746Z  # Mapping des groupes d'âge frontend vers les valeurs ENUM PostgreSQL
2026-02-20T22:09:12.5316713Z  FRONTEND_TO_DB_AGE_GROUP = {
2026-02-20T22:09:12.5317343Z      # Groupes d'âge frontend → valeurs DB (mapping 1:1 après migration)
2026-02-20T22:09:12.5318083Z -    "6-8": AgeGroup.GROUP_6_8,        # 6-8 ans → GROUP_6_8
2026-02-20T22:09:12.5318784Z -    "9-11": AgeGroup.GROUP_10_12,     # 9-11 ans → GROUP_10_12
2026-02-20T22:09:12.5319468Z -    "12-14": AgeGroup.GROUP_13_15,    # 12-14 ans → GROUP_13_15
2026-02-20T22:09:12.5320155Z -    "15-17": AgeGroup.GROUP_15_17,    # 15-17 ans → GROUP_15_17
2026-02-20T22:09:12.5320796Z -    "adulte": AgeGroup.ADULT,         # adulte → ADULT
2026-02-20T22:09:12.5321453Z -    "tous-ages": AgeGroup.ALL_AGES,   # tous âges → ALL_AGES
2026-02-20T22:09:12.5322091Z +    "6-8": AgeGroup.GROUP_6_8,  # 6-8 ans → GROUP_6_8
2026-02-20T22:09:12.5322718Z +    "9-11": AgeGroup.GROUP_10_12,  # 9-11 ans → GROUP_10_12
2026-02-20T22:09:12.5323536Z +    "12-14": AgeGroup.GROUP_13_15,  # 12-14 ans → GROUP_13_15
2026-02-20T22:09:12.5324223Z +    "15-17": AgeGroup.GROUP_15_17,  # 15-17 ans → GROUP_15_17
2026-02-20T22:09:12.5324834Z +    "adulte": AgeGroup.ADULT,  # adulte → ADULT
2026-02-20T22:09:12.5325456Z +    "tous-ages": AgeGroup.ALL_AGES,  # tous âges → ALL_AGES
2026-02-20T22:09:12.5326265Z      # Anciennes valeurs (rétrocompatibilité)
2026-02-20T22:09:12.5326721Z      "10-12": AgeGroup.GROUP_10_12,
2026-02-20T22:09:12.5327116Z      "13-15": AgeGroup.GROUP_13_15,
2026-02-20T22:09:12.5327500Z      "all": AgeGroup.ALL_AGES,
2026-02-20T22:09:12.5327954Z      # Valeurs legacy qui pourraient arriver (code ancien)
2026-02-20T22:09:12.5328428Z @@ -63,76 +66,76 @@
2026-02-20T22:09:12.5328732Z      "all_ages": AgeGroup.ALL_AGES,
2026-02-20T22:09:12.5329096Z  }
2026-02-20T22:09:12.5329321Z  
2026-02-20T22:09:12.5329761Z  # Mapping inverse : ENUM PostgreSQL vers format frontend pour affichage
2026-02-20T22:09:12.5330361Z  DB_TO_FRONTEND_AGE_GROUP = {
2026-02-20T22:09:12.5330924Z -    AgeGroup.GROUP_6_8: "6-8",        # GROUP_6_8 → 6-8 ans
2026-02-20T22:09:12.5331630Z -    AgeGroup.GROUP_10_12: "9-11",     # GROUP_10_12 → 9-11 ans
2026-02-20T22:09:12.5332351Z -    AgeGroup.GROUP_13_15: "12-14",    # GROUP_13_15 → 12-14 ans
2026-02-20T22:09:12.5333239Z -    AgeGroup.GROUP_15_17: "15-17",    # GROUP_15_17 → 15-17 ans
2026-02-20T22:09:12.5333960Z -    AgeGroup.ADULT: "adulte",         # ADULT → adulte
2026-02-20T22:09:12.5334670Z -    AgeGroup.ALL_AGES: "tous-ages",   # ALL_AGES → tous âges
2026-02-20T22:09:12.5335361Z +    AgeGroup.GROUP_6_8: "6-8",  # GROUP_6_8 → 6-8 ans
2026-02-20T22:09:12.5336012Z +    AgeGroup.GROUP_10_12: "9-11",  # GROUP_10_12 → 9-11 ans
2026-02-20T22:09:12.5336731Z +    AgeGroup.GROUP_13_15: "12-14",  # GROUP_13_15 → 12-14 ans
2026-02-20T22:09:12.5337451Z +    AgeGroup.GROUP_15_17: "15-17",  # GROUP_15_17 → 15-17 ans
2026-02-20T22:09:12.5338101Z +    AgeGroup.ADULT: "adulte",  # ADULT → adulte
2026-02-20T22:09:12.5338758Z +    AgeGroup.ALL_AGES: "tous-ages",  # ALL_AGES → tous âges
2026-02-20T22:09:12.5339275Z  }
2026-02-20T22:09:12.5339582Z  
2026-02-20T22:09:12.5339975Z  # Alias pour compatibilité (même contenu)
2026-02-20T22:09:12.5340551Z  DB_TO_FRONTEND_AGE_GROUP_EXTENDED = DB_TO_FRONTEND_AGE_GROUP
2026-02-20T22:09:12.5341069Z  
2026-02-20T22:09:12.5341299Z  
2026-02-20T22:09:12.5341705Z  def normalize_age_group_for_db(age_group: str) -> AgeGroup:
2026-02-20T22:09:12.5342216Z      """
2026-02-20T22:09:12.5342775Z      Convertit un groupe d'âge frontend vers une valeur ENUM PostgreSQL.
2026-02-20T22:09:12.5343585Z -    
2026-02-20T22:09:12.5343835Z +
2026-02-20T22:09:12.5344076Z      Args:
2026-02-20T22:09:12.5344539Z          age_group: Groupe d'âge (format frontend ou ENUM)
2026-02-20T22:09:12.5345015Z -    
2026-02-20T22:09:12.5345256Z +
2026-02-20T22:09:12.5345498Z      Returns:
2026-02-20T22:09:12.5345850Z          Valeur AgeGroup compatible avec PostgreSQL
2026-02-20T22:09:12.5346323Z      """
2026-02-20T22:09:12.5346592Z      if not age_group:
2026-02-20T22:09:12.5346943Z          return AgeGroup.ALL_AGES
2026-02-20T22:09:12.5347539Z -    
2026-02-20T22:09:12.5347788Z +
2026-02-20T22:09:12.5348053Z      # Normaliser la casse
2026-02-20T22:09:12.5348458Z      age_group_lower = age_group.lower().strip()
2026-02-20T22:09:12.5348898Z -    
2026-02-20T22:09:12.5349134Z +
2026-02-20T22:09:12.5349579Z      # Chercher dans le mapping
2026-02-20T22:09:12.5350044Z      if age_group_lower in FRONTEND_TO_DB_AGE_GROUP:
2026-02-20T22:09:12.5350618Z          return FRONTEND_TO_DB_AGE_GROUP[age_group_lower]
2026-02-20T22:09:12.5351088Z -    
2026-02-20T22:09:12.5351335Z +
2026-02-20T22:09:12.5351778Z      # Si c'est déjà une valeur AgeGroup, la retourner
2026-02-20T22:09:12.5352239Z      try:
2026-02-20T22:09:12.5352545Z          return AgeGroup(age_group_lower)
2026-02-20T22:09:12.5353138Z      except ValueError:
2026-02-20T22:09:12.5353482Z          pass
2026-02-20T22:09:12.5353746Z -    
2026-02-20T22:09:12.5353996Z +
2026-02-20T22:09:12.5354258Z      # Fallback vers ALL_AGES
2026-02-20T22:09:12.5355019Z      logger.warning(f"Groupe d'âge non reconnu: {age_group}, utilisation de ALL_AGES")
2026-02-20T22:09:12.5355735Z      return AgeGroup.ALL_AGES
2026-02-20T22:09:12.5356091Z  
2026-02-20T22:09:12.5356318Z  
2026-02-20T22:09:12.5356679Z  def normalize_age_group_for_frontend(age_group) -> str:
2026-02-20T22:09:12.5357184Z      """
2026-02-20T22:09:12.5357621Z      Convertit une valeur ENUM PostgreSQL vers le format frontend.
2026-02-20T22:09:12.5358173Z -    
2026-02-20T22:09:12.5358409Z +
2026-02-20T22:09:12.5358642Z      Args:
2026-02-20T22:09:12.5359218Z          age_group: Valeur AgeGroup de la DB (peut être AgeGroup, str, ou None)
2026-02-20T22:09:12.5359788Z -    
2026-02-20T22:09:12.5360040Z +
2026-02-20T22:09:12.5360299Z      Returns:
2026-02-20T22:09:12.5360648Z          String au format frontend (6-8, 9-11, etc.)
2026-02-20T22:09:12.5361076Z      """
2026-02-20T22:09:12.5361354Z      if not age_group:
2026-02-20T22:09:12.5361684Z          return "tous-ages"
2026-02-20T22:09:12.5362026Z -    
2026-02-20T22:09:12.5362288Z +
2026-02-20T22:09:12.5362709Z      # Si c'est une string, essayer de la convertir en AgeGroup d'abord
2026-02-20T22:09:12.5363459Z      if isinstance(age_group, str):
2026-02-20T22:09:12.5364136Z          # Vérifier d'abord dans le mapping étendu par valeur string
2026-02-20T22:09:12.5364749Z          age_group_lower = age_group.lower()
2026-02-20T22:09:12.5365395Z          for ag_enum, frontend_val in DB_TO_FRONTEND_AGE_GROUP_EXTENDED.items():
2026-02-20T22:09:12.5366213Z              if ag_enum.value == age_group_lower or ag_enum.name == age_group.upper():
2026-02-20T22:09:12.5366855Z                  return frontend_val
2026-02-20T22:09:12.5367251Z          # Fallback
2026-02-20T22:09:12.5367569Z          return "tous-ages"
2026-02-20T22:09:12.5367913Z -    
2026-02-20T22:09:12.5368164Z +
2026-02-20T22:09:12.5368643Z      # Si c'est un enum, utiliser le mapping étendu
2026-02-20T22:09:12.5369284Z      return DB_TO_FRONTEND_AGE_GROUP_EXTENDED.get(age_group, "tous-ages")
2026-02-20T22:09:12.5369892Z  
2026-02-20T22:09:12.5370148Z  
2026-02-20T22:09:12.5370416Z  def create_challenge(
2026-02-20T22:09:12.5370747Z @@ -152,11 +155,11 @@
2026-02-20T22:09:12.5371086Z      creator_id: Optional[int] = None,
2026-02-20T22:09:12.5371590Z      generation_parameters: Optional[Dict] = None,
2026-02-20T22:09:12.5372105Z  ) -> LogicChallenge:
2026-02-20T22:09:12.5372429Z      """
2026-02-20T22:09:12.5372842Z      Créer un nouveau challenge.
2026-02-20T22:09:12.5373416Z -    
2026-02-20T22:09:12.5373667Z +
2026-02-20T22:09:12.5373919Z      Args:
2026-02-20T22:09:12.5374214Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5374598Z          title: Titre du challenge
2026-02-20T22:09:12.5375140Z          description: Description détaillée
2026-02-20T22:09:12.5375717Z          challenge_type: Type (SEQUENCE, PATTERN, SPATIAL, etc.)
2026-02-20T22:09:12.5376270Z @@ -168,21 +171,21 @@
2026-02-20T22:09:12.5376796Z          visual_data: Données de visualisation (optionnel)
2026-02-20T22:09:12.5377501Z          difficulty_rating: Difficulté 1-5 (défaut: 3.0)
2026-02-20T22:09:12.5378478Z          estimated_time_minutes: Temps estimé (défaut: 10)
2026-02-20T22:09:12.5379165Z          tags: Tags séparés par virgules (optionnel)
2026-02-20T22:09:12.5379792Z          creator_id: ID du créateur (optionnel)
2026-02-20T22:09:12.5380223Z -    
2026-02-20T22:09:12.5380694Z +
2026-02-20T22:09:12.5380962Z      Returns:
2026-02-20T22:09:12.5381354Z          LogicChallenge créé
2026-02-20T22:09:12.5381708Z      """
2026-02-20T22:09:12.5382260Z      # Définir explicitement created_at pour éviter les valeurs NULL
2026-02-20T22:09:12.5382875Z      now = datetime.now(timezone.utc)
2026-02-20T22:09:12.5383479Z -    
2026-02-20T22:09:12.5383725Z +
2026-02-20T22:09:12.5384299Z      # Convertir le groupe d'âge frontend vers la valeur ENUM PostgreSQL
2026-02-20T22:09:12.5384999Z      db_age_group = normalize_age_group_for_db(age_group)
2026-02-20T22:09:12.5385824Z      logger.debug(f"Conversion groupe d'âge: {age_group} -> {db_age_group}")
2026-02-20T22:09:12.5386462Z -    
2026-02-20T22:09:12.5386715Z +
2026-02-20T22:09:12.5387002Z      challenge = LogicChallenge(
2026-02-20T22:09:12.5387389Z          title=title,
2026-02-20T22:09:12.5387737Z          description=description,
2026-02-20T22:09:12.5388166Z          challenge_type=challenge_type,
2026-02-20T22:09:12.5388637Z          age_group=db_age_group,
2026-02-20T22:09:12.5389120Z @@ -197,34 +200,35 @@
2026-02-20T22:09:12.5389455Z          creator_id=creator_id,
2026-02-20T22:09:12.5389839Z          is_active=True,
2026-02-20T22:09:12.5390454Z          created_at=now,  # Définir explicitement la date de création
2026-02-20T22:09:12.5391104Z          generation_parameters=generation_parameters,
2026-02-20T22:09:12.5391568Z      )
2026-02-20T22:09:12.5391826Z -    
2026-02-20T22:09:12.5392071Z +
2026-02-20T22:09:12.5392338Z      db.add(challenge)
2026-02-20T22:09:12.5392662Z      db.commit()
2026-02-20T22:09:12.5393132Z      db.refresh(challenge)
2026-02-20T22:09:12.5393473Z -    
2026-02-20T22:09:12.5393738Z +
2026-02-20T22:09:12.5394321Z      logger.info(f"Challenge créé: {challenge.id} - {challenge.title}")
2026-02-20T22:09:12.5394940Z      return challenge
2026-02-20T22:09:12.5395253Z  
2026-02-20T22:09:12.5395489Z  
2026-02-20T22:09:12.5396006Z  def get_challenge(db: Session, challenge_id: int) -> Optional[LogicChallenge]:
2026-02-20T22:09:12.5396666Z      """
2026-02-20T22:09:12.5397081Z      Récupérer un challenge par ID.
2026-02-20T22:09:12.5397470Z -    
2026-02-20T22:09:12.5397726Z +
2026-02-20T22:09:12.5397971Z      Args:
2026-02-20T22:09:12.5398264Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5398662Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5399053Z -    
2026-02-20T22:09:12.5399308Z +
2026-02-20T22:09:12.5399540Z      Returns:
2026-02-20T22:09:12.5399897Z          LogicChallenge ou None si non trouvé
2026-02-20T22:09:12.5400295Z      """
2026-02-20T22:09:12.5400597Z -    return db.query(LogicChallenge).filter(
2026-02-20T22:09:12.5401046Z -        LogicChallenge.id == challenge_id,
2026-02-20T22:09:12.5401529Z -        LogicChallenge.is_active == True
2026-02-20T22:09:12.5401936Z -    ).first()
2026-02-20T22:09:12.5402223Z +    return (
2026-02-20T22:09:12.5402533Z +        db.query(LogicChallenge)
2026-02-20T22:09:12.5403374Z +        .filter(LogicChallenge.id == challenge_id, LogicChallenge.is_active == True)
2026-02-20T22:09:12.5404056Z +        .first()
2026-02-20T22:09:12.5404346Z +    )
2026-02-20T22:09:12.5404604Z  
2026-02-20T22:09:12.5404838Z  
2026-02-20T22:09:12.5405103Z  def list_challenges(
2026-02-20T22:09:12.5405442Z      db: Session,
2026-02-20T22:09:12.5405794Z      challenge_type: Optional[str] = None,
2026-02-20T22:09:12.5406209Z @@ -237,57 +241,57 @@
2026-02-20T22:09:12.5406540Z      order: str = "random",
2026-02-20T22:09:12.5406953Z      exclude_ids: Optional[List[int]] = None,
2026-02-20T22:09:12.5407401Z  ) -> List[LogicChallenge]:
2026-02-20T22:09:12.5407749Z      """
2026-02-20T22:09:12.5408041Z      Lister les challenges avec filtres.
2026-02-20T22:09:12.5408691Z -    
2026-02-20T22:09:12.5408944Z +
2026-02-20T22:09:12.5409189Z      Args:
2026-02-20T22:09:12.5409475Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5409930Z          challenge_type: Filtrer par type (optionnel)
2026-02-20T22:09:12.5410873Z          age_group: Filtrer par groupe d'âge (optionnel)
2026-02-20T22:09:12.5411600Z          difficulty_min: Difficulté minimale (optionnel)
2026-02-20T22:09:12.5412289Z          difficulty_max: Difficulté maximale (optionnel)
2026-02-20T22:09:12.5412820Z          tags: Filtrer par tags (optionnel)
2026-02-20T22:09:12.5413636Z          limit: Nombre maximum de résultats (défaut: 10)
2026-02-20T22:09:12.5414282Z          offset: Offset pour pagination (défaut: 0)
2026-02-20T22:09:12.5414733Z -    
2026-02-20T22:09:12.5414981Z +
2026-02-20T22:09:12.5415232Z      Returns:
2026-02-20T22:09:12.5460918Z          Liste de LogicChallenge
2026-02-20T22:09:12.5461338Z      """
2026-02-20T22:09:12.5461848Z      query = db.query(LogicChallenge).filter(LogicChallenge.is_active == True)
2026-02-20T22:09:12.5462526Z -    
2026-02-20T22:09:12.5462789Z +
2026-02-20T22:09:12.5463263Z      # Filtres
2026-02-20T22:09:12.5463580Z      if challenge_type:
2026-02-20T22:09:12.5464155Z          query = query.filter(LogicChallenge.challenge_type == challenge_type)
2026-02-20T22:09:12.5464792Z -    
2026-02-20T22:09:12.5465060Z +
2026-02-20T22:09:12.5465333Z      if age_group:
2026-02-20T22:09:12.5465803Z          query = query.filter(LogicChallenge.age_group == age_group)
2026-02-20T22:09:12.5466361Z -    
2026-02-20T22:09:12.5466615Z +
2026-02-20T22:09:12.5466919Z      if difficulty_min is not None:
2026-02-20T22:09:12.5467565Z          query = query.filter(LogicChallenge.difficulty_rating >= difficulty_min)
2026-02-20T22:09:12.5468207Z -    
2026-02-20T22:09:12.5468455Z +
2026-02-20T22:09:12.5468741Z      if difficulty_max is not None:
2026-02-20T22:09:12.5469356Z          query = query.filter(LogicChallenge.difficulty_rating <= difficulty_max)
2026-02-20T22:09:12.5469999Z -    
2026-02-20T22:09:12.5470257Z +
2026-02-20T22:09:12.5470504Z      if tags:
2026-02-20T22:09:12.5470848Z          # Recherche partielle dans les tags
2026-02-20T22:09:12.5471444Z          query = query.filter(LogicChallenge.tags.contains(tags))
2026-02-20T22:09:12.5471994Z  
2026-02-20T22:09:12.5472472Z      # Exclure les défis déjà réussis si demandé
2026-02-20T22:09:12.5472942Z      if exclude_ids:
2026-02-20T22:09:12.5473649Z          query = query.filter(LogicChallenge.id.notin_(exclude_ids))
2026-02-20T22:09:12.5474204Z -    
2026-02-20T22:09:12.5474471Z +
2026-02-20T22:09:12.5475026Z      # Ordre : aléatoire par défaut (varier l'entraînement), ou récent
2026-02-20T22:09:12.5475634Z      if order == "recent":
2026-02-20T22:09:12.5475995Z          query = query.order_by(
2026-02-20T22:09:12.5476474Z -            LogicChallenge.created_at.desc().nullslast(),
2026-02-20T22:09:12.5477005Z -            LogicChallenge.id.desc()
2026-02-20T22:09:12.5477668Z +            LogicChallenge.created_at.desc().nullslast(), LogicChallenge.id.desc()
2026-02-20T22:09:12.5478343Z          )
2026-02-20T22:09:12.5478622Z      else:
2026-02-20T22:09:12.5478921Z          from sqlalchemy import func
2026-02-20T22:09:12.5479312Z +
2026-02-20T22:09:12.5479620Z          query = query.order_by(func.random())
2026-02-20T22:09:12.5480055Z -    
2026-02-20T22:09:12.5480316Z +
2026-02-20T22:09:12.5480645Z      return query.offset(offset).limit(limit).all()
2026-02-20T22:09:12.5481114Z  
2026-02-20T22:09:12.5481349Z  
2026-02-20T22:09:12.5481611Z  def count_challenges(
2026-02-20T22:09:12.5481936Z      db: Session,
2026-02-20T22:09:12.5482243Z @@ -295,110 +299,109 @@
2026-02-20T22:09:12.5482592Z      age_group: Optional[str] = None,
2026-02-20T22:09:12.5483319Z      exclude_ids: Optional[List[int]] = None,
2026-02-20T22:09:12.5483770Z  ) -> int:
2026-02-20T22:09:12.5484031Z      """
2026-02-20T22:09:12.5484349Z      Compter les challenges avec filtres.
2026-02-20T22:09:12.5484757Z -    
2026-02-20T22:09:12.5485013Z +
2026-02-20T22:09:12.5485518Z      Args:
2026-02-20T22:09:12.5485815Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5486278Z          challenge_type: Filtrer par type (optionnel)
2026-02-20T22:09:12.5486987Z          age_group: Filtrer par groupe d'âge (optionnel)
2026-02-20T22:09:12.5488009Z          exclude_ids: IDs à exclure du comptage (ex: défis déjà réussis)
2026-02-20T22:09:12.5488605Z -    
2026-02-20T22:09:12.5488861Z +
2026-02-20T22:09:12.5489102Z      Returns:
2026-02-20T22:09:12.5489464Z          Nombre de challenges correspondant aux filtres
2026-02-20T22:09:12.5489934Z      """
2026-02-20T22:09:12.5490432Z      query = db.query(LogicChallenge).filter(LogicChallenge.is_active == True)
2026-02-20T22:09:12.5491054Z -    
2026-02-20T22:09:12.5491319Z +
2026-02-20T22:09:12.5491585Z      if challenge_type:
2026-02-20T22:09:12.5492139Z          query = query.filter(LogicChallenge.challenge_type == challenge_type)
2026-02-20T22:09:12.5492755Z -    
2026-02-20T22:09:12.5493197Z +
2026-02-20T22:09:12.5493468Z      if age_group:
2026-02-20T22:09:12.5493924Z          query = query.filter(LogicChallenge.age_group == age_group)
2026-02-20T22:09:12.5494463Z  
2026-02-20T22:09:12.5494726Z      if exclude_ids:
2026-02-20T22:09:12.5495204Z          query = query.filter(LogicChallenge.id.notin_(exclude_ids))
2026-02-20T22:09:12.5495760Z -    
2026-02-20T22:09:12.5496024Z +
2026-02-20T22:09:12.5496289Z      return query.count()
2026-02-20T22:09:12.5496622Z  
2026-02-20T22:09:12.5496846Z  
2026-02-20T22:09:12.5497115Z  def update_challenge(
2026-02-20T22:09:12.5497443Z -    db: Session,
2026-02-20T22:09:12.5497753Z -    challenge_id: int,
2026-02-20T22:09:12.5498080Z -    **kwargs
2026-02-20T22:09:12.5498410Z +    db: Session, challenge_id: int, **kwargs
2026-02-20T22:09:12.5498888Z  ) -> Optional[LogicChallenge]:
2026-02-20T22:09:12.5499246Z      """
2026-02-20T22:09:12.5499641Z      Mettre à jour un challenge.
2026-02-20T22:09:12.5500014Z -    
2026-02-20T22:09:12.5500268Z +
2026-02-20T22:09:12.5500506Z      Args:
2026-02-20T22:09:12.5500814Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5501197Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5501736Z          **kwargs: Champs à mettre à jour
2026-02-20T22:09:12.5502154Z -    
2026-02-20T22:09:12.5502409Z +
2026-02-20T22:09:12.5502673Z      Returns:
2026-02-20T22:09:12.5503298Z          LogicChallenge mis à jour ou None si non trouvé
2026-02-20T22:09:12.5503779Z      """
2026-02-20T22:09:12.5504113Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5504570Z -    
2026-02-20T22:09:12.5504824Z +
2026-02-20T22:09:12.5505095Z      if not challenge:
2026-02-20T22:09:12.5505421Z          return None
2026-02-20T22:09:12.5505735Z -    
2026-02-20T22:09:12.5505992Z +
2026-02-20T22:09:12.5506379Z      # Mettre à jour les champs fournis
2026-02-20T22:09:12.5506839Z      for key, value in kwargs.items():
2026-02-20T22:09:12.5507286Z          if hasattr(challenge, key):
2026-02-20T22:09:12.5507729Z              setattr(challenge, key, value)
2026-02-20T22:09:12.5508165Z -    
2026-02-20T22:09:12.5508421Z +
2026-02-20T22:09:12.5508771Z      challenge.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:12.5509274Z      db.commit()
2026-02-20T22:09:12.5509584Z      db.refresh(challenge)
2026-02-20T22:09:12.5509931Z -    
2026-02-20T22:09:12.5510177Z +
2026-02-20T22:09:12.5510663Z      logger.info(f"Challenge mis à jour: {challenge.id}")
2026-02-20T22:09:12.5511180Z      return challenge
2026-02-20T22:09:12.5511495Z  
2026-02-20T22:09:12.5511733Z  
2026-02-20T22:09:12.5512140Z  def delete_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:12.5512678Z      """
2026-02-20T22:09:12.5564912Z      Supprimer (soft delete) un challenge.
2026-02-20T22:09:12.5565556Z -    
2026-02-20T22:09:12.5565821Z +
2026-02-20T22:09:12.5566076Z      Args:
2026-02-20T22:09:12.5566372Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5566806Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5567207Z -    
2026-02-20T22:09:12.5567484Z +
2026-02-20T22:09:12.5568113Z      Returns:
2026-02-20T22:09:12.5568701Z          True si supprimé, False sinon
2026-02-20T22:09:12.5569119Z      """
2026-02-20T22:09:12.5569464Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5569928Z -    
2026-02-20T22:09:12.5570182Z +
2026-02-20T22:09:12.5570763Z      if not challenge:
2026-02-20T22:09:12.5571123Z          return False
2026-02-20T22:09:12.5571440Z -    
2026-02-20T22:09:12.5571687Z +
2026-02-20T22:09:12.5571974Z      challenge.is_active = False
2026-02-20T22:09:12.5572346Z      db.commit()
2026-02-20T22:09:12.5572634Z -    
2026-02-20T22:09:12.5572890Z +
2026-02-20T22:09:12.5573737Z      logger.info(f"Challenge supprimé (soft): {challenge.id}")
2026-02-20T22:09:12.5574284Z      return True
2026-02-20T22:09:12.5574580Z  
2026-02-20T22:09:12.5574812Z  
2026-02-20T22:09:12.5575076Z -def get_user_completed_challenges(
2026-02-20T22:09:12.5575492Z -    db: Session,
2026-02-20T22:09:12.5575784Z -    user_id: int
2026-02-20T22:09:12.5576080Z -) -> List[int]:
2026-02-20T22:09:12.5576614Z +def get_user_completed_challenges(db: Session, user_id: int) -> List[int]:
2026-02-20T22:09:12.5577239Z      """
2026-02-20T22:09:12.5577832Z      Récupérer les IDs des challenges complétés par un utilisateur.
2026-02-20T22:09:12.5578400Z -    
2026-02-20T22:09:12.5578649Z +
2026-02-20T22:09:12.5578903Z      Args:
2026-02-20T22:09:12.5579176Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5579566Z          user_id: ID de l'utilisateur
2026-02-20T22:09:12.5579961Z -    
2026-02-20T22:09:12.5580207Z +
2026-02-20T22:09:12.5580455Z      Returns:
2026-02-20T22:09:12.5580892Z          Liste des IDs de challenges complétés
2026-02-20T22:09:12.5581333Z      """
2026-02-20T22:09:12.5581703Z -    attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5582285Z -        LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.5582817Z -        LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:12.5583479Z -    ).all()
2026-02-20T22:09:12.5583757Z -    
2026-02-20T22:09:12.5584030Z +    attempts = (
2026-02-20T22:09:12.5584376Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5584806Z +        .filter(
2026-02-20T22:09:12.5585191Z +            LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.5585733Z +            LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.5586244Z +        )
2026-02-20T22:09:12.5586504Z +        .all()
2026-02-20T22:09:12.5586790Z +    )
2026-02-20T22:09:12.5587031Z +
2026-02-20T22:09:12.5587412Z      return [attempt.challenge_id for attempt in attempts]
2026-02-20T22:09:12.5587915Z  
2026-02-20T22:09:12.5588181Z  
2026-02-20T22:09:12.5588447Z  def record_attempt(
2026-02-20T22:09:12.5588764Z      db: Session,
2026-02-20T22:09:12.5589076Z @@ -408,88 +411,106 @@
2026-02-20T22:09:12.5589401Z      is_correct: bool,
2026-02-20T22:09:12.5589775Z      time_spent_seconds: Optional[int] = None,
2026-02-20T22:09:12.5590252Z  ) -> LogicChallengeAttempt:
2026-02-20T22:09:12.5590626Z      """
2026-02-20T22:09:12.5591077Z      Enregistrer une tentative de résolution.
2026-02-20T22:09:12.5591525Z -    
2026-02-20T22:09:12.5591780Z +
2026-02-20T22:09:12.5592039Z      Args:
2026-02-20T22:09:12.5592329Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5592725Z          user_id: ID de l'utilisateur
2026-02-20T22:09:12.5593473Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5594018Z          user_answer: Réponse fournie
2026-02-20T22:09:12.5594551Z          is_correct: Réponse correcte ou non
2026-02-20T22:09:12.5595154Z          time_spent_seconds: Temps passé (optionnel)
2026-02-20T22:09:12.5595626Z -    
2026-02-20T22:09:12.5595884Z +
2026-02-20T22:09:12.5596140Z      Returns:
2026-02-20T22:09:12.5596552Z          LogicChallengeAttempt créé
2026-02-20T22:09:12.5596950Z      """
2026-02-20T22:09:12.5597261Z      attempt = LogicChallengeAttempt(
2026-02-20T22:09:12.5597677Z          user_id=user_id,
2026-02-20T22:09:12.5598046Z          challenge_id=challenge_id,
2026-02-20T22:09:12.5598450Z          user_answer=user_answer,
2026-02-20T22:09:12.5599127Z          is_correct=is_correct,
2026-02-20T22:09:12.5599551Z          time_spent_seconds=time_spent_seconds,
2026-02-20T22:09:12.5599993Z      )
2026-02-20T22:09:12.5600239Z -    
2026-02-20T22:09:12.5600487Z +
2026-02-20T22:09:12.5600738Z      db.add(attempt)
2026-02-20T22:09:12.5601291Z -    
2026-02-20T22:09:12.5601600Z +
2026-02-20T22:09:12.5602446Z      # Mettre à jour le taux de réussite du challenge (sur chaque tentative, pas seulement les correctes)
2026-02-20T22:09:12.5603512Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5603971Z      if challenge:
2026-02-20T22:09:12.5604555Z          # Requête unique avec agrégation pour total et correct
2026-02-20T22:09:12.5605099Z -        stats = db.query(
2026-02-20T22:09:12.5605588Z -            func.count(LogicChallengeAttempt.id).label('total'),
2026-02-20T22:09:12.5606407Z -            func.count(case((LogicChallengeAttempt.is_correct == True, 1))).label('correct')
2026-02-20T22:09:12.5607138Z -        ).filter(
2026-02-20T22:09:12.5607578Z -            LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5608104Z -        ).first()
2026-02-20T22:09:12.5608395Z -        
2026-02-20T22:09:12.5608656Z +        stats = (
2026-02-20T22:09:12.5608961Z +            db.query(
2026-02-20T22:09:12.5609435Z +                func.count(LogicChallengeAttempt.id).label("total"),
2026-02-20T22:09:12.5610215Z +                func.count(case((LogicChallengeAttempt.is_correct == True, 1))).label(
2026-02-20T22:09:12.5610861Z +                    "correct"
2026-02-20T22:09:12.5611218Z +                ),
2026-02-20T22:09:12.5611512Z +            )
2026-02-20T22:09:12.5611958Z +            .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5612541Z +            .first()
2026-02-20T22:09:12.5612849Z +        )
2026-02-20T22:09:12.5613407Z +
2026-02-20T22:09:12.5613754Z          total_attempts = stats.total if stats else 0
2026-02-20T22:09:12.5614328Z          correct_attempts = stats.correct if stats else 0
2026-02-20T22:09:12.5615183Z -        challenge.success_rate = (correct_attempts / total_attempts) * 100 if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5615971Z -    
2026-02-20T22:09:12.5616279Z +        challenge.success_rate = (
2026-02-20T22:09:12.5616911Z +            (correct_attempts / total_attempts) * 100 if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5617540Z +        )
2026-02-20T22:09:12.5617793Z +
2026-02-20T22:09:12.5618053Z      db.commit()
2026-02-20T22:09:12.5618354Z      db.refresh(attempt)
2026-02-20T22:09:12.5618683Z -    
2026-02-20T22:09:12.5619555Z -    logger.info(f"Tentative enregistrée: Challenge {challenge_id}, User {user_id}, Correct: {is_correct}")
2026-02-20T22:09:12.5620375Z +
2026-02-20T22:09:12.5620616Z +    logger.info(
2026-02-20T22:09:12.5621363Z +        f"Tentative enregistrée: Challenge {challenge_id}, User {user_id}, Correct: {is_correct}"
2026-02-20T22:09:12.5622098Z +    )
2026-02-20T22:09:12.5622359Z      return attempt
2026-02-20T22:09:12.5622655Z  
2026-02-20T22:09:12.5622890Z  
2026-02-20T22:09:12.5623557Z  def get_challenge_stats(db: Session, challenge_id: int) -> Dict[str, Any]:
2026-02-20T22:09:12.5624176Z      """
2026-02-20T22:09:12.5624649Z      Récupérer les statistiques d'un challenge.
2026-02-20T22:09:12.5625139Z -    
2026-02-20T22:09:12.5625409Z +
2026-02-20T22:09:12.5625650Z      Args:
2026-02-20T22:09:12.5625942Z          db: Session SQLAlchemy
2026-02-20T22:09:12.5626356Z          challenge_id: ID du challenge
2026-02-20T22:09:12.5626781Z -    
2026-02-20T22:09:12.5627084Z +
2026-02-20T22:09:12.5627332Z      Returns:
2026-02-20T22:09:12.5627662Z          Dictionnaire avec les statistiques
2026-02-20T22:09:12.5628071Z      """
2026-02-20T22:09:12.5628394Z      challenge = get_challenge(db, challenge_id)
2026-02-20T22:09:12.5628840Z -    
2026-02-20T22:09:12.5629086Z +
2026-02-20T22:09:12.5629340Z      if not challenge:
2026-02-20T22:09:12.5629660Z          return {}
2026-02-20T22:09:12.5629950Z -    
2026-02-20T22:09:12.5630597Z -    total_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5631264Z -        LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5631771Z -    ).count()
2026-02-20T22:09:12.5632051Z -    
2026-02-20T22:09:12.5632655Z -    correct_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:12.5633533Z -        LogicChallengeAttempt.challenge_id == challenge_id,
2026-02-20T22:09:12.5634121Z -        LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:12.5634588Z -    ).count()
2026-02-20T22:09:12.5634857Z -    
2026-02-20T22:09:12.5635293Z -    unique_users = db.query(LogicChallengeAttempt.user_id).filter(
2026-02-20T22:09:12.5636000Z -        LogicChallengeAttempt.challenge_id == challenge_id
2026-02-20T22:09:12.5636536Z -    ).distinct().count()
2026-02-20T22:09:12.5636878Z -    
2026-02-20T22:09:12.5637123Z +
2026-02-20T22:09:12.5637396Z +    total_attempts = (
2026-02-20T22:09:12.5637763Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5638380Z +        .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5638948Z +        .count()
2026-02-20T22:09:12.5639232Z +    )
2026-02-20T22:09:12.5639484Z +
2026-02-20T22:09:12.5639823Z +    correct_attempts = (
2026-02-20T22:09:12.5640224Z +        db.query(LogicChallengeAttempt)
2026-02-20T22:09:12.5640641Z +        .filter(
2026-02-20T22:09:12.5641065Z +            LogicChallengeAttempt.challenge_id == challenge_id,
2026-02-20T22:09:12.5641672Z +            LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.5642140Z +        )
2026-02-20T22:09:12.5642395Z +        .count()
2026-02-20T22:09:12.5642678Z +    )
2026-02-20T22:09:12.5642926Z +
2026-02-20T22:09:12.5643342Z +    unique_users = (
2026-02-20T22:09:12.5643722Z +        db.query(LogicChallengeAttempt.user_id)
2026-02-20T22:09:12.5644338Z +        .filter(LogicChallengeAttempt.challenge_id == challenge_id)
2026-02-20T22:09:12.5644918Z +        .distinct()
2026-02-20T22:09:12.5645220Z +        .count()
2026-02-20T22:09:12.5645511Z +    )
2026-02-20T22:09:12.5645753Z +
2026-02-20T22:09:12.5646004Z      return {
2026-02-20T22:09:12.5646315Z          "challenge_id": challenge_id,
2026-02-20T22:09:12.5646756Z          "title": challenge.title,
2026-02-20T22:09:12.5647186Z          "total_attempts": total_attempts,
2026-02-20T22:09:12.5647660Z          "correct_attempts": correct_attempts,
2026-02-20T22:09:12.5648417Z -        "success_rate": (correct_attempts / total_attempts * 100) if total_attempts > 0 else 0.0,
2026-02-20T22:09:12.5649147Z +        "success_rate": (
2026-02-20T22:09:12.5649670Z +            (correct_attempts / total_attempts * 100) if total_attempts > 0 else 0.0
2026-02-20T22:09:12.5743920Z +        ),
2026-02-20T22:09:12.5744268Z          "unique_users": unique_users,
2026-02-20T22:09:12.5744797Z          "difficulty_rating": challenge.difficulty_rating,
2026-02-20T22:09:12.5745297Z      }
2026-02-20T22:09:12.5745547Z -
2026-02-20T22:09:12.5749729Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py
2026-02-20T22:09:12.5750806Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.5751926Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py	2026-02-20 22:09:12.528805+00:00
2026-02-20T22:09:12.5752651Z @@ -1,9 +1,10 @@
2026-02-20T22:09:12.5752892Z  """
2026-02-20T22:09:12.5753505Z  Service de génération de challenges par IA.
2026-02-20T22:09:12.5754152Z  Extrait la logique de génération streaming depuis challenge_handlers.
2026-02-20T22:09:12.5754679Z  """
2026-02-20T22:09:12.5754914Z +
2026-02-20T22:09:12.5755146Z  import json
2026-02-20T22:09:12.5755413Z  import traceback
2026-02-20T22:09:12.5755712Z  from datetime import datetime
2026-02-20T22:09:12.5756120Z  from typing import Any, AsyncGenerator, Dict, Optional
2026-02-20T22:09:12.5756538Z  
2026-02-20T22:09:12.5756757Z @@ -85,13 +86,15 @@
2026-02-20T22:09:12.5757198Z      params = AGE_GROUP_PARAMS.get(age_group, AGE_GROUP_PARAMS["9-11"])
2026-02-20T22:09:12.5758047Z      age_display = params["display"]
2026-02-20T22:09:12.5758450Z      age_target_phrase = (
2026-02-20T22:09:12.5758772Z          "pour des adultes"
2026-02-20T22:09:12.5759073Z          if age_group == "adulte"
2026-02-20T22:09:12.5759646Z -        else "pour un public de tous âges"
2026-02-20T22:09:12.5760007Z -        if age_group == "tous-ages"
2026-02-20T22:09:12.5760487Z -        else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5760963Z +        else (
2026-02-20T22:09:12.5761375Z +            "pour un public de tous âges"
2026-02-20T22:09:12.5761822Z +            if age_group == "tous-ages"
2026-02-20T22:09:12.5762441Z +            else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5762933Z +        )
2026-02-20T22:09:12.5763406Z      )
2026-02-20T22:09:12.5763652Z  
2026-02-20T22:09:12.5763927Z      visual_adult_rule = ""
2026-02-20T22:09:12.5764387Z      if age_group == "adulte" and challenge_type == "visual":
2026-02-20T22:09:12.5764935Z          visual_adult_rule = """
2026-02-20T22:09:12.5765306Z @@ -396,20 +399,24 @@
2026-02-20T22:09:12.5765614Z  
2026-02-20T22:09:12.5766135Z  Assure-toi que le visual_data est complet et permet une visualisation interactive.
2026-02-20T22:09:12.5767241Z  IMPORTANT : Vérifie TOUJOURS la cohérence logique avant de retourner le JSON."""
2026-02-20T22:09:12.5767898Z  
2026-02-20T22:09:12.5768139Z  
2026-02-20T22:09:12.5768709Z -def build_challenge_user_prompt(challenge_type: str, age_group: str, prompt: str) -> str:
2026-02-20T22:09:12.5769478Z +def build_challenge_user_prompt(
2026-02-20T22:09:12.5769961Z +    challenge_type: str, age_group: str, prompt: str
2026-02-20T22:09:12.5770437Z +) -> str:
2026-02-20T22:09:12.5771031Z      """Construit le prompt utilisateur pour la génération de défis."""
2026-02-20T22:09:12.5771778Z      params = AGE_GROUP_PARAMS.get(age_group, AGE_GROUP_PARAMS["9-11"])
2026-02-20T22:09:12.5772401Z      age_display = params["display"]
2026-02-20T22:09:12.5772837Z      age_target_phrase = (
2026-02-20T22:09:12.5773380Z          "pour des adultes"
2026-02-20T22:09:12.5773751Z          if age_group == "adulte"
2026-02-20T22:09:12.5774260Z -        else "pour un public de tous âges"
2026-02-20T22:09:12.5774753Z -        if age_group == "tous-ages"
2026-02-20T22:09:12.5775346Z -        else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5775832Z +        else (
2026-02-20T22:09:12.5776248Z +            "pour un public de tous âges"
2026-02-20T22:09:12.5776705Z +            if age_group == "tous-ages"
2026-02-20T22:09:12.5777326Z +            else f"pour des enfants/élèves de {age_display}"
2026-02-20T22:09:12.5777812Z +        )
2026-02-20T22:09:12.5778074Z      )
2026-02-20T22:09:12.5778319Z  
2026-02-20T22:09:12.5779026Z      user_prompt = f"""Crée un défi mathélogique de type "{challenge_type}" {age_target_phrase}.
2026-02-20T22:09:12.5779716Z  
2026-02-20T22:09:12.5779999Z  CONTRAINTES OBLIGATOIRES :
2026-02-20T22:09:12.5780369Z @@ -436,17 +443,23 @@
2026-02-20T22:09:12.5780697Z  ) -> Dict[str, Any]:
2026-02-20T22:09:12.5780997Z      """
2026-02-20T22:09:12.5781566Z      Normalise les données générées avec ajustements de difficulté.
2026-02-20T22:09:12.5782142Z      """
2026-02-20T22:09:12.5782459Z      if age_group not in AGE_GROUP_PARAMS:
2026-02-20T22:09:12.5783671Z -        logger.warning(f"Groupe d'âge '{age_group}' non trouvé dans le mapping, utilisation de '9-11' par défaut")
2026-02-20T22:09:12.5784533Z +        logger.warning(
2026-02-20T22:09:12.5785361Z +            f"Groupe d'âge '{age_group}' non trouvé dans le mapping, utilisation de '9-11' par défaut"
2026-02-20T22:09:12.5786083Z +        )
2026-02-20T22:09:12.5786352Z  
2026-02-20T22:09:12.5786628Z      final_age_group = age_group
2026-02-20T22:09:12.5787129Z      ai_difficulty = challenge_data.get("difficulty_rating")
2026-02-20T22:09:12.5787875Z      expected_difficulty = calculate_difficulty_for_age_group(final_age_group)
2026-02-20T22:09:12.5788762Z  
2026-02-20T22:09:12.5789355Z -    if ai_difficulty and isinstance(ai_difficulty, (int, float)) and 1.0 <= ai_difficulty <= 5.0:
2026-02-20T22:09:12.5790100Z +    if (
2026-02-20T22:09:12.5790380Z +        ai_difficulty
2026-02-20T22:09:12.5790778Z +        and isinstance(ai_difficulty, (int, float))
2026-02-20T22:09:12.5791467Z +        and 1.0 <= ai_difficulty <= 5.0
2026-02-20T22:09:12.5791875Z +    ):
2026-02-20T22:09:12.5792238Z          if abs(ai_difficulty - expected_difficulty) > 1.5:
2026-02-20T22:09:12.5792751Z              logger.info(
2026-02-20T22:09:12.5793899Z                  f"Difficulté IA ({ai_difficulty}) ajustée pour groupe d'âge {final_age_group} -> {expected_difficulty}"
2026-02-20T22:09:12.5794746Z              )
2026-02-20T22:09:12.5795101Z              final_difficulty = expected_difficulty
2026-02-20T22:09:12.5795571Z @@ -558,16 +571,23 @@
2026-02-20T22:09:12.5795874Z  
2026-02-20T22:09:12.5796131Z              if use_o1:
2026-02-20T22:09:12.5796618Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5797217Z              elif use_o3:
2026-02-20T22:09:12.5797722Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5798555Z -                api_kwargs["reasoning_effort"] = ai_params.get("reasoning_effort", "medium")
2026-02-20T22:09:12.5799331Z +                api_kwargs["reasoning_effort"] = ai_params.get(
2026-02-20T22:09:12.5799871Z +                    "reasoning_effort", "medium"
2026-02-20T22:09:12.5800307Z +                )
2026-02-20T22:09:12.5800697Z              elif AIConfig.is_gpt5_model(ai_params["model"]):
2026-02-20T22:09:12.5801357Z                  api_kwargs["max_completion_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5802176Z -                api_kwargs["reasoning_effort"] = ai_params.get("reasoning_effort", "medium")
2026-02-20T22:09:12.5802943Z +                api_kwargs["reasoning_effort"] = ai_params.get(
2026-02-20T22:09:12.5803681Z +                    "reasoning_effort", "medium"
2026-02-20T22:09:12.5804118Z +                )
2026-02-20T22:09:12.5804568Z                  api_kwargs["verbosity"] = ai_params.get("verbosity", "low")
2026-02-20T22:09:12.5805370Z -                if ai_params.get("reasoning_effort") == "none" and "temperature" in ai_params:
2026-02-20T22:09:12.5806044Z +                if (
2026-02-20T22:09:12.5806447Z +                    ai_params.get("reasoning_effort") == "none"
2026-02-20T22:09:12.5806972Z +                    and "temperature" in ai_params
2026-02-20T22:09:12.5807412Z +                ):
2026-02-20T22:09:12.5807833Z                      api_kwargs["temperature"] = ai_params["temperature"]
2026-02-20T22:09:12.5808368Z              else:
2026-02-20T22:09:12.5808759Z                  api_kwargs["max_tokens"] = ai_params["max_tokens"]
2026-02-20T22:09:12.5809439Z                  api_kwargs["temperature"] = ai_params.get("temperature", 0.5)
2026-02-20T22:09:12.5810012Z  
2026-02-20T22:09:12.5810262Z @@ -577,12 +597,16 @@
2026-02-20T22:09:12.5810747Z              return await client.chat.completions.create(**api_kwargs)
2026-02-20T22:09:12.5811291Z  
2026-02-20T22:09:12.5811546Z          try:
2026-02-20T22:09:12.5811893Z              stream = await create_stream_with_retry()
2026-02-20T22:09:12.5812547Z          except (RateLimitError, APIError, APITimeoutError) as api_error:
2026-02-20T22:09:12.5813810Z -            logger.error(f"Erreur API OpenAI après {AIConfig.MAX_RETRIES} tentatives: {api_error}")
2026-02-20T22:09:12.5815132Z -            yield sse_error_message(f"Erreur lors de la génération après plusieurs tentatives: {str(api_error)}")
2026-02-20T22:09:12.5815967Z +            logger.error(
2026-02-20T22:09:12.5816734Z +                f"Erreur API OpenAI après {AIConfig.MAX_RETRIES} tentatives: {api_error}"
2026-02-20T22:09:12.5817394Z +            )
2026-02-20T22:09:12.5817701Z +            yield sse_error_message(
2026-02-20T22:09:12.5818505Z +                f"Erreur lors de la génération après plusieurs tentatives: {str(api_error)}"
2026-02-20T22:09:12.5819416Z +            )
2026-02-20T22:09:12.5819700Z              return
2026-02-20T22:09:12.5820053Z          except Exception as unexpected_error:
2026-02-20T22:09:12.5820906Z              logger.error(f"Erreur inattendue lors de la génération: {unexpected_error}")
2026-02-20T22:09:12.5822096Z              yield sse_error_message("Erreur inattendue lors de la génération")
2026-02-20T22:09:12.5822711Z              return
2026-02-20T22:09:12.5823198Z @@ -597,16 +621,22 @@
2026-02-20T22:09:12.5823630Z              if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:12.5824219Z                  content = chunk.choices[0].delta.content
2026-02-20T22:09:12.5824715Z                  full_response += content
2026-02-20T22:09:12.5825256Z                  completion_tokens_estimate = len(full_response) // 4
2026-02-20T22:09:12.5825871Z              if hasattr(chunk, "usage") and chunk.usage:
2026-02-20T22:09:12.5826622Z -                prompt_tokens_estimate = chunk.usage.prompt_tokens or prompt_tokens_estimate
2026-02-20T22:09:12.5827693Z -                completion_tokens_estimate = chunk.usage.completion_tokens or completion_tokens_estimate
2026-02-20T22:09:12.5828516Z +                prompt_tokens_estimate = (
2026-02-20T22:09:12.5829086Z +                    chunk.usage.prompt_tokens or prompt_tokens_estimate
2026-02-20T22:09:12.5829625Z +                )
2026-02-20T22:09:12.5829967Z +                completion_tokens_estimate = (
2026-02-20T22:09:12.5830583Z +                    chunk.usage.completion_tokens or completion_tokens_estimate
2026-02-20T22:09:12.5831158Z +                )
2026-02-20T22:09:12.5831445Z  
2026-02-20T22:09:12.5831845Z          # Fallback si réponse vide (o3)
2026-02-20T22:09:12.5832499Z          if not full_response.strip() and AIConfig.is_o3_model(ai_params["model"]):
2026-02-20T22:09:12.5833728Z -            logger.warning("Réponse vide de o3, fallback vers modèle sans raisonnement...")
2026-02-20T22:09:12.5834439Z +            logger.warning(
2026-02-20T22:09:12.5835124Z +                "Réponse vide de o3, fallback vers modèle sans raisonnement..."
2026-02-20T22:09:12.5835693Z +            )
2026-02-20T22:09:12.5836055Z              fallback_model = AIConfig.ADVANCED_MODEL
2026-02-20T22:09:12.5836507Z              try:
2026-02-20T22:09:12.5836861Z                  fallback_client = AsyncOpenAI(
2026-02-20T22:09:12.5837412Z                      api_key=settings.OPENAI_API_KEY,
2026-02-20T22:09:12.5837951Z                      timeout=ai_params.get("timeout", 120),
2026-02-20T22:09:12.5838425Z @@ -621,15 +651,19 @@
2026-02-20T22:09:12.5838793Z                      max_tokens=ai_params["max_tokens"],
2026-02-20T22:09:12.5839270Z                      temperature=0.4,
2026-02-20T22:09:12.5839647Z                  )
2026-02-20T22:09:12.5840176Z                  if fallback_resp.choices and fallback_resp.choices[0].message.content:
2026-02-20T22:09:12.5840962Z                      full_response = fallback_resp.choices[0].message.content
2026-02-20T22:09:12.5841988Z -                    logger.info(f"Fallback {fallback_model}: {len(full_response)} caractères reçus")
2026-02-20T22:09:12.5842717Z +                    logger.info(
2026-02-20T22:09:12.5843620Z +                        f"Fallback {fallback_model}: {len(full_response)} caractères reçus"
2026-02-20T22:09:12.5844271Z +                    )
2026-02-20T22:09:12.5844618Z              except Exception as fb_err:
2026-02-20T22:09:12.5845212Z                  logger.error(f"Fallback échoué: {fb_err}")
2026-02-20T22:09:12.5845656Z  
2026-02-20T22:09:12.5846445Z -        logger.info(f"Réponse reçue: {len(full_response)} caractères, ~{len(full_response)//4} tokens estimés")
2026-02-20T22:09:12.5847245Z +        logger.info(
2026-02-20T22:09:12.5848020Z +            f"Réponse reçue: {len(full_response)} caractères, ~{len(full_response)//4} tokens estimés"
2026-02-20T22:09:12.5848747Z +        )
2026-02-20T22:09:12.5848999Z  
2026-02-20T22:09:12.5849242Z          try:
2026-02-20T22:09:12.5849896Z              challenge_data = extract_json_from_text(full_response)
2026-02-20T22:09:12.5850506Z          except json.JSONDecodeError as json_error:
2026-02-20T22:09:12.5851101Z              logger.error(f"Erreur de parsing JSON: {json_error}")
2026-02-20T22:09:12.5851627Z @@ -645,40 +679,52 @@
2026-02-20T22:09:12.5852459Z              yield sse_error_message("Erreur lors du parsing de la réponse JSON")
2026-02-20T22:09:12.5853282Z              return
2026-02-20T22:09:12.5853583Z  
2026-02-20T22:09:12.5854068Z          if not challenge_data.get("title") or not challenge_data.get("description"):
2026-02-20T22:09:12.5855062Z              logger.error(f"Données de challenge incomplètes: {challenge_data}")
2026-02-20T22:09:12.5856200Z -            yield sse_error_message("Les données générées sont incomplètes (titre ou description manquant)")
2026-02-20T22:09:12.5857016Z +            yield sse_error_message(
2026-02-20T22:09:12.5857762Z +                "Les données générées sont incomplètes (titre ou description manquant)"
2026-02-20T22:09:12.5858411Z +            )
2026-02-20T22:09:12.5858693Z              return
2026-02-20T22:09:12.5858974Z  
2026-02-20T22:09:12.5859340Z          challenge_data["challenge_type"] = challenge_type
2026-02-20T22:09:12.5859898Z          if challenge_type.lower() == "pattern":
2026-02-20T22:09:12.5860487Z              challenge_data = auto_correct_challenge(challenge_data)
2026-02-20T22:09:12.5861228Z          is_valid, validation_errors = validate_challenge_logic(challenge_data)
2026-02-20T22:09:12.5861844Z  
2026-02-20T22:09:12.5862098Z          if not is_valid:
2026-02-20T22:09:12.5862900Z -            logger.warning(f"Challenge généré avec erreurs de validation: {validation_errors}")
2026-02-20T22:09:12.5863829Z +            logger.warning(
2026-02-20T22:09:12.5864545Z +                f"Challenge généré avec erreurs de validation: {validation_errors}"
2026-02-20T22:09:12.5865156Z +            )
2026-02-20T22:09:12.5865575Z              logger.info("Tentative de correction automatique...")
2026-02-20T22:09:12.5866307Z              corrected_challenge = auto_correct_challenge(challenge_data)
2026-02-20T22:09:12.5867236Z -            is_valid_after_correction, remaining_errors = validate_challenge_logic(corrected_challenge)
2026-02-20T22:09:12.5868262Z +            is_valid_after_correction, remaining_errors = validate_challenge_logic(
2026-02-20T22:09:12.5868928Z +                corrected_challenge
2026-02-20T22:09:12.5869319Z +            )
2026-02-20T22:09:12.5869653Z              if is_valid_after_correction:
2026-02-20T22:09:12.5870295Z                  logger.info("Correction automatique réussie")
2026-02-20T22:09:12.5870867Z                  challenge_data = corrected_challenge
2026-02-20T22:09:12.5871338Z                  auto_corrected = True
2026-02-20T22:09:12.5871779Z                  validation_passed = True
2026-02-20T22:09:12.5872196Z              else:
2026-02-20T22:09:12.5872852Z -                logger.error(f"Correction automatique impossible. Erreurs restantes: {remaining_errors}")
2026-02-20T22:09:12.5873825Z +                logger.error(
2026-02-20T22:09:12.5874460Z +                    f"Correction automatique impossible. Erreurs restantes: {remaining_errors}"
2026-02-20T22:09:12.5875158Z +                )
2026-02-20T22:09:12.5875492Z                  validation_passed = False
2026-02-20T22:09:12.5875997Z                  errors_str = ", ".join(remaining_errors[:2])
2026-02-20T22:09:12.5876828Z                  yield f"data: {json.dumps({'type': 'warning', 'message': f'Avertissement: {errors_str}'})}\n\n"
2026-02-20T22:09:12.5877590Z          else:
2026-02-20T22:09:12.5878082Z              logger.debug("Challenge validé avec succès")
2026-02-20T22:09:12.5878590Z              validation_passed = True
2026-02-20T22:09:12.5878983Z  
2026-02-20T22:09:12.5879607Z -        normalized_challenge = normalize_generated_challenge(challenge_data, challenge_type, age_group)
2026-02-20T22:09:12.5880403Z -
2026-02-20T22:09:12.5880971Z -        if not normalized_challenge.get("title") or not normalized_challenge.get("description"):
2026-02-20T22:09:12.5882063Z +        normalized_challenge = normalize_generated_challenge(
2026-02-20T22:09:12.5882665Z +            challenge_data, challenge_type, age_group
2026-02-20T22:09:12.5883294Z +        )
2026-02-20T22:09:12.5883558Z +
2026-02-20T22:09:12.5884233Z +        if not normalized_challenge.get("title") or not normalized_challenge.get(
2026-02-20T22:09:12.5884929Z +            "description"
2026-02-20T22:09:12.5885266Z +        ):
2026-02-20T22:09:12.5885908Z              logger.error(f"Challenge normalisé invalide: {normalized_challenge}")
2026-02-20T22:09:12.5886866Z              yield sse_error_message("Erreur lors de la normalisation des données")
2026-02-20T22:09:12.5887498Z              return
2026-02-20T22:09:12.5887793Z  
2026-02-20T22:09:12.5888034Z          try:
2026-02-20T22:09:12.5888312Z @@ -692,23 +738,31 @@
2026-02-20T22:09:12.5888730Z                      question=normalized_challenge.get("question"),
2026-02-20T22:09:12.5889405Z                      correct_answer=normalized_challenge["correct_answer"],
2026-02-20T22:09:12.5890181Z                      solution_explanation=normalized_challenge["solution_explanation"],
2026-02-20T22:09:12.5890934Z                      hints=normalized_challenge.get("hints", []),
2026-02-20T22:09:12.5891604Z                      visual_data=normalized_challenge.get("visual_data", {}),
2026-02-20T22:09:12.5892406Z -                    difficulty_rating=normalized_challenge.get("difficulty_rating", 3.0),
2026-02-20T22:09:12.5893564Z -                    estimated_time_minutes=normalized_challenge.get("estimated_time_minutes", 10),
2026-02-20T22:09:12.5894382Z +                    difficulty_rating=normalized_challenge.get(
2026-02-20T22:09:12.5894926Z +                        "difficulty_rating", 3.0
2026-02-20T22:09:12.5895361Z +                    ),
2026-02-20T22:09:12.5895803Z +                    estimated_time_minutes=normalized_challenge.get(
2026-02-20T22:09:12.5896378Z +                        "estimated_time_minutes", 10
2026-02-20T22:09:12.5896828Z +                    ),
2026-02-20T22:09:12.5897290Z                      tags=normalized_challenge.get("tags", "ai,generated"),
2026-02-20T22:09:12.5897860Z                      creator_id=user_id,
2026-02-20T22:09:12.5898315Z                      generation_parameters={
2026-02-20T22:09:12.5898760Z                          "source": "ai",
2026-02-20T22:09:12.5899333Z                          "challenge_type": normalized_challenge["challenge_type"],
2026-02-20T22:09:12.5900021Z                          "age_group": normalized_challenge["age_group"],
2026-02-20T22:09:12.5900625Z                          "model": ai_params.get("model", "unknown"),
2026-02-20T22:09:12.5901120Z                      },
2026-02-20T22:09:12.5901424Z                  )
2026-02-20T22:09:12.5901709Z  
2026-02-20T22:09:12.5902315Z -                if created_challenge and hasattr(created_challenge, "title") and created_challenge.title:
2026-02-20T22:09:12.5903277Z +                if (
2026-02-20T22:09:12.5903608Z +                    created_challenge
2026-02-20T22:09:12.5904086Z +                    and hasattr(created_challenge, "title")
2026-02-20T22:09:12.5904608Z +                    and created_challenge.title
2026-02-20T22:09:12.5905037Z +                ):
2026-02-20T22:09:12.5905425Z                      usage_stats = token_tracker.track_usage(
2026-02-20T22:09:12.5905957Z                          challenge_type=challenge_type,
2026-02-20T22:09:12.5906501Z                          prompt_tokens=prompt_tokens_estimate,
2026-02-20T22:09:12.5907087Z                          completion_tokens=completion_tokens_estimate,
2026-02-20T22:09:12.5907646Z                          model=ai_params["model"],
2026-02-20T22:09:12.5908076Z @@ -732,11 +786,13 @@
2026-02-20T22:09:12.5908378Z                          "challenge_type": (
2026-02-20T22:09:12.5908874Z                              str(created_challenge.challenge_type)
2026-02-20T22:09:12.5909506Z                              if hasattr(created_challenge.challenge_type, "value")
2026-02-20T22:09:12.5910388Z                              else created_challenge.challenge_type
2026-02-20T22:09:12.5910873Z                          ),
2026-02-20T22:09:12.5911668Z -                        "age_group": normalize_age_group_for_frontend(created_challenge.age_group),
2026-02-20T22:09:12.5912498Z +                        "age_group": normalize_age_group_for_frontend(
2026-02-20T22:09:12.5913252Z +                            created_challenge.age_group
2026-02-20T22:09:12.5913721Z +                        ),
2026-02-20T22:09:12.5914133Z                          "question": created_challenge.question,
2026-02-20T22:09:12.5914749Z                          "correct_answer": created_challenge.correct_answer,
2026-02-20T22:09:12.5915499Z                          "solution_explanation": created_challenge.solution_explanation,
2026-02-20T22:09:12.5916205Z                          "hints": created_challenge.hints or [],
2026-02-20T22:09:12.5916816Z                          "visual_data": created_challenge.visual_data or {},
2026-02-20T22:09:12.5917359Z @@ -758,11 +814,13 @@
2026-02-20T22:09:12.5917887Z              logger.error(f"Erreur lors de la sauvegarde du challenge: {db_error}")
2026-02-20T22:09:12.5918572Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:12.5919090Z              if normalized_challenge.get("title"):
2026-02-20T22:09:12.5920322Z                  yield f"data: {json.dumps({'type': 'challenge', 'challenge': normalized_challenge, 'warning': 'Non sauvegardé en base'})}\n\n"
2026-02-20T22:09:12.5921282Z              else:
2026-02-20T22:09:12.5921852Z -                yield sse_error_message("Erreur lors de la sauvegarde et challenge invalide")
2026-02-20T22:09:12.5922579Z +                yield sse_error_message(
2026-02-20T22:09:12.5923296Z +                    "Erreur lors de la sauvegarde et challenge invalide"
2026-02-20T22:09:12.5923826Z +                )
2026-02-20T22:09:12.5924116Z  
2026-02-20T22:09:12.5924473Z          yield f"data: {json.dumps({'type': 'done'})}\n\n"
2026-02-20T22:09:12.5924947Z  
2026-02-20T22:09:12.5925301Z      except Exception as gen_error:
2026-02-20T22:09:12.5925985Z          logger.error(f"Erreur lors de la génération: {gen_error}")
2026-02-20T22:09:12.6881805Z --- /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.6884028Z +++ /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py	2026-02-20 22:09:12.680331+00:00
2026-02-20T22:09:12.6885213Z @@ -32,22 +32,31 @@
2026-02-20T22:09:12.6885812Z  # Type: Callable[[Session, int, dict, Optional[dict]], bool]
2026-02-20T22:09:12.6888982Z  CheckerFn = Callable[[Session, int, Dict[str, Any], Optional[Dict[str, Any]]], bool]
2026-02-20T22:09:12.6889770Z  
2026-02-20T22:09:12.6890026Z  
2026-02-20T22:09:12.6890315Z  def _check_attempts_count(
2026-02-20T22:09:12.6891009Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6891794Z +    db: Session,
2026-02-20T22:09:12.6892116Z +    user_id: int,
2026-02-20T22:09:12.6892448Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6892908Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6893635Z  ) -> bool:
2026-02-20T22:09:12.6894345Z      """Vérifie count(attempts) >= attempts_count."""
2026-02-20T22:09:12.6894900Z      target = req.get("attempts_count")
2026-02-20T22:09:12.6895345Z      if target is None:
2026-02-20T22:09:12.6895716Z          return False
2026-02-20T22:09:12.6896328Z -    count = db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar() or 0
2026-02-20T22:09:12.6897026Z +    count = (
2026-02-20T22:09:12.6897557Z +        db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar()
2026-02-20T22:09:12.6898236Z +        or 0
2026-02-20T22:09:12.6898530Z +    )
2026-02-20T22:09:12.6898837Z      return count >= int(target)
2026-02-20T22:09:12.6899231Z  
2026-02-20T22:09:12.6899966Z  
2026-02-20T22:09:12.6900271Z  def _check_logic_attempts_count(
2026-02-20T22:09:12.6900985Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6901729Z +    db: Session,
2026-02-20T22:09:12.6902038Z +    user_id: int,
2026-02-20T22:09:12.6902682Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6903383Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6903877Z  ) -> bool:
2026-02-20T22:09:12.6904691Z      """Vérifie count(logic_challenge_attempts corrects) >= logic_attempts_count. B5."""
2026-02-20T22:09:12.6905579Z      from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:12.6906156Z  
2026-02-20T22:09:12.6906484Z      target = req.get("logic_attempts_count")
2026-02-20T22:09:12.6906942Z @@ -64,20 +73,26 @@
2026-02-20T22:09:12.6907252Z      )
2026-02-20T22:09:12.6907568Z      return count >= int(target)
2026-02-20T22:09:12.6907942Z  
2026-02-20T22:09:12.6908211Z  
2026-02-20T22:09:12.6908490Z  def _check_mixte(
2026-02-20T22:09:12.6909119Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6909871Z +    db: Session,
2026-02-20T22:09:12.6910179Z +    user_id: int,
2026-02-20T22:09:12.6910510Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6910958Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6911450Z  ) -> bool:
2026-02-20T22:09:12.6912049Z      """Vérifie attempts_count ET logic_attempts_count. B5."""
2026-02-20T22:09:12.6912948Z -    return _check_attempts_count(db, user_id, req, _attempt_data) and _check_logic_attempts_count(
2026-02-20T22:09:12.6913970Z +    return _check_attempts_count(
2026-02-20T22:09:12.6914418Z          db, user_id, req, _attempt_data
2026-02-20T22:09:12.6914841Z -    )
2026-02-20T22:09:12.6915287Z +    ) and _check_logic_attempts_count(db, user_id, req, _attempt_data)
2026-02-20T22:09:12.6915877Z  
2026-02-20T22:09:12.6916129Z  
2026-02-20T22:09:12.6916435Z  def _check_success_rate(
2026-02-20T22:09:12.6917128Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6917884Z +    db: Session,
2026-02-20T22:09:12.6918201Z +    user_id: int,
2026-02-20T22:09:12.6918542Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6919028Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6919530Z  ) -> bool:
2026-02-20T22:09:12.6920154Z      """Vérifie min_attempts atteint ET success_rate >= taux."""
2026-02-20T22:09:12.6920728Z      target = req.get("min_attempts")
2026-02-20T22:09:12.6921177Z      rate = req.get("success_rate")
2026-02-20T22:09:12.6921608Z      if target is None or rate is None:
2026-02-20T22:09:12.6922042Z @@ -94,11 +109,14 @@
2026-02-20T22:09:12.6922494Z      success_pct = (stats[1] / stats[0] * 100) if stats[0] else 0
2026-02-20T22:09:12.6923290Z      return success_pct >= float(rate)
2026-02-20T22:09:12.6923717Z  
2026-02-20T22:09:12.6923963Z  
2026-02-20T22:09:12.6924267Z  def _check_consecutive(
2026-02-20T22:09:12.6924919Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6925756Z +    db: Session,
2026-02-20T22:09:12.6926076Z +    user_id: int,
2026-02-20T22:09:12.6926402Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6926847Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6927345Z  ) -> bool:
2026-02-20T22:09:12.6928019Z      """Vérifie série consécutive de succès pour un type d'exercice."""
2026-02-20T22:09:12.6928697Z      ex_type = req.get("exercise_type", "addition")
2026-02-20T22:09:12.6929263Z      required = req.get("consecutive_correct")
2026-02-20T22:09:12.6929746Z      if required is None:
2026-02-20T22:09:12.6930118Z @@ -126,11 +144,14 @@
2026-02-20T22:09:12.6930435Z              break
2026-02-20T22:09:12.6930742Z      return False
2026-02-20T22:09:12.6931036Z  
2026-02-20T22:09:12.6931292Z  
2026-02-20T22:09:12.6931560Z  def _check_max_time(
2026-02-20T22:09:12.6932635Z -    db: Session, user_id: int, req: Dict[str, Any], attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6933641Z +    db: Session,
2026-02-20T22:09:12.6933966Z +    user_id: int,
2026-02-20T22:09:12.6934303Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6935093Z +    attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6935620Z  ) -> bool:
2026-02-20T22:09:12.6936323Z      """Vérifie au moins une tentative correcte en moins de max_time secondes."""
2026-02-20T22:09:12.6937012Z      max_t = req.get("max_time")
2026-02-20T22:09:12.6937409Z      if max_t is None:
2026-02-20T22:09:12.6937751Z          return False
2026-02-20T22:09:12.6938074Z @@ -148,11 +169,14 @@
2026-02-20T22:09:12.6938393Z      )
2026-02-20T22:09:12.6938690Z      return fast is not None
2026-02-20T22:09:12.6939042Z  
2026-02-20T22:09:12.6939295Z  
2026-02-20T22:09:12.6939579Z  def _check_consecutive_days(
2026-02-20T22:09:12.6940263Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6941001Z +    db: Session,
2026-02-20T22:09:12.6941311Z +    user_id: int,
2026-02-20T22:09:12.6941630Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6942077Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6942538Z  ) -> bool:
2026-02-20T22:09:12.6943292Z      """Vérifie X jours consécutifs d'activité (exercices)."""
2026-02-20T22:09:12.6943856Z      days = req.get("consecutive_days")
2026-02-20T22:09:12.6943985Z      if days is None:
2026-02-20T22:09:12.6944108Z          return False
2026-02-20T22:09:12.6944225Z @@ -180,11 +204,14 @@
2026-02-20T22:09:12.6944350Z              break
2026-02-20T22:09:12.6944485Z      return count >= days
2026-02-20T22:09:12.6944591Z  
2026-02-20T22:09:12.6944704Z  
2026-02-20T22:09:12.6944842Z  def _check_perfect_day(
2026-02-20T22:09:12.6945273Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6945398Z +    db: Session,
2026-02-20T22:09:12.6945543Z +    user_id: int,
2026-02-20T22:09:12.6945677Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6945880Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6946016Z  ) -> bool:
2026-02-20T22:09:12.6946586Z      """Vérifie journée parfaite : tous les exercices du jour réussis, au moins 3."""
2026-02-20T22:09:12.6946793Z      today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.6946934Z      row = db.execute(
2026-02-20T22:09:12.6947056Z          text("""
2026-02-20T22:09:12.6947178Z @@ -198,15 +225,20 @@
2026-02-20T22:09:12.6947300Z          return False
2026-02-20T22:09:12.6947446Z      return row[0] == row[1]
2026-02-20T22:09:12.6947558Z  
2026-02-20T22:09:12.6947663Z  
2026-02-20T22:09:12.6947807Z  def _check_all_types(
2026-02-20T22:09:12.6948235Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6948356Z +    db: Session,
2026-02-20T22:09:12.6948471Z +    user_id: int,
2026-02-20T22:09:12.6948623Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6948829Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6948952Z  ) -> bool:
2026-02-20T22:09:12.6949426Z      """Vérifie que l'utilisateur a essayé tous les types d'exercices."""
2026-02-20T22:09:12.6949574Z      all_types = db.execute(
2026-02-20T22:09:12.6950105Z -        text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.6950233Z +        text(
2026-02-20T22:09:12.6950722Z +            "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.6950836Z +        )
2026-02-20T22:09:12.6950954Z      ).fetchall()
2026-02-20T22:09:12.6951084Z      if not all_types:
2026-02-20T22:09:12.6951207Z          return False
2026-02-20T22:09:12.6951402Z      all_set = {str(r[0]).lower() for r in all_types}
2026-02-20T22:09:12.6951548Z      user_types = db.execute(
2026-02-20T22:09:12.6951669Z @@ -221,11 +253,14 @@
2026-02-20T22:09:12.6952180Z      user_set = {str(r[0]).lower() for r in user_types}
2026-02-20T22:09:12.6952346Z      return all_set.issubset(user_set)
2026-02-20T22:09:12.6952482Z  
2026-02-20T22:09:12.6952590Z  
2026-02-20T22:09:12.6952722Z  def _check_comeback(
2026-02-20T22:09:12.6953574Z -    db: Session, user_id: int, req: Dict[str, Any], attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6953722Z +    db: Session,
2026-02-20T22:09:12.6953845Z +    user_id: int,
2026-02-20T22:09:12.6953979Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6954190Z +    attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6954309Z  ) -> bool:
2026-02-20T22:09:12.6954906Z      """Vérifie si l'utilisateur revient après X jours sans activité (loss aversion)."""
2026-02-20T22:09:12.6955071Z      days = req.get("comeback_days")
2026-02-20T22:09:12.6955249Z      if days is None or attempt_data is None:
2026-02-20T22:09:12.6955371Z          return False
2026-02-20T22:09:12.6955495Z @@ -249,17 +284,22 @@
2026-02-20T22:09:12.6955905Z      delta = (current_dt - prev.created_at).days if hasattr(current_dt, "__sub__") else 0
2026-02-20T22:09:12.6956042Z      return delta >= days
2026-02-20T22:09:12.6956153Z  
2026-02-20T22:09:12.6956268Z  
2026-02-20T22:09:12.6956406Z  def _check_min_per_type(
2026-02-20T22:09:12.6956842Z -    db: Session, user_id: int, req: Dict[str, Any], _attempt_data: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6956970Z +    db: Session,
2026-02-20T22:09:12.6957087Z +    user_id: int,
2026-02-20T22:09:12.6957217Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6957422Z +    _attempt_data: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6957550Z  ) -> bool:
2026-02-20T22:09:12.6957915Z      """Vérifie au moins X exercices réussis par type."""
2026-02-20T22:09:12.6958170Z      min_count = req.get("min_per_type", req.get("min_count", 5))
2026-02-20T22:09:12.6958315Z      min_count = int(min_count)
2026-02-20T22:09:12.6958451Z      all_types = db.execute(
2026-02-20T22:09:12.6958979Z -        text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.6959119Z +        text(
2026-02-20T22:09:12.6959618Z +            "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.6959736Z +        )
2026-02-20T22:09:12.6959875Z      ).fetchall()
2026-02-20T22:09:12.6960014Z      if not all_types:
2026-02-20T22:09:12.6960138Z          return False
2026-02-20T22:09:12.6960261Z      for r in all_types:
2026-02-20T22:09:12.6960392Z          ex_type = str(r[0])
2026-02-20T22:09:12.6960518Z @@ -310,11 +350,15 @@
2026-02-20T22:09:12.6960663Z      # logic_attempts_count seul
2026-02-20T22:09:12.6979486Z      if "logic_attempts_count" in keys:
2026-02-20T22:09:12.6979707Z          return "logic_attempts_count"
2026-02-20T22:09:12.6979824Z  
2026-02-20T22:09:12.6980114Z      # attempts_count seul (pas de consecutive_correct, etc.)
2026-02-20T22:09:12.6980606Z -    if "attempts_count" in keys and "consecutive_correct" not in keys and "success_rate" not in keys:
2026-02-20T22:09:12.6980741Z +    if (
2026-02-20T22:09:12.6980900Z +        "attempts_count" in keys
2026-02-20T22:09:12.6981076Z +        and "consecutive_correct" not in keys
2026-02-20T22:09:12.6981222Z +        and "success_rate" not in keys
2026-02-20T22:09:12.6981344Z +    ):
2026-02-20T22:09:12.6981503Z          return "attempts_count"
2026-02-20T22:09:12.6981611Z  
2026-02-20T22:09:12.6981734Z      # success_rate
2026-02-20T22:09:12.6981979Z      if "min_attempts" in keys and "success_rate" in keys:
2026-02-20T22:09:12.6982123Z          return "success_rate"
2026-02-20T22:09:12.6982251Z @@ -375,31 +419,41 @@
2026-02-20T22:09:12.6982361Z  
2026-02-20T22:09:12.6982536Z  # --- Progress getters (Lot C-2) ---
2026-02-20T22:09:12.6982951Z  # Type: Callable[[Session, int, Dict, Optional[Dict]], Optional[tuple[float, int, int]]]
2026-02-20T22:09:12.6983871Z  # stats_cache évite N+1 quand get_badges_progress pré-fetch les stats
2026-02-20T22:09:12.6984344Z  ProgressFn = Callable[
2026-02-20T22:09:12.6984794Z -    [Session, int, Dict[str, Any], Optional[Dict[str, Any]]], Optional[tuple[float, int, int]]
2026-02-20T22:09:12.6985065Z +    [Session, int, Dict[str, Any], Optional[Dict[str, Any]]],
2026-02-20T22:09:12.6985248Z +    Optional[tuple[float, int, int]],
2026-02-20T22:09:12.6985626Z  ]
2026-02-20T22:09:12.6985759Z  
2026-02-20T22:09:12.6985863Z  
2026-02-20T22:09:12.6986049Z  def _progress_attempts_count(
2026-02-20T22:09:12.6986438Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6986563Z +    db: Session,
2026-02-20T22:09:12.6986693Z +    user_id: int,
2026-02-20T22:09:12.6986828Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6987000Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6987161Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6987317Z      t = req.get("attempts_count")
2026-02-20T22:09:12.6987430Z      if t is None:
2026-02-20T22:09:12.6987562Z          return None
2026-02-20T22:09:12.6987689Z      t = int(t)
2026-02-20T22:09:12.6987913Z      if cache is not None and "attempts_count" in cache:
2026-02-20T22:09:12.6988064Z          c = cache["attempts_count"]
2026-02-20T22:09:12.6988182Z      else:
2026-02-20T22:09:12.6988623Z -        c = db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar() or 0
2026-02-20T22:09:12.6988755Z +        c = (
2026-02-20T22:09:12.6989125Z +            db.query(func.count(Attempt.id)).filter(Attempt.user_id == user_id).scalar()
2026-02-20T22:09:12.6989251Z +            or 0
2026-02-20T22:09:12.6989363Z +        )
2026-02-20T22:09:12.6989506Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.6989656Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.6989760Z  
2026-02-20T22:09:12.6989863Z  
2026-02-20T22:09:12.6990019Z  def _progress_logic_attempts_count(
2026-02-20T22:09:12.6990404Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6990535Z +    db: Session,
2026-02-20T22:09:12.6990652Z +    user_id: int,
2026-02-20T22:09:12.6990793Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6990960Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6991119Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6991412Z      from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:12.6991532Z  
2026-02-20T22:09:12.6991692Z      t = req.get("logic_attempts_count")
2026-02-20T22:09:12.6991815Z      if t is None:
2026-02-20T22:09:12.6991951Z @@ -408,20 +462,26 @@
2026-02-20T22:09:12.6992189Z      if cache is not None and "logic_correct_count" in cache:
2026-02-20T22:09:12.6992345Z          c = cache["logic_correct_count"]
2026-02-20T22:09:12.6992459Z      else:
2026-02-20T22:09:12.6992581Z          c = (
2026-02-20T22:09:12.6992811Z              db.query(func.count(LogicChallengeAttempt.id))
2026-02-20T22:09:12.6993513Z -            .filter(LogicChallengeAttempt.user_id == user_id, LogicChallengeAttempt.is_correct == True)
2026-02-20T22:09:12.6993658Z +            .filter(
2026-02-20T22:09:12.6993865Z +                LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:12.6994069Z +                LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:12.6994190Z +            )
2026-02-20T22:09:12.6994319Z              .scalar()
2026-02-20T22:09:12.6994432Z              or 0
2026-02-20T22:09:12.6994541Z          )
2026-02-20T22:09:12.6994692Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.6994834Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.6994943Z  
2026-02-20T22:09:12.6995056Z  
2026-02-20T22:09:12.6995191Z  def _progress_mixte(
2026-02-20T22:09:12.6995542Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6995652Z +    db: Session,
2026-02-20T22:09:12.6995769Z +    user_id: int,
2026-02-20T22:09:12.6995893Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6996052Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6996462Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6996696Z      p1 = _progress_attempts_count(db, user_id, req, cache)
2026-02-20T22:09:12.6996957Z      p2 = _progress_logic_attempts_count(db, user_id, req, cache)
2026-02-20T22:09:12.6997106Z      if not p1 or not p2:
2026-02-20T22:09:12.6997448Z          return None
2026-02-20T22:09:12.6997584Z @@ -432,11 +492,14 @@
2026-02-20T22:09:12.6997750Z          return (round(prog, 2), cur1, tgt1)
2026-02-20T22:09:12.6997918Z      return (round(prog, 2), cur2, tgt2)
2026-02-20T22:09:12.6998024Z  
2026-02-20T22:09:12.6998134Z  
2026-02-20T22:09:12.6998294Z  def _progress_success_rate(
2026-02-20T22:09:12.6998672Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.6998796Z +    db: Session,
2026-02-20T22:09:12.6998916Z +    user_id: int,
2026-02-20T22:09:12.6999054Z +    req: Dict[str, Any],
2026-02-20T22:09:12.6999219Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.6999388Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.6999546Z      t = req.get("min_attempts")
2026-02-20T22:09:12.6999692Z      rate = req.get("success_rate")
2026-02-20T22:09:12.6999866Z      if t is None or rate is None:
2026-02-20T22:09:12.7000014Z          return None
2026-02-20T22:09:12.7000156Z @@ -444,11 +507,13 @@
2026-02-20T22:09:12.7000536Z      if cache is not None and "attempts_total" in cache and "attempts_correct" in cache:
2026-02-20T22:09:12.7000695Z          total = cache["attempts_total"]
2026-02-20T22:09:12.7000863Z          correct = cache["attempts_correct"]
2026-02-20T22:09:12.7000979Z      else:
2026-02-20T22:09:12.7001111Z          row = db.execute(
2026-02-20T22:09:12.7001635Z -            text("SELECT COUNT(*), COUNT(CASE WHEN is_correct THEN 1 END) FROM attempts WHERE user_id = :user_id"),
2026-02-20T22:09:12.7001757Z +            text(
2026-02-20T22:09:12.7002237Z +                "SELECT COUNT(*), COUNT(CASE WHEN is_correct THEN 1 END) FROM attempts WHERE user_id = :user_id"
2026-02-20T22:09:12.7002358Z +            ),
2026-02-20T22:09:12.7002510Z              {"user_id": user_id},
2026-02-20T22:09:12.7002634Z          ).fetchone()
2026-02-20T22:09:12.7002777Z          total = row[0] if row else 0
2026-02-20T22:09:12.7002927Z          correct = row[1] if row else 0
2026-02-20T22:09:12.7013569Z      p = min(1.0, total / max(1, t)) if total else 0.0
2026-02-20T22:09:12.7013726Z @@ -456,18 +521,25 @@
2026-02-20T22:09:12.7013846Z          p = 1.0
2026-02-20T22:09:12.7014004Z      return (round(p, 2), total, t)
2026-02-20T22:09:12.7014115Z  
2026-02-20T22:09:12.7014222Z  
2026-02-20T22:09:12.7014382Z  def _progress_consecutive(
2026-02-20T22:09:12.7014769Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7014892Z +    db: Session,
2026-02-20T22:09:12.7015018Z +    user_id: int,
2026-02-20T22:09:12.7015150Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7015322Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7015491Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7015760Z      ex_type = str(req.get("exercise_type", "addition")).lower()
2026-02-20T22:09:12.7015922Z      t = req.get("consecutive_correct")
2026-02-20T22:09:12.7016037Z      if t is None:
2026-02-20T22:09:12.7016167Z          return None
2026-02-20T22:09:12.7016282Z      t = int(t)
2026-02-20T22:09:12.7016781Z -    if cache is not None and "consecutive_by_type" in cache and ex_type in cache["consecutive_by_type"]:
2026-02-20T22:09:12.7016896Z +    if (
2026-02-20T22:09:12.7017038Z +        cache is not None
2026-02-20T22:09:12.7017196Z +        and "consecutive_by_type" in cache
2026-02-20T22:09:12.7017397Z +        and ex_type in cache["consecutive_by_type"]
2026-02-20T22:09:12.7017520Z +    ):
2026-02-20T22:09:12.7017724Z          streak = cache["consecutive_by_type"][ex_type]
2026-02-20T22:09:12.7017836Z      else:
2026-02-20T22:09:12.7017969Z          rows = db.execute(
2026-02-20T22:09:12.7018100Z              text("""
2026-02-20T22:09:12.7018602Z                  SELECT a.is_correct FROM attempts a
2026-02-20T22:09:12.7018730Z @@ -486,11 +558,14 @@
2026-02-20T22:09:12.7018883Z      p = min(1.0, streak / max(1, t))
2026-02-20T22:09:12.7019031Z      return (round(p, 2), streak, t)
2026-02-20T22:09:12.7019137Z  
2026-02-20T22:09:12.7019259Z  
2026-02-20T22:09:12.7019659Z  def _progress_consecutive_days(
2026-02-20T22:09:12.7020077Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7020202Z +    db: Session,
2026-02-20T22:09:12.7020338Z +    user_id: int,
2026-02-20T22:09:12.7020474Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7020640Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7020807Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7020962Z      t = req.get("consecutive_days")
2026-02-20T22:09:12.7021083Z      if t is None:
2026-02-20T22:09:12.7021204Z          return None
2026-02-20T22:09:12.7021328Z      t = int(t)
2026-02-20T22:09:12.7021456Z @@ -517,30 +592,42 @@
2026-02-20T22:09:12.7021591Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.7021738Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.7021845Z  
2026-02-20T22:09:12.7021950Z  
2026-02-20T22:09:12.7022092Z  def _progress_max_time(
2026-02-20T22:09:12.7022489Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7022612Z +    db: Session,
2026-02-20T22:09:12.7022731Z +    user_id: int,
2026-02-20T22:09:12.7022872Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7023257Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7023430Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7023569Z      max_t = req.get("max_time")
2026-02-20T22:09:12.7023698Z      if max_t is None:
2026-02-20T22:09:12.7023820Z          return None
2026-02-20T22:09:12.7024254Z      max_t = float(max_t)
2026-02-20T22:09:12.7025832Z      if cache is not None and "min_fast_time" in cache:
2026-02-20T22:09:12.7026231Z -        has_fast = cache["min_fast_time"] is not None and cache["min_fast_time"] <= max_t
2026-02-20T22:09:12.7026365Z +        has_fast = (
2026-02-20T22:09:12.7026689Z +            cache["min_fast_time"] is not None and cache["min_fast_time"] <= max_t
2026-02-20T22:09:12.7026803Z +        )
2026-02-20T22:09:12.7026923Z      else:
2026-02-20T22:09:12.7027044Z          fast = (
2026-02-20T22:09:12.7027190Z              db.query(Attempt)
2026-02-20T22:09:12.7027797Z -            .filter(Attempt.user_id == user_id, Attempt.is_correct == True, Attempt.time_spent <= max_t)
2026-02-20T22:09:12.7028510Z +            .filter(
2026-02-20T22:09:12.7028714Z +                Attempt.user_id == user_id,
2026-02-20T22:09:12.7028871Z +                Attempt.is_correct == True,
2026-02-20T22:09:12.7029035Z +                Attempt.time_spent <= max_t,
2026-02-20T22:09:12.7029165Z +            )
2026-02-20T22:09:12.7029426Z              .first()
2026-02-20T22:09:12.7029541Z          )
2026-02-20T22:09:12.7031109Z          has_fast = fast is not None
2026-02-20T22:09:12.7031381Z      return (1.0, 1, 1) if has_fast else (0.0, 0, 1)
2026-02-20T22:09:12.7035435Z  
2026-02-20T22:09:12.7035590Z  
2026-02-20T22:09:12.7035771Z  def _progress_perfect_day(
2026-02-20T22:09:12.7036179Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7036304Z +    db: Session,
2026-02-20T22:09:12.7036424Z +    user_id: int,
2026-02-20T22:09:12.7036567Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7036736Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7036898Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7037143Z      if cache is not None and "perfect_day_today" in cache:
2026-02-20T22:09:12.7037339Z          total, correct = cache["perfect_day_today"]
2026-02-20T22:09:12.7037455Z      else:
2026-02-20T22:09:12.7037644Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.7037773Z @@ -557,18 +644,27 @@
2026-02-20T22:09:12.7037902Z          return (0.0, 0, 1)
2026-02-20T22:09:12.7038423Z      return (1.0, 1, 1) if total == correct else (0.0, 0, 1)
2026-02-20T22:09:12.7038537Z  
2026-02-20T22:09:12.7038643Z  
2026-02-20T22:09:12.7038787Z  def _progress_all_types(
2026-02-20T22:09:12.7039398Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7039597Z -) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7040005Z -    if cache is not None and "exercise_types" in cache and "user_exercise_types" in cache:
2026-02-20T22:09:12.7040139Z +    db: Session,
2026-02-20T22:09:12.7040258Z +    user_id: int,
2026-02-20T22:09:12.7040388Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7040563Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7040721Z +) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7040832Z +    if (
2026-02-20T22:09:12.7040961Z +        cache is not None
2026-02-20T22:09:12.7041126Z +        and "exercise_types" in cache
2026-02-20T22:09:12.7041278Z +        and "user_exercise_types" in cache
2026-02-20T22:09:12.7041401Z +    ):
2026-02-20T22:09:12.7041587Z          all_set = set(cache["exercise_types"])
2026-02-20T22:09:12.7041762Z          user_set = cache["user_exercise_types"]
2026-02-20T22:09:12.7041874Z      else:
2026-02-20T22:09:12.7042015Z          all_rows = db.execute(
2026-02-20T22:09:12.7042558Z -            text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.7042678Z +            text(
2026-02-20T22:09:12.7043398Z +                "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.7043527Z +            )
2026-02-20T22:09:12.7043654Z          ).fetchall()
2026-02-20T22:09:12.7043776Z          if not all_rows:
2026-02-20T22:09:12.7043908Z              return None
2026-02-20T22:09:12.7044106Z          all_set = {str(r[0]).lower() for r in all_rows}
2026-02-20T22:09:12.7044243Z          user_rows = db.execute(
2026-02-20T22:09:12.7044373Z @@ -586,44 +682,52 @@
2026-02-20T22:09:12.7044511Z      p = min(1.0, c / max(1, t))
2026-02-20T22:09:12.7044649Z      return (round(p, 2), c, t)
2026-02-20T22:09:12.7044761Z  
2026-02-20T22:09:12.7044875Z  
2026-02-20T22:09:12.7045006Z  def _progress_comeback(
2026-02-20T22:09:12.7045407Z -    _db: Session, _user_id: int, req: Dict[str, Any], _cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7045522Z +    _db: Session,
2026-02-20T22:09:12.7045649Z +    _user_id: int,
2026-02-20T22:09:12.7045783Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7045956Z +    _cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7046121Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7046378Z      """Comeback : pas de progression affichable (surprise)."""
2026-02-20T22:09:12.7046523Z      if "comeback_days" not in req:
2026-02-20T22:09:12.7046652Z          return None
2026-02-20T22:09:12.7046768Z      return (0.0, 0, 1)
2026-02-20T22:09:12.7046869Z  
2026-02-20T22:09:12.7046959Z  
2026-02-20T22:09:12.7047117Z  def _progress_min_per_type(
2026-02-20T22:09:12.7047473Z -    db: Session, user_id: int, req: Dict[str, Any], cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.7047585Z +    db: Session,
2026-02-20T22:09:12.7047699Z +    user_id: int,
2026-02-20T22:09:12.7047827Z +    req: Dict[str, Any],
2026-02-20T22:09:12.7047990Z +    cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.7048139Z  ) -> Optional[tuple[float, int, int]]:
2026-02-20T22:09:12.7048436Z      min_count = int(req.get("min_per_type", req.get("min_count", 5)))
2026-02-20T22:09:12.7048815Z      if cache is not None and "exercise_types" in cache and "per_type_correct" in cache:
2026-02-20T22:09:12.7048993Z          types_list = cache["exercise_types"]
2026-02-20T22:09:12.7049167Z          per_type = cache["per_type_correct"]
2026-02-20T22:09:12.7049448Z          min_cur = min((per_type.get(t, 0) for t in types_list), default=0)
2026-02-20T22:09:12.7049563Z      else:
2026-02-20T22:09:12.7049708Z          all_rows = db.execute(
2026-02-20T22:09:12.7050582Z -            text("SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false")
2026-02-20T22:09:12.7050713Z +            text(
2026-02-20T22:09:12.7051408Z +                "SELECT DISTINCT exercise_type FROM exercises WHERE is_active = true AND is_archived = false"
2026-02-20T22:09:12.7051551Z +            )
2026-02-20T22:09:12.7051680Z          ).fetchall()
2026-02-20T22:09:12.7051802Z          if not all_rows:
2026-02-20T22:09:12.7051926Z              return None
2026-02-20T22:09:12.7052058Z          min_cur = float("inf")
2026-02-20T22:09:12.7052189Z          for r in all_rows:
2026-02-20T22:09:12.7052344Z              ex_type = str(r[0]).lower()
2026-02-20T22:09:12.7052478Z              cnt = db.execute(
2026-02-20T22:09:12.7052605Z -                    text("""
2026-02-20T22:09:12.7052720Z +                text("""
2026-02-20T22:09:12.7052915Z                          SELECT COUNT(*) FROM attempts a
2026-02-20T22:09:12.7053363Z                          JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.7055447Z                          WHERE a.user_id = :user_id AND LOWER(e.exercise_type::text) = LOWER(:ex_type)
2026-02-20T22:09:12.7056287Z                          AND a.is_correct = true
2026-02-20T22:09:12.7057590Z                      """),
2026-02-20T22:09:12.7057836Z -                    {"user_id": user_id, "ex_type": ex_type},
2026-02-20T22:09:12.7143733Z -                ).fetchone()
2026-02-20T22:09:12.7144052Z +                {"user_id": user_id, "ex_type": ex_type},
2026-02-20T22:09:12.7144192Z +            ).fetchone()
2026-02-20T22:09:12.7144339Z              c = cnt[0] if cnt else 0
2026-02-20T22:09:12.7144495Z              min_cur = min(min_cur, c)
2026-02-20T22:09:12.7144745Z          min_cur = int(min_cur) if min_cur != float("inf") else 0
2026-02-20T22:09:12.7144865Z      t = min_count
2026-02-20T22:09:12.7145153Z      min_cur = int(min_cur) if isinstance(min_cur, float) else min_cur
2026-02-20T22:09:12.7145757Z would reformat /home/runner/work/mathakine/mathakine/app/services/badge_requirement_engine.py
2026-02-20T22:09:12.8794257Z --- /home/runner/work/mathakine/mathakine/app/services/badge_service.py	2026-02-20 22:09:02.810965+00:00
2026-02-20T22:09:12.8795564Z +++ /home/runner/work/mathakine/mathakine/app/services/badge_service.py	2026-02-20 22:09:12.865127+00:00
2026-02-20T22:09:12.8796325Z @@ -15,78 +15,95 @@
2026-02-20T22:09:12.8796712Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.8797346Z  from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:12.8797980Z  from app.models.attempt import Attempt
2026-02-20T22:09:12.8798422Z  from app.models.progress import Progress
2026-02-20T22:09:12.8798865Z  from app.models.user import User
2026-02-20T22:09:12.8799574Z -from app.services.badge_requirement_engine import check_requirements, get_requirement_progress
2026-02-20T22:09:12.8800437Z +from app.services.badge_requirement_engine import (
2026-02-20T22:09:12.8800920Z +    check_requirements,
2026-02-20T22:09:12.8801280Z +    get_requirement_progress,
2026-02-20T22:09:12.8801619Z +)
2026-02-20T22:09:12.8801841Z  
2026-02-20T22:09:12.8802093Z  logger = get_logger(__name__)
2026-02-20T22:09:12.8802412Z +
2026-02-20T22:09:12.8802633Z  
2026-02-20T22:09:12.8802910Z  class BadgeService:
2026-02-20T22:09:12.8803547Z      """Service pour la gestion des badges et achievements"""
2026-02-20T22:09:12.8804057Z -    
2026-02-20T22:09:12.8804318Z +
2026-02-20T22:09:12.8804613Z      def __init__(self, db: Session):
2026-02-20T22:09:12.8805030Z          self.db = db
2026-02-20T22:09:12.8805338Z -    
2026-02-20T22:09:12.8806021Z -    def check_and_award_badges(self, user_id: int, attempt_data: Dict[str, Any] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.8806846Z +
2026-02-20T22:09:12.8807121Z +    def check_and_award_badges(
2026-02-20T22:09:12.8807628Z +        self, user_id: int, attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8808186Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.8808971Z          """
2026-02-20T22:09:12.8809760Z          Vérifier et attribuer les badges mérités par un utilisateur
2026-02-20T22:09:12.8810322Z -        
2026-02-20T22:09:12.8810590Z +
2026-02-20T22:09:12.8810833Z          Args:
2026-02-20T22:09:12.8811385Z              user_id: ID de l'utilisateur
2026-02-20T22:09:12.8812121Z              attempt_data: Données de la dernière tentative (optionnel)
2026-02-20T22:09:12.8812688Z -            
2026-02-20T22:09:12.8813146Z +
2026-02-20T22:09:12.8813407Z          Returns:
2026-02-20T22:09:12.8813820Z              Liste des nouveaux badges obtenus
2026-02-20T22:09:12.8814248Z          """
2026-02-20T22:09:12.8814523Z          try:
2026-02-20T22:09:12.8814950Z              user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.8815516Z              if not user:
2026-02-20T22:09:12.8816116Z                  logger.error(f"Utilisateur {user_id} non trouvé")
2026-02-20T22:09:12.8816646Z                  return []
2026-02-20T22:09:12.8816986Z -            
2026-02-20T22:09:12.8817260Z +
2026-02-20T22:09:12.8817680Z              # Récupérer tous les badges disponibles
2026-02-20T22:09:12.8818281Z -            available_badges = self.db.query(Achievement).filter(
2026-02-20T22:09:12.8818853Z -                Achievement.is_active == True
2026-02-20T22:09:12.8819273Z -            ).all()
2026-02-20T22:09:12.8819573Z -            
2026-02-20T22:09:12.8819864Z +            available_badges = (
2026-02-20T22:09:12.8820467Z +                self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.8821089Z +            )
2026-02-20T22:09:12.8821356Z +
2026-02-20T22:09:12.8821823Z              # Récupérer les badges déjà obtenus - CORRECTION
2026-02-20T22:09:12.8822336Z              earned_badge_ids = set(
2026-02-20T22:09:12.8830842Z -                badge_id[0] for badge_id in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.8832556Z +                badge_id[0]
2026-02-20T22:09:12.8833481Z +                for badge_id in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.8834169Z                  .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:12.8834663Z                  .all()
2026-02-20T22:09:12.8834970Z              )
2026-02-20T22:09:12.8835261Z -            
2026-02-20T22:09:12.8835525Z +
2026-02-20T22:09:12.8835798Z              new_badges = []
2026-02-20T22:09:12.8836145Z -            
2026-02-20T22:09:12.8836405Z +
2026-02-20T22:09:12.8836692Z              for badge in available_badges:
2026-02-20T22:09:12.8837161Z                  if badge.id not in earned_badge_ids:
2026-02-20T22:09:12.8837794Z                      if self._check_badge_requirements(user_id, badge, attempt_data):
2026-02-20T22:09:12.8838484Z                          new_badge = self._award_badge(user_id, badge)
2026-02-20T22:09:12.8838994Z                          if new_badge:
2026-02-20T22:09:12.8839438Z                              new_badges.append(new_badge)
2026-02-20T22:09:12.8840406Z -                            logger.info(f"🎖️ Badge '{badge.name}' attribué à l'utilisateur {user_id}")
2026-02-20T22:09:12.8841096Z -            
2026-02-20T22:09:12.8841401Z +                            logger.info(
2026-02-20T22:09:12.8842157Z +                                f"🎖️ Badge '{badge.name}' attribué à l'utilisateur {user_id}"
2026-02-20T22:09:12.8842753Z +                            )
2026-02-20T22:09:12.8843266Z +
2026-02-20T22:09:12.8843677Z              # Mettre à jour les points et le niveau
2026-02-20T22:09:12.8844135Z              if new_badges:
2026-02-20T22:09:12.8844563Z                  self._update_user_gamification(user_id, new_badges)
2026-02-20T22:09:12.8845068Z -            
2026-02-20T22:09:12.8845340Z +
2026-02-20T22:09:12.8845600Z              return new_badges
2026-02-20T22:09:12.8845942Z -            
2026-02-20T22:09:12.8846197Z +
2026-02-20T22:09:12.8846500Z          except Exception as badge_check_error:
2026-02-20T22:09:12.8847553Z -            logger.error(f"Erreur lors de la vérification des badges pour l'utilisateur {user_id}: {badge_check_error}")
2026-02-20T22:09:12.8848704Z +            logger.error(
2026-02-20T22:09:12.8849580Z +                f"Erreur lors de la vérification des badges pour l'utilisateur {user_id}: {badge_check_error}"
2026-02-20T22:09:12.8850563Z +            )
2026-02-20T22:09:12.8850869Z              return []
2026-02-20T22:09:12.8851174Z -    
2026-02-20T22:09:12.8851982Z would reformat /home/runner/work/mathakine/mathakine/app/services/badge_service.py
2026-02-20T22:09:12.8853436Z -    def _check_badge_requirements(self, user_id: int, badge: Achievement, attempt_data: Dict[str, Any] = None) -> bool:
2026-02-20T22:09:12.8854296Z +
2026-02-20T22:09:12.8854569Z +    def _check_badge_requirements(
2026-02-20T22:09:12.8855175Z +        self, user_id: int, badge: Achievement, attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8855791Z +    ) -> bool:
2026-02-20T22:09:12.8856391Z          """Vérifier si un utilisateur remplit les conditions pour un badge.
2026-02-20T22:09:12.8857343Z          Lot C : moteur générique d'abord, fallback par code pour rétrocompatibilité.
2026-02-20T22:09:12.8857957Z          """
2026-02-20T22:09:12.8858263Z          if not badge.requirements:
2026-02-20T22:09:12.8858652Z              return False
2026-02-20T22:09:12.8858986Z  
2026-02-20T22:09:12.8859233Z          try:
2026-02-20T22:09:12.8859977Z -            requirements = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.8860869Z +            requirements = (
2026-02-20T22:09:12.8861264Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.8861769Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.8862250Z +                else badge.requirements
2026-02-20T22:09:12.8862645Z +            )
2026-02-20T22:09:12.8863246Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.8864649Z              logger.error(f"Requirements invalides pour le badge {badge.code}")
2026-02-20T22:09:12.8923475Z              return False
2026-02-20T22:09:12.8923844Z  
2026-02-20T22:09:12.8924184Z          if not isinstance(requirements, dict):
2026-02-20T22:09:12.8924663Z @@ -96,483 +113,566 @@
2026-02-20T22:09:12.8925256Z          result = check_requirements(self.db, user_id, requirements, attempt_data)
2026-02-20T22:09:12.8925944Z          if result is not None:
2026-02-20T22:09:12.8926346Z              return result
2026-02-20T22:09:12.8926687Z  
2026-02-20T22:09:12.8927389Z          # Fallback par code pour rétrocompatibilité (badges sans schéma reconnu)
2026-02-20T22:09:12.8928428Z -        return self._check_badge_requirements_by_code(user_id, badge, requirements, attempt_data)
2026-02-20T22:09:12.8929296Z +        return self._check_badge_requirements_by_code(
2026-02-20T22:09:12.8929870Z +            user_id, badge, requirements, attempt_data
2026-02-20T22:09:12.8930330Z +        )
2026-02-20T22:09:12.8930606Z  
2026-02-20T22:09:12.8930926Z      def _check_badge_requirements_by_code(
2026-02-20T22:09:12.8931797Z -        self, user_id: int, badge: Achievement, requirements: Dict[str, Any], attempt_data: Dict[str, Any] = None
2026-02-20T22:09:12.8932664Z +        self,
2026-02-20T22:09:12.8933155Z +        user_id: int,
2026-02-20T22:09:12.8933538Z +        badge: Achievement,
2026-02-20T22:09:12.8933915Z +        requirements: Dict[str, Any],
2026-02-20T22:09:12.8934366Z +        attempt_data: Dict[str, Any] = None,
2026-02-20T22:09:12.8934804Z      ) -> bool:
2026-02-20T22:09:12.8935422Z          """Fallback : vérification par code (rétrocompatibilité)."""
2026-02-20T22:09:12.8936049Z          # BADGE: Premiers Pas (1 tentative)
2026-02-20T22:09:12.8936515Z -        if badge.code == 'first_steps':
2026-02-20T22:09:12.8937124Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8937793Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8938230Z -            ).scalar()
2026-02-20T22:09:12.8939053Z -            return attempts_count >= requirements.get('attempts_count', 1)
2026-02-20T22:09:12.8939645Z -        
2026-02-20T22:09:12.8939952Z +        if badge.code == "first_steps":
2026-02-20T22:09:12.8940399Z +            attempts_count = (
2026-02-20T22:09:12.8941123Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8941697Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8942177Z +                .scalar()
2026-02-20T22:09:12.8942509Z +            )
2026-02-20T22:09:12.8943191Z +            return attempts_count >= requirements.get("attempts_count", 1)
2026-02-20T22:09:12.8943785Z +
2026-02-20T22:09:12.8944111Z          # BADGE: Voie du Padawan (10 tentatives)
2026-02-20T22:09:12.8944603Z -        elif badge.code == 'padawan_path':
2026-02-20T22:09:12.8945231Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8945853Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8946287Z -            ).scalar()
2026-02-20T22:09:12.8946821Z -            return attempts_count >= requirements.get('attempts_count', 10)
2026-02-20T22:09:12.8947421Z -        
2026-02-20T22:09:12.8947745Z +        elif badge.code == "padawan_path":
2026-02-20T22:09:12.8948199Z +            attempts_count = (
2026-02-20T22:09:12.8948669Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8949220Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8949709Z +                .scalar()
2026-02-20T22:09:12.8950058Z +            )
2026-02-20T22:09:12.8950546Z +            return attempts_count >= requirements.get("attempts_count", 10)
2026-02-20T22:09:12.8951153Z +
2026-02-20T22:09:12.8951668Z          # BADGE: Épreuve du Chevalier (50 tentatives)
2026-02-20T22:09:12.8952207Z -        elif badge.code == 'knight_trial':
2026-02-20T22:09:12.8952843Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.8983839Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.8984326Z -            ).scalar()
2026-02-20T22:09:12.8984881Z -            return attempts_count >= requirements.get('attempts_count', 50)
2026-02-20T22:09:12.8985490Z -        
2026-02-20T22:09:12.8985829Z +        elif badge.code == "knight_trial":
2026-02-20T22:09:12.8986308Z +            attempts_count = (
2026-02-20T22:09:12.8986766Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.8987312Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.8987781Z +                .scalar()
2026-02-20T22:09:12.8988126Z +            )
2026-02-20T22:09:12.8988622Z +            return attempts_count >= requirements.get("attempts_count", 50)
2026-02-20T22:09:12.8989229Z +
2026-02-20T22:09:12.8989817Z          # BADGE: Maître des Additions (20 additions consécutives)
2026-02-20T22:09:12.8990450Z -        elif badge.code == 'addition_master':
2026-02-20T22:09:12.8990990Z -            return self._check_consecutive_success(
2026-02-20T22:09:12.8991499Z -                user_id, 
2026-02-20T22:09:12.8991970Z -                requirements.get('exercise_type', 'addition'),
2026-02-20T22:09:12.8992590Z -                requirements.get('consecutive_correct', 20)
2026-02-20T22:09:12.8993287Z -            )
2026-02-20T22:09:12.8993591Z -        
2026-02-20T22:09:12.8994207Z -        # BADGE: Éclair de Vitesse (exercice en moins de 5 secondes)
2026-02-20T22:09:12.8994819Z -        elif badge.code == 'speed_demon':
2026-02-20T22:09:12.8995374Z -            max_time = requirements.get('max_time', 5)
2026-02-20T22:09:12.8996124Z -            if attempt_data and attempt_data.get('time_spent', float('inf')) <= max_time:
2026-02-20T22:09:12.8996822Z -                return True
2026-02-20T22:09:12.8997182Z -            
2026-02-20T22:09:12.8997631Z -            # Vérifier dans l'historique
2026-02-20T22:09:12.8998174Z -            fast_attempt = self.db.query(Attempt).filter(
2026-02-20T22:09:12.8998717Z -                Attempt.user_id == user_id,
2026-02-20T22:09:12.8999478Z -                Attempt.is_correct == True,
2026-02-20T22:09:12.8999966Z -                Attempt.time_spent <= max_time
2026-02-20T22:09:12.9000423Z -            ).first()
2026-02-20T22:09:12.9000810Z -            return fast_attempt is not None
2026-02-20T22:09:12.9001250Z -        
2026-02-20T22:09:12.9002158Z -        # BADGE: Journée Parfaite (tous les exercices d'une journée réussis)
2026-02-20T22:09:12.9002859Z -        elif badge.code == 'perfect_day':
2026-02-20T22:09:12.9003588Z -            return self._check_perfect_day(user_id)
2026-02-20T22:09:12.9004061Z -        
2026-02-20T22:09:12.9004534Z -        # BADGE: Maître Jedi (100 tentatives)
2026-02-20T22:09:12.9005040Z -        elif badge.code == 'jedi_master':
2026-02-20T22:09:12.9005670Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.9006337Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.9006769Z -            ).scalar()
2026-02-20T22:09:12.9007312Z -            return attempts_count >= requirements.get('attempts_count', 100)
2026-02-20T22:09:12.9007949Z -        
2026-02-20T22:09:12.9008414Z -        # BADGE: Grand Maître (200 tentatives)
2026-02-20T22:09:12.9008898Z -        elif badge.code == 'grand_master':
2026-02-20T22:09:12.9009527Z -            attempts_count = self.db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:12.9010273Z -                Attempt.user_id == user_id
2026-02-20T22:09:12.9010709Z -            ).scalar()
2026-02-20T22:09:12.9011237Z -            return attempts_count >= requirements.get('attempts_count', 200)
2026-02-20T22:09:12.9011847Z -        
2026-02-20T22:09:12.9012488Z -        # BADGE: Maître des Soustractions (15 soustractions consécutives)
2026-02-20T22:09:12.9043483Z -        elif badge.code == 'subtraction_master':
2026-02-20T22:09:12.9044059Z +        elif badge.code == "addition_master":
2026-02-20T22:09:12.9044597Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9045086Z                  user_id,
2026-02-20T22:09:12.9045594Z -                requirements.get('exercise_type', 'soustraction'),
2026-02-20T22:09:12.9046245Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9046755Z -            )
2026-02-20T22:09:12.9047044Z -        
2026-02-20T22:09:12.9047759Z -        # BADGE: Maître des Multiplications (15 multiplications consécutives)
2026-02-20T22:09:12.9048505Z -        elif badge.code == 'multiplication_master':
2026-02-20T22:09:12.9049099Z +                requirements.get("exercise_type", "addition"),
2026-02-20T22:09:12.9049712Z +                requirements.get("consecutive_correct", 20),
2026-02-20T22:09:12.9050217Z +            )
2026-02-20T22:09:12.9050514Z +
2026-02-20T22:09:12.9051173Z +        # BADGE: Éclair de Vitesse (exercice en moins de 5 secondes)
2026-02-20T22:09:12.9051769Z +        elif badge.code == "speed_demon":
2026-02-20T22:09:12.9052289Z +            max_time = requirements.get("max_time", 5)
2026-02-20T22:09:12.9052781Z +            if (
2026-02-20T22:09:12.9053305Z +                attempt_data
2026-02-20T22:09:12.9053840Z +                and attempt_data.get("time_spent", float("inf")) <= max_time
2026-02-20T22:09:12.9054437Z +            ):
2026-02-20T22:09:12.9054750Z +                return True
2026-02-20T22:09:12.9055110Z +
2026-02-20T22:09:12.9055554Z +            # Vérifier dans l'historique
2026-02-20T22:09:12.9056029Z +            fast_attempt = (
2026-02-20T22:09:12.9056436Z +                self.db.query(Attempt)
2026-02-20T22:09:12.9056870Z +                .filter(
2026-02-20T22:09:12.9057261Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:12.9057760Z +                    Attempt.is_correct == True,
2026-02-20T22:09:12.9058262Z +                    Attempt.time_spent <= max_time,
2026-02-20T22:09:12.9058728Z +                )
2026-02-20T22:09:12.9059046Z +                .first()
2026-02-20T22:09:12.9059370Z +            )
2026-02-20T22:09:12.9059716Z +            return fast_attempt is not None
2026-02-20T22:09:12.9060437Z +
2026-02-20T22:09:12.9061095Z +        # BADGE: Journée Parfaite (tous les exercices d'une journée réussis)
2026-02-20T22:09:12.9061778Z +        elif badge.code == "perfect_day":
2026-02-20T22:09:12.9062299Z +            return self._check_perfect_day(user_id)
2026-02-20T22:09:12.9062769Z +
2026-02-20T22:09:12.9063657Z +        # BADGE: Maître Jedi (100 tentatives)
2026-02-20T22:09:12.9064167Z +        elif badge.code == "jedi_master":
2026-02-20T22:09:12.9064624Z +            attempts_count = (
2026-02-20T22:09:12.9065075Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.9065608Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.9066088Z +                .scalar()
2026-02-20T22:09:12.9066429Z +            )
2026-02-20T22:09:12.9066934Z +            return attempts_count >= requirements.get("attempts_count", 100)
2026-02-20T22:09:12.9067537Z +
2026-02-20T22:09:12.9067993Z +        # BADGE: Grand Maître (200 tentatives)
2026-02-20T22:09:12.9068510Z +        elif badge.code == "grand_master":
2026-02-20T22:09:12.9068972Z +            attempts_count = (
2026-02-20T22:09:12.9069431Z +                self.db.query(func.count(Attempt.id))
2026-02-20T22:09:12.9069961Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:12.9070453Z +                .scalar()
2026-02-20T22:09:12.9070801Z +            )
2026-02-20T22:09:12.9071297Z +            return attempts_count >= requirements.get("attempts_count", 200)
2026-02-20T22:09:12.9071900Z +
2026-02-20T22:09:12.9072527Z +        # BADGE: Maître des Soustractions (15 soustractions consécutives)
2026-02-20T22:09:12.9103539Z +        elif badge.code == "subtraction_master":
2026-02-20T22:09:12.9104121Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9104626Z                  user_id,
2026-02-20T22:09:12.9105121Z -                requirements.get('exercise_type', 'multiplication'),
2026-02-20T22:09:12.9105800Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9106322Z -            )
2026-02-20T22:09:12.9106616Z -        
2026-02-20T22:09:12.9107224Z -        # BADGE: Maître des Divisions (15 divisions consécutives)
2026-02-20T22:09:12.9107858Z -        elif badge.code == 'division_master':
2026-02-20T22:09:12.9108560Z +                requirements.get("exercise_type", "soustraction"),
2026-02-20T22:09:12.9109214Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9109724Z +            )
2026-02-20T22:09:12.9110004Z +
2026-02-20T22:09:12.9110652Z +        # BADGE: Maître des Multiplications (15 multiplications consécutives)
2026-02-20T22:09:12.9111367Z +        elif badge.code == "multiplication_master":
2026-02-20T22:09:12.9111930Z              return self._check_consecutive_success(
2026-02-20T22:09:12.9112424Z                  user_id,
2026-02-20T22:09:12.9114023Z -                requirements.get('exercise_type', 'division'),
2026-02-20T22:09:12.9114678Z -                requirements.get('consecutive_correct', 15)
2026-02-20T22:09:12.9115200Z -            )
2026-02-20T22:09:12.9115503Z -        
2026-02-20T22:09:12.9115929Z +                requirements.get("exercise_type", "multiplication"),
2026-02-20T22:09:12.9116602Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9117101Z +            )
2026-02-20T22:09:12.9117407Z +
2026-02-20T22:09:12.9117977Z +        # BADGE: Maître des Divisions (15 divisions consécutives)
2026-02-20T22:09:12.9118594Z +        elif badge.code == "division_master":
2026-02-20T22:09:12.9119130Z +            return self._check_consecutive_success(
2026-02-20T22:09:12.9119595Z +                user_id,
2026-02-20T22:09:12.9120061Z +                requirements.get("exercise_type", "division"),
2026-02-20T22:09:12.9120674Z +                requirements.get("consecutive_correct", 15),
2026-02-20T22:09:12.9121175Z +            )
2026-02-20T22:09:12.9121447Z +
2026-02-20T22:09:12.9122016Z          # BADGE: Expert (taux de réussite ≥ 80% sur 50 tentatives)
2026-02-20T22:09:12.9122892Z -        elif badge.code == 'expert':
2026-02-20T22:09:12.9123542Z +        elif badge.code == "expert":
2026-02-20T22:09:12.9124012Z              return self._check_success_rate(
2026-02-20T22:09:12.9124454Z                  user_id,
2026-02-20T22:09:12.9125104Z -                requirements.get('success_rate', 80),
2026-02-20T22:09:12.9125684Z -                requirements.get('min_attempts', 50)
2026-02-20T22:09:12.9126169Z -            )
2026-02-20T22:09:12.9126451Z -        
2026-02-20T22:09:12.9126804Z +                requirements.get("success_rate", 80),
2026-02-20T22:09:12.9127355Z +                requirements.get("min_attempts", 50),
2026-02-20T22:09:12.9127816Z +            )
2026-02-20T22:09:12.9128107Z +
2026-02-20T22:09:12.9128746Z          # BADGE: Perfectionniste (taux de réussite ≥ 95% sur 30 tentatives)
2026-02-20T22:09:12.9129435Z -        elif badge.code == 'perfectionist':
2026-02-20T22:09:12.9129947Z +        elif badge.code == "perfectionist":
2026-02-20T22:09:12.9130456Z              return self._check_success_rate(
2026-02-20T22:09:12.9130892Z                  user_id,
2026-02-20T22:09:12.9131291Z -                requirements.get('success_rate', 95),
2026-02-20T22:09:12.9131844Z -                requirements.get('min_attempts', 30)
2026-02-20T22:09:12.9132301Z -            )
2026-02-20T22:09:12.9132616Z -        
2026-02-20T22:09:12.9132954Z +                requirements.get("success_rate", 95),
2026-02-20T22:09:12.9163871Z +                requirements.get("min_attempts", 30),
2026-02-20T22:09:12.9164359Z +            )
2026-02-20T22:09:12.9164654Z +
2026-02-20T22:09:12.9165181Z          # BADGE: Semaine Parfaite (7 jours consécutifs)
2026-02-20T22:09:12.9165739Z -        elif badge.code == 'perfect_week':
2026-02-20T22:09:12.9166235Z +        elif badge.code == "perfect_week":
2026-02-20T22:09:12.9166756Z              return self._check_consecutive_days(
2026-02-20T22:09:12.9167234Z -                user_id,
2026-02-20T22:09:12.9167663Z -                requirements.get('consecutive_days', 7)
2026-02-20T22:09:12.9168172Z -            )
2026-02-20T22:09:12.9168463Z -        
2026-02-20T22:09:12.9168862Z +                user_id, requirements.get("consecutive_days", 7)
2026-02-20T22:09:12.9169373Z +            )
2026-02-20T22:09:12.9169655Z +
2026-02-20T22:09:12.9170145Z          # BADGE: Mois Parfait (30 jours consécutifs)
2026-02-20T22:09:12.9170679Z -        elif badge.code == 'perfect_month':
2026-02-20T22:09:12.9171166Z +        elif badge.code == "perfect_month":
2026-02-20T22:09:12.9171652Z              return self._check_consecutive_days(
2026-02-20T22:09:12.9172124Z -                user_id,
2026-02-20T22:09:12.9172551Z -                requirements.get('consecutive_days', 30)
2026-02-20T22:09:12.9173239Z -            )
2026-02-20T22:09:12.9173544Z -        
2026-02-20T22:09:12.9173949Z +                user_id, requirements.get("consecutive_days", 30)
2026-02-20T22:09:12.9174478Z +            )
2026-02-20T22:09:12.9174774Z +
2026-02-20T22:09:12.9175186Z          # BADGE: Explorateur (essayer tous les types d'exercices)
2026-02-20T22:09:12.9175799Z -        elif badge.code == 'explorer':
2026-02-20T22:09:12.9176273Z +        elif badge.code == "explorer":
2026-02-20T22:09:12.9176800Z              return self._check_all_exercise_types(user_id)
2026-02-20T22:09:12.9177297Z -        
2026-02-20T22:09:12.9177579Z +
2026-02-20T22:09:12.9178202Z          # BADGE: Polyvalent (réussir au moins 5 exercices de chaque type)
2026-02-20T22:09:12.9178864Z -        elif badge.code == 'versatile':
2026-02-20T22:09:12.9179338Z +        elif badge.code == "versatile":
2026-02-20T22:09:12.9179813Z              return self._check_min_per_type(
2026-02-20T22:09:12.9180274Z -                user_id,
2026-02-20T22:09:12.9180704Z -                requirements.get('min_per_type', 5)
2026-02-20T22:09:12.9181184Z -            )
2026-02-20T22:09:12.9181492Z -        
2026-02-20T22:09:12.9181877Z +                user_id, requirements.get("min_per_type", 5)
2026-02-20T22:09:12.9182385Z +            )
2026-02-20T22:09:12.9183143Z +
2026-02-20T22:09:12.9183445Z          return False
2026-02-20T22:09:12.9183768Z -    
2026-02-20T22:09:12.9184442Z -    def _check_consecutive_success(self, user_id: int, exercise_type: str, required_streak: int) -> bool:
2026-02-20T22:09:12.9185267Z +
2026-02-20T22:09:12.9185811Z +    def _check_consecutive_success(
2026-02-20T22:09:12.9186416Z +        self, user_id: int, exercise_type: str, required_streak: int
2026-02-20T22:09:12.9186986Z +    ) -> bool:
2026-02-20T22:09:12.9187680Z          """Vérifier une série consécutive de succès pour un type d'exercice"""
2026-02-20T22:09:12.9188302Z -        
2026-02-20T22:09:12.9188589Z +
2026-02-20T22:09:12.9189161Z          # Récupérer les dernières tentatives pour ce type d'exercice
2026-02-20T22:09:12.9189799Z -        attempts = self.db.execute(text("""
2026-02-20T22:09:12.9190284Z +        attempts = self.db.execute(
2026-02-20T22:09:12.9190694Z +            text("""
2026-02-20T22:09:12.9191041Z              SELECT a.is_correct
2026-02-20T22:09:12.9191442Z              FROM attempts a
2026-02-20T22:09:12.9191869Z              JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9192351Z              WHERE a.user_id = :user_id 
2026-02-20T22:09:12.9192812Z              AND e.exercise_type = :exercise_type
2026-02-20T22:09:12.9223594Z              ORDER BY a.created_at DESC
2026-02-20T22:09:12.9224029Z              LIMIT :limit
2026-02-20T22:09:12.9224348Z -        """), {
2026-02-20T22:09:12.9224630Z -            "user_id": user_id,
2026-02-20T22:09:12.9225041Z -            "exercise_type": exercise_type,
2026-02-20T22:09:12.9225776Z -            "limit": required_streak * 2  # Prendre plus pour être sûr
2026-02-20T22:09:12.9226341Z -        }).fetchall()
2026-02-20T22:09:12.9226656Z -        
2026-02-20T22:09:12.9226921Z +        """),
2026-02-20T22:09:12.9227193Z +            {
2026-02-20T22:09:12.9227507Z +                "user_id": user_id,
2026-02-20T22:09:12.9227943Z +                "exercise_type": exercise_type,
2026-02-20T22:09:12.9228679Z +                "limit": required_streak * 2,  # Prendre plus pour être sûr
2026-02-20T22:09:12.9229247Z +            },
2026-02-20T22:09:12.9229539Z +        ).fetchall()
2026-02-20T22:09:12.9229849Z +
2026-02-20T22:09:12.9230144Z          if len(attempts) < required_streak:
2026-02-20T22:09:12.9230588Z              return False
2026-02-20T22:09:12.9230912Z -        
2026-02-20T22:09:12.9231165Z +
2026-02-20T22:09:12.9231557Z          # Compter la série actuelle de succès
2026-02-20T22:09:12.9232010Z          current_streak = 0
2026-02-20T22:09:12.9232379Z          for attempt in attempts:
2026-02-20T22:09:12.9233273Z              if attempt.is_correct:  # Accès direct à l'attribut au lieu de [0]
2026-02-20T22:09:12.9233901Z                  current_streak += 1
2026-02-20T22:09:12.9234352Z                  if current_streak >= required_streak:
2026-02-20T22:09:12.9234821Z                      return True
2026-02-20T22:09:12.9235171Z              else:
2026-02-20T22:09:12.9235614Z                  break  # Série interrompue
2026-02-20T22:09:12.9236019Z -        
2026-02-20T22:09:12.9236282Z +
2026-02-20T22:09:12.9236538Z          return False
2026-02-20T22:09:12.9236846Z -    
2026-02-20T22:09:12.9237093Z +
2026-02-20T22:09:12.9237437Z      def _check_perfect_day(self, user_id: int) -> bool:
2026-02-20T22:09:12.9238178Z          """Vérifier si l'utilisateur a eu une journée parfaite"""
2026-02-20T22:09:12.9238704Z -        
2026-02-20T22:09:12.9238974Z +
2026-02-20T22:09:12.9239289Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9239739Z -        
2026-02-20T22:09:12.9239989Z +
2026-02-20T22:09:12.9240432Z          # Récupérer toutes les tentatives d'aujourd'hui
2026-02-20T22:09:12.9240972Z -        today_attempts = self.db.execute(text("""
2026-02-20T22:09:12.9241463Z +        today_attempts = self.db.execute(
2026-02-20T22:09:12.9241880Z +            text("""
2026-02-20T22:09:12.9242199Z              SELECT COUNT(*) as total, 
2026-02-20T22:09:12.9242941Z                     COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9243631Z              FROM attempts
2026-02-20T22:09:12.9243994Z              WHERE user_id = :user_id 
2026-02-20T22:09:12.9244409Z              AND DATE(created_at) = :today
2026-02-20T22:09:12.9244814Z -        """), {
2026-02-20T22:09:12.9245289Z -            "user_id": user_id,
2026-02-20T22:09:12.9245671Z -            "today": today
2026-02-20T22:09:12.9246004Z -        }).fetchone()
2026-02-20T22:09:12.9246319Z -        
2026-02-20T22:09:12.9246573Z +        """),
2026-02-20T22:09:12.9246887Z +            {"user_id": user_id, "today": today},
2026-02-20T22:09:12.9247318Z +        ).fetchone()
2026-02-20T22:09:12.9247601Z +
2026-02-20T22:09:12.9247964Z          if not today_attempts or today_attempts.total == 0:
2026-02-20T22:09:12.9248446Z              return False
2026-02-20T22:09:12.9248760Z -        
2026-02-20T22:09:12.9249016Z +
2026-02-20T22:09:12.9249606Z          # Tous les exercices doivent être réussis ET au moins 3 exercices
2026-02-20T22:09:12.9250496Z -        return today_attempts.correct == today_attempts.total and today_attempts.total >= 3
2026-02-20T22:09:12.9251203Z -    
2026-02-20T22:09:12.9251805Z -    def _check_success_rate(self, user_id: int, min_success_rate: float, min_attempts: int) -> bool:
2026-02-20T22:09:12.9252546Z +        return (
2026-02-20T22:09:12.9273479Z +            today_attempts.correct == today_attempts.total and today_attempts.total >= 3
2026-02-20T22:09:12.9274214Z +        )
2026-02-20T22:09:12.9274494Z +
2026-02-20T22:09:12.9274770Z +    def _check_success_rate(
2026-02-20T22:09:12.9275322Z +        self, user_id: int, min_success_rate: float, min_attempts: int
2026-02-20T22:09:12.9275889Z +    ) -> bool:
2026-02-20T22:09:12.9276791Z          """Vérifier si l'utilisateur atteint un taux de réussite minimum sur un nombre minimum de tentatives"""
2026-02-20T22:09:12.9277598Z -        
2026-02-20T22:09:12.9277907Z -        stats = self.db.execute(text("""
2026-02-20T22:09:12.9278353Z +
2026-02-20T22:09:12.9278622Z +        stats = self.db.execute(
2026-02-20T22:09:12.9279014Z +            text("""
2026-02-20T22:09:12.9279329Z              SELECT 
2026-02-20T22:09:12.9279664Z                  COUNT(*) as total,
2026-02-20T22:09:12.9280176Z                  COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9280698Z              FROM attempts
2026-02-20T22:09:12.9281072Z              WHERE user_id = :user_id
2026-02-20T22:09:12.9281465Z -        """), {
2026-02-20T22:09:12.9281780Z -            "user_id": user_id
2026-02-20T22:09:12.9282149Z -        }).fetchone()
2026-02-20T22:09:12.9282464Z -        
2026-02-20T22:09:12.9282725Z +        """),
2026-02-20T22:09:12.9283207Z +            {"user_id": user_id},
2026-02-20T22:09:12.9283599Z +        ).fetchone()
2026-02-20T22:09:12.9283913Z +
2026-02-20T22:09:12.9284242Z          if not stats or stats.total < min_attempts:
2026-02-20T22:09:12.9284712Z              return False
2026-02-20T22:09:12.9285043Z -        
2026-02-20T22:09:12.9285307Z +
2026-02-20T22:09:12.9285670Z          success_rate = (stats.correct / stats.total) * 100
2026-02-20T22:09:12.9286226Z          return success_rate >= min_success_rate
2026-02-20T22:09:12.9286659Z -    
2026-02-20T22:09:12.9286763Z +
2026-02-20T22:09:12.9287130Z      def _check_consecutive_days(self, user_id: int, required_days: int) -> bool:
2026-02-20T22:09:12.9287686Z          """Vérifier si l'utilisateur a fait des exercices pendant X jours consécutifs"""
2026-02-20T22:09:12.9287797Z -        
2026-02-20T22:09:12.9287903Z +
2026-02-20T22:09:12.9288423Z          # Récupérer les jours uniques avec des tentatives, triés par date décroissante
2026-02-20T22:09:12.9288584Z -        days = self.db.execute(text("""
2026-02-20T22:09:12.9288720Z +        days = self.db.execute(
2026-02-20T22:09:12.9288838Z +            text("""
2026-02-20T22:09:12.9289028Z              SELECT DISTINCT DATE(created_at) as day
2026-02-20T22:09:12.9289156Z              FROM attempts
2026-02-20T22:09:12.9289584Z              WHERE user_id = :user_id
2026-02-20T22:09:12.9289717Z              ORDER BY day DESC
2026-02-20T22:09:12.9289833Z              LIMIT :limit
2026-02-20T22:09:12.9289936Z -        """), {
2026-02-20T22:09:12.9290055Z -            "user_id": user_id,
2026-02-20T22:09:12.9290887Z -            "limit": required_days + 1  # Prendre un jour de plus pour vérifier la continuité
2026-02-20T22:09:12.9291028Z -        }).fetchall()
2026-02-20T22:09:12.9291135Z -        
2026-02-20T22:09:12.9291250Z +        """),
2026-02-20T22:09:12.9291360Z +            {
2026-02-20T22:09:12.9291495Z +                "user_id": user_id,
2026-02-20T22:09:12.9291632Z +                "limit": required_days
2026-02-20T22:09:12.9292036Z +                + 1,  # Prendre un jour de plus pour vérifier la continuité
2026-02-20T22:09:12.9292146Z +            },
2026-02-20T22:09:12.9292267Z +        ).fetchall()
2026-02-20T22:09:12.9292384Z +
2026-02-20T22:09:12.9292530Z          if len(days) < required_days:
2026-02-20T22:09:12.9292668Z              return False
2026-02-20T22:09:12.9292780Z -        
2026-02-20T22:09:12.9292879Z +
2026-02-20T22:09:12.9293350Z          # Vérifier que les jours sont consécutifs
2026-02-20T22:09:12.9293532Z          today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9293688Z          consecutive_count = 0
2026-02-20T22:09:12.9293796Z -        
2026-02-20T22:09:12.9293898Z +
2026-02-20T22:09:12.9294064Z          for i, day_row in enumerate(days):
2026-02-20T22:09:12.9294337Z -            day = day_row.day if hasattr(day_row, 'day') else day_row[0]
2026-02-20T22:09:12.9294581Z +            day = day_row.day if hasattr(day_row, "day") else day_row[0]
2026-02-20T22:09:12.9294788Z              expected_date = today - timedelta(days=i)
2026-02-20T22:09:12.9294900Z -            
2026-02-20T22:09:12.9295002Z +
2026-02-20T22:09:12.9295143Z              if day == expected_date:
2026-02-20T22:09:12.9295287Z                  consecutive_count += 1
2026-02-20T22:09:12.9295397Z              else:
2026-02-20T22:09:12.9295524Z                  break
2026-02-20T22:09:12.9295636Z -        
2026-02-20T22:09:12.9295737Z +
2026-02-20T22:09:12.9295907Z          return consecutive_count >= required_days
2026-02-20T22:09:12.9296012Z -    
2026-02-20T22:09:12.9296121Z +
2026-02-20T22:09:12.9296384Z      def _check_all_exercise_types(self, user_id: int) -> bool:
2026-02-20T22:09:12.9296920Z          """Vérifier si l'utilisateur a essayé tous les types d'exercices disponibles"""
2026-02-20T22:09:12.9297034Z -        
2026-02-20T22:09:12.9297133Z +
2026-02-20T22:09:12.9297458Z          # Récupérer tous les types d'exercices disponibles
2026-02-20T22:09:12.9297628Z          all_types = self.db.execute(text("""
2026-02-20T22:09:12.9297794Z              SELECT DISTINCT exercise_type
2026-02-20T22:09:12.9297919Z              FROM exercises
2026-02-20T22:09:12.9298122Z              WHERE is_active = true AND is_archived = false
2026-02-20T22:09:12.9298254Z          """)).fetchall()
2026-02-20T22:09:12.9298364Z -        
2026-02-20T22:09:12.9298475Z +
2026-02-20T22:09:12.9298600Z          if not all_types:
2026-02-20T22:09:12.9298734Z              return False
2026-02-20T22:09:12.9298838Z -        
2026-02-20T22:09:12.9299339Z -        all_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in all_types}
2026-02-20T22:09:12.9299466Z -        
2026-02-20T22:09:12.9299570Z +
2026-02-20T22:09:12.9299695Z +        all_types_set = {
2026-02-20T22:09:12.9299999Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9300139Z +            for row in all_types
2026-02-20T22:09:12.9300246Z +        }
2026-02-20T22:09:12.9300345Z +
2026-02-20T22:09:12.9300752Z          # Récupérer les types d'exercices que l'utilisateur a essayés
2026-02-20T22:09:12.9300922Z -        user_types = self.db.execute(text("""
2026-02-20T22:09:12.9301070Z +        user_types = self.db.execute(
2026-02-20T22:09:12.9301195Z +            text("""
2026-02-20T22:09:12.9301358Z              SELECT DISTINCT e.exercise_type
2026-02-20T22:09:12.9301705Z              FROM attempts a
2026-02-20T22:09:12.9301889Z              JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9302040Z              WHERE a.user_id = :user_id
2026-02-20T22:09:12.9302148Z -        """), {
2026-02-20T22:09:12.9302452Z -            "user_id": user_id
2026-02-20T22:09:12.9302598Z -        }).fetchall()
2026-02-20T22:09:12.9302709Z -        
2026-02-20T22:09:12.9343594Z -        user_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in user_types}
2026-02-20T22:09:12.9343731Z -        
2026-02-20T22:09:12.9343854Z +        """),
2026-02-20T22:09:12.9344003Z +            {"user_id": user_id},
2026-02-20T22:09:12.9344128Z +        ).fetchall()
2026-02-20T22:09:12.9344248Z +
2026-02-20T22:09:12.9344383Z +        user_types_set = {
2026-02-20T22:09:12.9344680Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9344826Z +            for row in user_types
2026-02-20T22:09:12.9344946Z +        }
2026-02-20T22:09:12.9345049Z +
2026-02-20T22:09:12.9345292Z          # Normaliser les types (lowercase pour comparaison)
2026-02-20T22:09:12.9345578Z          all_types_normalized = {str(t).lower() for t in all_types_set}
2026-02-20T22:09:12.9345883Z          user_types_normalized = {str(t).lower() for t in user_types_set}
2026-02-20T22:09:12.9345998Z -        
2026-02-20T22:09:12.9346114Z +
2026-02-20T22:09:12.9346397Z          return all_types_normalized.issubset(user_types_normalized)
2026-02-20T22:09:12.9346506Z -    
2026-02-20T22:09:12.9346606Z +
2026-02-20T22:09:12.9346906Z      def _check_min_per_type(self, user_id: int, min_count: int) -> bool:
2026-02-20T22:09:12.9347437Z          """Vérifier si l'utilisateur a réussi au moins X exercices de chaque type"""
2026-02-20T22:09:12.9347546Z -        
2026-02-20T22:09:12.9347655Z +
2026-02-20T22:09:12.9347989Z          # Récupérer tous les types d'exercices disponibles
2026-02-20T22:09:12.9348159Z          all_types = self.db.execute(text("""
2026-02-20T22:09:12.9348335Z              SELECT DISTINCT exercise_type
2026-02-20T22:09:12.9348462Z              FROM exercises
2026-02-20T22:09:12.9348665Z              WHERE is_active = true AND is_archived = false
2026-02-20T22:09:12.9348788Z          """)).fetchall()
2026-02-20T22:09:12.9348909Z -        
2026-02-20T22:09:12.9349010Z +
2026-02-20T22:09:12.9349135Z          if not all_types:
2026-02-20T22:09:12.9349257Z              return False
2026-02-20T22:09:12.9349359Z -        
2026-02-20T22:09:12.9349848Z -        all_types_set = {row.exercise_type if hasattr(row, 'exercise_type') else row[0] for row in all_types}
2026-02-20T22:09:12.9349954Z -        
2026-02-20T22:09:12.9350061Z +
2026-02-20T22:09:12.9350190Z +        all_types_set = {
2026-02-20T22:09:12.9350471Z +            row.exercise_type if hasattr(row, "exercise_type") else row[0]
2026-02-20T22:09:12.9350614Z +            for row in all_types
2026-02-20T22:09:12.9350721Z +        }
2026-02-20T22:09:12.9350832Z +
2026-02-20T22:09:12.9351378Z          # Pour chaque type, vérifier si l'utilisateur a réussi au moins min_count exercices
2026-02-20T22:09:12.9351541Z          for ex_type in all_types_set:
2026-02-20T22:09:12.9351727Z -            success_count = self.db.execute(text("""
2026-02-20T22:09:12.9351898Z +            success_count = self.db.execute(
2026-02-20T22:09:12.9352031Z +                text("""
2026-02-20T22:09:12.9352170Z                  SELECT COUNT(*) as count
2026-02-20T22:09:12.9352302Z                  FROM attempts a
2026-02-20T22:09:12.9352501Z                  JOIN exercises e ON a.exercise_id = e.id
2026-02-20T22:09:12.9352641Z                  WHERE a.user_id = :user_id
2026-02-20T22:09:12.9353142Z                  AND LOWER(e.exercise_type::text) = LOWER(:exercise_type)
2026-02-20T22:09:12.9353295Z                  AND a.is_correct = true
2026-02-20T22:09:12.9353416Z -            """), {
2026-02-20T22:09:12.9353551Z -                "user_id": user_id,
2026-02-20T22:09:12.9353979Z -                "exercise_type": str(ex_type)
2026-02-20T22:09:12.9354116Z -            }).fetchone()
2026-02-20T22:09:12.9354229Z -            
2026-02-20T22:09:12.9354653Z -            count = success_count.count if hasattr(success_count, 'count') else success_count[0]
2026-02-20T22:09:12.9354770Z +            """),
2026-02-20T22:09:12.9355195Z +                {"user_id": user_id, "exercise_type": str(ex_type)},
2026-02-20T22:09:12.9355332Z +            ).fetchone()
2026-02-20T22:09:12.9355443Z +
2026-02-20T22:09:12.9355566Z +            count = (
2026-02-20T22:09:12.9355698Z +                success_count.count
2026-02-20T22:09:12.9355863Z +                if hasattr(success_count, "count")
2026-02-20T22:09:12.9356009Z +                else success_count[0]
2026-02-20T22:09:12.9356116Z +            )
2026-02-20T22:09:12.9356248Z              if count < min_count:
2026-02-20T22:09:12.9356375Z                  return False
2026-02-20T22:09:12.9356490Z -        
2026-02-20T22:09:12.9356591Z +
2026-02-20T22:09:12.9356714Z          return True
2026-02-20T22:09:12.9356827Z -    
2026-02-20T22:09:12.9357224Z -    def _award_badge(self, user_id: int, badge: Achievement) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9357330Z +
2026-02-20T22:09:12.9357447Z +    def _award_badge(
2026-02-20T22:09:12.9357627Z +        self, user_id: int, badge: Achievement
2026-02-20T22:09:12.9357778Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9358085Z          """Attribuer un badge à un utilisateur"""
2026-02-20T22:09:12.9358203Z -        
2026-02-20T22:09:12.9358306Z +
2026-02-20T22:09:12.9358416Z          try:
2026-02-20T22:09:12.9358588Z              user_achievement = UserAchievement(
2026-02-20T22:09:12.9358726Z                  user_id=user_id,
2026-02-20T22:09:12.9358868Z                  achievement_id=badge.id,
2026-02-20T22:09:12.9359055Z                  earned_at=datetime.now(timezone.utc),
2026-02-20T22:09:12.9359187Z -                is_displayed=True
2026-02-20T22:09:12.9359295Z -            )
2026-02-20T22:09:12.9359417Z -            
2026-02-20T22:09:12.9359553Z +                is_displayed=True,
2026-02-20T22:09:12.9359652Z +            )
2026-02-20T22:09:12.9359751Z +
2026-02-20T22:09:12.9359907Z              self.db.add(user_achievement)
2026-02-20T22:09:12.9360045Z              self.db.commit()
2026-02-20T22:09:12.9360161Z -            
2026-02-20T22:09:12.9360279Z +
2026-02-20T22:09:12.9360404Z              return {
2026-02-20T22:09:12.9360529Z -                'id': badge.id,
2026-02-20T22:09:12.9360659Z -                'code': badge.code,
2026-02-20T22:09:12.9360786Z -                'name': badge.name,
2026-02-20T22:09:12.9360975Z -                'description': badge.description,
2026-02-20T22:09:12.9361171Z -                'star_wars_title': badge.star_wars_title,
2026-02-20T22:09:12.9361338Z -                'difficulty': badge.difficulty,
2026-02-20T22:09:12.9361525Z -                'points_reward': badge.points_reward,
2026-02-20T22:09:12.9361766Z -                'earned_at': user_achievement.earned_at.isoformat()
2026-02-20T22:09:12.9361898Z +                "id": badge.id,
2026-02-20T22:09:12.9362026Z +                "code": badge.code,
2026-02-20T22:09:12.9362155Z +                "name": badge.name,
2026-02-20T22:09:12.9362320Z +                "description": badge.description,
2026-02-20T22:09:12.9362512Z +                "star_wars_title": badge.star_wars_title,
2026-02-20T22:09:12.9362679Z +                "difficulty": badge.difficulty,
2026-02-20T22:09:12.9362852Z +                "points_reward": badge.points_reward,
2026-02-20T22:09:12.9363324Z +                "earned_at": user_achievement.earned_at.isoformat(),
2026-02-20T22:09:12.9363464Z              }
2026-02-20T22:09:12.9363572Z -            
2026-02-20T22:09:12.9363676Z +
2026-02-20T22:09:12.9363848Z          except Exception as badge_award_error:
2026-02-20T22:09:12.9363991Z              self.db.rollback()
2026-02-20T22:09:12.9364439Z -            logger.error(f"Erreur lors de l'attribution du badge {badge.code}: {badge_award_error}")
2026-02-20T22:09:12.9364765Z +            logger.error(
2026-02-20T22:09:12.9365132Z +                f"Erreur lors de l'attribution du badge {badge.code}: {badge_award_error}"
2026-02-20T22:09:12.9365242Z +            )
2026-02-20T22:09:12.9365366Z              return None
2026-02-20T22:09:12.9365474Z -    
2026-02-20T22:09:12.9365737Z +
2026-02-20T22:09:12.9366153Z      def _update_user_gamification(self, user_id: int, new_badges: List[Dict[str, Any]]):
2026-02-20T22:09:12.9366559Z          """Mettre à jour les points et le niveau de l'utilisateur"""
2026-02-20T22:09:12.9366672Z -        
2026-02-20T22:09:12.9366776Z +
2026-02-20T22:09:12.9366887Z          try:
2026-02-20T22:09:12.9367143Z              # Calculer les points gagnés
2026-02-20T22:09:12.9367492Z -            total_points_gained = sum(badge['points_reward'] for badge in new_badges)
2026-02-20T22:09:12.9367601Z -            
2026-02-20T22:09:12.9367939Z +            total_points_gained = sum(badge["points_reward"] for badge in new_badges)
2026-02-20T22:09:12.9368065Z +
2026-02-20T22:09:12.9368305Z              # Mettre à jour l'utilisateur
2026-02-20T22:09:12.9368586Z              user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.9368710Z              if user:
2026-02-20T22:09:12.9368863Z                  # Ajouter les points
2026-02-20T22:09:12.9369123Z -                current_points = getattr(user, 'total_points', 0) or 0
2026-02-20T22:09:12.9369371Z +                current_points = getattr(user, "total_points", 0) or 0
2026-02-20T22:09:12.9369627Z                  new_total_points = current_points + total_points_gained
2026-02-20T22:09:12.9369734Z -                
2026-02-20T22:09:12.9369837Z +
2026-02-20T22:09:12.9370146Z                  # Calculer le nouveau niveau (100 points par niveau)
2026-02-20T22:09:12.9370390Z                  new_level = max(1, new_total_points // 100 + 1)
2026-02-20T22:09:12.9417681Z -                
2026-02-20T22:09:12.9417817Z +
2026-02-20T22:09:12.9418212Z                  # Calculer le rang Jedi basé sur le niveau
2026-02-20T22:09:12.9418487Z                  jedi_rank = self._calculate_jedi_rank(new_level)
2026-02-20T22:09:12.9418603Z -                
2026-02-20T22:09:12.9418709Z +
2026-02-20T22:09:12.9419180Z                  # Mettre à jour via SQL brut pour éviter les problèmes de modèle
2026-02-20T22:09:12.9419345Z -                self.db.execute(text("""
2026-02-20T22:09:12.9419485Z +                self.db.execute(
2026-02-20T22:09:12.9419606Z +                    text("""
2026-02-20T22:09:12.9419749Z                      UPDATE users 
2026-02-20T22:09:12.9419926Z                      SET total_points = :total_points,
2026-02-20T22:09:12.9420100Z                          current_level = :current_level,
2026-02-20T22:09:12.9420313Z                          experience_points = :experience_points,
2026-02-20T22:09:12.9420480Z                          jedi_rank = :jedi_rank
2026-02-20T22:09:12.9420616Z                      WHERE id = :user_id
2026-02-20T22:09:12.9420747Z -                """), {
2026-02-20T22:09:12.9420939Z -                    "total_points": new_total_points,
2026-02-20T22:09:12.9421100Z -                    "current_level": new_level,
2026-02-20T22:09:12.9421293Z -                    "experience_points": new_total_points % 100,
2026-02-20T22:09:12.9421432Z -                    "jedi_rank": jedi_rank,
2026-02-20T22:09:12.9421551Z -                    "user_id": user_id
2026-02-20T22:09:12.9421652Z -                })
2026-02-20T22:09:12.9421754Z -                
2026-02-20T22:09:12.9421878Z +                """),
2026-02-20T22:09:12.9421989Z +                    {
2026-02-20T22:09:12.9422172Z +                        "total_points": new_total_points,
2026-02-20T22:09:12.9422345Z +                        "current_level": new_level,
2026-02-20T22:09:12.9422559Z +                        "experience_points": new_total_points % 100,
2026-02-20T22:09:12.9422708Z +                        "jedi_rank": jedi_rank,
2026-02-20T22:09:12.9422852Z +                        "user_id": user_id,
2026-02-20T22:09:12.9423404Z +                    },
2026-02-20T22:09:12.9423518Z +                )
2026-02-20T22:09:12.9423625Z +
2026-02-20T22:09:12.9423774Z                  self.db.commit()
2026-02-20T22:09:12.9424930Z -                logger.info(f"Gamification mise à jour pour l'utilisateur {user_id}: {total_points_gained} points, niveau {new_level}, rang {jedi_rank}")
2026-02-20T22:09:12.9425050Z -                
2026-02-20T22:09:12.9425187Z +                logger.info(
2026-02-20T22:09:12.9426048Z +                    f"Gamification mise à jour pour l'utilisateur {user_id}: {total_points_gained} points, niveau {new_level}, rang {jedi_rank}"
2026-02-20T22:09:12.9426159Z +                )
2026-02-20T22:09:12.9426262Z +
2026-02-20T22:09:12.9426481Z          except Exception as gamification_update_error:
2026-02-20T22:09:12.9426606Z              self.db.rollback()
2026-02-20T22:09:12.9427323Z -            logger.error(f"Erreur mise à jour gamification pour l'utilisateur {user_id}: {gamification_update_error}")
2026-02-20T22:09:12.9427456Z -    
2026-02-20T22:09:12.9427585Z +            logger.error(
2026-02-20T22:09:12.9428210Z +                f"Erreur mise à jour gamification pour l'utilisateur {user_id}: {gamification_update_error}"
2026-02-20T22:09:12.9428326Z +            )
2026-02-20T22:09:12.9428442Z +
2026-02-20T22:09:12.9428652Z      def _calculate_jedi_rank(self, level: int) -> str:
2026-02-20T22:09:12.9428937Z          """Calculer le rang Jedi basé sur le niveau"""
2026-02-20T22:09:12.9429056Z -        
2026-02-20T22:09:12.9429157Z +
2026-02-20T22:09:12.9429279Z          if level < 5:
2026-02-20T22:09:12.9429419Z -            return 'youngling'
2026-02-20T22:09:12.9429545Z +            return "youngling"
2026-02-20T22:09:12.9429670Z          elif level < 15:
2026-02-20T22:09:12.9429799Z -            return 'padawan'
2026-02-20T22:09:12.9429936Z +            return "padawan"
2026-02-20T22:09:12.9430057Z          elif level < 30:
2026-02-20T22:09:12.9430184Z -            return 'knight'
2026-02-20T22:09:12.9430332Z +            return "knight"
2026-02-20T22:09:12.9430457Z          elif level < 50:
2026-02-20T22:09:12.9430578Z -            return 'master'
2026-02-20T22:09:12.9430710Z +            return "master"
2026-02-20T22:09:12.9430819Z          else:
2026-02-20T22:09:12.9430960Z -            return 'grand_master'
2026-02-20T22:09:12.9431064Z -    
2026-02-20T22:09:12.9431200Z +            return "grand_master"
2026-02-20T22:09:12.9431302Z +
2026-02-20T22:09:12.9431551Z      def get_user_badges(self, user_id: int) -> Dict[str, Any]:
2026-02-20T22:09:12.9431870Z          """Récupérer tous les badges d'un utilisateur"""
2026-02-20T22:09:12.9431976Z -        
2026-02-20T22:09:12.9432081Z +
2026-02-20T22:09:12.9432187Z          try:
2026-02-20T22:09:12.9432320Z              # Badges obtenus
2026-02-20T22:09:12.9432505Z -            earned_badges = self.db.execute(text("""
2026-02-20T22:09:12.9432665Z +            earned_badges = self.db.execute(
2026-02-20T22:09:12.9432807Z +                text("""
2026-02-20T22:09:12.9463463Z                  SELECT a.id, a.code, a.name, a.description, a.star_wars_title,
2026-02-20T22:09:12.9463729Z                         a.difficulty, a.points_reward, a.category,
2026-02-20T22:09:12.9463912Z                         ua.earned_at, ua.is_displayed
2026-02-20T22:09:12.9464081Z                  FROM achievements a
2026-02-20T22:09:12.9464338Z                  JOIN user_achievements ua ON a.id = ua.achievement_id
2026-02-20T22:09:12.9464491Z                  WHERE ua.user_id = :user_id
2026-02-20T22:09:12.9464647Z                  ORDER BY ua.earned_at DESC
2026-02-20T22:09:12.9464811Z -            """), {"user_id": user_id}).fetchall()
2026-02-20T22:09:12.9464921Z -            
2026-02-20T22:09:12.9465038Z +            """),
2026-02-20T22:09:12.9465172Z +                {"user_id": user_id},
2026-02-20T22:09:12.9465295Z +            ).fetchall()
2026-02-20T22:09:12.9465401Z +
2026-02-20T22:09:12.9465601Z              # Statistiques utilisateur (inclut streak)
2026-02-20T22:09:12.9466038Z -            user_stats = self.db.execute(text("""
2026-02-20T22:09:12.9466201Z +            user_stats = self.db.execute(
2026-02-20T22:09:12.9466333Z +                text("""
2026-02-20T22:09:12.9466837Z                  SELECT total_points, current_level, experience_points, jedi_rank,
2026-02-20T22:09:12.9467109Z                         COALESCE(current_streak, 0), COALESCE(best_streak, 0)
2026-02-20T22:09:12.9467243Z                  FROM users
2026-02-20T22:09:12.9467375Z                  WHERE id = :user_id
2026-02-20T22:09:12.9467539Z -            """), {"user_id": user_id}).fetchone()
2026-02-20T22:09:12.9467647Z +            """),
2026-02-20T22:09:12.9467785Z +                {"user_id": user_id},
2026-02-20T22:09:12.9467902Z +            ).fetchone()
2026-02-20T22:09:12.9468009Z  
2026-02-20T22:09:12.9468156Z              pinned: List[int] = []
2026-02-20T22:09:12.9468271Z              try:
2026-02-20T22:09:12.9468553Z                  user = self.db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:12.9468921Z                  if user and hasattr(user, "pinned_badge_ids") and user.pinned_badge_ids:
2026-02-20T22:09:12.9469313Z -                    pinned = [int(x) for x in user.pinned_badge_ids if isinstance(x, (int, float))]
2026-02-20T22:09:12.9469447Z +                    pinned = [
2026-02-20T22:09:12.9469562Z +                        int(x)
2026-02-20T22:09:12.9469747Z +                        for x in user.pinned_badge_ids
2026-02-20T22:09:12.9469908Z +                        if isinstance(x, (int, float))
2026-02-20T22:09:12.9470021Z +                    ]
2026-02-20T22:09:12.9470167Z              except Exception:
2026-02-20T22:09:12.9470283Z                  pass
2026-02-20T22:09:12.9470390Z -            
2026-02-20T22:09:12.9470492Z +
2026-02-20T22:09:12.9470619Z              return {
2026-02-20T22:09:12.9470753Z -                'earned_badges': [
2026-02-20T22:09:12.9470879Z +                "earned_badges": [
2026-02-20T22:09:12.9471006Z                      {
2026-02-20T22:09:12.9471138Z -                        'id': badge[0],
2026-02-20T22:09:12.9471273Z -                        'code': badge[1],
2026-02-20T22:09:12.9471406Z -                        'name': badge[2],
2026-02-20T22:09:12.9471577Z -                        'description': badge[3],
2026-02-20T22:09:12.9471746Z -                        'star_wars_title': badge[4],
2026-02-20T22:09:12.9471898Z -                        'difficulty': badge[5],
2026-02-20T22:09:12.9472064Z -                        'points_reward': badge[6],
2026-02-20T22:09:12.9472211Z -                        'category': badge[7],
2026-02-20T22:09:12.9472471Z -                        'earned_at': badge[8].isoformat() if badge[8] else None,
2026-02-20T22:09:12.9472634Z -                        'is_displayed': badge[9]
2026-02-20T22:09:12.9472765Z +                        "id": badge[0],
2026-02-20T22:09:12.9472897Z +                        "code": badge[1],
2026-02-20T22:09:12.9473220Z +                        "name": badge[2],
2026-02-20T22:09:12.9473427Z +                        "description": badge[3],
2026-02-20T22:09:12.9473666Z +                        "star_wars_title": badge[4],
2026-02-20T22:09:12.9473869Z +                        "difficulty": badge[5],
2026-02-20T22:09:12.9474086Z +                        "points_reward": badge[6],
2026-02-20T22:09:12.9474265Z +                        "category": badge[7],
2026-02-20T22:09:12.9474565Z +                        "earned_at": badge[8].isoformat() if badge[8] else None,
2026-02-20T22:09:12.9474767Z +                        "is_displayed": badge[9],
2026-02-20T22:09:12.9474901Z                      }
2026-02-20T22:09:12.9475096Z                      for badge in earned_badges
2026-02-20T22:09:12.9475229Z                  ],
2026-02-20T22:09:12.9475394Z -                'user_stats': {
2026-02-20T22:09:12.9475649Z -                    'total_points': user_stats[0] if user_stats else 0,
2026-02-20T22:09:12.9475885Z -                    'current_level': user_stats[1] if user_stats else 1,
2026-02-20T22:09:12.9476446Z -                    'experience_points': user_stats[2] if user_stats else 0,
2026-02-20T22:09:12.9476771Z -                    'jedi_rank': user_stats[3] if user_stats else 'youngling',
2026-02-20T22:09:12.9476936Z -                    'pinned_badge_ids': pinned,
2026-02-20T22:09:12.9477586Z -                    'current_streak': user_stats[4] if user_stats and len(user_stats) > 4 else 0,
2026-02-20T22:09:12.9477991Z -                    'best_streak': user_stats[5] if user_stats and len(user_stats) > 5 else 0,
2026-02-20T22:09:12.9478146Z -                } if user_stats else {
2026-02-20T22:09:12.9478352Z -                    'total_points': 0,
2026-02-20T22:09:12.9478501Z -                    'current_level': 1,
2026-02-20T22:09:12.9478660Z -                    'experience_points': 0,
2026-02-20T22:09:12.9478847Z -                    'jedi_rank': 'youngling',
2026-02-20T22:09:12.9479013Z -                    'pinned_badge_ids': [],
2026-02-20T22:09:12.9479167Z -                    'current_streak': 0,
2026-02-20T22:09:12.9479306Z -                    'best_streak': 0,
2026-02-20T22:09:12.9479428Z -                }
2026-02-20T22:09:12.9479571Z +                "user_stats": (
2026-02-20T22:09:12.9479689Z +                    {
2026-02-20T22:09:12.9479983Z +                        "total_points": user_stats[0] if user_stats else 0,
2026-02-20T22:09:12.9480236Z +                        "current_level": user_stats[1] if user_stats else 1,
2026-02-20T22:09:12.9480554Z +                        "experience_points": user_stats[2] if user_stats else 0,
2026-02-20T22:09:12.9480837Z +                        "jedi_rank": user_stats[3] if user_stats else "youngling",
2026-02-20T22:09:12.9481021Z +                        "pinned_badge_ids": pinned,
2026-02-20T22:09:12.9481166Z +                        "current_streak": (
2026-02-20T22:09:12.9481488Z +                            user_stats[4] if user_stats and len(user_stats) > 4 else 0
2026-02-20T22:09:12.9481632Z +                        ),
2026-02-20T22:09:12.9481770Z +                        "best_streak": (
2026-02-20T22:09:12.9482093Z +                            user_stats[5] if user_stats and len(user_stats) > 5 else 0
2026-02-20T22:09:12.9482228Z +                        ),
2026-02-20T22:09:12.9482344Z +                    }
2026-02-20T22:09:12.9482484Z +                    if user_stats
2026-02-20T22:09:12.9482597Z +                    else {
2026-02-20T22:09:12.9482752Z +                        "total_points": 0,
2026-02-20T22:09:12.9482937Z +                        "current_level": 1,
2026-02-20T22:09:12.9483326Z +                        "experience_points": 0,
2026-02-20T22:09:12.9483504Z +                        "jedi_rank": "youngling",
2026-02-20T22:09:12.9483664Z +                        "pinned_badge_ids": [],
2026-02-20T22:09:12.9483814Z +                        "current_streak": 0,
2026-02-20T22:09:12.9483960Z +                        "best_streak": 0,
2026-02-20T22:09:12.9484093Z +                    }
2026-02-20T22:09:12.9484212Z +                ),
2026-02-20T22:09:12.9484320Z              }
2026-02-20T22:09:12.9484442Z -            
2026-02-20T22:09:12.9484550Z +
2026-02-20T22:09:12.9484737Z          except Exception as user_badges_error:
2026-02-20T22:09:12.9485440Z -            logger.error(f"Erreur récupération badges utilisateur {user_id}: {user_badges_error}")
2026-02-20T22:09:12.9485660Z -            return {'earned_badges': [], 'user_stats': {}}
2026-02-20T22:09:12.9485776Z -    
2026-02-20T22:09:12.9485911Z +            logger.error(
2026-02-20T22:09:12.9486446Z +                f"Erreur récupération badges utilisateur {user_id}: {user_badges_error}"
2026-02-20T22:09:12.9486563Z +            )
2026-02-20T22:09:12.9486772Z +            return {"earned_badges": [], "user_stats": {}}
2026-02-20T22:09:12.9486890Z +
2026-02-20T22:09:12.9487271Z      def _format_requirements_to_text(self, badge: Achievement) -> Optional[str]:
2026-02-20T22:09:12.9487874Z          """Convertit le JSON requirements en texte lisible (critères d'obtention)."""
2026-02-20T22:09:12.9488320Z          if not badge.requirements:
2026-02-20T22:09:12.9488451Z              return None
2026-02-20T22:09:12.9488573Z          try:
2026-02-20T22:09:12.9489473Z -            req = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.9489672Z +            req = (
2026-02-20T22:09:12.9489904Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.9490175Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.9490379Z +                else badge.requirements
2026-02-20T22:09:12.9490534Z +            )
2026-02-20T22:09:12.9490792Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.9490983Z              return None
2026-02-20T22:09:12.9491132Z          if not isinstance(req, dict):
2026-02-20T22:09:12.9491267Z              return None
2026-02-20T22:09:12.9491431Z          # attempts_count
2026-02-20T22:09:12.9491550Z @@ -586,11 +686,16 @@
2026-02-20T22:09:12.9491963Z              return f"{target} tentatives avec {rate}% de réussite"
2026-02-20T22:09:12.9492149Z          # exercise_type + consecutive_correct
2026-02-20T22:09:12.9492396Z          ex_type = req.get("exercise_type", "").lower()
2026-02-20T22:09:12.9492589Z          consec = req.get("consecutive_correct")
2026-02-20T22:09:12.9492771Z          if consec is not None:
2026-02-20T22:09:12.9523958Z -            labels = {"addition": "additions", "soustraction": "soustractions", "multiplication": "multiplications", "division": "divisions"}
2026-02-20T22:09:12.9524194Z +            labels = {
2026-02-20T22:09:12.9524412Z +                "addition": "additions",
2026-02-20T22:09:12.9524664Z +                "soustraction": "soustractions",
2026-02-20T22:09:12.9524867Z +                "multiplication": "multiplications",
2026-02-20T22:09:12.9525034Z +                "division": "divisions",
2026-02-20T22:09:12.9525147Z +            }
2026-02-20T22:09:12.9525322Z              label = labels.get(ex_type, ex_type)
2026-02-20T22:09:12.9525760Z              return f"{consec} {label} consécutives correctes"
2026-02-20T22:09:12.9525889Z          # max_time
2026-02-20T22:09:12.9526034Z          max_t = req.get("max_time")
2026-02-20T22:09:12.9526172Z          if max_t is not None:
2026-02-20T22:09:12.9526312Z @@ -613,50 +718,62 @@
2026-02-20T22:09:12.9526650Z              return f"Revenir après {cb} jours sans activité"
2026-02-20T22:09:12.9526775Z          return None
2026-02-20T22:09:12.9526888Z  
2026-02-20T22:09:12.9527146Z      def get_available_badges(self) -> List[Dict[str, Any]]:
2026-02-20T22:09:12.9527463Z          """Récupérer tous les badges disponibles"""
2026-02-20T22:09:12.9527578Z -        
2026-02-20T22:09:12.9527700Z +
2026-02-20T22:09:12.9527822Z          try:
2026-02-20T22:09:12.9528052Z -            badges = self.db.query(Achievement).filter(
2026-02-20T22:09:12.9528234Z -                Achievement.is_active == True
2026-02-20T22:09:12.9528560Z -            ).order_by(Achievement.category, Achievement.difficulty).all()
2026-02-20T22:09:12.9528688Z -            
2026-02-20T22:09:12.9528812Z +            badges = (
2026-02-20T22:09:12.9528970Z +                self.db.query(Achievement)
2026-02-20T22:09:12.9529137Z +                .filter(Achievement.is_active == True)
2026-02-20T22:09:12.9529390Z +                .order_by(Achievement.category, Achievement.difficulty)
2026-02-20T22:09:12.9529511Z +                .all()
2026-02-20T22:09:12.9529611Z +            )
2026-02-20T22:09:12.9529709Z +
2026-02-20T22:09:12.9529816Z              return [
2026-02-20T22:09:12.9529926Z                  {
2026-02-20T22:09:12.9530057Z -                    'id': badge.id,
2026-02-20T22:09:12.9530196Z -                    'code': badge.code,
2026-02-20T22:09:12.9530346Z -                    'name': badge.name,
2026-02-20T22:09:12.9530537Z -                    'description': badge.description,
2026-02-20T22:09:12.9530831Z -                    'criteria_text': self._format_requirements_to_text(badge),
2026-02-20T22:09:12.9531307Z -                    'star_wars_title': badge.star_wars_title,
2026-02-20T22:09:12.9531501Z -                    'difficulty': badge.difficulty,
2026-02-20T22:09:12.9531699Z -                    'points_reward': badge.points_reward,
2026-02-20T22:09:12.9532048Z -                    'category': badge.category,
2026-02-20T22:09:12.9532260Z -                    'is_secret': badge.is_secret,
2026-02-20T22:09:12.9532427Z -                    'icon_url': badge.icon_url,
2026-02-20T22:09:12.9532560Z +                    "id": badge.id,
2026-02-20T22:09:12.9532712Z +                    "code": badge.code,
2026-02-20T22:09:12.9532849Z +                    "name": badge.name,
2026-02-20T22:09:12.9533272Z +                    "description": badge.description,
2026-02-20T22:09:12.9533579Z +                    "criteria_text": self._format_requirements_to_text(badge),
2026-02-20T22:09:12.9533807Z +                    "star_wars_title": badge.star_wars_title,
2026-02-20T22:09:12.9533997Z +                    "difficulty": badge.difficulty,
2026-02-20T22:09:12.9534190Z +                    "points_reward": badge.points_reward,
2026-02-20T22:09:12.9534361Z +                    "category": badge.category,
2026-02-20T22:09:12.9534521Z +                    "is_secret": badge.is_secret,
2026-02-20T22:09:12.9534691Z +                    "icon_url": badge.icon_url,
2026-02-20T22:09:12.9534820Z                  }
2026-02-20T22:09:12.9534960Z                  for badge in badges
2026-02-20T22:09:12.9535070Z              ]
2026-02-20T22:09:12.9535185Z -            
2026-02-20T22:09:12.9535303Z +
2026-02-20T22:09:12.9535510Z          except Exception as available_badges_error:
2026-02-20T22:09:12.9536143Z -            logger.error(f"Erreur récupération badges disponibles: {available_badges_error}")
2026-02-20T22:09:12.9536296Z +            logger.error(
2026-02-20T22:09:12.9536769Z +                f"Erreur récupération badges disponibles: {available_badges_error}"
2026-02-20T22:09:12.9536889Z +            )
2026-02-20T22:09:12.9537043Z              return []
2026-02-20T22:09:12.9537152Z  
2026-02-20T22:09:12.9537298Z      def _get_badge_progress(
2026-02-20T22:09:12.9537697Z -        self, user_id: int, badge: Achievement, stats_cache: Optional[Dict[str, Any]] = None
2026-02-20T22:09:12.9537816Z +        self,
2026-02-20T22:09:12.9537953Z +        user_id: int,
2026-02-20T22:09:12.9538092Z +        badge: Achievement,
2026-02-20T22:09:12.9538302Z +        stats_cache: Optional[Dict[str, Any]] = None,
2026-02-20T22:09:12.9538451Z      ) -> tuple[float, int, int]:
2026-02-20T22:09:12.9538569Z          """
2026-02-20T22:09:12.9538957Z          Calcule la progression vers un badge non débloqué.
2026-02-20T22:09:12.9539420Z          Lot C-2 : utilise badge_requirement_engine.get_requirement_progress pour tous les types.
2026-02-20T22:09:12.9539728Z          stats_cache: pré-fetch pour éviter N+1.
2026-02-20T22:09:12.9540047Z          Returns: (progress 0.0-1.0, current_value, target_value)
2026-02-20T22:09:12.9540186Z          """
2026-02-20T22:09:12.9540338Z          if not badge.requirements:
2026-02-20T22:09:12.9540470Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9540594Z          try:
2026-02-20T22:09:12.9541151Z -            req = json.loads(badge.requirements) if isinstance(badge.requirements, str) else badge.requirements
2026-02-20T22:09:12.9541285Z +            req = (
2026-02-20T22:09:12.9541460Z +                json.loads(badge.requirements)
2026-02-20T22:09:12.9541663Z +                if isinstance(badge.requirements, str)
2026-02-20T22:09:12.9541829Z +                else badge.requirements
2026-02-20T22:09:12.9541937Z +            )
2026-02-20T22:09:12.9542134Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:12.9542252Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9542395Z          if not isinstance(req, dict):
2026-02-20T22:09:12.9542528Z              return (0.0, 0, 0)
2026-02-20T22:09:12.9542634Z  
2026-02-20T22:09:12.9542754Z @@ -669,15 +786,18 @@
2026-02-20T22:09:12.9543426Z          """
2026-02-20T22:09:12.9543736Z          Progression vers les badges (unlocked + in_progress).
2026-02-20T22:09:12.9544185Z          Pré-fetch des stats communes pour éviter N+1.
2026-02-20T22:09:12.9544346Z          """
2026-02-20T22:09:12.9544510Z          earned_ids = {
2026-02-20T22:09:12.9545155Z -            r[0] for r in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.9545315Z +            r[0]
2026-02-20T22:09:12.9545668Z +            for r in self.db.query(UserAchievement.achievement_id)
2026-02-20T22:09:12.9545926Z              .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:12.9546084Z              .all()
2026-02-20T22:09:12.9546214Z          }
2026-02-20T22:09:12.9546737Z -        all_badges = self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.9546892Z +        all_badges = (
2026-02-20T22:09:12.9547329Z +            self.db.query(Achievement).filter(Achievement.is_active == True).all()
2026-02-20T22:09:12.9547478Z +        )
2026-02-20T22:09:12.9547637Z  
2026-02-20T22:09:12.9548126Z          # Pré-fetch stats pour éviter N+1 — une requête par type de donnée
2026-02-20T22:09:12.9548287Z          stats_cache: Dict[str, Any] = {}
2026-02-20T22:09:12.9548408Z          try:
2026-02-20T22:09:12.9548567Z              row = self.db.execute(
2026-02-20T22:09:12.9548692Z @@ -713,46 +833,56 @@
2026-02-20T22:09:12.9548929Z                      WHERE a.user_id = :uid AND a.is_correct = true
2026-02-20T22:09:12.9549176Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:12.9549296Z                  """),
2026-02-20T22:09:12.9549429Z                  {"uid": user_id},
2026-02-20T22:09:12.9549562Z              ).fetchall()
2026-02-20T22:09:12.9549931Z -            stats_cache["per_type_correct"] = {str(r[0]).lower(): r[1] for r in per_type}
2026-02-20T22:09:12.9550162Z +            stats_cache["per_type_correct"] = {
2026-02-20T22:09:12.9550366Z +                str(r[0]).lower(): r[1] for r in per_type
2026-02-20T22:09:12.9550492Z +            }
2026-02-20T22:09:12.9550667Z              user_types_rows = self.db.execute(
2026-02-20T22:09:12.9550803Z                  text("""
2026-02-20T22:09:12.9551136Z                      SELECT DISTINCT LOWER(e.exercise_type::text) FROM attempts a
2026-02-20T22:09:12.9551495Z                      JOIN exercises e ON a.exercise_id = e.id WHERE a.user_id = :uid
2026-02-20T22:09:12.9551615Z                  """),
2026-02-20T22:09:12.9551752Z                  {"uid": user_id},
2026-02-20T22:09:12.9551873Z              ).fetchall()
2026-02-20T22:09:12.9552265Z -            stats_cache["user_exercise_types"] = {str(r[0]).lower() for r in user_types_rows}
2026-02-20T22:09:12.9552458Z +            stats_cache["user_exercise_types"] = {
2026-02-20T22:09:12.9552653Z +                str(r[0]).lower() for r in user_types_rows
2026-02-20T22:09:12.9552765Z +            }
2026-02-20T22:09:12.9552907Z              # consecutive_days
2026-02-20T22:09:12.9583460Z              days_rows = self.db.execute(
2026-02-20T22:09:12.9583632Z                  text("""
2026-02-20T22:09:12.9583914Z                      SELECT DISTINCT DATE(created_at) as day FROM attempts
2026-02-20T22:09:12.9584160Z                      WHERE user_id = :uid ORDER BY day DESC LIMIT 35
2026-02-20T22:09:12.9584291Z                  """),
2026-02-20T22:09:12.9584428Z                  {"uid": user_id},
2026-02-20T22:09:12.9584563Z              ).fetchall()
2026-02-20T22:09:12.9585047Z -            stats_cache["activity_dates"] = [r[0] if hasattr(r, "__getitem__") else r.day for r in days_rows]
2026-02-20T22:09:12.9585228Z +            stats_cache["activity_dates"] = [
2026-02-20T22:09:12.9585514Z +                r[0] if hasattr(r, "__getitem__") else r.day for r in days_rows
2026-02-20T22:09:12.9585627Z +            ]
2026-02-20T22:09:12.9585897Z              # max_time : min time_spent parmi les tentatives correctes
2026-02-20T22:09:12.9586051Z              min_time = self.db.execute(
2026-02-20T22:09:12.9586492Z                  text(
2026-02-20T22:09:12.9586922Z                      "SELECT MIN(time_spent) FROM attempts WHERE user_id = :uid AND is_correct = true"
2026-02-20T22:09:12.9587040Z                  ),
2026-02-20T22:09:12.9587184Z                  {"uid": user_id},
2026-02-20T22:09:12.9587574Z              ).fetchone()
2026-02-20T22:09:12.9588077Z -            stats_cache["min_fast_time"] = float(min_time[0]) if min_time and min_time[0] is not None else None
2026-02-20T22:09:12.9588258Z +            stats_cache["min_fast_time"] = (
2026-02-20T22:09:12.9588570Z +                float(min_time[0]) if min_time and min_time[0] is not None else None
2026-02-20T22:09:12.9588683Z +            )
2026-02-20T22:09:12.9588833Z              # perfect_day : stats du jour
2026-02-20T22:09:12.9589036Z              today = datetime.now(timezone.utc).date()
2026-02-20T22:09:12.9589188Z              pd_row = self.db.execute(
2026-02-20T22:09:12.9589311Z                  text("""
2026-02-20T22:09:12.9589681Z                      SELECT COUNT(*) as total, COUNT(CASE WHEN is_correct THEN 1 END) as correct
2026-02-20T22:09:12.9590010Z                      FROM attempts WHERE user_id = :uid AND DATE(created_at) = :today
2026-02-20T22:09:12.9590133Z                  """),
2026-02-20T22:09:12.9590310Z                  {"uid": user_id, "today": today},
2026-02-20T22:09:12.9590438Z              ).fetchone()
2026-02-20T22:09:12.9590860Z -            stats_cache["perfect_day_today"] = (pd_row[0] or 0, pd_row[1] or 0) if pd_row else (0, 0)
2026-02-20T22:09:12.9591040Z +            stats_cache["perfect_day_today"] = (
2026-02-20T22:09:12.9591286Z +                (pd_row[0] or 0, pd_row[1] or 0) if pd_row else (0, 0)
2026-02-20T22:09:12.9591402Z +            )
2026-02-20T22:09:12.9591891Z              # consecutive par type : streak actuel (dernières tentatives)
2026-02-20T22:09:12.9592141Z              for ex_t in stats_cache.get("exercise_types", []):
2026-02-20T22:09:12.9592309Z                  streak_rows = self.db.execute(
2026-02-20T22:09:12.9592450Z                      text("""
2026-02-20T22:09:12.9592655Z                          SELECT a.is_correct FROM attempts a
2026-02-20T22:09:12.9592779Z @@ -779,23 +909,27 @@
2026-02-20T22:09:12.9592911Z          for b in all_badges:
2026-02-20T22:09:12.9593246Z              if b.id in earned_ids:
2026-02-20T22:09:12.9593575Z                  unlocked.append({"id": b.id, "code": b.code, "name": b.name})
2026-02-20T22:09:12.9593702Z              else:
2026-02-20T22:09:12.9594011Z                  prog, cur, tgt = self._get_badge_progress(user_id, b, stats_cache)
2026-02-20T22:09:12.9594177Z -                in_progress.append({
2026-02-20T22:09:12.9594306Z -                    "id": b.id,
2026-02-20T22:09:12.9594439Z -                    "code": b.code,
2026-02-20T22:09:12.9594574Z -                    "name": b.name,
2026-02-20T22:09:12.9594714Z -                    "progress": prog,
2026-02-20T22:09:12.9594825Z -                    "current": cur,
2026-02-20T22:09:12.9594931Z -                    "target": tgt,
2026-02-20T22:09:12.9595201Z -                    "criteria_text": self._format_requirements_to_text(b),
2026-02-20T22:09:12.9595406Z -                    "is_secret": getattr(b, "is_secret", False),
2026-02-20T22:09:12.9595512Z -                })
2026-02-20T22:09:12.9595664Z +                in_progress.append(
2026-02-20T22:09:12.9595772Z +                    {
2026-02-20T22:09:12.9595896Z +                        "id": b.id,
2026-02-20T22:09:12.9596034Z +                        "code": b.code,
2026-02-20T22:09:12.9596175Z +                        "name": b.name,
2026-02-20T22:09:12.9596320Z +                        "progress": prog,
2026-02-20T22:09:12.9596456Z +                        "current": cur,
2026-02-20T22:09:12.9596600Z +                        "target": tgt,
2026-02-20T22:09:12.9596873Z +                        "criteria_text": self._format_requirements_to_text(b),
2026-02-20T22:09:12.9597092Z +                        "is_secret": getattr(b, "is_secret", False),
2026-02-20T22:09:12.9597465Z +                    }
2026-02-20T22:09:12.9597578Z +                )
2026-02-20T22:09:12.9597844Z          return {"unlocked": unlocked, "in_progress": in_progress}
2026-02-20T22:09:12.9597958Z  
2026-02-20T22:09:12.9598620Z -    def get_closest_progress_notification(self, user_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9598815Z +    def get_closest_progress_notification(
2026-02-20T22:09:12.9598951Z +        self, user_id: int
2026-02-20T22:09:12.9599110Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:12.9599221Z          """
2026-02-20T22:09:12.9599779Z          Retourne le badge le plus proche du déblocage (progress >= 0.5, target > 0)
2026-02-20T22:09:12.9600106Z          pour afficher « Tu approches ! Plus que X ».
2026-02-20T22:09:12.9600387Z          Exclut les badges secrets non débloqués.
2026-02-20T22:09:12.9600499Z          """
2026-02-20T22:09:12.9600619Z @@ -809,11 +943,13 @@
2026-02-20T22:09:12.9600757Z              if prog < 0.5:
2026-02-20T22:09:12.9600897Z                  continue
2026-02-20T22:09:12.9601138Z              if p.get("is_secret") and p["id"] not in earned_ids:
2026-02-20T22:09:12.9601268Z                  continue
2026-02-20T22:09:12.9601597Z              remaining = max(0, (p.get("target", 0) or 0) - (p.get("current", 0) or 0))
2026-02-20T22:09:12.9601991Z -            candidates.append((prog, {"name": p.get("name", ""), "remaining": remaining}))
2026-02-20T22:09:12.9602140Z +            candidates.append(
2026-02-20T22:09:12.9602401Z +                (prog, {"name": p.get("name", ""), "remaining": remaining})
2026-02-20T22:09:12.9602512Z +            )
2026-02-20T22:09:12.9602643Z          if not candidates:
2026-02-20T22:09:12.9602775Z              return None
2026-02-20T22:09:12.9603311Z          candidates.sort(key=lambda x: -x[0])  # Plus haute progression d'abord
2026-02-20T22:09:12.9603463Z          return candidates[0][1]
2026-02-20T22:09:12.9603585Z  
2026-02-20T22:09:12.9603703Z @@ -821,11 +957,16 @@
2026-02-20T22:09:12.9603823Z          """
2026-02-20T22:09:12.9604302Z          Stats rareté par badge : unlock_count, unlock_percent, rarity_label.
2026-02-20T22:09:12.9604725Z          A-4 : preuve sociale (« X% ont débloqué »), indicateur rareté.
2026-02-20T22:09:12.9604840Z          """
2026-02-20T22:09:12.9604949Z          try:
2026-02-20T22:09:12.9605445Z -            total_users = self.db.query(func.count(User.id)).filter(User.is_active == True).scalar() or 1
2026-02-20T22:09:12.9605579Z +            total_users = (
2026-02-20T22:09:12.9605754Z +                self.db.query(func.count(User.id))
2026-02-20T22:09:12.9605923Z +                .filter(User.is_active == True)
2026-02-20T22:09:12.9606045Z +                .scalar()
2026-02-20T22:09:12.9606161Z +                or 1
2026-02-20T22:09:12.9606272Z +            )
2026-02-20T22:09:12.9606441Z              rows = self.db.execute(text("""
2026-02-20T22:09:12.9606863Z                  SELECT ua.achievement_id, COUNT(DISTINCT ua.user_id) as unlock_count
2026-02-20T22:09:12.9607037Z                  FROM user_achievements ua
2026-02-20T22:09:12.9607270Z                  JOIN achievements a ON a.id = ua.achievement_id
2026-02-20T22:09:12.9607418Z                  WHERE a.is_active = true
2026-02-20T22:09:12.9607540Z @@ -873,6 +1014,6 @@
2026-02-20T22:09:12.9607683Z                  self.db.commit()
2026-02-20T22:09:12.9607831Z          except Exception as e:
2026-02-20T22:09:12.9607968Z              self.db.rollback()
2026-02-20T22:09:12.9608187Z              logger.error(f"Erreur set_pinned_badges: {e}")
2026-02-20T22:09:12.9608320Z              return []
2026-02-20T22:09:12.9608443Z -        return valid 
2026-02-20T22:09:12.9608578Z \ No newline at end of file
2026-02-20T22:09:12.9608704Z +        return valid
2026-02-20T22:09:12.9609221Z would reformat /home/runner/work/mathakine/mathakine/app/services/db_init_service.py
2026-02-20T22:09:12.9609793Z --- /home/runner/work/mathakine/mathakine/app/services/db_init_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:12.9610597Z +++ /home/runner/work/mathakine/mathakine/app/services/db_init_service.py	2026-02-20 22:09:12.910586+00:00
2026-02-20T22:09:12.9610724Z @@ -1,8 +1,9 @@
2026-02-20T22:09:12.9610840Z  """
2026-02-20T22:09:12.9611175Z  Service d'initialisation de la base de données
2026-02-20T22:09:12.9611283Z  """
2026-02-20T22:09:12.9611595Z +
2026-02-20T22:09:12.9611742Z  import random
2026-02-20T22:09:12.9611914Z  from datetime import datetime, timedelta
2026-02-20T22:09:12.9612021Z  
2026-02-20T22:09:12.9612229Z  from app.core.logging_config import get_logger
2026-02-20T22:09:12.9612333Z  
2026-02-20T22:09:12.9612449Z @@ -10,12 +11,11 @@
2026-02-20T22:09:12.9612603Z  from sqlalchemy.orm import Session
2026-02-20T22:09:12.9612720Z  
2026-02-20T22:09:12.9612907Z  from app.db.base import Base, engine, get_db
2026-02-20T22:09:12.9643375Z  from app.models.attempt import Attempt
2026-02-20T22:09:12.9643770Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:12.9644080Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:12.9644278Z -                                        LogicChallengeType)
2026-02-20T22:09:12.9644700Z +from app.models.logic_challenge import AgeGroup, LogicChallenge, LogicChallengeType
2026-02-20T22:09:12.9644884Z  from app.models.user import User, UserRole
2026-02-20T22:09:12.9645086Z  from app.utils.db_helpers import get_enum_value
2026-02-20T22:09:12.9645191Z  
2026-02-20T22:09:12.9645303Z  
2026-02-20T22:09:12.9645430Z  def create_tables():
2026-02-20T22:09:12.9645548Z @@ -23,12 +23,10 @@
2026-02-20T22:09:12.9645934Z      Crée toutes les tables dans la base de données.
2026-02-20T22:09:12.9646050Z      """
2026-02-20T22:09:12.9646445Z      logger.info("Création des tables dans la base de données")
2026-02-20T22:09:12.9646619Z      Base.metadata.create_all(bind=engine)
2026-02-20T22:09:12.9646921Z      logger.success("Tables créées avec succès")
2026-02-20T22:09:12.9647027Z -
2026-02-20T22:09:12.9647131Z -
2026-02-20T22:09:12.9647247Z  
2026-02-20T22:09:12.9647370Z  
2026-02-20T22:09:12.9647519Z  def populate_test_data():
2026-02-20T22:09:12.9647634Z      """
2026-02-20T22:09:12.9647995Z      Remplit la base de données avec des données de test.
2026-02-20T22:09:12.9648116Z @@ -54,16 +52,16 @@
2026-02-20T22:09:12.9648222Z  
2026-02-20T22:09:12.9648372Z          db.commit()
2026-02-20T22:09:12.9648734Z          logger.success("Données de test créées avec succès")
2026-02-20T22:09:12.9648937Z      except Exception as test_data_creation_error:
2026-02-20T22:09:12.9649072Z          db.rollback()
2026-02-20T22:09:12.9649721Z -        logger.error(f"Erreur lors de la création des données de test: {str(test_data_creation_error)}")
2026-02-20T22:09:12.9649856Z +        logger.error(
2026-02-20T22:09:12.9650396Z +            f"Erreur lors de la création des données de test: {str(test_data_creation_error)}"
2026-02-20T22:09:12.9650520Z +        )
2026-02-20T22:09:12.9650630Z          raise
2026-02-20T22:09:12.9650746Z      finally:
2026-02-20T22:09:12.9650884Z          db.close()
2026-02-20T22:09:12.9650989Z -
2026-02-20T22:09:12.9651095Z -
2026-02-20T22:09:12.9651199Z  
2026-02-20T22:09:12.9651310Z  
2026-02-20T22:09:12.9651468Z  def create_test_users(db: Session):
2026-02-20T22:09:12.9651580Z      """
2026-02-20T22:09:12.9651959Z      Crée des utilisateurs de test dans la base de données.
2026-02-20T22:09:12.9652081Z @@ -119,12 +117,10 @@
2026-02-20T22:09:12.9652209Z      db.add_all(users)
2026-02-20T22:09:12.9652323Z      db.flush()
2026-02-20T22:09:12.9652822Z      logger.info(f"{len(users)} utilisateurs créés (incluant ObiWan permanent)")
2026-02-20T22:09:12.9652938Z  
2026-02-20T22:09:12.9653274Z  
2026-02-20T22:09:12.9653391Z -
2026-02-20T22:09:12.9653498Z -
2026-02-20T22:09:12.9653678Z  def create_test_exercises(db: Session):
2026-02-20T22:09:12.9653795Z      """
2026-02-20T22:09:12.9654174Z      Crée des exercices de test dans la base de données.
2026-02-20T22:09:12.9654292Z      """
2026-02-20T22:09:12.9654596Z      logger.info("Création des exercices de test")
2026-02-20T22:09:12.9654981Z @@ -180,12 +176,10 @@
2026-02-20T22:09:12.9655125Z      db.add_all(exercises)
2026-02-20T22:09:12.9655244Z      db.flush()
2026-02-20T22:09:12.9655556Z      logger.info(f"{len(exercises)} exercices créés")
2026-02-20T22:09:12.9655663Z  
2026-02-20T22:09:12.9655761Z  
2026-02-20T22:09:12.9656046Z -
2026-02-20T22:09:12.9656157Z -
2026-02-20T22:09:12.9656318Z  def create_test_attempts(db: Session):
2026-02-20T22:09:12.9656426Z      """
2026-02-20T22:09:12.9656760Z      Crée des tentatives de test dans la base de données.
2026-02-20T22:09:12.9656886Z      """
2026-02-20T22:09:12.9657202Z      logger.info("Création des tentatives de test")
2026-02-20T22:09:12.9657333Z @@ -197,11 +191,13 @@
2026-02-20T22:09:12.9657446Z  
2026-02-20T22:09:12.9657839Z      # Récupérer un utilisateur Padawan avec l'énumération native
2026-02-20T22:09:12.9658167Z      padawan = db.query(User).filter(User.role == UserRole.PADAWAN).first()
2026-02-20T22:09:12.9658282Z  
2026-02-20T22:09:12.9658452Z      if not padawan:
2026-02-20T22:09:12.9659039Z -        logger.warning("Aucun utilisateur Padawan trouvé, création des tentatives ignorée")
2026-02-20T22:09:12.9659175Z +        logger.warning(
2026-02-20T22:09:12.9659660Z +            "Aucun utilisateur Padawan trouvé, création des tentatives ignorée"
2026-02-20T22:09:12.9659791Z +        )
2026-02-20T22:09:12.9659906Z          return
2026-02-20T22:09:12.9660021Z  
2026-02-20T22:09:12.9660261Z      # Récupérer tous les exercices
2026-02-20T22:09:12.9660426Z      exercises = db.query(Exercise).all()
2026-02-20T22:09:12.9660532Z  
2026-02-20T22:09:12.9660658Z @@ -226,20 +222,22 @@
2026-02-20T22:09:12.9660772Z          db.flush()
2026-02-20T22:09:12.9661242Z          logger.info(f"Tentative réussie créée pour l'exercice {exercise.id}")
2026-02-20T22:09:12.9661359Z  
2026-02-20T22:09:12.9661597Z          # Créer une tentative échouée
2026-02-20T22:09:12.9661731Z          failed_answer = ""
2026-02-20T22:09:12.9661839Z -        
2026-02-20T22:09:12.9661971Z +
2026-02-20T22:09:12.9662208Z          if exercise.choices and len(exercise.choices) > 0:
2026-02-20T22:09:12.9662611Z -            incorrect_choices = [c for c in exercise.choices if c != exercise.correct_answer]
2026-02-20T22:09:12.9662766Z +            incorrect_choices = [
2026-02-20T22:09:12.9663254Z +                c for c in exercise.choices if c != exercise.correct_answer
2026-02-20T22:09:12.9663377Z +            ]
2026-02-20T22:09:12.9663522Z              if incorrect_choices:
2026-02-20T22:09:12.9663750Z                  failed_answer = random.choice(incorrect_choices)
2026-02-20T22:09:12.9663863Z -        
2026-02-20T22:09:12.9663967Z +
2026-02-20T22:09:12.9664438Z          # Si on n'a pas trouvé de mauvaise réponse, on utilise juste un espace
2026-02-20T22:09:12.9664578Z          if not failed_answer:
2026-02-20T22:09:12.9664718Z              failed_answer = " "
2026-02-20T22:09:12.9664836Z -            
2026-02-20T22:09:12.9664938Z +
2026-02-20T22:09:12.9665078Z          failed_attempt = Attempt(
2026-02-20T22:09:12.9665230Z              user_id=padawan.id,
2026-02-20T22:09:12.9665384Z              exercise_id=exercise.id,
2026-02-20T22:09:12.9665525Z              user_answer=failed_answer,
2026-02-20T22:09:12.9665654Z              is_correct=False,
2026-02-20T22:09:12.9665781Z @@ -251,12 +249,10 @@
2026-02-20T22:09:12.9665929Z          db.add(failed_attempt)
2026-02-20T22:09:12.9666047Z          db.flush()
2026-02-20T22:09:12.9666531Z          logger.info(f"Tentative échouée créée pour l'exercice {exercise.id}")
2026-02-20T22:09:12.9666642Z  
2026-02-20T22:09:12.9667039Z      logger.info(f"Tentatives créées pour {len(exercises)} exercices")
2026-02-20T22:09:12.9667146Z -
2026-02-20T22:09:12.9667262Z -
2026-02-20T22:09:12.9667363Z  
2026-02-20T22:09:12.9667461Z  
2026-02-20T22:09:12.9667659Z  def create_test_logic_challenges(db: Session):
2026-02-20T22:09:12.9667781Z      """
2026-02-20T22:09:12.9668139Z      Crée des défis logiques de test dans la base de données.
2026-02-20T22:09:12.9668257Z @@ -308,26 +304,27 @@
2026-02-20T22:09:12.9668640Z      db.add_all(logic_challenges)
2026-02-20T22:09:12.9668758Z      db.flush()
2026-02-20T22:09:12.9669157Z      logger.info(f"{len(logic_challenges)} défis logiques créés")
2026-02-20T22:09:12.9669275Z  
2026-02-20T22:09:12.9669378Z  
2026-02-20T22:09:12.9669479Z -
2026-02-20T22:09:12.9669785Z -
2026-02-20T22:09:12.9669961Z  def initialize_database():
2026-02-20T22:09:12.9670074Z      """
2026-02-20T22:09:12.9670582Z      Initialise la base de données avec les tables et les données nécessaires.
2026-02-20T22:09:12.9670704Z -    
2026-02-20T22:09:12.9670807Z +
2026-02-20T22:09:12.9671320Z      ATTENTION : populate_test_data() n'est appelé qu'en dehors de la production.
2026-02-20T22:09:12.9671771Z      Les fonctions de peuplement vérifient déjà si des données existent.
2026-02-20T22:09:12.9671893Z      """
2026-02-20T22:09:12.9672012Z      import os
2026-02-20T22:09:12.9672119Z +
2026-02-20T22:09:12.9672235Z      try:
2026-02-20T22:09:12.9672366Z          create_tables()
2026-02-20T22:09:12.9672630Z          environment = os.getenv("ENVIRONMENT", "development")
2026-02-20T22:09:12.9672791Z          if environment != "production":
2026-02-20T22:09:12.9672944Z              populate_test_data()
2026-02-20T22:09:12.9703352Z          else:
2026-02-20T22:09:12.9703844Z              logger.info("Mode production : pas de données de test")
2026-02-20T22:09:12.9704257Z          logger.success("Base de données initialisée avec succès")
2026-02-20T22:09:12.9704424Z      except Exception as db_init_error:
2026-02-20T22:09:12.9705055Z -        logger.error(f"Erreur lors de l'initialisation de la base de données: {str(db_init_error)}")
2026-02-20T22:09:12.9705191Z -        raise
2026-02-20T22:09:12.9705337Z \ No newline at end of file
2026-02-20T22:09:12.9705465Z +        logger.error(
2026-02-20T22:09:12.9706007Z +            f"Erreur lors de l'initialisation de la base de données: {str(db_init_error)}"
2026-02-20T22:09:12.9706129Z +        )
2026-02-20T22:09:12.9706243Z +        raise
2026-02-20T22:09:13.0336416Z --- /home/runner/work/mathakine/mathakine/app/services/email_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.0338827Z +++ /home/runner/work/mathakine/mathakine/app/services/email_service.py	2026-02-20 22:09:13.030432+00:00
2026-02-20T22:09:13.0339884Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.0340453Z  """
2026-02-20T22:09:13.0340818Z  Service d'envoi d'emails pour Mathakine
2026-02-20T22:09:13.0341350Z  Support SMTP et SendGrid (optionnel)
2026-02-20T22:09:13.0341775Z  """
2026-02-20T22:09:13.0342040Z +
2026-02-20T22:09:13.0342308Z  import os
2026-02-20T22:09:13.0342591Z  import smtplib
2026-02-20T22:09:13.0343174Z  from email.mime.multipart import MIMEMultipart
2026-02-20T22:09:13.0343725Z  from email.mime.text import MIMEText
2026-02-20T22:09:13.0344202Z  from typing import Optional
2026-02-20T22:09:13.0344580Z @@ -29,35 +30,36 @@
2026-02-20T22:09:13.0344899Z          Mail,
2026-02-20T22:09:13.0345187Z          To,
2026-02-20T22:09:13.0345503Z          TrackingSettings,
2026-02-20T22:09:13.0345898Z          ClickTracking,
2026-02-20T22:09:13.0346224Z      )
2026-02-20T22:09:13.0346500Z +
2026-02-20T22:09:13.0346791Z      SENDGRID_AVAILABLE = True
2026-02-20T22:09:13.0347200Z  except ImportError:
2026-02-20T22:09:13.0347578Z      SENDGRID_AVAILABLE = False
2026-02-20T22:09:13.0348199Z      logger.debug("SendGrid non disponible, utilisation SMTP uniquement")
2026-02-20T22:09:13.0348832Z  
2026-02-20T22:09:13.0349104Z  
2026-02-20T22:09:13.0349387Z  class EmailService:
2026-02-20T22:09:13.0349769Z      """Service pour l'envoi d'emails"""
2026-02-20T22:09:13.0350201Z -    
2026-02-20T22:09:13.0350468Z +
2026-02-20T22:09:13.0350741Z      @staticmethod
2026-02-20T22:09:13.0351071Z      def send_email(
2026-02-20T22:09:13.0351411Z          to_email: str,
2026-02-20T22:09:13.0351747Z          subject: str,
2026-02-20T22:09:13.0352102Z          html_content: str,
2026-02-20T22:09:13.0352501Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0353175Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0354017Z      ) -> bool:
2026-02-20T22:09:13.0354305Z          """
2026-02-20T22:09:13.0354611Z          Envoie un email.
2026-02-20T22:09:13.0355331Z would reformat /home/runner/work/mathakine/mathakine/app/services/email_service.py
2026-02-20T22:09:13.0356278Z -        
2026-02-20T22:09:13.0356581Z +
2026-02-20T22:09:13.0356829Z          Args:
2026-02-20T22:09:13.0357206Z              to_email: Adresse email du destinataire
2026-02-20T22:09:13.0357712Z              subject: Sujet de l'email
2026-02-20T22:09:13.0358194Z              html_content: Contenu HTML de l'email
2026-02-20T22:09:13.0358787Z              text_content: Contenu texte alternatif (optionnel)
2026-02-20T22:09:13.0359302Z -        
2026-02-20T22:09:13.0359574Z +
2026-02-20T22:09:13.0359825Z          Returns:
2026-02-20T22:09:13.0360528Z              True si l'email a été envoyé avec succès, False sinon
2026-02-20T22:09:13.0361067Z          """
2026-02-20T22:09:13.0361456Z          if os.getenv("TESTING", "false").lower() == "true":
2026-02-20T22:09:13.0362331Z              logger.debug(f"[Email] Mode test : envoi simulé vers {to_email}")
2026-02-20T22:09:13.0363156Z @@ -65,152 +67,176 @@
2026-02-20T22:09:13.0363475Z  
2026-02-20T22:09:13.0363856Z          # Vérifier si SendGrid est configuré
2026-02-20T22:09:13.0364336Z          sendgrid_api_key = os.getenv("SENDGRID_API_KEY")
2026-02-20T22:09:13.0364841Z          if sendgrid_api_key and SENDGRID_AVAILABLE:
2026-02-20T22:09:13.0365396Z              logger.info(f"[Email] Envoi via SendGrid vers {to_email}")
2026-02-20T22:09:13.0366216Z -            return EmailService._send_via_sendgrid(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0366988Z +            return EmailService._send_via_sendgrid(
2026-02-20T22:09:13.0367501Z +                to_email, subject, html_content, text_content
2026-02-20T22:09:13.0367970Z +            )
2026-02-20T22:09:13.0368246Z          else:
2026-02-20T22:09:13.0369237Z -            logger.info(f"[Email] Envoi via SMTP vers {to_email} (SendGrid: key={'✓' if sendgrid_api_key else '✗'}, pkg={SENDGRID_AVAILABLE})")
2026-02-20T22:09:13.0370261Z -            return EmailService._send_via_smtp(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0370913Z -    
2026-02-20T22:09:13.0371205Z +            logger.info(
2026-02-20T22:09:13.0372234Z +                f"[Email] Envoi via SMTP vers {to_email} (SendGrid: key={'✓' if sendgrid_api_key else '✗'}, pkg={SENDGRID_AVAILABLE})"
2026-02-20T22:09:13.0373330Z +            )
2026-02-20T22:09:13.0373708Z +            return EmailService._send_via_smtp(
2026-02-20T22:09:13.0374263Z +                to_email, subject, html_content, text_content
2026-02-20T22:09:13.0374745Z +            )
2026-02-20T22:09:13.0375033Z +
2026-02-20T22:09:13.0375323Z      @staticmethod
2026-02-20T22:09:13.0375657Z      def _send_via_sendgrid(
2026-02-20T22:09:13.0376045Z          to_email: str,
2026-02-20T22:09:13.0376391Z          subject: str,
2026-02-20T22:09:13.0376765Z          html_content: str,
2026-02-20T22:09:13.0377167Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0377604Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0378024Z      ) -> bool:
2026-02-20T22:09:13.0378371Z          """Envoie un email via SendGrid API"""
2026-02-20T22:09:13.0378837Z          try:
2026-02-20T22:09:13.0379232Z              sendgrid_api_key = os.getenv("SENDGRID_API_KEY")
2026-02-20T22:09:13.0379741Z              if not sendgrid_api_key:
2026-02-20T22:09:13.0381822Z                  logger.error("SENDGRID_API_KEY non configurée")
2026-02-20T22:09:13.0382397Z                  return False
2026-02-20T22:09:13.0382767Z -            
2026-02-20T22:09:13.0383261Z +
2026-02-20T22:09:13.0383696Z              sg = sendgrid.SendGridAPIClient(api_key=sendgrid_api_key)
2026-02-20T22:09:13.0384519Z -            from_email = Email(os.getenv("SENDGRID_FROM_EMAIL", "noreply@mathakine.com"))
2026-02-20T22:09:13.0385234Z +            from_email = Email(
2026-02-20T22:09:13.0386064Z +                os.getenv("SENDGRID_FROM_EMAIL", "noreply@mathakine.com")
2026-02-20T22:09:13.0386629Z +            )
2026-02-20T22:09:13.0386942Z              to_email_obj = To(to_email)
2026-02-20T22:09:13.0387354Z -            
2026-02-20T22:09:13.0387634Z +
2026-02-20T22:09:13.0388131Z              if text_content:
2026-02-20T22:09:13.0388631Z                  content = Content("text/plain", text_content)
2026-02-20T22:09:13.0389121Z              else:
2026-02-20T22:09:13.0389530Z                  # Extraire le texte depuis le HTML si possible
2026-02-20T22:09:13.0390047Z                  import re
2026-02-20T22:09:13.0390520Z -                text_content = re.sub(r'<[^>]+>', '', html_content)
2026-02-20T22:09:13.0391039Z +
2026-02-20T22:09:13.0391430Z +                text_content = re.sub(r"<[^>]+>", "", html_content)
2026-02-20T22:09:13.0392023Z                  content = Content("text/html", html_content)
2026-02-20T22:09:13.0392507Z -            
2026-02-20T22:09:13.0392799Z +
2026-02-20T22:09:13.0393293Z              message = Mail(
2026-02-20T22:09:13.0393694Z                  from_email=from_email,
2026-02-20T22:09:13.0394128Z                  to_emails=to_email_obj,
2026-02-20T22:09:13.0394560Z                  subject=subject,
2026-02-20T22:09:13.0394984Z -                html_content=html_content
2026-02-20T22:09:13.0395452Z +                html_content=html_content,
2026-02-20T22:09:13.0395871Z              )
2026-02-20T22:09:13.0396715Z              # Désactiver le click tracking : les liens restent directs (verify-email, reset-password)
2026-02-20T22:09:13.0397597Z              message.tracking_settings = TrackingSettings()
2026-02-20T22:09:13.0398361Z              message.tracking_settings.click_tracking = ClickTracking(enable=False)
2026-02-20T22:09:13.0399016Z  
2026-02-20T22:09:13.0399299Z              if text_content:
2026-02-20T22:09:13.0399841Z                  message.add_content(Content("text/plain", text_content))
2026-02-20T22:09:13.0400415Z -            
2026-02-20T22:09:13.0400722Z +
2026-02-20T22:09:13.0401016Z              response = sg.send(message)
2026-02-20T22:09:13.0401432Z -            
2026-02-20T22:09:13.0401718Z +
2026-02-20T22:09:13.0402055Z              if response.status_code in [200, 201, 202]:
2026-02-20T22:09:13.0402853Z                  logger.info(f"Email envoyé via SendGrid à {to_email}")
2026-02-20T22:09:13.0403633Z                  return True
2026-02-20T22:09:13.0404005Z              else:
2026-02-20T22:09:13.0404649Z -                logger.error(f"Erreur SendGrid: {response.status_code} - {response.body}")
2026-02-20T22:09:13.0405365Z +                logger.error(
2026-02-20T22:09:13.0405913Z +                    f"Erreur SendGrid: {response.status_code} - {response.body}"
2026-02-20T22:09:13.0406521Z +                )
2026-02-20T22:09:13.0406853Z                  return False
2026-02-20T22:09:13.0407199Z -                
2026-02-20T22:09:13.0407492Z +
2026-02-20T22:09:13.0407815Z          except Exception as sendgrid_error:
2026-02-20T22:09:13.0408509Z              logger.error(f"Erreur lors de l'envoi via SendGrid: {sendgrid_error}")
2026-02-20T22:09:13.0409158Z              return False
2026-02-20T22:09:13.0409504Z -    
2026-02-20T22:09:13.0409764Z +
2026-02-20T22:09:13.0410037Z      @staticmethod
2026-02-20T22:09:13.0410364Z      def _send_via_smtp(
2026-02-20T22:09:13.0410744Z          to_email: str,
2026-02-20T22:09:13.0411090Z          subject: str,
2026-02-20T22:09:13.0411433Z          html_content: str,
2026-02-20T22:09:13.0411840Z -        text_content: Optional[str] = None
2026-02-20T22:09:13.0412345Z +        text_content: Optional[str] = None,
2026-02-20T22:09:13.0412787Z      ) -> bool:
2026-02-20T22:09:13.0413374Z          """Envoie un email via SMTP"""
2026-02-20T22:09:13.0413805Z          try:
2026-02-20T22:09:13.0414264Z              # Configuration SMTP depuis les variables d'environnement
2026-02-20T22:09:13.0414971Z              smtp_host = os.getenv("SMTP_HOST", "smtp.gmail.com")
2026-02-20T22:09:13.0415604Z              smtp_port = int(os.getenv("SMTP_PORT", "587"))
2026-02-20T22:09:13.0416434Z              smtp_user = os.getenv("SMTP_USER", "")
2026-02-20T22:09:13.0416990Z              smtp_password = os.getenv("SMTP_PASSWORD", "")
2026-02-20T22:09:13.0418004Z -            smtp_from_email = os.getenv("SMTP_FROM_EMAIL", smtp_user or "noreply@mathakine.com")
2026-02-20T22:09:13.0418798Z +            smtp_from_email = os.getenv(
2026-02-20T22:09:13.0419351Z +                "SMTP_FROM_EMAIL", smtp_user or "noreply@mathakine.com"
2026-02-20T22:09:13.0419906Z +            )
2026-02-20T22:09:13.0420394Z              smtp_use_tls = os.getenv("SMTP_USE_TLS", "true").lower() == "true"
2026-02-20T22:09:13.0420974Z -            
2026-02-20T22:09:13.0421266Z +
2026-02-20T22:09:13.0421792Z              # Si SMTP non configuré, logger et retourner False
2026-02-20T22:09:13.0422397Z              if not smtp_user or not smtp_password:
2026-02-20T22:09:13.0423377Z                  logger.warning(f"SMTP non configuré - Email non envoyé")
2026-02-20T22:09:13.0424839Z -                logger.warning(f"SMTP_USER={'configuré' if smtp_user else 'MANQUANT'}, SMTP_PASSWORD={'configuré' if smtp_password else 'MANQUANT'}")
2026-02-20T22:09:13.0425905Z +                logger.warning(
2026-02-20T22:09:13.0427025Z +                    f"SMTP_USER={'configuré' if smtp_user else 'MANQUANT'}, SMTP_PASSWORD={'configuré' if smtp_password else 'MANQUANT'}"
2026-02-20T22:09:13.0427965Z +                )
2026-02-20T22:09:13.0428637Z                  logger.info(f"Email qui aurait été envoyé à {to_email}: {subject}")
2026-02-20T22:09:13.0429524Z                  # En développement, on peut simuler l'envoi
2026-02-20T22:09:13.0430165Z                  if os.getenv("ENVIRONMENT", "").lower() != "production":
2026-02-20T22:09:13.0431002Z                      logger.info("Mode développement: Email simulé")
2026-02-20T22:09:13.0431557Z                      return True
2026-02-20T22:09:13.0431947Z                  return False
2026-02-20T22:09:13.0432314Z -            
2026-02-20T22:09:13.0433307Z -            logger.info(f"Tentative d'envoi email SMTP à {to_email} via {smtp_host}:{smtp_port}")
2026-02-20T22:09:13.0434089Z -            
2026-02-20T22:09:13.0434363Z +
2026-02-20T22:09:13.0434643Z +            logger.info(
2026-02-20T22:09:13.0435402Z +                f"Tentative d'envoi email SMTP à {to_email} via {smtp_host}:{smtp_port}"
2026-02-20T22:09:13.0436069Z +            )
2026-02-20T22:09:13.0436363Z +
2026-02-20T22:09:13.0436739Z              # Créer le message
2026-02-20T22:09:13.0437196Z -            msg = MIMEMultipart('alternative')
2026-02-20T22:09:13.0437689Z -            msg['Subject'] = subject
2026-02-20T22:09:13.0438147Z -            msg['From'] = smtp_from_email
2026-02-20T22:09:13.0438586Z -            msg['To'] = to_email
2026-02-20T22:09:13.0438962Z -            
2026-02-20T22:09:13.0439300Z +            msg = MIMEMultipart("alternative")
2026-02-20T22:09:13.0439777Z +            msg["Subject"] = subject
2026-02-20T22:09:13.0440199Z +            msg["From"] = smtp_from_email
2026-02-20T22:09:13.0440644Z +            msg["To"] = to_email
2026-02-20T22:09:13.0441017Z +
2026-02-20T22:09:13.0441323Z              # Ajouter le contenu texte si fourni
2026-02-20T22:09:13.0441806Z              if text_content:
2026-02-20T22:09:13.0442272Z -                part_text = MIMEText(text_content, 'plain')
2026-02-20T22:09:13.0442863Z +                part_text = MIMEText(text_content, "plain")
2026-02-20T22:09:13.0443539Z                  msg.attach(part_text)
2026-02-20T22:09:13.0443923Z -            
2026-02-20T22:09:13.0444198Z +
2026-02-20T22:09:13.0444495Z              # Ajouter le contenu HTML
2026-02-20T22:09:13.0444996Z -            part_html = MIMEText(html_content, 'html')
2026-02-20T22:09:13.0445558Z +            part_html = MIMEText(html_content, "html")
2026-02-20T22:09:13.0446064Z              msg.attach(part_html)
2026-02-20T22:09:13.0446453Z -            
2026-02-20T22:09:13.0446742Z +
2026-02-20T22:09:13.0447019Z              # Envoyer l'email
2026-02-20T22:09:13.0447973Z              logger.debug(f"Connexion SMTP à {smtp_host}:{smtp_port}")
2026-02-20T22:09:13.0448661Z              with smtplib.SMTP(smtp_host, smtp_port) as server:
2026-02-20T22:09:13.0449557Z                  logger.debug(f"Connexion établie, démarrage TLS: {smtp_use_tls}")
2026-02-20T22:09:13.0450446Z                  if smtp_use_tls:
2026-02-20T22:09:13.0450889Z                      server.starttls()
2026-02-20T22:09:13.0451433Z                  logger.debug(f"Authentification avec {smtp_user}")
2026-02-20T22:09:13.0452042Z                  server.login(smtp_user, smtp_password)
2026-02-20T22:09:13.0452760Z                  logger.debug(f"Envoi du message à {to_email}")
2026-02-20T22:09:13.0453502Z                  server.send_message(msg)
2026-02-20T22:09:13.0453936Z -            
2026-02-20T22:09:13.0454684Z -            logger.info(f"✅ Email envoyé via SMTP à {to_email} depuis {smtp_from_email}")
2026-02-20T22:09:13.0455373Z +
2026-02-20T22:09:13.0455657Z +            logger.info(
2026-02-20T22:09:13.0456361Z +                f"✅ Email envoyé via SMTP à {to_email} depuis {smtp_from_email}"
2026-02-20T22:09:13.0456969Z +            )
2026-02-20T22:09:13.0457277Z              return True
2026-02-20T22:09:13.0457615Z -            
2026-02-20T22:09:13.0457894Z +
2026-02-20T22:09:13.0458360Z          except smtplib.SMTPAuthenticationError as smtp_auth_error:
2026-02-20T22:09:13.0459329Z              logger.error(f"❌ Erreur d'authentification SMTP: {smtp_auth_error}")
2026-02-20T22:09:13.0460299Z              logger.error(f"Vérifiez SMTP_USER ({smtp_user}) et SMTP_PASSWORD")
2026-02-20T22:09:13.0460939Z              return False
2026-02-20T22:09:13.0461375Z          except smtplib.SMTPException as smtp_error:
2026-02-20T22:09:13.0462087Z              logger.error(f"❌ Erreur SMTP: {smtp_error}")
2026-02-20T22:09:13.0462588Z              return False
2026-02-20T22:09:13.0463184Z          except Exception as smtp_general_error:
2026-02-20T22:09:13.0464275Z -            logger.error(f"❌ Erreur lors de l'envoi via SMTP: {type(smtp_general_error).__name__}: {smtp_general_error}")
2026-02-20T22:09:13.0465176Z +            logger.error(
2026-02-20T22:09:13.0466081Z +                f"❌ Erreur lors de l'envoi via SMTP: {type(smtp_general_error).__name__}: {smtp_general_error}"
2026-02-20T22:09:13.0466870Z +            )
2026-02-20T22:09:13.0467189Z              import traceback
2026-02-20T22:09:13.0467544Z +
2026-02-20T22:09:13.0467880Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:13.0468350Z              return False
2026-02-20T22:09:13.0468690Z -    
2026-02-20T22:09:13.0468956Z +
2026-02-20T22:09:13.0469236Z      @staticmethod
2026-02-20T22:09:13.0469588Z      def send_verification_email(
2026-02-20T22:09:13.0469996Z          to_email: str,
2026-02-20T22:09:13.0470351Z          username: str,
2026-02-20T22:09:13.0470700Z          verification_token: str,
2026-02-20T22:09:13.0471135Z -        frontend_url: Optional[str] = None
2026-02-20T22:09:13.0471622Z +        frontend_url: Optional[str] = None,
2026-02-20T22:09:13.0472087Z      ) -> bool:
2026-02-20T22:09:13.0472376Z          """
2026-02-20T22:09:13.0472910Z          Envoie un email de vérification à l'inscription.
2026-02-20T22:09:13.0473832Z          Template thème Jedi, ergonomique et accessible.
2026-02-20T22:09:13.0474327Z          """
2026-02-20T22:09:13.0474648Z          if not frontend_url:
2026-02-20T22:09:13.0475367Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.0476173Z +            frontend_url = os.getenv(
2026-02-20T22:09:13.0476768Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.0477364Z +            )
2026-02-20T22:09:13.0477930Z          verification_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:13.0478737Z          subject = "Bienvenue ! Active ton compte Mathakine"
2026-02-20T22:09:13.0479463Z          html_content = verification_email_html(username, verification_link)
2026-02-20T22:09:13.0480538Z          text_content = verification_email_text(username, verification_link)
2026-02-20T22:09:13.0481415Z          return EmailService.send_email(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0482108Z @@ -218,19 +244,20 @@
2026-02-20T22:09:13.0482670Z      @staticmethod
2026-02-20T22:09:13.0483224Z      def send_password_reset_email(
2026-02-20T22:09:13.0483664Z          to_email: str,
2026-02-20T22:09:13.0484005Z          username: str,
2026-02-20T22:09:13.0484356Z          reset_token: str,
2026-02-20T22:09:13.0484755Z -        frontend_url: Optional[str] = None
2026-02-20T22:09:13.0485232Z +        frontend_url: Optional[str] = None,
2026-02-20T22:09:13.0485670Z      ) -> bool:
2026-02-20T22:09:13.0485958Z          """
2026-02-20T22:09:13.0486522Z          Envoie un email de réinitialisation de mot de passe.
2026-02-20T22:09:13.0487265Z          Template thème Jedi, ergonomique et accessible.
2026-02-20T22:09:13.0487762Z          """
2026-02-20T22:09:13.0488086Z          if not frontend_url:
2026-02-20T22:09:13.0488776Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.0489695Z +            frontend_url = os.getenv(
2026-02-20T22:09:13.0490293Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.0490894Z +            )
2026-02-20T22:09:13.0491381Z          reset_link = f"{frontend_url}/reset-password?token={reset_token}"
2026-02-20T22:09:13.0492306Z          subject = "Réinitialisation de ton mot de passe — Mathakine"
2026-02-20T22:09:13.0493277Z          html_content = password_reset_email_html(username, reset_link)
2026-02-20T22:09:13.0494061Z          text_content = password_reset_email_text(username, reset_link)
2026-02-20T22:09:13.0494912Z          return EmailService.send_email(to_email, subject, html_content, text_content)
2026-02-20T22:09:13.0495583Z -
2026-02-20T22:09:13.1504369Z --- /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.1505989Z +++ /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py	2026-02-20 22:09:13.145701+00:00
2026-02-20T22:09:13.1507044Z @@ -1,10 +1,11 @@
2026-02-20T22:09:13.1507369Z  """
2026-02-20T22:09:13.1507768Z  Service d'adaptation pour enhanced_server.py.
2026-02-20T22:09:13.1508975Z  Permet d'utiliser le système de transaction et les services avec enhanced_server.py
2026-02-20T22:09:13.1509798Z  sans modifier massivement le serveur existant.
2026-02-20T22:09:13.1510288Z  """
2026-02-20T22:09:13.1510556Z +
2026-02-20T22:09:13.1510815Z  import json
2026-02-20T22:09:13.1511220Z  from typing import Any, Dict, List, Optional, Union
2026-02-20T22:09:13.1511697Z  
2026-02-20T22:09:13.1512043Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.1512504Z  
2026-02-20T22:09:13.1512757Z @@ -22,170 +23,177 @@
2026-02-20T22:09:13.1513305Z  
2026-02-20T22:09:13.1513554Z  
2026-02-20T22:09:13.1513995Z  def _serialize_exercise(exercise: Exercise) -> Dict[str, Any]:
2026-02-20T22:09:13.1514545Z      """
2026-02-20T22:09:13.1515262Z      Helper pour sérialiser un objet Exercise en dictionnaire JSON-sérialisable.
2026-02-20T22:09:13.1515907Z -    
2026-02-20T22:09:13.1516163Z +
2026-02-20T22:09:13.1516404Z      Args:
2026-02-20T22:09:13.1516744Z          exercise: Objet Exercise SQLAlchemy
2026-02-20T22:09:13.1517177Z -        
2026-02-20T22:09:13.1517437Z +
2026-02-20T22:09:13.1517687Z      Returns:
2026-02-20T22:09:13.1518114Z          Dictionnaire sérialisable en JSON
2026-02-20T22:09:13.1518541Z      """
2026-02-20T22:09:13.1518934Z      # Convertir les énumérations en strings
2026-02-20T22:09:13.1519968Z -    exercise_type_value = exercise.exercise_type.value if hasattr(exercise.exercise_type, 'value') else str(exercise.exercise_type)
2026-02-20T22:09:13.1521503Z -    difficulty_value = exercise.difficulty.value if hasattr(exercise.difficulty, 'value') else str(exercise.difficulty)
2026-02-20T22:09:13.1522874Z -    
2026-02-20T22:09:13.1523380Z +    exercise_type_value = (
2026-02-20T22:09:13.1523770Z +        exercise.exercise_type.value
2026-02-20T22:09:13.1524246Z +        if hasattr(exercise.exercise_type, "value")
2026-02-20T22:09:13.1524752Z +        else str(exercise.exercise_type)
2026-02-20T22:09:13.1525428Z +    )
2026-02-20T22:09:13.1525738Z +    difficulty_value = (
2026-02-20T22:09:13.1526129Z +        exercise.difficulty.value
2026-02-20T22:09:13.1526591Z +        if hasattr(exercise.difficulty, "value")
2026-02-20T22:09:13.1527100Z +        else str(exercise.difficulty)
2026-02-20T22:09:13.1527501Z +    )
2026-02-20T22:09:13.1527758Z +
2026-02-20T22:09:13.1528068Z      # Convertir les dates en ISO format strings
2026-02-20T22:09:13.1528793Z      created_at_str = exercise.created_at.isoformat() if exercise.created_at else None
2026-02-20T22:09:13.1529762Z      updated_at_str = exercise.updated_at.isoformat() if exercise.updated_at else None
2026-02-20T22:09:13.1530435Z -    
2026-02-20T22:09:13.1530703Z +
2026-02-20T22:09:13.1531214Z      # Gérer les choices (peut être JSON string ou list)
2026-02-20T22:09:13.1531741Z      choices_value = exercise.choices
2026-02-20T22:09:13.1532203Z      if isinstance(choices_value, str):
2026-02-20T22:09:13.1532615Z          try:
2026-02-20T22:09:13.1533183Z              choices_value = json.loads(choices_value)
2026-02-20T22:09:13.1533726Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:13.1534199Z              choices_value = []
2026-02-20T22:09:13.1534593Z      elif choices_value is None:
2026-02-20T22:09:13.1534998Z          choices_value = []
2026-02-20T22:09:13.1535332Z -    
2026-02-20T22:09:13.1535594Z +
2026-02-20T22:09:13.1535821Z      return {
2026-02-20T22:09:13.1536120Z -        'id': exercise.id,
2026-02-20T22:09:13.1536507Z -        'title': exercise.title,
2026-02-20T22:09:13.1536941Z -        'creator_id': exercise.creator_id,
2026-02-20T22:09:13.1537447Z -        'exercise_type': exercise_type_value,
2026-02-20T22:09:13.1537936Z -        'difficulty': difficulty_value,
2026-02-20T22:09:13.1538388Z -        'tags': exercise.tags,
2026-02-20T22:09:13.1538794Z -        'question': exercise.question,
2026-02-20T22:09:13.1539277Z -        'correct_answer': exercise.correct_answer,
2026-02-20T22:09:13.1539758Z -        'choices': choices_value,
2026-02-20T22:09:13.1540202Z -        'explanation': exercise.explanation,
2026-02-20T22:09:13.1540665Z -        'hint': exercise.hint,
2026-02-20T22:09:13.1541066Z -        'image_url': exercise.image_url,
2026-02-20T22:09:13.1541536Z -        'audio_url': exercise.audio_url,
2026-02-20T22:09:13.1541973Z -        'is_active': exercise.is_active,
2026-02-20T22:09:13.1542436Z -        'is_archived': exercise.is_archived,
2026-02-20T22:09:13.1543191Z -        'ai_generated': getattr(exercise, 'ai_generated', False),
2026-02-20T22:09:13.1543820Z -        'view_count': exercise.view_count or 0,
2026-02-20T22:09:13.1544308Z -        'created_at': created_at_str,
2026-02-20T22:09:13.1544741Z -        'updated_at': updated_at_str,
2026-02-20T22:09:13.1545208Z +        "id": exercise.id,
2026-02-20T22:09:13.1545601Z +        "title": exercise.title,
2026-02-20T22:09:13.1546039Z +        "creator_id": exercise.creator_id,
2026-02-20T22:09:13.1546540Z +        "exercise_type": exercise_type_value,
2026-02-20T22:09:13.1547055Z +        "difficulty": difficulty_value,
2026-02-20T22:09:13.1547507Z +        "tags": exercise.tags,
2026-02-20T22:09:13.1547889Z +        "question": exercise.question,
2026-02-20T22:09:13.1548337Z +        "correct_answer": exercise.correct_answer,
2026-02-20T22:09:13.1548853Z +        "choices": choices_value,
2026-02-20T22:09:13.1549301Z +        "explanation": exercise.explanation,
2026-02-20T22:09:13.1549772Z +        "hint": exercise.hint,
2026-02-20T22:09:13.1550164Z +        "image_url": exercise.image_url,
2026-02-20T22:09:13.1550620Z +        "audio_url": exercise.audio_url,
2026-02-20T22:09:13.1551090Z +        "is_active": exercise.is_active,
2026-02-20T22:09:13.1551548Z +        "is_archived": exercise.is_archived,
2026-02-20T22:09:13.1552415Z +        "ai_generated": getattr(exercise, "ai_generated", False),
2026-02-20T22:09:13.1553223Z +        "view_count": exercise.view_count or 0,
2026-02-20T22:09:13.1553735Z +        "created_at": created_at_str,
2026-02-20T22:09:13.1554416Z +        "updated_at": updated_at_str,
2026-02-20T22:09:13.1554850Z      }
2026-02-20T22:09:13.1555112Z  
2026-02-20T22:09:13.1555348Z  
2026-02-20T22:09:13.1555631Z  class EnhancedServerAdapter:
2026-02-20T22:09:13.1556006Z      """
2026-02-20T22:09:13.1556316Z      Adaptateur pour enhanced_server.py.
2026-02-20T22:09:13.1557107Z      Fournit des méthodes qui correspondent aux opérations SQL directes
2026-02-20T22:09:13.1558039Z      dans enhanced_server.py, mais utilise notre système de transaction.
2026-02-20T22:09:13.1558638Z      """
2026-02-20T22:09:13.1558893Z -    
2026-02-20T22:09:13.1559150Z +
2026-02-20T22:09:13.1559404Z      @staticmethod
2026-02-20T22:09:13.1559747Z      def get_db_session() -> Session:
2026-02-20T22:09:13.1560151Z          """
2026-02-20T22:09:13.1560595Z          Obtient une session de base de données.
2026-02-20T22:09:13.1561219Z          Remplace la fonction get_db_connection() de enhanced_server.py.
2026-02-20T22:09:13.1561778Z -        
2026-02-20T22:09:13.1562034Z +
2026-02-20T22:09:13.1562301Z          Returns:
2026-02-20T22:09:13.1562638Z              Session: Une session SQLAlchemy
2026-02-20T22:09:13.1593372Z          """
2026-02-20T22:09:13.1593720Z          return SessionLocal()
2026-02-20T22:09:13.1594091Z -    
2026-02-20T22:09:13.1594383Z +
2026-02-20T22:09:13.1594643Z      @staticmethod
2026-02-20T22:09:13.1595033Z      def close_db_session(db: Session) -> None:
2026-02-20T22:09:13.1595477Z          """
2026-02-20T22:09:13.1595972Z          Ferme une session de base de données.
2026-02-20T22:09:13.1596396Z -        
2026-02-20T22:09:13.1596660Z +
2026-02-20T22:09:13.1596904Z          Args:
2026-02-20T22:09:13.1597278Z              db: Session à fermer
2026-02-20T22:09:13.1597677Z          """
2026-02-20T22:09:13.1597956Z          db.close()
2026-02-20T22:09:13.1598256Z -    
2026-02-20T22:09:13.1598506Z +
2026-02-20T22:09:13.1598762Z      @staticmethod
2026-02-20T22:09:13.1599319Z      def get_exercise_by_id(db: Session, exercise_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1599999Z          """
2026-02-20T22:09:13.1600426Z          Récupère un exercice par son ID.
2026-02-20T22:09:13.1600862Z -        
2026-02-20T22:09:13.1601119Z +
2026-02-20T22:09:13.1601372Z          Args:
2026-02-20T22:09:13.1601776Z              db: Session de base de données
2026-02-20T22:09:13.1602239Z              exercise_id: ID de l'exercice
2026-02-20T22:09:13.1602651Z -            
2026-02-20T22:09:13.1602924Z +
2026-02-20T22:09:13.1603389Z          Returns:
2026-02-20T22:09:13.1603977Z              Un dictionnaire contenant les données de l'exercice ou None
2026-02-20T22:09:13.1604679Z          """
2026-02-20T22:09:13.1605187Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.1606097Z          if exercise:
2026-02-20T22:09:13.1606609Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1653474Z          return None
2026-02-20T22:09:13.1653877Z -    
2026-02-20T22:09:13.1654140Z +
2026-02-20T22:09:13.1654405Z      @staticmethod
2026-02-20T22:09:13.1654776Z      def list_exercises(
2026-02-20T22:09:13.1655138Z -        db: Session, 
2026-02-20T22:09:13.1655471Z +        db: Session,
2026-02-20T22:09:13.1655832Z          exercise_type: Optional[str] = None,
2026-02-20T22:09:13.1656330Z          difficulty: Optional[str] = None,
2026-02-20T22:09:13.1656780Z -        limit: Optional[int] = None
2026-02-20T22:09:13.1657207Z +        limit: Optional[int] = None,
2026-02-20T22:09:13.1657629Z      ) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1658002Z          """
2026-02-20T22:09:13.1658390Z          Liste les exercices actifs avec filtrage optionnel.
2026-02-20T22:09:13.1658877Z -        
2026-02-20T22:09:13.1659148Z +
2026-02-20T22:09:13.1659819Z          Args:
2026-02-20T22:09:13.1660336Z              db: Session de base de données
2026-02-20T22:09:13.1660937Z              exercise_type: Type d'exercice à filtrer
2026-02-20T22:09:13.1661590Z              difficulty: Niveau de difficulté à filtrer
2026-02-20T22:09:13.1662471Z              limit: Nombre maximum d'exercices à retourner
2026-02-20T22:09:13.1663225Z -            
2026-02-20T22:09:13.1663522Z +
2026-02-20T22:09:13.1663783Z          Returns:
2026-02-20T22:09:13.1664390Z              Liste de dictionnaires contenant les données des exercices
2026-02-20T22:09:13.1664946Z          """
2026-02-20T22:09:13.1665314Z          exercises = ExerciseService.list_exercises(
2026-02-20T22:09:13.1665780Z -            db,
2026-02-20T22:09:13.1666118Z -            exercise_type=exercise_type,
2026-02-20T22:09:13.1666569Z -            difficulty=difficulty,
2026-02-20T22:09:13.1666982Z -            limit=limit
2026-02-20T22:09:13.1667505Z +            db, exercise_type=exercise_type, difficulty=difficulty, limit=limit
2026-02-20T22:09:13.1668134Z          )
2026-02-20T22:09:13.1668393Z -        
2026-02-20T22:09:13.1668661Z +
2026-02-20T22:09:13.1669334Z          # Convertir les objets SQLAlchemy en dictionnaires avec sérialisation des dates
2026-02-20T22:09:13.1670153Z          return [_serialize_exercise(ex) for ex in exercises]
2026-02-20T22:09:13.1670657Z -    
2026-02-20T22:09:13.1670921Z -    @staticmethod
2026-02-20T22:09:13.1671561Z -    def create_exercise(db: Session, exercise_data: Dict[str, Any]) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1672297Z +
2026-02-20T22:09:13.1672564Z +    @staticmethod
2026-02-20T22:09:13.1672877Z +    def create_exercise(
2026-02-20T22:09:13.1673529Z +        db: Session, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.1674027Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1674411Z          """
2026-02-20T22:09:13.1674820Z          Crée un nouvel exercice.
2026-02-20T22:09:13.1675191Z -        
2026-02-20T22:09:13.1675463Z +
2026-02-20T22:09:13.1675719Z          Args:
2026-02-20T22:09:13.1676144Z              db: Session de base de données
2026-02-20T22:09:13.1676696Z              exercise_data: Données de l'exercice
2026-02-20T22:09:13.1677140Z -            
2026-02-20T22:09:13.1677408Z +
2026-02-20T22:09:13.1677657Z          Returns:
2026-02-20T22:09:13.1678109Z              Un dictionnaire contenant les données de l'exercice créé ou None
2026-02-20T22:09:13.1678228Z          """
2026-02-20T22:09:13.1678522Z          exercise = ExerciseService.create_exercise(db, exercise_data)
2026-02-20T22:09:13.1678645Z          if exercise:
2026-02-20T22:09:13.1678810Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1678938Z          return None
2026-02-20T22:09:13.1679045Z -    
2026-02-20T22:09:13.1679150Z +
2026-02-20T22:09:13.1679273Z      @staticmethod
2026-02-20T22:09:13.1679412Z      def create_generated_exercise(
2026-02-20T22:09:13.1679534Z -        db: Session, 
2026-02-20T22:09:13.1679667Z -        exercise_type: str, 
2026-02-20T22:09:13.1679802Z +        db: Session,
2026-02-20T22:09:13.1679937Z +        exercise_type: str,
2026-02-20T22:09:13.1680252Z          age_group: str,  # Ajout du paramètre manquant
2026-02-20T22:09:13.1680396Z -        difficulty: str, 
2026-02-20T22:09:13.1680525Z +        difficulty: str,
2026-02-20T22:09:13.1680652Z          title: str,
2026-02-20T22:09:13.1680778Z          question: str,
2026-02-20T22:09:13.1680920Z          correct_answer: str,
2026-02-20T22:09:13.1681047Z          choices: List[str],
2026-02-20T22:09:13.1681180Z          explanation: str,
2026-02-20T22:09:13.1681335Z          hint: Optional[str] = None,
2026-02-20T22:09:13.1681473Z          tags: Optional[str] = None,
2026-02-20T22:09:13.1682034Z would reformat /home/runner/work/mathakine/mathakine/app/services/enhanced_server_adapter.py
2026-02-20T22:09:13.1682190Z          ai_generated: bool = False,
2026-02-20T22:09:13.1682322Z -        locale: str = "fr"
2026-02-20T22:09:13.1682446Z +        locale: str = "fr",
2026-02-20T22:09:13.1682859Z      ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1713209Z          """
2026-02-20T22:09:13.1713724Z          Crée un nouvel exercice généré avec support des traductions.
2026-02-20T22:09:13.1714575Z          Cette méthode est spécifiquement conçue pour les fonctions de génération d'exercices
2026-02-20T22:09:13.1714758Z          dans enhanced_server.py.
2026-02-20T22:09:13.1714873Z -        
2026-02-20T22:09:13.1714984Z +
2026-02-20T22:09:13.1715107Z          Args:
2026-02-20T22:09:13.1715632Z              db: Session de base de données (non utilisée, conservée pour compatibilité)
2026-02-20T22:09:13.1715798Z              exercise_type: Type d'exercice
2026-02-20T22:09:13.1716067Z              age_group: Groupe d'âge de l'exercice
2026-02-20T22:09:13.1716285Z              difficulty: Niveau de difficulté
2026-02-20T22:09:13.1716405Z @@ -196,39 +204,42 @@
2026-02-20T22:09:13.1716675Z              explanation: Explication de la réponse
2026-02-20T22:09:13.1716827Z              hint: Indice (optionnel)
2026-02-20T22:09:13.1716984Z              tags: Tags (optionnel)
2026-02-20T22:09:13.1717309Z              ai_generated: Si l'exercice a été généré par IA
2026-02-20T22:09:13.1717739Z              locale: Locale pour la création des traductions (défaut: "fr")
2026-02-20T22:09:13.1717870Z -            
2026-02-20T22:09:13.1717978Z +
2026-02-20T22:09:13.1718090Z          Returns:
2026-02-20T22:09:13.1718533Z              Un dictionnaire contenant les données de l'exercice créé ou None
2026-02-20T22:09:13.1718643Z          """
2026-02-20T22:09:13.1719146Z          # NOTE: exercise_service_translations archivé - utiliser ExerciseService ORM
2026-02-20T22:09:13.1719341Z          from app.services import ExerciseService
2026-02-20T22:09:13.1719444Z -        
2026-02-20T22:09:13.1719549Z +
2026-02-20T22:09:13.1719678Z          exercise_data = {
2026-02-20T22:09:13.1719813Z -            'title': title,
2026-02-20T22:09:13.1719973Z -            'exercise_type': exercise_type,
2026-02-20T22:09:13.1720380Z -            'age_group': age_group,  # Utilisation du nouveau paramètre
2026-02-20T22:09:13.1720538Z -            'difficulty': difficulty,
2026-02-20T22:09:13.1720675Z -            'question': question,
2026-02-20T22:09:13.1720834Z -            'correct_answer': correct_answer,
2026-02-20T22:09:13.1720982Z -            'choices': choices,
2026-02-20T22:09:13.1721133Z -            'explanation': explanation,
2026-02-20T22:09:13.1721254Z -            'hint': hint,
2026-02-20T22:09:13.1721398Z -            'tags': tags or "generated",
2026-02-20T22:09:13.1721556Z -            'ai_generated': ai_generated,
2026-02-20T22:09:13.1721687Z -            'is_active': True,
2026-02-20T22:09:13.1721819Z -            'is_archived': False,
2026-02-20T22:09:13.1721957Z -            'view_count': 0
2026-02-20T22:09:13.1722084Z +            "title": title,
2026-02-20T22:09:13.1722240Z +            "exercise_type": exercise_type,
2026-02-20T22:09:13.1722629Z +            "age_group": age_group,  # Utilisation du nouveau paramètre
2026-02-20T22:09:13.1722789Z +            "difficulty": difficulty,
2026-02-20T22:09:13.1722921Z +            "question": question,
2026-02-20T22:09:13.1723270Z +            "correct_answer": correct_answer,
2026-02-20T22:09:13.1723416Z +            "choices": choices,
2026-02-20T22:09:13.1723579Z +            "explanation": explanation,
2026-02-20T22:09:13.1723701Z +            "hint": hint,
2026-02-20T22:09:13.1723855Z +            "tags": tags or "generated",
2026-02-20T22:09:13.1724000Z +            "ai_generated": ai_generated,
2026-02-20T22:09:13.1724128Z +            "is_active": True,
2026-02-20T22:09:13.1724258Z +            "is_archived": False,
2026-02-20T22:09:13.1724393Z +            "view_count": 0,
2026-02-20T22:09:13.1724501Z          }
2026-02-20T22:09:13.1724609Z -        
2026-02-20T22:09:13.1725441Z -        logger.info(f"Création d'un exercice généré de type {exercise_type}, groupe d'âge {age_group}, difficulté {difficulty}")
2026-02-20T22:09:13.1725551Z +
2026-02-20T22:09:13.1725907Z +        logger.info(
2026-02-20T22:09:13.1726632Z +            f"Création d'un exercice généré de type {exercise_type}, groupe d'âge {age_group}, difficulté {difficulty}"
2026-02-20T22:09:13.1726755Z +        )
2026-02-20T22:09:13.1726970Z          # NOTE: Utiliser ExerciseService ORM directement
2026-02-20T22:09:13.1727363Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1727497Z          try:
2026-02-20T22:09:13.1727689Z              from app.models.exercise import Exercise
2026-02-20T22:09:13.1727798Z +
2026-02-20T22:09:13.1727981Z              exercise = Exercise(**exercise_data)
2026-02-20T22:09:13.1728108Z              db.add(exercise)
2026-02-20T22:09:13.1728231Z              db.commit()
2026-02-20T22:09:13.1728364Z              db.refresh(exercise)
2026-02-20T22:09:13.1728537Z              return _serialize_exercise(exercise)
2026-02-20T22:09:13.1728671Z @@ -236,139 +247,148 @@
2026-02-20T22:09:13.1729139Z              logger.error(f"Erreur création exercice: {exercise_creation_error}")
2026-02-20T22:09:13.1729281Z              db.rollback()
2026-02-20T22:09:13.1729411Z              return None
2026-02-20T22:09:13.1729520Z          finally:
2026-02-20T22:09:13.1729724Z              EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.1729831Z -    
2026-02-20T22:09:13.1729960Z -    @staticmethod
2026-02-20T22:09:13.1730398Z -    def update_exercise(db: Session, exercise_id: int, exercise_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.1730508Z +
2026-02-20T22:09:13.1730633Z +    @staticmethod
2026-02-20T22:09:13.1730766Z +    def update_exercise(
2026-02-20T22:09:13.1731034Z +        db: Session, exercise_id: int, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.1731151Z +    ) -> bool:
2026-02-20T22:09:13.1731267Z          """
2026-02-20T22:09:13.1731505Z          Met à jour un exercice existant.
2026-02-20T22:09:13.1731609Z -        
2026-02-20T22:09:13.1731715Z +
2026-02-20T22:09:13.1731820Z          Args:
2026-02-20T22:09:13.1732039Z              db: Session de base de données
2026-02-20T22:09:13.1732336Z              exercise_id: ID de l'exercice à mettre à jour
2026-02-20T22:09:13.1732660Z              exercise_data: Nouvelles données de l'exercice
2026-02-20T22:09:13.1732767Z -            
2026-02-20T22:09:13.1732868Z +
2026-02-20T22:09:13.1733188Z          Returns:
2026-02-20T22:09:13.1733506Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.1733617Z          """
2026-02-20T22:09:13.1733976Z          return ExerciseService.update_exercise(db, exercise_id, exercise_data)
2026-02-20T22:09:13.1734082Z -    
2026-02-20T22:09:13.1734184Z +
2026-02-20T22:09:13.1734298Z      @staticmethod
2026-02-20T22:09:13.1734573Z      def archive_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.1734683Z          """
2026-02-20T22:09:13.1735149Z          Archive un exercice (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.1735260Z -        
2026-02-20T22:09:13.1735363Z +
2026-02-20T22:09:13.1735484Z          Args:
2026-02-20T22:09:13.1735723Z              db: Session de base de données
2026-02-20T22:09:13.1736007Z              exercise_id: ID de l'exercice à archiver
2026-02-20T22:09:13.1736117Z -            
2026-02-20T22:09:13.1736219Z +
2026-02-20T22:09:13.1736342Z          Returns:
2026-02-20T22:09:13.1736631Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.1736742Z          """
2026-02-20T22:09:13.1737003Z          return ExerciseService.archive_exercise(db, exercise_id)
2026-02-20T22:09:13.1737117Z -    
2026-02-20T22:09:13.1737228Z -    @staticmethod
2026-02-20T22:09:13.1737660Z -    def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1737771Z +
2026-02-20T22:09:13.1737890Z +    @staticmethod
2026-02-20T22:09:13.1738023Z +    def record_attempt(
2026-02-20T22:09:13.1738194Z +        db: Session, attempt_data: Dict[str, Any]
2026-02-20T22:09:13.1738349Z +    ) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1738727Z          """
2026-02-20T22:09:13.1739242Z          Enregistre une tentative de résolution d'exercice avec PostgreSQL direct.
2026-02-20T22:09:13.1739367Z -        
2026-02-20T22:09:13.1739470Z +
2026-02-20T22:09:13.1739578Z          Args:
2026-02-20T22:09:13.1740260Z              db: Session de base de données (non utilisée, conservée pour compatibilité)
2026-02-20T22:09:13.1740537Z              attempt_data: Données de la tentative
2026-02-20T22:09:13.1740646Z -            
2026-02-20T22:09:13.1740748Z +
2026-02-20T22:09:13.1740859Z          Returns:
2026-02-20T22:09:13.1741305Z              Un dictionnaire contenant les données de la tentative créée ou None
2026-02-20T22:09:13.1741415Z          """
2026-02-20T22:09:13.1741855Z          # NOTE: attempt_service_translations archivé - utiliser Attempt ORM
2026-02-20T22:09:13.1742035Z          from app.models.attempt import Attempt
2026-02-20T22:09:13.1742146Z -        
2026-02-20T22:09:13.1742248Z +
2026-02-20T22:09:13.1742414Z          attempt = Attempt(**attempt_data)
2026-02-20T22:09:13.1742566Z          db.add(attempt)
2026-02-20T22:09:13.1742684Z          db.commit()
2026-02-20T22:09:13.1742824Z          db.refresh(attempt)
2026-02-20T22:09:13.1742947Z          return attempt
2026-02-20T22:09:13.1773319Z -    
2026-02-20T22:09:13.1773461Z -    @staticmethod
2026-02-20T22:09:13.1773901Z -    def get_user_stats(db: Session, user_id: int, time_range: str = "30") -> Dict[str, Any]:
2026-02-20T22:09:13.1774017Z +
2026-02-20T22:09:13.1774136Z +    @staticmethod
2026-02-20T22:09:13.1774271Z +    def get_user_stats(
2026-02-20T22:09:13.1774480Z +        db: Session, user_id: int, time_range: str = "30"
2026-02-20T22:09:13.1774607Z +    ) -> Dict[str, Any]:
2026-02-20T22:09:13.1774710Z          """
2026-02-20T22:09:13.1775041Z          Récupère les statistiques d'un utilisateur.
2026-02-20T22:09:13.1775154Z -        
2026-02-20T22:09:13.1775259Z +
2026-02-20T22:09:13.1775378Z          Args:
2026-02-20T22:09:13.1775620Z              db: Session de base de données
2026-02-20T22:09:13.1775777Z              user_id: ID de l'utilisateur
2026-02-20T22:09:13.1776138Z              time_range: Période de temps ("7", "30", "90", "all")
2026-02-20T22:09:13.1776248Z -            
2026-02-20T22:09:13.1776351Z +
2026-02-20T22:09:13.1776462Z          Returns:
2026-02-20T22:09:13.1776764Z              Un dictionnaire contenant les statistiques de l'utilisateur
2026-02-20T22:09:13.1776873Z          """
2026-02-20T22:09:13.1777203Z          return UserService.get_user_stats(db, user_id, time_range=time_range)
2026-02-20T22:09:13.1777315Z -    
2026-02-20T22:09:13.1777433Z -    @staticmethod
2026-02-20T22:09:13.1777876Z -    def execute_raw_query(db: Session, query: str, params: dict = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1777982Z +
2026-02-20T22:09:13.1778105Z +    @staticmethod
2026-02-20T22:09:13.1778235Z +    def execute_raw_query(
2026-02-20T22:09:13.1778432Z +        db: Session, query: str, params: dict = None
2026-02-20T22:09:13.1778573Z +    ) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1778691Z          """
2026-02-20T22:09:13.1779106Z          Exécute une requête SQL brute (paramètres nommés uniquement).
2026-02-20T22:09:13.1779554Z          À utiliser uniquement pour la compatibilité avec le code existant.
2026-02-20T22:09:13.1779891Z          Privilégier les méthodes du service (audit 3.1).
2026-02-20T22:09:13.1780005Z -        
2026-02-20T22:09:13.1780111Z +
2026-02-20T22:09:13.1780229Z          Args:
2026-02-20T22:09:13.1780469Z              db: Session de base de données
2026-02-20T22:09:13.1780832Z              query: Requête SQL avec paramètres nommés (:param_name)
2026-02-20T22:09:13.1781138Z              params: Dictionnaire de paramètres nommés
2026-02-20T22:09:13.1781248Z -            
2026-02-20T22:09:13.1781352Z +
2026-02-20T22:09:13.1781463Z          Returns:
2026-02-20T22:09:13.1781794Z              Liste de dictionnaires contenant les résultats
2026-02-20T22:09:13.1781902Z          """
2026-02-20T22:09:13.1782524Z -        logger.warning("Utilisation de execute_raw_query - À remplacer par les méthodes du service")
2026-02-20T22:09:13.1782912Z +        logger.warning(
2026-02-20T22:09:13.1783617Z +            "Utilisation de execute_raw_query - À remplacer par les méthodes du service"
2026-02-20T22:09:13.1783719Z +        )
2026-02-20T22:09:13.1784237Z          return DatabaseAdapter.execute_query(db, query, params or {})
2026-02-20T22:09:13.1784378Z -    
2026-02-20T22:09:13.1784484Z +
2026-02-20T22:09:13.1784820Z      # === MÉTHODES POUR LOGIC CHALLENGES (NOUVEAU !) ===
2026-02-20T22:09:13.1784936Z -    
2026-02-20T22:09:13.1785043Z +
2026-02-20T22:09:13.1785162Z      @staticmethod
2026-02-20T22:09:13.1785533Z      def get_logic_challenges(limit: Optional[int] = None) -> List[Dict[str, Any]]:
2026-02-20T22:09:13.1785642Z          """
2026-02-20T22:09:13.1785946Z          Récupère la liste des logic challenges actifs.
2026-02-20T22:09:13.1786075Z -        
2026-02-20T22:09:13.1786187Z +
2026-02-20T22:09:13.1786298Z          Args:
2026-02-20T22:09:13.1786643Z              limit: Nombre maximum de challenges à retourner
2026-02-20T22:09:13.1786761Z -            
2026-02-20T22:09:13.1786867Z +
2026-02-20T22:09:13.1786981Z          Returns:
2026-02-20T22:09:13.1787414Z              Liste de dictionnaires contenant les données des logic challenges
2026-02-20T22:09:13.1787540Z          """
2026-02-20T22:09:13.1787731Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1787839Z          try:
2026-02-20T22:09:13.1788087Z -            challenges = LogicChallengeService.list_challenges(
2026-02-20T22:09:13.1788198Z -                db, 
2026-02-20T22:09:13.1788323Z -                limit=limit
2026-02-20T22:09:13.1788427Z -            )
2026-02-20T22:09:13.1788538Z -            
2026-02-20T22:09:13.1788866Z +            challenges = LogicChallengeService.list_challenges(db, limit=limit)
2026-02-20T22:09:13.1788967Z +
2026-02-20T22:09:13.1789551Z              # Convertir en dictionnaires - utiliser to_dict() pour éviter les erreurs d'attributs
2026-02-20T22:09:13.1789750Z              return [ch.to_dict() for ch in challenges]
2026-02-20T22:09:13.1789978Z          except Exception as e:
2026-02-20T22:09:13.1790475Z              logger.error(f"Erreur lors de la récupération des logic challenges: {e}")
2026-02-20T22:09:13.1790600Z              return []
2026-02-20T22:09:13.1790721Z          finally:
2026-02-20T22:09:13.1790925Z              EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.1791032Z -    
2026-02-20T22:09:13.1791131Z +
2026-02-20T22:09:13.1791250Z      @staticmethod
2026-02-20T22:09:13.1791586Z      def get_logic_challenge(challenge_id: int) -> Optional[Dict[str, Any]]:
2026-02-20T22:09:13.1791692Z          """
2026-02-20T22:09:13.1791963Z          Récupère un logic challenge par son ID.
2026-02-20T22:09:13.1792071Z -        
2026-02-20T22:09:13.1792183Z +
2026-02-20T22:09:13.1792294Z          Args:
2026-02-20T22:09:13.1792444Z              challenge_id: ID du challenge
2026-02-20T22:09:13.1792564Z -            
2026-02-20T22:09:13.1792678Z +
2026-02-20T22:09:13.1792789Z          Returns:
2026-02-20T22:09:13.1793373Z              Un dictionnaire contenant les données du challenge ou None
2026-02-20T22:09:13.1793499Z          """
2026-02-20T22:09:13.1793689Z          db = EnhancedServerAdapter.get_db_session()
2026-02-20T22:09:13.1793807Z          try:
2026-02-20T22:09:13.1794131Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.1794256Z              if challenge:
2026-02-20T22:09:13.1794413Z                  return challenge.to_dict()
2026-02-20T22:09:13.1794545Z              return None
2026-02-20T22:09:13.1794680Z          except Exception as e:
2026-02-20T22:09:13.1795259Z -            logger.error(f"Erreur lors de la récupération du logic challenge {challenge_id}: {e}")
2026-02-20T22:09:13.1795390Z +            logger.error(
2026-02-20T22:09:13.1795870Z +                f"Erreur lors de la récupération du logic challenge {challenge_id}: {e}"
2026-02-20T22:09:13.1795979Z +            )
2026-02-20T22:09:13.1796332Z              return None
2026-02-20T22:09:13.1796456Z          finally:
2026-02-20T22:09:13.1796677Z -            EnhancedServerAdapter.close_db_session(db) 
2026-02-20T22:09:13.1796812Z \ No newline at end of file
2026-02-20T22:09:13.1797200Z +            EnhancedServerAdapter.close_db_session(db)
2026-02-20T22:09:13.2604194Z --- /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.2609120Z would reformat /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py
2026-02-20T22:09:13.2611734Z +++ /home/runner/work/mathakine/mathakine/app/services/logic_challenge_service.py	2026-02-20 22:09:13.256723+00:00
2026-02-20T22:09:13.2614099Z @@ -1,235 +1,277 @@
2026-02-20T22:09:13.2615614Z  """
2026-02-20T22:09:13.2617795Z  Service pour la gestion des défis de logique mathématique (Épreuves du Conseil Jedi).
2026-02-20T22:09:13.2620248Z  Implémente les opérations métier liées aux défis logiques et utilise le transaction manager.
2026-02-20T22:09:13.2622214Z  """
2026-02-20T22:09:13.2624115Z +
2026-02-20T22:09:13.2624728Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:13.2625203Z  
2026-02-20T22:09:13.2625566Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.2626073Z  
2026-02-20T22:09:13.2626360Z  logger = get_logger(__name__)
2026-02-20T22:09:13.2626781Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.2627174Z  
2026-02-20T22:09:13.2627498Z  from app.db.adapter import DatabaseAdapter
2026-02-20T22:09:13.2628063Z  from app.db.transaction import TransactionManager
2026-02-20T22:09:13.2628989Z -from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:13.2629653Z -                                        LogicChallengeAttempt,
2026-02-20T22:09:13.2647982Z -                                        LogicChallengeType)
2026-02-20T22:09:13.2654957Z +from app.models.logic_challenge import (
2026-02-20T22:09:13.2656607Z +    AgeGroup,
2026-02-20T22:09:13.2661308Z +    LogicChallenge,
2026-02-20T22:09:13.2694730Z +    LogicChallengeAttempt,
2026-02-20T22:09:13.2695465Z +    LogicChallengeType,
2026-02-20T22:09:13.2699701Z +)
2026-02-20T22:09:13.2700537Z  from app.utils.db_helpers import adapt_enum_for_db, get_enum_value
2026-02-20T22:09:13.2701373Z  
2026-02-20T22:09:13.2701641Z  
2026-02-20T22:09:13.2701930Z  class LogicChallengeService:
2026-02-20T22:09:13.2702763Z      """
2026-02-20T22:09:13.2703518Z      Service pour la gestion des défis de logique mathématique.
2026-02-20T22:09:13.2704410Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des défis.
2026-02-20T22:09:13.2705027Z      """
2026-02-20T22:09:13.2705278Z -    
2026-02-20T22:09:13.2705518Z +
2026-02-20T22:09:13.2705767Z      @staticmethod
2026-02-20T22:09:13.2706292Z      def get_challenge(db: Session, challenge_id: int) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2706921Z          """
2026-02-20T22:09:13.2707349Z          Récupère un défi par son ID.
2026-02-20T22:09:13.2707784Z -        
2026-02-20T22:09:13.2708049Z +
2026-02-20T22:09:13.2708298Z          Args:
2026-02-20T22:09:13.2708735Z              db: Session de base de données
2026-02-20T22:09:13.2709315Z              challenge_id: ID du défi à récupérer
2026-02-20T22:09:13.2709760Z -            
2026-02-20T22:09:13.2710054Z +
2026-02-20T22:09:13.2710310Z          Returns:
2026-02-20T22:09:13.2710841Z              Le défi correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.2711357Z          """
2026-02-20T22:09:13.2711838Z          return DatabaseAdapter.get_by_id(db, LogicChallenge, challenge_id)
2026-02-20T22:09:13.2712454Z -    
2026-02-20T22:09:13.2712719Z +
2026-02-20T22:09:13.2713174Z      @staticmethod
2026-02-20T22:09:13.2713516Z      def list_challenges(
2026-02-20T22:09:13.2713864Z -        db: Session, 
2026-02-20T22:09:13.2714188Z +        db: Session,
2026-02-20T22:09:13.2714552Z          challenge_type: Optional[str] = None,
2026-02-20T22:09:13.2715033Z          age_group: Optional[str] = None,
2026-02-20T22:09:13.2715928Z          limit: Optional[int] = None,
2026-02-20T22:09:13.2716360Z -        offset: Optional[int] = None
2026-02-20T22:09:13.2716793Z +        offset: Optional[int] = None,
2026-02-20T22:09:13.2717278Z      ) -> List[LogicChallenge]:
2026-02-20T22:09:13.2717862Z          """
2026-02-20T22:09:13.2718403Z          Liste les défis actifs avec filtrage optionnel.
2026-02-20T22:09:13.2718888Z -        
2026-02-20T22:09:13.2719165Z +
2026-02-20T22:09:13.2719461Z          Args:
2026-02-20T22:09:13.2719865Z              db: Session de base de données
2026-02-20T22:09:13.2720522Z              challenge_type: Type de défi à filtrer (optionnel)
2026-02-20T22:09:13.2721218Z              age_group: Groupe d'âge à filtrer (optionnel)
2026-02-20T22:09:13.2721881Z              limit: Nombre maximum de défis à retourner
2026-02-20T22:09:13.2722503Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.2722942Z -            
2026-02-20T22:09:13.2744566Z +
2026-02-20T22:09:13.2744823Z          Returns:
2026-02-20T22:09:13.2745383Z              Liste des défis correspondants aux critères
2026-02-20T22:09:13.2745866Z          """
2026-02-20T22:09:13.2746152Z          try:
2026-02-20T22:09:13.2746709Z              query = db.query(LogicChallenge).filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:13.2747385Z -            
2026-02-20T22:09:13.2747661Z +
2026-02-20T22:09:13.2747943Z              if challenge_type:
2026-02-20T22:09:13.2748668Z                  # Adapter le type de défi pour le moteur de base de données actuel
2026-02-20T22:09:13.2749548Z -                adapted_type = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2750663Z -                logger.debug(f"Type de défi adapté: de '{challenge_type}' à '{adapted_type}'")
2026-02-20T22:09:13.2751392Z +                adapted_type = adapt_enum_for_db(
2026-02-20T22:09:13.2751939Z +                    "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2752426Z +                )
2026-02-20T22:09:13.2752747Z +                logger.debug(
2026-02-20T22:09:13.2753652Z +                    f"Type de défi adapté: de '{challenge_type}' à '{adapted_type}'"
2026-02-20T22:09:13.2754232Z +                )
2026-02-20T22:09:13.2754768Z                  query = query.filter(LogicChallenge.challenge_type == adapted_type)
2026-02-20T22:09:13.2755395Z -            
2026-02-20T22:09:13.2755674Z +
2026-02-20T22:09:13.2755939Z              if age_group:
2026-02-20T22:09:13.2756626Z                  # Adapter le groupe d'âge pour le moteur de base de données actuel
2026-02-20T22:09:13.2757358Z                  adapted_age = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2758152Z                  logger.debug(f"Groupe d'âge adapté: de '{age_group}' à '{adapted_age}'")
2026-02-20T22:09:13.2758872Z                  query = query.filter(LogicChallenge.age_group == adapted_age)
2026-02-20T22:09:13.2759370Z -            
2026-02-20T22:09:13.2759628Z +
2026-02-20T22:09:13.2759882Z              if offset is not None:
2026-02-20T22:09:13.2760247Z                  query = query.offset(offset)
2026-02-20T22:09:13.2760594Z -            
2026-02-20T22:09:13.2760833Z +
2026-02-20T22:09:13.2761061Z              if limit is not None:
2026-02-20T22:09:13.2761436Z                  query = query.limit(limit)
2026-02-20T22:09:13.2761803Z -            
2026-02-20T22:09:13.2762049Z +
2026-02-20T22:09:13.2762311Z              return query.all()
2026-02-20T22:09:13.2762725Z          except Exception as challenges_fetch_error:
2026-02-20T22:09:13.2763736Z -            logger.error(f"Erreur lors de la récupération des défis: {challenges_fetch_error}")
2026-02-20T22:09:13.2764420Z +            logger.error(
2026-02-20T22:09:13.2765072Z +                f"Erreur lors de la récupération des défis: {challenges_fetch_error}"
2026-02-20T22:09:13.2765649Z +            )
2026-02-20T22:09:13.2765907Z              return []
2026-02-20T22:09:13.2766182Z -    
2026-02-20T22:09:13.2766706Z -    @staticmethod
2026-02-20T22:09:13.2767232Z -    def create_challenge(db: Session, challenge_data: Dict[str, Any]) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2767957Z +
2026-02-20T22:09:13.2768229Z +    @staticmethod
2026-02-20T22:09:13.2768542Z +    def create_challenge(
2026-02-20T22:09:13.2769180Z +        db: Session, challenge_data: Dict[str, Any]
2026-02-20T22:09:13.2769714Z +    ) -> Optional[LogicChallenge]:
2026-02-20T22:09:13.2770124Z          """
2026-02-20T22:09:13.2770529Z          Crée un nouveau défi.
2026-02-20T22:09:13.2770891Z -        
2026-02-20T22:09:13.2771155Z +
2026-02-20T22:09:13.2771397Z          Args:
2026-02-20T22:09:13.2771810Z              db: Session de base de données
2026-02-20T22:09:13.2772510Z              challenge_data: Dictionnaire contenant les données du défi
2026-02-20T22:09:13.2773283Z -            
2026-02-20T22:09:13.2773555Z +
2026-02-20T22:09:13.2773817Z          Returns:
2026-02-20T22:09:13.2774273Z              Le défi créé ou None en cas d'erreur
2026-02-20T22:09:13.2774733Z          """
2026-02-20T22:09:13.2775341Z          # Adapter les valeurs d'enum pour le moteur de base de données actuel
2026-02-20T22:09:13.2776017Z          if "challenge_type" in challenge_data:
2026-02-20T22:09:13.2776580Z              challenge_type = challenge_data["challenge_type"]
2026-02-20T22:09:13.2777469Z -            challenge_data["challenge_type"] = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2778799Z -            logger.debug(f"Type de défi adapté: de '{challenge_type}' à '{challenge_data['challenge_type']}'")
2026-02-20T22:09:13.2779558Z -        
2026-02-20T22:09:13.2779965Z +            challenge_data["challenge_type"] = adapt_enum_for_db(
2026-02-20T22:09:13.2780574Z +                "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2781043Z +            )
2026-02-20T22:09:13.2781352Z +            logger.debug(
2026-02-20T22:09:13.2782133Z +                f"Type de défi adapté: de '{challenge_type}' à '{challenge_data['challenge_type']}'"
2026-02-20T22:09:13.2782850Z +            )
2026-02-20T22:09:13.2783305Z +
2026-02-20T22:09:13.2783613Z          if "age_group" in challenge_data:
2026-02-20T22:09:13.2784095Z              age_group = challenge_data["age_group"]
2026-02-20T22:09:13.2784809Z              challenge_data["age_group"] = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2785943Z -            logger.debug(f"Groupe d'âge adapté: de '{age_group}' à '{challenge_data['age_group']}'")
2026-02-20T22:09:13.2786688Z -        
2026-02-20T22:09:13.2786971Z +            logger.debug(
2026-02-20T22:09:13.2787687Z +                f"Groupe d'âge adapté: de '{age_group}' à '{challenge_data['age_group']}'"
2026-02-20T22:09:13.2788313Z +            )
2026-02-20T22:09:13.2788600Z +
2026-02-20T22:09:13.2789261Z          # Définir explicitement created_at si non présent pour éviter les valeurs NULL
2026-02-20T22:09:13.2789993Z          from datetime import datetime, timezone
2026-02-20T22:09:13.2790785Z -        if "created_at" not in challenge_data or challenge_data.get("created_at") is None:
2026-02-20T22:09:13.2791471Z +
2026-02-20T22:09:13.2791725Z +        if (
2026-02-20T22:09:13.2792050Z +            "created_at" not in challenge_data
2026-02-20T22:09:13.2792571Z +            or challenge_data.get("created_at") is None
2026-02-20T22:09:13.2793227Z +        ):
2026-02-20T22:09:13.2793670Z              challenge_data["created_at"] = datetime.now(timezone.utc)
2026-02-20T22:09:13.2794219Z -        
2026-02-20T22:09:13.2794475Z +
2026-02-20T22:09:13.2794935Z          return DatabaseAdapter.create(db, LogicChallenge, challenge_data)
2026-02-20T22:09:13.2795534Z -    
2026-02-20T22:09:13.2795811Z -    @staticmethod
2026-02-20T22:09:13.2796451Z -    def update_challenge(db: Session, challenge_id: int, challenge_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.2797194Z +
2026-02-20T22:09:13.2797452Z +    @staticmethod
2026-02-20T22:09:13.2797776Z +    def update_challenge(
2026-02-20T22:09:13.2798291Z +        db: Session, challenge_id: int, challenge_data: Dict[str, Any]
2026-02-20T22:09:13.2799097Z +    ) -> bool:
2026-02-20T22:09:13.2799394Z          """
2026-02-20T22:09:13.2799813Z          Met à jour un défi existant.
2026-02-20T22:09:13.2800222Z -        
2026-02-20T22:09:13.2800472Z +
2026-02-20T22:09:13.2800727Z          Args:
2026-02-20T22:09:13.2801338Z              db: Session de base de données
2026-02-20T22:09:13.2801963Z              challenge_id: ID du défi à mettre à jour
2026-02-20T22:09:13.2802601Z              challenge_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.2803361Z -            
2026-02-20T22:09:13.2803644Z +
2026-02-20T22:09:13.2803894Z          Returns:
2026-02-20T22:09:13.2804393Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.2804859Z          """
2026-02-20T22:09:13.2805350Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2805966Z          if not challenge:
2026-02-20T22:09:13.2806683Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.2807345Z              return False
2026-02-20T22:09:13.2807683Z -        
2026-02-20T22:09:13.2807949Z +
2026-02-20T22:09:13.2808522Z          # Adapter les valeurs d'enum pour le moteur de base de données actuel
2026-02-20T22:09:13.2809211Z          if "challenge_type" in challenge_data:
2026-02-20T22:09:13.2809769Z              challenge_type = challenge_data["challenge_type"]
2026-02-20T22:09:13.2810622Z -            challenge_data["challenge_type"] = adapt_enum_for_db("LogicChallengeType", challenge_type, db)
2026-02-20T22:09:13.2812073Z -            logger.debug(f"Type de défi adapté pour mise à jour: de '{challenge_type}' à '{challenge_data['challenge_type']}'")
2026-02-20T22:09:13.2812951Z -        
2026-02-20T22:09:13.2813563Z +            challenge_data["challenge_type"] = adapt_enum_for_db(
2026-02-20T22:09:13.2814171Z +                "LogicChallengeType", challenge_type, db
2026-02-20T22:09:13.2814651Z +            )
2026-02-20T22:09:13.2814946Z +            logger.debug(
2026-02-20T22:09:13.2815875Z +                f"Type de défi adapté pour mise à jour: de '{challenge_type}' à '{challenge_data['challenge_type']}'"
2026-02-20T22:09:13.2816641Z +            )
2026-02-20T22:09:13.2816952Z +
2026-02-20T22:09:13.2817283Z          if "age_group" in challenge_data:
2026-02-20T22:09:13.2817775Z              age_group = challenge_data["age_group"]
2026-02-20T22:09:13.2818461Z              challenge_data["age_group"] = adapt_enum_for_db("AgeGroup", age_group, db)
2026-02-20T22:09:13.2819683Z -            logger.debug(f"Groupe d'âge adapté pour mise à jour: de '{age_group}' à '{challenge_data['age_group']}'")
2026-02-20T22:09:13.2820504Z -        
2026-02-20T22:09:13.2820788Z +            logger.debug(
2026-02-20T22:09:13.2821619Z +                f"Groupe d'âge adapté pour mise à jour: de '{age_group}' à '{challenge_data['age_group']}'"
2026-02-20T22:09:13.2822346Z +            )
2026-02-20T22:09:13.2822642Z +
2026-02-20T22:09:13.2823273Z          return DatabaseAdapter.update(db, challenge, challenge_data)
2026-02-20T22:09:13.2823847Z -    
2026-02-20T22:09:13.2824106Z +
2026-02-20T22:09:13.2824358Z      @staticmethod
2026-02-20T22:09:13.2824825Z      def archive_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:13.2825386Z          """
2026-02-20T22:09:13.2825993Z          Archive un défi (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.2826614Z -        
2026-02-20T22:09:13.2826876Z +
2026-02-20T22:09:13.2827121Z          Args:
2026-02-20T22:09:13.2827527Z              db: Session de base de données
2026-02-20T22:09:13.2828080Z              challenge_id: ID du défi à archiver
2026-02-20T22:09:13.2828502Z -            
2026-02-20T22:09:13.2828783Z +
2026-02-20T22:09:13.2829027Z          Returns:
2026-02-20T22:09:13.2829496Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.2829951Z          """
2026-02-20T22:09:13.2830445Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2831307Z          if not challenge:
2026-02-20T22:09:13.2832010Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour archivage")
2026-02-20T22:09:13.2832641Z              return False
2026-02-20T22:09:13.2833142Z -        
2026-02-20T22:09:13.2833613Z +
2026-02-20T22:09:13.2833980Z          return DatabaseAdapter.archive(db, challenge)
2026-02-20T22:09:13.2834459Z -    
2026-02-20T22:09:13.2834709Z +
2026-02-20T22:09:13.2834967Z      @staticmethod
2026-02-20T22:09:13.2835428Z      def delete_challenge(db: Session, challenge_id: int) -> bool:
2026-02-20T22:09:13.2835984Z          """
2026-02-20T22:09:13.2836508Z          Supprime physiquement un défi de la base de données.
2026-02-20T22:09:13.2837248Z          Les tentatives associées sont supprimées en cascade.
2026-02-20T22:09:13.2837749Z -        
2026-02-20T22:09:13.2838007Z +
2026-02-20T22:09:13.2838258Z          Args:
2026-02-20T22:09:13.2838671Z              db: Session de base de données
2026-02-20T22:09:13.2839251Z              challenge_id: ID du défi à supprimer
2026-02-20T22:09:13.2839687Z -            
2026-02-20T22:09:13.2839983Z +
2026-02-20T22:09:13.2840228Z          Returns:
2026-02-20T22:09:13.2840716Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.2841199Z          """
2026-02-20T22:09:13.2841683Z          challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:13.2842309Z          if not challenge:
2026-02-20T22:09:13.2843197Z              logger.error(f"Défi avec ID {challenge_id} non trouvé pour suppression")
2026-02-20T22:09:13.2843862Z              return False
2026-02-20T22:09:13.2844181Z -        
2026-02-20T22:09:13.2844450Z +
2026-02-20T22:09:13.2844779Z          return DatabaseAdapter.delete(db, challenge)
2026-02-20T22:09:13.2845257Z -    
2026-02-20T22:09:13.2845521Z -    @staticmethod
2026-02-20T22:09:13.2846167Z -    def get_challenge_attempts(db: Session, challenge_id: int) -> List[LogicChallengeAttempt]:
2026-02-20T22:09:13.2846923Z +
2026-02-20T22:09:13.2847177Z +    @staticmethod
2026-02-20T22:09:13.2847502Z +    def get_challenge_attempts(
2026-02-20T22:09:13.2847914Z +        db: Session, challenge_id: int
2026-02-20T22:09:13.2848371Z +    ) -> List[LogicChallengeAttempt]:
2026-02-20T22:09:13.2848788Z          """
2026-02-20T22:09:13.2849309Z          Récupère toutes les tentatives associées à un défi.
2026-02-20T22:09:13.2849807Z -        
2026-02-20T22:09:13.2850066Z +
2026-02-20T22:09:13.2850315Z          Args:
2026-02-20T22:09:13.2850720Z              db: Session de base de données
2026-02-20T22:09:13.2851254Z              challenge_id: ID du défi
2026-02-20T22:09:13.2851639Z -            
2026-02-20T22:09:13.2851919Z +
2026-02-20T22:09:13.2852170Z          Returns:
2026-02-20T22:09:13.2852608Z              Liste des tentatives pour ce défi
2026-02-20T22:09:13.2853198Z          """
2026-02-20T22:09:13.2853857Z -        return DatabaseAdapter.get_by_field(db, LogicChallengeAttempt, "challenge_id", challenge_id)
2026-02-20T22:09:13.2854656Z -    
2026-02-20T22:09:13.2854932Z -    @staticmethod
2026-02-20T22:09:13.2855596Z -    def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[LogicChallengeAttempt]:
2026-02-20T22:09:13.2856417Z +        return DatabaseAdapter.get_by_field(
2026-02-20T22:09:13.2857011Z +            db, LogicChallengeAttempt, "challenge_id", challenge_id
2026-02-20T22:09:13.2857536Z +        )
2026-02-20T22:09:13.2857804Z +
2026-02-20T22:09:13.2858056Z +    @staticmethod
2026-02-20T22:09:13.2858377Z +    def record_attempt(
2026-02-20T22:09:13.2858776Z +        db: Session, attempt_data: Dict[str, Any]
2026-02-20T22:09:13.2859284Z +    ) -> Optional[LogicChallengeAttempt]:
2026-02-20T22:09:13.2859709Z          """
2026-02-20T22:09:13.2860219Z          Enregistre une nouvelle tentative pour un défi.
2026-02-20T22:09:13.2860718Z -        
2026-02-20T22:09:13.2860972Z +
2026-02-20T22:09:13.2861229Z          Args:
2026-02-20T22:09:13.2861637Z              db: Session de base de données
2026-02-20T22:09:13.2862637Z              attempt_data: Dictionnaire contenant les données de la tentative
2026-02-20T22:09:13.2863435Z -            
2026-02-20T22:09:13.2863724Z +
2026-02-20T22:09:13.2863971Z          Returns:
2026-02-20T22:09:13.2864650Z              La tentative créée ou None en cas d'erreur
2026-02-20T22:09:13.2865120Z          """
2026-02-20T22:09:13.2865529Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:13.2866036Z              try:
2026-02-20T22:09:13.2866463Z                  # Vérifier que le défi existe
2026-02-20T22:09:13.2867005Z                  challenge_id = attempt_data.get("challenge_id")
2026-02-20T22:09:13.2867744Z                  challenge = LogicChallengeService.get_challenge(session, challenge_id)
2026-02-20T22:09:13.2868407Z -                
2026-02-20T22:09:13.2868697Z +
2026-02-20T22:09:13.2868969Z                  if not challenge:
2026-02-20T22:09:13.2870002Z -                    logger.error(f"Tentative d'enregistrement d'une tentative pour un défi inexistant (ID {challenge_id})")
2026-02-20T22:09:13.2870937Z +                    logger.error(
2026-02-20T22:09:13.2871867Z +                        f"Tentative d'enregistrement d'une tentative pour un défi inexistant (ID {challenge_id})"
2026-02-20T22:09:13.2872668Z +                    )
2026-02-20T22:09:13.2873166Z                      return None
2026-02-20T22:09:13.2873522Z -                
2026-02-20T22:09:13.2873808Z +
2026-02-20T22:09:13.2874164Z                  # Créer la tentative
2026-02-20T22:09:13.2874674Z                  attempt = LogicChallengeAttempt(**attempt_data)
2026-02-20T22:09:13.2875212Z                  session.add(attempt)
2026-02-20T22:09:13.2875622Z                  session.flush()
2026-02-20T22:09:13.2875987Z -                
2026-02-20T22:09:13.2876269Z +
2026-02-20T22:09:13.2876537Z                  # Log de l'action
2026-02-20T22:09:13.2877023Z                  is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.2878231Z -                logger.info(f"Tentative enregistrée pour le défi {challenge_id}: {'Correcte' if is_correct else 'Incorrecte'}")
2026-02-20T22:09:13.2879121Z -                
2026-02-20T22:09:13.2879433Z +                logger.info(
2026-02-20T22:09:13.2880398Z +                    f"Tentative enregistrée pour le défi {challenge_id}: {'Correcte' if is_correct else 'Incorrecte'}"
2026-02-20T22:09:13.2881211Z +                )
2026-02-20T22:09:13.2881502Z +
2026-02-20T22:09:13.2881762Z                  return attempt
2026-02-20T22:09:13.2882199Z              except Exception as attempt_save_error:
2026-02-20T22:09:13.2883154Z -                logger.error(f"Erreur lors de l'enregistrement de la tentative: {attempt_save_error}")
2026-02-20T22:09:13.2883924Z -                return None 
2026-02-20T22:09:13.2884300Z \ No newline at end of file
2026-02-20T22:09:13.2884678Z +                logger.error(
2026-02-20T22:09:13.2885276Z +                    f"Erreur lors de l'enregistrement de la tentative: {attempt_save_error}"
2026-02-20T22:09:13.2885940Z +                )
2026-02-20T22:09:13.2886255Z +                return None
2026-02-20T22:09:13.3411842Z --- /home/runner/work/mathakine/mathakine/app/services/streak_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3413622Z +++ /home/runner/work/mathakine/mathakine/app/services/streak_service.py	2026-02-20 22:09:13.339927+00:00
2026-02-20T22:09:13.3415833Z @@ -1,10 +1,11 @@
2026-02-20T22:09:13.3417250Z  """
2026-02-20T22:09:13.3418910Z would reformat /home/runner/work/mathakine/mathakine/app/services/streak_service.py
2026-02-20T22:09:13.3419991Z  Service de calcul de la série d'entraînement (streak).
2026-02-20T22:09:13.3420478Z  
2026-02-20T22:09:13.3421747Z  Jours consécutifs avec au moins une activité (exercice ou défi).
2026-02-20T22:09:13.3423583Z  """
2026-02-20T22:09:13.3423842Z +
2026-02-20T22:09:13.3424244Z  from datetime import date, datetime, timedelta, timezone
2026-02-20T22:09:13.3424787Z  
2026-02-20T22:09:13.3425559Z  from sqlalchemy import func
2026-02-20T22:09:13.3425977Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.3426363Z  
2026-02-20T22:09:13.3426617Z @@ -19,20 +20,26 @@
2026-02-20T22:09:13.3427099Z  def _activity_dates_for_user(db: Session, user_id: int) -> set[date]:
2026-02-20T22:09:13.3428329Z      """Retourne l'ensemble des dates (UTC) où l'utilisateur a eu une activité."""
2026-02-20T22:09:13.3428978Z      dates = set()
2026-02-20T22:09:13.3429263Z  
2026-02-20T22:09:13.3429549Z      # Dates des tentatives exercices
2026-02-20T22:09:13.3430072Z -    for (d,) in db.query(func.date(Attempt.created_at)).filter(
2026-02-20T22:09:13.3430661Z -        Attempt.user_id == user_id
2026-02-20T22:09:13.3431056Z -    ).distinct().all():
2026-02-20T22:09:13.3431388Z +    for (d,) in (
2026-02-20T22:09:13.3431748Z +        db.query(func.date(Attempt.created_at))
2026-02-20T22:09:13.3432226Z +        .filter(Attempt.user_id == user_id)
2026-02-20T22:09:13.3432647Z +        .distinct()
2026-02-20T22:09:13.3433164Z +        .all()
2026-02-20T22:09:13.3433452Z +    ):
2026-02-20T22:09:13.3433698Z          if d:
2026-02-20T22:09:13.3433993Z              dates.add(d)
2026-02-20T22:09:13.3434315Z  
2026-02-20T22:09:13.3434682Z      # Dates des tentatives défis
2026-02-20T22:09:13.3435276Z -    for (d,) in db.query(func.date(LogicChallengeAttempt.created_at)).filter(
2026-02-20T22:09:13.3435906Z -        LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:13.3436323Z -    ).distinct().all():
2026-02-20T22:09:13.3436614Z +    for (d,) in (
2026-02-20T22:09:13.3436997Z +        db.query(func.date(LogicChallengeAttempt.created_at))
2026-02-20T22:09:13.3437528Z +        .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:13.3437952Z +        .distinct()
2026-02-20T22:09:13.3438209Z +        .all()
2026-02-20T22:09:13.3438463Z +    ):
2026-02-20T22:09:13.3438714Z          if d:
2026-02-20T22:09:13.3438986Z              dates.add(d)
2026-02-20T22:09:13.3439303Z  
2026-02-20T22:09:13.3439541Z      return dates
2026-02-20T22:09:13.3439831Z  
2026-02-20T22:09:13.3440065Z @@ -69,9 +76,11 @@
2026-02-20T22:09:13.3440388Z      prev_best = user.best_streak or 0
2026-02-20T22:09:13.3440806Z      best = max(prev_best, current)
2026-02-20T22:09:13.3441171Z  
2026-02-20T22:09:13.3441448Z      user.current_streak = current
2026-02-20T22:09:13.3441846Z      user.best_streak = best
2026-02-20T22:09:13.3442498Z -    user.last_activity_date = today if today in activity_dates else user.last_activity_date
2026-02-20T22:09:13.3443462Z +    user.last_activity_date = (
2026-02-20T22:09:13.3444021Z +        today if today in activity_dates else user.last_activity_date
2026-02-20T22:09:13.3444572Z +    )
2026-02-20T22:09:13.3444844Z      db.commit()
2026-02-20T22:09:13.3445128Z  
2026-02-20T22:09:13.3445408Z      return (current, best)
2026-02-20T22:09:13.3478242Z would reformat /home/runner/work/mathakine/mathakine/app/services/exercise_service.py
2026-02-20T22:09:13.3479375Z --- /home/runner/work/mathakine/mathakine/app/services/exercise_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3480841Z +++ /home/runner/work/mathakine/mathakine/app/services/exercise_service.py	2026-02-20 22:09:13.339050+00:00
2026-02-20T22:09:13.3481697Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.3481994Z  """
2026-02-20T22:09:13.3482549Z  Service pour la gestion des exercices mathématiques.
2026-02-20T22:09:13.3483691Z  Implémente les opérations métier liées aux exercices et utilise le transaction manager.
2026-02-20T22:09:13.3484398Z  """
2026-02-20T22:09:13.3484657Z +
2026-02-20T22:09:13.3485028Z  from typing import Any, Dict, List, Optional, Union
2026-02-20T22:09:13.3485500Z  
2026-02-20T22:09:13.3485850Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.3486297Z  
2026-02-20T22:09:13.3486580Z  logger = get_logger(__name__)
2026-02-20T22:09:13.3486949Z @@ -19,52 +20,56 @@
2026-02-20T22:09:13.3487285Z  class ExerciseService:
2026-02-20T22:09:13.3487607Z      """
2026-02-20T22:09:13.3488124Z      Service pour la gestion des exercices mathématiques.
2026-02-20T22:09:13.3489344Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des exercices.
2026-02-20T22:09:13.3490041Z      """
2026-02-20T22:09:13.3490302Z -    
2026-02-20T22:09:13.3490564Z +
2026-02-20T22:09:13.3490793Z      @staticmethod
2026-02-20T22:09:13.3491459Z      def get_exercise(db: Session, exercise_id: int) -> Optional[Exercise]:
2026-02-20T22:09:13.3492031Z          """
2026-02-20T22:09:13.3523631Z          Récupère un exercice par son ID.
2026-02-20T22:09:13.3524097Z -        
2026-02-20T22:09:13.3524372Z +
2026-02-20T22:09:13.3524859Z          IMPORTANT: Utilise cast() pour charger les enums en tant que strings
2026-02-20T22:09:13.3525919Z          pour éviter les erreurs LookupError avec les valeurs en minuscules dans la DB.
2026-02-20T22:09:13.3526616Z -        
2026-02-20T22:09:13.3526888Z +
2026-02-20T22:09:13.3527136Z          Args:
2026-02-20T22:09:13.3527595Z              db: Session de base de données
2026-02-20T22:09:13.3528185Z              exercise_id: ID de l'exercice à récupérer
2026-02-20T22:09:13.3528675Z -            
2026-02-20T22:09:13.3528949Z +
2026-02-20T22:09:13.3529207Z          Returns:
2026-02-20T22:09:13.3529771Z              L'exercice correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.3530327Z          """
2026-02-20T22:09:13.3530616Z          try:
2026-02-20T22:09:13.3530958Z              from sqlalchemy import String, cast
2026-02-20T22:09:13.3531389Z  
2026-02-20T22:09:13.3532042Z              # Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:13.3532743Z -            exercise_row = db.query(
2026-02-20T22:09:13.3533361Z -                Exercise.id,
2026-02-20T22:09:13.3533759Z -                Exercise.title,
2026-02-20T22:09:13.3534161Z -                Exercise.question,
2026-02-20T22:09:13.3534595Z -                Exercise.correct_answer,
2026-02-20T22:09:13.3535035Z -                Exercise.choices,
2026-02-20T22:09:13.3535442Z -                Exercise.explanation,
2026-02-20T22:09:13.3535908Z -                Exercise.hint,
2026-02-20T22:09:13.3536282Z -                Exercise.tags,
2026-02-20T22:09:13.3536671Z -                Exercise.ai_generated,
2026-02-20T22:09:13.3537085Z -                Exercise.is_active,
2026-02-20T22:09:13.3537515Z -                Exercise.is_archived,
2026-02-20T22:09:13.3537922Z -                Exercise.view_count,
2026-02-20T22:09:13.3538340Z -                Exercise.created_at,
2026-02-20T22:09:13.3538748Z -                Exercise.updated_at,
2026-02-20T22:09:13.3539360Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:13.3540137Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:13.3540774Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:13.3541246Z -            
2026-02-20T22:09:13.3541551Z +            exercise_row = (
2026-02-20T22:09:13.3541918Z +                db.query(
2026-02-20T22:09:13.3542525Z +                    Exercise.id,
2026-02-20T22:09:13.3542923Z +                    Exercise.title,
2026-02-20T22:09:13.3543496Z +                    Exercise.question,
2026-02-20T22:09:13.3543931Z +                    Exercise.correct_answer,
2026-02-20T22:09:13.3544390Z +                    Exercise.choices,
2026-02-20T22:09:13.3544830Z +                    Exercise.explanation,
2026-02-20T22:09:13.3545272Z +                    Exercise.hint,
2026-02-20T22:09:13.3545672Z +                    Exercise.tags,
2026-02-20T22:09:13.3546086Z +                    Exercise.ai_generated,
2026-02-20T22:09:13.3546523Z +                    Exercise.is_active,
2026-02-20T22:09:13.3546957Z +                    Exercise.is_archived,
2026-02-20T22:09:13.3547389Z +                    Exercise.view_count,
2026-02-20T22:09:13.3547831Z +                    Exercise.created_at,
2026-02-20T22:09:13.3548277Z +                    Exercise.updated_at,
2026-02-20T22:09:13.3548886Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:13.3549695Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:13.3550266Z +                )
2026-02-20T22:09:13.3550626Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:13.3551282Z +                .first()
2026-02-20T22:09:13.3551633Z +            )
2026-02-20T22:09:13.3551913Z +
2026-02-20T22:09:13.3552172Z              if not exercise_row:
2026-02-20T22:09:13.3552565Z                  return None
2026-02-20T22:09:13.3552899Z -            
2026-02-20T22:09:13.3553366Z +
2026-02-20T22:09:13.3553777Z              # Créer un objet Exercise avec les valeurs normalisées
2026-02-20T22:09:13.3553920Z              exercise = Exercise()
2026-02-20T22:09:13.3554080Z              exercise.id = exercise_row.id
2026-02-20T22:09:13.3554248Z              exercise.title = exercise_row.title
2026-02-20T22:09:13.3554438Z              exercise.question = exercise_row.question
2026-02-20T22:09:13.3554569Z @@ -77,330 +82,397 @@
2026-02-20T22:09:13.3554776Z              exercise.is_active = exercise_row.is_active
2026-02-20T22:09:13.3554989Z              exercise.is_archived = exercise_row.is_archived
2026-02-20T22:09:13.3555197Z              exercise.view_count = exercise_row.view_count
2026-02-20T22:09:13.3555421Z              exercise.created_at = exercise_row.created_at
2026-02-20T22:09:13.3555629Z              exercise.updated_at = exercise_row.updated_at
2026-02-20T22:09:13.3555738Z -            
2026-02-20T22:09:13.3555851Z +
2026-02-20T22:09:13.3556261Z              # Convertir les strings normalisées en enums (en majuscules)
2026-02-20T22:09:13.3556565Z              from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:13.3557207Z -            exercise_type_normalized = exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION"
2026-02-20T22:09:13.3557802Z -            difficulty_normalized = exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN"
2026-02-20T22:09:13.3557921Z -            
2026-02-20T22:09:13.3558024Z +
2026-02-20T22:09:13.3558191Z +            exercise_type_normalized = (
2026-02-20T22:09:13.3558387Z +                exercise_row.exercise_type_str.upper()
2026-02-20T22:09:13.3558571Z +                if exercise_row.exercise_type_str
2026-02-20T22:09:13.3558713Z +                else "ADDITION"
2026-02-20T22:09:13.3558824Z +            )
2026-02-20T22:09:13.3558972Z +            difficulty_normalized = (
2026-02-20T22:09:13.3559149Z +                exercise_row.difficulty_str.upper()
2026-02-20T22:09:13.3559321Z +                if exercise_row.difficulty_str
2026-02-20T22:09:13.3559452Z +                else "PADAWAN"
2026-02-20T22:09:13.3559558Z +            )
2026-02-20T22:09:13.3559665Z +
2026-02-20T22:09:13.3559770Z              try:
2026-02-20T22:09:13.3560093Z                  exercise.exercise_type = ExerciseType(exercise_type_normalized)
2026-02-20T22:09:13.3560227Z              except ValueError:
2026-02-20T22:09:13.3561474Z -                logger.warning(f"Type d'exercice invalide: {exercise_type_normalized}, utilisation de ADDITION par défaut")
2026-02-20T22:09:13.3561611Z +                logger.warning(
2026-02-20T22:09:13.3562272Z +                    f"Type d'exercice invalide: {exercise_type_normalized}, utilisation de ADDITION par défaut"
2026-02-20T22:09:13.3562392Z +                )
2026-02-20T22:09:13.3562626Z                  exercise.exercise_type = ExerciseType.ADDITION
2026-02-20T22:09:13.3562731Z -            
2026-02-20T22:09:13.3562837Z +
2026-02-20T22:09:13.3562944Z              try:
2026-02-20T22:09:13.3563431Z                  exercise.difficulty = DifficultyLevel(difficulty_normalized)
2026-02-20T22:09:13.3563569Z              except ValueError:
2026-02-20T22:09:13.3564322Z -                logger.warning(f"Difficulté invalide: {difficulty_normalized}, utilisation de PADAWAN par défaut")
2026-02-20T22:09:13.3564459Z +                logger.warning(
2026-02-20T22:09:13.3565066Z +                    f"Difficulté invalide: {difficulty_normalized}, utilisation de PADAWAN par défaut"
2026-02-20T22:09:13.3565185Z +                )
2026-02-20T22:09:13.3565415Z                  exercise.difficulty = DifficultyLevel.PADAWAN
2026-02-20T22:09:13.3565520Z -            
2026-02-20T22:09:13.3565630Z +
2026-02-20T22:09:13.3565997Z              return exercise
2026-02-20T22:09:13.3566194Z          except Exception as get_exercise_error:
2026-02-20T22:09:13.3566861Z -            logger.error(f"Erreur lors de la récupération de l'exercice {exercise_id}: {get_exercise_error}")
2026-02-20T22:09:13.3566999Z +            logger.error(
2026-02-20T22:09:13.3567532Z +                f"Erreur lors de la récupération de l'exercice {exercise_id}: {get_exercise_error}"
2026-02-20T22:09:13.3567640Z +            )
2026-02-20T22:09:13.3567982Z              # Fallback vers la méthode originale en cas d'erreur
2026-02-20T22:09:13.3568094Z              try:
2026-02-20T22:09:13.3568381Z                  return DatabaseAdapter.get_by_id(db, Exercise, exercise_id)
2026-02-20T22:09:13.3568539Z              except Exception:
2026-02-20T22:09:13.3568662Z                  return None
2026-02-20T22:09:13.3568766Z -    
2026-02-20T22:09:13.3568869Z +
2026-02-20T22:09:13.3568995Z      @staticmethod
2026-02-20T22:09:13.3569134Z      def list_exercises(
2026-02-20T22:09:13.3569253Z -        db: Session, 
2026-02-20T22:09:13.3569377Z +        db: Session,
2026-02-20T22:09:13.3569542Z          exercise_type: Optional[str] = None,
2026-02-20T22:09:13.3569699Z          difficulty: Optional[str] = None,
2026-02-20T22:09:13.3569837Z          limit: Optional[int] = None,
2026-02-20T22:09:13.3569982Z -        offset: Optional[int] = None
2026-02-20T22:09:13.3570123Z +        offset: Optional[int] = None,
2026-02-20T22:09:13.3570252Z      ) -> List[Exercise]:
2026-02-20T22:09:13.3570365Z          """
2026-02-20T22:09:13.3570586Z          Liste les exercices actifs avec filtrage optionnel.
2026-02-20T22:09:13.3570697Z -        
2026-02-20T22:09:13.3570816Z +
2026-02-20T22:09:13.3570930Z          Args:
2026-02-20T22:09:13.3571170Z              db: Session de base de données
2026-02-20T22:09:13.3571518Z              exercise_type: Type d'exercice à filtrer (optionnel)
2026-02-20T22:09:13.3571896Z              difficulty: Niveau de difficulté à filtrer (optionnel)
2026-02-20T22:09:13.3572198Z              limit: Nombre maximum d'exercices à retourner
2026-02-20T22:09:13.3572455Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.3572573Z -            
2026-02-20T22:09:13.3572675Z +
2026-02-20T22:09:13.3572784Z          Returns:
2026-02-20T22:09:13.3573284Z              Liste des exercices correspondants aux critères
2026-02-20T22:09:13.3573403Z          """
2026-02-20T22:09:13.3573512Z          try:
2026-02-20T22:09:13.3573672Z              query = db.query(Exercise).filter(
2026-02-20T22:09:13.3573850Z -                Exercise.is_archived == False,
2026-02-20T22:09:13.3574001Z -                Exercise.is_active == True
2026-02-20T22:09:13.3574368Z -            )
2026-02-20T22:09:13.3574476Z -            
2026-02-20T22:09:13.3574760Z +                Exercise.is_archived == False, Exercise.is_active == True
2026-02-20T22:09:13.3574874Z +            )
2026-02-20T22:09:13.3574978Z +
2026-02-20T22:09:13.3575320Z              # FILTRE CRITIQUE : Accepter les valeurs en majuscules ET minuscules
2026-02-20T22:09:13.3575670Z              # pour compatibilité avec les données existantes
2026-02-20T22:09:13.3575878Z              valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.3576139Z              valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.3576249Z -            
2026-02-20T22:09:13.3576352Z +
2026-02-20T22:09:13.3576663Z              # Ajouter les valeurs en minuscules pour compatibilité
2026-02-20T22:09:13.3577102Z -            valid_types.extend(['addition', 'subtraction', 'multiplication', 'division', 'mixed'])
2026-02-20T22:09:13.3577450Z -            valid_difficulties.extend(['initie', 'padawan', 'chevalier', 'maitre'])
2026-02-20T22:09:13.3577572Z -            
2026-02-20T22:09:13.3577722Z +            valid_types.extend(
2026-02-20T22:09:13.3578031Z +                ["addition", "subtraction", "multiplication", "division", "mixed"]
2026-02-20T22:09:13.3578139Z +            )
2026-02-20T22:09:13.3578769Z +            valid_difficulties.extend(["initie", "padawan", "chevalier", "maitre"])
2026-02-20T22:09:13.3578888Z +
2026-02-20T22:09:13.3579307Z              # Ne pas filtrer par énumération pour éviter les problèmes
2026-02-20T22:09:13.3579602Z              # query = query.filter(Exercise.exercise_type.in_(valid_types))
2026-02-20T22:09:13.3579922Z              # query = query.filter(Exercise.difficulty.in_(valid_difficulties))
2026-02-20T22:09:13.3580030Z -            
2026-02-20T22:09:13.3580130Z +
2026-02-20T22:09:13.3580277Z              if exercise_type:
2026-02-20T22:09:13.3580567Z                  query = query.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:13.3580688Z -            
2026-02-20T22:09:13.3580799Z +
2026-02-20T22:09:13.3580926Z              if difficulty:
2026-02-20T22:09:13.3581186Z                  query = query.filter(Exercise.difficulty == difficulty)
2026-02-20T22:09:13.3581291Z -            
2026-02-20T22:09:13.3581407Z +
2026-02-20T22:09:13.3581553Z              if offset is not None:
2026-02-20T22:09:13.3581712Z                  query = query.offset(offset)
2026-02-20T22:09:13.3581828Z -            
2026-02-20T22:09:13.3581931Z +
2026-02-20T22:09:13.3582064Z              if limit is not None:
2026-02-20T22:09:13.3582208Z                  query = query.limit(limit)
2026-02-20T22:09:13.3582316Z -            
2026-02-20T22:09:13.3582417Z +
2026-02-20T22:09:13.3582551Z              return query.all()
2026-02-20T22:09:13.3582750Z          except Exception as exercises_fetch_error:
2026-02-20T22:09:13.3583574Z -            logger.error(f"Erreur lors de la récupération des exercices: {exercises_fetch_error}")
2026-02-20T22:09:13.3583712Z +            logger.error(
2026-02-20T22:09:13.3584206Z +                f"Erreur lors de la récupération des exercices: {exercises_fetch_error}"
2026-02-20T22:09:13.3584325Z +            )
2026-02-20T22:09:13.3584440Z              return []
2026-02-20T22:09:13.3584541Z -    
2026-02-20T22:09:13.3584664Z -    @staticmethod
2026-02-20T22:09:13.3601716Z -    def create_exercise(db: Session, exercise_data: Dict[str, Any]) -> Optional[Exercise]:
2026-02-20T22:09:13.3601866Z +
2026-02-20T22:09:13.3602001Z +    @staticmethod
2026-02-20T22:09:13.3602140Z +    def create_exercise(
2026-02-20T22:09:13.3602337Z +        db: Session, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.3602497Z +    ) -> Optional[Exercise]:
2026-02-20T22:09:13.3602609Z          """
2026-02-20T22:09:13.3602882Z          Crée un nouvel exercice.
2026-02-20T22:09:13.3603242Z -        
2026-02-20T22:09:13.3603364Z +
2026-02-20T22:09:13.3603478Z          Args:
2026-02-20T22:09:13.3603745Z              db: Session de base de données
2026-02-20T22:09:13.3604510Z              exercise_data: Dictionnaire contenant les données de l'exercice
2026-02-20T22:09:13.3604630Z -            
2026-02-20T22:09:13.3604734Z +
2026-02-20T22:09:13.3604856Z          Returns:
2026-02-20T22:09:13.3605135Z              L'exercice créé ou None en cas d'erreur
2026-02-20T22:09:13.3605242Z          """
2026-02-20T22:09:13.3605535Z          return DatabaseAdapter.create(db, Exercise, exercise_data)
2026-02-20T22:09:13.3605647Z -    
2026-02-20T22:09:13.3605768Z -    @staticmethod
2026-02-20T22:09:13.3606215Z -    def update_exercise(db: Session, exercise_id: int, exercise_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.3606330Z +
2026-02-20T22:09:13.3606448Z +    @staticmethod
2026-02-20T22:09:13.3606583Z +    def update_exercise(
2026-02-20T22:09:13.3606860Z +        db: Session, exercise_id: int, exercise_data: Dict[str, Any]
2026-02-20T22:09:13.3606973Z +    ) -> bool:
2026-02-20T22:09:13.3607078Z          """
2026-02-20T22:09:13.3607315Z          Met à jour un exercice existant.
2026-02-20T22:09:13.3607446Z -        
2026-02-20T22:09:13.3607549Z +
2026-02-20T22:09:13.3607660Z          Args:
2026-02-20T22:09:13.3607906Z              db: Session de base de données
2026-02-20T22:09:13.3608219Z              exercise_id: ID de l'exercice à mettre à jour
2026-02-20T22:09:13.3608689Z              exercise_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.3608810Z -            
2026-02-20T22:09:13.3608931Z +
2026-02-20T22:09:13.3609048Z          Returns:
2026-02-20T22:09:13.3609364Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.3609481Z          """
2026-02-20T22:09:13.3609736Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3609867Z          if not exercise:
2026-02-20T22:09:13.3610480Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.3610612Z              return False
2026-02-20T22:09:13.3610723Z -        
2026-02-20T22:09:13.3610827Z +
2026-02-20T22:09:13.3611137Z          return DatabaseAdapter.update(db, exercise, exercise_data)
2026-02-20T22:09:13.3611244Z -    
2026-02-20T22:09:13.3611350Z +
2026-02-20T22:09:13.3611480Z      @staticmethod
2026-02-20T22:09:13.3611754Z      def archive_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.3611869Z          """
2026-02-20T22:09:13.3612351Z          Archive un exercice (marque comme supprimé sans suppression physique).
2026-02-20T22:09:13.3612470Z -        
2026-02-20T22:09:13.3612572Z +
2026-02-20T22:09:13.3612682Z          Args:
2026-02-20T22:09:13.3612924Z              db: Session de base de données
2026-02-20T22:09:13.3613400Z              exercise_id: ID de l'exercice à archiver
2026-02-20T22:09:13.3613512Z -            
2026-02-20T22:09:13.3613613Z +
2026-02-20T22:09:13.3613735Z          Returns:
2026-02-20T22:09:13.3614027Z              True si l'archivage a réussi, False sinon
2026-02-20T22:09:13.3614134Z          """
2026-02-20T22:09:13.3614407Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3614550Z          if not exercise:
2026-02-20T22:09:13.3615048Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour archivage")
2026-02-20T22:09:13.3615174Z              return False
2026-02-20T22:09:13.3615288Z -        
2026-02-20T22:09:13.3615399Z +
2026-02-20T22:09:13.3615605Z          return DatabaseAdapter.archive(db, exercise)
2026-02-20T22:09:13.3615719Z -    
2026-02-20T22:09:13.3615823Z +
2026-02-20T22:09:13.3615942Z      @staticmethod
2026-02-20T22:09:13.3616206Z      def delete_exercise(db: Session, exercise_id: int) -> bool:
2026-02-20T22:09:13.3616316Z          """
2026-02-20T22:09:13.3616696Z          Supprime physiquement un exercice de la base de données.
2026-02-20T22:09:13.3617044Z          Les tentatives associées sont supprimées en cascade.
2026-02-20T22:09:13.3617179Z -        
2026-02-20T22:09:13.3617325Z +
2026-02-20T22:09:13.3617439Z          Args:
2026-02-20T22:09:13.3617686Z              db: Session de base de données
2026-02-20T22:09:13.3618193Z              exercise_id: ID de l'exercice à supprimer
2026-02-20T22:09:13.3618303Z -            
2026-02-20T22:09:13.3618408Z +
2026-02-20T22:09:13.3618531Z          Returns:
2026-02-20T22:09:13.3618833Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.3618959Z          """
2026-02-20T22:09:13.3619232Z          exercise = ExerciseService.get_exercise(db, exercise_id)
2026-02-20T22:09:13.3619361Z          if not exercise:
2026-02-20T22:09:13.3619867Z              logger.error(f"Exercice avec ID {exercise_id} non trouvé pour suppression")
2026-02-20T22:09:13.3619998Z              return False
2026-02-20T22:09:13.3620119Z -        
2026-02-20T22:09:13.3620223Z +
2026-02-20T22:09:13.3620427Z          return DatabaseAdapter.delete(db, exercise)
2026-02-20T22:09:13.3620538Z -    
2026-02-20T22:09:13.3620645Z +
2026-02-20T22:09:13.3620761Z      @staticmethod
2026-02-20T22:09:13.3621110Z      def get_exercise_attempts(db: Session, exercise_id: int) -> List[Attempt]:
2026-02-20T22:09:13.3621235Z          """
2026-02-20T22:09:13.3621618Z          Récupère toutes les tentatives associées à un exercice.
2026-02-20T22:09:13.3621725Z -        
2026-02-20T22:09:13.3621835Z +
2026-02-20T22:09:13.3621943Z          Args:
2026-02-20T22:09:13.3622464Z              db: Session de base de données
2026-02-20T22:09:13.3622625Z              exercise_id: ID de l'exercice
2026-02-20T22:09:13.3622744Z -            
2026-02-20T22:09:13.3622849Z +
2026-02-20T22:09:13.3623165Z          Returns:
2026-02-20T22:09:13.3623374Z              Liste des tentatives pour cet exercice
2026-02-20T22:09:13.3623485Z          """
2026-02-20T22:09:13.3623865Z          return DatabaseAdapter.get_by_field(db, Attempt, "exercise_id", exercise_id)
2026-02-20T22:09:13.3623981Z -    
2026-02-20T22:09:13.3624085Z +
2026-02-20T22:09:13.3624202Z      @staticmethod
2026-02-20T22:09:13.3624599Z      def record_attempt(db: Session, attempt_data: Dict[str, Any]) -> Optional[Attempt]:
2026-02-20T22:09:13.3624732Z          """
2026-02-20T22:09:13.3624960Z          Enregistre une nouvelle tentative pour un exercice.
2026-02-20T22:09:13.3625068Z -        
2026-02-20T22:09:13.3625179Z +
2026-02-20T22:09:13.3625281Z          Args:
2026-02-20T22:09:13.3625531Z              db: Session de base de données
2026-02-20T22:09:13.3625970Z              attempt_data: Dictionnaire contenant les données de la tentative
2026-02-20T22:09:13.3626090Z -            
2026-02-20T22:09:13.3626192Z +
2026-02-20T22:09:13.3626306Z          Returns:
2026-02-20T22:09:13.3626597Z              La tentative créée ou None en cas d'erreur
2026-02-20T22:09:13.3626705Z          """
2026-02-20T22:09:13.3626943Z          with TransactionManager.transaction(db) as session:
2026-02-20T22:09:13.3627049Z              try:
2026-02-20T22:09:13.3627311Z                  # Vérifier que l'exercice existe
2026-02-20T22:09:13.3627526Z                  exercise_id = attempt_data.get("exercise_id")
2026-02-20T22:09:13.3627901Z                  logger.info(f"Tentative d'enregistrement pour l'exercice {exercise_id}")
2026-02-20T22:09:13.3628035Z -                
2026-02-20T22:09:13.3628140Z +
2026-02-20T22:09:13.3628442Z                  exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3628558Z -                
2026-02-20T22:09:13.3628676Z +
2026-02-20T22:09:13.3629017Z                  # Si SQLAlchemy ne trouve pas l'exercice, essayer avec PostgreSQL direct
2026-02-20T22:09:13.3629149Z                  if not exercise:
2026-02-20T22:09:13.3629908Z -                    logger.warning(f"SQLAlchemy n'a pas trouvé l'exercice {exercise_id}, tentative avec PostgreSQL direct")
2026-02-20T22:09:13.3630050Z +                    logger.warning(
2026-02-20T22:09:13.3630679Z +                        f"SQLAlchemy n'a pas trouvé l'exercice {exercise_id}, tentative avec PostgreSQL direct"
2026-02-20T22:09:13.3630815Z +                    )
2026-02-20T22:09:13.3630936Z                      try:
2026-02-20T22:09:13.3631424Z                          # NOTE: exercise_service_translations archivé - fallback désactivé
2026-02-20T22:09:13.3631964Z                          logger.error(f"Exercice {exercise_id} introuvable en base")
2026-02-20T22:09:13.3632122Z                          exercise_dict = None
2026-02-20T22:09:13.3632279Z                          if exercise_dict:
2026-02-20T22:09:13.3632800Z -                            logger.info(f"Exercice {exercise_id} trouvé via PostgreSQL direct")
2026-02-20T22:09:13.3632943Z +                            logger.info(
2026-02-20T22:09:13.3633547Z +                                f"Exercice {exercise_id} trouvé via PostgreSQL direct"
2026-02-20T22:09:13.3633666Z +                            )
2026-02-20T22:09:13.3634073Z                              # Utiliser get_exercise qui gère correctement les enums
2026-02-20T22:09:13.3634389Z -                            exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3634602Z +                            exercise = ExerciseService.get_exercise(
2026-02-20T22:09:13.3634788Z +                                session, exercise_id
2026-02-20T22:09:13.3634910Z +                            )
2026-02-20T22:09:13.3635089Z                      except Exception as pg_error:
2026-02-20T22:09:13.3635863Z -                        logger.error(f"Erreur lors de la récupération PostgreSQL directe: {pg_error}")
2026-02-20T22:09:13.3635993Z -                
2026-02-20T22:09:13.3636141Z +                        logger.error(
2026-02-20T22:09:13.3636622Z +                            f"Erreur lors de la récupération PostgreSQL directe: {pg_error}"
2026-02-20T22:09:13.3636759Z +                        )
2026-02-20T22:09:13.3636867Z +
2026-02-20T22:09:13.3637002Z                  if not exercise:
2026-02-20T22:09:13.3637615Z -                    logger.error(f"Tentative d'enregistrement d'une tentative pour un exercice inexistant (ID {exercise_id})")
2026-02-20T22:09:13.3637748Z +                    logger.error(
2026-02-20T22:09:13.3638253Z +                        f"Tentative d'enregistrement d'une tentative pour un exercice inexistant (ID {exercise_id})"
2026-02-20T22:09:13.3638394Z +                    )
2026-02-20T22:09:13.3638976Z                      # Essayer de vérifier si l'exercice existe vraiment en BDD avec une requête directe
2026-02-20T22:09:13.3639217Z                      from server.database import get_db_connection
2026-02-20T22:09:13.3639334Z +
2026-02-20T22:09:13.3639491Z                      conn = get_db_connection()
2026-02-20T22:09:13.3639638Z                      cursor = conn.cursor()
2026-02-20T22:09:13.3639757Z                      try:
2026-02-20T22:09:13.3640142Z -                        cursor.execute("SELECT id FROM exercises WHERE id = %s", (exercise_id,))
2026-02-20T22:09:13.3640279Z +                        cursor.execute(
2026-02-20T22:09:13.3640549Z +                            "SELECT id FROM exercises WHERE id = %s", (exercise_id,)
2026-02-20T22:09:13.3640675Z +                        )
2026-02-20T22:09:13.3640853Z                          exists = cursor.fetchone()
2026-02-20T22:09:13.3640980Z                          if exists:
2026-02-20T22:09:13.3641730Z -                            logger.warning(f"L'exercice {exercise_id} existe en BDD mais n'est pas trouvé par SQLAlchemy ORM")
2026-02-20T22:09:13.3641887Z +                            logger.warning(
2026-02-20T22:09:13.3642495Z +                                f"L'exercice {exercise_id} existe en BDD mais n'est pas trouvé par SQLAlchemy ORM"
2026-02-20T22:09:13.3642621Z +                            )
2026-02-20T22:09:13.3643469Z                              # Forcer le refresh de la session SQLAlchemy et utiliser get_exercise qui gère les enums
2026-02-20T22:09:13.3643636Z                              session.expire_all()
2026-02-20T22:09:13.3643954Z -                            exercise = ExerciseService.get_exercise(session, exercise_id)
2026-02-20T22:09:13.3644180Z +                            exercise = ExerciseService.get_exercise(
2026-02-20T22:09:13.3644648Z +                                session, exercise_id
2026-02-20T22:09:13.3644773Z +                            )
2026-02-20T22:09:13.3644925Z                              if not exercise:
2026-02-20T22:09:13.3645571Z -                                logger.error(f"Impossible de charger l'exercice {exercise_id} même après refresh")
2026-02-20T22:09:13.3645724Z +                                logger.error(
2026-02-20T22:09:13.3646260Z +                                    f"Impossible de charger l'exercice {exercise_id} même après refresh"
2026-02-20T22:09:13.3646382Z +                                )
2026-02-20T22:09:13.3646518Z                                  return None
2026-02-20T22:09:13.3646633Z                          else:
2026-02-20T22:09:13.3647005Z -                            logger.error(f"L'exercice {exercise_id} n'existe vraiment pas en BDD")
2026-02-20T22:09:13.3647145Z +                            logger.error(
2026-02-20T22:09:13.3647425Z +                                f"L'exercice {exercise_id} n'existe vraiment pas en BDD"
2026-02-20T22:09:13.3647565Z +                            )
2026-02-20T22:09:13.3647697Z                              return None
2026-02-20T22:09:13.3647817Z                      finally:
2026-02-20T22:09:13.3647956Z                          cursor.close()
2026-02-20T22:09:13.3648268Z                          conn.close()
2026-02-20T22:09:13.3648392Z -                
2026-02-20T22:09:13.3648507Z +
2026-02-20T22:09:13.3648641Z                  if not exercise:
2026-02-20T22:09:13.3763423Z                      return None
2026-02-20T22:09:13.3763595Z -                
2026-02-20T22:09:13.3763719Z +
2026-02-20T22:09:13.3764292Z                  logger.info(f"Exercice {exercise_id} trouvé: {exercise.title}")
2026-02-20T22:09:13.3764406Z -                
2026-02-20T22:09:13.3764519Z +
2026-02-20T22:09:13.3764748Z                  # Créer la tentative
2026-02-20T22:09:13.3765268Z -                logger.info(f"Création de la tentative avec attempt_data: {attempt_data}")
2026-02-20T22:09:13.3765432Z +                logger.info(
2026-02-20T22:09:13.3765867Z +                    f"Création de la tentative avec attempt_data: {attempt_data}"
2026-02-20T22:09:13.3765981Z +                )
2026-02-20T22:09:13.3766158Z                  attempt = Attempt(**attempt_data)
2026-02-20T22:09:13.3766327Z                  session.add(attempt)
2026-02-20T22:09:13.3766461Z                  session.flush()
2026-02-20T22:09:13.3766832Z                  logger.info(f"Tentative créée avec ID: {attempt.id}")
2026-02-20T22:09:13.3766951Z -                
2026-02-20T22:09:13.3767055Z +
2026-02-20T22:09:13.3767187Z                  # Log de l'action
2026-02-20T22:09:13.3767418Z                  is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.3768241Z -                logger.info(f"Tentative enregistrée pour l'exercice {exercise_id}: {'Correcte' if is_correct else 'Incorrecte'}")
2026-02-20T22:09:13.3768354Z -                
2026-02-20T22:09:13.3768484Z +                logger.info(
2026-02-20T22:09:13.3769234Z +                    f"Tentative enregistrée pour l'exercice {exercise_id}: {'Correcte' if is_correct else 'Incorrecte'}"
2026-02-20T22:09:13.3769347Z +                )
2026-02-20T22:09:13.3769446Z +
2026-02-20T22:09:13.3769962Z                  # 🔥 CORRECTION CRITIQUE : Mettre à jour les statistiques utilisateur
2026-02-20T22:09:13.3770087Z                  try:
2026-02-20T22:09:13.3770483Z -                    ExerciseService._update_user_statistics(session, attempt_data, exercise)
2026-02-20T22:09:13.3771138Z -                    logger.info(f"Statistiques mises à jour pour l'utilisateur {attempt_data.get('user_id')}")
2026-02-20T22:09:13.3771353Z +                    ExerciseService._update_user_statistics(
2026-02-20T22:09:13.3771535Z +                        session, attempt_data, exercise
2026-02-20T22:09:13.3771651Z +                    )
2026-02-20T22:09:13.3771800Z +                    logger.info(
2026-02-20T22:09:13.3772355Z +                        f"Statistiques mises à jour pour l'utilisateur {attempt_data.get('user_id')}"
2026-02-20T22:09:13.3772778Z +                    )
2026-02-20T22:09:13.3773160Z                  except Exception as stats_error:
2026-02-20T22:09:13.3773740Z -                    logger.error(f"Erreur lors de la mise à jour des statistiques: {stats_error}")
2026-02-20T22:09:13.3773884Z +                    logger.error(
2026-02-20T22:09:13.3774342Z +                        f"Erreur lors de la mise à jour des statistiques: {stats_error}"
2026-02-20T22:09:13.3774456Z +                    )
2026-02-20T22:09:13.3774862Z                      # Ne pas faire échouer la tentative pour une erreur de stats
2026-02-20T22:09:13.3774972Z -                
2026-02-20T22:09:13.3775084Z +
2026-02-20T22:09:13.3775215Z                  return attempt
2026-02-20T22:09:13.3775415Z              except Exception as attempt_record_error:
2026-02-20T22:09:13.3775719Z                  error_type = type(attempt_record_error).__name__
2026-02-20T22:09:13.3775899Z                  error_msg = str(attempt_record_error)
2026-02-20T22:09:13.3776049Z                  import traceback
2026-02-20T22:09:13.3776706Z -                logger.error(f"❌ ERREUR lors de l'enregistrement de la tentative: {error_type}: {error_msg}")
2026-02-20T22:09:13.3776824Z +
2026-02-20T22:09:13.3777166Z +                logger.error(
2026-02-20T22:09:13.3777729Z +                    f"❌ ERREUR lors de l'enregistrement de la tentative: {error_type}: {error_msg}"
2026-02-20T22:09:13.3777852Z +                )
2026-02-20T22:09:13.3778156Z                  logger.error(f"Traceback complet:\n{traceback.format_exc()}")
2026-02-20T22:09:13.3778286Z                  return None
2026-02-20T22:09:13.3778398Z  
2026-02-20T22:09:13.3778516Z      @staticmethod
2026-02-20T22:09:13.3779224Z -    def _update_user_statistics(session: Session, attempt_data: Dict[str, Any], exercise: Union[Exercise, Dict[str, Any], None]) -> None:
2026-02-20T22:09:13.3779372Z +    def _update_user_statistics(
2026-02-20T22:09:13.3779518Z +        session: Session,
2026-02-20T22:09:13.3779666Z +        attempt_data: Dict[str, Any],
2026-02-20T22:09:13.3779880Z +        exercise: Union[Exercise, Dict[str, Any], None],
2026-02-20T22:09:13.3780008Z +    ) -> None:
2026-02-20T22:09:13.3780115Z          """
2026-02-20T22:09:13.3780536Z          Met à jour les statistiques utilisateur après une tentative.
2026-02-20T22:09:13.3780660Z -        
2026-02-20T22:09:13.3780764Z +
2026-02-20T22:09:13.3780871Z          Args:
2026-02-20T22:09:13.3781139Z              session: Session de base de données
2026-02-20T22:09:13.3781415Z              attempt_data: Données de la tentative
2026-02-20T22:09:13.3781823Z              exercise: Exercice concerné (objet Exercise, dict, ou None)
2026-02-20T22:09:13.3781943Z          """
2026-02-20T22:09:13.3782095Z          from datetime import datetime
2026-02-20T22:09:13.3782198Z  
2026-02-20T22:09:13.3782414Z          from app.models.legacy_tables import UserStats
2026-02-20T22:09:13.3782608Z          from app.models.progress import Progress
2026-02-20T22:09:13.3782739Z -        
2026-02-20T22:09:13.3782843Z +
2026-02-20T22:09:13.3783327Z          user_id = attempt_data.get("user_id")
2026-02-20T22:09:13.3783554Z          is_correct = attempt_data.get("is_correct", False)
2026-02-20T22:09:13.3783769Z          time_spent = attempt_data.get("time_spent", 0)
2026-02-20T22:09:13.3783877Z -        
2026-02-20T22:09:13.3783979Z +
2026-02-20T22:09:13.3784318Z          # Extraire exercise_type et difficulty depuis exercise (objet ou dict)
2026-02-20T22:09:13.3784451Z          if exercise is None:
2026-02-20T22:09:13.3784969Z              logger.warning("Aucun exercice fourni pour mettre à jour les statistiques")
2026-02-20T22:09:13.3785090Z              return
2026-02-20T22:09:13.3785196Z -        
2026-02-20T22:09:13.3785297Z +
2026-02-20T22:09:13.3785459Z          if isinstance(exercise, dict):
2026-02-20T22:09:13.3785665Z              exercise_type = exercise.get("exercise_type")
2026-02-20T22:09:13.3785846Z              difficulty = exercise.get("difficulty")
2026-02-20T22:09:13.3786164Z          else:
2026-02-20T22:09:13.3786358Z              exercise_type = exercise.exercise_type
2026-02-20T22:09:13.3786522Z              difficulty = exercise.difficulty
2026-02-20T22:09:13.3786623Z -        
2026-02-20T22:09:13.3786736Z +
2026-02-20T22:09:13.3786880Z          if not exercise_type:
2026-02-20T22:09:13.3787476Z -            logger.warning(f"Impossible de déterminer le type d'exercice pour les statistiques")
2026-02-20T22:09:13.3787613Z +            logger.warning(
2026-02-20T22:09:13.3788084Z +                f"Impossible de déterminer le type d'exercice pour les statistiques"
2026-02-20T22:09:13.3788190Z +            )
2026-02-20T22:09:13.3788301Z              return
2026-02-20T22:09:13.3788419Z -        
2026-02-20T22:09:13.3788524Z +
2026-02-20T22:09:13.3788775Z          # 1. Mettre à jour ou créer Progress
2026-02-20T22:09:13.3788975Z -        progress = session.query(Progress).filter(
2026-02-20T22:09:13.3789131Z -            Progress.user_id == user_id,
2026-02-20T22:09:13.3789328Z -            Progress.exercise_type == exercise_type
2026-02-20T22:09:13.3789441Z -        ).first()
2026-02-20T22:09:13.3789557Z -        
2026-02-20T22:09:13.3789676Z +        progress = (
2026-02-20T22:09:13.3789822Z +            session.query(Progress)
2026-02-20T22:09:13.3790152Z +            .filter(
2026-02-20T22:09:13.3790495Z +                Progress.user_id == user_id, Progress.exercise_type == exercise_type
2026-02-20T22:09:13.3790605Z +            )
2026-02-20T22:09:13.3790719Z +            .first()
2026-02-20T22:09:13.3790834Z +        )
2026-02-20T22:09:13.3790932Z +
2026-02-20T22:09:13.3791051Z          if progress:
2026-02-20T22:09:13.3791214Z              progress.total_attempts += 1
2026-02-20T22:09:13.3791336Z              if is_correct:
2026-02-20T22:09:13.3791503Z                  progress.correct_attempts += 1
2026-02-20T22:09:13.3791647Z                  progress.streak += 1
2026-02-20T22:09:13.3791880Z                  if progress.streak > progress.highest_streak:
2026-02-20T22:09:13.3792102Z                      progress.highest_streak = progress.streak
2026-02-20T22:09:13.3792216Z              else:
2026-02-20T22:09:13.3792364Z                  progress.streak = 0
2026-02-20T22:09:13.3792487Z -            
2026-02-20T22:09:13.3792592Z +
2026-02-20T22:09:13.3792859Z              # Mettre à jour le temps moyen
2026-02-20T22:09:13.3793207Z              if progress.average_time is None:
2026-02-20T22:09:13.3793391Z                  progress.average_time = time_spent
2026-02-20T22:09:13.3793507Z              else:
2026-02-20T22:09:13.3793923Z -                total_time = progress.average_time * (progress.total_attempts - 1) + time_spent
2026-02-20T22:09:13.3794052Z +                total_time = (
2026-02-20T22:09:13.3794381Z +                    progress.average_time * (progress.total_attempts - 1) + time_spent
2026-02-20T22:09:13.3794504Z +                )
2026-02-20T22:09:13.3794794Z                  progress.average_time = total_time / progress.total_attempts
2026-02-20T22:09:13.3794915Z -            
2026-02-20T22:09:13.3795017Z +
2026-02-20T22:09:13.3795341Z              progress.completion_rate = progress.calculate_completion_rate()
2026-02-20T22:09:13.3795508Z              progress.update_mastery_level()
2026-02-20T22:09:13.3795632Z          else:
2026-02-20T22:09:13.3795789Z              new_progress = Progress(
2026-02-20T22:09:13.3795918Z                  user_id=user_id,
2026-02-20T22:09:13.3796037Z @@ -408,48 +480,65 @@
2026-02-20T22:09:13.3796282Z                  difficulty=difficulty if difficulty else "initie",
2026-02-20T22:09:13.3796417Z                  total_attempts=1,
2026-02-20T22:09:13.3796600Z                  correct_attempts=1 if is_correct else 0,
2026-02-20T22:09:13.3796747Z                  average_time=time_spent,
2026-02-20T22:09:13.3796914Z                  streak=1 if is_correct else 0,
2026-02-20T22:09:13.3797095Z -                highest_streak=1 if is_correct else 0
2026-02-20T22:09:13.3797545Z +                highest_streak=1 if is_correct else 0,
2026-02-20T22:09:13.3797663Z              )
2026-02-20T22:09:13.3797810Z              session.add(new_progress)
2026-02-20T22:09:13.3797918Z -        
2026-02-20T22:09:13.3798028Z +
2026-02-20T22:09:13.3798555Z          # 2. Mettre à jour ou créer UserStats dans une session SÉPARÉE pour éviter
2026-02-20T22:09:13.3799057Z          #    de contaminer la transaction principale (table legacy, peut être absente)
2026-02-20T22:09:13.3799175Z          try:
2026-02-20T22:09:13.3799376Z              from sqlalchemy.orm import sessionmaker
2026-02-20T22:09:13.3799479Z +
2026-02-20T22:09:13.3799762Z              aux_factory = sessionmaker(autocommit=False, autoflush=False)
2026-02-20T22:09:13.3799996Z              aux_session = aux_factory(bind=session.get_bind())
2026-02-20T22:09:13.3800105Z              try:
2026-02-20T22:09:13.3800275Z -                result = aux_session.execute(text(
2026-02-20T22:09:13.3800480Z -                    "SELECT 1 FROM information_schema.tables "
2026-02-20T22:09:13.3800771Z -                    "WHERE table_schema='public' AND table_name='user_stats'"
2026-02-20T22:09:13.3800882Z -                ))
2026-02-20T22:09:13.3801043Z +                result = aux_session.execute(
2026-02-20T22:09:13.3801170Z +                    text(
2026-02-20T22:09:13.3801590Z +                        "SELECT 1 FROM information_schema.tables "
2026-02-20T22:09:13.3801879Z +                        "WHERE table_schema='public' AND table_name='user_stats'"
2026-02-20T22:09:13.3801999Z +                    )
2026-02-20T22:09:13.3802106Z +                )
2026-02-20T22:09:13.3802251Z                  if not result.scalar():
2026-02-20T22:09:13.3802618Z                      logger.debug("Table user_stats absente, ignorée")
2026-02-20T22:09:13.3802738Z                  else:
2026-02-20T22:09:13.3803440Z -                    ex_type_val = exercise_type.value if hasattr(exercise_type, 'value') else str(exercise_type)
2026-02-20T22:09:13.3803938Z -                    diff_val = difficulty.value if hasattr(difficulty, 'value') else str(difficulty) or "initie"
2026-02-20T22:09:13.3804193Z -                    user_stat = aux_session.query(UserStats).filter(
2026-02-20T22:09:13.3804402Z -                        UserStats.exercise_type == ex_type_val,
2026-02-20T22:09:13.3804595Z -                        UserStats.difficulty == diff_val
2026-02-20T22:09:13.3804730Z -                    ).first()
2026-02-20T22:09:13.3804860Z +                    ex_type_val = (
2026-02-20T22:09:13.3805010Z +                        exercise_type.value
2026-02-20T22:09:13.3805205Z +                        if hasattr(exercise_type, "value")
2026-02-20T22:09:13.3805363Z +                        else str(exercise_type)
2026-02-20T22:09:13.3805481Z +                    )
2026-02-20T22:09:13.3805599Z +                    diff_val = (
2026-02-20T22:09:13.3805737Z +                        difficulty.value
2026-02-20T22:09:13.3805910Z +                        if hasattr(difficulty, "value")
2026-02-20T22:09:13.3806083Z +                        else str(difficulty) or "initie"
2026-02-20T22:09:13.3806205Z +                    )
2026-02-20T22:09:13.3806330Z +                    user_stat = (
2026-02-20T22:09:13.3806491Z +                        aux_session.query(UserStats)
2026-02-20T22:09:13.3806615Z +                        .filter(
2026-02-20T22:09:13.3806834Z +                            UserStats.exercise_type == ex_type_val,
2026-02-20T22:09:13.3807024Z +                            UserStats.difficulty == diff_val,
2026-02-20T22:09:13.3807139Z +                        )
2026-02-20T22:09:13.3807261Z +                        .first()
2026-02-20T22:09:13.3807367Z +                    )
2026-02-20T22:09:13.3807490Z                      if user_stat:
2026-02-20T22:09:13.3807672Z                          user_stat.total_attempts += 1
2026-02-20T22:09:13.3807805Z                          if is_correct:
2026-02-20T22:09:13.3807991Z                              user_stat.correct_attempts += 1
2026-02-20T22:09:13.3808419Z                          user_stat.last_updated = datetime.now()
2026-02-20T22:09:13.3808549Z                      else:
2026-02-20T22:09:13.3808715Z -                        aux_session.add(UserStats(
2026-02-20T22:09:13.3808881Z -                            exercise_type=ex_type_val,
2026-02-20T22:09:13.3809048Z -                            difficulty=diff_val,
2026-02-20T22:09:13.3809199Z -                            total_attempts=1,
2026-02-20T22:09:13.3809407Z -                            correct_attempts=1 if is_correct else 0
2026-02-20T22:09:13.3809533Z -                        ))
2026-02-20T22:09:13.3809670Z +                        aux_session.add(
2026-02-20T22:09:13.3809799Z +                            UserStats(
2026-02-20T22:09:13.3809976Z +                                exercise_type=ex_type_val,
2026-02-20T22:09:13.3810148Z +                                difficulty=diff_val,
2026-02-20T22:09:13.3810300Z +                                total_attempts=1,
2026-02-20T22:09:13.3810523Z +                                correct_attempts=1 if is_correct else 0,
2026-02-20T22:09:13.3810648Z +                            )
2026-02-20T22:09:13.3810765Z +                        )
2026-02-20T22:09:13.3810908Z                      aux_session.commit()
2026-02-20T22:09:13.3811028Z              finally:
2026-02-20T22:09:13.3811329Z                  aux_session.close()
2026-02-20T22:09:13.3811506Z          except Exception as user_stats_err:
2026-02-20T22:09:13.3811884Z              logger.debug("UserStats ignoré: %s", user_stats_err)
2026-02-20T22:09:13.3812007Z  
2026-02-20T22:09:13.3812139Z -        session.flush() 
2026-02-20T22:09:13.3812276Z \ No newline at end of file
2026-02-20T22:09:13.3812412Z +        session.flush()
2026-02-20T22:09:13.3874020Z would reformat /home/runner/work/mathakine/mathakine/app/utils/csrf.py
2026-02-20T22:09:13.3874491Z --- /home/runner/work/mathakine/mathakine/app/utils/csrf.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.3875355Z +++ /home/runner/work/mathakine/mathakine/app/utils/csrf.py	2026-02-20 22:09:13.385161+00:00
2026-02-20T22:09:13.3875730Z @@ -3,10 +3,11 @@
2026-02-20T22:09:13.3875839Z  
2026-02-20T22:09:13.3876324Z  Pattern double-submit : le backend génère un token, le met en cookie
2026-02-20T22:09:13.3876639Z  et le retourne. Le client renvoie le token dans le header X-CSRF-Token.
2026-02-20T22:09:13.3876943Z  Un attaquant cross-site ne peut pas lire le cookie ni forger le header.
2026-02-20T22:09:13.3877046Z  """
2026-02-20T22:09:13.3877153Z +
2026-02-20T22:09:13.3877265Z  import os
2026-02-20T22:09:13.3877378Z  import secrets
2026-02-20T22:09:13.3877475Z  
2026-02-20T22:09:13.3877668Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.3877822Z  from starlette.requests import Request
2026-02-20T22:09:13.6017872Z --- /home/runner/work/mathakine/mathakine/app/services/user_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6019167Z +++ /home/runner/work/mathakine/mathakine/app/services/user_service.py	2026-02-20 22:09:13.597470+00:00
2026-02-20T22:09:13.6020026Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.6020333Z  """
2026-02-20T22:09:13.6020664Z  Service pour la gestion des utilisateurs.
2026-02-20T22:09:13.6021822Z  Implémente les opérations métier liées aux utilisateurs et utilise le transaction manager.
2026-02-20T22:09:13.6022602Z  """
2026-02-20T22:09:13.6022859Z +
2026-02-20T22:09:13.6023404Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:13.6023848Z  
2026-02-20T22:09:13.6024192Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.6024652Z  
2026-02-20T22:09:13.6024939Z  logger = get_logger(__name__)
2026-02-20T22:09:13.6025311Z @@ -24,221 +25,237 @@
2026-02-20T22:09:13.6025623Z      """
2026-02-20T22:09:13.6025950Z      Service pour la gestion des utilisateurs.
2026-02-20T22:09:13.6026880Z      Fournit des méthodes pour récupérer, créer, modifier et supprimer des utilisateurs,
2026-02-20T22:09:13.6027835Z      ainsi que pour consulter leurs activités et statistiques.
2026-02-20T22:09:13.6028828Z      """
2026-02-20T22:09:13.6029104Z -    
2026-02-20T22:09:13.6029352Z +
2026-02-20T22:09:13.6029617Z      @staticmethod
2026-02-20T22:09:13.6030061Z      def get_user(db: Session, user_id: int) -> Optional[User]:
2026-02-20T22:09:13.6030601Z          """
2026-02-20T22:09:13.6031067Z          Récupère un utilisateur par son ID.
2026-02-20T22:09:13.6031508Z -        
2026-02-20T22:09:13.6031769Z +
2026-02-20T22:09:13.6032019Z          Args:
2026-02-20T22:09:13.6032449Z              db: Session de base de données
2026-02-20T22:09:13.6033208Z              user_id: ID de l'utilisateur à récupérer
2026-02-20T22:09:13.6033684Z -            
2026-02-20T22:09:13.6033963Z +
2026-02-20T22:09:13.6034224Z          Returns:
2026-02-20T22:09:13.6034823Z              L'utilisateur correspondant à l'ID ou None s'il n'existe pas
2026-02-20T22:09:13.6035411Z          """
2026-02-20T22:09:13.6035805Z          return DatabaseAdapter.get_by_id(db, User, user_id)
2026-02-20T22:09:13.6036312Z -    
2026-02-20T22:09:13.6036589Z +
2026-02-20T22:09:13.6036842Z      @staticmethod
2026-02-20T22:09:13.6037361Z      def get_user_by_username(db: Session, username: str) -> Optional[User]:
2026-02-20T22:09:13.6037965Z          """
2026-02-20T22:09:13.6038476Z          Récupère un utilisateur par son nom d'utilisateur.
2026-02-20T22:09:13.6039228Z -        
2026-02-20T22:09:13.6039514Z +
2026-02-20T22:09:13.6039756Z          Args:
2026-02-20T22:09:13.6040180Z              db: Session de base de données
2026-02-20T22:09:13.6040761Z              username: Nom d'utilisateur à rechercher
2026-02-20T22:09:13.6041221Z -            
2026-02-20T22:09:13.6041493Z +
2026-02-20T22:09:13.6041739Z          Returns:
2026-02-20T22:09:13.6042298Z              L'utilisateur correspondant au nom d'utilisateur ou None s'il n'existe pas
2026-02-20T22:09:13.6063235Z          """
2026-02-20T22:09:13.6063841Z          users = DatabaseAdapter.get_by_field(db, User, "username", username)
2026-02-20T22:09:13.6064505Z          return users[0] if users else None
2026-02-20T22:09:13.6064947Z -    
2026-02-20T22:09:13.6065203Z +
2026-02-20T22:09:13.6065462Z      @staticmethod
2026-02-20T22:09:13.6065941Z      def get_user_by_email(db: Session, email: str) -> Optional[User]:
2026-02-20T22:09:13.6066494Z          """
2026-02-20T22:09:13.6067050Z          Récupère un utilisateur par son adresse email.
2026-02-20T22:09:13.6067526Z -        
2026-02-20T22:09:13.6067793Z +
2026-02-20T22:09:13.6068035Z          Args:
2026-02-20T22:09:13.6068441Z              db: Session de base de données
2026-02-20T22:09:13.6068977Z              email: Adresse email à rechercher
2026-02-20T22:09:13.6069398Z -            
2026-02-20T22:09:13.6069664Z +
2026-02-20T22:09:13.6069918Z          Returns:
2026-02-20T22:09:13.6070645Z              L'utilisateur correspondant à l'adresse email ou None s'il n'existe pas
2026-02-20T22:09:13.6071275Z          """
2026-02-20T22:09:13.6071722Z          users = DatabaseAdapter.get_by_field(db, User, "email", email)
2026-02-20T22:09:13.6072320Z          return users[0] if users else None
2026-02-20T22:09:13.6072746Z -    
2026-02-20T22:09:13.6073207Z -    @staticmethod
2026-02-20T22:09:13.6073885Z -    def list_users(db: Session, limit: Optional[int] = None, offset: Optional[int] = None) -> List[User]:
2026-02-20T22:09:13.6074638Z +
2026-02-20T22:09:13.6074911Z +    @staticmethod
2026-02-20T22:09:13.6075214Z +    def list_users(
2026-02-20T22:09:13.6075714Z +        db: Session, limit: Optional[int] = None, offset: Optional[int] = None
2026-02-20T22:09:13.6076694Z would reformat /home/runner/work/mathakine/mathakine/app/services/user_service.py
2026-02-20T22:09:13.6077370Z +    ) -> List[User]:
2026-02-20T22:09:13.6077682Z          """
2026-02-20T22:09:13.6077999Z          Liste tous les utilisateurs actifs.
2026-02-20T22:09:13.6078420Z -        
2026-02-20T22:09:13.6078672Z +
2026-02-20T22:09:13.6078923Z          Args:
2026-02-20T22:09:13.6079329Z              db: Session de base de données
2026-02-20T22:09:13.6079932Z              limit: Nombre maximum d'utilisateurs à retourner
2026-02-20T22:09:13.6080905Z              offset: Décalage pour la pagination
2026-02-20T22:09:13.6081335Z -            
2026-02-20T22:09:13.6081608Z +
2026-02-20T22:09:13.6081845Z          Returns:
2026-02-20T22:09:13.6082179Z              Liste des utilisateurs actifs
2026-02-20T22:09:13.6082774Z          """
2026-02-20T22:09:13.6083234Z          try:
2026-02-20T22:09:13.6083625Z              query = db.query(User).filter(User.is_active == True)
2026-02-20T22:09:13.6084134Z -            
2026-02-20T22:09:13.6084398Z +
2026-02-20T22:09:13.6084661Z              if offset is not None:
2026-02-20T22:09:13.6085092Z                  query = query.offset(offset)
2026-02-20T22:09:13.6085496Z -            
2026-02-20T22:09:13.6085761Z +
2026-02-20T22:09:13.6086021Z              if limit is not None:
2026-02-20T22:09:13.6086434Z                  query = query.limit(limit)
2026-02-20T22:09:13.6086825Z -            
2026-02-20T22:09:13.6087090Z +
2026-02-20T22:09:13.6087346Z              return query.all()
2026-02-20T22:09:13.6087779Z          except Exception as users_fetch_error:
2026-02-20T22:09:13.6088682Z -            logger.error(f"Erreur lors de la récupération des utilisateurs: {users_fetch_error}")
2026-02-20T22:09:13.6089411Z +            logger.error(
2026-02-20T22:09:13.6090095Z +                f"Erreur lors de la récupération des utilisateurs: {users_fetch_error}"
2026-02-20T22:09:13.6090701Z +            )
2026-02-20T22:09:13.6090988Z              return []
2026-02-20T22:09:13.6091287Z -    
2026-02-20T22:09:13.6091544Z +
2026-02-20T22:09:13.6091785Z      @staticmethod
2026-02-20T22:09:13.6092291Z      def create_user(db: Session, user_data: Dict[str, Any]) -> Optional[User]:
2026-02-20T22:09:13.6092896Z          """
2026-02-20T22:09:13.6123672Z          Crée un nouvel utilisateur.
2026-02-20T22:09:13.6124100Z -        
2026-02-20T22:09:13.6124365Z +
2026-02-20T22:09:13.6124619Z          Args:
2026-02-20T22:09:13.6125020Z              db: Session de base de données
2026-02-20T22:09:13.6125741Z              user_data: Dictionnaire contenant les données de l'utilisateur
2026-02-20T22:09:13.6126331Z -            
2026-02-20T22:09:13.6126608Z +
2026-02-20T22:09:13.6126851Z          Returns:
2026-02-20T22:09:13.6127319Z              L'utilisateur créé ou None en cas d'erreur
2026-02-20T22:09:13.6127787Z          """
2026-02-20T22:09:13.6128340Z          # Vérifier si l'utilisateur existe déjà (par email ou username)
2026-02-20T22:09:13.6128967Z          username = user_data.get("username")
2026-02-20T22:09:13.6129415Z          email = user_data.get("email")
2026-02-20T22:09:13.6129811Z -        
2026-02-20T22:09:13.6130064Z +
2026-02-20T22:09:13.6130555Z          with TransactionManager.transaction(db, auto_commit=False) as session:
2026-02-20T22:09:13.6131390Z              if username and UserService.get_user_by_username(session, username):
2026-02-20T22:09:13.6132337Z                  logger.error(f"Un utilisateur avec le nom '{username}' existe déjà")
2026-02-20T22:09:13.6133119Z                  return None
2026-02-20T22:09:13.6133480Z -            
2026-02-20T22:09:13.6133751Z +
2026-02-20T22:09:13.6134144Z              if email and UserService.get_user_by_email(session, email):
2026-02-20T22:09:13.6135019Z                  logger.error(f"Un utilisateur avec l'email '{email}' existe déjà")
2026-02-20T22:09:13.6135626Z                  return None
2026-02-20T22:09:13.6135961Z -            
2026-02-20T22:09:13.6136216Z +
2026-02-20T22:09:13.6136790Z              # Adapter le rôle utilisateur pour le moteur de base de données actuel
2026-02-20T22:09:13.6137426Z              role = user_data.get("role")
2026-02-20T22:09:13.6137830Z              if role:
2026-02-20T22:09:13.6138315Z                  user_data["role"] = adapt_enum_for_db("UserRole", role, session)
2026-02-20T22:09:13.6139195Z                  logger.debug(f"Rôle adapté: de '{role}' à '{user_data['role']}'")
2026-02-20T22:09:13.6139769Z -            
2026-02-20T22:09:13.6140029Z +
2026-02-20T22:09:13.6140424Z              return DatabaseAdapter.create(session, User, user_data)
2026-02-20T22:09:13.6141222Z -    
2026-02-20T22:09:13.6141468Z +
2026-02-20T22:09:13.6141724Z      @staticmethod
2026-02-20T22:09:13.6142244Z      def update_user(db: Session, user_id: int, user_data: Dict[str, Any]) -> bool:
2026-02-20T22:09:13.6142873Z          """
2026-02-20T22:09:13.6143668Z          Met à jour un utilisateur existant.
2026-02-20T22:09:13.6144106Z -        
2026-02-20T22:09:13.6144356Z +
2026-02-20T22:09:13.6144606Z          Args:
2026-02-20T22:09:13.6144999Z              db: Session de base de données
2026-02-20T22:09:13.6145592Z              user_id: ID de l'utilisateur à mettre à jour
2026-02-20T22:09:13.6146199Z              user_data: Dictionnaire contenant les nouvelles valeurs
2026-02-20T22:09:13.6146715Z -            
2026-02-20T22:09:13.6146992Z +
2026-02-20T22:09:13.6147234Z          Returns:
2026-02-20T22:09:13.6147710Z              True si la mise à jour a réussi, False sinon
2026-02-20T22:09:13.6148166Z          """
2026-02-20T22:09:13.6148514Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6148953Z          if not user:
2026-02-20T22:09:13.6149642Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour mise à jour")
2026-02-20T22:09:13.6150304Z              return False
2026-02-20T22:09:13.6150633Z -        
2026-02-20T22:09:13.6150893Z +
2026-02-20T22:09:13.6151471Z          # Adapter le rôle utilisateur si présent dans les données de mise à jour
2026-02-20T22:09:13.6152101Z          if "role" in user_data:
2026-02-20T22:09:13.6152488Z              role = user_data["role"]
2026-02-20T22:09:13.6183316Z              user_data["role"] = adapt_enum_for_db("UserRole", role, db)
2026-02-20T22:09:13.6184475Z -            logger.debug(f"Rôle adapté pour mise à jour: de '{role}' à '{user_data['role']}'")
2026-02-20T22:09:13.6185207Z -        
2026-02-20T22:09:13.6185519Z +            logger.debug(
2026-02-20T22:09:13.6186253Z +                f"Rôle adapté pour mise à jour: de '{role}' à '{user_data['role']}'"
2026-02-20T22:09:13.6186909Z +            )
2026-02-20T22:09:13.6187203Z +
2026-02-20T22:09:13.6187595Z          return DatabaseAdapter.update(db, user, user_data)
2026-02-20T22:09:13.6188090Z -    
2026-02-20T22:09:13.6188361Z +
2026-02-20T22:09:13.6188624Z      @staticmethod
2026-02-20T22:09:13.6189069Z      def delete_user(db: Session, user_id: int) -> bool:
2026-02-20T22:09:13.6189558Z          """
2026-02-20T22:09:13.6190131Z          Supprime physiquement un utilisateur de la base de données.
2026-02-20T22:09:13.6190940Z          Les entités associées sont supprimées en cascade.
2026-02-20T22:09:13.6191434Z -        
2026-02-20T22:09:13.6191719Z +
2026-02-20T22:09:13.6191985Z          Args:
2026-02-20T22:09:13.6192441Z              db: Session de base de données
2026-02-20T22:09:13.6193255Z              user_id: ID de l'utilisateur à supprimer
2026-02-20T22:09:13.6193742Z -            
2026-02-20T22:09:13.6194021Z +
2026-02-20T22:09:13.6194281Z          Returns:
2026-02-20T22:09:13.6194823Z              True si la suppression a réussi, False sinon
2026-02-20T22:09:13.6195327Z          """
2026-02-20T22:09:13.6195695Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6196165Z          if not user:
2026-02-20T22:09:13.6196947Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour suppression")
2026-02-20T22:09:13.6197634Z              return False
2026-02-20T22:09:13.6197977Z -        
2026-02-20T22:09:13.6198242Z +
2026-02-20T22:09:13.6198576Z          return DatabaseAdapter.delete(db, user)
2026-02-20T22:09:13.6199031Z -    
2026-02-20T22:09:13.6199299Z +
2026-02-20T22:09:13.6199563Z      @staticmethod
2026-02-20T22:09:13.6200000Z      def disable_user(db: Session, user_id: int) -> bool:
2026-02-20T22:09:13.6200505Z          """
2026-02-20T22:09:13.6201105Z          Désactive un utilisateur (préférable à la suppression).
2026-02-20T22:09:13.6201650Z -        
2026-02-20T22:09:13.6201902Z +
2026-02-20T22:09:13.6202133Z          Args:
2026-02-20T22:09:13.6202871Z              db: Session de base de données
2026-02-20T22:09:13.6203727Z              user_id: ID de l'utilisateur à désactiver
2026-02-20T22:09:13.6204189Z -            
2026-02-20T22:09:13.6204479Z +
2026-02-20T22:09:13.6204722Z          Returns:
2026-02-20T22:09:13.6205505Z              True si la désactivation a réussi, False sinon
2026-02-20T22:09:13.6206050Z          """
2026-02-20T22:09:13.6206409Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6206911Z          if not user:
2026-02-20T22:09:13.6207673Z              logger.error(f"Utilisateur avec ID {user_id} non trouvé pour désactivation")
2026-02-20T22:09:13.6208271Z              return False
2026-02-20T22:09:13.6208549Z -        
2026-02-20T22:09:13.6208776Z +
2026-02-20T22:09:13.6209157Z          return DatabaseAdapter.update(db, user, {"is_active": False})
2026-02-20T22:09:13.6209667Z -    
2026-02-20T22:09:13.6209912Z -    @staticmethod
2026-02-20T22:09:13.6210415Z -    def get_user_stats(db: Session, user_id: int, time_range: str = "30") -> Dict[str, Any]:
2026-02-20T22:09:13.6211028Z +
2026-02-20T22:09:13.6211257Z +    @staticmethod
2026-02-20T22:09:13.6211543Z +    def get_user_stats(
2026-02-20T22:09:13.6211942Z +        db: Session, user_id: int, time_range: str = "30"
2026-02-20T22:09:13.6212410Z +    ) -> Dict[str, Any]:
2026-02-20T22:09:13.6212711Z          """
2026-02-20T22:09:13.6243523Z          Récupère les statistiques d'un utilisateur.
2026-02-20T22:09:13.6244061Z -        
2026-02-20T22:09:13.6244337Z +
2026-02-20T22:09:13.6244604Z          Args:
2026-02-20T22:09:13.6245079Z              db: Session de base de données
2026-02-20T22:09:13.6245555Z              user_id: ID de l'utilisateur
2026-02-20T22:09:13.6246223Z              time_range: Période de temps ("7", "30", "90", "all")
2026-02-20T22:09:13.6246761Z -            
2026-02-20T22:09:13.6247045Z +
2026-02-20T22:09:13.6247316Z          Returns:
2026-02-20T22:09:13.6247784Z              Dictionnaire contenant les statistiques de l'utilisateur
2026-02-20T22:09:13.6248362Z          """
2026-02-20T22:09:13.6248711Z          user = UserService.get_user(db, user_id)
2026-02-20T22:09:13.6249176Z          if not user:
2026-02-20T22:09:13.6250056Z -            logger.error(f"Utilisateur avec ID {user_id} non trouvé pour récupération des statistiques")
2026-02-20T22:09:13.6250886Z +            logger.error(
2026-02-20T22:09:13.6251678Z +                f"Utilisateur avec ID {user_id} non trouvé pour récupération des statistiques"
2026-02-20T22:09:13.6252366Z +            )
2026-02-20T22:09:13.6252668Z              return {}
2026-02-20T22:09:13.6253169Z -        
2026-02-20T22:09:13.6253455Z +
2026-02-20T22:09:13.6253712Z          try:
2026-02-20T22:09:13.6254118Z              from datetime import datetime, timedelta, timezone
2026-02-20T22:09:13.6254650Z  
2026-02-20T22:09:13.6255120Z              # Calculer la date de début selon time_range
2026-02-20T22:09:13.6255641Z              date_filter = None
2026-02-20T22:09:13.6256031Z              if time_range != "all":
2026-02-20T22:09:13.6256495Z                  days = int(time_range)
2026-02-20T22:09:13.6257116Z                  date_filter = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:13.6257754Z -            
2026-02-20T22:09:13.6258043Z +
2026-02-20T22:09:13.6258421Z              # Statistiques de base avec filtre temporel
2026-02-20T22:09:13.6259141Z              attempts_query = db.query(Attempt).filter(Attempt.user_id == user_id)
2026-02-20T22:09:13.6259806Z              if date_filter:
2026-02-20T22:09:13.6260442Z -                attempts_query = attempts_query.filter(Attempt.created_at >= date_filter)
2026-02-20T22:09:13.6261136Z -            
2026-02-20T22:09:13.6261517Z +                attempts_query = attempts_query.filter(
2026-02-20T22:09:13.6262057Z +                    Attempt.created_at >= date_filter
2026-02-20T22:09:13.6262515Z +                )
2026-02-20T22:09:13.6262844Z +
2026-02-20T22:09:13.6263382Z              total_attempts = attempts_query.count()
2026-02-20T22:09:13.6264293Z              correct_attempts = attempts_query.filter(Attempt.is_correct == True).count()
2026-02-20T22:09:13.6264881Z -            
2026-02-20T22:09:13.6265124Z +
2026-02-20T22:09:13.6265650Z              # Calculer le taux de réussite (éviter la division par zéro)
2026-02-20T22:09:13.6266627Z -            success_rate = round((correct_attempts / total_attempts) * 100) if total_attempts > 0 else 0
2026-02-20T22:09:13.6267369Z -            
2026-02-20T22:09:13.6267633Z +            success_rate = (
2026-02-20T22:09:13.6268038Z +                round((correct_attempts / total_attempts) * 100)
2026-02-20T22:09:13.6268479Z +                if total_attempts > 0
2026-02-20T22:09:13.6268843Z +                else 0
2026-02-20T22:09:13.6269118Z +            )
2026-02-20T22:09:13.6269369Z +
2026-02-20T22:09:13.6269643Z              # Statistiques par type d'exercice
2026-02-20T22:09:13.6270069Z              exercise_types_stats = {}
2026-02-20T22:09:13.6270417Z -            
2026-02-20T22:09:13.6270663Z +
2026-02-20T22:09:13.6271280Z              # Récupérer les statistiques directement avec SQL brut pour éviter les problèmes d'enum
2026-02-20T22:09:13.6272134Z              # et gérer les types en MAJUSCULES/minuscules mélangés
2026-02-20T22:09:13.6272753Z              # Ajouter le filtre temporel dans la requête SQL
2026-02-20T22:09:13.6303637Z              if date_filter:
2026-02-20T22:09:13.6303986Z                  stats_query = text("""
2026-02-20T22:09:13.6304319Z @@ -251,14 +268,13 @@
2026-02-20T22:09:13.6304615Z                      WHERE a.user_id = :user_id
2026-02-20T22:09:13.6305022Z                        AND a.created_at >= :date_filter
2026-02-20T22:09:13.6305528Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:13.6305937Z                      ORDER BY total DESC
2026-02-20T22:09:13.6306261Z                  """)
2026-02-20T22:09:13.6306569Z -                result = db.execute(stats_query, {
2026-02-20T22:09:13.6306956Z -                    "user_id": user_id,
2026-02-20T22:09:13.6307325Z -                    "date_filter": date_filter
2026-02-20T22:09:13.6307674Z -                })
2026-02-20T22:09:13.6307961Z +                result = db.execute(
2026-02-20T22:09:13.6308424Z +                    stats_query, {"user_id": user_id, "date_filter": date_filter}
2026-02-20T22:09:13.6308938Z +                )
2026-02-20T22:09:13.6309180Z              else:
2026-02-20T22:09:13.6309436Z                  stats_query = text("""
2026-02-20T22:09:13.6309776Z                      SELECT 
2026-02-20T22:09:13.6310205Z                          LOWER(e.exercise_type::text) as exercise_type_normalized,
2026-02-20T22:09:13.6310694Z                          COUNT(*) as total,
2026-02-20T22:09:13.6311027Z @@ -268,65 +284,71 @@
2026-02-20T22:09:13.6311333Z                      WHERE a.user_id = :user_id
2026-02-20T22:09:13.6311738Z                      GROUP BY LOWER(e.exercise_type::text)
2026-02-20T22:09:13.6312132Z                      ORDER BY total DESC
2026-02-20T22:09:13.6312467Z                  """)
2026-02-20T22:09:13.6312815Z                  result = db.execute(stats_query, {"user_id": user_id})
2026-02-20T22:09:13.6313432Z -            
2026-02-20T22:09:13.6313673Z +
2026-02-20T22:09:13.6313926Z              stats_rows = result.fetchall()
2026-02-20T22:09:13.6314279Z -            
2026-02-20T22:09:13.6314523Z +
2026-02-20T22:09:13.6314992Z              # Construire le dictionnaire de statistiques par type normalisé
2026-02-20T22:09:13.6315514Z              for row in stats_rows:
2026-02-20T22:09:13.6315872Z                  ex_type_normalized = row[0]
2026-02-20T22:09:13.6316225Z                  total_type = row[1]
2026-02-20T22:09:13.6316570Z                  correct_type = row[2]
2026-02-20T22:09:13.6317144Z -                success_rate_type = round((correct_type / total_type) * 100) if total_type > 0 else 0
2026-02-20T22:09:13.6317750Z -                
2026-02-20T22:09:13.6318016Z +                success_rate_type = (
2026-02-20T22:09:13.6318502Z +                    round((correct_type / total_type) * 100) if total_type > 0 else 0
2026-02-20T22:09:13.6319246Z +                )
2026-02-20T22:09:13.6319497Z +
2026-02-20T22:09:13.6319785Z                  exercise_types_stats[ex_type_normalized] = {
2026-02-20T22:09:13.6320215Z                      "total": total_type,
2026-02-20T22:09:13.6320786Z                      "correct": correct_type,
2026-02-20T22:09:13.6321233Z -                    "success_rate": success_rate_type
2026-02-20T22:09:13.6321655Z +                    "success_rate": success_rate_type,
2026-02-20T22:09:13.6322024Z                  }
2026-02-20T22:09:13.6322268Z -            
2026-02-20T22:09:13.6322497Z +
2026-02-20T22:09:13.6322943Z              # Récupérer les données de progression si disponibles
2026-02-20T22:09:13.6323812Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.6324433Z +            progress_records = (
2026-02-20T22:09:13.6324893Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.6325389Z +            )
2026-02-20T22:09:13.6325658Z              progress_data = {}
2026-02-20T22:09:13.6325952Z -            
2026-02-20T22:09:13.6326181Z +
2026-02-20T22:09:13.6326418Z              for record in progress_records:
2026-02-20T22:09:13.6326828Z                  ex_type = record.exercise_type
2026-02-20T22:09:13.6327229Z                  difficulty = record.difficulty
2026-02-20T22:09:13.6327580Z -                
2026-02-20T22:09:13.6327823Z +
2026-02-20T22:09:13.6328072Z                  if ex_type not in progress_data:
2026-02-20T22:09:13.6328485Z                      progress_data[ex_type] = {}
2026-02-20T22:09:13.6328833Z -                
2026-02-20T22:09:13.6329065Z +
2026-02-20T22:09:13.6329329Z                  progress_data[ex_type][difficulty] = {
2026-02-20T22:09:13.6329772Z                      "mastery_level": record.mastery_level,
2026-02-20T22:09:13.6330195Z                      "streak": record.streak,
2026-02-20T22:09:13.6330613Z                      "highest_streak": record.highest_streak,
2026-02-20T22:09:13.6331069Z                      "total_attempts": record.total_attempts,
2026-02-20T22:09:13.6331525Z -                    "correct_attempts": record.correct_attempts
2026-02-20T22:09:13.6332014Z +                    "correct_attempts": record.correct_attempts,
2026-02-20T22:09:13.6332407Z                  }
2026-02-20T22:09:13.6332649Z -            
2026-02-20T22:09:13.6332869Z +
2026-02-20T22:09:13.6363504Z              # Assembler toutes les statistiques
2026-02-20T22:09:13.6363911Z              stats = {
2026-02-20T22:09:13.6364192Z                  "user_id": user.id,
2026-02-20T22:09:13.6364555Z                  "username": user.username,
2026-02-20T22:09:13.6364990Z                  "user": {
2026-02-20T22:09:13.6365293Z                      "id": user.id,
2026-02-20T22:09:13.6365641Z                      "username": user.username,
2026-02-20T22:09:13.6366021Z                      "role": user.role,
2026-02-20T22:09:13.6366398Z -                    "grade_level": user.grade_level
2026-02-20T22:09:13.6366823Z +                    "grade_level": user.grade_level,
2026-02-20T22:09:13.6367188Z                  },
2026-02-20T22:09:13.6367477Z                  "total_attempts": total_attempts,
2026-02-20T22:09:13.6367920Z                  "correct_attempts": correct_attempts,
2026-02-20T22:09:13.6368335Z                  "success_rate": success_rate,
2026-02-20T22:09:13.6368754Z -                "by_exercise_type": exercise_types_stats
2026-02-20T22:09:13.6369214Z +                "by_exercise_type": exercise_types_stats,
2026-02-20T22:09:13.6369594Z              }
2026-02-20T22:09:13.6369819Z -            
2026-02-20T22:09:13.6370064Z +
2026-02-20T22:09:13.6370530Z              # Ajouter les données de progression si disponibles
2026-02-20T22:09:13.6370974Z              if progress_data:
2026-02-20T22:09:13.6371335Z                  stats["progress"] = progress_data
2026-02-20T22:09:13.6371710Z -            
2026-02-20T22:09:13.6372180Z +
2026-02-20T22:09:13.6372395Z              return stats
2026-02-20T22:09:13.6372677Z -            
2026-02-20T22:09:13.6372908Z +
2026-02-20T22:09:13.6373359Z          except Exception as stats_fetch_error:
2026-02-20T22:09:13.6374323Z -            logger.error(f"Erreur lors de la récupération des statistiques: {stats_fetch_error}")
2026-02-20T22:09:13.6375259Z -            return {"stats_error": "Erreur lors de la récupération des statistiques"} 
2026-02-20T22:09:13.6375828Z \ No newline at end of file
2026-02-20T22:09:13.6376141Z +            logger.error(
2026-02-20T22:09:13.6376717Z +                f"Erreur lors de la récupération des statistiques: {stats_fetch_error}"
2026-02-20T22:09:13.6377230Z +            )
2026-02-20T22:09:13.6377755Z +            return {"stats_error": "Erreur lors de la récupération des statistiques"}
2026-02-20T22:09:13.6378530Z would reformat /home/runner/work/mathakine/mathakine/app/utils/db_utils.py
2026-02-20T22:09:13.6379344Z --- /home/runner/work/mathakine/mathakine/app/utils/db_utils.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6380279Z +++ /home/runner/work/mathakine/mathakine/app/utils/db_utils.py	2026-02-20 22:09:13.623067+00:00
2026-02-20T22:09:13.6380918Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.6381182Z  """
2026-02-20T22:09:13.6381454Z  Utilitaires DB pour les handlers (DRY).
2026-02-20T22:09:13.6381925Z  Context manager pour session + commit/rollback/close.
2026-02-20T22:09:13.6382338Z  """
2026-02-20T22:09:13.6382549Z +
2026-02-20T22:09:13.6382828Z  from contextlib import asynccontextmanager
2026-02-20T22:09:13.6383416Z  from typing import AsyncGenerator
2026-02-20T22:09:13.6383751Z  
2026-02-20T22:09:13.6383992Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.6384324Z  
2026-02-20T22:09:13.6855633Z --- /home/runner/work/mathakine/mathakine/app/utils/email_templates.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.6856764Z +++ /home/runner/work/mathakine/mathakine/app/utils/email_templates.py	2026-02-20 22:09:13.683943+00:00
2026-02-20T22:09:13.6857542Z @@ -1,19 +1,19 @@
2026-02-20T22:09:13.6857795Z  """
2026-02-20T22:09:13.6858532Z  Templates emails Mathakine - Thème Jedi / L'Ordre des Mathématiques
2026-02-20T22:09:13.6859293Z  Design unifié, ergonomique et accessible pour tous les clients email.
2026-02-20T22:09:13.6859801Z  """
2026-02-20T22:09:13.6860038Z +
2026-02-20T22:09:13.6860283Z  from typing import Optional
2026-02-20T22:09:13.6860580Z -
2026-02-20T22:09:13.6860795Z  
2026-02-20T22:09:13.6861222Z  # Couleurs du thème Jedi/Space (compatible clients email)
2026-02-20T22:09:13.6861654Z  THEME = {
2026-02-20T22:09:13.6861957Z -    "bg_dark": "#0f172a",       # Fond header (espace)
2026-02-20T22:09:13.6862398Z -    "bg_content": "#ffffff",    # Corps du message
2026-02-20T22:09:13.6862832Z -    "accent": "#06b6d4",        # Cyan (lame de sabre)
2026-02-20T22:09:13.6863443Z +    "bg_dark": "#0f172a",  # Fond header (espace)
2026-02-20T22:09:13.6863872Z +    "bg_content": "#ffffff",  # Corps du message
2026-02-20T22:09:13.6864296Z +    "accent": "#06b6d4",  # Cyan (lame de sabre)
2026-02-20T22:09:13.6864681Z      "accent_hover": "#0891b2",
2026-02-20T22:09:13.6865023Z -    "gold": "#f59e0b",          # Sagesse Jedi
2026-02-20T22:09:13.6865398Z +    "gold": "#f59e0b",  # Sagesse Jedi
2026-02-20T22:09:13.6865747Z      "text_dark": "#1e293b",
2026-02-20T22:09:13.6866066Z      "text_light": "#e2e8f0",
2026-02-20T22:09:13.6866388Z      "text_muted": "#64748b",
2026-02-20T22:09:13.6866681Z      "border": "#e2e8f0",
2026-02-20T22:09:13.6866956Z  }
2026-02-20T22:09:13.6867644Z would reformat /home/runner/work/mathakine/mathakine/app/utils/email_templates.py
2026-02-20T22:09:13.7805099Z --- /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.7806534Z +++ /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py	2026-02-20 22:09:13.776768+00:00
2026-02-20T22:09:13.7807411Z @@ -1,63 +1,63 @@
2026-02-20T22:09:13.7809552Z  """
2026-02-20T22:09:13.7824167Z would reformat /home/runner/work/mathakine/mathakine/app/utils/db_helpers.py
2026-02-20T22:09:13.7825880Z  Utilitaires pour la gestion des valeurs d'énumération PostgreSQL.
2026-02-20T22:09:13.7826921Z  """
2026-02-20T22:09:13.7827413Z +
2026-02-20T22:09:13.7827788Z  from typing import Any, Dict, Optional
2026-02-20T22:09:13.7828235Z  
2026-02-20T22:09:13.7828841Z  from sqlalchemy import inspect
2026-02-20T22:09:13.7829314Z  from sqlalchemy.orm import Session
2026-02-20T22:09:13.7829725Z  
2026-02-20T22:09:13.7829965Z  
2026-02-20T22:09:13.7830288Z  def get_db_engine(db_session: Session) -> str:
2026-02-20T22:09:13.7830726Z      """
2026-02-20T22:09:13.7831390Z      Détecte le moteur de base de données utilisé (postgresql ou sqlite).
2026-02-20T22:09:13.7831995Z -    
2026-02-20T22:09:13.7832239Z +
2026-02-20T22:09:13.7832464Z      Args:
2026-02-20T22:09:13.7832862Z          db_session: Session de base de données
2026-02-20T22:09:13.7833511Z -        
2026-02-20T22:09:13.7833734Z +
2026-02-20T22:09:13.7833964Z      Returns:
2026-02-20T22:09:13.7834523Z          Nom du moteur de base de données ('postgresql' ou 'sqlite')
2026-02-20T22:09:13.7835057Z      """
2026-02-20T22:09:13.7835396Z      engine_name = db_session.bind.engine.name
2026-02-20T22:09:13.7835872Z      return engine_name
2026-02-20T22:09:13.7836207Z  
2026-02-20T22:09:13.7836445Z +
2026-02-20T22:09:13.7836797Z  def is_postgresql(db_session: Session) -> bool:
2026-02-20T22:09:13.7837264Z      """
2026-02-20T22:09:13.7837792Z      Vérifie si le moteur de base de données est PostgreSQL.
2026-02-20T22:09:13.7838301Z -    
2026-02-20T22:09:13.7838570Z +
2026-02-20T22:09:13.7838817Z      Args:
2026-02-20T22:09:13.7839252Z          db_session: Session de base de données
2026-02-20T22:09:13.7839763Z -        
2026-02-20T22:09:13.7840018Z +
2026-02-20T22:09:13.7840268Z      Returns:
2026-02-20T22:09:13.7840624Z          True si le moteur est PostgreSQL, False sinon
2026-02-20T22:09:13.7841095Z      """
2026-02-20T22:09:13.7841402Z      engine_name = get_db_engine(db_session)
2026-02-20T22:09:13.7841894Z -    return engine_name == 'postgresql'
2026-02-20T22:09:13.7842351Z +    return engine_name == "postgresql"
2026-02-20T22:09:13.7842756Z +
2026-02-20T22:09:13.7843181Z  
2026-02-20T22:09:13.7843667Z  # Mapping des valeurs d'énumération pour PostgreSQL
2026-02-20T22:09:13.7844290Z  # Format: (nom_enum, valeur_python): valeur_postgresql
2026-02-20T22:09:13.7844792Z  ENUM_MAPPING = {
2026-02-20T22:09:13.7845156Z      # UserRole - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7845631Z      ("UserRole", "padawan"): "PADAWAN",
2026-02-20T22:09:13.7846106Z      ("UserRole", "maitre"): "MAITRE",
2026-02-20T22:09:13.7846526Z      ("UserRole", "gardien"): "GARDIEN",
2026-02-20T22:09:13.7846987Z      ("UserRole", "archiviste"): "ARCHIVISTE",
2026-02-20T22:09:13.7847864Z      # Note: Le rôle ADMIN a été supprimé - ARCHIVISTE est maintenant le rôle admin suprême
2026-02-20T22:09:13.7848544Z -    
2026-02-20T22:09:13.7848891Z -    # ExerciseType - Valeurs PostgreSQL exactes  
2026-02-20T22:09:13.7849448Z +    # ExerciseType - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7849956Z      ("ExerciseType", "addition"): "ADDITION",
2026-02-20T22:09:13.7850468Z      ("ExerciseType", "soustraction"): "SOUSTRACTION",
2026-02-20T22:09:13.7851061Z      ("ExerciseType", "multiplication"): "MULTIPLICATION",
2026-02-20T22:09:13.7851623Z      ("ExerciseType", "division"): "DIVISION",
2026-02-20T22:09:13.7852084Z      ("ExerciseType", "mixed"): "MIXED",
2026-02-20T22:09:13.7852476Z -    
2026-02-20T22:09:13.7852821Z      # DifficultyLevel - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7853553Z      ("DifficultyLevel", "initie"): "INITIE",
2026-02-20T22:09:13.7854051Z -    ("DifficultyLevel", "padawan"): "PADAWAN", 
2026-02-20T22:09:13.7854578Z +    ("DifficultyLevel", "padawan"): "PADAWAN",
2026-02-20T22:09:13.7855075Z      ("DifficultyLevel", "chevalier"): "CHEVALIER",
2026-02-20T22:09:13.7855583Z      ("DifficultyLevel", "maitre"): "MAITRE",
2026-02-20T22:09:13.7856006Z -    
2026-02-20T22:09:13.7856319Z      # LogicChallengeType - Valeurs PostgreSQL exactes
2026-02-20T22:09:13.7857161Z      ("LogicChallengeType", "sequence"): "SEQUENCE",
2026-02-20T22:09:13.7857697Z      ("LogicChallengeType", "pattern"): "PATTERN",
2026-02-20T22:09:13.7858228Z      ("LogicChallengeType", "visual"): "VISUAL",
2026-02-20T22:09:13.7858931Z      ("LogicChallengeType", "puzzle"): "PUZZLE",
2026-02-20T22:09:13.7859399Z @@ -67,95 +67,97 @@
2026-02-20T22:09:13.7859810Z      ("LogicChallengeType", "probability"): "PROBABILITY",
2026-02-20T22:09:13.7860364Z      ("LogicChallengeType", "graph"): "GRAPH",
2026-02-20T22:09:13.7923725Z      ("LogicChallengeType", "coding"): "CODING",
2026-02-20T22:09:13.7924282Z      ("LogicChallengeType", "chess"): "CHESS",
2026-02-20T22:09:13.7924795Z      ("LogicChallengeType", "custom"): "CUSTOM",
2026-02-20T22:09:13.7925228Z -    
2026-02-20T22:09:13.7925617Z      # AgeGroup - Mapping complet Python vers PostgreSQL
2026-02-20T22:09:13.7926256Z -    ("AgeGroup", "enfant"): "GROUP_10_12",       # enfant => 10-12
2026-02-20T22:09:13.7926975Z -    ("AgeGroup", "adolescent"): "GROUP_13_15",   # adolescent => 13-15
2026-02-20T22:09:13.7927674Z -    ("AgeGroup", "adulte"): "ALL_AGES",          # adulte => tous ages
2026-02-20T22:09:13.7928348Z -    ("AgeGroup", "age_9_12"): "GROUP_10_12",     # 9-12 => 10-12
2026-02-20T22:09:13.7928998Z -    ("AgeGroup", "age_12_13"): "GROUP_13_15",    # 12-13 => 13-15
2026-02-20T22:09:13.7929614Z +    ("AgeGroup", "enfant"): "GROUP_10_12",  # enfant => 10-12
2026-02-20T22:09:13.7930277Z +    ("AgeGroup", "adolescent"): "GROUP_13_15",  # adolescent => 13-15
2026-02-20T22:09:13.7930939Z +    ("AgeGroup", "adulte"): "ALL_AGES",  # adulte => tous ages
2026-02-20T22:09:13.7931543Z +    ("AgeGroup", "age_9_12"): "GROUP_10_12",  # 9-12 => 10-12
2026-02-20T22:09:13.7932128Z +    ("AgeGroup", "age_12_13"): "GROUP_13_15",  # 12-13 => 13-15
2026-02-20T22:09:13.7932736Z      ("AgeGroup", "age_13_plus"): "GROUP_13_15",  # 13+ => 13-15
2026-02-20T22:09:13.7933530Z -    ("AgeGroup", "9-12"): "GROUP_10_12",         # 9-12 => 10-12
2026-02-20T22:09:13.7934163Z -    ("AgeGroup", "12-13"): "GROUP_13_15",        # 12-13 => 13-15
2026-02-20T22:09:13.7935053Z -    ("AgeGroup", "13+"): "GROUP_13_15",          # 13+ => 13-15 (AJOUTÉ)
2026-02-20T22:09:13.7935687Z +    ("AgeGroup", "9-12"): "GROUP_10_12",  # 9-12 => 10-12
2026-02-20T22:09:13.7936262Z +    ("AgeGroup", "12-13"): "GROUP_13_15",  # 12-13 => 13-15
2026-02-20T22:09:13.7936964Z +    ("AgeGroup", "13+"): "GROUP_13_15",  # 13+ => 13-15 (AJOUTÉ)
2026-02-20T22:09:13.7937601Z      ("AgeGroup", "group_10_12"): "GROUP_10_12",  # exact match
2026-02-20T22:09:13.7938218Z      ("AgeGroup", "group_13_15"): "GROUP_13_15",  # exact match
2026-02-20T22:09:13.7938835Z -    ("AgeGroup", "all_ages"): "ALL_AGES",        # exact match
2026-02-20T22:09:13.7939434Z +    ("AgeGroup", "all_ages"): "ALL_AGES",  # exact match
2026-02-20T22:09:13.7940019Z      # Anciennes valeurs pour compatibilité
2026-02-20T22:09:13.7940488Z      ("AgeGroup", "10-12"): "GROUP_10_12",
2026-02-20T22:09:13.7940911Z      ("AgeGroup", "13-15"): "GROUP_13_15",
2026-02-20T22:09:13.7941313Z      ("AgeGroup", "all"): "ALL_AGES",
2026-02-20T22:09:13.7941691Z  }
2026-02-20T22:09:13.7941937Z  
2026-02-20T22:09:13.7942178Z +
2026-02-20T22:09:13.7942646Z  def get_enum_value(enum_class, value, db: Optional[Session] = None) -> str:
2026-02-20T22:09:13.7943459Z      """
2026-02-20T22:09:13.7944166Z      Récupère la valeur PostgreSQL correspondant à une valeur d'énumération Python.
2026-02-20T22:09:13.7944847Z -    
2026-02-20T22:09:13.7945107Z +
2026-02-20T22:09:13.7945364Z      Args:
2026-02-20T22:09:13.7945928Z          enum_class: Classe d'énumération (ex: UserRole, ExerciseType)
2026-02-20T22:09:13.7946972Z          value: Valeur de l'énumération (peut être une valeur de l'enum ou sa représentation string)
2026-02-20T22:09:13.7948063Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7948687Z -        
2026-02-20T22:09:13.7948957Z +
2026-02-20T22:09:13.7949568Z      Returns:
2026-02-20T22:09:13.7950007Z          Valeur adaptée pour PostgreSQL
2026-02-20T22:09:13.7950425Z      """
2026-02-20T22:09:13.7950746Z      # Si la valeur est None, retourner None
2026-02-20T22:09:13.7951180Z      if value is None:
2026-02-20T22:09:13.7951519Z          return None
2026-02-20T22:09:13.7952027Z -    
2026-02-20T22:09:13.7952310Z +
2026-02-20T22:09:13.7952742Z      # Obtenir le nom de la classe d'énumération
2026-02-20T22:09:13.7953415Z      enum_name = enum_class.__name__
2026-02-20T22:09:13.7953815Z -    
2026-02-20T22:09:13.7954062Z +
2026-02-20T22:09:13.7954376Z      # Si c'est un objet enum, obtenir sa valeur
2026-02-20T22:09:13.7954972Z -    enum_value = value.value if hasattr(value, 'value') else value
2026-02-20T22:09:13.7955529Z -    
2026-02-20T22:09:13.7955916Z +    enum_value = value.value if hasattr(value, "value") else value
2026-02-20T22:09:13.7956444Z +
2026-02-20T22:09:13.7956709Z      # Chercher dans le mapping
2026-02-20T22:09:13.7957120Z      mapping_key = (enum_name, enum_value)
2026-02-20T22:09:13.7957584Z      if mapping_key in ENUM_MAPPING:
2026-02-20T22:09:13.7958001Z          return ENUM_MAPPING[mapping_key]
2026-02-20T22:09:13.7958403Z -    
2026-02-20T22:09:13.7958649Z +
2026-02-20T22:09:13.7959349Z      # Si pas trouvé, utiliser la valeur telle quelle mais en majuscules pour PostgreSQL
2026-02-20T22:09:13.7960047Z      return str(enum_value).upper()
2026-02-20T22:09:13.7960426Z  
2026-02-20T22:09:13.7960655Z +
2026-02-20T22:09:13.7961166Z  def adapt_enum_for_db(enum_name: str, value: str, db: Optional[Session] = None) -> str:
2026-02-20T22:09:13.7961827Z      """
2026-02-20T22:09:13.7962336Z      Adapte une valeur d'énumération textuelle pour PostgreSQL.
2026-02-20T22:09:13.7962862Z -    
2026-02-20T22:09:13.7963310Z +
2026-02-20T22:09:13.7963557Z      Args:
2026-02-20T22:09:13.7964174Z          enum_name: Nom de la classe d'énumération (ex: 'UserRole', 'ExerciseType')
2026-02-20T22:09:13.7964955Z          value: Valeur textuelle de l'énumération
2026-02-20T22:09:13.7965759Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7966380Z -        
2026-02-20T22:09:13.7966634Z +
2026-02-20T22:09:13.7966879Z      Returns:
2026-02-20T22:09:13.7967296Z          Valeur adaptée pour PostgreSQL
2026-02-20T22:09:13.7967700Z      """
2026-02-20T22:09:13.7967999Z      # Chercher dans le mapping
2026-02-20T22:09:13.7968388Z      mapping_key = (enum_name, value)
2026-02-20T22:09:13.7968830Z      if mapping_key in ENUM_MAPPING:
2026-02-20T22:09:13.7969259Z          return ENUM_MAPPING[mapping_key]
2026-02-20T22:09:13.7969681Z -    
2026-02-20T22:09:13.7969925Z +
2026-02-20T22:09:13.7970457Z      # Si pas trouvé dans le mapping, utiliser la valeur en majuscules
2026-02-20T22:09:13.7971029Z      return value.upper()
2026-02-20T22:09:13.7971363Z  
2026-02-20T22:09:13.7971610Z +
2026-02-20T22:09:13.7972043Z  def get_all_enum_values(db: Optional[Session] = None) -> Dict[str, Any]:
2026-02-20T22:09:13.7972630Z      """
2026-02-20T22:09:13.7973326Z      Fournit toutes les valeurs d'énumération pour PostgreSQL.
2026-02-20T22:09:13.7973905Z      Utile pour les tests et fixtures.
2026-02-20T22:09:13.7974288Z -    
2026-02-20T22:09:13.7974539Z +
2026-02-20T22:09:13.7974776Z      Args:
2026-02-20T22:09:13.7975363Z          db: Session de base de données (non utilisée, gardée pour compatibilité)
2026-02-20T22:09:13.7975969Z -        
2026-02-20T22:09:13.7976247Z +
2026-02-20T22:09:13.7976496Z      Returns:
2026-02-20T22:09:13.7977140Z          Dictionnaire contenant toutes les valeurs d'énumération adaptées
2026-02-20T22:09:13.7977767Z      """
2026-02-20T22:09:13.7978225Z      from app.models.exercise import DifficultyLevel, ExerciseType
2026-02-20T22:09:13.7979032Z      from app.models.logic_challenge import AgeGroup, LogicChallengeType
2026-02-20T22:09:13.7979703Z      from app.models.user import UserRole
2026-02-20T22:09:13.7980136Z -    
2026-02-20T22:09:13.7980393Z +
2026-02-20T22:09:13.7980653Z      return {
2026-02-20T22:09:13.7981260Z          "engine": "postgresql",
2026-02-20T22:09:13.7981671Z          "user_roles": {
2026-02-20T22:09:13.7982148Z              "padawan": get_enum_value(UserRole, UserRole.PADAWAN),
2026-02-20T22:09:13.7982803Z              "maitre": get_enum_value(UserRole, UserRole.MAITRE),
2026-02-20T22:09:13.7983770Z @@ -170,31 +172,37 @@
2026-02-20T22:09:13.7984314Z              "division": get_enum_value(ExerciseType, ExerciseType.DIVISION),
2026-02-20T22:09:13.7985145Z              "fractions": get_enum_value(ExerciseType, ExerciseType.FRACTIONS),
2026-02-20T22:09:13.7985958Z              "geometrie": get_enum_value(ExerciseType, ExerciseType.GEOMETRIE),
2026-02-20T22:09:13.7986722Z              "texte": get_enum_value(ExerciseType, ExerciseType.TEXTE),
2026-02-20T22:09:13.7987434Z              "mixte": get_enum_value(ExerciseType, ExerciseType.MIXTE),
2026-02-20T22:09:13.7988157Z -            "divers": get_enum_value(ExerciseType, ExerciseType.DIVERS)
2026-02-20T22:09:13.7988899Z +            "divers": get_enum_value(ExerciseType, ExerciseType.DIVERS),
2026-02-20T22:09:13.7989471Z          },
2026-02-20T22:09:13.7989791Z          "difficulty_levels": {
2026-02-20T22:09:13.7990355Z              "initie": get_enum_value(DifficultyLevel, DifficultyLevel.INITIE),
2026-02-20T22:09:13.7991186Z              "padawan": get_enum_value(DifficultyLevel, DifficultyLevel.PADAWAN),
2026-02-20T22:09:13.7992066Z              "chevalier": get_enum_value(DifficultyLevel, DifficultyLevel.CHEVALIER),
2026-02-20T22:09:13.7992930Z -            "maitre": get_enum_value(DifficultyLevel, DifficultyLevel.MAITRE)
2026-02-20T22:09:13.7993951Z +            "maitre": get_enum_value(DifficultyLevel, DifficultyLevel.MAITRE),
2026-02-20T22:09:13.7994551Z          },
2026-02-20T22:09:13.7994863Z          "challenge_types": {
2026-02-20T22:09:13.7995510Z              "sequence": get_enum_value(LogicChallengeType, LogicChallengeType.SEQUENCE),
2026-02-20T22:09:13.7996457Z              "puzzle": get_enum_value(LogicChallengeType, LogicChallengeType.PUZZLE),
2026-02-20T22:09:13.7997395Z              "pattern": get_enum_value(LogicChallengeType, LogicChallengeType.PATTERN),
2026-02-20T22:09:13.7998310Z              "visual": get_enum_value(LogicChallengeType, LogicChallengeType.VISUAL),
2026-02-20T22:09:13.7999221Z              "riddle": get_enum_value(LogicChallengeType, LogicChallengeType.PUZZLE),
2026-02-20T22:09:13.8000175Z -            "deduction": get_enum_value(LogicChallengeType, LogicChallengeType.DEDUCTION),
2026-02-20T22:09:13.8001413Z -            "spatial": get_enum_value(LogicChallengeType, LogicChallengeType.VISUAL),  # SPATIAL fusionné
2026-02-20T22:09:13.8002575Z -            "probability": get_enum_value(LogicChallengeType, LogicChallengeType.PROBABILITY),
2026-02-20T22:09:13.8003576Z +            "deduction": get_enum_value(
2026-02-20T22:09:13.8004160Z +                LogicChallengeType, LogicChallengeType.DEDUCTION
2026-02-20T22:09:13.8004704Z +            ),
2026-02-20T22:09:13.8005045Z +            "spatial": get_enum_value(
2026-02-20T22:09:13.8005562Z +                LogicChallengeType, LogicChallengeType.VISUAL
2026-02-20T22:09:13.8006151Z +            ),  # SPATIAL fusionné
2026-02-20T22:09:13.8006575Z +            "probability": get_enum_value(
2026-02-20T22:09:13.8007143Z +                LogicChallengeType, LogicChallengeType.PROBABILITY
2026-02-20T22:09:13.8007703Z +            ),
2026-02-20T22:09:13.8008223Z              "graph": get_enum_value(LogicChallengeType, LogicChallengeType.GRAPH),
2026-02-20T22:09:13.8009112Z              "coding": get_enum_value(LogicChallengeType, LogicChallengeType.CODING),
2026-02-20T22:09:13.8010060Z              "chess": get_enum_value(LogicChallengeType, LogicChallengeType.CHESS),
2026-02-20T22:09:13.8010917Z -            "custom": get_enum_value(LogicChallengeType, LogicChallengeType.CUSTOM)
2026-02-20T22:09:13.8011828Z +            "custom": get_enum_value(LogicChallengeType, LogicChallengeType.CUSTOM),
2026-02-20T22:09:13.8012483Z          },
2026-02-20T22:09:13.8012792Z          "age_groups": {
2026-02-20T22:09:13.8013729Z              # Seules les 3 valeurs existantes en PostgreSQL
2026-02-20T22:09:13.8014424Z              "group_10_12": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8015185Z              "group_13_15": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8016017Z @@ -213,48 +221,46 @@
2026-02-20T22:09:13.8016507Z              # Legacy values (mappent vers les valeurs existantes)
2026-02-20T22:09:13.8017200Z              "enfant": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8017948Z              "adolescent": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8018670Z              "9-12": get_enum_value(AgeGroup, AgeGroup.GROUP_10_12),
2026-02-20T22:09:13.8019334Z              "12-13": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8019985Z -            "13+": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15)
2026-02-20T22:09:13.8020505Z -        }
2026-02-20T22:09:13.8020781Z -    } 
2026-02-20T22:09:13.8021198Z +            "13+": get_enum_value(AgeGroup, AgeGroup.GROUP_13_15),
2026-02-20T22:09:13.8021724Z +        },
2026-02-20T22:09:13.8021995Z +    }
2026-02-20T22:09:13.8022260Z +
2026-02-20T22:09:13.8022506Z  
2026-02-20T22:09:13.8022946Z  def get_python_enum_value(enum_class, db_value: str) -> str:
2026-02-20T22:09:13.8023676Z      """
2026-02-20T22:09:13.8024258Z      Convertit une valeur PostgreSQL vers la valeur Python correspondante pour Pydantic.
2026-02-20T22:09:13.8024974Z -    
2026-02-20T22:09:13.8025242Z +
2026-02-20T22:09:13.8025497Z      Args:
2026-02-20T22:09:13.8026162Z          enum_class: La classe d'énumération Python (ex: UserRole, AgeGroup)
2026-02-20T22:09:13.8027205Z          db_value: La valeur stockée dans PostgreSQL (ex: "PADAWAN", "GROUP_10_12")
2026-02-20T22:09:13.8027850Z -    
2026-02-20T22:09:13.8028123Z +
2026-02-20T22:09:13.8028380Z      Returns:
2026-02-20T22:09:13.8028820Z          La valeur Python correspondante (ex: "padawan", "10-12")
2026-02-20T22:09:13.8029362Z      """
2026-02-20T22:09:13.8029674Z      enum_name = enum_class.__name__
2026-02-20T22:09:13.8030078Z -    
2026-02-20T22:09:13.8030353Z +
2026-02-20T22:09:13.8030679Z      # Mapping inverse PostgreSQL -> Python
2026-02-20T22:09:13.8031166Z      reverse_mapping = {
2026-02-20T22:09:13.8031537Z          # UserRole
2026-02-20T22:09:13.8031885Z          ("UserRole", "PADAWAN"): "padawan",
2026-02-20T22:09:13.8032358Z -        ("UserRole", "MAITRE"): "maitre", 
2026-02-20T22:09:13.8032819Z +        ("UserRole", "MAITRE"): "maitre",
2026-02-20T22:09:13.8033488Z          ("UserRole", "GARDIEN"): "gardien",
2026-02-20T22:09:13.8033977Z          ("UserRole", "ARCHIVISTE"): "archiviste",
2026-02-20T22:09:13.8034448Z -        
2026-02-20T22:09:13.8034729Z          # ExerciseType
2026-02-20T22:09:13.8035131Z          ("ExerciseType", "ADDITION"): "addition",
2026-02-20T22:09:13.8035691Z          ("ExerciseType", "SOUSTRACTION"): "soustraction",
2026-02-20T22:09:13.8036302Z          ("ExerciseType", "MULTIPLICATION"): "multiplication",
2026-02-20T22:09:13.8036907Z          ("ExerciseType", "DIVISION"): "division",
2026-02-20T22:09:13.8037407Z          ("ExerciseType", "MIXED"): "mixed",
2026-02-20T22:09:13.8037838Z -        
2026-02-20T22:09:13.8038152Z          # DifficultyLevel
2026-02-20T22:09:13.8038581Z          ("DifficultyLevel", "INITIE"): "initie",
2026-02-20T22:09:13.8039104Z          ("DifficultyLevel", "PADAWAN"): "padawan",
2026-02-20T22:09:13.8039684Z -        ("DifficultyLevel", "CHEVALIER"): "chevalier", 
2026-02-20T22:09:13.8040291Z +        ("DifficultyLevel", "CHEVALIER"): "chevalier",
2026-02-20T22:09:13.8040837Z          ("DifficultyLevel", "MAITRE"): "maitre",
2026-02-20T22:09:13.8041294Z -        
2026-02-20T22:09:13.8041603Z          # LogicChallengeType
2026-02-20T22:09:13.8042083Z          ("LogicChallengeType", "SEQUENCE"): "sequence",
2026-02-20T22:09:13.8042659Z          ("LogicChallengeType", "PATTERN"): "pattern",
2026-02-20T22:09:13.8043455Z          ("LogicChallengeType", "VISUAL"): "visual",
2026-02-20T22:09:13.8044336Z          ("LogicChallengeType", "PUZZLE"): "puzzle",
2026-02-20T22:09:13.8044830Z @@ -264,24 +270,23 @@
2026-02-20T22:09:13.8045276Z          ("LogicChallengeType", "PROBABILITY"): "probability",
2026-02-20T22:09:13.8046085Z          ("LogicChallengeType", "GRAPH"): "graph",
2026-02-20T22:09:13.8046618Z          ("LogicChallengeType", "CODING"): "coding",
2026-02-20T22:09:13.8047119Z          ("LogicChallengeType", "CHESS"): "chess",
2026-02-20T22:09:13.8047658Z          ("LogicChallengeType", "CUSTOM"): "custom",
2026-02-20T22:09:13.8048117Z -        
2026-02-20T22:09:13.8048415Z          # AgeGroup
2026-02-20T22:09:13.8048783Z          ("AgeGroup", "GROUP_10_12"): "10-12",
2026-02-20T22:09:13.8049251Z          ("AgeGroup", "GROUP_13_15"): "13-15",
2026-02-20T22:09:13.8049714Z          ("AgeGroup", "ALL_AGES"): "all",
2026-02-20T22:09:13.8050129Z      }
2026-02-20T22:09:13.8050408Z -    
2026-02-20T22:09:13.8050674Z +
2026-02-20T22:09:13.8050988Z      # Chercher dans le mapping inverse
2026-02-20T22:09:13.8051471Z      key = (enum_name, db_value)
2026-02-20T22:09:13.8051888Z      if key in reverse_mapping:
2026-02-20T22:09:13.8052301Z          return reverse_mapping[key]
2026-02-20T22:09:13.8052708Z -    
2026-02-20T22:09:13.8053154Z +
2026-02-20T22:09:13.8053717Z      # Si pas trouvé, essayer de deviner selon les patterns
2026-02-20T22:09:13.8054293Z      if db_value.startswith("GROUP_"):
2026-02-20T22:09:13.8054741Z          # GROUP_10_12 -> 10-12
2026-02-20T22:09:13.8055258Z          return db_value.replace("GROUP_", "").replace("_", "-")
2026-02-20T22:09:13.8055783Z -    
2026-02-20T22:09:13.8056052Z +
2026-02-20T22:09:13.8056473Z      # Par défaut, retourner en minuscules
2026-02-20T22:09:13.8056939Z -    return db_value.lower() 
2026-02-20T22:09:13.8057339Z \ No newline at end of file
2026-02-20T22:09:13.8057721Z +    return db_value.lower()
2026-02-20T22:09:13.8058604Z would reformat /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py
2026-02-20T22:09:13.8059893Z --- /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.8061312Z +++ /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py	2026-02-20 22:09:13.798723+00:00
2026-02-20T22:09:13.8062240Z @@ -13,13 +13,14 @@
2026-02-20T22:09:13.8062681Z  from app.models.recommendation import Recommendation
2026-02-20T22:09:13.8063454Z  from app.models.user import User
2026-02-20T22:09:13.8063849Z  
2026-02-20T22:09:13.8064132Z  logger = get_logger(__name__)
2026-02-20T22:09:13.8064488Z  
2026-02-20T22:09:13.8064739Z +
2026-02-20T22:09:13.8065024Z  class RecommendationService:
2026-02-20T22:09:13.8065944Z      """Service analysant les performances et générant des recommandations personnalisées"""
2026-02-20T22:09:13.8066707Z -    
2026-02-20T22:09:13.8066991Z +
2026-02-20T22:09:13.8067251Z      @staticmethod
2026-02-20T22:09:13.8067640Z      def generate_recommendations(db, user_id):
2026-02-20T22:09:13.8068529Z          """Génère des recommandations pour un utilisateur basé sur ses performances
2026-02-20T22:09:13.8069203Z  
2026-02-20T22:09:13.8069486Z          Args:
2026-02-20T22:09:13.8069784Z @@ -31,406 +32,508 @@
2026-02-20T22:09:13.8070105Z          """
2026-02-20T22:09:13.8070384Z          try:
2026-02-20T22:09:13.8070880Z              # Récupérer les données utilisateur
2026-02-20T22:09:13.8071552Z              user_exists = db.query(exists().where(User.id == user_id)).scalar()
2026-02-20T22:09:13.8072187Z              if not user_exists:
2026-02-20T22:09:13.8073433Z -                logger.warning(f"Tentative de génération de recommandations pour un utilisateur inexistant: {user_id}")
2026-02-20T22:09:13.8074356Z +                logger.warning(
2026-02-20T22:09:13.8075276Z +                    f"Tentative de génération de recommandations pour un utilisateur inexistant: {user_id}"
2026-02-20T22:09:13.8076052Z +                )
2026-02-20T22:09:13.8076386Z                  return []
2026-02-20T22:09:13.8077031Z -            
2026-02-20T22:09:13.8077330Z +
2026-02-20T22:09:13.8077745Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:13.8078307Z              if not user:
2026-02-20T22:09:13.8078932Z                  logger.error(f"Utilisateur {user_id} non trouvé")
2026-02-20T22:09:13.8079702Z                  return []
2026-02-20T22:09:13.8080071Z  
2026-02-20T22:09:13.8080696Z              # Récupérer les stats récentes (30 derniers jours) pour mieux cibler
2026-02-20T22:09:13.8081446Z              from app.services.user_service import UserService
2026-02-20T22:09:13.8081959Z +
2026-02-20T22:09:13.8082471Z              recent_stats = UserService.get_user_stats(db, user_id, time_range="30")
2026-02-20T22:09:13.8083532Z              performance_by_type = recent_stats.get("by_exercise_type", {})
2026-02-20T22:09:13.8084135Z -            
2026-02-20T22:09:13.8084428Z +
2026-02-20T22:09:13.8084890Z              # Analyser les performances récentes
2026-02-20T22:09:13.8085670Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.8086464Z -            recent_attempts = db.query(Attempt).filter(
2026-02-20T22:09:13.8087002Z -                Attempt.user_id == user_id,
2026-02-20T22:09:13.8087686Z -                Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=30)
2026-02-20T22:09:13.8088468Z -            ).order_by(Attempt.created_at.desc()).limit(50).all()
2026-02-20T22:09:13.8089000Z -            
2026-02-20T22:09:13.8089316Z +            progress_records = (
2026-02-20T22:09:13.8089870Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:13.8090434Z +            )
2026-02-20T22:09:13.8090745Z +            recent_attempts = (
2026-02-20T22:09:13.8091103Z +                db.query(Attempt)
2026-02-20T22:09:13.8091465Z +                .filter(
2026-02-20T22:09:13.8091825Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:13.8092281Z +                    Attempt.created_at
2026-02-20T22:09:13.8092793Z +                    > datetime.now(timezone.utc) - timedelta(days=30),
2026-02-20T22:09:13.8093506Z +                )
2026-02-20T22:09:13.8093876Z +                .order_by(Attempt.created_at.desc())
2026-02-20T22:09:13.8094354Z +                .limit(50)
2026-02-20T22:09:13.8094712Z +                .all()
2026-02-20T22:09:13.8095022Z +            )
2026-02-20T22:09:13.8095304Z +
2026-02-20T22:09:13.8096091Z              # Récupérer les exercices complétés dans les 7 derniers jours pour éviter les doublons
2026-02-20T22:09:13.8096903Z              recently_completed_exercise_ids = set()
2026-02-20T22:09:13.8097503Z -            recent_completed_attempts = db.query(Attempt).filter(
2026-02-20T22:09:13.8098086Z -                Attempt.user_id == user_id,
2026-02-20T22:09:13.8098551Z -                Attempt.is_correct == True,
2026-02-20T22:09:13.8099187Z -                Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=7)
2026-02-20T22:09:13.8099844Z -            ).all()
2026-02-20T22:09:13.8100181Z +            recent_completed_attempts = (
2026-02-20T22:09:13.8100624Z +                db.query(Attempt)
2026-02-20T22:09:13.8101005Z +                .filter(
2026-02-20T22:09:13.8101390Z +                    Attempt.user_id == user_id,
2026-02-20T22:09:13.8101889Z +                    Attempt.is_correct == True,
2026-02-20T22:09:13.8102558Z +                    Attempt.created_at > datetime.now(timezone.utc) - timedelta(days=7),
2026-02-20T22:09:13.8103399Z +                )
2026-02-20T22:09:13.8103707Z +                .all()
2026-02-20T22:09:13.8104028Z +            )
2026-02-20T22:09:13.8104387Z              for attempt in recent_completed_attempts:
2026-02-20T22:09:13.8104899Z                  if attempt.exercise_id:
2026-02-20T22:09:13.8105476Z                      recently_completed_exercise_ids.add(attempt.exercise_id)
2026-02-20T22:09:13.8106041Z -            
2026-02-20T22:09:13.8106321Z +
2026-02-20T22:09:13.8107138Z              # Supprimer les anciennes recommandations non complétées
2026-02-20T22:09:13.8107744Z              db.query(Recommendation).filter(
2026-02-20T22:09:13.8108225Z -                Recommendation.user_id == user_id,
2026-02-20T22:09:13.8108754Z -                Recommendation.is_completed == False
2026-02-20T22:09:13.8109787Z +                Recommendation.user_id == user_id, Recommendation.is_completed == False
2026-02-20T22:09:13.8110488Z              ).delete()
2026-02-20T22:09:13.8110804Z -            
2026-02-20T22:09:13.8111079Z +
2026-02-20T22:09:13.8111503Z              # Générer de nouvelles recommandations
2026-02-20T22:09:13.8111976Z              recommendations = []
2026-02-20T22:09:13.8112351Z -            
2026-02-20T22:09:13.8112621Z +
2026-02-20T22:09:13.8113599Z              # 1. Recommandations basées sur les domaines à améliorer (utilisant les stats récentes)
2026-02-20T22:09:13.8114605Z              # Prioriser les types avec faible taux de réussite récent
2026-02-20T22:09:13.8115329Z              for ex_type_key, type_stats in performance_by_type.items():
2026-02-20T22:09:13.8116227Z                  # Normaliser le type d'exercice (peut être en minuscules depuis SQL)
2026-02-20T22:09:13.8116918Z                  ex_type = str(ex_type_key).lower()
2026-02-20T22:09:13.8117493Z                  success_rate = type_stats.get("success_rate", 0)
2026-02-20T22:09:13.8118040Z                  total = type_stats.get("total", 0)
2026-02-20T22:09:13.8118481Z -                
2026-02-20T22:09:13.8118765Z +
2026-02-20T22:09:13.8119522Z                  # Seulement recommander si au moins 3 tentatives récentes pour avoir des données fiables
2026-02-20T22:09:13.8120323Z                  if total >= 3 and success_rate < 70:
2026-02-20T22:09:13.8121017Z                      # Déterminer la priorité selon le taux de réussite
2026-02-20T22:09:13.8121582Z                      if success_rate < 50:
2026-02-20T22:09:13.8122027Z                          priority = 9  # Urgent
2026-02-20T22:09:13.8123267Z                          reason = f"Votre taux de réussite en {ex_type} est de {success_rate}%. Continuons à progresser !"
2026-02-20T22:09:13.8124080Z                      else:
2026-02-20T22:09:13.8124467Z                          priority = 8  # Important
2026-02-20T22:09:13.8125394Z                          reason = f"Pour améliorer votre taux de réussite en {ex_type} ({success_rate}%)"
2026-02-20T22:09:13.8126105Z -                    
2026-02-20T22:09:13.8126428Z +
2026-02-20T22:09:13.8126931Z                      # Trouver le niveau de difficulté le plus approprié
2026-02-20T22:09:13.8127885Z                      # Utiliser le niveau le plus pratiqué récemment ou le niveau actuel du Progress
2026-02-20T22:09:13.8128621Z                      target_difficulty = None
2026-02-20T22:09:13.8129126Z                      for progress in progress_records:
2026-02-20T22:09:13.8129702Z                          if str(progress.exercise_type).lower() == ex_type:
2026-02-20T22:09:13.8130333Z                              target_difficulty = progress.difficulty
2026-02-20T22:09:13.8130864Z                              break
2026-02-20T22:09:13.8131227Z -                    
2026-02-20T22:09:13.8131529Z +
2026-02-20T22:09:13.8131815Z                      if not target_difficulty:
2026-02-20T22:09:13.8132462Z                          target_difficulty = "INITIE"  # Par défaut
2026-02-20T22:09:13.8132937Z -                    
2026-02-20T22:09:13.8133423Z +
2026-02-20T22:09:13.8134108Z                      # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8134907Z                      valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8135557Z                      valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8136107Z -                    
2026-02-20T22:09:13.8136404Z +
2026-02-20T22:09:13.8137000Z                      # Trouver des exercices appropriés pour améliorer cette compétence
2026-02-20T22:09:13.8137831Z                      # Utiliser func.lower pour comparer sans tenir compte de la casse
2026-02-20T22:09:13.8138786Z                      exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8139373Z                          func.lower(Exercise.exercise_type) == ex_type,
2026-02-20T22:09:13.8140110Z                          Exercise.difficulty == target_difficulty,
2026-02-20T22:09:13.8140675Z                          Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8141273Z                          Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8141845Z                          Exercise.is_archived == False,
2026-02-20T22:09:13.8142346Z -                        Exercise.is_active == True
2026-02-20T22:09:13.8142797Z -                    )
2026-02-20T22:09:13.8143340Z -                    
2026-02-20T22:09:13.8143705Z +                        Exercise.is_active == True,
2026-02-20T22:09:13.8144153Z +                    )
2026-02-20T22:09:13.8144461Z +
2026-02-20T22:09:13.8144940Z                      # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8145522Z                      if recently_completed_exercise_ids:
2026-02-20T22:09:13.8146403Z -                        exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8147259Z -                    
2026-02-20T22:09:13.8147655Z +                        exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8148310Z +                            ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8148891Z +                        )
2026-02-20T22:09:13.8149209Z +
2026-02-20T22:09:13.8149672Z                      exercises = exercise_query.order_by(func.random()).limit(2).all()
2026-02-20T22:09:13.8150286Z -                    
2026-02-20T22:09:13.8150590Z +
2026-02-20T22:09:13.8150857Z                      for ex in exercises:
2026-02-20T22:09:13.8151543Z                          # Vérifier si l'utilisateur a déjà fait cet exercice
2026-02-20T22:09:13.8152210Z -                        existing_attempt = db.query(Attempt).filter(
2026-02-20T22:09:13.8152789Z -                            Attempt.user_id == user_id,
2026-02-20T22:09:13.8153489Z -                            Attempt.exercise_id == ex.id
2026-02-20T22:09:13.8153964Z -                        ).first()
2026-02-20T22:09:13.8154341Z -                        
2026-02-20T22:09:13.8154701Z +                        existing_attempt = (
2026-02-20T22:09:13.8155161Z +                            db.query(Attempt)
2026-02-20T22:09:13.8155587Z +                            .filter(
2026-02-20T22:09:13.8156150Z +                                Attempt.user_id == user_id, Attempt.exercise_id == ex.id
2026-02-20T22:09:13.8156749Z +                            )
2026-02-20T22:09:13.8157105Z +                            .first()
2026-02-20T22:09:13.8157485Z +                        )
2026-02-20T22:09:13.8157797Z +
2026-02-20T22:09:13.8158104Z                          if not existing_attempt:
2026-02-20T22:09:13.8158644Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8159187Z -                                user_id=user_id,
2026-02-20T22:09:13.8159684Z -                                exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8160238Z -                                difficulty=ex.difficulty,
2026-02-20T22:09:13.8160750Z -                                exercise_id=ex.id,
2026-02-20T22:09:13.8161221Z -                                priority=priority,
2026-02-20T22:09:13.8161688Z -                                reason=reason
2026-02-20T22:09:13.8162113Z -                            ))
2026-02-20T22:09:13.8162462Z -            
2026-02-20T22:09:13.8162790Z +                            recommendations.append(
2026-02-20T22:09:13.8163455Z +                                Recommendation(
2026-02-20T22:09:13.8163915Z +                                    user_id=user_id,
2026-02-20T22:09:13.8164436Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8165235Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8165752Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8166244Z +                                    priority=priority,
2026-02-20T22:09:13.8166896Z +                                    reason=reason,
2026-02-20T22:09:13.8167346Z +                                )
2026-02-20T22:09:13.8167718Z +                            )
2026-02-20T22:09:13.8168062Z +
2026-02-20T22:09:13.8168800Z              # 2. Recommandations pour monter en niveau (progression) - basé sur stats récentes
2026-02-20T22:09:13.8169681Z              for ex_type_key, type_stats in performance_by_type.items():
2026-02-20T22:09:13.8170292Z                  # Normaliser le type d'exercice
2026-02-20T22:09:13.8170771Z                  ex_type = str(ex_type_key).lower()
2026-02-20T22:09:13.8171327Z                  success_rate = type_stats.get("success_rate", 0)
2026-02-20T22:09:13.8171862Z                  total = type_stats.get("total", 0)
2026-02-20T22:09:13.8172313Z -                
2026-02-20T22:09:13.8172589Z +
2026-02-20T22:09:13.8173549Z                  # Si taux de réussite > 85% avec au moins 5 tentatives récentes, proposer niveau supérieur
2026-02-20T22:09:13.8174359Z                  if total >= 5 and success_rate > 85:
2026-02-20T22:09:13.8174903Z                      # Trouver le niveau actuel depuis Progress
2026-02-20T22:09:13.8175440Z                      current_difficulty = None
2026-02-20T22:09:13.8175930Z                      for progress in progress_records:
2026-02-20T22:09:13.8176508Z                          if str(progress.exercise_type).lower() == ex_type:
2026-02-20T22:09:13.8177136Z                              current_difficulty = progress.difficulty
2026-02-20T22:09:13.8177647Z                              break
2026-02-20T22:09:13.8178016Z -                    
2026-02-20T22:09:13.8178314Z +
2026-02-20T22:09:13.8178476Z                      if not current_difficulty:
2026-02-20T22:09:13.8178881Z                          continue  # Pas de niveau trouvé, passer au suivant
2026-02-20T22:09:13.8178998Z -                    
2026-02-20T22:09:13.8179103Z +
2026-02-20T22:09:13.8179432Z                      # Proposer des exercices du niveau supérieur
2026-02-20T22:09:13.8179885Z -                    next_difficulty = RecommendationService._get_next_difficulty(current_difficulty)
2026-02-20T22:09:13.8180179Z +                    next_difficulty = RecommendationService._get_next_difficulty(
2026-02-20T22:09:13.8180329Z +                        current_difficulty
2026-02-20T22:09:13.8180443Z +                    )
2026-02-20T22:09:13.8180580Z                      if next_difficulty:
2026-02-20T22:09:13.8181142Z                          # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8181372Z                          valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8181639Z                          valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8181770Z -                        
2026-02-20T22:09:13.8181882Z +
2026-02-20T22:09:13.8182082Z                          # Normaliser ex_type pour la comparaison
2026-02-20T22:09:13.8182256Z                          exercise_type_filter = ex_type
2026-02-20T22:09:13.8182442Z                          for enum_type in ExerciseType:
2026-02-20T22:09:13.8182644Z                              if enum_type.value.lower() == ex_type:
2026-02-20T22:09:13.8182856Z                                  exercise_type_filter = enum_type.value
2026-02-20T22:09:13.8183150Z                                  break
2026-02-20T22:09:13.8183276Z -                        
2026-02-20T22:09:13.8183380Z +
2026-02-20T22:09:13.8183586Z                          exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8183828Z                              func.lower(Exercise.exercise_type) == ex_type,
2026-02-20T22:09:13.8184032Z                              Exercise.difficulty == next_difficulty,
2026-02-20T22:09:13.8184445Z                              Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8184690Z                              Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8184873Z                              Exercise.is_archived == False,
2026-02-20T22:09:13.8185206Z -                            Exercise.is_active == True
2026-02-20T22:09:13.8185340Z -                        )
2026-02-20T22:09:13.8185459Z -                        
2026-02-20T22:09:13.8185636Z +                            Exercise.is_active == True,
2026-02-20T22:09:13.8185753Z +                        )
2026-02-20T22:09:13.8185867Z +
2026-02-20T22:09:13.8186210Z                          # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8186402Z                          if recently_completed_exercise_ids:
2026-02-20T22:09:13.8186951Z -                            exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8187084Z -                        
2026-02-20T22:09:13.8187413Z -                        exercises = exercise_query.order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8187523Z -                        
2026-02-20T22:09:13.8187718Z +                            exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8187986Z +                                ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8188101Z +                            )
2026-02-20T22:09:13.8188206Z +
2026-02-20T22:09:13.8188332Z +                        exercises = (
2026-02-20T22:09:13.8188592Z +                            exercise_query.order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8188718Z +                        )
2026-02-20T22:09:13.8188821Z +
2026-02-20T22:09:13.8188973Z                          for ex in exercises:
2026-02-20T22:09:13.8189187Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8189342Z -                                user_id=user_id,
2026-02-20T22:09:13.8189538Z -                                exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8189712Z -                                difficulty=ex.difficulty,
2026-02-20T22:09:13.8189877Z -                                exercise_id=ex.id,
2026-02-20T22:09:13.8190022Z -                                priority=7,
2026-02-20T22:09:13.8190909Z -                                reason=f"Excellent ! Vous avez {success_rate}% de réussite en {ex.exercise_type}. Essayons le niveau {next_difficulty} !"
2026-02-20T22:09:13.8191040Z -                            ))
2026-02-20T22:09:13.8191144Z -            
2026-02-20T22:09:13.8191318Z +                            recommendations.append(
2026-02-20T22:09:13.8191468Z +                                Recommendation(
2026-02-20T22:09:13.8191634Z +                                    user_id=user_id,
2026-02-20T22:09:13.8191830Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8192025Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8192188Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8192327Z +                                    priority=7,
2026-02-20T22:09:13.8193430Z +                                    reason=f"Excellent ! Vous avez {success_rate}% de réussite en {ex.exercise_type}. Essayons le niveau {next_difficulty} !",
2026-02-20T22:09:13.8193571Z +                                )
2026-02-20T22:09:13.8193691Z +                            )
2026-02-20T22:09:13.8193794Z +
2026-02-20T22:09:13.8194252Z              # 3. Recommandations pour maintenir les compétences (réactivation)
2026-02-20T22:09:13.8194590Z              # Trouver les compétences non pratiquées récemment
2026-02-20T22:09:13.8195213Z              # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides dès le départ
2026-02-20T22:09:13.8195426Z              valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8195921Z              valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8196046Z -            
2026-02-20T22:09:13.8196340Z -            all_exercise_types = db.query(Exercise.exercise_type).filter(
2026-02-20T22:09:13.8196549Z -                Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8196967Z -                Exercise.difficulty.in_(valid_difficulties)
2026-02-20T22:09:13.8197115Z -            ).distinct().all()
2026-02-20T22:09:13.8197233Z -            
2026-02-20T22:09:13.8197339Z +
2026-02-20T22:09:13.8197478Z +            all_exercise_types = (
2026-02-20T22:09:13.8197649Z +                db.query(Exercise.exercise_type)
2026-02-20T22:09:13.8197771Z +                .filter(
2026-02-20T22:09:13.8197970Z +                    Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8198187Z +                    Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8198299Z +                )
2026-02-20T22:09:13.8198416Z +                .distinct()
2026-02-20T22:09:13.8198532Z +                .all()
2026-02-20T22:09:13.8198632Z +            )
2026-02-20T22:09:13.8198743Z +
2026-02-20T22:09:13.8198905Z              for ex_type in all_exercise_types:
2026-02-20T22:09:13.8199101Z                  ex_type = ex_type[0]  # Extraction du tuple
2026-02-20T22:09:13.8199526Z                  # Vérifier si ce type d'exercice a été pratiqué récemment
2026-02-20T22:09:13.8199998Z                  # Utiliser une requête filtrée pour éviter les erreurs d'énumération
2026-02-20T22:09:13.8200152Z                  recent_type_attempts = []
2026-02-20T22:09:13.8200309Z                  for a in recent_attempts:
2026-02-20T22:09:13.8200492Z -                    exercise = db.query(Exercise).filter(
2026-02-20T22:09:13.8200663Z -                        Exercise.id == a.exercise_id,
2026-02-20T22:09:13.8200868Z -                        Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8201093Z -                        Exercise.difficulty.in_(valid_difficulties)
2026-02-20T22:09:13.8201232Z -                    ).first()
2026-02-20T22:09:13.8201359Z +                    exercise = (
2026-02-20T22:09:13.8201508Z +                        db.query(Exercise)
2026-02-20T22:09:13.8201627Z +                        .filter(
2026-02-20T22:09:13.8201808Z +                            Exercise.id == a.exercise_id,
2026-02-20T22:09:13.8202030Z +                            Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8202259Z +                            Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8202375Z +                        )
2026-02-20T22:09:13.8202490Z +                        .first()
2026-02-20T22:09:13.8202610Z +                    )
2026-02-20T22:09:13.8202848Z                      if exercise and exercise.exercise_type == ex_type:
2026-02-20T22:09:13.8203218Z                          recent_type_attempts.append(a)
2026-02-20T22:09:13.8203349Z -                
2026-02-20T22:09:13.8203453Z +
2026-02-20T22:09:13.8203616Z                  if not recent_type_attempts:
2026-02-20T22:09:13.8204156Z                      # Trouver le niveau le plus élevé maîtrisé par l'utilisateur pour ce type
2026-02-20T22:09:13.8204294Z                      user_level = None
2026-02-20T22:09:13.8204459Z                      for p in progress_records:
2026-02-20T22:09:13.8204809Z -                        if p.exercise_type == ex_type and p.calculate_completion_rate() > 70:
2026-02-20T22:09:13.8204941Z +                        if (
2026-02-20T22:09:13.8205108Z +                            p.exercise_type == ex_type
2026-02-20T22:09:13.8205314Z +                            and p.calculate_completion_rate() > 70
2026-02-20T22:09:13.8205442Z +                        ):
2026-02-20T22:09:13.8205611Z                              user_level = p.difficulty
2026-02-20T22:09:13.8205726Z -                    
2026-02-20T22:09:13.8205839Z +
2026-02-20T22:09:13.8206201Z                      # Si aucun niveau trouvé, proposer le niveau débutant
2026-02-20T22:09:13.8206338Z                      if not user_level:
2026-02-20T22:09:13.8206709Z                          user_level = "INITIE"
2026-02-20T22:09:13.8206831Z -                    
2026-02-20T22:09:13.8206935Z +
2026-02-20T22:09:13.8207323Z                      # Proposer un exercice pour maintenir cette compétence
2026-02-20T22:09:13.8207706Z -                    exercises = db.query(Exercise).filter(
2026-02-20T22:09:13.8207915Z -                        Exercise.exercise_type == ex_type,
2026-02-20T22:09:13.8208101Z -                        Exercise.difficulty == user_level,
2026-02-20T22:09:13.8208241Z +                    exercises = (
2026-02-20T22:09:13.8208378Z +                        db.query(Exercise)
2026-02-20T22:09:13.8208497Z +                        .filter(
2026-02-20T22:09:13.8208692Z +                            Exercise.exercise_type == ex_type,
2026-02-20T22:09:13.8208887Z +                            Exercise.difficulty == user_level,
2026-02-20T22:09:13.8209095Z +                            Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8209416Z +                            Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8209603Z +                            Exercise.is_archived == False,
2026-02-20T22:09:13.8209773Z +                            Exercise.is_active == True,
2026-02-20T22:09:13.8209896Z +                        )
2026-02-20T22:09:13.8210057Z +                        .order_by(func.random())
2026-02-20T22:09:13.8210179Z +                        .limit(1)
2026-02-20T22:09:13.8210293Z +                        .all()
2026-02-20T22:09:13.8210398Z +                    )
2026-02-20T22:09:13.8210509Z +
2026-02-20T22:09:13.8210645Z +                    for ex in exercises:
2026-02-20T22:09:13.8211061Z +                        # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8211303Z +                        if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8211480Z +                            recommendations.append(
2026-02-20T22:09:13.8211641Z +                                Recommendation(
2026-02-20T22:09:13.8211806Z +                                    user_id=user_id,
2026-02-20T22:09:13.8212007Z +                                    exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8212203Z +                                    difficulty=ex.difficulty,
2026-02-20T22:09:13.8212365Z +                                    exercise_id=ex.id,
2026-02-20T22:09:13.8212518Z +                                    priority=5,
2026-02-20T22:09:13.8213211Z +                                    reason=f"Pour maintenir vos compétences en {ex.exercise_type}",
2026-02-20T22:09:13.8213341Z +                                )
2026-02-20T22:09:13.8213468Z +                            )
2026-02-20T22:09:13.8213573Z +
2026-02-20T22:09:13.8213985Z +            # 4. Recommandations de découverte (nouveaux types d'exercices)
2026-02-20T22:09:13.8214306Z +            practised_types = set([p.exercise_type for p in progress_records])
2026-02-20T22:09:13.8214582Z +            all_types = set([ex_type[0] for ex_type in all_exercise_types])
2026-02-20T22:09:13.8214763Z +            new_types = all_types - practised_types
2026-02-20T22:09:13.8214867Z +
2026-02-20T22:09:13.8215017Z +            for new_type in new_types:
2026-02-20T22:09:13.8215547Z +                # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8215756Z +                valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8216017Z +                valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8216122Z +
2026-02-20T22:09:13.8216245Z +                exercises = (
2026-02-20T22:09:13.8216384Z +                    db.query(Exercise)
2026-02-20T22:09:13.8216501Z +                    .filter(
2026-02-20T22:09:13.8216689Z +                        Exercise.exercise_type == new_type,
2026-02-20T22:09:13.8216838Z +                        Exercise.difficulty
2026-02-20T22:09:13.8217083Z +                        == "INITIE",  # Commencer par le niveau le plus simple
2026-02-20T22:09:13.8217502Z                          Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8217729Z                          Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8218064Z                          Exercise.is_archived == False,
2026-02-20T22:09:13.8218232Z -                        Exercise.is_active == True
2026-02-20T22:09:13.8218418Z -                    ).order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8218537Z -                    
2026-02-20T22:09:13.8218675Z -                    for ex in exercises:
2026-02-20T22:09:13.8219075Z -                        # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8219304Z -                        if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8219526Z -                            recommendations.append(Recommendation(
2026-02-20T22:09:13.8219691Z +                        Exercise.is_active == True,
2026-02-20T22:09:13.8219814Z +                    )
2026-02-20T22:09:13.8219964Z +                    .order_by(func.random())
2026-02-20T22:09:13.8220081Z +                    .limit(1)
2026-02-20T22:09:13.8220195Z +                    .all()
2026-02-20T22:09:13.8220309Z +                )
2026-02-20T22:09:13.8220410Z +
2026-02-20T22:09:13.8220565Z +                for ex in exercises:
2026-02-20T22:09:13.8220953Z +                    # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8221183Z +                    if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8221348Z +                        recommendations.append(
2026-02-20T22:09:13.8221486Z +                            Recommendation(
2026-02-20T22:09:13.8221641Z                                  user_id=user_id,
2026-02-20T22:09:13.8221835Z                                  exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8222007Z                                  difficulty=ex.difficulty,
2026-02-20T22:09:13.8222175Z                                  exercise_id=ex.id,
2026-02-20T22:09:13.8222312Z -                                priority=5,
2026-02-20T22:09:13.8222778Z -                                reason=f"Pour maintenir vos compétences en {ex.exercise_type}"
2026-02-20T22:09:13.8222899Z -                            ))
2026-02-20T22:09:13.8223206Z -            
2026-02-20T22:09:13.8223641Z -            # 4. Recommandations de découverte (nouveaux types d'exercices)
2026-02-20T22:09:13.8223965Z -            practised_types = set([p.exercise_type for p in progress_records])
2026-02-20T22:09:13.8224244Z -            all_types = set([ex_type[0] for ex_type in all_exercise_types])
2026-02-20T22:09:13.8224426Z -            new_types = all_types - practised_types
2026-02-20T22:09:13.8224536Z -            
2026-02-20T22:09:13.8224693Z -            for new_type in new_types:
2026-02-20T22:09:13.8225222Z -                # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8225445Z -                valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8225706Z -                valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8225822Z -                
2026-02-20T22:09:13.8226000Z -                exercises = db.query(Exercise).filter(
2026-02-20T22:09:13.8226196Z -                    Exercise.exercise_type == new_type,
2026-02-20T22:09:13.8226578Z -                    Exercise.difficulty == "INITIE",  # Commencer par le niveau le plus simple
2026-02-20T22:09:13.8226777Z -                    Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8226991Z -                    Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8227158Z -                    Exercise.is_archived == False,
2026-02-20T22:09:13.8227312Z -                    Exercise.is_active == True
2026-02-20T22:09:13.8227490Z -                ).order_by(func.random()).limit(1).all()
2026-02-20T22:09:13.8227604Z -                
2026-02-20T22:09:13.8227939Z -                for ex in exercises:
2026-02-20T22:09:13.8228330Z -                    # Vérifier que l'exercice n'a pas été complété récemment
2026-02-20T22:09:13.8228556Z -                    if ex.id not in recently_completed_exercise_ids:
2026-02-20T22:09:13.8228934Z -                        recommendations.append(Recommendation(
2026-02-20T22:09:13.8229081Z -                            user_id=user_id,
2026-02-20T22:09:13.8229263Z -                            exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8229436Z -                            difficulty=ex.difficulty,
2026-02-20T22:09:13.8229581Z -                            exercise_id=ex.id,
2026-02-20T22:09:13.8229719Z -                            priority=4,
2026-02-20T22:09:13.8230203Z -                            reason=f"Découvrez un nouveau type d'exercice: {ex.exercise_type}"
2026-02-20T22:09:13.8230320Z -                        ))
2026-02-20T22:09:13.8230424Z -            
2026-02-20T22:09:13.8230560Z +                                priority=4,
2026-02-20T22:09:13.8231051Z +                                reason=f"Découvrez un nouveau type d'exercice: {ex.exercise_type}",
2026-02-20T22:09:13.8231173Z +                            )
2026-02-20T22:09:13.8231293Z +                        )
2026-02-20T22:09:13.8231412Z +
2026-02-20T22:09:13.8231963Z              # 5. Recommandations de défis logiques (challenges) — au moins 2, jusqu'à 4
2026-02-20T22:09:13.8232135Z              completed_challenge_ids = {
2026-02-20T22:09:13.8232274Z                  a.challenge_id
2026-02-20T22:09:13.8232493Z                  for a in db.query(LogicChallengeAttempt)
2026-02-20T22:09:13.8232621Z                  .filter(
2026-02-20T22:09:13.8232838Z                      LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:13.8233298Z -                    LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:13.8233520Z +                    LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:13.8233637Z                  )
2026-02-20T22:09:13.8233783Z                  .all()
2026-02-20T22:09:13.8233896Z              }
2026-02-20T22:09:13.8234366Z -            challenge_query = db.query(LogicChallenge).filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:13.8234608Z +            challenge_query = db.query(LogicChallenge).filter(
2026-02-20T22:09:13.8234817Z +                LogicChallenge.is_archived == False
2026-02-20T22:09:13.8234929Z +            )
2026-02-20T22:09:13.8235083Z              if completed_challenge_ids:
2026-02-20T22:09:13.8235294Z                  challenge_query = challenge_query.filter(
2026-02-20T22:09:13.8235572Z                      ~LogicChallenge.id.in_(list(completed_challenge_ids))
2026-02-20T22:09:13.8235690Z                  )
2026-02-20T22:09:13.8236099Z -            suggested_challenges = challenge_query.order_by(func.random()).limit(4).all()
2026-02-20T22:09:13.8236252Z +            suggested_challenges = (
2026-02-20T22:09:13.8236509Z +                challenge_query.order_by(func.random()).limit(4).all()
2026-02-20T22:09:13.8236630Z +            )
2026-02-20T22:09:13.8237331Z              # Priorité plus élevée si l'utilisateur n'a pas encore fait de défis (incitation à découvrir)
2026-02-20T22:09:13.8237559Z              num_completed = len(completed_challenge_ids)
2026-02-20T22:09:13.8237956Z -            challenge_priority = 8 if num_completed == 0 else 7 if num_completed < 3 else 6
2026-02-20T22:09:13.8238114Z +            challenge_priority = (
2026-02-20T22:09:13.8238373Z +                8 if num_completed == 0 else 7 if num_completed < 3 else 6
2026-02-20T22:09:13.8238489Z +            )
2026-02-20T22:09:13.8238667Z              for ch in suggested_challenges:
2026-02-20T22:09:13.8239122Z -                challenge_type_str = str(ch.challenge_type).lower() if ch.challenge_type else "logique"
2026-02-20T22:09:13.8239269Z +                challenge_type_str = (
2026-02-20T22:09:13.8239598Z +                    str(ch.challenge_type).lower() if ch.challenge_type else "logique"
2026-02-20T22:09:13.8240122Z +                )
2026-02-20T22:09:13.8240282Z                  if num_completed == 0:
2026-02-20T22:09:13.8240857Z                      reason = "Découvrez les défis logiques pour aiguiser votre raisonnement !"
2026-02-20T22:09:13.8241028Z                  elif num_completed < 3:
2026-02-20T22:09:13.8241761Z -                    reason = f"Variez votre entraînement avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8241915Z +                    reason = (
2026-02-20T22:09:13.8242418Z +                        f"Variez votre entraînement avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8242540Z +                    )
2026-02-20T22:09:13.8242660Z                  else:
2026-02-20T22:09:13.8243442Z                      reason = f"Testez vos compétences logiques avec un défi {challenge_type_str} !"
2026-02-20T22:09:13.8243665Z -                recommendations.append(Recommendation(
2026-02-20T22:09:13.8243810Z -                    user_id=user_id,
2026-02-20T22:09:13.8243956Z -                    exercise_id=None,
2026-02-20T22:09:13.8244138Z -                    challenge_id=ch.id,
2026-02-20T22:09:13.8244318Z -                    recommendation_type="challenge",
2026-02-20T22:09:13.8244476Z -                    exercise_type="challenge",
2026-02-20T22:09:13.8244699Z -                    difficulty=ch.difficulty or "PADAWAN",
2026-02-20T22:09:13.8244877Z -                    priority=challenge_priority,
2026-02-20T22:09:13.8245013Z -                    reason=reason
2026-02-20T22:09:13.8245133Z -                ))
2026-02-20T22:09:13.8245244Z -            
2026-02-20T22:09:13.8245402Z +                recommendations.append(
2026-02-20T22:09:13.8245539Z +                    Recommendation(
2026-02-20T22:09:13.8245687Z +                        user_id=user_id,
2026-02-20T22:09:13.8245828Z +                        exercise_id=None,
2026-02-20T22:09:13.8245978Z +                        challenge_id=ch.id,
2026-02-20T22:09:13.8246172Z +                        recommendation_type="challenge",
2026-02-20T22:09:13.8246347Z +                        exercise_type="challenge",
2026-02-20T22:09:13.8246555Z +                        difficulty=ch.difficulty or "PADAWAN",
2026-02-20T22:09:13.8246739Z +                        priority=challenge_priority,
2026-02-20T22:09:13.8246876Z +                        reason=reason,
2026-02-20T22:09:13.8246999Z +                    )
2026-02-20T22:09:13.8247110Z +                )
2026-02-20T22:09:13.8247229Z +
2026-02-20T22:09:13.8247841Z              # Si aucune recommandation n'a été générée, proposer quelques exercices aléatoires
2026-02-20T22:09:13.8247996Z              if not recommendations:
2026-02-20T22:09:13.8248572Z                  # FILTRE CRITIQUE : Exclure les exercices avec des types/difficultés invalides
2026-02-20T22:09:13.8248802Z                  valid_types = [t.value for t in ExerciseType]
2026-02-20T22:09:13.8249076Z                  valid_difficulties = [d.value for d in DifficultyLevel]
2026-02-20T22:09:13.8249199Z -                
2026-02-20T22:09:13.8249856Z -                logger.debug(f"Aucune recommandation générée, recherche d'exercices aléatoires...")
2026-02-20T22:09:13.8249968Z +
2026-02-20T22:09:13.8250104Z +                logger.debug(
2026-02-20T22:09:13.8250631Z +                    f"Aucune recommandation générée, recherche d'exercices aléatoires..."
2026-02-20T22:09:13.8250762Z +                )
2026-02-20T22:09:13.8250995Z                  logger.debug(f"Types valides: {valid_types}")
2026-02-20T22:09:13.8251427Z                  logger.debug(f"Difficultés valides: {valid_difficulties}")
2026-02-20T22:09:13.8251546Z -                
2026-02-20T22:09:13.8251653Z +
2026-02-20T22:09:13.8251863Z                  exercise_query = db.query(Exercise).filter(
2026-02-20T22:09:13.8252080Z                      Exercise.exercise_type.in_(valid_types),
2026-02-20T22:09:13.8252308Z                      Exercise.difficulty.in_(valid_difficulties),
2026-02-20T22:09:13.8252487Z                      Exercise.is_archived == False,
2026-02-20T22:09:13.8253209Z -                    Exercise.is_active == True
2026-02-20T22:09:13.8253344Z -                )
2026-02-20T22:09:13.8253466Z -                
2026-02-20T22:09:13.8253643Z +                    Exercise.is_active == True,
2026-02-20T22:09:13.8253755Z +                )
2026-02-20T22:09:13.8253862Z +
2026-02-20T22:09:13.8254403Z                  # Exclure les exercices récemment complétés
2026-02-20T22:09:13.8254597Z                  if recently_completed_exercise_ids:
2026-02-20T22:09:13.8255102Z -                    exercise_query = exercise_query.filter(~Exercise.id.in_(list(recently_completed_exercise_ids)))
2026-02-20T22:09:13.8255223Z -                
2026-02-20T22:09:13.8255435Z +                    exercise_query = exercise_query.filter(
2026-02-20T22:09:13.8255720Z +                        ~Exercise.id.in_(list(recently_completed_exercise_ids))
2026-02-20T22:09:13.8255839Z +                    )
2026-02-20T22:09:13.8255954Z +
2026-02-20T22:09:13.8256327Z                  random_exercises = exercise_query.order_by(func.random()).limit(3).all()
2026-02-20T22:09:13.8256460Z -                
2026-02-20T22:09:13.8256567Z +
2026-02-20T22:09:13.8257041Z                  logger.debug(f"Exercices trouvés: {len(random_exercises)}")
2026-02-20T22:09:13.8257203Z                  for ex in random_exercises:
2026-02-20T22:09:13.8257548Z                      logger.debug(f"  - {ex.title} ({ex.exercise_type}/{ex.difficulty})")
2026-02-20T22:09:13.8257673Z -                
2026-02-20T22:09:13.8257786Z +
2026-02-20T22:09:13.8257943Z                  for ex in random_exercises:
2026-02-20T22:09:13.8258167Z -                    recommendations.append(Recommendation(
2026-02-20T22:09:13.8258313Z -                        user_id=user_id,
2026-02-20T22:09:13.8258502Z -                        exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8258663Z -                        difficulty=ex.difficulty,
2026-02-20T22:09:13.8258815Z -                        exercise_id=ex.id,
2026-02-20T22:09:13.8258949Z -                        priority=3,
2026-02-20T22:09:13.8259196Z -                        reason="Pour continuer votre apprentissage"
2026-02-20T22:09:13.8259323Z -                    ))
2026-02-20T22:09:13.8259433Z -                
2026-02-20T22:09:13.8259602Z +                    recommendations.append(
2026-02-20T22:09:13.8259756Z +                        Recommendation(
2026-02-20T22:09:13.8259923Z +                            user_id=user_id,
2026-02-20T22:09:13.8260128Z +                            exercise_type=ex.exercise_type,
2026-02-20T22:09:13.8260307Z +                            difficulty=ex.difficulty,
2026-02-20T22:09:13.8260481Z +                            exercise_id=ex.id,
2026-02-20T22:09:13.8260622Z +                            priority=3,
2026-02-20T22:09:13.8260869Z +                            reason="Pour continuer votre apprentissage",
2026-02-20T22:09:13.8261003Z +                        )
2026-02-20T22:09:13.8261121Z +                    )
2026-02-20T22:09:13.8261232Z +
2026-02-20T22:09:13.8261814Z                  logger.debug(f"Recommandations fallback créées: {len(recommendations)}")
2026-02-20T22:09:13.8261940Z -            
2026-02-20T22:09:13.8262052Z +
2026-02-20T22:09:13.8262236Z              # Ajouter toutes les recommandations
2026-02-20T22:09:13.8262403Z              db.add_all(recommendations)
2026-02-20T22:09:13.8262541Z              db.commit()
2026-02-20T22:09:13.8262655Z -            
2026-02-20T22:09:13.8262761Z +
2026-02-20T22:09:13.8262915Z              return recommendations
2026-02-20T22:09:13.8263219Z -            
2026-02-20T22:09:13.8263333Z +
2026-02-20T22:09:13.8263603Z          except Exception as recommendations_generation_error:
2026-02-20T22:09:13.8264363Z -            logger.error(f"Erreur dans la génération des recommandations: {str(recommendations_generation_error)}")
2026-02-20T22:09:13.8264503Z +            logger.error(
2026-02-20T22:09:13.8265136Z +                f"Erreur dans la génération des recommandations: {str(recommendations_generation_error)}"
2026-02-20T22:09:13.8265501Z +            )
2026-02-20T22:09:13.8265637Z              db.rollback()
2026-02-20T22:09:13.8265762Z              return []
2026-02-20T22:09:13.8265884Z -    
2026-02-20T22:09:13.8265992Z +
2026-02-20T22:09:13.8266114Z      @staticmethod
2026-02-20T22:09:13.8266565Z      def mark_recommendation_as_shown(db, recommendation_id):
2026-02-20T22:09:13.8267072Z          """Marque une recommandation comme ayant été montrée à l'utilisateur"""
2026-02-20T22:09:13.8267190Z          try:
2026-02-20T22:09:13.8267711Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8267868Z +            recommendation = (
2026-02-20T22:09:13.8268024Z +                db.query(Recommendation)
2026-02-20T22:09:13.8268256Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8268388Z +                .first()
2026-02-20T22:09:13.8268498Z +            )
2026-02-20T22:09:13.8268636Z              if recommendation:
2026-02-20T22:09:13.8268834Z                  recommendation.shown_count += 1
2026-02-20T22:09:13.8268963Z                  db.commit()
2026-02-20T22:09:13.8269134Z          except Exception as mark_shown_error:
2026-02-20T22:09:13.8269858Z -            logger.error(f"Erreur lors du marquage de la recommandation comme montrée: {str(mark_shown_error)}")
2026-02-20T22:09:13.8270012Z +            logger.error(
2026-02-20T22:09:13.8270614Z +                f"Erreur lors du marquage de la recommandation comme montrée: {str(mark_shown_error)}"
2026-02-20T22:09:13.8270735Z +            )
2026-02-20T22:09:13.8270879Z              db.rollback()
2026-02-20T22:09:13.8270991Z -    
2026-02-20T22:09:13.8271101Z +
2026-02-20T22:09:13.8271233Z      @staticmethod
2026-02-20T22:09:13.8271512Z      def mark_recommendation_as_clicked(db, recommendation_id):
2026-02-20T22:09:13.8272028Z          """Marque une recommandation comme ayant été cliquée par l'utilisateur"""
2026-02-20T22:09:13.8272144Z          try:
2026-02-20T22:09:13.8272689Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8272832Z +            recommendation = (
2026-02-20T22:09:13.8273173Z +                db.query(Recommendation)
2026-02-20T22:09:13.8273443Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8273579Z +                .first()
2026-02-20T22:09:13.8273691Z +            )
2026-02-20T22:09:13.8273838Z              if recommendation:
2026-02-20T22:09:13.8274032Z                  recommendation.clicked_count += 1
2026-02-20T22:09:13.8274344Z                  recommendation.last_clicked_at = datetime.now(timezone.utc)
2026-02-20T22:09:13.8274477Z                  db.commit()
2026-02-20T22:09:13.8274671Z          except Exception as mark_clicked_error:
2026-02-20T22:09:13.8275436Z -            logger.error(f"Erreur lors du marquage de la recommandation comme cliquée: {str(mark_clicked_error)}")
2026-02-20T22:09:13.8275582Z +            logger.error(
2026-02-20T22:09:13.8276241Z +                f"Erreur lors du marquage de la recommandation comme cliquée: {str(mark_clicked_error)}"
2026-02-20T22:09:13.8276358Z +            )
2026-02-20T22:09:13.8276492Z              db.rollback()
2026-02-20T22:09:13.8276605Z -    
2026-02-20T22:09:13.8276721Z +
2026-02-20T22:09:13.8276847Z      @staticmethod
2026-02-20T22:09:13.8277130Z      def mark_recommendation_as_completed(db, recommendation_id):
2026-02-20T22:09:13.8277480Z          """Marque une recommandation comme complétée"""
2026-02-20T22:09:13.8277594Z          try:
2026-02-20T22:09:13.8278119Z -            recommendation = db.query(Recommendation).filter(Recommendation.id == recommendation_id).first()
2026-02-20T22:09:13.8278276Z +            recommendation = (
2026-02-20T22:09:13.8278437Z +                db.query(Recommendation)
2026-02-20T22:09:13.8278668Z +                .filter(Recommendation.id == recommendation_id)
2026-02-20T22:09:13.8278795Z +                .first()
2026-02-20T22:09:13.8279156Z +            )
2026-02-20T22:09:13.8279293Z              if recommendation:
2026-02-20T22:09:13.8279481Z                  recommendation.is_completed = True
2026-02-20T22:09:13.8279783Z                  recommendation.completed_at = datetime.now(timezone.utc)
2026-02-20T22:09:13.8279916Z                  db.commit()
2026-02-20T22:09:13.8280315Z          except Exception as mark_completed_error:
2026-02-20T22:09:13.8281124Z -            logger.error(f"Erreur lors du marquage de la recommandation comme complétée: {str(mark_completed_error)}")
2026-02-20T22:09:13.8281266Z +            logger.error(
2026-02-20T22:09:13.8281924Z +                f"Erreur lors du marquage de la recommandation comme complétée: {str(mark_completed_error)}"
2026-02-20T22:09:13.8282038Z +            )
2026-02-20T22:09:13.8282174Z              db.rollback()
2026-02-20T22:09:13.8282285Z -    
2026-02-20T22:09:13.8282393Z +
2026-02-20T22:09:13.8282523Z      @staticmethod
2026-02-20T22:09:13.8282745Z      def get_user_recommendations(db, user_id, limit=7):
2026-02-20T22:09:13.8283420Z          """Récupère les recommandations actives (mix exercices + défis)"""
2026-02-20T22:09:13.8283634Z -        all_recs = db.query(Recommendation).filter(
2026-02-20T22:09:13.8283809Z -            Recommendation.user_id == user_id,
2026-02-20T22:09:13.8284011Z -            Recommendation.is_completed == False
2026-02-20T22:09:13.8284342Z -        ).order_by(Recommendation.priority.desc()).limit(limit + 10).all()
2026-02-20T22:09:13.8284489Z +        all_recs = (
2026-02-20T22:09:13.8284647Z +            db.query(Recommendation)
2026-02-20T22:09:13.8284767Z +            .filter(
2026-02-20T22:09:13.8285151Z +                Recommendation.user_id == user_id, Recommendation.is_completed == False
2026-02-20T22:09:13.8285264Z +            )
2026-02-20T22:09:13.8285473Z +            .order_by(Recommendation.priority.desc())
2026-02-20T22:09:13.8285608Z +            .limit(limit + 10)
2026-02-20T22:09:13.8285728Z +            .all()
2026-02-20T22:09:13.8285843Z +        )
2026-02-20T22:09:13.8286014Z          result = list(all_recs[:limit])
2026-02-20T22:09:13.8286335Z          challenges = [r for r in all_recs if getattr(r, "challenge_id", None)]
2026-02-20T22:09:13.8286810Z          # Si aucun défi dans le top limit mais qu'il en existe, en insérer un
2026-02-20T22:09:13.8287177Z          if challenges and not any(getattr(r, "challenge_id", None) for r in result):
2026-02-20T22:09:13.8287543Z              exercises_only = [r for r in result if not getattr(r, "challenge_id", None)]
2026-02-20T22:09:13.8287726Z              if len(exercises_only) >= limit - 1:
2026-02-20T22:09:13.8287982Z                  result = exercises_only[: limit - 1] + [challenges[0]]
2026-02-20T22:09:13.8288135Z          return result[:limit]
2026-02-20T22:09:13.8288251Z -    
2026-02-20T22:09:13.8288362Z +
2026-02-20T22:09:13.8288493Z      @staticmethod
2026-02-20T22:09:13.8288713Z      def _get_next_difficulty(current_difficulty):
2026-02-20T22:09:13.8289062Z          """Retourne le niveau de difficulté suivant"""
2026-02-20T22:09:13.8289617Z          # Utiliser les mêmes valeurs que les énumérations DifficultyLevel (en majuscules)
2026-02-20T22:09:13.8289932Z          difficulty_levels = ["INITIE", "PADAWAN", "CHEVALIER", "MAITRE"]
2026-02-20T22:09:13.8290057Z @@ -438,6 +541,6 @@
2026-02-20T22:09:13.8290414Z              current_index = difficulty_levels.index(current_difficulty.upper())
2026-02-20T22:09:13.8290641Z              if current_index < len(difficulty_levels) - 1:
2026-02-20T22:09:13.8290869Z                  return difficulty_levels[current_index + 1]
2026-02-20T22:09:13.8291008Z          except ValueError:
2026-02-20T22:09:13.8291127Z              pass
2026-02-20T22:09:13.8291262Z -        return None 
2026-02-20T22:09:13.8291402Z \ No newline at end of file
2026-02-20T22:09:13.8291527Z +        return None
2026-02-20T22:09:13.8544578Z would reformat /home/runner/work/mathakine/mathakine/app/utils/email_verification.py
2026-02-20T22:09:13.8545177Z --- /home/runner/work/mathakine/mathakine/app/utils/email_verification.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:13.8546337Z +++ /home/runner/work/mathakine/mathakine/app/utils/email_verification.py	2026-02-20 22:09:13.832577+00:00
2026-02-20T22:09:13.8546527Z @@ -1,8 +1,9 @@
2026-02-20T22:09:13.8546875Z  """
2026-02-20T22:09:13.8547528Z  Utilitaires pour la vérification d'email
2026-02-20T22:09:13.8547651Z  """
2026-02-20T22:09:13.8547759Z +
2026-02-20T22:09:13.8547882Z  import secrets
2026-02-20T22:09:13.8548100Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:13.8548262Z  from typing import Optional
2026-02-20T22:09:13.8548362Z  
2026-02-20T22:09:13.8548562Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.8548683Z @@ -11,41 +12,41 @@
2026-02-20T22:09:13.8548789Z  
2026-02-20T22:09:13.8548893Z  
2026-02-20T22:09:13.8549234Z  def generate_verification_token() -> str:
2026-02-20T22:09:13.8549562Z      """
2026-02-20T22:09:13.8549866Z      Génère un token de vérification sécurisé.
2026-02-20T22:09:13.8550002Z -    
2026-02-20T22:09:13.8550117Z +
2026-02-20T22:09:13.8550232Z      Returns:
2026-02-20T22:09:13.8550554Z          Token de vérification (32 caractères aléatoires)
2026-02-20T22:09:13.8550666Z      """
2026-02-20T22:09:13.8550817Z      return secrets.token_urlsafe(32)
2026-02-20T22:09:13.8550918Z  
2026-02-20T22:09:13.8551033Z  
2026-02-20T22:09:13.8551377Z  def is_verification_token_expired(sent_at: Optional[datetime]) -> bool:
2026-02-20T22:09:13.8551483Z      """
2026-02-20T22:09:13.8551768Z      Vérifie si un token de vérification a expiré.
2026-02-20T22:09:13.8551882Z -    
2026-02-20T22:09:13.8551984Z +
2026-02-20T22:09:13.8552092Z      Args:
2026-02-20T22:09:13.8552386Z          sent_at: Date d'envoi du token
2026-02-20T22:09:13.8552736Z -    
2026-02-20T22:09:13.8552841Z +
2026-02-20T22:09:13.8552947Z      Returns:
2026-02-20T22:09:13.8553546Z          True si le token a expiré (plus de 24 heures), False sinon
2026-02-20T22:09:13.8553654Z      """
2026-02-20T22:09:13.8553777Z      if not sent_at:
2026-02-20T22:09:13.8553916Z          return True
2026-02-20T22:09:13.8554017Z -    
2026-02-20T22:09:13.8554121Z +
2026-02-20T22:09:13.8554326Z      expiration_time = sent_at + timedelta(hours=24)
2026-02-20T22:09:13.8554558Z      return datetime.now(timezone.utc) > expiration_time
2026-02-20T22:09:13.8554805Z  
2026-02-20T22:09:13.8555170Z  
2026-02-20T22:09:13.8555539Z  def is_password_reset_token_expired(expires_at: Optional[datetime]) -> bool:
2026-02-20T22:09:13.8555645Z      """
2026-02-20T22:09:13.8556058Z      Vérifie si un token de réinitialisation de mot de passe a expiré.
2026-02-20T22:09:13.8556167Z -    
2026-02-20T22:09:13.8556270Z +
2026-02-20T22:09:13.8556377Z      Args:
2026-02-20T22:09:13.8556548Z          expires_at: Date d'expiration du token
2026-02-20T22:09:13.8556659Z -    
2026-02-20T22:09:13.8556758Z +
2026-02-20T22:09:13.8556866Z      Returns:
2026-02-20T22:09:13.8557209Z          True si le token a expiré (1h par défaut), False sinon
2026-02-20T22:09:13.8557315Z      """
2026-02-20T22:09:13.8557452Z      if not expires_at:
2026-02-20T22:09:13.8557711Z          return True
2026-02-20T22:09:13.8573795Z @@ -53,19 +54,21 @@
2026-02-20T22:09:13.8573911Z  
2026-02-20T22:09:13.8574020Z  
2026-02-20T22:09:13.8574483Z  def create_verification_link(token: str, frontend_url: Optional[str] = None) -> str:
2026-02-20T22:09:13.8574594Z      """
2026-02-20T22:09:13.8574915Z      Crée un lien de vérification d'email.
2026-02-20T22:09:13.8575031Z -    
2026-02-20T22:09:13.8575132Z +
2026-02-20T22:09:13.8575246Z      Args:
2026-02-20T22:09:13.8575476Z          token: Token de vérification
2026-02-20T22:09:13.8575671Z          frontend_url: URL du frontend (optionnel)
2026-02-20T22:09:13.8575777Z -    
2026-02-20T22:09:13.8575880Z +
2026-02-20T22:09:13.8575998Z      Returns:
2026-02-20T22:09:13.8576225Z          Lien de vérification complet
2026-02-20T22:09:13.8576331Z      """
2026-02-20T22:09:13.8576445Z      import os
2026-02-20T22:09:13.8576555Z +
2026-02-20T22:09:13.8576687Z      if not frontend_url:
2026-02-20T22:09:13.8577472Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:13.8577588Z -    
2026-02-20T22:09:13.8577733Z +        frontend_url = os.getenv(
2026-02-20T22:09:13.8578208Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:13.8578329Z +        )
2026-02-20T22:09:13.8578439Z +
2026-02-20T22:09:13.8578656Z      return f"{frontend_url}/verify-email?token={token}"
2026-02-20T22:09:13.8578761Z -
2026-02-20T22:09:13.8726016Z --- /home/runner/work/mathakine/mathakine/app/utils/error_handler.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.8726612Z +++ /home/runner/work/mathakine/mathakine/app/utils/error_handler.py	2026-02-20 22:09:13.870662+00:00
2026-02-20T22:09:13.8726744Z @@ -1,8 +1,9 @@
2026-02-20T22:09:13.8726856Z  """
2026-02-20T22:09:13.8727371Z  Helper pour la gestion standardisée des erreurs dans les handlers.
2026-02-20T22:09:13.8727493Z  """
2026-02-20T22:09:13.8727619Z +
2026-02-20T22:09:13.8727739Z  import os
2026-02-20T22:09:13.8727877Z  import traceback
2026-02-20T22:09:13.8728046Z  from typing import Any, Dict, Optional
2026-02-20T22:09:13.8728155Z  
2026-02-20T22:09:13.8728364Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.8728489Z @@ -32,42 +33,44 @@
2026-02-20T22:09:13.8728608Z  
2026-02-20T22:09:13.8728747Z  class ErrorHandler:
2026-02-20T22:09:13.8728865Z      """
2026-02-20T22:09:13.8729343Z      Classe utilitaire pour gérer les erreurs de manière standardisée.
2026-02-20T22:09:13.8729458Z      """
2026-02-20T22:09:13.8729566Z -    
2026-02-20T22:09:13.8729684Z +
2026-02-20T22:09:13.8729809Z      @staticmethod
2026-02-20T22:09:13.8729957Z      def create_error_response(
2026-02-20T22:09:13.8730105Z          error: Exception,
2026-02-20T22:09:13.8730244Z          status_code: int = 500,
2026-02-20T22:09:13.8730408Z          user_message: Optional[str] = None,
2026-02-20T22:09:13.8730562Z -        include_details: bool = None
2026-02-20T22:09:13.8730736Z +        include_details: bool = None,
2026-02-20T22:09:13.8730878Z      ) -> JSONResponse:
2026-02-20T22:09:13.8730992Z          """
2026-02-20T22:09:13.8731355Z          Crée une réponse d'erreur JSON standardisée.
2026-02-20T22:09:13.8731468Z -        
2026-02-20T22:09:13.8731578Z +
2026-02-20T22:09:13.8731708Z          Args:
2026-02-20T22:09:13.8731946Z              error: Exception levée
2026-02-20T22:09:13.8732270Z              status_code: Code HTTP d'erreur (défaut: 500)
2026-02-20T22:09:13.8732944Z              user_message: Message à afficher à l'utilisateur (si None, utilise le message de l'exception)
2026-02-20T22:09:13.8733865Z              include_details: Inclure les détails techniques (défaut: True si DEBUG, False sinon)
2026-02-20T22:09:13.8733989Z -        
2026-02-20T22:09:13.8734098Z +
2026-02-20T22:09:13.8734223Z          Returns:
2026-02-20T22:09:13.8734538Z              JSONResponse avec le format d'erreur standardisé
2026-02-20T22:09:13.8734652Z          """
2026-02-20T22:09:13.8734831Z          error_type = type(error).__name__
2026-02-20T22:09:13.8750513Z          error_message = str(error)
2026-02-20T22:09:13.8750667Z -        
2026-02-20T22:09:13.8750784Z +
2026-02-20T22:09:13.8751222Z          # Ne jamais exposer traceback/détails en production
2026-02-20T22:09:13.8751400Z          if include_details is None:
2026-02-20T22:09:13.8751615Z              include_details = (
2026-02-20T22:09:13.8751826Z                  settings.LOG_LEVEL.upper() == "DEBUG"
2026-02-20T22:09:13.8752049Z                  and os.getenv("ENVIRONMENT") != "production"
2026-02-20T22:09:13.8752168Z              )
2026-02-20T22:09:13.8752275Z  
2026-02-20T22:09:13.8752764Z          # Message utilisateur : générique en prod pour éviter fuite d'info
2026-02-20T22:09:13.8754693Z -        display_error = user_message or (error_message if include_details else GENERIC_ERROR_MESSAGE)
2026-02-20T22:09:13.8754888Z +        display_error = user_message or (
2026-02-20T22:09:13.8755193Z +            error_message if include_details else GENERIC_ERROR_MESSAGE
2026-02-20T22:09:13.8755625Z +        )
2026-02-20T22:09:13.8755737Z  
2026-02-20T22:09:13.8756017Z          # Construire la réponse
2026-02-20T22:09:13.8756187Z          response_data: Dict[str, Any] = {
2026-02-20T22:09:13.8756334Z              "error": display_error,
2026-02-20T22:09:13.8756696Z              "error_type": error_type,
2026-02-20T22:09:13.8756841Z @@ -75,70 +78,65 @@
2026-02-20T22:09:13.8756955Z  
2026-02-20T22:09:13.8757323Z          # Ajouter les détails techniques uniquement en dev
2026-02-20T22:09:13.8757489Z          if include_details:
2026-02-20T22:09:13.8757710Z              response_data["error_message"] = error_message
2026-02-20T22:09:13.8757949Z              response_data["details"] = traceback.format_exc()
2026-02-20T22:09:13.8758067Z -        
2026-02-20T22:09:13.8758182Z +
2026-02-20T22:09:13.8758318Z          # Logger l'erreur
2026-02-20T22:09:13.8758528Z          logger.error(f"{error_type}: {error_message}")
2026-02-20T22:09:13.8758829Z          if include_details:
2026-02-20T22:09:13.8759156Z              logger.debug(f"Traceback complet:\n{traceback.format_exc()}")
2026-02-20T22:09:13.8760200Z -        
2026-02-20T22:09:13.8761138Z +
2026-02-20T22:09:13.8763759Z          # Nettoyer les données pour sérialisation JSON (gère les MagicMock dans les tests)
2026-02-20T22:09:13.8764041Z          response_data = make_json_serializable(response_data)
2026-02-20T22:09:13.8764165Z -        
2026-02-20T22:09:13.8764289Z +
2026-02-20T22:09:13.8766745Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8766882Z -    
2026-02-20T22:09:13.8767002Z +
2026-02-20T22:09:13.8767128Z      @staticmethod
2026-02-20T22:09:13.8767289Z      def create_validation_error(
2026-02-20T22:09:13.8767418Z -        field: str,
2026-02-20T22:09:13.8767556Z -        message: str,
2026-02-20T22:09:13.8767695Z -        status_code: int = 400
2026-02-20T22:09:13.8767919Z +        field: str, message: str, status_code: int = 400
2026-02-20T22:09:13.8768095Z      ) -> JSONResponse:
2026-02-20T22:09:13.8768209Z          """
2026-02-20T22:09:13.8768547Z          Crée une réponse d'erreur de validation.
2026-02-20T22:09:13.8768661Z -        
2026-02-20T22:09:13.8768782Z +
2026-02-20T22:09:13.8768897Z          Args:
2026-02-20T22:09:13.8769066Z              field: Nom du champ en erreur
2026-02-20T22:09:13.8769225Z              message: Message d'erreur
2026-02-20T22:09:13.8769504Z              status_code: Code HTTP (défaut: 400)
2026-02-20T22:09:13.8769614Z -        
2026-02-20T22:09:13.8769722Z +
2026-02-20T22:09:13.8769847Z          Returns:
2026-02-20T22:09:13.8770086Z              JSONResponse avec le format d'erreur de validation
2026-02-20T22:09:13.8770196Z          """
2026-02-20T22:09:13.8770339Z          response_data = {
2026-02-20T22:09:13.8770503Z              "error": "Erreur de validation",
2026-02-20T22:09:13.8770635Z              "field": field,
2026-02-20T22:09:13.8770768Z              "message": message,
2026-02-20T22:09:13.8770904Z          }
2026-02-20T22:09:13.8771014Z -        
2026-02-20T22:09:13.8771124Z +
2026-02-20T22:09:13.8771513Z          logger.warning(f"Erreur de validation pour le champ '{field}': {message}")
2026-02-20T22:09:13.8771628Z -        
2026-02-20T22:09:13.8771735Z +
2026-02-20T22:09:13.8772027Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8772144Z -    
2026-02-20T22:09:13.8772249Z +
2026-02-20T22:09:13.8772370Z      @staticmethod
2026-02-20T22:09:13.8772518Z      def create_not_found_error(
2026-02-20T22:09:13.8772657Z -        resource_type: str,
2026-02-20T22:09:13.8772788Z -        resource_id: Any,
2026-02-20T22:09:13.8772920Z -        status_code: int = 404
2026-02-20T22:09:13.8773409Z +        resource_type: str, resource_id: Any, status_code: int = 404
2026-02-20T22:09:13.8773551Z      ) -> JSONResponse:
2026-02-20T22:09:13.8773664Z          """
2026-02-20T22:09:13.8774056Z          Crée une réponse d'erreur "ressource non trouvée".
2026-02-20T22:09:13.8774440Z -        
2026-02-20T22:09:13.8774552Z +
2026-02-20T22:09:13.8774684Z          Args:
2026-02-20T22:09:13.8775013Z              resource_type: Type de ressource (ex: "exercice", "utilisateur")
2026-02-20T22:09:13.8775180Z              resource_id: ID de la ressource
2026-02-20T22:09:13.8775674Z              status_code: Code HTTP (défaut: 404)
2026-02-20T22:09:13.8775808Z -        
2026-02-20T22:09:13.8775919Z +
2026-02-20T22:09:13.8776042Z          Returns:
2026-02-20T22:09:13.8776415Z              JSONResponse avec le format d'erreur "non trouvé"
2026-02-20T22:09:13.8776533Z          """
2026-02-20T22:09:13.8776676Z          response_data = {
2026-02-20T22:09:13.8777041Z              "error": f"{resource_type.capitalize()} non trouvé",
2026-02-20T22:09:13.8777227Z              "resource_type": resource_type,
2026-02-20T22:09:13.8777396Z              "resource_id": str(resource_id),
2026-02-20T22:09:13.8777508Z          }
2026-02-20T22:09:13.8777628Z -        
2026-02-20T22:09:13.8777738Z +
2026-02-20T22:09:13.8778295Z          logger.warning(f"{resource_type.capitalize()} non trouvé: ID {resource_id}")
2026-02-20T22:09:13.8778413Z -        
2026-02-20T22:09:13.8778533Z +
2026-02-20T22:09:13.8778826Z          return JSONResponse(response_data, status_code=status_code)
2026-02-20T22:09:13.8778934Z -
2026-02-20T22:09:13.8779371Z would reformat /home/runner/work/mathakine/mathakine/app/utils/error_handler.py
2026-02-20T22:09:13.9598999Z --- /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.9599929Z +++ /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py	2026-02-20 22:09:13.957901+00:00
2026-02-20T22:09:13.9600325Z @@ -1,9 +1,10 @@
2026-02-20T22:09:13.9600438Z  """
2026-02-20T22:09:13.9600673Z  Module de sanitization des prompts utilisateurs.
2026-02-20T22:09:13.9600939Z  Protection contre l'injection de prompts malveillants.
2026-02-20T22:09:13.9601047Z  """
2026-02-20T22:09:13.9601155Z +
2026-02-20T22:09:13.9601314Z  import re
2026-02-20T22:09:13.9601467Z  from typing import Optional
2026-02-20T22:09:13.9601570Z  
2026-02-20T22:09:13.9601778Z  from app.core.logging_config import get_logger
2026-02-20T22:09:13.9601883Z  
2026-02-20T22:09:13.9602000Z @@ -11,114 +12,112 @@
2026-02-20T22:09:13.9602102Z  
2026-02-20T22:09:13.9602214Z  
2026-02-20T22:09:13.9602541Z  def sanitize_user_prompt(prompt: str, max_length: int = 500) -> str:
2026-02-20T22:09:13.9602651Z      """
2026-02-20T22:09:13.9602886Z      Sanitize user prompt to prevent injection attacks.
2026-02-20T22:09:13.9603160Z -    
2026-02-20T22:09:13.9603266Z +
2026-02-20T22:09:13.9603376Z      Args:
2026-02-20T22:09:13.9603545Z          prompt: Prompt utilisateur brut
2026-02-20T22:09:13.9604010Z          max_length: Longueur maximale autorisée
2026-02-20T22:09:13.9604121Z -        
2026-02-20T22:09:13.9604239Z +
2026-02-20T22:09:13.9604357Z      Returns:
2026-02-20T22:09:13.9604500Z          Prompt sanitized
2026-02-20T22:09:13.9604610Z      """
2026-02-20T22:09:13.9604754Z      if not prompt:
2026-02-20T22:09:13.9604864Z          return ""
2026-02-20T22:09:13.9604968Z -    
2026-02-20T22:09:13.9605073Z +
2026-02-20T22:09:13.9605216Z      # Limiter la longueur
2026-02-20T22:09:13.9605362Z      original_length = len(prompt)
2026-02-20T22:09:13.9605517Z      prompt = prompt[:max_length]
2026-02-20T22:09:13.9605640Z -    
2026-02-20T22:09:13.9605743Z +
2026-02-20T22:09:13.9605891Z      if original_length > max_length:
2026-02-20T22:09:13.9606479Z          logger.warning(f"Prompt tronqué de {original_length} à {max_length} caractères")
2026-02-20T22:09:13.9606585Z -    
2026-02-20T22:09:13.9606688Z +
2026-02-20T22:09:13.9607052Z      # Patterns dangereux à supprimer (tentatives d'injection)
2026-02-20T22:09:13.9607365Z      # Anglais ET français (Mathakine = plateforme FR)
2026-02-20T22:09:13.9607505Z      dangerous_patterns = [
2026-02-20T22:09:13.9607731Z          # Tentatives de contournement d'instructions (EN)
2026-02-20T22:09:13.9608054Z -        r'ignore\s+(previous|above|all|all\s+previous)\s+instructions?',
2026-02-20T22:09:13.9608728Z -        r'forget\s+(everything|all|previous)',
2026-02-20T22:09:13.9608899Z -        r'disregard\s+(previous|above|all)',
2026-02-20T22:09:13.9609030Z -        r'you\s+are\s+now',
2026-02-20T22:09:13.9609176Z -        r'new\s+instructions?',
2026-02-20T22:09:13.9609538Z -        r'override\s+(previous|system)',
2026-02-20T22:09:13.9609910Z +        r"ignore\s+(previous|above|all|all\s+previous)\s+instructions?",
2026-02-20T22:09:13.9610092Z +        r"forget\s+(everything|all|previous)",
2026-02-20T22:09:13.9610248Z +        r"disregard\s+(previous|above|all)",
2026-02-20T22:09:13.9610375Z +        r"you\s+are\s+now",
2026-02-20T22:09:13.9610514Z +        r"new\s+instructions?",
2026-02-20T22:09:13.9610661Z +        r"override\s+(previous|system)",
2026-02-20T22:09:13.9611069Z          # Français : oublie, tu es maintenant, nouveau contexte...
2026-02-20T22:09:13.9611475Z -        r'oublie\s+(tout|tout\s+ce\s+qui\s+précède|les\s+instructions)',
2026-02-20T22:09:13.9611829Z -        r'tu\s+es\s+(maintenant|désormais)\s+(un|une|le|la)',
2026-02-20T22:09:13.9612000Z -        r'ignore\s+(tout|les\s+instructions)',
2026-02-20T22:09:13.9612295Z -        r'nouveau\s+(contexte|rôle|personnage|mode)',
2026-02-20T22:09:13.9612717Z +        r"oublie\s+(tout|tout\s+ce\s+qui\s+précède|les\s+instructions)",
2026-02-20T22:09:13.9613218Z +        r"tu\s+es\s+(maintenant|désormais)\s+(un|une|le|la)",
2026-02-20T22:09:13.9613693Z would reformat /home/runner/work/mathakine/mathakine/app/utils/prompt_sanitizer.py
2026-02-20T22:09:13.9613868Z +        r"ignore\s+(tout|les\s+instructions)",
2026-02-20T22:09:13.9614173Z +        r"nouveau\s+(contexte|rôle|personnage|mode)",
2026-02-20T22:09:13.9614484Z          r'r[eé]ponds\s+(uniquement|seulement)\s+["\']',
2026-02-20T22:09:13.9614618Z -        r'from\s+now\s+on',
2026-02-20T22:09:13.9614728Z -        
2026-02-20T22:09:13.9614857Z +        r"from\s+now\s+on",
2026-02-20T22:09:13.9615107Z          # Tentatives de changement de rôle
2026-02-20T22:09:13.9615274Z -        r'act\s+as\s+if\s+you\s+are',
2026-02-20T22:09:13.9615410Z -        r'pretend\s+to\s+be',
2026-02-20T22:09:13.9615548Z -        r'you\s+must\s+now',
2026-02-20T22:09:13.9615808Z -        r'fais\s+comme\s+si\s+tu\s+(étais|es)',
2026-02-20T22:09:13.9615930Z -        
2026-02-20T22:09:13.9616067Z +        r"act\s+as\s+if\s+you\s+are",
2026-02-20T22:09:13.9616206Z +        r"pretend\s+to\s+be",
2026-02-20T22:09:13.9616327Z +        r"you\s+must\s+now",
2026-02-20T22:09:13.9616577Z +        r"fais\s+comme\s+si\s+tu\s+(étais|es)",
2026-02-20T22:09:13.9616737Z          # Tentatives de manipulation
2026-02-20T22:09:13.9616866Z -        r'do\s+not\s+follow',
2026-02-20T22:09:13.9617000Z -        r'ignore\s+the\s+system',
2026-02-20T22:09:13.9617162Z -        r'bypass\s+(safety|security|rules)',
2026-02-20T22:09:13.9617272Z -        
2026-02-20T22:09:13.9617394Z +        r"do\s+not\s+follow",
2026-02-20T22:09:13.9617527Z +        r"ignore\s+the\s+system",
2026-02-20T22:09:13.9617700Z +        r"bypass\s+(safety|security|rules)",
2026-02-20T22:09:13.9617849Z          # Tentatives de fuite d'informations
2026-02-20T22:09:13.9618075Z -        r'show\s+me\s+your\s+(prompt|instructions|system)',
2026-02-20T22:09:13.9618269Z -        r'repeat\s+your\s+(prompt|instructions)',
2026-02-20T22:09:13.9618476Z -        r'what\s+are\s+your\s+(instructions|rules)',
2026-02-20T22:09:13.9618734Z -        r'montre\s+(moi\s+)?(ton|ta|tes)\s+(prompt|instructions)',
2026-02-20T22:09:13.9619010Z -        r'quel\s+est\s+ton\s+(prompt|système)',
2026-02-20T22:09:13.9619236Z +        r"show\s+me\s+your\s+(prompt|instructions|system)",
2026-02-20T22:09:13.9619411Z +        r"repeat\s+your\s+(prompt|instructions)",
2026-02-20T22:09:13.9619592Z +        r"what\s+are\s+your\s+(instructions|rules)",
2026-02-20T22:09:13.9619842Z +        r"montre\s+(moi\s+)?(ton|ta|tes)\s+(prompt|instructions)",
2026-02-20T22:09:13.9620114Z +        r"quel\s+est\s+ton\s+(prompt|système)",
2026-02-20T22:09:13.9620460Z      ]
2026-02-20T22:09:13.9620565Z -    
2026-02-20T22:09:13.9620671Z +
2026-02-20T22:09:13.9620841Z      # Supprimer les patterns dangereux
2026-02-20T22:09:13.9620981Z      sanitized_prompt = prompt
2026-02-20T22:09:13.9621115Z      removed_patterns = []
2026-02-20T22:09:13.9621226Z -    
2026-02-20T22:09:13.9621519Z +
2026-02-20T22:09:13.9621697Z      for pattern in dangerous_patterns:
2026-02-20T22:09:13.9622026Z          matches = re.findall(pattern, sanitized_prompt, flags=re.IGNORECASE)
2026-02-20T22:09:13.9622159Z          if matches:
2026-02-20T22:09:13.9622325Z              removed_patterns.extend(matches)
2026-02-20T22:09:13.9622698Z -            sanitized_prompt = re.sub(pattern, '', sanitized_prompt, flags=re.IGNORECASE)
2026-02-20T22:09:13.9622810Z -    
2026-02-20T22:09:13.9623127Z +            sanitized_prompt = re.sub(
2026-02-20T22:09:13.9623368Z +                pattern, "", sanitized_prompt, flags=re.IGNORECASE
2026-02-20T22:09:13.9623486Z +            )
2026-02-20T22:09:13.9623606Z +
2026-02-20T22:09:13.9623743Z      if removed_patterns:
2026-02-20T22:09:13.9624322Z          logger.warning(f"Patterns dangereux détectés et supprimés: {removed_patterns}")
2026-02-20T22:09:13.9624444Z -    
2026-02-20T22:09:13.9624551Z +
2026-02-20T22:09:13.9624715Z      # Nettoyer les espaces multiples
2026-02-20T22:09:13.9624988Z -    sanitized_prompt = re.sub(r'\s+', ' ', sanitized_prompt)
2026-02-20T22:09:13.9625230Z +    sanitized_prompt = re.sub(r"\s+", " ", sanitized_prompt)
2026-02-20T22:09:13.9625417Z      sanitized_prompt = sanitized_prompt.strip()
2026-02-20T22:09:13.9625524Z -    
2026-02-20T22:09:13.9625634Z +
2026-02-20T22:09:13.9625775Z      return sanitized_prompt
2026-02-20T22:09:13.9625880Z  
2026-02-20T22:09:13.9625990Z  
2026-02-20T22:09:13.9626315Z  def validate_prompt_safety(prompt: str) -> tuple[bool, Optional[str]]:
2026-02-20T22:09:13.9626424Z      """
2026-02-20T22:09:13.9626671Z      Valide la sécurité d'un prompt.
2026-02-20T22:09:13.9626781Z -    
2026-02-20T22:09:13.9626893Z +
2026-02-20T22:09:13.9626999Z      Returns:
2026-02-20T22:09:13.9627462Z          Tuple (is_safe, reason) où reason est None si safe, sinon message d'erreur
2026-02-20T22:09:13.9627572Z      """
2026-02-20T22:09:13.9627694Z      if not prompt:
2026-02-20T22:09:13.9627823Z          return True, None
2026-02-20T22:09:13.9627946Z -    
2026-02-20T22:09:13.9628050Z +
2026-02-20T22:09:13.9628253Z      # Vérifier la longueur
2026-02-20T22:09:13.9628396Z      if len(prompt) > 1000:
2026-02-20T22:09:13.9628737Z          return False, "Prompt trop long (max 1000 caractères)"
2026-02-20T22:09:13.9628844Z -    
2026-02-20T22:09:13.9628945Z +
2026-02-20T22:09:13.9629298Z      # Blocage : fuite de prompt ou messages ultra-courts purement malveillants.
2026-02-20T22:09:13.9629823Z      # Les injections mixtes ("Explique Pythagore. PS: Oublie tout...") sont nettoyées
2026-02-20T22:09:13.9630116Z      # par sanitize_user_prompt qui supprime les fragments dangereux.
2026-02-20T22:09:13.9630257Z      block_patterns = [
2026-02-20T22:09:13.9630488Z -        r'ignore\s+(previous|above|all)\s+instructions?',
2026-02-20T22:09:13.9630644Z -        r'forget\s+everything\s*\.?\s*$',
2026-02-20T22:09:13.9631058Z -        r'(?:show|repeat|disclose)\s+(?:me\s+)?(?:your|the)\s+(?:system\s+)?(?:prompt|instructions)',
2026-02-20T22:09:13.9631287Z +        r"ignore\s+(previous|above|all)\s+instructions?",
2026-02-20T22:09:13.9631434Z +        r"forget\s+everything\s*\.?\s*$",
2026-02-20T22:09:13.9631824Z +        r"(?:show|repeat|disclose)\s+(?:me\s+)?(?:your|the)\s+(?:system\s+)?(?:prompt|instructions)",
2026-02-20T22:09:13.9631934Z      ]
2026-02-20T22:09:13.9632084Z      for pattern in block_patterns:
2026-02-20T22:09:13.9632352Z          if re.search(pattern, prompt.strip(), flags=re.IGNORECASE):
2026-02-20T22:09:13.9632661Z              return False, "Pattern dangereux détecté"
2026-02-20T22:09:13.9632767Z  
2026-02-20T22:09:13.9633297Z      # Message court (< 60 car) + injection FR/EN → bloquer
2026-02-20T22:09:13.9633461Z      if len(prompt.strip()) < 60:
2026-02-20T22:09:13.9634029Z -        for pat in [r'oublie\s+tout', r'you\s+are\s+now', r'tu\s+es\s+maintenant']:
2026-02-20T22:09:13.9634339Z +        for pat in [r"oublie\s+tout", r"you\s+are\s+now", r"tu\s+es\s+maintenant"]:
2026-02-20T22:09:13.9634740Z              if re.search(pat, prompt, flags=re.IGNORECASE):
2026-02-20T22:09:13.9635080Z                  return False, "Pattern dangereux détecté"
2026-02-20T22:09:13.9635191Z -    
2026-02-20T22:09:13.9635294Z +
2026-02-20T22:09:13.9635429Z      return True, None
2026-02-20T22:09:13.9635530Z -
2026-02-20T22:09:13.9982160Z would reformat /home/runner/work/mathakine/mathakine/app/utils/json_utils.py
2026-02-20T22:09:13.9982676Z --- /home/runner/work/mathakine/mathakine/app/utils/json_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:13.9983476Z +++ /home/runner/work/mathakine/mathakine/app/utils/json_utils.py	2026-02-20 22:09:13.994089+00:00
2026-02-20T22:09:13.9983619Z @@ -1,14 +1,17 @@
2026-02-20T22:09:13.9983734Z  """
2026-02-20T22:09:13.9983938Z  Utilitaires pour le parsing JSON.
2026-02-20T22:09:13.9984048Z  """
2026-02-20T22:09:13.9984163Z +
2026-02-20T22:09:13.9984290Z  import json
2026-02-20T22:09:13.9984419Z  import re
2026-02-20T22:09:13.9984624Z  from typing import Any, List, Optional, Union
2026-02-20T22:09:13.9984736Z  
2026-02-20T22:09:13.9984872Z  
2026-02-20T22:09:13.9985316Z -def safe_parse_json(value: Optional[Union[str, dict, list]], default: Any = None) -> Any:
2026-02-20T22:09:13.9985454Z +def safe_parse_json(
2026-02-20T22:09:13.9985735Z +    value: Optional[Union[str, dict, list]], default: Any = None
2026-02-20T22:09:13.9985861Z +) -> Any:
2026-02-20T22:09:13.9985976Z      """
2026-02-20T22:09:13.9986571Z      Parse JSON en gérant les cas None, string vide, ou JSON invalide.
2026-02-20T22:09:13.9986970Z      Utilisé pour les champs DB (choices, visual_data, etc.).
2026-02-20T22:09:13.9987086Z  
2026-02-20T22:09:13.9987202Z      Args:
2026-02-20T22:09:13.9987329Z @@ -60,87 +63,101 @@
2026-02-20T22:09:13.9987664Z              open_braces = json_cleaned.count("{") - json_cleaned.count("}")
2026-02-20T22:09:13.9987978Z              open_brackets = json_cleaned.count("[") - json_cleaned.count("]")
2026-02-20T22:09:13.9988151Z              if json_cleaned.count('"') % 2 == 1:
2026-02-20T22:09:13.9988316Z                  json_cleaned += '..."'
2026-02-20T22:09:13.9988490Z              last_colon = json_cleaned.rfind(":")
2026-02-20T22:09:13.9988947Z -            last_close = max(json_cleaned.rfind("}"), json_cleaned.rfind("]"), json_cleaned.rfind('"'))
2026-02-20T22:09:13.9989102Z +            last_close = max(
2026-02-20T22:09:13.9989258Z +                json_cleaned.rfind("}"),
2026-02-20T22:09:13.9989408Z +                json_cleaned.rfind("]"),
2026-02-20T22:09:13.9989560Z +                json_cleaned.rfind('"'),
2026-02-20T22:09:13.9989695Z +            )
2026-02-20T22:09:13.9989841Z              if last_colon > last_close:
2026-02-20T22:09:13.9989984Z                  json_cleaned += '""'
2026-02-20T22:09:13.9990251Z              json_cleaned += "]" * open_brackets + "}" * open_braces
2026-02-20T22:09:13.9990417Z              return json.loads(json_cleaned)
2026-02-20T22:09:13.9990530Z  
2026-02-20T22:09:13.9990649Z  
2026-02-20T22:09:13.9990843Z  def make_json_serializable(obj: Any) -> Any:
2026-02-20T22:09:13.9990963Z      """
2026-02-20T22:09:13.9991390Z      Convertit un objet en une structure sérialisable en JSON.
2026-02-20T22:09:13.9991826Z      Gère les MagicMock, les objets avec attributs, les datetime, etc.
2026-02-20T22:09:13.9991939Z -    
2026-02-20T22:09:13.9992045Z +
2026-02-20T22:09:13.9992170Z      Args:
2026-02-20T22:09:13.9992395Z          obj: Objet à convertir
2026-02-20T22:09:13.9992507Z -    
2026-02-20T22:09:13.9992613Z +
2026-02-20T22:09:13.9992742Z      Returns:
2026-02-20T22:09:13.9993354Z          Objet sérialisable (dict, list, str, int, float, bool, None)
2026-02-20T22:09:13.9993476Z      """
2026-02-20T22:09:13.9993779Z      # Détecter MagicMock et autres objets mock
2026-02-20T22:09:13.9994457Z -    if hasattr(obj, '__class__') and 'Mock' in obj.__class__.__name__:
2026-02-20T22:09:13.9994761Z +    if hasattr(obj, "__class__") and "Mock" in obj.__class__.__name__:
2026-02-20T22:09:13.9994988Z          # Si c'est un MagicMock, essayer de le convertir en dict
2026-02-20T22:09:13.9995313Z          try:
2026-02-20T22:09:13.9995483Z              # Si l'objet a un dict, l'utiliser
2026-02-20T22:09:13.9995621Z -            if hasattr(obj, '__dict__'):
2026-02-20T22:09:13.9996099Z -                return {k: make_json_serializable(v) for k, v in obj.__dict__.items() if not k.startswith('_')}
2026-02-20T22:09:13.9996246Z +            if hasattr(obj, "__dict__"):
2026-02-20T22:09:13.9996374Z +                return {
2026-02-20T22:09:13.9996550Z +                    k: make_json_serializable(v)
2026-02-20T22:09:13.9996719Z +                    for k, v in obj.__dict__.items()
2026-02-20T22:09:13.9996874Z +                    if not k.startswith("_")
2026-02-20T22:09:13.9996986Z +                }
2026-02-20T22:09:13.9997378Z              # Sinon, retourner une représentation string
2026-02-20T22:09:13.9997529Z              return str(obj)
2026-02-20T22:09:13.9997680Z          except Exception:
2026-02-20T22:09:13.9997820Z              return str(obj)
2026-02-20T22:09:13.9997930Z -    
2026-02-20T22:09:13.9998049Z +
2026-02-20T22:09:13.9998289Z      # Gérer les dictionnaires
2026-02-20T22:09:13.9998447Z      if isinstance(obj, dict):
2026-02-20T22:09:13.9998729Z          return {k: make_json_serializable(v) for k, v in obj.items()}
2026-02-20T22:09:13.9998842Z -    
2026-02-20T22:09:13.9998963Z +
2026-02-20T22:09:13.9999182Z      # Gérer les listes
2026-02-20T22:09:13.9999349Z      if isinstance(obj, (list, tuple)):
2026-02-20T22:09:13.9999603Z          return [make_json_serializable(item) for item in obj]
2026-02-20T22:09:13.9999711Z -    
2026-02-20T22:09:13.9999818Z +
2026-02-20T22:09:14.0000085Z      # Gérer les types de base sérialisables
2026-02-20T22:09:14.0000344Z      if isinstance(obj, (str, int, float, bool, type(None))):
2026-02-20T22:09:14.0000488Z          return obj
2026-02-20T22:09:14.0000602Z -    
2026-02-20T22:09:14.0000718Z +
2026-02-20T22:09:14.0000939Z      # Gérer les datetime
2026-02-20T22:09:14.0001091Z -    if hasattr(obj, 'isoformat'):
2026-02-20T22:09:14.0001247Z +    if hasattr(obj, "isoformat"):
2026-02-20T22:09:14.0001397Z          return obj.isoformat()
2026-02-20T22:09:14.0001505Z -    
2026-02-20T22:09:14.0001612Z +
2026-02-20T22:09:14.0002077Z      # Gérer les objets avec attributs (modèles SQLAlchemy, Pydantic, etc.)
2026-02-20T22:09:14.0002222Z -    if hasattr(obj, '__dict__'):
2026-02-20T22:09:14.0002360Z +    if hasattr(obj, "__dict__"):
2026-02-20T22:09:14.0002473Z          try:
2026-02-20T22:09:14.0003199Z -            return {k: make_json_serializable(v) for k, v in obj.__dict__.items() if not k.startswith('_')}
2026-02-20T22:09:14.0003353Z +            return {
2026-02-20T22:09:14.0003520Z +                k: make_json_serializable(v)
2026-02-20T22:09:14.0003724Z +                for k, v in obj.__dict__.items()
2026-02-20T22:09:14.0003871Z +                if not k.startswith("_")
2026-02-20T22:09:14.0003980Z +            }
2026-02-20T22:09:14.0004964Z          except Exception:
2026-02-20T22:09:14.0005129Z              return str(obj)
2026-02-20T22:09:14.0005244Z -    
2026-02-20T22:09:14.0005373Z +
2026-02-20T22:09:14.0005540Z      # Fallback: convertir en string
2026-02-20T22:09:14.0005657Z      try:
2026-02-20T22:09:14.0005794Z          return str(obj)
2026-02-20T22:09:14.0005941Z      except Exception:
2026-02-20T22:09:14.0006067Z          return None
2026-02-20T22:09:14.0006180Z  
2026-02-20T22:09:14.0006288Z  
2026-02-20T22:09:14.0006796Z -def parse_choices_json(choices_value: Optional[Union[str, dict, list]]) -> Optional[List[str]]:
2026-02-20T22:09:14.0006950Z +def parse_choices_json(
2026-02-20T22:09:14.0007163Z +    choices_value: Optional[Union[str, dict, list]],
2026-02-20T22:09:14.0007314Z +) -> Optional[List[str]]:
2026-02-20T22:09:14.0007426Z      """
2026-02-20T22:09:14.0008116Z      Parse les choix d'exercice depuis différents formats JSON.
2026-02-20T22:09:14.0008229Z -    
2026-02-20T22:09:14.0008348Z +
2026-02-20T22:09:14.0008466Z      Args:
2026-02-20T22:09:14.0008783Z          choices_value: Valeur des choix (string JSON, dict, list, ou None)
2026-02-20T22:09:14.0009189Z -    
2026-02-20T22:09:14.0009324Z +
2026-02-20T22:09:14.0009446Z      Returns:
2026-02-20T22:09:14.0009594Z          Liste de strings ou None
2026-02-20T22:09:14.0009715Z      """
2026-02-20T22:09:14.0009855Z      if not choices_value:
2026-02-20T22:09:14.0009983Z          return None
2026-02-20T22:09:14.0010100Z -    
2026-02-20T22:09:14.0010207Z +
2026-02-20T22:09:14.0010377Z      if isinstance(choices_value, list):
2026-02-20T22:09:14.0010610Z          # Déjà une liste
2026-02-20T22:09:14.0010759Z          return choices_value
2026-02-20T22:09:14.0010867Z -    
2026-02-20T22:09:14.0010977Z +
2026-02-20T22:09:14.0011144Z      if isinstance(choices_value, str):
2026-02-20T22:09:14.0011384Z          # String JSON à parser
2026-02-20T22:09:14.0011499Z          try:
2026-02-20T22:09:14.0011679Z              parsed = json.loads(choices_value)
2026-02-20T22:09:14.0011846Z              if isinstance(parsed, list):
2026-02-20T22:09:14.0011969Z @@ -149,12 +166,11 @@
2026-02-20T22:09:14.0012161Z                  # Dict JSONB : extraire les valeurs
2026-02-20T22:09:14.0012411Z                  return list(parsed.values()) if parsed else None
2026-02-20T22:09:14.0012539Z              return None
2026-02-20T22:09:14.0012735Z          except (json.JSONDecodeError, TypeError):
2026-02-20T22:09:14.0012863Z              return None
2026-02-20T22:09:14.0013251Z -    
2026-02-20T22:09:14.0013371Z +
2026-02-20T22:09:14.0013547Z      if isinstance(choices_value, dict):
2026-02-20T22:09:14.0013720Z          # Dict JSONB : extraire les valeurs
2026-02-20T22:09:14.0014018Z          return list(choices_value.values()) if choices_value else None
2026-02-20T22:09:14.0014130Z -    
2026-02-20T22:09:14.0014258Z +
2026-02-20T22:09:14.0014383Z      return None
2026-02-20T22:09:14.0014490Z -
2026-02-20T22:09:14.0176554Z --- /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0177882Z +++ /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py	2026-02-20 22:09:14.015247+00:00
2026-02-20T22:09:14.0178695Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0178997Z  """
2026-02-20T22:09:14.0179511Z  Module de métriques pour la génération IA.
2026-02-20T22:09:14.0180171Z  Track la qualité, performance et fiabilité des générations.
2026-02-20T22:09:14.0180678Z  """
2026-02-20T22:09:14.0180924Z +
2026-02-20T22:09:14.0181221Z  from collections import defaultdict
2026-02-20T22:09:14.0181658Z  from datetime import datetime, timedelta
2026-02-20T22:09:14.0182134Z  from typing import Dict, List, Optional
2026-02-20T22:09:14.0182530Z  
2026-02-20T22:09:14.0182867Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.0183488Z @@ -11,31 +12,31 @@
2026-02-20T22:09:14.0183814Z  logger = get_logger(__name__)
2026-02-20T22:09:14.0184166Z  
2026-02-20T22:09:14.0184401Z  
2026-02-20T22:09:14.0184663Z  class GenerationMetrics:
2026-02-20T22:09:14.0185217Z      """Tracker de métriques pour la génération IA."""
2026-02-20T22:09:14.0185682Z -    
2026-02-20T22:09:14.0185950Z +
2026-02-20T22:09:14.0186218Z      def __init__(self):
2026-02-20T22:09:14.0187188Z          # Structure: {challenge_type: [{"timestamp": datetime, "success": bool, "validation_passed": bool, "auto_corrected": bool, "duration": float}]}
2026-02-20T22:09:14.0188376Z          self._generation_history: Dict[str, List] = defaultdict(list)
2026-02-20T22:09:14.0189101Z          self._validation_failures: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0189795Z          self._auto_corrections: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0190458Z          self._success_count: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0191090Z          self._failure_count: Dict[str, int] = defaultdict(int)
2026-02-20T22:09:14.0191915Z -    
2026-02-20T22:09:14.0192173Z +
2026-02-20T22:09:14.0192457Z      def record_generation(
2026-02-20T22:09:14.0192808Z          self,
2026-02-20T22:09:14.0193323Z          challenge_type: str,
2026-02-20T22:09:14.0193704Z          success: bool,
2026-02-20T22:09:14.0194288Z          validation_passed: bool = True,
2026-02-20T22:09:14.0194772Z          auto_corrected: bool = False,
2026-02-20T22:09:14.0195215Z          duration_seconds: float = 0.0,
2026-02-20T22:09:14.0195674Z -        error_type: Optional[str] = None
2026-02-20T22:09:14.0196136Z +        error_type: Optional[str] = None,
2026-02-20T22:09:14.0196559Z      ):
2026-02-20T22:09:14.0196810Z          """
2026-02-20T22:09:14.0197329Z          Enregistre une génération dans les métriques.
2026-02-20T22:09:14.0197792Z -        
2026-02-20T22:09:14.0198011Z +
2026-02-20T22:09:14.0198207Z          Args:
2026-02-20T22:09:14.0198484Z              challenge_type: Type de challenge
2026-02-20T22:09:14.0198990Z              success: Si la génération a réussi
2026-02-20T22:09:14.0199465Z              validation_passed: Si la validation a passé
2026-02-20T22:09:14.0200061Z              auto_corrected: Si une auto-correction a été appliquée
2026-02-20T22:09:14.0200509Z @@ -48,149 +49,167 @@
2026-02-20T22:09:14.0200840Z              "validation_passed": validation_passed,
2026-02-20T22:09:14.0201257Z              "auto_corrected": auto_corrected,
2026-02-20T22:09:14.0201644Z              "duration": duration_seconds,
2026-02-20T22:09:14.0202010Z              "error_type": error_type,
2026-02-20T22:09:14.0202340Z          }
2026-02-20T22:09:14.0202567Z -        
2026-02-20T22:09:14.0202781Z +
2026-02-20T22:09:14.0204926Z          self._generation_history[challenge_type].append(record)
2026-02-20T22:09:14.0205391Z -        
2026-02-20T22:09:14.0205623Z +
2026-02-20T22:09:14.0205847Z          if success:
2026-02-20T22:09:14.0206205Z              self._success_count[challenge_type] += 1
2026-02-20T22:09:14.0206652Z          else:
2026-02-20T22:09:14.0206946Z              self._failure_count[challenge_type] += 1
2026-02-20T22:09:14.0207322Z -        
2026-02-20T22:09:14.0207553Z +
2026-02-20T22:09:14.0207805Z          if not validation_passed:
2026-02-20T22:09:14.0208259Z              self._validation_failures[challenge_type] += 1
2026-02-20T22:09:14.0208807Z -        
2026-02-20T22:09:14.0209031Z +
2026-02-20T22:09:14.0209262Z          if auto_corrected:
2026-02-20T22:09:14.0209638Z              self._auto_corrections[challenge_type] += 1
2026-02-20T22:09:14.0210067Z -        
2026-02-20T22:09:14.0210296Z +
2026-02-20T22:09:14.0210535Z          logger.debug(
2026-02-20T22:09:14.0210924Z              f"Metrics recorded - Type: {challenge_type}, "
2026-02-20T22:09:14.0211520Z              f"Success: {success}, Validation: {validation_passed}, "
2026-02-20T22:09:14.0212434Z              f"Auto-corrected: {auto_corrected}, Duration: {duration_seconds:.2f}s"
2026-02-20T22:09:14.0212934Z          )
2026-02-20T22:09:14.0213314Z -    
2026-02-20T22:09:14.0213773Z -    def get_success_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0214458Z +
2026-02-20T22:09:14.0214706Z +    def get_success_rate(
2026-02-20T22:09:14.0215175Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0215678Z +    ) -> float:
2026-02-20T22:09:14.0216106Z          """Calcule le taux de succès."""
2026-02-20T22:09:14.0216599Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0217057Z -        
2026-02-20T22:09:14.0217331Z -        if challenge_type:
2026-02-20T22:09:14.0217663Z -            records = [
2026-02-20T22:09:14.0218099Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0218614Z +
2026-02-20T22:09:14.0218898Z +        if challenge_type:
2026-02-20T22:09:14.0219261Z +            records = [
2026-02-20T22:09:14.0219588Z +                r
2026-02-20T22:09:14.0219997Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0220824Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0221250Z              ]
2026-02-20T22:09:14.0221526Z          else:
2026-02-20T22:09:14.0221825Z              records = []
2026-02-20T22:09:14.0222494Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0223267Z -                records.extend([
2026-02-20T22:09:14.0223669Z -                    r for r in type_records
2026-02-20T22:09:14.0224144Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0224593Z -                ])
2026-02-20T22:09:14.0224877Z -        
2026-02-20T22:09:14.0225158Z -        if not records:
2026-02-20T22:09:14.0225490Z -            return 0.0
2026-02-20T22:09:14.0225796Z -        
2026-02-20T22:09:14.0226068Z +                records.extend(
2026-02-20T22:09:14.0226578Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0227117Z +                )
2026-02-20T22:09:14.0227418Z +
2026-02-20T22:09:14.0227674Z +        if not records:
2026-02-20T22:09:14.0228012Z +            return 0.0
2026-02-20T22:09:14.0228317Z +
2026-02-20T22:09:14.0228695Z          success_count = sum(1 for r in records if r["success"])
2026-02-20T22:09:14.0229291Z          return success_count / len(records) * 100
2026-02-20T22:09:14.0229734Z -    
2026-02-20T22:09:14.0230396Z -    def get_validation_failure_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0231199Z +
2026-02-20T22:09:14.0231492Z +    def get_validation_failure_rate(
2026-02-20T22:09:14.0232035Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0232571Z +    ) -> float:
2026-02-20T22:09:14.0233277Z          """Calcule le taux d'échec de validation."""
2026-02-20T22:09:14.0233865Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0234358Z -        
2026-02-20T22:09:14.0234639Z -        if challenge_type:
2026-02-20T22:09:14.0235007Z -            records = [
2026-02-20T22:09:14.0235444Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0235950Z +
2026-02-20T22:09:14.0236207Z +        if challenge_type:
2026-02-20T22:09:14.0236555Z +            records = [
2026-02-20T22:09:14.0236885Z +                r
2026-02-20T22:09:14.0237317Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0237864Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0238280Z              ]
2026-02-20T22:09:14.0238559Z          else:
2026-02-20T22:09:14.0238841Z              records = []
2026-02-20T22:09:14.0239303Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0239840Z -                records.extend([
2026-02-20T22:09:14.0240250Z -                    r for r in type_records
2026-02-20T22:09:14.0240720Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0241148Z -                ])
2026-02-20T22:09:14.0241446Z -        
2026-02-20T22:09:14.0241712Z -        if not records:
2026-02-20T22:09:14.0242054Z -            return 0.0
2026-02-20T22:09:14.0242348Z -        
2026-02-20T22:09:14.0242618Z +                records.extend(
2026-02-20T22:09:14.0243304Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0243837Z +                )
2026-02-20T22:09:14.0244145Z +
2026-02-20T22:09:14.0244432Z +        if not records:
2026-02-20T22:09:14.0244791Z +            return 0.0
2026-02-20T22:09:14.0245114Z +
2026-02-20T22:09:14.0245577Z          failure_count = sum(1 for r in records if not r["validation_passed"])
2026-02-20T22:09:14.0246269Z          return failure_count / len(records) * 100
2026-02-20T22:09:14.0246736Z -    
2026-02-20T22:09:14.0247360Z -    def get_auto_correction_rate(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0248090Z +
2026-02-20T22:09:14.0248354Z +    def get_auto_correction_rate(
2026-02-20T22:09:14.0249168Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0249728Z +    ) -> float:
2026-02-20T22:09:14.0250098Z          """Calcule le taux d'auto-correction."""
2026-02-20T22:09:14.0250685Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0251521Z -        
2026-02-20T22:09:14.0251863Z -        if challenge_type:
2026-02-20T22:09:14.0252245Z -            records = [
2026-02-20T22:09:14.0252731Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0253502Z +
2026-02-20T22:09:14.0253785Z +        if challenge_type:
2026-02-20T22:09:14.0254166Z +            records = [
2026-02-20T22:09:14.0254517Z +                r
2026-02-20T22:09:14.0254950Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0255514Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0255957Z              ]
2026-02-20T22:09:14.0256245Z          else:
2026-02-20T22:09:14.0256558Z              records = []
2026-02-20T22:09:14.0257032Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0257608Z -                records.extend([
2026-02-20T22:09:14.0258041Z -                    r for r in type_records
2026-02-20T22:09:14.0258558Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.0259023Z -                ])
2026-02-20T22:09:14.0259326Z -        
2026-02-20T22:09:14.0259629Z -        if not records:
2026-02-20T22:09:14.0259974Z -            return 0.0
2026-02-20T22:09:14.0260306Z -        
2026-02-20T22:09:14.0260602Z +                records.extend(
2026-02-20T22:09:14.0261138Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.0261692Z +                )
2026-02-20T22:09:14.0261988Z +
2026-02-20T22:09:14.0262253Z +        if not records:
2026-02-20T22:09:14.0262608Z +            return 0.0
2026-02-20T22:09:14.0262930Z +
2026-02-20T22:09:14.0266111Z          corrected_count = sum(1 for r in records if r["auto_corrected"])
2026-02-20T22:09:14.0268280Z          return corrected_count / len(records) * 100
2026-02-20T22:09:14.0268723Z -    
2026-02-20T22:09:14.0269307Z -    def get_average_duration(self, challenge_type: Optional[str] = None, days: int = 1) -> float:
2026-02-20T22:09:14.0270031Z +
2026-02-20T22:09:14.0270304Z +    def get_average_duration(
2026-02-20T22:09:14.0270795Z +        self, challenge_type: Optional[str] = None, days: int = 1
2026-02-20T22:09:14.0271294Z +    ) -> float:
2026-02-20T22:09:14.0271781Z          """Calcule la durée moyenne de génération."""
2026-02-20T22:09:14.0272346Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0272845Z -        
2026-02-20T22:09:14.0273358Z -        if challenge_type:
2026-02-20T22:09:14.0273735Z -            records = [
2026-02-20T22:09:14.0274199Z -                r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0274724Z +
2026-02-20T22:09:14.0274998Z +        if challenge_type:
2026-02-20T22:09:14.0275382Z +            records = [
2026-02-20T22:09:14.0275702Z +                r
2026-02-20T22:09:14.0276123Z +                for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0276747Z                  if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0277241Z              ]
2026-02-20T22:09:14.0277529Z          else:
2026-02-20T22:09:14.0277816Z              records = []
2026-02-20T22:09:14.0278285Z              for type_records in self._generation_history.values():
2026-02-20T22:09:14.0278830Z -                records.extend([
2026-02-20T22:09:14.0279226Z -                    r for r in type_records
2026-02-20T22:09:14.0279743Z -                    if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0280230Z -                ])
2026-02-20T22:09:14.0280513Z -        
2026-02-20T22:09:14.0280789Z -        if not records:
2026-02-20T22:09:14.0281135Z -            return 0.0
2026-02-20T22:09:14.0281440Z -        
2026-02-20T22:09:14.0281998Z +                records.extend(
2026-02-20T22:09:14.0282363Z +                    [
2026-02-20T22:09:14.0282677Z +                        r
2026-02-20T22:09:14.0283226Z +                        for r in type_records
2026-02-20T22:09:14.0283955Z +                        if r["timestamp"] > cutoff_date and r["success"]
2026-02-20T22:09:14.0284506Z +                    ]
2026-02-20T22:09:14.0284807Z +                )
2026-02-20T22:09:14.0285097Z +
2026-02-20T22:09:14.0285357Z +        if not records:
2026-02-20T22:09:14.0285691Z +            return 0.0
2026-02-20T22:09:14.0285994Z +
2026-02-20T22:09:14.0286359Z          total_duration = sum(r["duration"] for r in records)
2026-02-20T22:09:14.0286901Z          return total_duration / len(records)
2026-02-20T22:09:14.0287331Z -    
2026-02-20T22:09:14.0287588Z +
2026-02-20T22:09:14.0287915Z      def get_summary(self, days: int = 1) -> Dict:
2026-02-20T22:09:14.0288601Z          """Retourne un résumé complet des métriques."""
2026-02-20T22:09:14.0289087Z          return {
2026-02-20T22:09:14.0289494Z              "success_rate": self.get_success_rate(days=days),
2026-02-20T22:09:14.0290207Z              "validation_failure_rate": self.get_validation_failure_rate(days=days),
2026-02-20T22:09:14.0291055Z              "auto_correction_rate": self.get_auto_correction_rate(days=days),
2026-02-20T22:09:14.0291789Z              "average_duration": self.get_average_duration(days=days),
2026-02-20T22:09:14.0292401Z              "by_type": self._get_summary_by_type(days),
2026-02-20T22:09:14.0292856Z          }
2026-02-20T22:09:14.0293425Z -    
2026-02-20T22:09:14.0293704Z +
2026-02-20T22:09:14.0294123Z      def _get_summary_by_type(self, days: int) -> Dict[str, Dict]:
2026-02-20T22:09:14.0294918Z          """Retourne les métriques groupées par type."""
2026-02-20T22:09:14.0295442Z          summary_by_type = {}
2026-02-20T22:09:14.0295807Z -        
2026-02-20T22:09:14.0296068Z +
2026-02-20T22:09:14.0296462Z          for challenge_type in self._generation_history.keys():
2026-02-20T22:09:14.0297080Z              summary_by_type[challenge_type] = {
2026-02-20T22:09:14.0297709Z                  "success_rate": self.get_success_rate(challenge_type, days),
2026-02-20T22:09:14.0298600Z -                "validation_failure_rate": self.get_validation_failure_rate(challenge_type, days),
2026-02-20T22:09:14.0299592Z -                "auto_correction_rate": self.get_auto_correction_rate(challenge_type, days),
2026-02-20T22:09:14.0300443Z +                "validation_failure_rate": self.get_validation_failure_rate(
2026-02-20T22:09:14.0301059Z +                    challenge_type, days
2026-02-20T22:09:14.0301470Z +                ),
2026-02-20T22:09:14.0301903Z +                "auto_correction_rate": self.get_auto_correction_rate(
2026-02-20T22:09:14.0302485Z +                    challenge_type, days
2026-02-20T22:09:14.0302892Z +                ),
2026-02-20T22:09:14.0303637Z                  "average_duration": self.get_average_duration(challenge_type, days),
2026-02-20T22:09:14.0304340Z -                "total_generations": len([
2026-02-20T22:09:14.0304893Z -                    r for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0305570Z -                    if r["timestamp"] > datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0306115Z -                ]),
2026-02-20T22:09:14.0306463Z +                "total_generations": len(
2026-02-20T22:09:14.0306877Z +                    [
2026-02-20T22:09:14.0307190Z +                        r
2026-02-20T22:09:14.0307648Z +                        for r in self._generation_history[challenge_type]
2026-02-20T22:09:14.0308319Z +                        if r["timestamp"] > datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.0308874Z +                    ]
2026-02-20T22:09:14.0309168Z +                ),
2026-02-20T22:09:14.0309456Z              }
2026-02-20T22:09:14.0309718Z -        
2026-02-20T22:09:14.0309978Z +
2026-02-20T22:09:14.0310241Z          return summary_by_type
2026-02-20T22:09:14.0310831Z  
2026-02-20T22:09:14.0311073Z  
2026-02-20T22:09:14.0311461Z  # Instance globale des métriques
2026-02-20T22:09:14.0311921Z  generation_metrics = GenerationMetrics()
2026-02-20T22:09:14.0312339Z -
2026-02-20T22:09:14.0312940Z would reformat /home/runner/work/mathakine/mathakine/app/utils/generation_metrics.py
2026-02-20T22:09:14.0910342Z --- /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0911636Z +++ /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py	2026-02-20 22:09:14.088692+00:00
2026-02-20T22:09:14.0912434Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0912733Z  """
2026-02-20T22:09:14.0913340Z  Rate limiting pour les endpoints sensibles (audit 3.4).
2026-02-20T22:09:14.0914405Z  Protège contre bruteforce (login, forgot-password) et énumération.
2026-02-20T22:09:14.0915014Z  """
2026-02-20T22:09:14.0915278Z +
2026-02-20T22:09:14.0915544Z  import os
2026-02-20T22:09:14.0915828Z  import time
2026-02-20T22:09:14.0916140Z  from collections import defaultdict
2026-02-20T22:09:14.0916583Z  from functools import wraps
2026-02-20T22:09:14.0916968Z  from typing import Callable
2026-02-20T22:09:14.0917351Z @@ -59,12 +60,15 @@
2026-02-20T22:09:14.0917689Z              ip = _get_client_ip(request)
2026-02-20T22:09:14.0918214Z              key = f"rate_limit:{endpoint_name}:{ip}"
2026-02-20T22:09:14.0918810Z              if not _check_rate_limit(key, RATE_LIMIT_AUTH_MAX):
2026-02-20T22:09:14.0919768Z                  logger.warning(f"Rate limit dépassé pour {endpoint_name} depuis {ip}")
2026-02-20T22:09:14.0920555Z                  from starlette.responses import JSONResponse
2026-02-20T22:09:14.0921059Z +
2026-02-20T22:09:14.0921367Z                  return JSONResponse(
2026-02-20T22:09:14.0922197Z -                    {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0922863Z +                    {
2026-02-20T22:09:14.0923782Z +                        "error": "Trop de tentatives. Veuillez réessayer dans une minute."
2026-02-20T22:09:14.0924447Z +                    },
2026-02-20T22:09:14.0924808Z                      status_code=429,
2026-02-20T22:09:14.0925208Z                  )
2026-02-20T22:09:14.0925607Z              return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0926072Z  
2026-02-20T22:09:14.0926377Z          return wrapped
2026-02-20T22:09:14.0926720Z @@ -80,10 +84,11 @@
2026-02-20T22:09:14.0927083Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0927532Z          key = f"rate_limit:register:{ip}"
2026-02-20T22:09:14.0928098Z          if not _check_rate_limit(key, RATE_LIMIT_REGISTER_MAX):
2026-02-20T22:09:14.0929024Z              logger.warning(f"Rate limit dépassé pour register depuis {ip}")
2026-02-20T22:09:14.0929746Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0930252Z +
2026-02-20T22:09:14.0930547Z              return JSONResponse(
2026-02-20T22:09:14.0931309Z                  {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0931984Z                  status_code=429,
2026-02-20T22:09:14.0932375Z              )
2026-02-20T22:09:14.0932753Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0963566Z @@ -99,10 +104,11 @@
2026-02-20T22:09:14.0963994Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0964534Z          key = f"rate_limit:resend_verification:{ip}"
2026-02-20T22:09:14.0965208Z          if not _check_rate_limit(key, RATE_LIMIT_RESEND_VERIFICATION_MAX):
2026-02-20T22:09:14.0966292Z              logger.warning(f"Rate limit dépassé pour resend-verification depuis {ip}")
2026-02-20T22:09:14.0967130Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0967622Z +
2026-02-20T22:09:14.0967911Z              return JSONResponse(
2026-02-20T22:09:14.0968695Z                  {"error": "Trop de tentatives. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0969362Z                  status_code=429,
2026-02-20T22:09:14.0969742Z              )
2026-02-20T22:09:14.0970453Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0970946Z @@ -118,12 +124,15 @@
2026-02-20T22:09:14.0971312Z          ip = _get_client_ip(request)
2026-02-20T22:09:14.0971768Z          key = f"rate_limit:chat:{ip}"
2026-02-20T22:09:14.0972520Z          if not _check_rate_limit(key, RATE_LIMIT_CHAT_MAX):
2026-02-20T22:09:14.0973628Z              logger.warning(f"Rate limit dépassé pour chat depuis {ip}")
2026-02-20T22:09:14.0974333Z              from starlette.responses import JSONResponse
2026-02-20T22:09:14.0974826Z +
2026-02-20T22:09:14.0975121Z              return JSONResponse(
2026-02-20T22:09:14.0975964Z -                {"error": "Limite de messages atteinte. Veuillez réessayer dans une minute."},
2026-02-20T22:09:14.0976659Z +                {
2026-02-20T22:09:14.0977376Z +                    "error": "Limite de messages atteinte. Veuillez réessayer dans une minute."
2026-02-20T22:09:14.0978068Z +                },
2026-02-20T22:09:14.0978411Z                  status_code=429,
2026-02-20T22:09:14.0978789Z              )
2026-02-20T22:09:14.0979163Z          return await func(request, *args, **kwargs)
2026-02-20T22:09:14.0979628Z  
2026-02-20T22:09:14.0979902Z      return wrapped
2026-02-20T22:09:14.0980505Z would reformat /home/runner/work/mathakine/mathakine/app/utils/rate_limit.py
2026-02-20T22:09:14.0997417Z --- /home/runner/work/mathakine/mathakine/app/utils/request_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.0998553Z +++ /home/runner/work/mathakine/mathakine/app/utils/request_utils.py	2026-02-20 22:09:14.098653+00:00
2026-02-20T22:09:14.0999384Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.0999667Z  """
2026-02-20T22:09:14.1002943Z  Utilitaires pour le parsing des requêtes HTTP (DRY).
2026-02-20T22:09:14.1004459Z  Centralise le pattern await request.json() + validation des champs.
2026-02-20T22:09:14.1005582Z  """
2026-02-20T22:09:14.1006221Z +
2026-02-20T22:09:14.1006683Z  from typing import Any, Dict, Optional, Union
2026-02-20T22:09:14.1007261Z  
2026-02-20T22:09:14.1008592Z  from starlette.requests import Request
2026-02-20T22:09:14.1011822Z  from starlette.responses import JSONResponse
2026-02-20T22:09:14.1012564Z  
2026-02-20T22:09:14.1016418Z would reformat /home/runner/work/mathakine/mathakine/app/utils/request_utils.py
2026-02-20T22:09:14.1125380Z would reformat /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py
2026-02-20T22:09:14.1126529Z --- /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1127758Z +++ /home/runner/work/mathakine/mathakine/app/utils/rate_limiter.py	2026-02-20 22:09:14.109142+00:00
2026-02-20T22:09:14.1128569Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.1128873Z  """
2026-02-20T22:09:14.1129454Z  Module de rate limiting pour la génération IA.
2026-02-20T22:09:14.1130263Z  Limite le nombre de générations par utilisateur et par période.
2026-02-20T22:09:14.1130833Z  """
2026-02-20T22:09:14.1131100Z +
2026-02-20T22:09:14.1131402Z  from collections import defaultdict
2026-02-20T22:09:14.1131908Z  from datetime import datetime, timedelta
2026-02-20T22:09:14.1132441Z  from typing import Dict, List, Optional, Tuple
2026-02-20T22:09:14.1132906Z  
2026-02-20T22:09:14.1133454Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.1133910Z @@ -11,97 +12,98 @@
2026-02-20T22:09:14.1134220Z  logger = get_logger(__name__)
2026-02-20T22:09:14.1134572Z  
2026-02-20T22:09:14.1134806Z  
2026-02-20T22:09:14.1135043Z  class RateLimiter:
2026-02-20T22:09:14.1135802Z      """Rate limiter simple en mémoire (peut être migré vers Redis pour production)."""
2026-02-20T22:09:14.1136505Z -    
2026-02-20T22:09:14.1136774Z +
2026-02-20T22:09:14.1137050Z      def __init__(self):
2026-02-20T22:09:14.1137450Z          # Structure: {user_id: [timestamps]}
2026-02-20T22:09:14.1138147Z          self._user_generation_counts: Dict[int, List[datetime]] = defaultdict(list)
2026-02-20T22:09:14.1138891Z          self._cleanup_interval = timedelta(hours=1)
2026-02-20T22:09:14.1139655Z          self._last_cleanup = datetime.now()
2026-02-20T22:09:14.1140065Z -    
2026-02-20T22:09:14.1140321Z +
2026-02-20T22:09:14.1140595Z      def check_rate_limit(
2026-02-20T22:09:14.1140964Z -        self, 
2026-02-20T22:09:14.1141294Z -        user_id: int, 
2026-02-20T22:09:14.1141890Z -        max_per_hour: int = 10,
2026-02-20T22:09:14.1142337Z -        max_per_day: int = 50
2026-02-20T22:09:14.1142876Z +        self, user_id: int, max_per_hour: int = 10, max_per_day: int = 50
2026-02-20T22:09:14.1143708Z      ) -> tuple[bool, Optional[str]]:
2026-02-20T22:09:14.1144123Z          """
2026-02-20T22:09:14.1144703Z          Vérifie si l'utilisateur peut générer un challenge.
2026-02-20T22:09:14.1145223Z -        
2026-02-20T22:09:14.1145498Z +
2026-02-20T22:09:14.1145738Z          Args:
2026-02-20T22:09:14.1146066Z              user_id: ID de l'utilisateur
2026-02-20T22:09:14.1146867Z              max_per_hour: Nombre maximum de générations par heure
2026-02-20T22:09:14.1147592Z              max_per_day: Nombre maximum de générations par jour
2026-02-20T22:09:14.1148098Z -            
2026-02-20T22:09:14.1148376Z +
2026-02-20T22:09:14.1148625Z          Returns:
2026-02-20T22:09:14.1149168Z              Tuple (allowed, reason) où reason est None si autorisé
2026-02-20T22:09:14.1149690Z          """
2026-02-20T22:09:14.1150002Z          now = datetime.now()
2026-02-20T22:09:14.1150352Z -        
2026-02-20T22:09:14.1150625Z +
2026-02-20T22:09:14.1151067Z          # Nettoyage périodique (toutes les heures)
2026-02-20T22:09:14.1151661Z          if now - self._last_cleanup > self._cleanup_interval:
2026-02-20T22:09:14.1152209Z              self._cleanup_old_entries()
2026-02-20T22:09:14.1152659Z              self._last_cleanup = now
2026-02-20T22:09:14.1153254Z -        
2026-02-20T22:09:14.1153530Z +
2026-02-20T22:09:14.1153981Z          # Récupérer les timestamps de l'utilisateur
2026-02-20T22:09:14.1154580Z          user_timestamps = self._user_generation_counts[user_id]
2026-02-20T22:09:14.1155111Z -        
2026-02-20T22:09:14.1155379Z +
2026-02-20T22:09:14.1155852Z          # Filtrer les timestamps récents (dernière heure)
2026-02-20T22:09:14.1156383Z          hour_ago = now - timedelta(hours=1)
2026-02-20T22:09:14.1157001Z          recent_timestamps = [ts for ts in user_timestamps if ts > hour_ago]
2026-02-20T22:09:14.1157606Z -        
2026-02-20T22:09:14.1157872Z +
2026-02-20T22:09:14.1158234Z          # Vérifier limite horaire
2026-02-20T22:09:14.1158702Z          if len(recent_timestamps) >= max_per_hour:
2026-02-20T22:09:14.1159535Z              return False, f"Limite horaire atteinte ({max_per_hour} générations/heure)"
2026-02-20T22:09:14.1160189Z -        
2026-02-20T22:09:14.1160447Z +
2026-02-20T22:09:14.1160895Z          # Filtrer les timestamps récents (dernières 24h)
2026-02-20T22:09:14.1161428Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1162021Z          daily_timestamps = [ts for ts in user_timestamps if ts > day_ago]
2026-02-20T22:09:14.1162605Z -        
2026-02-20T22:09:14.1162873Z +
2026-02-20T22:09:14.1163693Z          # Vérifier limite journalière
2026-02-20T22:09:14.1164190Z          if len(daily_timestamps) >= max_per_day:
2026-02-20T22:09:14.1165069Z -            return False, f"Limite journalière atteinte ({max_per_day} générations/jour)"
2026-02-20T22:09:14.1165785Z -        
2026-02-20T22:09:14.1166056Z +            return (
2026-02-20T22:09:14.1166370Z +                False,
2026-02-20T22:09:14.1167023Z +                f"Limite journalière atteinte ({max_per_day} générations/jour)",
2026-02-20T22:09:14.1167624Z +            )
2026-02-20T22:09:14.1167897Z +
2026-02-20T22:09:14.1168323Z          # Autoriser et enregistrer la génération
2026-02-20T22:09:14.1169188Z          # Stocker la liste filtrée à 24h (pas hourly) pour conserver la limite journalière
2026-02-20T22:09:14.1169929Z          daily_timestamps.append(now)
2026-02-20T22:09:14.1170478Z          self._user_generation_counts[user_id] = daily_timestamps
2026-02-20T22:09:14.1170997Z -        
2026-02-20T22:09:14.1171538Z +
2026-02-20T22:09:14.1171810Z          return True, None
2026-02-20T22:09:14.1172149Z -    
2026-02-20T22:09:14.1172406Z +
2026-02-20T22:09:14.1172689Z      def _cleanup_old_entries(self):
2026-02-20T22:09:14.1173483Z          """Nettoie les entrées de plus de 24h."""
2026-02-20T22:09:14.1174224Z          now = datetime.now()
2026-02-20T22:09:14.1174674Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1175125Z -        
2026-02-20T22:09:14.1175412Z +
2026-02-20T22:09:14.1175825Z          for user_id in list(self._user_generation_counts.keys()):
2026-02-20T22:09:14.1176508Z              timestamps = self._user_generation_counts[user_id]
2026-02-20T22:09:14.1177142Z              filtered = [ts for ts in timestamps if ts > day_ago]
2026-02-20T22:09:14.1177654Z -            
2026-02-20T22:09:14.1177927Z +
2026-02-20T22:09:14.1178216Z              if filtered:
2026-02-20T22:09:14.1178671Z                  self._user_generation_counts[user_id] = filtered
2026-02-20T22:09:14.1180516Z              else:
2026-02-20T22:09:14.1181001Z                  # Supprimer la clé si vide
2026-02-20T22:09:14.1181512Z                  del self._user_generation_counts[user_id]
2026-02-20T22:09:14.1181985Z -        
2026-02-20T22:09:14.1182643Z -        logger.debug(f"Nettoyage rate limiter: {len(self._user_generation_counts)} utilisateurs actifs")
2026-02-20T22:09:14.1183638Z -    
2026-02-20T22:09:14.1183897Z +
2026-02-20T22:09:14.1184163Z +        logger.debug(
2026-02-20T22:09:14.1184764Z +            f"Nettoyage rate limiter: {len(self._user_generation_counts)} utilisateurs actifs"
2026-02-20T22:09:14.1185466Z +        )
2026-02-20T22:09:14.1185730Z +
2026-02-20T22:09:14.1186111Z      def get_user_stats(self, user_id: int) -> Dict[str, int]:
2026-02-20T22:09:14.1186951Z          """Retourne les statistiques de génération d'un utilisateur."""
2026-02-20T22:09:14.1187549Z          now = datetime.now()
2026-02-20T22:09:14.1187978Z          hour_ago = now - timedelta(hours=1)
2026-02-20T22:09:14.1188459Z          day_ago = now - timedelta(days=1)
2026-02-20T22:09:14.1188873Z -        
2026-02-20T22:09:14.1189129Z +
2026-02-20T22:09:14.1189413Z          timestamps = self._user_generation_counts.get(user_id, [])
2026-02-20T22:09:14.1189522Z -        
2026-02-20T22:09:14.1189623Z +
2026-02-20T22:09:14.1189752Z          return {
2026-02-20T22:09:14.1190020Z              "last_hour": len([ts for ts in timestamps if ts > hour_ago]),
2026-02-20T22:09:14.1190276Z              "last_day": len([ts for ts in timestamps if ts > day_ago]),
2026-02-20T22:09:14.1190420Z              "total": len(timestamps),
2026-02-20T22:09:14.1190530Z          }
2026-02-20T22:09:14.1190633Z  
2026-02-20T22:09:14.1190733Z  
2026-02-20T22:09:14.1190885Z  # Instance globale du rate limiter
2026-02-20T22:09:14.1191026Z  rate_limiter = RateLimiter()
2026-02-20T22:09:14.1191130Z -
2026-02-20T22:09:14.1191556Z would reformat /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py
2026-02-20T22:09:14.1192074Z --- /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1192589Z +++ /home/runner/work/mathakine/mathakine/app/utils/settings_reader.py	2026-02-20 22:09:14.112945+00:00
2026-02-20T22:09:14.1192703Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.1192813Z  """
2026-02-20T22:09:14.1193332Z  Lecture des paramètres globaux (table settings).
2026-02-20T22:09:14.1193877Z  Utilisé par middleware et handlers pour maintenance_mode, registration_enabled, etc.
2026-02-20T22:09:14.1193994Z  """
2026-02-20T22:09:14.1194099Z +
2026-02-20T22:09:14.1194269Z  from app.models.setting import Setting
2026-02-20T22:09:14.1194442Z  from app.utils.db_utils import db_session
2026-02-20T22:09:14.1194545Z  
2026-02-20T22:09:14.1194646Z  
2026-02-20T22:09:14.1194953Z  async def get_setting_bool(key: str, default: bool = False) -> bool:
2026-02-20T22:09:14.1397315Z --- /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.1398171Z +++ /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py	2026-02-20 22:09:14.138919+00:00
2026-02-20T22:09:14.1398823Z @@ -1,13 +1,13 @@
2026-02-20T22:09:14.1399718Z  """
2026-02-20T22:09:14.1401029Z  Utilitaires SSE (Server-Sent Events) — DRY pour génération IA en streaming.
2026-02-20T22:09:14.1401557Z  """
2026-02-20T22:09:14.1402632Z +
2026-02-20T22:09:14.1403562Z  import json
2026-02-20T22:09:14.1404478Z  from typing import AsyncGenerator
2026-02-20T22:09:14.1406452Z  
2026-02-20T22:09:14.1407449Z  from starlette.responses import StreamingResponse
2026-02-20T22:09:14.1408580Z -
2026-02-20T22:09:14.1409479Z  
2026-02-20T22:09:14.1412411Z  SSE_HEADERS = {
2026-02-20T22:09:14.1412685Z      "Cache-Control": "no-cache",
2026-02-20T22:09:14.1412828Z      "Connection": "keep-alive",
2026-02-20T22:09:14.1412936Z  }
2026-02-20T22:09:14.1413216Z @@ -16,11 +16,13 @@
2026-02-20T22:09:14.1413564Z  async def sse_error_generator(message: str) -> AsyncGenerator[str, None]:
2026-02-20T22:09:14.1413957Z      """Générateur async SSE pour envoyer une erreur."""
2026-02-20T22:09:14.1414299Z      yield f"data: {json.dumps({'type': 'error', 'message': message})}\n\n"
2026-02-20T22:09:14.1414404Z  
2026-02-20T22:09:14.1414501Z  
2026-02-20T22:09:14.1414941Z -def sse_error_response(message: str, extra_headers: dict | None = None) -> StreamingResponse:
2026-02-20T22:09:14.1415075Z +def sse_error_response(
2026-02-20T22:09:14.1415262Z +    message: str, extra_headers: dict | None = None
2026-02-20T22:09:14.1415412Z +) -> StreamingResponse:
2026-02-20T22:09:14.1415707Z      """Retourne une StreamingResponse SSE avec un message d'erreur."""
2026-02-20T22:09:14.1415872Z      headers = dict(SSE_HEADERS)
2026-02-20T22:09:14.1416005Z      if extra_headers:
2026-02-20T22:09:14.1416172Z          headers.update(extra_headers)
2026-02-20T22:09:14.1416552Z would reformat /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py
2026-02-20T22:09:14.1416705Z      return StreamingResponse(
2026-02-20T22:09:14.1535526Z --- /home/runner/work/mathakine/mathakine/server/__init__.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.1536723Z +++ /home/runner/work/mathakine/mathakine/server/__init__.py	2026-02-20 22:09:14.152967+00:00
2026-02-20T22:09:14.1538939Z @@ -9,12 +9,12 @@
2026-02-20T22:09:14.1539438Z  from server.app import create_app, run_server
2026-02-20T22:09:14.1539914Z  from server.database import get_database_url, init_database
2026-02-20T22:09:14.1540335Z  from server.template_handler import render_error, render_template
2026-02-20T22:09:14.1540611Z  
2026-02-20T22:09:14.1542532Z  __all__ = [
2026-02-20T22:09:14.1543138Z -    'create_app',
2026-02-20T22:09:14.1543441Z -    'run_server',
2026-02-20T22:09:14.1543701Z -    'render_template',
2026-02-20T22:09:14.1543928Z -    'render_error',
2026-02-20T22:09:14.1544159Z -    'init_database',
2026-02-20T22:09:14.1544399Z -    'get_database_url',
2026-02-20T22:09:14.1544661Z -] 
2026-02-20T22:09:14.1544921Z \ No newline at end of file
2026-02-20T22:09:14.1545170Z +    "create_app",
2026-02-20T22:09:14.1545474Z +    "run_server",
2026-02-20T22:09:14.1545727Z +    "render_template",
2026-02-20T22:09:14.1546015Z +    "render_error",
2026-02-20T22:09:14.1546249Z +    "init_database",
2026-02-20T22:09:14.1546549Z +    "get_database_url",
2026-02-20T22:09:14.1546756Z +]
2026-02-20T22:09:14.1553334Z would reformat /home/runner/work/mathakine/mathakine/server/__init__.py
2026-02-20T22:09:14.2023250Z --- /home/runner/work/mathakine/mathakine/server/app.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.2023710Z +++ /home/runner/work/mathakine/mathakine/server/app.py	2026-02-20 22:09:14.200843+00:00
2026-02-20T22:09:14.2023852Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.2024023Z  App initialization for Mathakine.
2026-02-20T22:09:14.2024134Z  
2026-02-20T22:09:14.2024495Z  This module centralizes Starlette application creation and configuration.
2026-02-20T22:09:14.2024875Z  It ties together routes, middleware, exception handlers, and other components.
2026-02-20T22:09:14.2024986Z  """
2026-02-20T22:09:14.2025497Z +
2026-02-20T22:09:14.2025635Z  import os
2026-02-20T22:09:14.2025743Z  
2026-02-20T22:09:14.2025871Z  import uvicorn
2026-02-20T22:09:14.2026087Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.2026315Z  from app.core.monitoring import init_monitoring
2026-02-20T22:09:14.2026664Z @@ -21,14 +22,14 @@
2026-02-20T22:09:14.2026784Z  
2026-02-20T22:09:14.2026899Z  
2026-02-20T22:09:14.2027121Z  def create_app(debug: bool = False) -> Starlette:
2026-02-20T22:09:14.2027233Z      """
2026-02-20T22:09:14.2027454Z      Create and configure the Starlette application.
2026-02-20T22:09:14.2093445Z -    
2026-02-20T22:09:14.2093594Z +
2026-02-20T22:09:14.2093736Z      Args:
2026-02-20T22:09:14.2093922Z          debug: Whether to enable debug mode
2026-02-20T22:09:14.2094038Z -        
2026-02-20T22:09:14.2094164Z +
2026-02-20T22:09:14.2094284Z      Returns:
2026-02-20T22:09:14.2094460Z          Configured Starlette application
2026-02-20T22:09:14.2094565Z      """
2026-02-20T22:09:14.2094816Z      # Monitoring : Sentry + Prometheus (audit HIGH #1)
2026-02-20T22:09:14.2094950Z      init_monitoring()
2026-02-20T22:09:14.2095066Z @@ -37,48 +38,46 @@
2026-02-20T22:09:14.2095208Z      app = Starlette(
2026-02-20T22:09:14.2095332Z          debug=debug,
2026-02-20T22:09:14.2095466Z          routes=get_routes(),
2026-02-20T22:09:14.2095629Z          middleware=get_middleware(),
2026-02-20T22:09:14.2095852Z          exception_handlers=get_exception_handlers(),
2026-02-20T22:09:14.2095991Z -        on_startup=[startup]
2026-02-20T22:09:14.2096130Z +        on_startup=[startup],
2026-02-20T22:09:14.2096247Z      )
2026-02-20T22:09:14.2096357Z -    
2026-02-20T22:09:14.2096463Z +
2026-02-20T22:09:14.2096701Z      # Store templates in application state for API routes
2026-02-20T22:09:14.2096888Z      app.state.templates = get_templates()
2026-02-20T22:09:14.2096999Z -    
2026-02-20T22:09:14.2097106Z +
2026-02-20T22:09:14.2097233Z      return app
2026-02-20T22:09:14.2097338Z +
2026-02-20T22:09:14.2097454Z  
2026-02-20T22:09:14.2097591Z  async def startup():
2026-02-20T22:09:14.2097717Z      """
2026-02-20T22:09:14.2097910Z      Startup event handler for the application.
2026-02-20T22:09:14.2098022Z -    
2026-02-20T22:09:14.2098141Z +
2026-02-20T22:09:14.2098385Z      This function is called when the application starts.
2026-02-20T22:09:14.2098669Z      It initializes the database and performs other setup tasks.
2026-02-20T22:09:14.2098784Z      """
2026-02-20T22:09:14.2098991Z      logger.info("Starting up Mathakine server")
2026-02-20T22:09:14.2099119Z      init_database()
2026-02-20T22:09:14.2099225Z -    
2026-02-20T22:09:14.2099341Z +
2026-02-20T22:09:14.2100001Z      # Note: La migration email est désormais gérée via Alembic (migrations/versions/)
2026-02-20T22:09:14.2100351Z would reformat /home/runner/work/mathakine/mathakine/server/app.py
2026-02-20T22:09:14.2101066Z      # L'ancien script scripts/apply_email_verification_migration.py a été archivé dans _ARCHIVE_2026
2026-02-20T22:09:14.2101188Z -    
2026-02-20T22:09:14.2101318Z +
2026-02-20T22:09:14.2101565Z      logger.info("Mathakine server started successfully")
2026-02-20T22:09:14.2101683Z +
2026-02-20T22:09:14.2101791Z  
2026-02-20T22:09:14.2102122Z  def run_server(host: str = "0.0.0.0", port: int = 8000, debug: bool = False):
2026-02-20T22:09:14.2102268Z      """
2026-02-20T22:09:14.2102416Z      Run the Starlette server.
2026-02-20T22:09:14.2102522Z -    
2026-02-20T22:09:14.2102626Z +
2026-02-20T22:09:14.2102749Z      Args:
2026-02-20T22:09:14.2102882Z          host: Host to bind to
2026-02-20T22:09:14.2103548Z          port: Port to bind to
2026-02-20T22:09:14.2103749Z          debug: Whether to enable debug mode
2026-02-20T22:09:14.2103863Z      """
2026-02-20T22:09:14.2104173Z      log_level = os.environ.get("MATH_TRAINER_LOG_LEVEL", "INFO").lower()
2026-02-20T22:09:14.2104294Z -    
2026-02-20T22:09:14.2104403Z +
2026-02-20T22:09:14.2104758Z      logger.info(f"Starting Mathakine server on {host}:{port} (debug={debug})")
2026-02-20T22:09:14.2105135Z -    
2026-02-20T22:09:14.2105254Z +
2026-02-20T22:09:14.2105383Z      uvicorn.run(
2026-02-20T22:09:14.2105532Z -        "enhanced_server:app",
2026-02-20T22:09:14.2105660Z -        host=host,
2026-02-20T22:09:14.2105786Z -        port=port,
2026-02-20T22:09:14.2105915Z -        reload=debug,
2026-02-20T22:09:14.2106268Z -        log_level=log_level
2026-02-20T22:09:14.2106406Z -    ) 
2026-02-20T22:09:14.2106555Z \ No newline at end of file
2026-02-20T22:09:14.2106933Z +        "enhanced_server:app", host=host, port=port, reload=debug, log_level=log_level
2026-02-20T22:09:14.2107058Z +    )
2026-02-20T22:09:14.2113726Z --- /home/runner/work/mathakine/mathakine/app/utils/translation.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.2114376Z +++ /home/runner/work/mathakine/mathakine/app/utils/translation.py	2026-02-20 22:09:14.208535+00:00
2026-02-20T22:09:14.2114660Z @@ -11,164 +11,160 @@
2026-02-20T22:09:14.2114771Z  {
2026-02-20T22:09:14.2114921Z    "fr": ["Choix 1", "Choix 2"],
2026-02-20T22:09:14.2115074Z    "en": ["Choice 1", "Choice 2"]
2026-02-20T22:09:14.2115186Z  }
2026-02-20T22:09:14.2115302Z  """
2026-02-20T22:09:14.2115408Z +
2026-02-20T22:09:14.2115599Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:14.2115705Z  
2026-02-20T22:09:14.2115879Z  from app.core.config import settings
2026-02-20T22:09:14.2115997Z  
2026-02-20T22:09:14.2116104Z  
2026-02-20T22:09:14.2116254Z  def get_translated_text(
2026-02-20T22:09:14.2116429Z      translations: Optional[Dict[str, Any]],
2026-02-20T22:09:14.2116558Z      locale: str = "fr",
2026-02-20T22:09:14.2116698Z -    fallback_locale: str = "fr"
2026-02-20T22:09:14.2116849Z +    fallback_locale: str = "fr",
2026-02-20T22:09:14.2116982Z  ) -> Optional[str]:
2026-02-20T22:09:14.2117093Z      """
2026-02-20T22:09:14.2117574Z      Récupère le texte traduit depuis un objet JSONB de traductions.
2026-02-20T22:09:14.2117687Z -    
2026-02-20T22:09:14.2117796Z +
2026-02-20T22:09:14.2117911Z      Args:
2026-02-20T22:09:14.2118245Z          translations: Dictionnaire JSONB des traductions {locale: text}
2026-02-20T22:09:14.2118548Z          locale: Locale demandée (fr, en, etc.)
2026-02-20T22:09:14.2118855Z          fallback_locale: Locale de repli si la traduction n'existe pas
2026-02-20T22:09:14.2118977Z -    
2026-02-20T22:09:14.2119089Z +
2026-02-20T22:09:14.2119225Z      Returns:
2026-02-20T22:09:14.2119374Z          Texte traduit ou None
2026-02-20T22:09:14.2119498Z      """
2026-02-20T22:09:14.2119636Z      if not translations:
2026-02-20T22:09:14.2119760Z          return None
2026-02-20T22:09:14.2119880Z -    
2026-02-20T22:09:14.2119989Z +
2026-02-20T22:09:14.2120237Z      # Essayer la locale demandée
2026-02-20T22:09:14.2120472Z      if locale in translations and translations[locale]:
2026-02-20T22:09:14.2120633Z          return translations[locale]
2026-02-20T22:09:14.2120743Z -    
2026-02-20T22:09:14.2120849Z +
2026-02-20T22:09:14.2121112Z      # Fallback vers la locale par défaut
2026-02-20T22:09:14.2121448Z      if fallback_locale in translations and translations[fallback_locale]:
2026-02-20T22:09:14.2121642Z          return translations[fallback_locale]
2026-02-20T22:09:14.2121763Z -    
2026-02-20T22:09:14.2121872Z +
2026-02-20T22:09:14.2122181Z      # Fallback vers la première locale disponible
2026-02-20T22:09:14.2122310Z      if translations:
2026-02-20T22:09:14.2122508Z          first_locale = next(iter(translations))
2026-02-20T22:09:14.2122662Z          return translations[first_locale]
2026-02-20T22:09:14.2122765Z -    
2026-02-20T22:09:14.2122877Z +
2026-02-20T22:09:14.2123194Z      return None
2026-02-20T22:09:14.2123310Z  
2026-02-20T22:09:14.2123424Z  
2026-02-20T22:09:14.2123588Z  def get_translated_array(
2026-02-20T22:09:14.2123796Z      translations: Optional[Dict[str, List[str]]],
2026-02-20T22:09:14.2123934Z      locale: str = "fr",
2026-02-20T22:09:14.2124096Z -    fallback_locale: str = "fr"
2026-02-20T22:09:14.2124242Z +    fallback_locale: str = "fr",
2026-02-20T22:09:14.2124388Z  ) -> Optional[List[str]]:
2026-02-20T22:09:14.2124766Z      """
2026-02-20T22:09:14.2125227Z      Récupère un array traduit depuis un objet JSONB de traductions.
2026-02-20T22:09:14.2125347Z -    
2026-02-20T22:09:14.2125460Z +
2026-02-20T22:09:14.2125594Z      Args:
2026-02-20T22:09:14.2126139Z          translations: Dictionnaire JSONB des traductions {locale: [items]}
2026-02-20T22:09:14.2126401Z          locale: Locale demandée
2026-02-20T22:09:14.2126568Z          fallback_locale: Locale de repli
2026-02-20T22:09:14.2126687Z -    
2026-02-20T22:09:14.2126795Z +
2026-02-20T22:09:14.2126913Z      Returns:
2026-02-20T22:09:14.2127070Z          Liste traduite ou None
2026-02-20T22:09:14.2127185Z      """
2026-02-20T22:09:14.2127323Z      if not translations:
2026-02-20T22:09:14.2127448Z          return None
2026-02-20T22:09:14.2127568Z -    
2026-02-20T22:09:14.2127679Z +
2026-02-20T22:09:14.2127918Z      if locale in translations and translations[locale]:
2026-02-20T22:09:14.2128087Z          return translations[locale]
2026-02-20T22:09:14.2128216Z -    
2026-02-20T22:09:14.2128325Z +
2026-02-20T22:09:14.2128663Z      if fallback_locale in translations and translations[fallback_locale]:
2026-02-20T22:09:14.2128855Z          return translations[fallback_locale]
2026-02-20T22:09:14.2128968Z -    
2026-02-20T22:09:14.2129077Z +
2026-02-20T22:09:14.2129234Z      if translations:
2026-02-20T22:09:14.2129413Z          first_locale = next(iter(translations))
2026-02-20T22:09:14.2129574Z          return translations[first_locale]
2026-02-20T22:09:14.2129683Z -    
2026-02-20T22:09:14.2129800Z +
2026-02-20T22:09:14.2129925Z      return None
2026-02-20T22:09:14.2130032Z  
2026-02-20T22:09:14.2130147Z  
2026-02-20T22:09:14.2130301Z  def build_translations_dict(
2026-02-20T22:09:14.2130443Z -    fr_text: Optional[str],
2026-02-20T22:09:14.2130592Z -    en_text: Optional[str] = None,
2026-02-20T22:09:14.2130731Z -    **other_locales
2026-02-20T22:09:14.2131055Z +    fr_text: Optional[str], en_text: Optional[str] = None, **other_locales
2026-02-20T22:09:14.2131204Z  ) -> Dict[str, Any]:
2026-02-20T22:09:14.2131331Z      """
2026-02-20T22:09:14.2131649Z      Construit un dictionnaire de traductions pour insertion en JSONB.
2026-02-20T22:09:14.2131761Z -    
2026-02-20T22:09:14.2131870Z +
2026-02-20T22:09:14.2131999Z      Args:
2026-02-20T22:09:14.2132324Z          fr_text: Texte français (obligatoire)
2026-02-20T22:09:14.2132498Z          en_text: Texte anglais (optionnel)
2026-02-20T22:09:14.2132903Z          **other_locales: Autres langues (ex: es="Texto en español")
2026-02-20T22:09:14.2133227Z -    
2026-02-20T22:09:14.2133351Z +
2026-02-20T22:09:14.2133482Z      Returns:
2026-02-20T22:09:14.2133637Z          Dictionnaire de traductions
2026-02-20T22:09:14.2133748Z -    
2026-02-20T22:09:14.2133860Z +
2026-02-20T22:09:14.2133989Z      Example:
2026-02-20T22:09:14.2134253Z          >>> build_translations_dict("Bonjour", "Hello", es="Hola")
2026-02-20T22:09:14.2134441Z          {"fr": "Bonjour", "en": "Hello", "es": "Hola"}
2026-02-20T22:09:14.2134565Z      """
2026-02-20T22:09:14.2134731Z      translations = {"fr": fr_text}
2026-02-20T22:09:14.2134845Z -    
2026-02-20T22:09:14.2134955Z +
2026-02-20T22:09:14.2135085Z      if en_text:
2026-02-20T22:09:14.2135233Z          translations["en"] = en_text
2026-02-20T22:09:14.2135342Z -    
2026-02-20T22:09:14.2135459Z +
2026-02-20T22:09:14.2135643Z      translations.update(other_locales)
2026-02-20T22:09:14.2135748Z -    
2026-02-20T22:09:14.2135856Z +
2026-02-20T22:09:14.2136001Z      return translations
2026-02-20T22:09:14.2136106Z  
2026-02-20T22:09:14.2136217Z  
2026-02-20T22:09:14.2136384Z  def build_translations_array(
2026-02-20T22:09:14.2136536Z -    fr_array: Optional[List[str]],
2026-02-20T22:09:14.2136700Z -    en_array: Optional[List[str]] = None,
2026-02-20T22:09:14.2136834Z -    **other_locales
2026-02-20T22:09:14.2137220Z +    fr_array: Optional[List[str]], en_array: Optional[List[str]] = None, **other_locales
2026-02-20T22:09:14.2137368Z  ) -> Dict[str, List[str]]:
2026-02-20T22:09:14.2137480Z      """
2026-02-20T22:09:14.2137976Z      Construit un dictionnaire de traductions pour arrays.
2026-02-20T22:09:14.2138094Z -    
2026-02-20T22:09:14.2138204Z +
2026-02-20T22:09:14.2138326Z      Args:
2026-02-20T22:09:14.2138636Z          fr_array: Array français (obligatoire)
2026-02-20T22:09:14.2139027Z          en_array: Array anglais (optionnel)
2026-02-20T22:09:14.2139500Z          **other_locales: Autres langues (ex: es=["Opción 1", "Opción 2"])
2026-02-20T22:09:14.2139626Z -    
2026-02-20T22:09:14.2139736Z +
2026-02-20T22:09:14.2139856Z      Returns:
2026-02-20T22:09:14.2140048Z          Dictionnaire de traductions pour arrays
2026-02-20T22:09:14.2140155Z -    
2026-02-20T22:09:14.2140265Z +
2026-02-20T22:09:14.2140380Z      Example:
2026-02-20T22:09:14.2140746Z          >>> build_translations_array(["Choix 1", "Choix 2"], ["Choice 1", "Choice 2"])
2026-02-20T22:09:14.2140993Z          {"fr": ["Choix 1", "Choix 2"], "en": ["Choice 1", "Choice 2"]}
2026-02-20T22:09:14.2141112Z      """
2026-02-20T22:09:14.2141294Z      translations = {"fr": fr_array}
2026-02-20T22:09:14.2141406Z -    
2026-02-20T22:09:14.2141518Z +
2026-02-20T22:09:14.2141652Z      if en_array:
2026-02-20T22:09:14.2141803Z          translations["en"] = en_array
2026-02-20T22:09:14.2141911Z -    
2026-02-20T22:09:14.2142021Z +
2026-02-20T22:09:14.2142206Z      translations.update(other_locales)
2026-02-20T22:09:14.2142314Z -    
2026-02-20T22:09:14.2142419Z +
2026-02-20T22:09:14.2142565Z      return translations
2026-02-20T22:09:14.2142673Z  
2026-02-20T22:09:14.2142779Z  
2026-02-20T22:09:14.2163383Z  def parse_accept_language(accept_language: Optional[str]) -> str:
2026-02-20T22:09:14.2163533Z      """
2026-02-20T22:09:14.2164030Z      Parse le header Accept-Language et retourne la locale préférée.
2026-02-20T22:09:14.2164150Z -    
2026-02-20T22:09:14.2164275Z +
2026-02-20T22:09:14.2164392Z      Args:
2026-02-20T22:09:14.2164748Z          accept_language: Header Accept-Language (ex: "en-US,en;q=0.9,fr;q=0.8")
2026-02-20T22:09:14.2164855Z -    
2026-02-20T22:09:14.2164990Z +
2026-02-20T22:09:14.2165108Z      Returns:
2026-02-20T22:09:14.2165464Z          Locale préférée (fr, en, etc.) ou "fr" par défaut
2026-02-20T22:09:14.2165587Z      """
2026-02-20T22:09:14.2165736Z      if not accept_language:
2026-02-20T22:09:14.2165861Z          return "fr"
2026-02-20T22:09:14.2165987Z -    
2026-02-20T22:09:14.2166107Z +
2026-02-20T22:09:14.2166454Z      # Extraire la première locale (la plus préférée)
2026-02-20T22:09:14.2166763Z      first_locale = accept_language.split(",")[0].split(";")[0].strip()
2026-02-20T22:09:14.2166892Z -    
2026-02-20T22:09:14.2167001Z +
2026-02-20T22:09:14.2167216Z      # Extraire le code langue (ex: "en-US" -> "en")
2026-02-20T22:09:14.2167418Z      lang_code = first_locale.split("-")[0].lower()
2026-02-20T22:09:14.2167538Z -    
2026-02-20T22:09:14.2167643Z +
2026-02-20T22:09:14.2167942Z      # Valider que c'est une locale supportée
2026-02-20T22:09:14.2168110Z      supported_locales = ["fr", "en"]
2026-02-20T22:09:14.2168241Z -    
2026-02-20T22:09:14.2168351Z +
2026-02-20T22:09:14.2168518Z      if lang_code in supported_locales:
2026-02-20T22:09:14.2168660Z          return lang_code
2026-02-20T22:09:14.2168769Z -    
2026-02-20T22:09:14.2168876Z +
2026-02-20T22:09:14.2169002Z      return "fr"
2026-02-20T22:09:14.2169109Z -
2026-02-20T22:09:14.2169525Z would reformat /home/runner/work/mathakine/mathakine/app/utils/translation.py
2026-02-20T22:09:14.2857220Z --- /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py	2026-02-20 22:09:02.812965+00:00
2026-02-20T22:09:14.2859955Z +++ /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py	2026-02-20 22:09:14.282978+00:00
2026-02-20T22:09:14.2870658Z @@ -1,9 +1,10 @@
2026-02-20T22:09:14.2870992Z  """
2026-02-20T22:09:14.2871396Z  Module de tracking de l'utilisation des tokens OpenAI.
2026-02-20T22:09:14.2872325Z  Permet de monitorer les coûts et l'utilisation de l'API.
2026-02-20T22:09:14.2872878Z  """
2026-02-20T22:09:14.2873330Z +
2026-02-20T22:09:14.2873588Z  import json
2026-02-20T22:09:14.2874285Z  from collections import defaultdict
2026-02-20T22:09:14.2874771Z  from datetime import datetime
2026-02-20T22:09:14.2876525Z  from typing import Dict, Optional
2026-02-20T22:09:14.2878159Z  
2026-02-20T22:09:14.2879665Z @@ -12,168 +13,174 @@
2026-02-20T22:09:14.2881511Z  logger = get_logger(__name__)
2026-02-20T22:09:14.2882133Z  
2026-02-20T22:09:14.2882538Z  
2026-02-20T22:09:14.2882927Z  class TokenTracker:
2026-02-20T22:09:14.2884214Z      """Tracker simple en mémoire pour l'utilisation des tokens (peut être migré vers DB)."""
2026-02-20T22:09:14.2888356Z -    
2026-02-20T22:09:14.2888791Z +
2026-02-20T22:09:14.2889274Z      def __init__(self):
2026-02-20T22:09:14.2891053Z          # Structure: {challenge_type: [{"timestamp": datetime, "tokens": int, "cost": float}]}
2026-02-20T22:09:14.2892123Z would reformat /home/runner/work/mathakine/mathakine/app/utils/token_tracker.py
2026-02-20T22:09:14.2893323Z          self._usage_history: Dict[str, list] = defaultdict(list)
2026-02-20T22:09:14.2895852Z -        self._daily_totals: Dict[str, Dict] = defaultdict(lambda: {"tokens": 0, "cost": 0.0})
2026-02-20T22:09:14.2896585Z -    
2026-02-20T22:09:14.2896979Z +        self._daily_totals: Dict[str, Dict] = defaultdict(
2026-02-20T22:09:14.2897544Z +            lambda: {"tokens": 0, "cost": 0.0}
2026-02-20T22:09:14.2898004Z +        )
2026-02-20T22:09:14.2898275Z +
2026-02-20T22:09:14.2898559Z      def track_usage(
2026-02-20T22:09:14.2898883Z          self,
2026-02-20T22:09:14.2899196Z          challenge_type: str,
2026-02-20T22:09:14.2899587Z          prompt_tokens: int,
2026-02-20T22:09:14.2899991Z          completion_tokens: int,
2026-02-20T22:09:14.2900406Z -        model: str = "gpt-4o-mini"
2026-02-20T22:09:14.2900847Z +        model: str = "gpt-4o-mini",
2026-02-20T22:09:14.2901270Z      ) -> Dict[str, float]:
2026-02-20T22:09:14.2901628Z          """
2026-02-20T22:09:14.2902178Z          Track l'utilisation de tokens pour une génération.
2026-02-20T22:09:14.2902690Z -        
2026-02-20T22:09:14.2903174Z +
2026-02-20T22:09:14.2903441Z          Args:
2026-02-20T22:09:14.2903963Z              challenge_type: Type de challenge généré
2026-02-20T22:09:14.2904542Z              prompt_tokens: Nombre de tokens dans le prompt
2026-02-20T22:09:14.2905339Z              completion_tokens: Nombre de tokens dans la réponse
2026-02-20T22:09:14.2906017Z              model: Modèle OpenAI utilisé
2026-02-20T22:09:14.2906468Z -            
2026-02-20T22:09:14.2906768Z +
2026-02-20T22:09:14.2907025Z          Returns:
2026-02-20T22:09:14.2907634Z              Dict avec 'tokens' (total) et 'cost' (coût estimé en USD)
2026-02-20T22:09:14.2908178Z          """
2026-02-20T22:09:14.2908573Z          total_tokens = prompt_tokens + completion_tokens
2026-02-20T22:09:14.2909067Z -        
2026-02-20T22:09:14.2909337Z +
2026-02-20T22:09:14.2909948Z          # Coûts par modèle (USD par 1K tokens) - Mise à jour janvier 2025
2026-02-20T22:09:14.2910628Z          # Source: https://openai.com/pricing
2026-02-20T22:09:14.2911209Z          cost_per_1k_tokens = {
2026-02-20T22:09:14.2911613Z              "gpt-4o-mini": {
2026-02-20T22:09:14.2912127Z -                "input": 0.15 / 1000,   # $0.15 per 1M tokens = $0.00015 per 1K
2026-02-20T22:09:14.2912810Z +                "input": 0.15 / 1000,  # $0.15 per 1M tokens = $0.00015 per 1K
2026-02-20T22:09:14.2913681Z                  "output": 0.60 / 1000,  # $0.60 per 1M tokens = $0.0006 per 1K
2026-02-20T22:09:14.2914226Z              },
2026-02-20T22:09:14.2914539Z              "gpt-4o": {
2026-02-20T22:09:14.2915014Z -                "input": 2.50 / 1000,   # $2.50 per 1M tokens = $0.0025 per 1K
2026-02-20T22:09:14.2915694Z -                "output": 10.00 / 1000, # $10.00 per 1M tokens = $0.01 per 1K
2026-02-20T22:09:14.2916369Z +                "input": 2.50 / 1000,  # $2.50 per 1M tokens = $0.0025 per 1K
2026-02-20T22:09:14.2917041Z +                "output": 10.00 / 1000,  # $10.00 per 1M tokens = $0.01 per 1K
2026-02-20T22:09:14.2917594Z              },
2026-02-20T22:09:14.2918171Z              "gpt-4-turbo": {
2026-02-20T22:09:14.2918634Z                  "input": 10.00 / 1000,  # $10.00 per 1M tokens
2026-02-20T22:09:14.2919186Z -                "output": 30.00 / 1000, # $30.00 per 1M tokens
2026-02-20T22:09:14.2919961Z +                "output": 30.00 / 1000,  # $30.00 per 1M tokens
2026-02-20T22:09:14.2920470Z              },
2026-02-20T22:09:14.2920755Z          }
2026-02-20T22:09:14.2921034Z -        
2026-02-20T22:09:14.2921305Z +
2026-02-20T22:09:14.2921708Z          # Calculer le coût
2026-02-20T22:09:14.2922323Z          model_costs = cost_per_1k_tokens.get(model, cost_per_1k_tokens["gpt-4o-mini"])
2026-02-20T22:09:14.2925609Z -        cost = (prompt_tokens / 1000 * model_costs["input"]) + (completion_tokens / 1000 * model_costs["output"])
2026-02-20T22:09:14.2926448Z -        
2026-02-20T22:09:14.2926885Z +        cost = (prompt_tokens / 1000 * model_costs["input"]) + (
2026-02-20T22:09:14.2927542Z +            completion_tokens / 1000 * model_costs["output"]
2026-02-20T22:09:14.2928060Z +        )
2026-02-20T22:09:14.2928331Z +
2026-02-20T22:09:14.2928621Z          # Enregistrer l'utilisation
2026-02-20T22:09:14.2929049Z          usage_record = {
2026-02-20T22:09:14.2929437Z              "timestamp": datetime.now(),
2026-02-20T22:09:14.2929930Z              "prompt_tokens": prompt_tokens,
2026-02-20T22:09:14.2930434Z              "completion_tokens": completion_tokens,
2026-02-20T22:09:14.2930939Z              "total_tokens": total_tokens,
2026-02-20T22:09:14.2931377Z              "cost": cost,
2026-02-20T22:09:14.2931728Z              "model": model,
2026-02-20T22:09:14.2932075Z          }
2026-02-20T22:09:14.2932341Z -        
2026-02-20T22:09:14.2932609Z +
2026-02-20T22:09:14.2933201Z          self._usage_history[challenge_type].append(usage_record)
2026-02-20T22:09:14.2933756Z -        
2026-02-20T22:09:14.2934027Z +
2026-02-20T22:09:14.2934490Z          # Mettre à jour les totaux quotidiens
2026-02-20T22:09:14.2934975Z          today = datetime.now().date()
2026-02-20T22:09:14.2935463Z          day_key = f"{challenge_type}_{today}"
2026-02-20T22:09:14.2936021Z          self._daily_totals[day_key]["tokens"] += total_tokens
2026-02-20T22:09:14.2936616Z          self._daily_totals[day_key]["cost"] += cost
2026-02-20T22:09:14.2937094Z -        
2026-02-20T22:09:14.2937367Z +
2026-02-20T22:09:14.2937659Z          logger.info(
2026-02-20T22:09:14.2938096Z              f"Token usage tracked - Type: {challenge_type}, "
2026-02-20T22:09:14.2938926Z              f"Tokens: {total_tokens} (prompt: {prompt_tokens}, completion: {completion_tokens}), "
2026-02-20T22:09:14.2939720Z              f"Cost: ${cost:.6f}, Model: {model}"
2026-02-20T22:09:14.2940175Z          )
2026-02-20T22:09:14.2940452Z -        
2026-02-20T22:09:14.2940712Z +
2026-02-20T22:09:14.2940972Z          return {
2026-02-20T22:09:14.2941292Z              "tokens": total_tokens,
2026-02-20T22:09:14.2941718Z              "cost": cost,
2026-02-20T22:09:14.2942122Z              "prompt_tokens": prompt_tokens,
2026-02-20T22:09:14.2942653Z              "completion_tokens": completion_tokens,
2026-02-20T22:09:14.2943297Z          }
2026-02-20T22:09:14.2943577Z -    
2026-02-20T22:09:14.2943841Z +
2026-02-20T22:09:14.2944366Z      def get_stats(self, challenge_type: Optional[str] = None, days: int = 1) -> Dict:
2026-02-20T22:09:14.2945059Z          """
2026-02-20T22:09:14.2945411Z          Retourne les statistiques d'utilisation.
2026-02-20T22:09:14.2945884Z -        
2026-02-20T22:09:14.2946158Z +
2026-02-20T22:09:14.2946422Z          Args:
2026-02-20T22:09:14.2946836Z              challenge_type: Type de challenge (None pour tous)
2026-02-20T22:09:14.2947568Z              days: Nombre de jours à considérer
2026-02-20T22:09:14.2948016Z -            
2026-02-20T22:09:14.2948311Z +
2026-02-20T22:09:14.2948569Z          Returns:
2026-02-20T22:09:14.2949047Z              Dict avec statistiques agrégées
2026-02-20T22:09:14.2949486Z          """
2026-02-20T22:09:14.2949813Z          from datetime import timedelta
2026-02-20T22:09:14.2950560Z -        
2026-02-20T22:09:14.2950829Z +
2026-02-20T22:09:14.2951212Z          cutoff_date = datetime.now() - timedelta(days=days)
2026-02-20T22:09:14.2951716Z -        
2026-02-20T22:09:14.2951992Z +
2026-02-20T22:09:14.2952266Z          if challenge_type:
2026-02-20T22:09:14.2952865Z              records = [
2026-02-20T22:09:14.2953651Z -                r for r in self._usage_history[challenge_type]
2026-02-20T22:09:14.2955953Z +                r
2026-02-20T22:09:14.2958706Z +                for r in self._usage_history[challenge_type]
2026-02-20T22:09:14.2959323Z                  if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.2959790Z              ]
2026-02-20T22:09:14.2960091Z          else:
2026-02-20T22:09:14.2960402Z              # Tous les types
2026-02-20T22:09:14.2960777Z              records = []
2026-02-20T22:09:14.2961236Z              for type_records in self._usage_history.values():
2026-02-20T22:09:14.2961767Z -                records.extend([
2026-02-20T22:09:14.2962212Z -                    r for r in type_records
2026-02-20T22:09:14.2962680Z -                    if r["timestamp"] > cutoff_date
2026-02-20T22:09:14.2963342Z -                ])
2026-02-20T22:09:14.2963665Z -        
2026-02-20T22:09:14.2963962Z +                records.extend(
2026-02-20T22:09:14.2964502Z +                    [r for r in type_records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.2965064Z +                )
2026-02-20T22:09:14.2965358Z +
2026-02-20T22:09:14.2965626Z          if not records:
2026-02-20T22:09:14.2965980Z              return {
2026-02-20T22:09:14.2966325Z                  "total_tokens": 0,
2026-02-20T22:09:14.2966742Z                  "total_cost": 0.0,
2026-02-20T22:09:14.2967165Z                  "average_tokens": 0,
2026-02-20T22:09:14.2967576Z                  "count": 0,
2026-02-20T22:09:14.2967931Z              }
2026-02-20T22:09:14.2968216Z -        
2026-02-20T22:09:14.2968500Z +
2026-02-20T22:09:14.2968882Z          total_tokens = sum(r["total_tokens"] for r in records)
2026-02-20T22:09:14.2969502Z          total_cost = sum(r["cost"] for r in records)
2026-02-20T22:09:14.2970046Z          average_tokens = total_tokens / len(records)
2026-02-20T22:09:14.2970520Z -        
2026-02-20T22:09:14.2970788Z +
2026-02-20T22:09:14.2971033Z          return {
2026-02-20T22:09:14.2971374Z              "total_tokens": total_tokens,
2026-02-20T22:09:14.2971830Z              "total_cost": total_cost,
2026-02-20T22:09:14.2972283Z              "average_tokens": average_tokens,
2026-02-20T22:09:14.2972742Z              "count": len(records),
2026-02-20T22:09:14.2973593Z -            "by_type": self._get_stats_by_type(cutoff_date) if not challenge_type else {},
2026-02-20T22:09:14.2976387Z +            "by_type": (
2026-02-20T22:09:14.2992114Z +                self._get_stats_by_type(cutoff_date) if not challenge_type else {}
2026-02-20T22:09:14.2992765Z +            ),
2026-02-20T22:09:14.2993352Z          }
2026-02-20T22:09:14.2993632Z -    
2026-02-20T22:09:14.2993885Z +
2026-02-20T22:09:14.2994362Z      def _get_stats_by_type(self, cutoff_date: datetime) -> Dict[str, Dict]:
2026-02-20T22:09:14.2995205Z          """Retourne les stats groupées par type."""
2026-02-20T22:09:14.2995729Z          stats_by_type = {}
2026-02-20T22:09:14.2996070Z -        
2026-02-20T22:09:14.2996337Z +
2026-02-20T22:09:14.2996776Z          for challenge_type, records in self._usage_history.items():
2026-02-20T22:09:14.2997520Z              filtered = [r for r in records if r["timestamp"] > cutoff_date]
2026-02-20T22:09:14.2998114Z              if filtered:
2026-02-20T22:09:14.2998517Z                  stats_by_type[challenge_type] = {
2026-02-20T22:09:14.3003834Z                      "total_tokens": sum(r["total_tokens"] for r in filtered),
2026-02-20T22:09:14.3004537Z                      "total_cost": sum(r["cost"] for r in filtered),
2026-02-20T22:09:14.3005104Z                      "count": len(filtered),
2026-02-20T22:09:14.3005794Z -                    "average_tokens": sum(r["total_tokens"] for r in filtered) / len(filtered),
2026-02-20T22:09:14.3006929Z +                    "average_tokens": sum(r["total_tokens"] for r in filtered)
2026-02-20T22:09:14.3007534Z +                    / len(filtered),
2026-02-20T22:09:14.3007933Z                  }
2026-02-20T22:09:14.3008247Z -        
2026-02-20T22:09:14.3008515Z +
2026-02-20T22:09:14.3009022Z          return stats_by_type
2026-02-20T22:09:14.3009400Z -    
2026-02-20T22:09:14.3009668Z +
2026-02-20T22:09:14.3010129Z      def get_daily_summary(self, date: Optional[datetime] = None) -> Dict:
2026-02-20T22:09:14.3010993Z          """Retourne un résumé quotidien."""
2026-02-20T22:09:14.3011438Z          if date is None:
2026-02-20T22:09:14.3011821Z              date = datetime.now()
2026-02-20T22:09:14.3012215Z -        
2026-02-20T22:09:14.3012486Z +
2026-02-20T22:09:14.3012771Z          date_key = date.date()
2026-02-20T22:09:14.3013359Z          summary = {}
2026-02-20T22:09:14.3013700Z -        
2026-02-20T22:09:14.3013970Z +
2026-02-20T22:09:14.3014350Z          for key, totals in self._daily_totals.items():
2026-02-20T22:09:14.3014855Z              if str(date_key) in key:
2026-02-20T22:09:14.3015335Z                  challenge_type = key.split("_")[0]
2026-02-20T22:09:14.3015852Z                  summary[challenge_type] = totals
2026-02-20T22:09:14.3016314Z -        
2026-02-20T22:09:14.3016589Z +
2026-02-20T22:09:14.3016858Z          return summary
2026-02-20T22:09:14.3017194Z  
2026-02-20T22:09:14.3017447Z  
2026-02-20T22:09:14.3017740Z  # Instance globale du tracker
2026-02-20T22:09:14.3018151Z  token_tracker = TokenTracker()
2026-02-20T22:09:14.3018535Z -
2026-02-20T22:09:14.3019067Z would reformat /home/runner/work/mathakine/mathakine/server/database.py
2026-02-20T22:09:14.3020021Z --- /home/runner/work/mathakine/mathakine/server/database.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3021114Z +++ /home/runner/work/mathakine/mathakine/server/database.py	2026-02-20 22:09:14.297372+00:00
2026-02-20T22:09:14.3021875Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.3022311Z  Database initialization and management for Mathakine.
2026-02-20T22:09:14.3022816Z  
2026-02-20T22:09:14.3023473Z  This module centralizes database operations for the enhanced server,
2026-02-20T22:09:14.3024317Z  providing initialization, connection management, and utility functions.
2026-02-20T22:09:14.3024955Z  """
2026-02-20T22:09:14.3025211Z +
2026-02-20T22:09:14.3025464Z  import os
2026-02-20T22:09:14.3025750Z  import sys
2026-02-20T22:09:14.3026045Z  import traceback
2026-02-20T22:09:14.3026346Z  
2026-02-20T22:09:14.3026607Z  import psycopg2
2026-02-20T22:09:14.3026914Z @@ -18,39 +19,45 @@
2026-02-20T22:09:14.3027219Z  
2026-02-20T22:09:14.3027867Z  # Charger les variables d'environnement (ignorer .env en prod - sécurité)
2026-02-20T22:09:14.3028609Z  if os.environ.get("ENVIRONMENT") != "production":
2026-02-20T22:09:14.3029127Z      load_dotenv(override=False)
2026-02-20T22:09:14.3029522Z  
2026-02-20T22:09:14.3029773Z +
2026-02-20T22:09:14.3030063Z  def get_database_url() -> str:
2026-02-20T22:09:14.3030463Z      """
2026-02-20T22:09:14.3030847Z      Get the database URL from environment variables.
2026-02-20T22:09:14.3031340Z -    
2026-02-20T22:09:14.3031607Z +
2026-02-20T22:09:14.3031865Z      Returns:
2026-02-20T22:09:14.3032178Z          Database URL as a string
2026-02-20T22:09:14.3032574Z      """
2026-02-20T22:09:14.3033202Z      # Essayer d'abord la variable d'environnement DATABASE_URL
2026-02-20T22:09:14.3033832Z      db_url = os.environ.get("DATABASE_URL", "")
2026-02-20T22:09:14.3034277Z -    
2026-02-20T22:09:14.3034555Z +
2026-02-20T22:09:14.3035152Z      # Si pas définie, construire depuis les variables individuelles
2026-02-20T22:09:14.3035756Z      if not db_url:
2026-02-20T22:09:14.3036245Z          postgres_server = os.getenv("POSTGRES_SERVER", "localhost")
2026-02-20T22:09:14.3036958Z          postgres_user = os.getenv("POSTGRES_USER", "postgres")
2026-02-20T22:09:14.3037691Z          postgres_password = os.getenv("POSTGRES_PASSWORD", "postgres")
2026-02-20T22:09:14.3038665Z          postgres_db = os.getenv("POSTGRES_DB", "mathakine")
2026-02-20T22:09:14.3039520Z          db_url = f"postgresql://{postgres_user}:{postgres_password}@{postgres_server}/{postgres_db}"
2026-02-20T22:09:14.3040941Z -        logger.info(f"Using default DATABASE_URL: postgresql://{postgres_user}:***@{postgres_server}/{postgres_db}")
2026-02-20T22:09:14.3041852Z -    
2026-02-20T22:09:14.3042149Z +        logger.info(
2026-02-20T22:09:14.3042858Z +            f"Using default DATABASE_URL: postgresql://{postgres_user}:***@{postgres_server}/{postgres_db}"
2026-02-20T22:09:14.3043900Z +        )
2026-02-20T22:09:14.3044187Z +
2026-02-20T22:09:14.3044466Z      if not db_url:
2026-02-20T22:09:14.3045106Z -        logger.error("DATABASE_URL environment variable not set and no defaults available")
2026-02-20T22:09:14.3045873Z +        logger.error(
2026-02-20T22:09:14.3046442Z +            "DATABASE_URL environment variable not set and no defaults available"
2026-02-20T22:09:14.3047068Z +        )
2026-02-20T22:09:14.3047379Z          sys.exit(1)
2026-02-20T22:09:14.3047692Z -    
2026-02-20T22:09:14.3047971Z +
2026-02-20T22:09:14.3048234Z      return db_url
2026-02-20T22:09:14.3048536Z +
2026-02-20T22:09:14.3048782Z  
2026-02-20T22:09:14.3049062Z  def get_db_connection():
2026-02-20T22:09:14.3049409Z      """
2026-02-20T22:09:14.3049985Z      Obtient une connexion à la base de données PostgreSQL.
2026-02-20T22:09:14.3050512Z -    
2026-02-20T22:09:14.3050792Z +
2026-02-20T22:09:14.3051055Z      Returns:
2026-02-20T22:09:14.3051371Z          Une connexion psycopg2
2026-02-20T22:09:14.3051746Z      """
2026-02-20T22:09:14.3052011Z      try:
2026-02-20T22:09:14.3052368Z          conn = psycopg2.connect(get_database_url())
2026-02-20T22:09:14.3052841Z @@ -58,24 +65,25 @@
2026-02-20T22:09:14.3053500Z          return conn
2026-02-20T22:09:14.3053850Z      except Exception as e:
2026-02-20T22:09:14.3054512Z          logger.error(f"Erreur de connexion à PostgreSQL: {e}")
2026-02-20T22:09:14.3055038Z          raise e
2026-02-20T22:09:14.3055341Z  
2026-02-20T22:09:14.3055605Z +
2026-02-20T22:09:14.3055872Z  def init_database():
2026-02-20T22:09:14.3056195Z      """
2026-02-20T22:09:14.3056513Z      Initialize the database if necessary.
2026-02-20T22:09:14.3056945Z -    
2026-02-20T22:09:14.3057199Z +
2026-02-20T22:09:14.3057593Z      This function creates tables if they don't exist and
2026-02-20T22:09:14.3058153Z      performs other initialization tasks.
2026-02-20T22:09:14.3058599Z      """
2026-02-20T22:09:14.3058912Z      logger.info("Initializing database")
2026-02-20T22:09:14.3059344Z -    
2026-02-20T22:09:14.3059610Z +
2026-02-20T22:09:14.3059876Z      try:
2026-02-20T22:09:14.3060195Z          # Get a database connection
2026-02-20T22:09:14.3060639Z          conn = get_db_connection()
2026-02-20T22:09:14.3061067Z          cursor = conn.cursor()
2026-02-20T22:09:14.3061434Z -        
2026-02-20T22:09:14.3061717Z +
2026-02-20T22:09:14.3061972Z          try:
2026-02-20T22:09:14.3062350Z              # Create exercises table if it doesn't exist
2026-02-20T22:09:14.3062947Z              cursor.execute(ExerciseQueries.CREATE_TABLE)
2026-02-20T22:09:14.3063771Z  
2026-02-20T22:09:14.3064117Z              # Add ai_generated column if it doesn't exist
2026-02-20T22:09:14.3064610Z @@ -85,27 +93,28 @@
2026-02-20T22:09:14.3064940Z                  """)
2026-02-20T22:09:14.3065279Z                  conn.commit()
2026-02-20T22:09:14.3065688Z              except Exception as e:
2026-02-20T22:09:14.3066138Z                  logger.warning(f"Note: {str(e)}")
2026-02-20T22:09:14.3066624Z                  conn.rollback()
2026-02-20T22:09:14.3066986Z -                
2026-02-20T22:09:14.3067289Z +
2026-02-20T22:09:14.3067670Z              # Update existing exercises that contain the AI prefix
2026-02-20T22:09:14.3068302Z              from app.core.constants import Messages
2026-02-20T22:09:14.3068775Z +
2026-02-20T22:09:14.3069019Z              try:
2026-02-20T22:09:14.3069335Z                  cursor.execute(f"""
2026-02-20T22:09:14.3070037Z                  UPDATE exercises
2026-02-20T22:09:14.3070464Z                  SET ai_generated = TRUE
2026-02-20T22:09:14.3071253Z                  WHERE title LIKE '%{Messages.AI_EXERCISE_PREFIX}%' OR question LIKE '%{Messages.AI_EXERCISE_PREFIX}%'
2026-02-20T22:09:14.3072077Z                  """)
2026-02-20T22:09:14.3072614Z                  conn.commit()
2026-02-20T22:09:14.3073247Z              except Exception as e:
2026-02-20T22:09:14.3073719Z                  logger.warning(f"Note: {str(e)}")
2026-02-20T22:09:14.3074202Z                  conn.rollback()
2026-02-20T22:09:14.3074576Z -                
2026-02-20T22:09:14.3074874Z +
2026-02-20T22:09:14.3075220Z              # Create results table if it doesn't exist
2026-02-20T22:09:14.3075784Z              cursor.execute(ResultQueries.CREATE_TABLE)
2026-02-20T22:09:14.3076269Z -            
2026-02-20T22:09:14.3076551Z +
2026-02-20T22:09:14.3076903Z              # Create user_stats table if it doesn't exist
2026-02-20T22:09:14.3077425Z              cursor.execute("""
2026-02-20T22:09:14.3077869Z              CREATE TABLE IF NOT EXISTS user_stats (
2026-02-20T22:09:14.3078356Z                  id SERIAL PRIMARY KEY,
2026-02-20T22:09:14.3078829Z                  exercise_type VARCHAR(50) NOT NULL,
2026-02-20T22:09:14.3079299Z @@ -113,17 +122,17 @@
2026-02-20T22:09:14.3079682Z                  total_attempts INTEGER DEFAULT 0,
2026-02-20T22:09:14.3080204Z                  correct_attempts INTEGER DEFAULT 0,
2026-02-20T22:09:14.3080854Z                  last_updated TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
2026-02-20T22:09:14.3081471Z              )
2026-02-20T22:09:14.3081754Z              """)
2026-02-20T22:09:14.3082054Z -            
2026-02-20T22:09:14.3082335Z +
2026-02-20T22:09:14.3082732Z              logger.success("Database initialized successfully")
2026-02-20T22:09:14.3083467Z -            
2026-02-20T22:09:14.3083759Z +
2026-02-20T22:09:14.3084020Z          finally:
2026-02-20T22:09:14.3084358Z              # Always close the connection
2026-02-20T22:09:14.3084816Z              cursor.close()
2026-02-20T22:09:14.3085188Z              conn.close()
2026-02-20T22:09:14.3085536Z -            
2026-02-20T22:09:14.3085815Z +
2026-02-20T22:09:14.3086106Z      except Exception as e:
2026-02-20T22:09:14.3086593Z          logger.error(f"Error initializing database: {e}")
2026-02-20T22:09:14.3087130Z          traceback.print_exc()
2026-02-20T22:09:14.3087517Z -        sys.exit(1) 
2026-02-20T22:09:14.3087869Z \ No newline at end of file
2026-02-20T22:09:14.3088236Z +        sys.exit(1)
2026-02-20T22:09:14.3458120Z would reformat /home/runner/work/mathakine/mathakine/server/error_handlers.py
2026-02-20T22:09:14.3459187Z --- /home/runner/work/mathakine/mathakine/server/error_handlers.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3460360Z +++ /home/runner/work/mathakine/mathakine/server/error_handlers.py	2026-02-20 22:09:14.342875+00:00
2026-02-20T22:09:14.3461133Z @@ -4,10 +4,11 @@
2026-02-20T22:09:14.3461691Z  This module centralizes Starlette exception handling logic for a consistent
2026-02-20T22:09:14.3462411Z  error management across the application.
2026-02-20T22:09:14.3462838Z  
2026-02-20T22:09:14.3463572Z  Since the frontend is now Next.js, all error responses are JSON (no HTML templates).
2026-02-20T22:09:14.3464233Z  """
2026-02-20T22:09:14.3464499Z +
2026-02-20T22:09:14.3464749Z  import traceback
2026-02-20T22:09:14.3465042Z  
2026-02-20T22:09:14.3465369Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.3465834Z  
2026-02-20T22:09:14.3466110Z  logger = get_logger(__name__)
2026-02-20T22:09:14.3466482Z @@ -17,59 +18,61 @@
2026-02-20T22:09:14.3466769Z  
2026-02-20T22:09:14.3467011Z  
2026-02-20T22:09:14.3467400Z  async def not_found(request: Request, exc: HTTPException):
2026-02-20T22:09:14.3467920Z      """
2026-02-20T22:09:14.3468215Z      Handle 404 Not Found errors.
2026-02-20T22:09:14.3468587Z -    
2026-02-20T22:09:14.3468847Z +
2026-02-20T22:09:14.3469084Z      Args:
2026-02-20T22:09:14.3469716Z          request: The Starlette request object
2026-02-20T22:09:14.3470199Z          exc: The exception that was raised
2026-02-20T22:09:14.3470619Z -        
2026-02-20T22:09:14.3470874Z +
2026-02-20T22:09:14.3471123Z      Returns:
2026-02-20T22:09:14.3471418Z          JSON error response
2026-02-20T22:09:14.3472000Z      """
2026-02-20T22:09:14.3472418Z      logger.warning(f"404 Not Found: {request.url.path}")
2026-02-20T22:09:14.3472948Z      return JSONResponse(
2026-02-20T22:09:14.3473500Z          {
2026-02-20T22:09:14.3473791Z              "error": "Not Found",
2026-02-20T22:09:14.3474289Z              "message": "The requested resource does not exist.",
2026-02-20T22:09:14.3474830Z -            "path": str(request.url.path)
2026-02-20T22:09:14.3475303Z +            "path": str(request.url.path),
2026-02-20T22:09:14.3475707Z          },
2026-02-20T22:09:14.3475994Z -        status_code=404
2026-02-20T22:09:14.3476363Z +        status_code=404,
2026-02-20T22:09:14.3476684Z      )
2026-02-20T22:09:14.3476952Z +
2026-02-20T22:09:14.3477191Z  
2026-02-20T22:09:14.3477583Z  async def server_error(request: Request, exc: Exception):
2026-02-20T22:09:14.3478106Z      """
2026-02-20T22:09:14.3478513Z      Handle 500 Server Error and other unexpected exceptions.
2026-02-20T22:09:14.3479026Z -    
2026-02-20T22:09:14.3479278Z +
2026-02-20T22:09:14.3479529Z      Args:
2026-02-20T22:09:14.3479859Z          request: The Starlette request object
2026-02-20T22:09:14.3480331Z          exc: The exception that was raised
2026-02-20T22:09:14.3480750Z -        
2026-02-20T22:09:14.3481016Z +
2026-02-20T22:09:14.3481259Z      Returns:
2026-02-20T22:09:14.3481560Z          JSON error response
2026-02-20T22:09:14.3481910Z      """
2026-02-20T22:09:14.3482205Z      # Log the error for debugging
2026-02-20T22:09:14.3482782Z      logger.error(f"500 Server Error for {request.url.path}: {str(exc)}")
2026-02-20T22:09:14.3484299Z      logger.error(traceback.format_exc())
2026-02-20T22:09:14.3485670Z -    
2026-02-20T22:09:14.3513559Z +
2026-02-20T22:09:14.3513859Z      return JSONResponse(
2026-02-20T22:09:14.3514224Z          {
2026-02-20T22:09:14.3514552Z              "error": "Internal Server Error",
2026-02-20T22:09:14.3515198Z              "message": "An internal server error occurred. Please try again later.",
2026-02-20T22:09:14.3515882Z -            "path": str(request.url.path)
2026-02-20T22:09:14.3516345Z +            "path": str(request.url.path),
2026-02-20T22:09:14.3516757Z          },
2026-02-20T22:09:14.3517033Z -        status_code=500
2026-02-20T22:09:14.3517386Z +        status_code=500,
2026-02-20T22:09:14.3517705Z      )
2026-02-20T22:09:14.3517962Z +
2026-02-20T22:09:14.3518198Z  
2026-02-20T22:09:14.3518484Z  def get_exception_handlers():
2026-02-20T22:09:14.3518850Z      """
2026-02-20T22:09:14.3519369Z      Get a dictionary of exception handlers for use in Starlette app initialization.
2026-02-20T22:09:14.3520025Z -    
2026-02-20T22:09:14.3520269Z +
2026-02-20T22:09:14.3520517Z      Returns:
2026-02-20T22:09:14.3520905Z          Dict mapping exception types to handler functions
2026-02-20T22:09:14.3521386Z      """
2026-02-20T22:09:14.3521637Z      return {
2026-02-20T22:09:14.3521931Z          404: not_found,
2026-02-20T22:09:14.3522273Z          500: server_error,
2026-02-20T22:09:14.3522746Z -        Exception: server_error  # Catch all other exceptions
2026-02-20T22:09:14.3523422Z -    } 
2026-02-20T22:09:14.3523708Z \ No newline at end of file
2026-02-20T22:09:14.3524180Z +        Exception: server_error,  # Catch all other exceptions
2026-02-20T22:09:14.3524681Z +    }
2026-02-20T22:09:14.3843854Z --- /home/runner/work/mathakine/mathakine/server/auth.py	2026-02-20 22:09:02.836965+00:00
2026-02-20T22:09:14.3856190Z would reformat /home/runner/work/mathakine/mathakine/server/auth.py
2026-02-20T22:09:14.3858568Z +++ /home/runner/work/mathakine/mathakine/server/auth.py	2026-02-20 22:09:14.381536+00:00
2026-02-20T22:09:14.3860519Z @@ -2,10 +2,11 @@
2026-02-20T22:09:14.3862170Z  Module d'authentification pour le backend Starlette.
2026-02-20T22:09:14.3863304Z  
2026-02-20T22:09:14.3864124Z  Fournit les fonctions d'authentification utilisées par les handlers API,
2026-02-20T22:09:14.3865264Z  ainsi que des décorateurs pour éliminer la duplication de code auth dans les handlers.
2026-02-20T22:09:14.3865997Z  """
2026-02-20T22:09:14.3866523Z +
2026-02-20T22:09:14.3866805Z  import json
2026-02-20T22:09:14.3867123Z  from functools import wraps
2026-02-20T22:09:14.3867486Z  
2026-02-20T22:09:14.3867935Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:14.3868506Z  
2026-02-20T22:09:14.3868757Z @@ -17,17 +18,17 @@
2026-02-20T22:09:14.3870912Z  
2026-02-20T22:09:14.3871188Z  
2026-02-20T22:09:14.3872795Z  async def get_current_user(request):  # noqa: C901
2026-02-20T22:09:14.3874785Z      """
2026-02-20T22:09:14.3875522Z      Récupère l'utilisateur actuellement authentifié depuis le cookie access_token.
2026-02-20T22:09:14.3876195Z -    
2026-02-20T22:09:14.3876444Z +
2026-02-20T22:09:14.3876714Z      Args:
2026-02-20T22:09:14.3877021Z          request: Starlette Request object
2026-02-20T22:09:14.3877427Z -        
2026-02-20T22:09:14.3877688Z +
2026-02-20T22:09:14.3877929Z      Returns:
2026-02-20T22:09:14.3878595Z          dict: Dictionnaire avec les informations de l'utilisateur ou None si non authentifié
2026-02-20T22:09:14.3879305Z -        
2026-02-20T22:09:14.3879413Z +
2026-02-20T22:09:14.3879523Z      Example:
2026-02-20T22:09:14.3879625Z          {
2026-02-20T22:09:14.3879736Z              "id": 1,
2026-02-20T22:09:14.3879884Z              "username": "test_user",
2026-02-20T22:09:14.3880032Z              "email": "test@example.com",
2026-02-20T22:09:14.3880142Z @@ -35,20 +36,20 @@
2026-02-20T22:09:14.3880254Z          }
2026-02-20T22:09:14.3880356Z      """
2026-02-20T22:09:14.3880467Z      try:
2026-02-20T22:09:14.3880805Z          # Essayer d'abord le cookie (comportement par défaut)
2026-02-20T22:09:14.3881032Z          access_token = request.cookies.get("access_token")
2026-02-20T22:09:14.3881154Z -        
2026-02-20T22:09:14.3881259Z +
2026-02-20T22:09:14.3881481Z          # Si pas de cookie, essayer le header Authorization
2026-02-20T22:09:14.3881670Z          if not access_token:
2026-02-20T22:09:14.3881907Z              auth_header = request.headers.get("Authorization")
2026-02-20T22:09:14.3882177Z              if auth_header and auth_header.startswith("Bearer "):
2026-02-20T22:09:14.3882407Z                  access_token = auth_header.replace("Bearer ", "")
2026-02-20T22:09:14.3882519Z -        
2026-02-20T22:09:14.3882622Z +
2026-02-20T22:09:14.3882754Z          if not access_token:
2026-02-20T22:09:14.3882881Z              return None
2026-02-20T22:09:14.3883170Z -            
2026-02-20T22:09:14.3883277Z +
2026-02-20T22:09:14.3883689Z          # Utiliser le service d'authentification pour décoder le token
2026-02-20T22:09:14.3883859Z          from fastapi import HTTPException
2026-02-20T22:09:14.3883961Z  
2026-02-20T22:09:14.3884146Z          from app.core.security import decode_token
2026-02-20T22:09:14.3884431Z          from app.services.auth_service import get_user_by_username
2026-02-20T22:09:14.3884541Z @@ -61,44 +62,70 @@
2026-02-20T22:09:14.3884659Z              return None
2026-02-20T22:09:14.3884811Z          except Exception as decode_error:
2026-02-20T22:09:14.3885044Z              # Autre erreur de décodage
2026-02-20T22:09:14.3885458Z              logger.debug(f"Erreur lors du décodage du token: {decode_error}")
2026-02-20T22:09:14.3885576Z              return None
2026-02-20T22:09:14.3885688Z -        
2026-02-20T22:09:14.3885790Z +
2026-02-20T22:09:14.3885940Z          username = payload.get("sub")
2026-02-20T22:09:14.3886045Z -        
2026-02-20T22:09:14.3886153Z +
2026-02-20T22:09:14.3886275Z          if not username:
2026-02-20T22:09:14.3886390Z              return None
2026-02-20T22:09:14.3886500Z -            
2026-02-20T22:09:14.3886599Z +
2026-02-20T22:09:14.3886918Z          # Récupérer l'utilisateur depuis la base de données
2026-02-20T22:09:14.3887061Z          async with db_session() as db:
2026-02-20T22:09:14.3887484Z              user = get_user_by_username(db, username)
2026-02-20T22:09:14.3887591Z -            
2026-02-20T22:09:14.3887691Z +
2026-02-20T22:09:14.3887822Z              if user is None:
2026-02-20T22:09:14.3887943Z                  return None
2026-02-20T22:09:14.3888211Z -                
2026-02-20T22:09:14.3888316Z +
2026-02-20T22:09:14.3888781Z              # Retourner un dictionnaire sérialisable avec tous les champs profil
2026-02-20T22:09:14.3888894Z              return {
2026-02-20T22:09:14.3889017Z                  "id": user.id,
2026-02-20T22:09:14.3889171Z                  "username": user.username,
2026-02-20T22:09:14.3889423Z -                "email": user.email if hasattr(user, 'email') else None,
2026-02-20T22:09:14.3889664Z +                "email": user.email if hasattr(user, "email") else None,
2026-02-20T22:09:14.3889818Z                  "is_authenticated": True,
2026-02-20T22:09:14.3890076Z -                "role": user.role.value if hasattr(user, 'role') else None,
2026-02-20T22:09:14.3890390Z -                "full_name": user.full_name if hasattr(user, 'full_name') else None,
2026-02-20T22:09:14.3890746Z -                "grade_level": user.grade_level if hasattr(user, 'grade_level') else None,
2026-02-20T22:09:14.3891170Z -                "learning_style": user.learning_style if hasattr(user, 'learning_style') else None,
2026-02-20T22:09:14.3891727Z -                "preferred_difficulty": user.preferred_difficulty if hasattr(user, 'preferred_difficulty') else None,
2026-02-20T22:09:14.3892170Z -                "preferred_theme": user.preferred_theme if hasattr(user, 'preferred_theme') else None,
2026-02-20T22:09:14.3892768Z -                "accessibility_settings": user.accessibility_settings if hasattr(user, 'accessibility_settings') else None,
2026-02-20T22:09:14.3893461Z -                "created_at": user.created_at.isoformat() if hasattr(user, 'created_at') and user.created_at else None,
2026-02-20T22:09:14.3893835Z -                "total_points": user.total_points if hasattr(user, 'total_points') else 0,
2026-02-20T22:09:14.3894210Z -                "current_level": user.current_level if hasattr(user, 'current_level') else 1,
2026-02-20T22:09:14.3894562Z -                "jedi_rank": user.jedi_rank if hasattr(user, 'jedi_rank') else 'youngling',
2026-02-20T22:09:14.3894825Z +                "role": user.role.value if hasattr(user, "role") else None,
2026-02-20T22:09:14.3895134Z +                "full_name": user.full_name if hasattr(user, "full_name") else None,
2026-02-20T22:09:14.3895264Z +                "grade_level": (
2026-02-20T22:09:14.3895534Z +                    user.grade_level if hasattr(user, "grade_level") else None
2026-02-20T22:09:14.3895650Z +                ),
2026-02-20T22:09:14.3895782Z +                "learning_style": (
2026-02-20T22:09:14.3896090Z +                    user.learning_style if hasattr(user, "learning_style") else None
2026-02-20T22:09:14.3896208Z +                ),
2026-02-20T22:09:14.3896363Z +                "preferred_difficulty": (
2026-02-20T22:09:14.3896523Z +                    user.preferred_difficulty
2026-02-20T22:09:14.3896721Z +                    if hasattr(user, "preferred_difficulty")
2026-02-20T22:09:14.3896846Z +                    else None
2026-02-20T22:09:14.3896959Z +                ),
2026-02-20T22:09:14.3897100Z +                "preferred_theme": (
2026-02-20T22:09:14.3897429Z +                    user.preferred_theme if hasattr(user, "preferred_theme") else None
2026-02-20T22:09:14.3897535Z +                ),
2026-02-20T22:09:14.3897689Z +                "accessibility_settings": (
2026-02-20T22:09:14.3897856Z +                    user.accessibility_settings
2026-02-20T22:09:14.3898058Z +                    if hasattr(user, "accessibility_settings")
2026-02-20T22:09:14.3898177Z +                    else None
2026-02-20T22:09:14.3898279Z +                ),
2026-02-20T22:09:14.3898411Z +                "created_at": (
2026-02-20T22:09:14.3898566Z +                    user.created_at.isoformat()
2026-02-20T22:09:14.3898966Z +                    if hasattr(user, "created_at") and user.created_at
2026-02-20T22:09:14.3899092Z +                    else None
2026-02-20T22:09:14.3899198Z +                ),
2026-02-20T22:09:14.3899329Z +                "total_points": (
2026-02-20T22:09:14.3899760Z +                    user.total_points if hasattr(user, "total_points") else 0
2026-02-20T22:09:14.3899876Z +                ),
2026-02-20T22:09:14.3900012Z +                "current_level": (
2026-02-20T22:09:14.3900295Z +                    user.current_level if hasattr(user, "current_level") else 1
2026-02-20T22:09:14.3900408Z +                ),
2026-02-20T22:09:14.3900533Z +                "jedi_rank": (
2026-02-20T22:09:14.3900819Z +                    user.jedi_rank if hasattr(user, "jedi_rank") else "youngling"
2026-02-20T22:09:14.3900939Z +                ),
2026-02-20T22:09:14.3901044Z              }
2026-02-20T22:09:14.3901147Z -            
2026-02-20T22:09:14.3901257Z +
2026-02-20T22:09:14.3901423Z      except Exception as user_fetch_error:
2026-02-20T22:09:14.3901976Z -        logger.error(f"Erreur lors de la récupération de l'utilisateur: {user_fetch_error}")
2026-02-20T22:09:14.3902098Z +        logger.error(
2026-02-20T22:09:14.3902555Z +            f"Erreur lors de la récupération de l'utilisateur: {user_fetch_error}"
2026-02-20T22:09:14.3902660Z +        )
2026-02-20T22:09:14.3902774Z          return None
2026-02-20T22:09:14.3902877Z  
2026-02-20T22:09:14.3903139Z  
2026-02-20T22:09:14.3903650Z  # ─── Décorateurs d'authentification ───────────────────────────────────────────
2026-02-20T22:09:14.3904143Z  # Éliminent la duplication du code d'authentification dans les handlers.
2026-02-20T22:09:14.3904269Z @@ -117,99 +144,102 @@
2026-02-20T22:09:14.3904509Z  #       current_user = request.state.user  # Garanti non-None
2026-02-20T22:09:14.3904613Z  
2026-02-20T22:09:14.3904720Z  
2026-02-20T22:09:14.3904857Z  def require_auth(handler):
2026-02-20T22:09:14.3905191Z      """Décorateur qui exige une authentification valide.
2026-02-20T22:09:14.3905294Z -    
2026-02-20T22:09:14.3905403Z +
2026-02-20T22:09:14.3905751Z      Place l'utilisateur authentifié dans request.state.user.
2026-02-20T22:09:14.3905983Z      Retourne 401 JSON si non authentifié.
2026-02-20T22:09:14.3906109Z      """
2026-02-20T22:09:14.3906212Z +
2026-02-20T22:09:14.3906332Z      @wraps(handler)
2026-02-20T22:09:14.3906510Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3906721Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3907003Z          if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3907141Z -            return JSONResponse(
2026-02-20T22:09:14.3907327Z -                {"error": "Authentification requise"},
2026-02-20T22:09:14.3907455Z -                status_code=401
2026-02-20T22:09:14.3907560Z -            )
2026-02-20T22:09:14.3907931Z +            return JSONResponse({"error": "Authentification requise"}, status_code=401)
2026-02-20T22:09:14.3908098Z          request.state.user = current_user
2026-02-20T22:09:14.3908288Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3908390Z +
2026-02-20T22:09:14.3908516Z      return wrapper
2026-02-20T22:09:14.3908617Z  
2026-02-20T22:09:14.3908717Z  
2026-02-20T22:09:14.3908871Z  def optional_auth(handler):
2026-02-20T22:09:14.3909211Z      """Décorateur qui tente l'authentification sans l'exiger.
2026-02-20T22:09:14.3909315Z -    
2026-02-20T22:09:14.3909417Z +
2026-02-20T22:09:14.3909870Z      Place l'utilisateur dans request.state.user (None si non authentifié).
2026-02-20T22:09:14.3910189Z      Ne retourne jamais 401 - le handler décide quoi faire.
2026-02-20T22:09:14.3910292Z      """
2026-02-20T22:09:14.3910400Z +
2026-02-20T22:09:14.3910517Z      @wraps(handler)
2026-02-20T22:09:14.3910695Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3910887Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3911338Z          if current_user and current_user.get("is_authenticated"):
2026-02-20T22:09:14.3911503Z              request.state.user = current_user
2026-02-20T22:09:14.3911611Z          else:
2026-02-20T22:09:14.3911764Z              request.state.user = None
2026-02-20T22:09:14.3912111Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3912219Z +
2026-02-20T22:09:14.3912343Z      return wrapper
2026-02-20T22:09:14.3912444Z  
2026-02-20T22:09:14.3912544Z  
2026-02-20T22:09:14.3912687Z  def require_role(role: str):
2026-02-20T22:09:14.3913314Z      """Décorateur qui exige un rôle spécifique (ex: archiviste pour admin).
2026-02-20T22:09:14.3913422Z -    
2026-02-20T22:09:14.3913525Z +
2026-02-20T22:09:14.3913887Z      À combiner avec @require_auth. Place request.state.user.
2026-02-20T22:09:14.3914146Z      Retourne 403 si le rôle ne correspond pas.
2026-02-20T22:09:14.3914250Z -    
2026-02-20T22:09:14.3914352Z +
2026-02-20T22:09:14.3914465Z      Usage:
2026-02-20T22:09:14.3914602Z          @require_auth
2026-02-20T22:09:14.3914742Z          @require_role("archiviste")
2026-02-20T22:09:14.3914897Z          async def admin_handler(request):
2026-02-20T22:09:14.3915001Z              ...
2026-02-20T22:09:14.3915108Z      """
2026-02-20T22:09:14.3915214Z +
2026-02-20T22:09:14.3915359Z      def decorator(handler):
2026-02-20T22:09:14.3915486Z          @wraps(handler)
2026-02-20T22:09:14.3915676Z          async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3915982Z              # S'assurer qu'on a l'utilisateur (require_auth ou get_current_user)
2026-02-20T22:09:14.3916209Z              current_user = getattr(request.state, "user", None)
2026-02-20T22:09:14.3916341Z              if not current_user:
2026-02-20T22:09:14.3916551Z                  current_user = await get_current_user(request)
2026-02-20T22:09:14.3916847Z              if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3916987Z                  return JSONResponse(
2026-02-20T22:09:14.3917184Z -                    {"error": "Authentification requise"},
2026-02-20T22:09:14.3917320Z -                    status_code=401
2026-02-20T22:09:14.3917561Z +                    {"error": "Authentification requise"}, status_code=401
2026-02-20T22:09:14.3917669Z                  )
2026-02-20T22:09:14.3917846Z              if current_user.get("role") != role:
2026-02-20T22:09:14.3917983Z -                return JSONResponse(
2026-02-20T22:09:14.3918154Z -                    {"error": "Droits insuffisants"},
2026-02-20T22:09:14.3918281Z -                    status_code=403
2026-02-20T22:09:14.3918397Z -                )
2026-02-20T22:09:14.3918728Z +                return JSONResponse({"error": "Droits insuffisants"}, status_code=403)
2026-02-20T22:09:14.3918883Z              request.state.user = current_user
2026-02-20T22:09:14.3919079Z              return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3919175Z +
2026-02-20T22:09:14.3919290Z          return wrapper
2026-02-20T22:09:14.3919395Z +
2026-02-20T22:09:14.3919505Z      return decorator
2026-02-20T22:09:14.3919598Z  
2026-02-20T22:09:14.3919692Z  
2026-02-20T22:09:14.3919847Z  # Alias pratique pour les routes admin
2026-02-20T22:09:14.3920003Z  require_admin = require_role("archiviste")
2026-02-20T22:09:14.3920101Z  
2026-02-20T22:09:14.3920216Z  
2026-02-20T22:09:14.3920354Z  def require_auth_sse(handler):
2026-02-20T22:09:14.3920826Z      """Décorateur qui exige une authentification pour les endpoints SSE/streaming.
2026-02-20T22:09:14.3920926Z -    
2026-02-20T22:09:14.3921036Z +
2026-02-20T22:09:14.3921379Z      Place l'utilisateur authentifié dans request.state.user.
2026-02-20T22:09:14.3921841Z      Retourne un flux SSE d'erreur si non authentifié (au lieu d'un JSON 401).
2026-02-20T22:09:14.3921949Z      """
2026-02-20T22:09:14.3922046Z +
2026-02-20T22:09:14.3922160Z      @wraps(handler)
2026-02-20T22:09:14.3922338Z      async def wrapper(request, *args, **kwargs):
2026-02-20T22:09:14.3922542Z          current_user = await get_current_user(request)
2026-02-20T22:09:14.3923162Z          if not current_user or not current_user.get("is_authenticated"):
2026-02-20T22:09:14.3923269Z +
2026-02-20T22:09:14.3923441Z              async def auth_error_generator():
2026-02-20T22:09:14.3924024Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Authentification requise'})}\n\n"
2026-02-20T22:09:14.3924137Z +
2026-02-20T22:09:14.3924297Z              return StreamingResponse(
2026-02-20T22:09:14.3924439Z                  auth_error_generator(),
2026-02-20T22:09:14.3924600Z                  media_type="text/event-stream",
2026-02-20T22:09:14.3924905Z -                headers={"Cache-Control": "no-cache", "Connection": "keep-alive"}
2026-02-20T22:09:14.3925216Z +                headers={"Cache-Control": "no-cache", "Connection": "keep-alive"},
2026-02-20T22:09:14.3925326Z              )
2026-02-20T22:09:14.3925481Z          request.state.user = current_user
2026-02-20T22:09:14.3925688Z          return await handler(request, *args, **kwargs)
2026-02-20T22:09:14.3925796Z +
2026-02-20T22:09:14.3925912Z      return wrapper
2026-02-20T22:09:14.3926012Z -
2026-02-20T22:09:14.3942849Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py	2026-02-20 22:09:02.811965+00:00
2026-02-20T22:09:14.3943821Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py	2026-02-20 22:09:14.374982+00:00
2026-02-20T22:09:14.3943949Z @@ -1,99 +1,123 @@
2026-02-20T22:09:14.3944064Z  """
2026-02-20T22:09:14.3944533Z  Module de validation logique pour les challenges générés par IA.
2026-02-20T22:09:14.3945045Z  Vérifie la cohérence entre visual_data, correct_answer et solution_explanation.
2026-02-20T22:09:14.3945159Z  """
2026-02-20T22:09:14.3945274Z +
2026-02-20T22:09:14.3945390Z  import json
2026-02-20T22:09:14.3945601Z  from typing import Any, Dict, List, Optional, Tuple
2026-02-20T22:09:14.3945709Z  
2026-02-20T22:09:14.3945895Z  from app.core.logging_config import get_logger
2026-02-20T22:09:14.3946009Z  
2026-02-20T22:09:14.3946142Z  logger = get_logger(__name__)
2026-02-20T22:09:14.3946248Z  
2026-02-20T22:09:14.3963619Z  
2026-02-20T22:09:14.3963863Z  class ChallengeValidationError(Exception):
2026-02-20T22:09:14.3964313Z      """Exception levée lors de la validation d'un challenge."""
2026-02-20T22:09:14.3964441Z +
2026-02-20T22:09:14.3964554Z      pass
2026-02-20T22:09:14.3964660Z  
2026-02-20T22:09:14.3964775Z  
2026-02-20T22:09:14.3965193Z  def validate_challenge_logic(challenge_data: Dict[str, Any]) -> Tuple[bool, List[str]]:
2026-02-20T22:09:14.3965305Z      """
2026-02-20T22:09:14.3965670Z      Valide la cohérence logique d'un challenge généré par IA.
2026-02-20T22:09:14.3965762Z -    
2026-02-20T22:09:14.3965852Z +
2026-02-20T22:09:14.3965952Z      Args:
2026-02-20T22:09:14.3966313Z          challenge_data: Dictionnaire contenant les données du challenge
2026-02-20T22:09:14.3966405Z -        
2026-02-20T22:09:14.3966495Z +
2026-02-20T22:09:14.3966597Z      Returns:
2026-02-20T22:09:14.3966801Z          Tuple (is_valid, errors) où :
2026-02-20T22:09:14.3967012Z          - is_valid: True si le challenge est valide, False sinon
2026-02-20T22:09:14.3967234Z          - errors: Liste des erreurs détectées
2026-02-20T22:09:14.3967337Z      """
2026-02-20T22:09:14.3967455Z      errors = []
2026-02-20T22:09:14.3967575Z -    
2026-02-20T22:09:14.3967875Z -    challenge_type = challenge_data.get('challenge_type', '').upper()
2026-02-20T22:09:14.3968397Z -    visual_data = challenge_data.get('visual_data', {})
2026-02-20T22:09:14.3968642Z -    correct_answer = challenge_data.get('correct_answer', '')
2026-02-20T22:09:14.3968984Z -    solution_explanation = challenge_data.get('solution_explanation', '')
2026-02-20T22:09:14.3969099Z -    
2026-02-20T22:09:14.3969203Z +
2026-02-20T22:09:14.3969503Z +    challenge_type = challenge_data.get("challenge_type", "").upper()
2026-02-20T22:09:14.3969725Z +    visual_data = challenge_data.get("visual_data", {})
2026-02-20T22:09:14.3969966Z +    correct_answer = challenge_data.get("correct_answer", "")
2026-02-20T22:09:14.3970549Z +    solution_explanation = challenge_data.get("solution_explanation", "")
2026-02-20T22:09:14.3970669Z +
2026-02-20T22:09:14.3970951Z      # Parser visual_data si nécessaire
2026-02-20T22:09:14.3971118Z      if isinstance(visual_data, str):
2026-02-20T22:09:14.3971444Z          try:
2026-02-20T22:09:14.3971630Z              visual_data = json.loads(visual_data)
2026-02-20T22:09:14.3971776Z          except json.JSONDecodeError:
2026-02-20T22:09:14.3972019Z              errors.append("visual_data n'est pas un JSON valide")
2026-02-20T22:09:14.3972152Z              return False, errors
2026-02-20T22:09:14.3972257Z -    
2026-02-20T22:09:14.3972360Z +
2026-02-20T22:09:14.3972682Z      # Validation spécifique selon le type de challenge
2026-02-20T22:09:14.3972822Z -    if challenge_type == 'PATTERN':
2026-02-20T22:09:14.3973478Z -        pattern_errors = validate_pattern_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3973648Z +    if challenge_type == "PATTERN":
2026-02-20T22:09:14.3973853Z +        pattern_errors = validate_pattern_challenge(
2026-02-20T22:09:14.3974081Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3974191Z +        )
2026-02-20T22:09:14.3974364Z          errors.extend(pattern_errors)
2026-02-20T22:09:14.3974471Z -    
2026-02-20T22:09:14.3974626Z -    elif challenge_type == 'SEQUENCE':
2026-02-20T22:09:14.3975150Z -        sequence_errors = validate_sequence_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3975258Z +
2026-02-20T22:09:14.3975410Z +    elif challenge_type == "SEQUENCE":
2026-02-20T22:09:14.3975625Z +        sequence_errors = validate_sequence_challenge(
2026-02-20T22:09:14.3975850Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3975959Z +        )
2026-02-20T22:09:14.3976108Z          errors.extend(sequence_errors)
2026-02-20T22:09:14.3976218Z -    
2026-02-20T22:09:14.3976379Z -    elif challenge_type == 'PUZZLE':
2026-02-20T22:09:14.3976857Z -        puzzle_errors = validate_puzzle_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3976977Z +
2026-02-20T22:09:14.3977130Z +    elif challenge_type == "PUZZLE":
2026-02-20T22:09:14.3977325Z +        puzzle_errors = validate_puzzle_challenge(
2026-02-20T22:09:14.3977550Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3977657Z +        )
2026-02-20T22:09:14.3977802Z          errors.extend(puzzle_errors)
2026-02-20T22:09:14.3977906Z -    
2026-02-20T22:09:14.3978058Z -    elif challenge_type == 'GRAPH':
2026-02-20T22:09:14.3978516Z -        graph_errors = validate_graph_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3978624Z +
2026-02-20T22:09:14.3978779Z +    elif challenge_type == "GRAPH":
2026-02-20T22:09:14.3978956Z +        graph_errors = validate_graph_challenge(
2026-02-20T22:09:14.3979174Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3979292Z +        )
2026-02-20T22:09:14.3979445Z          errors.extend(graph_errors)
2026-02-20T22:09:14.3979547Z -    
2026-02-20T22:09:14.3979687Z -    elif challenge_type == 'VISUAL':
2026-02-20T22:09:14.3979800Z +
2026-02-20T22:09:14.3979940Z +    elif challenge_type == "VISUAL":
2026-02-20T22:09:14.3980366Z          # VISUAL inclut les défis spatiaux (rotation, symétrie, etc.)
2026-02-20T22:09:14.3980856Z -        visual_errors = validate_spatial_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3981057Z +        visual_errors = validate_spatial_challenge(
2026-02-20T22:09:14.3981266Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3981372Z +        )
2026-02-20T22:09:14.3981524Z          errors.extend(visual_errors)
2026-02-20T22:09:14.3981630Z -    
2026-02-20T22:09:14.3981772Z -    elif challenge_type == 'CODING':
2026-02-20T22:09:14.3981880Z +
2026-02-20T22:09:14.3982027Z +    elif challenge_type == "CODING":
2026-02-20T22:09:14.3982571Z          # Valider les défis de type labyrinthe/maze
2026-02-20T22:09:14.3983236Z -        coding_errors = validate_coding_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3983439Z +        coding_errors = validate_coding_challenge(
2026-02-20T22:09:14.3983851Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3983978Z +        )
2026-02-20T22:09:14.3984145Z          errors.extend(coding_errors)
2026-02-20T22:09:14.3984251Z -    
2026-02-20T22:09:14.3984398Z -    elif challenge_type == 'RIDDLE':
2026-02-20T22:09:14.3984874Z -        riddle_errors = validate_riddle_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3984980Z +
2026-02-20T22:09:14.3985125Z +    elif challenge_type == "RIDDLE":
2026-02-20T22:09:14.3985308Z +        riddle_errors = validate_riddle_challenge(
2026-02-20T22:09:14.3985535Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3985655Z +        )
2026-02-20T22:09:14.3985799Z          errors.extend(riddle_errors)
2026-02-20T22:09:14.3985911Z -    
2026-02-20T22:09:14.3986073Z -    elif challenge_type == 'PROBABILITY':
2026-02-20T22:09:14.3986577Z -        prob_errors = validate_probability_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3986685Z +
2026-02-20T22:09:14.3986852Z +    elif challenge_type == "PROBABILITY":
2026-02-20T22:09:14.3987048Z +        prob_errors = validate_probability_challenge(
2026-02-20T22:09:14.3987274Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3987386Z +        )
2026-02-20T22:09:14.3987529Z          errors.extend(prob_errors)
2026-02-20T22:09:14.3987624Z  
2026-02-20T22:09:14.3987766Z -    elif challenge_type == 'CHESS':
2026-02-20T22:09:14.3988219Z -        chess_errors = validate_chess_challenge(visual_data, correct_answer, solution_explanation)
2026-02-20T22:09:14.3988363Z +    elif challenge_type == "CHESS":
2026-02-20T22:09:14.3988543Z +        chess_errors = validate_chess_challenge(
2026-02-20T22:09:14.3988770Z +            visual_data, correct_answer, solution_explanation
2026-02-20T22:09:14.3988876Z +        )
2026-02-20T22:09:14.3989013Z          errors.extend(chess_errors)
2026-02-20T22:09:14.3989126Z  
2026-02-20T22:09:14.3989355Z      # Validation générale
2026-02-20T22:09:14.3989522Z      # Convertir en string si c'est une liste
2026-02-20T22:09:14.3990748Z -    correct_answer_str = ','.join(correct_answer) if isinstance(correct_answer, list) else str(correct_answer) if correct_answer else ''
2026-02-20T22:09:14.3991133Z -    explanation_str = str(solution_explanation) if solution_explanation else ''
2026-02-20T22:09:14.3991244Z -    
2026-02-20T22:09:14.3991386Z +    correct_answer_str = (
2026-02-20T22:09:14.3991531Z +        ",".join(correct_answer)
2026-02-20T22:09:14.3991695Z +        if isinstance(correct_answer, list)
2026-02-20T22:09:14.3991916Z +        else str(correct_answer) if correct_answer else ""
2026-02-20T22:09:14.3992045Z +    )
2026-02-20T22:09:14.3992399Z +    explanation_str = str(solution_explanation) if solution_explanation else ""
2026-02-20T22:09:14.3992503Z +
2026-02-20T22:09:14.3992761Z      if not correct_answer_str or not correct_answer_str.strip():
2026-02-20T22:09:14.3993129Z          errors.append("correct_answer est vide")
2026-02-20T22:09:14.3993250Z -    
2026-02-20T22:09:14.3993361Z +
2026-02-20T22:09:14.3993611Z      if not explanation_str or not explanation_str.strip():
2026-02-20T22:09:14.3993822Z          errors.append("solution_explanation est vide")
2026-02-20T22:09:14.3993931Z -    
2026-02-20T22:09:14.3994039Z +
2026-02-20T22:09:14.3994185Z      return len(errors) == 0, errors
2026-02-20T22:09:14.3994288Z  
2026-02-20T22:09:14.3994393Z  
2026-02-20T22:09:14.3994753Z  def compute_pattern_answers_multi(grid: List[List[Any]]) -> Optional[str]:
2026-02-20T22:09:14.3994860Z      """
2026-02-20T22:09:14.3994986Z @@ -104,11 +128,11 @@
2026-02-20T22:09:14.3995121Z      positions = []
2026-02-20T22:09:14.3995537Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.3995715Z          if not isinstance(row, (list, tuple)):
2026-02-20T22:09:14.3995834Z              continue
2026-02-20T22:09:14.3995993Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.3996414Z -            if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.3996673Z +            if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.3996842Z                  positions.append((i, j))
2026-02-20T22:09:14.3996970Z      if not positions:
2026-02-20T22:09:14.3997092Z          return None
2026-02-20T22:09:14.3997210Z      symbols = []
2026-02-20T22:09:14.3997368Z      for i, j in sorted(positions):
2026-02-20T22:09:14.3997483Z @@ -117,31 +141,37 @@
2026-02-20T22:09:14.3997604Z              return None
2026-02-20T22:09:14.3997766Z          symbols.append(str(s).strip())
2026-02-20T22:09:14.3997904Z      return ", ".join(symbols)
2026-02-20T22:09:14.3998013Z  
2026-02-20T22:09:14.3998115Z  
2026-02-20T22:09:14.3998693Z -def validate_pattern_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.3998846Z +def validate_pattern_challenge(
2026-02-20T22:09:14.3999150Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.3999283Z +) -> List[str]:
2026-02-20T22:09:14.3999389Z      """
2026-02-20T22:09:14.3999549Z      Valide un challenge de type PATTERN.
2026-02-20T22:09:14.3999982Z      Vérifie que la réponse correspond au pattern dans la grille.
2026-02-20T22:09:14.4000090Z      """
2026-02-20T22:09:14.4000206Z      errors = []
2026-02-20T22:09:14.4000322Z -    
2026-02-20T22:09:14.4000530Z -    if not visual_data or 'grid' not in visual_data:
2026-02-20T22:09:14.4000634Z +
2026-02-20T22:09:14.4000837Z +    if not visual_data or "grid" not in visual_data:
2026-02-20T22:09:14.4001169Z          errors.append("visual_data.grid manquant pour un challenge PATTERN")
2026-02-20T22:09:14.4001303Z          return errors
2026-02-20T22:09:14.4001416Z -    
2026-02-20T22:09:14.4001562Z -    grid = visual_data.get('grid', [])
2026-02-20T22:09:14.4001666Z +
2026-02-20T22:09:14.4001809Z +    grid = visual_data.get("grid", [])
2026-02-20T22:09:14.4001998Z      if not grid or not isinstance(grid, list):
2026-02-20T22:09:14.4002371Z          errors.append("visual_data.grid doit être un tableau")
2026-02-20T22:09:14.4002490Z          return errors
2026-02-20T22:09:14.4002603Z -    
2026-02-20T22:09:14.4002706Z +
2026-02-20T22:09:14.4002938Z      # Plusieurs "?" → format "O, O, X, O"
2026-02-20T22:09:14.4003376Z      expected_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:14.4003577Z      if expected_multi:
2026-02-20T22:09:14.4003995Z -        correct_parts = [p.strip().upper() for p in str(correct_answer).split(',') if p.strip()]
2026-02-20T22:09:14.4004382Z -        expected_parts = [p.strip().upper() for p in expected_multi.split(',') if p.strip()]
2026-02-20T22:09:14.4004537Z +        correct_parts = [
2026-02-20T22:09:14.4004847Z +            p.strip().upper() for p in str(correct_answer).split(",") if p.strip()
2026-02-20T22:09:14.4004954Z +        ]
2026-02-20T22:09:14.4005093Z +        expected_parts = [
2026-02-20T22:09:14.4005388Z +            p.strip().upper() for p in expected_multi.split(",") if p.strip()
2026-02-20T22:09:14.4005494Z +        ]
2026-02-20T22:09:14.4005870Z          if len(correct_parts) != len(expected_parts) or correct_parts != expected_parts:
2026-02-20T22:09:14.4006000Z              errors.append(
2026-02-20T22:09:14.4006476Z                  f"Pattern multi-cellules incohérent: attendu '{expected_multi}', "
2026-02-20T22:09:14.4006647Z                  f"correct_answer='{correct_answer}'"
2026-02-20T22:09:14.4006758Z              )
2026-02-20T22:09:14.4006868Z @@ -151,11 +181,11 @@
2026-02-20T22:09:14.4006990Z      question_pos = None
2026-02-20T22:09:14.4007132Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.4007273Z          if not isinstance(row, list):
2026-02-20T22:09:14.4007599Z              continue
2026-02-20T22:09:14.4007748Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4007990Z -            if cell == '?' or (isinstance(cell, str) and '?' in cell):
2026-02-20T22:09:14.4008395Z +            if cell == "?" or (isinstance(cell, str) and "?" in cell):
2026-02-20T22:09:14.4008550Z                  question_pos = (i, j)
2026-02-20T22:09:14.4008678Z                  break
2026-02-20T22:09:14.4008805Z          if question_pos:
2026-02-20T22:09:14.4008917Z              break
2026-02-20T22:09:14.4009053Z      if not question_pos:
2026-02-20T22:09:14.4009165Z @@ -168,11 +198,11 @@
2026-02-20T22:09:14.4009369Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4009495Z              errors.append(
2026-02-20T22:09:14.4009966Z                  f"Pattern incohérent: le pattern suggère '{expected_answer}', "
2026-02-20T22:09:14.4010178Z                  f"mais correct_answer est '{correct_answer}'"
2026-02-20T22:09:14.4010299Z              )
2026-02-20T22:09:14.4010411Z -    
2026-02-20T22:09:14.4010515Z +
2026-02-20T22:09:14.4010633Z      return errors
2026-02-20T22:09:14.4010735Z  
2026-02-20T22:09:14.4010840Z  
2026-02-20T22:09:14.4011253Z  def analyze_pattern(grid: List[List[Any]], row_idx: int, col_idx: int) -> Optional[str]:
2026-02-20T22:09:14.4011371Z      """
2026-02-20T22:09:14.4011495Z @@ -180,16 +210,16 @@
2026-02-20T22:09:14.4011667Z      Supporte plusieurs types de patterns :
2026-02-20T22:09:14.4011958Z      - Symétrie (horizontale, verticale, centrale)
2026-02-20T22:09:14.4012447Z      - Latin square (chaque ligne/colonne contient chaque élément une seule fois)
2026-02-20T22:09:14.4012718Z      - Patterns alternés simples (X-O-X, etc.)
2026-02-20T22:09:14.4012929Z      - Patterns de répétition
2026-02-20T22:09:14.4013956Z -    
2026-02-20T22:09:14.4014086Z +
2026-02-20T22:09:14.4043305Z      Args:
2026-02-20T22:09:14.4043465Z          grid: Grille 2D
2026-02-20T22:09:14.4043664Z          row_idx: Index de la ligne contenant '?'
2026-02-20T22:09:14.4043873Z          col_idx: Index de la colonne contenant '?'
2026-02-20T22:09:14.4043988Z -        
2026-02-20T22:09:14.4044096Z +
2026-02-20T22:09:14.4044214Z      Returns:
2026-02-20T22:09:14.4044712Z          Réponse attendue ou None si le pattern ne peut pas être déterminé
2026-02-20T22:09:14.4044835Z      """
2026-02-20T22:09:14.4045102Z      if not grid or row_idx >= len(grid) or col_idx >= len(grid[0]):
2026-02-20T22:09:14.4045224Z          return None
2026-02-20T22:09:14.4045342Z @@ -205,243 +235,270 @@
2026-02-20T22:09:14.4045516Z      def _rows_match(r1: int, r2: int) -> bool:
2026-02-20T22:09:14.4045679Z          if r1 >= len(grid) or r2 >= len(grid):
2026-02-20T22:09:14.4045804Z              return False
2026-02-20T22:09:14.4045948Z          for j in range(len(grid[0])):
2026-02-20T22:09:14.4046185Z              a, b = str(grid[r1][j]).strip(), str(grid[r2][j]).strip()
2026-02-20T22:09:14.4046397Z -            if a not in ('?', '') and b not in ('?', '') and a != b:
2026-02-20T22:09:14.4046618Z +            if a not in ("?", "") and b not in ("?", "") and a != b:
2026-02-20T22:09:14.4046758Z                  return False
2026-02-20T22:09:14.4046875Z          return True
2026-02-20T22:09:14.4046978Z +
2026-02-20T22:09:14.4047095Z      if rows >= 3:
2026-02-20T22:09:14.4047291Z          if row_idx in (0, 2) and _rows_match(0, 2):
2026-02-20T22:09:14.4047443Z              ref_row = 0 if row_idx == 2 else 2
2026-02-20T22:09:14.4047593Z              ref_val = grid[ref_row][col_idx]
2026-02-20T22:09:14.4047826Z -            if ref_val and str(ref_val).strip() not in ('?', ''):
2026-02-20T22:09:14.4048048Z +            if ref_val and str(ref_val).strip() not in ("?", ""):
2026-02-20T22:09:14.4048205Z                  return str(ref_val).strip()
2026-02-20T22:09:14.4048439Z          if row_idx in (1, 3) and rows >= 4 and _rows_match(1, 3):
2026-02-20T22:09:14.4048590Z              ref_row = 1 if row_idx == 3 else 3
2026-02-20T22:09:14.4048740Z              ref_val = grid[ref_row][col_idx]
2026-02-20T22:09:14.4049196Z -            if ref_val and str(ref_val).strip() not in ('?', ''):
2026-02-20T22:09:14.4049422Z +            if ref_val and str(ref_val).strip() not in ("?", ""):
2026-02-20T22:09:14.4049575Z                  return str(ref_val).strip()
2026-02-20T22:09:14.4049680Z  
2026-02-20T22:09:14.4050383Z      # 3. Symétrie : grille symétrique horizontale/verticale → ? = cellule miroir
2026-02-20T22:09:14.4050536Z      mirror_row = rows - 1 - row_idx
2026-02-20T22:09:14.4050667Z      mirror_col = cols - 1 - col_idx
2026-02-20T22:09:14.4050965Z      if mirror_row != row_idx and 0 <= mirror_row < rows and col_idx < cols:
2026-02-20T22:09:14.4051156Z          mirror_cell = grid[mirror_row][col_idx]
2026-02-20T22:09:14.4051539Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4051653Z +        if (
2026-02-20T22:09:14.4051781Z +            mirror_cell
2026-02-20T22:09:14.4051936Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4052096Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4052212Z +        ):
2026-02-20T22:09:14.4052363Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4052570Z      if mirror_col != col_idx and 0 <= mirror_col < cols:
2026-02-20T22:09:14.4052746Z          mirror_cell = grid[row_idx][mirror_col]
2026-02-20T22:09:14.4053326Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4053438Z +        if (
2026-02-20T22:09:14.4053559Z +            mirror_cell
2026-02-20T22:09:14.4053727Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4053876Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4053987Z +        ):
2026-02-20T22:09:14.4054140Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4054344Z      if 0 <= mirror_row < rows and 0 <= mirror_col < cols:
2026-02-20T22:09:14.4054522Z          mirror_cell = grid[mirror_row][mirror_col]
2026-02-20T22:09:14.4054905Z -        if mirror_cell and str(mirror_cell).strip() != '?' and '?' not in str(mirror_cell):
2026-02-20T22:09:14.4055024Z +        if (
2026-02-20T22:09:14.4055143Z +            mirror_cell
2026-02-20T22:09:14.4055305Z +            and str(mirror_cell).strip() != "?"
2026-02-20T22:09:14.4055464Z +            and "?" not in str(mirror_cell)
2026-02-20T22:09:14.4055572Z +        ):
2026-02-20T22:09:14.4055720Z              return str(mirror_cell).strip()
2026-02-20T22:09:14.4055827Z -    
2026-02-20T22:09:14.4055949Z +
2026-02-20T22:09:14.4056241Z      # 3. Analyser le pattern horizontal (ligne) pour patterns simples
2026-02-20T22:09:14.4056367Z      row = grid[row_idx]
2026-02-20T22:09:14.4056499Z      if len(row) >= 2:
2026-02-20T22:09:14.4056744Z          # Pattern X-O-X suggère X
2026-02-20T22:09:14.4056945Z -        if col_idx == 2 and row[0] == 'X' and row[1] == 'O':
2026-02-20T22:09:14.4057076Z -            return 'X'
2026-02-20T22:09:14.4057273Z +        if col_idx == 2 and row[0] == "X" and row[1] == "O":
2026-02-20T22:09:14.4057406Z +            return "X"
2026-02-20T22:09:14.4057629Z          # Pattern O-X-O suggère O
2026-02-20T22:09:14.4057831Z -        if col_idx == 2 and row[0] == 'O' and row[1] == 'X':
2026-02-20T22:09:14.4057947Z -            return 'O'
2026-02-20T22:09:14.4058144Z +        if col_idx == 2 and row[0] == "O" and row[1] == "X":
2026-02-20T22:09:14.4058269Z +            return "O"
2026-02-20T22:09:14.4058484Z          # Pattern alterné simple
2026-02-20T22:09:14.4058612Z          if col_idx == 2:
2026-02-20T22:09:14.4058900Z              if row[0] == row[1]:  # Même valeur répétée
2026-02-20T22:09:14.4059036Z                  return row[0]
2026-02-20T22:09:14.4059218Z              else:  # Pattern alterné
2026-02-20T22:09:14.4059518Z                  # Si X-O, alors ? = X (pour compléter X-O-X)
2026-02-20T22:09:14.4059689Z -                if row[0] == 'X' and row[1] == 'O':
2026-02-20T22:09:14.4059812Z -                    return 'X'
2026-02-20T22:09:14.4060206Z -                elif row[0] == 'O' and row[1] == 'X':
2026-02-20T22:09:14.4060341Z -                    return 'O'
2026-02-20T22:09:14.4060446Z -    
2026-02-20T22:09:14.4060598Z +                if row[0] == "X" and row[1] == "O":
2026-02-20T22:09:14.4060718Z +                    return "X"
2026-02-20T22:09:14.4061058Z +                elif row[0] == "O" and row[1] == "X":
2026-02-20T22:09:14.4061193Z +                    return "O"
2026-02-20T22:09:14.4061299Z +
2026-02-20T22:09:14.4061496Z      # 3. Analyser le pattern vertical (colonne)
2026-02-20T22:09:14.4061621Z      if len(grid) >= 2:
2026-02-20T22:09:14.4062036Z -        col = [grid[i][col_idx] for i in range(len(grid)) if i < len(grid) and col_idx < len(grid[i])]
2026-02-20T22:09:14.4062154Z +        col = [
2026-02-20T22:09:14.4062291Z +            grid[i][col_idx]
2026-02-20T22:09:14.4062432Z +            for i in range(len(grid))
2026-02-20T22:09:14.4062611Z +            if i < len(grid) and col_idx < len(grid[i])
2026-02-20T22:09:14.4062730Z +        ]
2026-02-20T22:09:14.4062857Z          if len(col) >= 2:
2026-02-20T22:09:14.4063335Z              # Pattern X-O-X suggère X
2026-02-20T22:09:14.4063558Z -            if row_idx == 2 and col[0] == 'X' and col[1] == 'O':
2026-02-20T22:09:14.4063685Z -                return 'X'
2026-02-20T22:09:14.4063900Z +            if row_idx == 2 and col[0] == "X" and col[1] == "O":
2026-02-20T22:09:14.4064025Z +                return "X"
2026-02-20T22:09:14.4064264Z              # Pattern O-X-O suggère O
2026-02-20T22:09:14.4064468Z -            if row_idx == 2 and col[0] == 'O' and col[1] == 'X':
2026-02-20T22:09:14.4064584Z -                return 'O'
2026-02-20T22:09:14.4064788Z +            if row_idx == 2 and col[0] == "O" and col[1] == "X":
2026-02-20T22:09:14.4064906Z +                return "O"
2026-02-20T22:09:14.4065141Z              # Pattern alterné simple
2026-02-20T22:09:14.4065279Z              if row_idx == 2:
2026-02-20T22:09:14.4065575Z                  if col[0] == col[1]:  # Même valeur répétée
2026-02-20T22:09:14.4065711Z                      return col[0]
2026-02-20T22:09:14.4065891Z                  else:  # Pattern alterné
2026-02-20T22:09:14.4066054Z -                    if col[0] == 'X' and col[1] == 'O':
2026-02-20T22:09:14.4066175Z -                        return 'X'
2026-02-20T22:09:14.4066355Z -                    elif col[0] == 'O' and col[1] == 'X':
2026-02-20T22:09:14.4066486Z -                        return 'O'
2026-02-20T22:09:14.4066589Z -    
2026-02-20T22:09:14.4066752Z +                    if col[0] == "X" and col[1] == "O":
2026-02-20T22:09:14.4066875Z +                        return "X"
2026-02-20T22:09:14.4067049Z +                    elif col[0] == "O" and col[1] == "X":
2026-02-20T22:09:14.4067171Z +                        return "O"
2026-02-20T22:09:14.4067278Z +
2026-02-20T22:09:14.4067467Z      # 4. Analyser les diagonales si applicable
2026-02-20T22:09:14.4067657Z      if row_idx == col_idx:  # Diagonale principale
2026-02-20T22:09:14.4068113Z -        diag = [grid[i][i] for i in range(min(len(grid), len(grid[0]))) if i < len(grid) and i < len(grid[0])]
2026-02-20T22:09:14.4068247Z +        diag = [
2026-02-20T22:09:14.4068365Z +            grid[i][i]
2026-02-20T22:09:14.4068558Z +            for i in range(min(len(grid), len(grid[0])))
2026-02-20T22:09:14.4068724Z +            if i < len(grid) and i < len(grid[0])
2026-02-20T22:09:14.4068832Z +        ]
2026-02-20T22:09:14.4068957Z          if len(diag) >= 2:
2026-02-20T22:09:14.4069083Z              if diag[0] == diag[1]:
2026-02-20T22:09:14.4069212Z                  return diag[0]
2026-02-20T22:09:14.4069376Z -            elif diag[0] == 'X' and diag[1] == 'O':
2026-02-20T22:09:14.4069492Z -                return 'X'
2026-02-20T22:09:14.4069654Z -            elif diag[0] == 'O' and diag[1] == 'X':
2026-02-20T22:09:14.4069785Z -                return 'O'
2026-02-20T22:09:14.4069890Z -    
2026-02-20T22:09:14.4070051Z +            elif diag[0] == "X" and diag[1] == "O":
2026-02-20T22:09:14.4070174Z +                return "X"
2026-02-20T22:09:14.4070550Z +            elif diag[0] == "O" and diag[1] == "X":
2026-02-20T22:09:14.4070671Z +                return "O"
2026-02-20T22:09:14.4070776Z +
2026-02-20T22:09:14.4070908Z      # Diagonale secondaire
2026-02-20T22:09:14.4071065Z      if row_idx + col_idx == len(grid) - 1:
2026-02-20T22:09:14.4071585Z -        diag2 = [grid[i][len(grid[0]) - 1 - i] for i in range(min(len(grid), len(grid[0])))]
2026-02-20T22:09:14.4071721Z +        diag2 = [
2026-02-20T22:09:14.4072077Z +            grid[i][len(grid[0]) - 1 - i] for i in range(min(len(grid), len(grid[0])))
2026-02-20T22:09:14.4072185Z +        ]
2026-02-20T22:09:14.4072323Z          if len(diag2) >= 2:
2026-02-20T22:09:14.4072459Z              if diag2[0] == diag2[1]:
2026-02-20T22:09:14.4072585Z                  return diag2[0]
2026-02-20T22:09:14.4072758Z -            elif diag2[0] == 'X' and diag2[1] == 'O':
2026-02-20T22:09:14.4072887Z -                return 'X'
2026-02-20T22:09:14.4103299Z -            elif diag2[0] == 'O' and diag2[1] == 'X':
2026-02-20T22:09:14.4103466Z -                return 'O'
2026-02-20T22:09:14.4103584Z -    
2026-02-20T22:09:14.4103774Z +            elif diag2[0] == "X" and diag2[1] == "O":
2026-02-20T22:09:14.4103900Z +                return "X"
2026-02-20T22:09:14.4104097Z +            elif diag2[0] == "O" and diag2[1] == "X":
2026-02-20T22:09:14.4104220Z +                return "O"
2026-02-20T22:09:14.4104323Z +
2026-02-20T22:09:14.4104436Z      return None
2026-02-20T22:09:14.4104545Z  
2026-02-20T22:09:14.4104644Z  
2026-02-20T22:09:14.4105156Z -def analyze_latin_square_pattern(grid: List[List[Any]], row_idx: int, col_idx: int) -> Optional[str]:
2026-02-20T22:09:14.4105318Z +def analyze_latin_square_pattern(
2026-02-20T22:09:14.4105519Z +    grid: List[List[Any]], row_idx: int, col_idx: int
2026-02-20T22:09:14.4105651Z +) -> Optional[str]:
2026-02-20T22:09:14.4105757Z      """
2026-02-20T22:09:14.4106254Z      Analyse un pattern de type "Latin Square" où chaque ligne et/ou colonne
2026-02-20T22:09:14.4106615Z      doit contenir chaque élément unique exactement une fois.
2026-02-20T22:09:14.4106720Z -    
2026-02-20T22:09:14.4106832Z +
2026-02-20T22:09:14.4107059Z      Exemples de grilles supportées:
2026-02-20T22:09:14.4107619Z      - [triangle, cercle, carré] / [cercle, carré, triangle] / [carré, ?, triangle] → cercle
2026-02-20T22:09:14.4107858Z      - [1, 2, 3] / [2, 3, 1] / [3, ?, 2] → 1
2026-02-20T22:09:14.4107966Z -    
2026-02-20T22:09:14.4108068Z +
2026-02-20T22:09:14.4108177Z      Args:
2026-02-20T22:09:14.4108309Z          grid: Grille 2D
2026-02-20T22:09:14.4108487Z          row_idx: Index de la ligne contenant '?'
2026-02-20T22:09:14.4108664Z          col_idx: Index de la colonne contenant '?'
2026-02-20T22:09:14.4108778Z -        
2026-02-20T22:09:14.4108877Z +
2026-02-20T22:09:14.4108987Z      Returns:
2026-02-20T22:09:14.4109413Z          Élément manquant ou None si le pattern n'est pas un latin square
2026-02-20T22:09:14.4109529Z      """
2026-02-20T22:09:14.4109710Z      if not grid or not isinstance(grid, list):
2026-02-20T22:09:14.4109845Z          return None
2026-02-20T22:09:14.4109961Z -    
2026-02-20T22:09:14.4110066Z +
2026-02-20T22:09:14.4110458Z      # Collecter tous les éléments uniques de la grille (sauf '?')
2026-02-20T22:09:14.4110594Z      all_elements = set()
2026-02-20T22:09:14.4110730Z      for row in grid:
2026-02-20T22:09:14.4110875Z          if isinstance(row, list):
2026-02-20T22:09:14.4111001Z              for cell in row:
2026-02-20T22:09:14.4111188Z                  cell_str = str(cell).strip().lower()
2026-02-20T22:09:14.4111380Z -                if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4111562Z +                if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4111724Z                      all_elements.add(cell_str)
2026-02-20T22:09:14.4111837Z -    
2026-02-20T22:09:14.4111938Z +
2026-02-20T22:09:14.4112073Z      if len(all_elements) < 2:
2026-02-20T22:09:14.4112195Z          return None
2026-02-20T22:09:14.4112532Z -    
2026-02-20T22:09:14.4112800Z -    # Vérifier si c'est un latin square : 
2026-02-20T22:09:14.4112908Z +
2026-02-20T22:09:14.4113375Z +    # Vérifier si c'est un latin square :
2026-02-20T22:09:14.4113829Z      # Le nombre d'éléments uniques devrait être égal à la taille de la grille
2026-02-20T22:09:14.4114158Z      grid_size = len(grid)
2026-02-20T22:09:14.4114331Z      if len(all_elements) != grid_size:
2026-02-20T22:09:14.4114859Z          # Ce n'est peut-être pas un latin square parfait, mais on peut quand même essayer
2026-02-20T22:09:14.4114977Z          pass
2026-02-20T22:09:14.4115089Z -    
2026-02-20T22:09:14.4115191Z +
2026-02-20T22:09:14.4115596Z      # Analyser la ligne contenant '?' pour trouver l'élément manquant
2026-02-20T22:09:14.4115738Z      target_row = grid[row_idx]
2026-02-20T22:09:14.4115906Z      if not isinstance(target_row, list):
2026-02-20T22:09:14.4116032Z          return None
2026-02-20T22:09:14.4116136Z -    
2026-02-20T22:09:14.4116247Z +
2026-02-20T22:09:14.4116394Z      elements_in_row = set()
2026-02-20T22:09:14.4116524Z      for cell in target_row:
2026-02-20T22:09:14.4116677Z          cell_str = str(cell).strip().lower()
2026-02-20T22:09:14.4116866Z -        if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4117052Z +        if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4117206Z              elements_in_row.add(cell_str)
2026-02-20T22:09:14.4117314Z -    
2026-02-20T22:09:14.4117416Z +
2026-02-20T22:09:14.4117964Z      # L'élément manquant est celui qui est dans all_elements mais pas dans elements_in_row
2026-02-20T22:09:14.4118186Z      missing_in_row = all_elements - elements_in_row
2026-02-20T22:09:14.4118291Z -    
2026-02-20T22:09:14.4118391Z +
2026-02-20T22:09:14.4118527Z      if len(missing_in_row) == 1:
2026-02-20T22:09:14.4118686Z          missing = list(missing_in_row)[0]
2026-02-20T22:09:14.4118830Z          # Retrouver la casse originale
2026-02-20T22:09:14.4118955Z          for row in grid:
2026-02-20T22:09:14.4119110Z              if isinstance(row, list):
2026-02-20T22:09:14.4119238Z                  for cell in row:
2026-02-20T22:09:14.4119435Z                      if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4119576Z                          return str(cell)
2026-02-20T22:09:14.4119705Z          return missing
2026-02-20T22:09:14.4119815Z -    
2026-02-20T22:09:14.4119920Z +
2026-02-20T22:09:14.4120382Z      # Si plusieurs éléments manquent dans la ligne, essayer avec la colonne
2026-02-20T22:09:14.4120730Z      if col_idx < len(grid[0]) if len(grid) > 0 and isinstance(grid[0], list) else False:
2026-02-20T22:09:14.4120872Z          elements_in_col = set()
2026-02-20T22:09:14.4120996Z          for row in grid:
2026-02-20T22:09:14.4121217Z              if isinstance(row, list) and col_idx < len(row):
2026-02-20T22:09:14.4121414Z                  cell_str = str(row[col_idx]).strip().lower()
2026-02-20T22:09:14.4121602Z -                if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4121993Z +                if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4122162Z                      elements_in_col.add(cell_str)
2026-02-20T22:09:14.4122275Z -        
2026-02-20T22:09:14.4122392Z +
2026-02-20T22:09:14.4122605Z          missing_in_col = all_elements - elements_in_col
2026-02-20T22:09:14.4122717Z -        
2026-02-20T22:09:14.4122822Z +
2026-02-20T22:09:14.4123149Z          if len(missing_in_col) == 1:
2026-02-20T22:09:14.4123311Z              missing = list(missing_in_col)[0]
2026-02-20T22:09:14.4123466Z              # Retrouver la casse originale
2026-02-20T22:09:14.4123604Z              for row in grid:
2026-02-20T22:09:14.4123751Z                  if isinstance(row, list):
2026-02-20T22:09:14.4123887Z                      for cell in row:
2026-02-20T22:09:14.4124086Z                          if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4124236Z                              return str(cell)
2026-02-20T22:09:14.4124358Z              return missing
2026-02-20T22:09:14.4124472Z -    
2026-02-20T22:09:14.4124587Z +
2026-02-20T22:09:14.4125109Z      # Si on a trouvé des candidats dans la ligne ET la colonne, prendre l'intersection
2026-02-20T22:09:14.4125254Z      if len(missing_in_row) > 0:
2026-02-20T22:09:14.4125403Z          missing_in_col_set = set()
2026-02-20T22:09:14.4125895Z          if col_idx < (len(grid[0]) if grid and isinstance(grid[0], list) else 0):
2026-02-20T22:09:14.4126040Z              for row in grid:
2026-02-20T22:09:14.4126260Z                  if isinstance(row, list) and col_idx < len(row):
2026-02-20T22:09:14.4126471Z                      cell_str = str(row[col_idx]).strip().lower()
2026-02-20T22:09:14.4126666Z -                    if cell_str != '?' and '?' not in cell_str:
2026-02-20T22:09:14.4126854Z +                    if cell_str != "?" and "?" not in cell_str:
2026-02-20T22:09:14.4127043Z                          missing_in_col_set.add(cell_str)
2026-02-20T22:09:14.4127263Z              missing_in_col = all_elements - missing_in_col_set
2026-02-20T22:09:14.4127380Z -            
2026-02-20T22:09:14.4127490Z +
2026-02-20T22:09:14.4127704Z              intersection = missing_in_row & missing_in_col
2026-02-20T22:09:14.4127850Z              if len(intersection) == 1:
2026-02-20T22:09:14.4128016Z                  missing = list(intersection)[0]
2026-02-20T22:09:14.4128191Z                  # Retrouver la casse originale
2026-02-20T22:09:14.4128318Z                  for row in grid:
2026-02-20T22:09:14.4128472Z                      if isinstance(row, list):
2026-02-20T22:09:14.4128616Z                          for cell in row:
2026-02-20T22:09:14.4128815Z                              if str(cell).strip().lower() == missing:
2026-02-20T22:09:14.4128965Z                                  return str(cell)
2026-02-20T22:09:14.4129099Z                  return missing
2026-02-20T22:09:14.4129206Z -    
2026-02-20T22:09:14.4129306Z +
2026-02-20T22:09:14.4129416Z      return None
2026-02-20T22:09:14.4129522Z  
2026-02-20T22:09:14.4129624Z  
2026-02-20T22:09:14.4130218Z -def validate_sequence_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4130385Z +def validate_sequence_challenge(
2026-02-20T22:09:14.4130679Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4130801Z +) -> List[str]:
2026-02-20T22:09:14.4130904Z      """
2026-02-20T22:09:14.4131070Z      Valide un challenge de type SEQUENCE.
2026-02-20T22:09:14.4131458Z      Vérifie que la réponse correspond à la séquence logique.
2026-02-20T22:09:14.4131569Z      """
2026-02-20T22:09:14.4131689Z      errors = []
2026-02-20T22:09:14.4131792Z -    
2026-02-20T22:09:14.4132012Z -    if not visual_data or 'sequence' not in visual_data:
2026-02-20T22:09:14.4132116Z +
2026-02-20T22:09:14.4132336Z +    if not visual_data or "sequence" not in visual_data:
2026-02-20T22:09:14.4163450Z          # Sequence peut être dans visual_data ou directement dans la question
2026-02-20T22:09:14.4163605Z          return errors
2026-02-20T22:09:14.4163956Z -    
2026-02-20T22:09:14.4164146Z -    sequence = visual_data.get('sequence', [])
2026-02-20T22:09:14.4164252Z +
2026-02-20T22:09:14.4164438Z +    sequence = visual_data.get("sequence", [])
2026-02-20T22:09:14.4164659Z      if not sequence or not isinstance(sequence, list):
2026-02-20T22:09:14.4164797Z          return errors
2026-02-20T22:09:14.4164902Z -    
2026-02-20T22:09:14.4165010Z +
2026-02-20T22:09:14.4165424Z      # Analyser la séquence pour déterminer le prochain élément
2026-02-20T22:09:14.4165585Z      expected = analyze_sequence(sequence)
2026-02-20T22:09:14.4165698Z -    
2026-02-20T22:09:14.4165803Z +
2026-02-20T22:09:14.4165946Z      if expected is not None:
2026-02-20T22:09:14.4166165Z          correct_normalized = str(correct_answer).strip()
2026-02-20T22:09:14.4166375Z          expected_normalized = str(expected).strip()
2026-02-20T22:09:14.4166483Z -        
2026-02-20T22:09:14.4166585Z +
2026-02-20T22:09:14.4166790Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4166933Z              errors.append(
2026-02-20T22:09:14.4167427Z                  f"Séquence incohérente: la séquence {sequence} suggère '{expected}', "
2026-02-20T22:09:14.4167640Z                  f"mais correct_answer est '{correct_answer}'"
2026-02-20T22:09:14.4167756Z              )
2026-02-20T22:09:14.4168056Z -    
2026-02-20T22:09:14.4168171Z +
2026-02-20T22:09:14.4168298Z      return errors
2026-02-20T22:09:14.4168401Z  
2026-02-20T22:09:14.4168503Z  
2026-02-20T22:09:14.4168768Z  def analyze_sequence(sequence: List[Any]) -> Optional[str]:
2026-02-20T22:09:14.4168883Z      """
2026-02-20T22:09:14.4168997Z @@ -451,12 +508,14 @@
2026-02-20T22:09:14.4169152Z      if not sequence or len(sequence) < 2:
2026-02-20T22:09:14.4169280Z          return None
2026-02-20T22:09:14.4169385Z  
2026-02-20T22:09:14.4169496Z      try:
2026-02-20T22:09:14.4169607Z          nums = [
2026-02-20T22:09:14.4169754Z -            float(s) for s in sequence
2026-02-20T22:09:14.4170176Z -            if isinstance(s, (int, float, str)) and str(s).replace(".", "").replace("-", "").isdigit()
2026-02-20T22:09:14.4170302Z +            float(s)
2026-02-20T22:09:14.4170441Z +            for s in sequence
2026-02-20T22:09:14.4170605Z +            if isinstance(s, (int, float, str))
2026-02-20T22:09:14.4170838Z +            and str(s).replace(".", "").replace("-", "").isdigit()
2026-02-20T22:09:14.4170951Z          ]
2026-02-20T22:09:14.4171097Z      except (ValueError, TypeError):
2026-02-20T22:09:14.4171216Z          return None
2026-02-20T22:09:14.4171318Z  
2026-02-20T22:09:14.4171448Z      if len(nums) < 2:
2026-02-20T22:09:14.4171568Z @@ -486,203 +545,257 @@
2026-02-20T22:09:14.4171889Z              return str(int(next_num)) if next_num.is_integer() else str(next_num)
2026-02-20T22:09:14.4172001Z  
2026-02-20T22:09:14.4172114Z      return None
2026-02-20T22:09:14.4172216Z  
2026-02-20T22:09:14.4172319Z  
2026-02-20T22:09:14.4172893Z -def validate_puzzle_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4173231Z +def validate_puzzle_challenge(
2026-02-20T22:09:14.4173530Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4173654Z +) -> List[str]:
2026-02-20T22:09:14.4173761Z      """
2026-02-20T22:09:14.4173925Z      Valide un challenge de type PUZZLE.
2026-02-20T22:09:14.4174120Z      Vérifie que:
2026-02-20T22:09:14.4174459Z      - La réponse correspond à l'ordre logique des pièces
2026-02-20T22:09:14.4174816Z      - Des indices/règles sont fournis pour déterminer l'ordre
2026-02-20T22:09:14.4174992Z      - L'explication justifie l'ordre correct
2026-02-20T22:09:14.4175110Z      """
2026-02-20T22:09:14.4175225Z      errors = []
2026-02-20T22:09:14.4175328Z -    
2026-02-20T22:09:14.4175437Z +
2026-02-20T22:09:14.4175568Z      if not visual_data:
2026-02-20T22:09:14.4175862Z          errors.append("visual_data manquant pour un challenge PUZZLE")
2026-02-20T22:09:14.4175980Z          return errors
2026-02-20T22:09:14.4176294Z -    
2026-02-20T22:09:14.4176584Z -    pieces = visual_data.get('pieces', visual_data.get('items', []))
2026-02-20T22:09:14.4176690Z +
2026-02-20T22:09:14.4176971Z +    pieces = visual_data.get("pieces", visual_data.get("items", []))
2026-02-20T22:09:14.4177177Z      if not pieces or not isinstance(pieces, list):
2026-02-20T22:09:14.4177513Z          errors.append("visual_data.pieces manquant pour un challenge PUZZLE")
2026-02-20T22:09:14.4177636Z          return errors
2026-02-20T22:09:14.4177745Z -    
2026-02-20T22:09:14.4177849Z +
2026-02-20T22:09:14.4178244Z      # Vérifier qu'il y a des indices/règles pour résoudre le puzzle
2026-02-20T22:09:14.4178817Z -    hints = visual_data.get('hints', visual_data.get('rules', visual_data.get('clues', visual_data.get('indices', []))))
2026-02-20T22:09:14.4179023Z -    description = visual_data.get('description', '')
2026-02-20T22:09:14.4179124Z -    
2026-02-20T22:09:14.4179268Z +    hints = visual_data.get(
2026-02-20T22:09:14.4179377Z +        "hints",
2026-02-20T22:09:14.4179511Z +        visual_data.get(
2026-02-20T22:09:14.4179801Z +            "rules", visual_data.get("clues", visual_data.get("indices", []))
2026-02-20T22:09:14.4179915Z +        ),
2026-02-20T22:09:14.4180019Z +    )
2026-02-20T22:09:14.4180414Z +    description = visual_data.get("description", "")
2026-02-20T22:09:14.4180533Z +
2026-02-20T22:09:14.4180696Z      if not hints and not description:
2026-02-20T22:09:14.4180830Z          errors.append(
2026-02-20T22:09:14.4181207Z              "PUZZLE incomplet: aucun indice (hints/rules/clues) ni description fourni. "
2026-02-20T22:09:14.4181634Z              "L'utilisateur n'a aucun moyen de déterminer l'ordre correct."
2026-02-20T22:09:14.4181741Z          )
2026-02-20T22:09:14.4181843Z -    
2026-02-20T22:09:14.4181948Z +
2026-02-20T22:09:14.4182385Z      # Vérifier que les indices sont substantiels (pas vides ou trop courts)
2026-02-20T22:09:14.4182547Z      if hints and isinstance(hints, list):
2026-02-20T22:09:14.4182901Z          valid_hints = [h for h in hints if isinstance(h, str) and len(h.strip()) > 5]
2026-02-20T22:09:14.4183258Z          if len(valid_hints) < 2 and len(pieces) > 2:
2026-02-20T22:09:14.4183391Z              errors.append(
2026-02-20T22:09:14.4184045Z                  f"PUZZLE avec {len(pieces)} éléments mais seulement {len(valid_hints)} indice(s) valide(s). "
2026-02-20T22:09:14.4184433Z                  f"Ajoutez plus d'indices pour permettre la résolution."
2026-02-20T22:09:14.4184545Z              )
2026-02-20T22:09:14.4184645Z -    
2026-02-20T22:09:14.4184753Z +
2026-02-20T22:09:14.4185070Z      # Parser les pièces en liste de strings normalisées
2026-02-20T22:09:14.4185201Z      piece_values = []
2026-02-20T22:09:14.4185326Z      for p in pieces:
2026-02-20T22:09:14.4185470Z          if isinstance(p, dict):
2026-02-20T22:09:14.4185755Z -            val = p.get('label') or p.get('value') or p.get('name') or str(p)
2026-02-20T22:09:14.4186030Z +            val = p.get("label") or p.get("value") or p.get("name") or str(p)
2026-02-20T22:09:14.4186163Z          else:
2026-02-20T22:09:14.4186279Z              val = p
2026-02-20T22:09:14.4186483Z          piece_values.append(str(val).strip().lower())
2026-02-20T22:09:14.4186594Z -    
2026-02-20T22:09:14.4186696Z +
2026-02-20T22:09:14.4187089Z      # Pour un puzzle, la réponse devrait être une liste ordonnée
2026-02-20T22:09:14.4187218Z      if correct_answer:
2026-02-20T22:09:14.4187512Z          # Gérer correct_answer comme liste ou string
2026-02-20T22:09:14.4187680Z          if isinstance(correct_answer, list):
2026-02-20T22:09:14.4187973Z              answer_parts = [str(p).strip().lower() for p in correct_answer]
2026-02-20T22:09:14.4188086Z          else:
2026-02-20T22:09:14.4188426Z -            answer_parts = [p.strip().lower() for p in str(correct_answer).split(',')]
2026-02-20T22:09:14.4188536Z -        
2026-02-20T22:09:14.4188877Z +            answer_parts = [p.strip().lower() for p in str(correct_answer).split(",")]
2026-02-20T22:09:14.4189214Z +
2026-02-20T22:09:14.4189404Z          if len(answer_parts) != len(piece_values):
2026-02-20T22:09:14.4189539Z              errors.append(
2026-02-20T22:09:14.4190083Z                  f"Puzzle incohérent: correct_answer contient {len(answer_parts)} éléments, "
2026-02-20T22:09:14.4190458Z                  f"mais pieces contient {len(piece_values)} éléments"
2026-02-20T22:09:14.4190568Z              )
2026-02-20T22:09:14.4190679Z -        
2026-02-20T22:09:14.4190780Z +
2026-02-20T22:09:14.4191189Z          # Vérifier que tous les éléments de pieces sont dans la réponse
2026-02-20T22:09:14.4191397Z          missing = set(piece_values) - set(answer_parts)
2026-02-20T22:09:14.4191522Z          if missing:
2026-02-20T22:09:14.4192017Z              errors.append(f"Puzzle: éléments manquants dans correct_answer: {missing}")
2026-02-20T22:09:14.4192127Z -    
2026-02-20T22:09:14.4192245Z +
2026-02-20T22:09:14.4192526Z      # Vérifier que l'explication justifie l'ordre
2026-02-20T22:09:14.4192682Z      if explanation and piece_values:
2026-02-20T22:09:14.4223360Z          # L'explication devrait mentionner au moins quelques éléments
2026-02-20T22:09:14.4223598Z          explanation_lower = str(explanation).lower()
2026-02-20T22:09:14.4223951Z          mentioned_count = sum(1 for p in piece_values if p in explanation_lower)
2026-02-20T22:09:14.4224428Z          if mentioned_count < len(piece_values) // 2:
2026-02-20T22:09:14.4224594Z              errors.append(
2026-02-20T22:09:14.4225239Z                  "L'explication ne mentionne pas assez d'éléments du puzzle pour justifier l'ordre."
2026-02-20T22:09:14.4225358Z              )
2026-02-20T22:09:14.4225471Z -    
2026-02-20T22:09:14.4225576Z +
2026-02-20T22:09:14.4225698Z      return errors
2026-02-20T22:09:14.4225808Z  
2026-02-20T22:09:14.4225913Z  
2026-02-20T22:09:14.4226482Z -def validate_graph_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4226638Z +def validate_graph_challenge(
2026-02-20T22:09:14.4226958Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4227079Z +) -> List[str]:
2026-02-20T22:09:14.4227184Z      """
2026-02-20T22:09:14.4227348Z      Valide un challenge de type GRAPH.
2026-02-20T22:09:14.4227669Z      Vérifie que les nœuds et arêtes sont cohérents.
2026-02-20T22:09:14.4227788Z      """
2026-02-20T22:09:14.4227901Z      errors = []
2026-02-20T22:09:14.4228012Z -    
2026-02-20T22:09:14.4228116Z +
2026-02-20T22:09:14.4228243Z      if not visual_data:
2026-02-20T22:09:14.4228371Z          return errors
2026-02-20T22:09:14.4228474Z -    
2026-02-20T22:09:14.4228764Z -    nodes = visual_data.get('nodes', visual_data.get('vertices', []))
2026-02-20T22:09:14.4229036Z -    edges = visual_data.get('edges', visual_data.get('links', []))
2026-02-20T22:09:14.4229149Z -    
2026-02-20T22:09:14.4229250Z +
2026-02-20T22:09:14.4229533Z +    nodes = visual_data.get("nodes", visual_data.get("vertices", []))
2026-02-20T22:09:14.4229804Z +    edges = visual_data.get("edges", visual_data.get("links", []))
2026-02-20T22:09:14.4229919Z +
2026-02-20T22:09:14.4230102Z      if not nodes or not isinstance(nodes, list):
2026-02-20T22:09:14.4230508Z          errors.append("visual_data.nodes manquant ou invalide pour un challenge GRAPH")
2026-02-20T22:09:14.4230631Z          return errors
2026-02-20T22:09:14.4230741Z -    
2026-02-20T22:09:14.4230849Z +
2026-02-20T22:09:14.4231186Z      # Créer un set des noms de nœuds pour vérification
2026-02-20T22:09:14.4231314Z      node_names = set()
2026-02-20T22:09:14.4231433Z      for node in nodes:
2026-02-20T22:09:14.4231591Z          if isinstance(node, dict):
2026-02-20T22:09:14.4232001Z -            node_names.add(str(node.get('label', node.get('value', node.get('id', '')))).upper())
2026-02-20T22:09:14.4232132Z +            node_names.add(
2026-02-20T22:09:14.4232440Z +                str(node.get("label", node.get("value", node.get("id", "")))).upper()
2026-02-20T22:09:14.4232556Z +            )
2026-02-20T22:09:14.4232870Z          else:
2026-02-20T22:09:14.4233219Z              node_names.add(str(node).upper())
2026-02-20T22:09:14.4233335Z -    
2026-02-20T22:09:14.4233436Z +
2026-02-20T22:09:14.4233866Z      # Vérifier que toutes les arêtes référencent des nœuds existants
2026-02-20T22:09:14.4234046Z      if edges and isinstance(edges, list):
2026-02-20T22:09:14.4234189Z          for edge in edges:
2026-02-20T22:09:14.4234334Z              if isinstance(edge, dict):
2026-02-20T22:09:14.4234542Z -                from_node = str(edge.get('from', '')).upper()
2026-02-20T22:09:14.4234729Z -                to_node = str(edge.get('to', '')).upper()
2026-02-20T22:09:14.4234923Z +                from_node = str(edge.get("from", "")).upper()
2026-02-20T22:09:14.4235099Z +                to_node = str(edge.get("to", "")).upper()
2026-02-20T22:09:14.4235356Z              elif isinstance(edge, (list, tuple)) and len(edge) >= 2:
2026-02-20T22:09:14.4235514Z                  from_node = str(edge[0]).upper()
2026-02-20T22:09:14.4235666Z                  to_node = str(edge[1]).upper()
2026-02-20T22:09:14.4235791Z              else:
2026-02-20T22:09:14.4235911Z                  continue
2026-02-20T22:09:14.4236016Z -            
2026-02-20T22:09:14.4236116Z +
2026-02-20T22:09:14.4236646Z              if from_node and from_node not in node_names and not from_node.isdigit():
2026-02-20T22:09:14.4237449Z -                errors.append(f"Arête référence un nœud inexistant: '{edge[0] if isinstance(edge, list) else edge.get('from')}'")
2026-02-20T22:09:14.4237588Z +                errors.append(
2026-02-20T22:09:14.4238257Z +                    f"Arête référence un nœud inexistant: '{edge[0] if isinstance(edge, list) else edge.get('from')}'"
2026-02-20T22:09:14.4238370Z +                )
2026-02-20T22:09:14.4238663Z              if to_node and to_node not in node_names and not to_node.isdigit():
2026-02-20T22:09:14.4239413Z -                errors.append(f"Arête référence un nœud inexistant: '{edge[1] if isinstance(edge, list) else edge.get('to')}'")
2026-02-20T22:09:14.4239536Z -    
2026-02-20T22:09:14.4239668Z +                errors.append(
2026-02-20T22:09:14.4240293Z +                    f"Arête référence un nœud inexistant: '{edge[1] if isinstance(edge, list) else edge.get('to')}'"
2026-02-20T22:09:14.4240411Z +                )
2026-02-20T22:09:14.4240512Z +
2026-02-20T22:09:14.4240637Z      return errors
2026-02-20T22:09:14.4240747Z  
2026-02-20T22:09:14.4240849Z  
2026-02-20T22:09:14.4241417Z -def validate_spatial_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4241566Z +def validate_spatial_challenge(
2026-02-20T22:09:14.4241875Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4241992Z +) -> List[str]:
2026-02-20T22:09:14.4242098Z      """
2026-02-20T22:09:14.4242511Z      Valide un challenge de type VISUAL (inclut les défis spatiaux).
2026-02-20T22:09:14.4242942Z      Vérifie la cohérence des données de symétrie, de formes, ou de grilles.
2026-02-20T22:09:14.4243242Z      """
2026-02-20T22:09:14.4243374Z      errors = []
2026-02-20T22:09:14.4243482Z -    
2026-02-20T22:09:14.4243586Z +
2026-02-20T22:09:14.4243712Z      if not visual_data:
2026-02-20T22:09:14.4243838Z          return errors
2026-02-20T22:09:14.4243945Z -    
2026-02-20T22:09:14.4244047Z +
2026-02-20T22:09:14.4244688Z      # Vérifier si c'est un défi avec grille (souvent catégorisé comme VISUAL mais contient une grille)
2026-02-20T22:09:14.4245082Z -    grid = visual_data.get('grid', visual_data.get('matrix', visual_data.get('pattern')))
2026-02-20T22:09:14.4245219Z +    grid = visual_data.get(
2026-02-20T22:09:14.4245480Z +        "grid", visual_data.get("matrix", visual_data.get("pattern"))
2026-02-20T22:09:14.4245600Z +    )
2026-02-20T22:09:14.4245822Z      if grid and isinstance(grid, list) and len(grid) > 0:
2026-02-20T22:09:14.4246191Z          # C'est en fait un pattern caché dans un challenge VISUAL
2026-02-20T22:09:14.4246499Z          # Appliquer la même validation que pour PATTERN
2026-02-20T22:09:14.4247082Z          pattern_errors = validate_grid_in_visual(grid, correct_answer, explanation)
2026-02-20T22:09:14.4247236Z          errors.extend(pattern_errors)
2026-02-20T22:09:14.4247370Z          return errors
2026-02-20T22:09:14.4247474Z -    
2026-02-20T22:09:14.4247577Z +
2026-02-20T22:09:14.4247844Z      # Vérifier les données de symétrie
2026-02-20T22:09:14.4248028Z -    if visual_data.get('type') == 'symmetry':
2026-02-20T22:09:14.4248197Z -        layout = visual_data.get('layout', [])
2026-02-20T22:09:14.4248411Z -        symmetry_line = visual_data.get('symmetry_line')
2026-02-20T22:09:14.4248523Z -        
2026-02-20T22:09:14.4248681Z +    if visual_data.get("type") == "symmetry":
2026-02-20T22:09:14.4248837Z +        layout = visual_data.get("layout", [])
2026-02-20T22:09:14.4249043Z +        symmetry_line = visual_data.get("symmetry_line")
2026-02-20T22:09:14.4249156Z +
2026-02-20T22:09:14.4249350Z          if not layout or not isinstance(layout, list):
2026-02-20T22:09:14.4249843Z              errors.append("visual_data.layout manquant pour un défi de symétrie")
2026-02-20T22:09:14.4249981Z              return errors
2026-02-20T22:09:14.4250089Z -        
2026-02-20T22:09:14.4250190Z +
2026-02-20T22:09:14.4250806Z          # Vérifier qu'il y a une question (cellule avec '?' ou question: true)
2026-02-20T22:09:14.4250951Z          has_question = False
2026-02-20T22:09:14.4251077Z          for item in layout:
2026-02-20T22:09:14.4251224Z              if isinstance(item, dict):
2026-02-20T22:09:14.4251464Z -                if item.get('question') or item.get('shape') == '?':
2026-02-20T22:09:14.4251697Z +                if item.get("question") or item.get("shape") == "?":
2026-02-20T22:09:14.4251841Z                      has_question = True
2026-02-20T22:09:14.4251962Z                      break
2026-02-20T22:09:14.4252070Z -        
2026-02-20T22:09:14.4252172Z +
2026-02-20T22:09:14.4252299Z          if not has_question:
2026-02-20T22:09:14.4252800Z              errors.append("Défi de symétrie: aucune cellule marquée comme question")
2026-02-20T22:09:14.4252925Z -        
2026-02-20T22:09:14.4273368Z +
2026-02-20T22:09:14.4273746Z          # Vérifier la cohérence gauche/droite
2026-02-20T22:09:14.4274159Z -        left_items = [i for i in layout if isinstance(i, dict) and i.get('side') == 'left']
2026-02-20T22:09:14.4274556Z -        right_items = [i for i in layout if isinstance(i, dict) and i.get('side') == 'right']
2026-02-20T22:09:14.4274671Z -        
2026-02-20T22:09:14.4274799Z +        left_items = [
2026-02-20T22:09:14.4275102Z +            i for i in layout if isinstance(i, dict) and i.get("side") == "left"
2026-02-20T22:09:14.4275211Z +        ]
2026-02-20T22:09:14.4275349Z +        right_items = [
2026-02-20T22:09:14.4275641Z +            i for i in layout if isinstance(i, dict) and i.get("side") == "right"
2026-02-20T22:09:14.4275752Z +        ]
2026-02-20T22:09:14.4275868Z +
2026-02-20T22:09:14.4276037Z          if not left_items or not right_items:
2026-02-20T22:09:14.4276632Z -            errors.append("Défi de symétrie: les côtés gauche et droite doivent être définis")
2026-02-20T22:09:14.4276750Z -    
2026-02-20T22:09:14.4276882Z +            errors.append(
2026-02-20T22:09:14.4277345Z +                "Défi de symétrie: les côtés gauche et droite doivent être définis"
2026-02-20T22:09:14.4277456Z +            )
2026-02-20T22:09:14.4277566Z +
2026-02-20T22:09:14.4277788Z      # Vérifier les formes basiques
2026-02-20T22:09:14.4277954Z -    shapes = visual_data.get('shapes', [])
2026-02-20T22:09:14.4278117Z +    shapes = visual_data.get("shapes", [])
2026-02-20T22:09:14.4278280Z      if shapes and isinstance(shapes, list):
2026-02-20T22:09:14.4278659Z          # Détecter si c'est un défi avec associations forme-couleur
2026-02-20T22:09:14.4278970Z -        colors = {'rouge', 'red', 'bleu', 'blue', 'vert', 'green', 'jaune', 'yellow', 
2026-02-20T22:09:14.4279354Z -                  'orange', 'violet', 'purple', 'rose', 'pink', 'noir', 'black', 'blanc', 'white'}
2026-02-20T22:09:14.4280082Z -        shape_names = {'triangle', 'cercle', 'circle', 'carré', 'carre', 'square', 
2026-02-20T22:09:14.4280503Z -                       'rectangle', 'losange', 'diamond', 'étoile', 'etoile', 'star'}
2026-02-20T22:09:14.4280624Z -        
2026-02-20T22:09:14.4280737Z +        colors = {
2026-02-20T22:09:14.4280866Z +            "rouge",
2026-02-20T22:09:14.4280983Z +            "red",
2026-02-20T22:09:14.4281094Z +            "bleu",
2026-02-20T22:09:14.4281207Z +            "blue",
2026-02-20T22:09:14.4281316Z +            "vert",
2026-02-20T22:09:14.4281434Z +            "green",
2026-02-20T22:09:14.4281545Z +            "jaune",
2026-02-20T22:09:14.4281659Z +            "yellow",
2026-02-20T22:09:14.4281774Z +            "orange",
2026-02-20T22:09:14.4281886Z +            "violet",
2026-02-20T22:09:14.4282002Z +            "purple",
2026-02-20T22:09:14.4282116Z +            "rose",
2026-02-20T22:09:14.4282236Z +            "pink",
2026-02-20T22:09:14.4282344Z +            "noir",
2026-02-20T22:09:14.4282463Z +            "black",
2026-02-20T22:09:14.4282576Z +            "blanc",
2026-02-20T22:09:14.4282688Z +            "white",
2026-02-20T22:09:14.4282791Z +        }
2026-02-20T22:09:14.4282918Z +        shape_names = {
2026-02-20T22:09:14.4283222Z +            "triangle",
2026-02-20T22:09:14.4283537Z +            "cercle",
2026-02-20T22:09:14.4283666Z +            "circle",
2026-02-20T22:09:14.4283873Z +            "carré",
2026-02-20T22:09:14.4283984Z +            "carre",
2026-02-20T22:09:14.4284093Z +            "square",
2026-02-20T22:09:14.4284212Z +            "rectangle",
2026-02-20T22:09:14.4284336Z +            "losange",
2026-02-20T22:09:14.4284454Z +            "diamond",
2026-02-20T22:09:14.4284630Z +            "étoile",
2026-02-20T22:09:14.4284751Z +            "etoile",
2026-02-20T22:09:14.4284862Z +            "star",
2026-02-20T22:09:14.4284971Z +        }
2026-02-20T22:09:14.4285076Z +
2026-02-20T22:09:14.4285364Z          # Collecter les associations forme-couleur visibles (hors ?)
2026-02-20T22:09:14.4285596Z          visible_associations = {}  # {forme: set(couleurs)}
2026-02-20T22:09:14.4285729Z          question_shape = None
2026-02-20T22:09:14.4285842Z -        
2026-02-20T22:09:14.4285943Z +
2026-02-20T22:09:14.4286073Z          for shape in shapes:
2026-02-20T22:09:14.4286255Z              shape_lower = str(shape).lower()
2026-02-20T22:09:14.4286393Z -            if '?' in shape_lower:
2026-02-20T22:09:14.4286521Z +            if "?" in shape_lower:
2026-02-20T22:09:14.4286711Z                  # C'est la question - extraire la forme
2026-02-20T22:09:14.4286863Z                  for sn in shape_names:
2026-02-20T22:09:14.4287011Z                      if sn in shape_lower:
2026-02-20T22:09:14.4287160Z                          question_shape = sn
2026-02-20T22:09:14.4287290Z                          break
2026-02-20T22:09:14.4287409Z                  continue
2026-02-20T22:09:14.4287513Z -            
2026-02-20T22:09:14.4287613Z +
2026-02-20T22:09:14.4287782Z              # Trouver la forme et la couleur
2026-02-20T22:09:14.4287915Z              found_shape = None
2026-02-20T22:09:14.4288042Z              found_color = None
2026-02-20T22:09:14.4288180Z              for sn in shape_names:
2026-02-20T22:09:14.4288318Z                  if sn in shape_lower:
2026-02-20T22:09:14.4288439Z @@ -690,19 +803,21 @@
2026-02-20T22:09:14.4288561Z                      break
2026-02-20T22:09:14.4288695Z              for c in colors:
2026-02-20T22:09:14.4288831Z                  if c in shape_lower:
2026-02-20T22:09:14.4288958Z                      found_color = c
2026-02-20T22:09:14.4289081Z                      break
2026-02-20T22:09:14.4289188Z -            
2026-02-20T22:09:14.4289286Z +
2026-02-20T22:09:14.4289439Z              if found_shape and found_color:
2026-02-20T22:09:14.4289650Z                  if found_shape not in visible_associations:
2026-02-20T22:09:14.4289852Z                      visible_associations[found_shape] = set()
2026-02-20T22:09:14.4290289Z                  visible_associations[found_shape].add(found_color)
2026-02-20T22:09:14.4290405Z -        
2026-02-20T22:09:14.4290504Z +
2026-02-20T22:09:14.4291051Z          # Format multi-cellules (ex: "Position 2: carré bleu, Position 6: triangle vert")
2026-02-20T22:09:14.4291391Z -        correct_lower = str(correct_answer).lower() if correct_answer else ''
2026-02-20T22:09:14.4291885Z -        is_multi_cell = 'position' in correct_lower and (',' in correct_lower or correct_lower.count(':') >= 2)
2026-02-20T22:09:14.4292202Z +        correct_lower = str(correct_answer).lower() if correct_answer else ""
2026-02-20T22:09:14.4292417Z +        is_multi_cell = "position" in correct_lower and (
2026-02-20T22:09:14.4292639Z +            "," in correct_lower or correct_lower.count(":") >= 2
2026-02-20T22:09:14.4292748Z +        )
2026-02-20T22:09:14.4292873Z          if is_multi_cell:
2026-02-20T22:09:14.4293641Z              # Ne pas appliquer la validation forme-couleur unique (trop complexe à valider auto)
2026-02-20T22:09:14.4293771Z              pass
2026-02-20T22:09:14.4293877Z          else:
2026-02-20T22:09:14.4294139Z              answer_is_color = any(c in correct_lower for c in colors)
2026-02-20T22:09:14.4294257Z @@ -719,266 +834,317 @@
2026-02-20T22:09:14.4294666Z                      if not answer_color_found and visible_colors:
2026-02-20T22:09:14.4294826Z                          errors.append(
2026-02-20T22:09:14.4295466Z                              f"VISUAL incohérent: la réponse '{correct_answer}' n'est pas visible dans les exemples "
2026-02-20T22:09:14.4295717Z                              f"de '{question_shape}'. Visible: {visible_colors}"
2026-02-20T22:09:14.4295837Z                          )
2026-02-20T22:09:14.4295952Z -    
2026-02-20T22:09:14.4296052Z +
2026-02-20T22:09:14.4296336Z      # Vérifier que correct_answer n'est pas vide
2026-02-20T22:09:14.4296583Z      if not correct_answer or not str(correct_answer).strip():
2026-02-20T22:09:14.4296973Z          errors.append("correct_answer est vide pour un défi VISUAL")
2026-02-20T22:09:14.4297093Z -    
2026-02-20T22:09:14.4297195Z +
2026-02-20T22:09:14.4297322Z      return errors
2026-02-20T22:09:14.4297424Z  
2026-02-20T22:09:14.4297526Z  
2026-02-20T22:09:14.4298039Z -def validate_grid_in_visual(grid: List[List[Any]], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4298188Z +def validate_grid_in_visual(
2026-02-20T22:09:14.4298444Z +    grid: List[List[Any]], correct_answer: str, explanation: str
2026-02-20T22:09:14.4298569Z +) -> List[str]:
2026-02-20T22:09:14.4298676Z      """
2026-02-20T22:09:14.4298906Z      Valide une grille contenue dans un challenge VISUAL.
2026-02-20T22:09:14.4299281Z      Vérifie la cohérence entre la grille et la réponse fournie.
2026-02-20T22:09:14.4299396Z      """
2026-02-20T22:09:14.4299510Z      errors = []
2026-02-20T22:09:14.4299616Z -    
2026-02-20T22:09:14.4299728Z +
2026-02-20T22:09:14.4299873Z      # Trouver la position du '?'
2026-02-20T22:09:14.4300003Z      question_pos = None
2026-02-20T22:09:14.4300152Z      for i, row in enumerate(grid):
2026-02-20T22:09:14.4300301Z          if not isinstance(row, list):
2026-02-20T22:09:14.4300418Z              continue
2026-02-20T22:09:14.4300563Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4300832Z -            if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.4301080Z +            if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.4301217Z                  question_pos = (i, j)
2026-02-20T22:09:14.4301329Z                  break
2026-02-20T22:09:14.4301468Z          if question_pos:
2026-02-20T22:09:14.4301577Z              break
2026-02-20T22:09:14.4301683Z -    
2026-02-20T22:09:14.4301796Z +
2026-02-20T22:09:14.4301924Z      if not question_pos:
2026-02-20T22:09:14.4302143Z          # Pas de '?' à compléter
2026-02-20T22:09:14.4302265Z          return errors
2026-02-20T22:09:14.4302377Z -    
2026-02-20T22:09:14.4302479Z +
2026-02-20T22:09:14.4302828Z      row_idx, col_idx = question_pos
2026-02-20T22:09:14.4302941Z -    
2026-02-20T22:09:14.4353299Z +
2026-02-20T22:09:14.4353730Z      # Analyser le pattern pour déterminer la réponse attendue
2026-02-20T22:09:14.4354075Z      expected_answer = analyze_latin_square_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4354231Z      if not expected_answer:
2026-02-20T22:09:14.4354496Z          expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4354602Z -    
2026-02-20T22:09:14.4354709Z +
2026-02-20T22:09:14.4354846Z      if expected_answer:
2026-02-20T22:09:14.4355139Z          # Normaliser les réponses pour comparaison
2026-02-20T22:09:14.4355403Z          correct_normalized = str(correct_answer).strip().lower()
2026-02-20T22:09:14.4355672Z          expected_normalized = str(expected_answer).strip().lower()
2026-02-20T22:09:14.4355782Z -        
2026-02-20T22:09:14.4355887Z +
2026-02-20T22:09:14.4356103Z          if correct_normalized != expected_normalized:
2026-02-20T22:09:14.4356251Z              errors.append(
2026-02-20T22:09:14.4356742Z                  f"Grille VISUAL incohérente: le pattern suggère '{expected_answer}', "
2026-02-20T22:09:14.4356973Z                  f"mais correct_answer est '{correct_answer}'. "
2026-02-20T22:09:14.4357113Z                  f"Grille: {grid}"
2026-02-20T22:09:14.4357423Z              )
2026-02-20T22:09:14.4357543Z -    
2026-02-20T22:09:14.4357647Z +
2026-02-20T22:09:14.4357766Z      return errors
2026-02-20T22:09:14.4357868Z  
2026-02-20T22:09:14.4357978Z  
2026-02-20T22:09:14.4358351Z  def auto_correct_challenge(challenge_data: Dict[str, Any]) -> Dict[str, Any]:
2026-02-20T22:09:14.4358461Z      """
2026-02-20T22:09:14.4358723Z      Tente de corriger automatiquement un challenge invalide.
2026-02-20T22:09:14.4358829Z -    
2026-02-20T22:09:14.4358933Z +
2026-02-20T22:09:14.4359046Z      Args:
2026-02-20T22:09:14.4359495Z          challenge_data: Dictionnaire contenant les données du challenge
2026-02-20T22:09:14.4359603Z -        
2026-02-20T22:09:14.4359716Z +
2026-02-20T22:09:14.4359836Z      Returns:
2026-02-20T22:09:14.4360323Z          Dictionnaire corrigé (peut être identique si aucune correction possible)
2026-02-20T22:09:14.4360433Z      """
2026-02-20T22:09:14.4360591Z      corrected = challenge_data.copy()
2026-02-20T22:09:14.4360700Z -    
2026-02-20T22:09:14.4361005Z -    challenge_type = challenge_data.get('challenge_type', '').upper()
2026-02-20T22:09:14.4361218Z -    visual_data = challenge_data.get('visual_data', {})
2026-02-20T22:09:14.4361325Z -    
2026-02-20T22:09:14.4361428Z +
2026-02-20T22:09:14.4361715Z +    challenge_type = challenge_data.get("challenge_type", "").upper()
2026-02-20T22:09:14.4361916Z +    visual_data = challenge_data.get("visual_data", {})
2026-02-20T22:09:14.4362025Z +
2026-02-20T22:09:14.4362263Z      # Parser visual_data si nécessaire
2026-02-20T22:09:14.4362413Z      if isinstance(visual_data, str):
2026-02-20T22:09:14.4362528Z          try:
2026-02-20T22:09:14.4362700Z              visual_data = json.loads(visual_data)
2026-02-20T22:09:14.4362862Z          except json.JSONDecodeError:
2026-02-20T22:09:14.4363166Z              return corrected
2026-02-20T22:09:14.4363286Z -    
2026-02-20T22:09:14.4363391Z +
2026-02-20T22:09:14.4363542Z      # Correction pour PATTERN
2026-02-20T22:09:14.4363889Z -    if challenge_type == 'PATTERN' and visual_data and 'grid' in visual_data:
2026-02-20T22:09:14.4364051Z -        grid = visual_data.get('grid', [])
2026-02-20T22:09:14.4364373Z +    if challenge_type == "PATTERN" and visual_data and "grid" in visual_data:
2026-02-20T22:09:14.4364528Z +        grid = visual_data.get("grid", [])
2026-02-20T22:09:14.4364641Z          if grid:
2026-02-20T22:09:14.4364919Z              # Plusieurs "?" → format "O, O, X, O"
2026-02-20T22:09:14.4365163Z              expected_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:14.4365299Z              if expected_multi:
2026-02-20T22:09:14.4365784Z -                logger.info(f"Correction automatique PATTERN (multi): correct_answer = '{expected_multi}'")
2026-02-20T22:09:14.4366210Z -                corrected['correct_answer'] = expected_multi
2026-02-20T22:09:14.4366488Z -                explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4367123Z -                if expected_multi[:20] not in explanation and expected_multi.split(',')[0].strip().upper() not in explanation.upper():
2026-02-20T22:09:14.4367324Z -                    corrected['solution_explanation'] = (
2026-02-20T22:09:14.4367460Z +                logger.info(
2026-02-20T22:09:14.4367872Z +                    f"Correction automatique PATTERN (multi): correct_answer = '{expected_multi}'"
2026-02-20T22:09:14.4367978Z +                )
2026-02-20T22:09:14.4368189Z +                corrected["correct_answer"] = expected_multi
2026-02-20T22:09:14.4368449Z +                explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4368561Z +                if (
2026-02-20T22:09:14.4368749Z +                    expected_multi[:20] not in explanation
2026-02-20T22:09:14.4368996Z +                    and expected_multi.split(",")[0].strip().upper()
2026-02-20T22:09:14.4369161Z +                    not in explanation.upper()
2026-02-20T22:09:14.4369269Z +                ):
2026-02-20T22:09:14.4369635Z +                    corrected["solution_explanation"] = (
2026-02-20T22:09:14.4370148Z                          f"Les symboles manquants, dans l'ordre des cases (ligne par ligne), sont : {expected_multi}. "
2026-02-20T22:09:14.4370298Z                          f"{explanation}"
2026-02-20T22:09:14.4370420Z                      )
2026-02-20T22:09:14.4370529Z              else:
2026-02-20T22:09:14.4370668Z                  question_pos = None
2026-02-20T22:09:14.4370826Z                  for i, row in enumerate(grid):
2026-02-20T22:09:14.4370996Z                      if not isinstance(row, list):
2026-02-20T22:09:14.4371122Z                          continue
2026-02-20T22:09:14.4371285Z                      for j, cell in enumerate(row):
2026-02-20T22:09:14.4371550Z -                        if cell == '?' or (isinstance(cell, str) and '?' in cell):
2026-02-20T22:09:14.4371793Z +                        if cell == "?" or (isinstance(cell, str) and "?" in cell):
2026-02-20T22:09:14.4371943Z                              question_pos = (i, j)
2026-02-20T22:09:14.4372082Z                              break
2026-02-20T22:09:14.4372217Z                      if question_pos:
2026-02-20T22:09:14.4372338Z                          break
2026-02-20T22:09:14.4372466Z                  if question_pos:
2026-02-20T22:09:14.4372641Z                      row_idx, col_idx = question_pos
2026-02-20T22:09:14.4372911Z                      expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4373230Z                      if expected_answer:
2026-02-20T22:09:14.4373717Z -                        logger.info(f"Correction automatique PATTERN: correct_answer = '{expected_answer}'")
2026-02-20T22:09:14.4373947Z -                        corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4374064Z -                    
2026-02-20T22:09:14.4374204Z +                        logger.info(
2026-02-20T22:09:14.4374594Z +                            f"Correction automatique PATTERN: correct_answer = '{expected_answer}'"
2026-02-20T22:09:14.4374717Z +                        )
2026-02-20T22:09:14.4374934Z +                        corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4375047Z +
2026-02-20T22:09:14.4375448Z                      # Mettre à jour l'explication si elle est contradictoire
2026-02-20T22:09:14.4375698Z -                    explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4375963Z +                    explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4376218Z                      if expected_answer.upper() not in explanation.upper():
2026-02-20T22:09:14.4376417Z -                        corrected['solution_explanation'] = (
2026-02-20T22:09:14.4376606Z +                        corrected["solution_explanation"] = (
2026-02-20T22:09:14.4377399Z                              f"En analysant le pattern dans la grille, on observe que le motif se répète. "
2026-02-20T22:09:14.4377861Z                              f"Le pattern suggère que la réponse est '{expected_answer}'. "
2026-02-20T22:09:14.4378034Z                              f"{explanation}"
2026-02-20T22:09:14.4378149Z                          )
2026-02-20T22:09:14.4378255Z -    
2026-02-20T22:09:14.4378357Z +
2026-02-20T22:09:14.4378522Z      # Correction pour VISUAL avec grille
2026-02-20T22:09:14.4378710Z -    if challenge_type == 'VISUAL' and visual_data:
2026-02-20T22:09:14.4379111Z -        grid = visual_data.get('grid', visual_data.get('matrix', visual_data.get('pattern')))
2026-02-20T22:09:14.4379302Z +    if challenge_type == "VISUAL" and visual_data:
2026-02-20T22:09:14.4379440Z +        grid = visual_data.get(
2026-02-20T22:09:14.4379706Z +            "grid", visual_data.get("matrix", visual_data.get("pattern"))
2026-02-20T22:09:14.4379833Z +        )
2026-02-20T22:09:14.4380057Z          if grid and isinstance(grid, list) and len(grid) > 0:
2026-02-20T22:09:14.4380208Z              # Trouver la position du '?'
2026-02-20T22:09:14.4380341Z              question_pos = None
2026-02-20T22:09:14.4380675Z              for i, row in enumerate(grid):
2026-02-20T22:09:14.4380846Z                  if not isinstance(row, list):
2026-02-20T22:09:14.4380972Z                      continue
2026-02-20T22:09:14.4381138Z                  for j, cell in enumerate(row):
2026-02-20T22:09:14.4381413Z -                    if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:14.4381672Z +                    if cell == "?" or (isinstance(cell, str) and "?" in str(cell)):
2026-02-20T22:09:14.4381829Z                          question_pos = (i, j)
2026-02-20T22:09:14.4381946Z                          break
2026-02-20T22:09:14.4382077Z                  if question_pos:
2026-02-20T22:09:14.4382191Z                      break
2026-02-20T22:09:14.4382312Z -            
2026-02-20T22:09:14.4382417Z +
2026-02-20T22:09:14.4382549Z              if question_pos:
2026-02-20T22:09:14.4382719Z                  row_idx, col_idx = question_pos
2026-02-20T22:09:14.4413320Z                  expected_answer = analyze_latin_square_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4413499Z                  if not expected_answer:
2026-02-20T22:09:14.4413792Z                      expected_answer = analyze_pattern(grid, row_idx, col_idx)
2026-02-20T22:09:14.4413916Z -                
2026-02-20T22:09:14.4414028Z +
2026-02-20T22:09:14.4414172Z                  if expected_answer:
2026-02-20T22:09:14.4414555Z -                    current_answer = str(corrected.get('correct_answer', '')).strip().lower()
2026-02-20T22:09:14.4414697Z +                    current_answer = (
2026-02-20T22:09:14.4414965Z +                        str(corrected.get("correct_answer", "")).strip().lower()
2026-02-20T22:09:14.4415091Z +                    )
2026-02-20T22:09:14.4415304Z                      expected_lower = expected_answer.lower()
2026-02-20T22:09:14.4415421Z -                    
2026-02-20T22:09:14.4415526Z +
2026-02-20T22:09:14.4415718Z                      if current_answer != expected_lower:
2026-02-20T22:09:14.4416710Z -                        logger.info(f"Correction automatique VISUAL: correct_answer changé de '{corrected.get('correct_answer')}' à '{expected_answer}'")
2026-02-20T22:09:14.4416947Z -                        corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4417070Z -                        
2026-02-20T22:09:14.4417204Z +                        logger.info(
2026-02-20T22:09:14.4418080Z +                            f"Correction automatique VISUAL: correct_answer changé de '{corrected.get('correct_answer')}' à '{expected_answer}'"
2026-02-20T22:09:14.4418206Z +                        )
2026-02-20T22:09:14.4418427Z +                        corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4418751Z +
2026-02-20T22:09:14.4419178Z                          # Mettre à jour l'explication et le titre si contradictoires
2026-02-20T22:09:14.4419472Z -                        explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4419669Z -                        title = corrected.get('title', '')
2026-02-20T22:09:14.4419885Z -                        question = corrected.get('question', '')
2026-02-20T22:09:14.4420008Z -                        
2026-02-20T22:09:14.4420277Z +                        explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4420456Z +                        title = corrected.get("title", "")
2026-02-20T22:09:14.4420662Z +                        question = corrected.get("question", "")
2026-02-20T22:09:14.4420763Z +
2026-02-20T22:09:14.4420925Z                          # Corriger l'explication
2026-02-20T22:09:14.4421171Z                          if expected_lower not in explanation.lower():
2026-02-20T22:09:14.4421379Z -                            corrected['solution_explanation'] = (
2026-02-20T22:09:14.4421589Z +                            corrected["solution_explanation"] = (
2026-02-20T22:09:14.4422053Z                                  f"En analysant la grille, chaque ligne doit contenir chaque forme une seule fois. "
2026-02-20T22:09:14.4423278Z                                  f"La ligne avec '?' contient déjà les autres formes, donc l'élément manquant est '{expected_answer}'. "
2026-02-20T22:09:14.4423436Z                              )
2026-02-20T22:09:14.4423557Z -                        
2026-02-20T22:09:14.4423674Z +
2026-02-20T22:09:14.4423982Z                          # Corriger le titre si incohérent
2026-02-20T22:09:14.4424529Z                          # Ex: "Où est le carré manquant ?" devrait devenir "Où est le cercle manquant ?"
2026-02-20T22:09:14.4424667Z                          if title:
2026-02-20T22:09:14.4424839Z                              title_lower = title.lower()
2026-02-20T22:09:14.4425218Z                              # Détecter si le titre mentionne une mauvaise forme
2026-02-20T22:09:14.4425755Z -                            shapes = ['triangle', 'cercle', 'carré', 'losange', 'étoile', 'rectangle']
2026-02-20T22:09:14.4425892Z +                            shapes = [
2026-02-20T22:09:14.4426043Z +                                "triangle",
2026-02-20T22:09:14.4426175Z +                                "cercle",
2026-02-20T22:09:14.4426393Z +                                "carré",
2026-02-20T22:09:14.4426528Z +                                "losange",
2026-02-20T22:09:14.4426735Z +                                "étoile",
2026-02-20T22:09:14.4426885Z +                                "rectangle",
2026-02-20T22:09:14.4427006Z +                            ]
2026-02-20T22:09:14.4427164Z                              for shape in shapes:
2026-02-20T22:09:14.4427432Z                                  if shape in title_lower and shape != expected_lower:
2026-02-20T22:09:14.4427862Z                                      # Le titre mentionne une autre forme que la bonne réponse
2026-02-20T22:09:14.4428515Z -                                    new_title = title.replace(shape, expected_answer).replace(shape.capitalize(), expected_answer.capitalize())
2026-02-20T22:09:14.4429098Z -                                    logger.info(f"Correction automatique titre: '{title}' → '{new_title}'")
2026-02-20T22:09:14.4429294Z -                                    corrected['title'] = new_title
2026-02-20T22:09:14.4429481Z +                                    new_title = title.replace(
2026-02-20T22:09:14.4429659Z +                                        shape, expected_answer
2026-02-20T22:09:14.4429813Z +                                    ).replace(
2026-02-20T22:09:14.4430084Z +                                        shape.capitalize(), expected_answer.capitalize()
2026-02-20T22:09:14.4430208Z +                                    )
2026-02-20T22:09:14.4430364Z +                                    logger.info(
2026-02-20T22:09:14.4430843Z +                                        f"Correction automatique titre: '{title}' → '{new_title}'"
2026-02-20T22:09:14.4431167Z +                                    )
2026-02-20T22:09:14.4431366Z +                                    corrected["title"] = new_title
2026-02-20T22:09:14.4431750Z                                      break
2026-02-20T22:09:14.4431870Z -    
2026-02-20T22:09:14.4431976Z +
2026-02-20T22:09:14.4432126Z      # Correction pour SEQUENCE
2026-02-20T22:09:14.4432476Z -    if challenge_type == 'SEQUENCE' and visual_data and 'sequence' in visual_data:
2026-02-20T22:09:14.4432662Z -        sequence = visual_data.get('sequence', [])
2026-02-20T22:09:14.4433191Z +    if challenge_type == "SEQUENCE" and visual_data and "sequence" in visual_data:
2026-02-20T22:09:14.4433382Z +        sequence = visual_data.get("sequence", [])
2026-02-20T22:09:14.4433688Z          if sequence and isinstance(sequence, list) and len(sequence) >= 2:
2026-02-20T22:09:14.4433905Z              expected_answer = analyze_sequence(sequence)
2026-02-20T22:09:14.4434030Z -            
2026-02-20T22:09:14.4434132Z +
2026-02-20T22:09:14.4434268Z              if expected_answer:
2026-02-20T22:09:14.4434523Z -                current_answer = corrected.get('correct_answer', '')
2026-02-20T22:09:14.4434771Z +                current_answer = corrected.get("correct_answer", "")
2026-02-20T22:09:14.4435065Z                  if str(current_answer).strip() != str(expected_answer).strip():
2026-02-20T22:09:14.4435944Z -                    logger.info(f"Correction automatique SEQUENCE: correct_answer changé de '{current_answer}' à '{expected_answer}'")
2026-02-20T22:09:14.4436167Z -                    corrected['correct_answer'] = expected_answer
2026-02-20T22:09:14.4436281Z -                    
2026-02-20T22:09:14.4436418Z +                    logger.info(
2026-02-20T22:09:14.4437166Z +                        f"Correction automatique SEQUENCE: correct_answer changé de '{current_answer}' à '{expected_answer}'"
2026-02-20T22:09:14.4437285Z +                    )
2026-02-20T22:09:14.4437520Z +                    corrected["correct_answer"] = expected_answer
2026-02-20T22:09:14.4437627Z +
2026-02-20T22:09:14.4438013Z                      # Mettre à jour l'explication si elle est contradictoire
2026-02-20T22:09:14.4438298Z -                    explanation = corrected.get('solution_explanation', '')
2026-02-20T22:09:14.4438566Z +                    explanation = corrected.get("solution_explanation", "")
2026-02-20T22:09:14.4438765Z                      if expected_answer not in explanation:
2026-02-20T22:09:14.4438965Z -                        corrected['solution_explanation'] = (
2026-02-20T22:09:14.4439167Z +                        corrected["solution_explanation"] = (
2026-02-20T22:09:14.4439767Z                              f"En analysant la séquence {sequence}, on observe une progression arithmétique. "
2026-02-20T22:09:14.4440226Z                              f"Le prochain élément de la séquence est '{expected_answer}'. "
2026-02-20T22:09:14.4440399Z                              f"{explanation}"
2026-02-20T22:09:14.4440513Z                          )
2026-02-20T22:09:14.4440617Z -    
2026-02-20T22:09:14.4440721Z +
2026-02-20T22:09:14.4440889Z      # Correction pour CODING (labyrinthes)
2026-02-20T22:09:14.4441083Z -    if challenge_type == 'CODING' and visual_data:
2026-02-20T22:09:14.4441498Z -        maze = visual_data.get('maze') or visual_data.get('grid') or visual_data.get('labyrinth')
2026-02-20T22:09:14.4441819Z -        start = visual_data.get('start') or visual_data.get('start_position')
2026-02-20T22:09:14.4442229Z -        end = visual_data.get('end') or visual_data.get('end_position') or visual_data.get('goal')
2026-02-20T22:09:14.4442338Z -        
2026-02-20T22:09:14.4442530Z +    if challenge_type == "CODING" and visual_data:
2026-02-20T22:09:14.4442644Z +        maze = (
2026-02-20T22:09:14.4442783Z +            visual_data.get("maze")
2026-02-20T22:09:14.4442925Z +            or visual_data.get("grid")
2026-02-20T22:09:14.4473337Z +            or visual_data.get("labyrinth")
2026-02-20T22:09:14.4473683Z +        )
2026-02-20T22:09:14.4474165Z +        start = visual_data.get("start") or visual_data.get("start_position")
2026-02-20T22:09:14.4474292Z +        end = (
2026-02-20T22:09:14.4474436Z +            visual_data.get("end")
2026-02-20T22:09:14.4474777Z +            or visual_data.get("end_position")
2026-02-20T22:09:14.4474940Z +            or visual_data.get("goal")
2026-02-20T22:09:14.4475054Z +        )
2026-02-20T22:09:14.4475157Z +
2026-02-20T22:09:14.4475295Z          if maze and start and end:
2026-02-20T22:09:14.4475544Z              # C'est un labyrinthe - valider et corriger le chemin
2026-02-20T22:09:14.4475783Z -            current_answer = corrected.get('correct_answer', '')
2026-02-20T22:09:14.4476012Z +            current_answer = corrected.get("correct_answer", "")
2026-02-20T22:09:14.4476231Z              correct_path = solve_maze_bfs(maze, start, end)
2026-02-20T22:09:14.4476340Z -            
2026-02-20T22:09:14.4476453Z +
2026-02-20T22:09:14.4476581Z              if correct_path:
2026-02-20T22:09:14.4476937Z                  # Vérifier si la réponse actuelle est valide
2026-02-20T22:09:14.4477234Z                  is_valid = validate_maze_path(maze, start, end, current_answer)
2026-02-20T22:09:14.4477345Z -                
2026-02-20T22:09:14.4477465Z +
2026-02-20T22:09:14.4477598Z                  if not is_valid:
2026-02-20T22:09:14.4478315Z -                    logger.info(f"Correction automatique MAZE: chemin invalide '{current_answer}' → '{correct_path}'")
2026-02-20T22:09:14.4478528Z -                    corrected['correct_answer'] = correct_path
2026-02-20T22:09:14.4478718Z -                    corrected['solution_explanation'] = (
2026-02-20T22:09:14.4478846Z +                    logger.info(
2026-02-20T22:09:14.4479461Z +                        f"Correction automatique MAZE: chemin invalide '{current_answer}' → '{correct_path}'"
2026-02-20T22:09:14.4479588Z +                    )
2026-02-20T22:09:14.4479782Z +                    corrected["correct_answer"] = correct_path
2026-02-20T22:09:14.4479979Z +                    corrected["solution_explanation"] = (
2026-02-20T22:09:14.4480358Z                          f"Pour aller du départ {start} à l'arrivée {end}, "
2026-02-20T22:09:14.4480586Z                          f"le chemin optimal est : {correct_path}. "
2026-02-20T22:09:14.4481111Z                          f"Ce chemin évite tous les murs (#) et utilise uniquement les cases libres."
2026-02-20T22:09:14.4481237Z                      )
2026-02-20T22:09:14.4481349Z              else:
2026-02-20T22:09:14.4482016Z -                logger.warning(f"Impossible de trouver un chemin valide dans le labyrinthe de {start} à {end}")
2026-02-20T22:09:14.4482139Z -    
2026-02-20T22:09:14.4482278Z +                logger.warning(
2026-02-20T22:09:14.4482826Z +                    f"Impossible de trouver un chemin valide dans le labyrinthe de {start} à {end}"
2026-02-20T22:09:14.4482938Z +                )
2026-02-20T22:09:14.4483236Z +
2026-02-20T22:09:14.4483363Z      return corrected
2026-02-20T22:09:14.4483465Z  
2026-02-20T22:09:14.4483572Z  
2026-02-20T22:09:14.4484120Z -def validate_riddle_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4484268Z +def validate_riddle_challenge(
2026-02-20T22:09:14.4484572Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4484703Z +) -> List[str]:
2026-02-20T22:09:14.4484808Z      """
2026-02-20T22:09:14.4484963Z      Valide un challenge de type RIDDLE.
2026-02-20T22:09:14.4485379Z      Vérifie la présence de données permettant de résoudre l'énigme.
2026-02-20T22:09:14.4485492Z      """
2026-02-20T22:09:14.4485609Z      errors = []
2026-02-20T22:09:14.4485742Z      if not visual_data:
2026-02-20T22:09:14.4485952Z          errors.append("RIDDLE: visual_data manquant")
2026-02-20T22:09:14.4486073Z          return errors
2026-02-20T22:09:14.4486393Z -    has_clues = bool(visual_data.get('clues') or visual_data.get('indices'))
2026-02-20T22:09:14.4487110Z -    has_context = bool(visual_data.get('context') or visual_data.get('scenario') or visual_data.get('scene'))
2026-02-20T22:09:14.4487449Z -    has_riddle = bool(visual_data.get('riddle') or visual_data.get('question'))
2026-02-20T22:09:14.4487922Z -    has_grid = bool(visual_data.get('grid') or visual_data.get('pattern'))
2026-02-20T22:09:14.4488257Z +    has_clues = bool(visual_data.get("clues") or visual_data.get("indices"))
2026-02-20T22:09:14.4488388Z +    has_context = bool(
2026-02-20T22:09:14.4488528Z +        visual_data.get("context")
2026-02-20T22:09:14.4488676Z +        or visual_data.get("scenario")
2026-02-20T22:09:14.4488814Z +        or visual_data.get("scene")
2026-02-20T22:09:14.4488921Z +    )
2026-02-20T22:09:14.4489242Z +    has_riddle = bool(visual_data.get("riddle") or visual_data.get("question"))
2026-02-20T22:09:14.4489558Z +    has_grid = bool(visual_data.get("grid") or visual_data.get("pattern"))
2026-02-20T22:09:14.4489815Z      if not (has_clues or has_context or has_riddle or has_grid):
2026-02-20T22:09:14.4489941Z          errors.append(
2026-02-20T22:09:14.4490308Z              "RIDDLE: visual_data doit contenir au moins clues, context, riddle ou grid "
2026-02-20T22:09:14.4490598Z              "pour permettre de résoudre l'énigme"
2026-02-20T22:09:14.4490720Z          )
2026-02-20T22:09:14.4490845Z      return errors
2026-02-20T22:09:14.4490947Z  
2026-02-20T22:09:14.4491052Z  
2026-02-20T22:09:14.4491653Z -def validate_probability_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4491816Z +def validate_probability_challenge(
2026-02-20T22:09:14.4492112Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4492230Z +) -> List[str]:
2026-02-20T22:09:14.4492348Z      """
2026-02-20T22:09:14.4492529Z      Valide un challenge de type PROBABILITY.
2026-02-20T22:09:14.4492920Z      Vérifie la présence de données numériques (quantités, totaux).
2026-02-20T22:09:14.4493210Z      """
2026-02-20T22:09:14.4493334Z      errors = []
2026-02-20T22:09:14.4493462Z      if not visual_data:
2026-02-20T22:09:14.4493698Z          errors.append("PROBABILITY: visual_data manquant")
2026-02-20T22:09:14.4493829Z          return errors
2026-02-20T22:09:14.4493962Z      has_counts = False
2026-02-20T22:09:14.4494118Z      for key, val in visual_data.items():
2026-02-20T22:09:14.4494358Z -        if key.lower() in ('total', 'description', 'question'):
2026-02-20T22:09:14.4494583Z +        if key.lower() in ("total", "description", "question"):
2026-02-20T22:09:14.4494698Z              continue
2026-02-20T22:09:14.4494888Z          if isinstance(val, (int, float)) and val > 0:
2026-02-20T22:09:14.4495024Z              has_counts = True
2026-02-20T22:09:14.4495135Z              break
2026-02-20T22:09:14.4495275Z          if isinstance(val, dict):
2026-02-20T22:09:14.4495403Z @@ -992,145 +1158,198 @@
2026-02-20T22:09:14.4495584Z              "(ex: rouge_bonbons: 10, bleu_bonbons: 5)"
2026-02-20T22:09:14.4495703Z          )
2026-02-20T22:09:14.4495817Z      return errors
2026-02-20T22:09:14.4495927Z  
2026-02-20T22:09:14.4496025Z  
2026-02-20T22:09:14.4496574Z -def validate_chess_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4496737Z +def validate_chess_challenge(
2026-02-20T22:09:14.4497028Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4497150Z +) -> List[str]:
2026-02-20T22:09:14.4497468Z      """Valide un challenge de type CHESS (échecs)."""
2026-02-20T22:09:14.4497591Z      errors = []
2026-02-20T22:09:14.4497717Z      if not visual_data:
2026-02-20T22:09:14.4497909Z          errors.append("CHESS: visual_data est vide")
2026-02-20T22:09:14.4498039Z          return errors
2026-02-20T22:09:14.4498144Z  
2026-02-20T22:09:14.4498300Z -    board = visual_data.get('board', [])
2026-02-20T22:09:14.4498457Z +    board = visual_data.get("board", [])
2026-02-20T22:09:14.4498883Z      if not board or not isinstance(board, list):
2026-02-20T22:09:14.4499171Z          errors.append("CHESS: visual_data.board manquant ou invalide")
2026-02-20T22:09:14.4499297Z          return errors
2026-02-20T22:09:14.4499409Z  
2026-02-20T22:09:14.4499537Z      if len(board) != 8:
2026-02-20T22:09:14.4500158Z          errors.append(f"CHESS: board doit avoir 8 rangées, reçu {len(board)}")
2026-02-20T22:09:14.4500455Z -    valid_pieces = {'K', 'k', 'Q', 'q', 'R', 'r', 'B', 'b', 'N', 'n', 'P', 'p', ''}
2026-02-20T22:09:14.4500730Z +    valid_pieces = {"K", "k", "Q", "q", "R", "r", "B", "b", "N", "n", "P", "p", ""}
2026-02-20T22:09:14.4500880Z      for i, row in enumerate(board):
2026-02-20T22:09:14.4501132Z          if not isinstance(row, (list, tuple)) or len(row) != 8:
2026-02-20T22:09:14.4501599Z              errors.append(f"CHESS: board[{i}] doit être une liste de 8 éléments")
2026-02-20T22:09:14.4501712Z              break
2026-02-20T22:09:14.4501858Z          for j, cell in enumerate(row):
2026-02-20T22:09:14.4502055Z -            val = str(cell).strip() if cell else ''
2026-02-20T22:09:14.4502219Z +            val = str(cell).strip() if cell else ""
2026-02-20T22:09:14.4502381Z              if val and val not in valid_pieces:
2026-02-20T22:09:14.4502814Z                  errors.append(f"CHESS: pièce invalide '{cell}' en [{i},{j}]")
2026-02-20T22:09:14.4502930Z                  break
2026-02-20T22:09:14.4533271Z  
2026-02-20T22:09:14.4533502Z -    turn = visual_data.get('turn', '').lower()
2026-02-20T22:09:14.4533663Z -    if turn not in ('white', 'black'):
2026-02-20T22:09:14.4533834Z +    turn = visual_data.get("turn", "").lower()
2026-02-20T22:09:14.4533981Z +    if turn not in ("white", "black"):
2026-02-20T22:09:14.4534516Z          errors.append(f"CHESS: turn doit être 'white' ou 'black', reçu '{turn}'")
2026-02-20T22:09:14.4534630Z  
2026-02-20T22:09:14.4534828Z -    objective = visual_data.get('objective', '')
2026-02-20T22:09:14.4535092Z -    valid_obj = ('mat_en_1', 'mat_en_2', 'mat_en_3', 'meilleur_coup')
2026-02-20T22:09:14.4535294Z +    objective = visual_data.get("objective", "")
2026-02-20T22:09:14.4535551Z +    valid_obj = ("mat_en_1", "mat_en_2", "mat_en_3", "meilleur_coup")
2026-02-20T22:09:14.4535704Z      if objective not in valid_obj:
2026-02-20T22:09:14.4536135Z          errors.append(f"CHESS: objective doit être parmi {valid_obj}")
2026-02-20T22:09:14.4536249Z  
2026-02-20T22:09:14.4536500Z      if not correct_answer or not str(correct_answer).strip():
2026-02-20T22:09:14.4537028Z          errors.append("CHESS: correct_answer est vide (notation algébrique attendue)")
2026-02-20T22:09:14.4537135Z  
2026-02-20T22:09:14.4537251Z      return errors
2026-02-20T22:09:14.4537360Z  
2026-02-20T22:09:14.4537465Z  
2026-02-20T22:09:14.4538023Z -def validate_coding_challenge(visual_data: Dict[str, Any], correct_answer: str, explanation: str) -> List[str]:
2026-02-20T22:09:14.4538172Z +def validate_coding_challenge(
2026-02-20T22:09:14.4538462Z +    visual_data: Dict[str, Any], correct_answer: str, explanation: str
2026-02-20T22:09:14.4538592Z +) -> List[str]:
2026-02-20T22:09:14.4538695Z      """
2026-02-20T22:09:14.4538859Z      Valide un challenge de type CODING.
2026-02-20T22:09:14.4539198Z      REJETTE les défis qui ne sont pas de vraie cryptographie.
2026-02-20T22:09:14.4539300Z      """
2026-02-20T22:09:14.4539396Z      errors = []
2026-02-20T22:09:14.4539494Z -    
2026-02-20T22:09:14.4539580Z +
2026-02-20T22:09:14.4539694Z      if not visual_data:
2026-02-20T22:09:14.4540262Z -        errors.append("CODING: visual_data est vide - un défi de cryptographie doit avoir des données")
2026-02-20T22:09:14.4540376Z -        return errors
2026-02-20T22:09:14.4540473Z -    
2026-02-20T22:09:14.4540595Z +        errors.append(
2026-02-20T22:09:14.4541081Z +            "CODING: visual_data est vide - un défi de cryptographie doit avoir des données"
2026-02-20T22:09:14.4541183Z +        )
2026-02-20T22:09:14.4541293Z +        return errors
2026-02-20T22:09:14.4541396Z +
2026-02-20T22:09:14.4541782Z      # Types valides pour CODING (cryptographie)
2026-02-20T22:09:14.4542139Z -    valid_coding_types = ['caesar', 'substitution', 'binary', 'symbols', 'algorithm', 'maze']
2026-02-20T22:09:14.4542321Z -    coding_type = visual_data.get('type', '').lower()
2026-02-20T22:09:14.4542411Z -    
2026-02-20T22:09:14.4542683Z +    valid_coding_types = [
2026-02-20T22:09:14.4542799Z +        "caesar",
2026-02-20T22:09:14.4542921Z +        "substitution",
2026-02-20T22:09:14.4543214Z +        "binary",
2026-02-20T22:09:14.4543325Z +        "symbols",
2026-02-20T22:09:14.4543450Z +        "algorithm",
2026-02-20T22:09:14.4543552Z +        "maze",
2026-02-20T22:09:14.4543651Z +    ]
2026-02-20T22:09:14.4543842Z +    coding_type = visual_data.get("type", "").lower()
2026-02-20T22:09:14.4543950Z +
2026-02-20T22:09:14.4544318Z      # Détecter si c'est un labyrinthe (même sans "type" explicite)
2026-02-20T22:09:14.4544706Z -    maze = visual_data.get('maze') or visual_data.get('grid') or visual_data.get('labyrinth')
2026-02-20T22:09:14.4545008Z -    start = visual_data.get('start') or visual_data.get('start_position')
2026-02-20T22:09:14.4545346Z -    end = visual_data.get('end') or visual_data.get('end_position') or visual_data.get('goal')
2026-02-20T22:09:14.4545442Z +    maze = (
2026-02-20T22:09:14.4545575Z +        visual_data.get("maze")
2026-02-20T22:09:14.4545695Z +        or visual_data.get("grid")
2026-02-20T22:09:14.4545816Z +        or visual_data.get("labyrinth")
2026-02-20T22:09:14.4545898Z +    )
2026-02-20T22:09:14.4546132Z +    start = visual_data.get("start") or visual_data.get("start_position")
2026-02-20T22:09:14.4546219Z +    end = (
2026-02-20T22:09:14.4546324Z +        visual_data.get("end")
2026-02-20T22:09:14.4546452Z +        or visual_data.get("end_position")
2026-02-20T22:09:14.4546556Z +        or visual_data.get("goal")
2026-02-20T22:09:14.4546638Z +    )
2026-02-20T22:09:14.4546771Z      is_maze = maze and start and end
2026-02-20T22:09:14.4546880Z -    
2026-02-20T22:09:14.4546986Z +
2026-02-20T22:09:14.4547451Z      # Détecter si c'est une SÉQUENCE ou un FAUX LABYRINTHE (INVALIDE pour CODING)
2026-02-20T22:09:14.4547694Z -    has_sequence = visual_data.get('sequence') is not None
2026-02-20T22:09:14.4548093Z -    has_pattern = visual_data.get('pattern') and not visual_data.get('encoded_message')
2026-02-20T22:09:14.4548303Z -    has_shapes = visual_data.get('shapes') is not None
2026-02-20T22:09:14.4548417Z -    
2026-02-20T22:09:14.4548641Z +    has_sequence = visual_data.get("sequence") is not None
2026-02-20T22:09:14.4549019Z +    has_pattern = visual_data.get("pattern") and not visual_data.get("encoded_message")
2026-02-20T22:09:14.4549228Z +    has_shapes = visual_data.get("shapes") is not None
2026-02-20T22:09:14.4549341Z +
2026-02-20T22:09:14.4549838Z      # Détecter les "labyrinthes de nombres" - CE N'EST PAS DE LA CRYPTOGRAPHIE !
2026-02-20T22:09:14.4550058Z -    has_numbers = visual_data.get('numbers') is not None
2026-02-20T22:09:14.4550264Z -    has_target = visual_data.get('target') is not None
2026-02-20T22:09:14.4550842Z -    has_movement_options = visual_data.get('movement_options') is not None or visual_data.get('movement') is not None
2026-02-20T22:09:14.4551059Z +    has_numbers = visual_data.get("numbers") is not None
2026-02-20T22:09:14.4551269Z +    has_target = visual_data.get("target") is not None
2026-02-20T22:09:14.4551407Z +    has_movement_options = (
2026-02-20T22:09:14.4551608Z +        visual_data.get("movement_options") is not None
2026-02-20T22:09:14.4551789Z +        or visual_data.get("movement") is not None
2026-02-20T22:09:14.4551895Z +    )
2026-02-20T22:09:14.4552226Z      is_fake_number_maze = has_numbers and (has_target or has_movement_options)
2026-02-20T22:09:14.4552332Z -    
2026-02-20T22:09:14.4552442Z +
2026-02-20T22:09:14.4552784Z      # Rejeter les séquences, patterns, et faux labyrinthes
2026-02-20T22:09:14.4552909Z      if has_sequence:
2026-02-20T22:09:14.4553722Z -        errors.append("CODING INVALIDE: 'sequence' détectée - utiliser le type SEQUENCE, pas CODING")
2026-02-20T22:09:14.4554065Z -        return errors
2026-02-20T22:09:14.4554213Z -    
2026-02-20T22:09:14.4554353Z +        errors.append(
2026-02-20T22:09:14.4554905Z +            "CODING INVALIDE: 'sequence' détectée - utiliser le type SEQUENCE, pas CODING"
2026-02-20T22:09:14.4555185Z +        )
2026-02-20T22:09:14.4555319Z +        return errors
2026-02-20T22:09:14.4555430Z +
2026-02-20T22:09:14.4555577Z      if has_pattern and not is_maze:
2026-02-20T22:09:14.4556115Z -        errors.append("CODING INVALIDE: 'pattern' sans cryptographie - utiliser le type PATTERN, pas CODING")
2026-02-20T22:09:14.4556248Z -        return errors
2026-02-20T22:09:14.4556352Z -    
2026-02-20T22:09:14.4556476Z +        errors.append(
2026-02-20T22:09:14.4556921Z +            "CODING INVALIDE: 'pattern' sans cryptographie - utiliser le type PATTERN, pas CODING"
2026-02-20T22:09:14.4557039Z +        )
2026-02-20T22:09:14.4557160Z +        return errors
2026-02-20T22:09:14.4557269Z +
2026-02-20T22:09:14.4557409Z      if has_shapes:
2026-02-20T22:09:14.4558025Z -        errors.append("CODING INVALIDE: 'shapes' détectées - utiliser le type VISUAL, pas CODING")
2026-02-20T22:09:14.4558150Z -        return errors
2026-02-20T22:09:14.4558254Z -    
2026-02-20T22:09:14.4558382Z +        errors.append(
2026-02-20T22:09:14.4558882Z +            "CODING INVALIDE: 'shapes' détectées - utiliser le type VISUAL, pas CODING"
2026-02-20T22:09:14.4558997Z +        )
2026-02-20T22:09:14.4559123Z +        return errors
2026-02-20T22:09:14.4559225Z +
2026-02-20T22:09:14.4559357Z      if is_fake_number_maze:
2026-02-20T22:09:14.4559483Z          errors.append(
2026-02-20T22:09:14.4560029Z              "CODING INVALIDE: 'numbers' + 'target' détectés - c'est un labyrinthe de nombres, "
2026-02-20T22:09:14.4560396Z              "pas de la cryptographie ! Utiliser le type SEQUENCE ou PUZZLE, pas CODING."
2026-02-20T22:09:14.4560503Z          )
2026-02-20T22:09:14.4560631Z          return errors
2026-02-20T22:09:14.4560747Z -    
2026-02-20T22:09:14.4560852Z +
2026-02-20T22:09:14.4561352Z      # Rejeter aussi les défis avec uniquement des nombres et pas de message encodé
2026-02-20T22:09:14.4561795Z -    if has_numbers and not visual_data.get('encoded_message') and not visual_data.get('message'):
2026-02-20T22:09:14.4561908Z +    if (
2026-02-20T22:09:14.4562039Z +        has_numbers
2026-02-20T22:09:14.4562233Z +        and not visual_data.get("encoded_message")
2026-02-20T22:09:14.4562391Z +        and not visual_data.get("message")
2026-02-20T22:09:14.4562498Z +    ):
2026-02-20T22:09:14.4562630Z          errors.append(
2026-02-20T22:09:14.4593583Z              "CODING INVALIDE: 'numbers' sans 'encoded_message' - CODING doit avoir un message secret à décoder, "
2026-02-20T22:09:14.4593764Z              "pas une liste de nombres."
2026-02-20T22:09:14.4593883Z          )
2026-02-20T22:09:14.4594012Z          return errors
2026-02-20T22:09:14.4594121Z -    
2026-02-20T22:09:14.4594221Z +
2026-02-20T22:09:14.4594650Z      # Vérifier le type ou la présence d'éléments de cryptographie
2026-02-20T22:09:14.4595089Z -    has_encoded_message = visual_data.get('encoded_message') or visual_data.get('message')
2026-02-20T22:09:14.4595575Z -    has_crypto_key = visual_data.get('key') or visual_data.get('partial_key') or visual_data.get('shift')
2026-02-20T22:09:14.4595973Z -    has_steps = visual_data.get('steps') and isinstance(visual_data.get('steps'), list)
2026-02-20T22:09:14.4596082Z -    
2026-02-20T22:09:14.4596439Z +    has_encoded_message = visual_data.get("encoded_message") or visual_data.get(
2026-02-20T22:09:14.4596554Z +        "message"
2026-02-20T22:09:14.4596668Z +    )
2026-02-20T22:09:14.4596792Z +    has_crypto_key = (
2026-02-20T22:09:14.4596929Z +        visual_data.get("key")
2026-02-20T22:09:14.4597094Z +        or visual_data.get("partial_key")
2026-02-20T22:09:14.4597235Z +        or visual_data.get("shift")
2026-02-20T22:09:14.4597339Z +    )
2026-02-20T22:09:14.4597726Z +    has_steps = visual_data.get("steps") and isinstance(visual_data.get("steps"), list)
2026-02-20T22:09:14.4598102Z +
2026-02-20T22:09:14.4598293Z      is_valid_crypto = (
2026-02-20T22:09:14.4598510Z -        coding_type in valid_coding_types or
2026-02-20T22:09:14.4598905Z -        is_maze or
2026-02-20T22:09:14.4599127Z -        has_encoded_message or
2026-02-20T22:09:14.4643638Z -        (has_crypto_key and has_encoded_message) or
2026-02-20T22:09:14.4643804Z -        has_steps
2026-02-20T22:09:14.4643978Z +        coding_type in valid_coding_types
2026-02-20T22:09:14.4644101Z +        or is_maze
2026-02-20T22:09:14.4644294Z +        or has_encoded_message
2026-02-20T22:09:14.4644489Z +        or (has_crypto_key and has_encoded_message)
2026-02-20T22:09:14.4644613Z +        or has_steps
2026-02-20T22:09:14.4644717Z      )
2026-02-20T22:09:14.4644819Z -    
2026-02-20T22:09:14.4644922Z +
2026-02-20T22:09:14.4645066Z      if not is_valid_crypto:
2026-02-20T22:09:14.4645187Z          errors.append(
2026-02-20T22:09:14.4645571Z              f"CODING INVALIDE: Le visual_data ne contient pas de cryptographie valide. "
2026-02-20T22:09:14.4645943Z              f"Attendu: type={valid_coding_types}, encoded_message, key/shift, ou maze. "
2026-02-20T22:09:14.4646251Z              f"Reçu: {list(visual_data.keys())}"
2026-02-20T22:09:14.4646360Z          )
2026-02-20T22:09:14.4646470Z -    
2026-02-20T22:09:14.4646579Z +
2026-02-20T22:09:14.4646758Z      # Si c'est un labyrinthe, valider le chemin
2026-02-20T22:09:14.4646872Z      if is_maze:
2026-02-20T22:09:14.4647154Z          if not validate_maze_path(maze, start, end, correct_answer):
2026-02-20T22:09:14.4647850Z -            errors.append(f"MAZE: Le chemin '{correct_answer}' ne mène pas du départ {start} à l'arrivée {end}")
2026-02-20T22:09:14.4647985Z +            errors.append(
2026-02-20T22:09:14.4648567Z +                f"MAZE: Le chemin '{correct_answer}' ne mène pas du départ {start} à l'arrivée {end}"
2026-02-20T22:09:14.4648680Z +            )
2026-02-20T22:09:14.4648785Z  
2026-02-20T22:09:14.4649390Z      # Substitution : clé complète OU partial_key avec règle déductible (caesar, atbash, keyword)
2026-02-20T22:09:14.4649649Z      if coding_type == "substitution" and has_encoded_message:
2026-02-20T22:09:14.4650054Z -        msg = (visual_data.get("encoded_message") or visual_data.get("message") or "").upper()
2026-02-20T22:09:14.4650177Z +        msg = (
2026-02-20T22:09:14.4650514Z +            visual_data.get("encoded_message") or visual_data.get("message") or ""
2026-02-20T22:09:14.4650627Z +        ).upper()
2026-02-20T22:09:14.4650963Z          decode_key = visual_data.get("key") or visual_data.get("partial_key") or {}
2026-02-20T22:09:14.4651414Z -        rule_type = (visual_data.get("rule_type") or visual_data.get("deducible_rule") or "").lower()
2026-02-20T22:09:14.4651537Z +        rule_type = (
2026-02-20T22:09:14.4651858Z +            visual_data.get("rule_type") or visual_data.get("deducible_rule") or ""
2026-02-20T22:09:14.4651972Z +        ).lower()
2026-02-20T22:09:14.4652189Z          letters_in_msg = set(c for c in msg if c.isalpha())
2026-02-20T22:09:14.4652434Z          keys_upper = set(k.upper() for k in decode_key.keys())
2026-02-20T22:09:14.4652606Z          missing = letters_in_msg - keys_upper
2026-02-20T22:09:14.4653610Z          # Si règle déductible (César, Atbash, clé-mot), partial_key avec 3+ exemples suffit
2026-02-20T22:09:14.4654027Z -        is_deducible = rule_type in ("caesar", "cesar", "atbash", "reverse", "keyword", "cle-mot")
2026-02-20T22:09:14.4654181Z +        is_deducible = rule_type in (
2026-02-20T22:09:14.4654307Z +            "caesar",
2026-02-20T22:09:14.4654423Z +            "cesar",
2026-02-20T22:09:14.4654534Z +            "atbash",
2026-02-20T22:09:14.4654656Z +            "reverse",
2026-02-20T22:09:14.4654767Z +            "keyword",
2026-02-20T22:09:14.4654883Z +            "cle-mot",
2026-02-20T22:09:14.4654992Z +        )
2026-02-20T22:09:14.4655128Z          if is_deducible:
2026-02-20T22:09:14.4655264Z              if len(decode_key) < 2:
2026-02-20T22:09:14.4655619Z                  errors.append(
2026-02-20T22:09:14.4656316Z                      "SUBSTITUTION: Avec rule_type déductible, fournir au moins 2-3 exemples dans partial_key."
2026-02-20T22:09:14.4656432Z                  )
2026-02-20T22:09:14.4656552Z @@ -1140,139 +1359,151 @@
2026-02-20T22:09:14.4657357Z                  "Fournir une clé complète OU rule_type (caesar/atbash/keyword) avec partial_key déductible."
2026-02-20T22:09:14.4657487Z              )
2026-02-20T22:09:14.4657611Z      return errors
2026-02-20T22:09:14.4657713Z  
2026-02-20T22:09:14.4657822Z  
2026-02-20T22:09:14.4658242Z -def solve_maze_bfs(maze: List[List[str]], start: List[int], end: List[int]) -> Optional[str]:
2026-02-20T22:09:14.4658369Z +def solve_maze_bfs(
2026-02-20T22:09:14.4658611Z +    maze: List[List[str]], start: List[int], end: List[int]
2026-02-20T22:09:14.4658740Z +) -> Optional[str]:
2026-02-20T22:09:14.4658847Z      """
2026-02-20T22:09:14.4659265Z      Résout un labyrinthe avec BFS et retourne le chemin en directions.
2026-02-20T22:09:14.4659394Z -    
2026-02-20T22:09:14.4659499Z +
2026-02-20T22:09:14.4659607Z      Args:
2026-02-20T22:09:14.4659845Z          maze: Grille du labyrinthe (# = mur, espace = chemin)
2026-02-20T22:09:14.4660106Z          start: Position de départ [row, col]
2026-02-20T22:09:14.4660354Z          end: Position d'arrivée [row, col]
2026-02-20T22:09:14.4660458Z -    
2026-02-20T22:09:14.4660570Z +
2026-02-20T22:09:14.4660683Z      Returns:
2026-02-20T22:09:14.4661046Z          Chemin en directions (ex: "BAS, BAS, DROITE, DROITE") ou None si pas de solution
2026-02-20T22:09:14.4661163Z      """
2026-02-20T22:09:14.4661315Z      from collections import deque
2026-02-20T22:09:14.4661421Z -    
2026-02-20T22:09:14.4661527Z +
2026-02-20T22:09:14.4661691Z      if not maze or not start or not end:
2026-02-20T22:09:14.4661811Z          return None
2026-02-20T22:09:14.4661915Z -    
2026-02-20T22:09:14.4662027Z +
2026-02-20T22:09:14.4662152Z      rows = len(maze)
2026-02-20T22:09:14.4662307Z      cols = len(maze[0]) if rows > 0 else 0
2026-02-20T22:09:14.4662411Z -    
2026-02-20T22:09:14.4662519Z +
2026-02-20T22:09:14.4662686Z      start_row, start_col = start[0], start[1]
2026-02-20T22:09:14.4662829Z      end_row, end_col = end[0], end[1]
2026-02-20T22:09:14.4662944Z -    
2026-02-20T22:09:14.4663234Z +
2026-02-20T22:09:14.4663510Z      # Vérifier que start et end sont valides
2026-02-20T22:09:14.4663730Z      if not (0 <= start_row < rows and 0 <= start_col < cols):
2026-02-20T22:09:14.4663864Z          return None
2026-02-20T22:09:14.4664058Z      if not (0 <= end_row < rows and 0 <= end_col < cols):
2026-02-20T22:09:14.4664173Z          return None
2026-02-20T22:09:14.4664282Z -    
2026-02-20T22:09:14.4664383Z +
2026-02-20T22:09:14.4664550Z      # Directions : (delta_row, delta_col, nom)
2026-02-20T22:09:14.4664670Z -    directions = [
2026-02-20T22:09:14.4664804Z -        (-1, 0, "HAUT"),
2026-02-20T22:09:14.4664919Z -        (1, 0, "BAS"),
2026-02-20T22:09:14.4665043Z -        (0, -1, "GAUCHE"),
2026-02-20T22:09:14.4665175Z -        (0, 1, "DROITE")
2026-02-20T22:09:14.4665279Z -    ]
2026-02-20T22:09:14.4665378Z -    
2026-02-20T22:09:14.4665688Z +    directions = [(-1, 0, "HAUT"), (1, 0, "BAS"), (0, -1, "GAUCHE"), (0, 1, "DROITE")]
2026-02-20T22:09:14.4665810Z +
2026-02-20T22:09:14.4665930Z      # BFS
2026-02-20T22:09:14.4666106Z      queue = deque([(start_row, start_col, [])])
2026-02-20T22:09:14.4666268Z      visited = {(start_row, start_col)}
2026-02-20T22:09:14.4666374Z -    
2026-02-20T22:09:14.4666479Z +
2026-02-20T22:09:14.4666594Z      while queue:
2026-02-20T22:09:14.4666759Z          row, col, path = queue.popleft()
2026-02-20T22:09:14.4666864Z -        
2026-02-20T22:09:14.4666963Z +
2026-02-20T22:09:14.4667171Z          # Arrivée atteinte
2026-02-20T22:09:14.4667326Z          if row == end_row and col == end_col:
2026-02-20T22:09:14.4667688Z              return ", ".join(path) if path else "DÉJÀ À L'ARRIVÉE"
2026-02-20T22:09:14.4667804Z -        
2026-02-20T22:09:14.4668110Z +
2026-02-20T22:09:14.4668276Z          for dr, dc, direction in directions:
2026-02-20T22:09:14.4668440Z              new_row, new_col = row + dr, col + dc
2026-02-20T22:09:14.4668554Z -            
2026-02-20T22:09:14.4668657Z +
2026-02-20T22:09:14.4668879Z              # Vérifier les limites
2026-02-20T22:09:14.4669276Z              if not (0 <= new_row < rows and 0 <= new_col < cols):
2026-02-20T22:09:14.4669405Z                  continue
2026-02-20T22:09:14.4669519Z -            
2026-02-20T22:09:14.4669621Z +
2026-02-20T22:09:14.4669867Z              # Vérifier si déjà visité
2026-02-20T22:09:14.4670026Z              if (new_row, new_col) in visited:
2026-02-20T22:09:14.4670145Z                  continue
2026-02-20T22:09:14.4670261Z -            
2026-02-20T22:09:14.4670366Z +
2026-02-20T22:09:14.4670589Z              # Vérifier si c'est un mur
2026-02-20T22:09:14.4670975Z -            cell = maze[new_row][new_col] if isinstance(maze[new_row], list) else maze[new_row]
2026-02-20T22:09:14.4671121Z +            cell = (
2026-02-20T22:09:14.4671258Z +                maze[new_row][new_col]
2026-02-20T22:09:14.4671431Z +                if isinstance(maze[new_row], list)
2026-02-20T22:09:14.4671572Z +                else maze[new_row]
2026-02-20T22:09:14.4671680Z +            )
2026-02-20T22:09:14.4671831Z              if isinstance(cell, list):
2026-02-20T22:09:14.4672069Z -                cell = cell[new_col] if new_col < len(cell) else '#'
2026-02-20T22:09:14.4672177Z -            
2026-02-20T22:09:14.4672409Z -            if cell in ['#', '█', '1']:
2026-02-20T22:09:14.4672626Z +                cell = cell[new_col] if new_col < len(cell) else "#"
2026-02-20T22:09:14.4672742Z +
2026-02-20T22:09:14.4672950Z +            if cell in ["#", "█", "1"]:
2026-02-20T22:09:14.4703351Z                  continue
2026-02-20T22:09:14.4703483Z -            
2026-02-20T22:09:14.4703591Z +
2026-02-20T22:09:14.4703845Z              # Ajouter à la file
2026-02-20T22:09:14.4704015Z              visited.add((new_row, new_col))
2026-02-20T22:09:14.4704294Z              queue.append((new_row, new_col, path + [direction]))
2026-02-20T22:09:14.4704406Z -    
2026-02-20T22:09:14.4704516Z +
2026-02-20T22:09:14.4704735Z      return None  # Pas de chemin trouvé
2026-02-20T22:09:14.4704843Z  
2026-02-20T22:09:14.4704948Z  
2026-02-20T22:09:14.4705460Z -def validate_maze_path(maze: List[List[str]], start: List[int], end: List[int], path_str: str) -> bool:
2026-02-20T22:09:14.4705615Z +def validate_maze_path(
2026-02-20T22:09:14.4705916Z +    maze: List[List[str]], start: List[int], end: List[int], path_str: str
2026-02-20T22:09:14.4706033Z +) -> bool:
2026-02-20T22:09:14.4706150Z      """
2026-02-20T22:09:14.4706482Z      Vérifie si un chemin est valide dans un labyrinthe.
2026-02-20T22:09:14.4706589Z -    
2026-02-20T22:09:14.4706692Z +
2026-02-20T22:09:14.4706812Z      Args:
2026-02-20T22:09:14.4706955Z          maze: Grille du labyrinthe
2026-02-20T22:09:14.4707213Z          start: Position de départ [row, col]
2026-02-20T22:09:14.4707473Z          end: Position d'arrivée [row, col]
2026-02-20T22:09:14.4707707Z          path_str: Chemin en texte (ex: "BAS, DROITE, DROITE")
2026-02-20T22:09:14.4707816Z -    
2026-02-20T22:09:14.4707933Z +
2026-02-20T22:09:14.4708047Z      Returns:
2026-02-20T22:09:14.4708369Z          True si le chemin est valide et mène à l'arrivée
2026-02-20T22:09:14.4708482Z      """
2026-02-20T22:09:14.4708701Z      if not maze or not start or not end or not path_str:
2026-02-20T22:09:14.4708824Z          return False
2026-02-20T22:09:14.4708928Z -    
2026-02-20T22:09:14.4709042Z +
2026-02-20T22:09:14.4709165Z      rows = len(maze)
2026-02-20T22:09:14.4709310Z      cols = len(maze[0]) if rows > 0 else 0
2026-02-20T22:09:14.4709416Z -    
2026-02-20T22:09:14.4709533Z +
2026-02-20T22:09:14.4709660Z      # Parser le chemin
2026-02-20T22:09:14.4709789Z      directions_map = {
2026-02-20T22:09:14.4709969Z -        'haut': (-1, 0), 'up': (-1, 0), 'h': (-1, 0),
2026-02-20T22:09:14.4710127Z -        'bas': (1, 0), 'down': (1, 0), 'b': (1, 0),
2026-02-20T22:09:14.4710562Z -        'gauche': (0, -1), 'left': (0, -1), 'g': (0, -1),
2026-02-20T22:09:14.4710744Z -        'droite': (0, 1), 'right': (0, 1), 'd': (0, 1)
2026-02-20T22:09:14.4710875Z +        "haut": (-1, 0),
2026-02-20T22:09:14.4710989Z +        "up": (-1, 0),
2026-02-20T22:09:14.4711271Z +        "h": (-1, 0),
2026-02-20T22:09:14.4711409Z +        "bas": (1, 0),
2026-02-20T22:09:14.4711529Z +        "down": (1, 0),
2026-02-20T22:09:14.4711638Z +        "b": (1, 0),
2026-02-20T22:09:14.4711764Z +        "gauche": (0, -1),
2026-02-20T22:09:14.4711897Z +        "left": (0, -1),
2026-02-20T22:09:14.4712015Z +        "g": (0, -1),
2026-02-20T22:09:14.4712141Z +        "droite": (0, 1),
2026-02-20T22:09:14.4712265Z +        "right": (0, 1),
2026-02-20T22:09:14.4712374Z +        "d": (0, 1),
2026-02-20T22:09:14.4712477Z      }
2026-02-20T22:09:14.4712582Z -    
2026-02-20T22:09:14.4712692Z +
2026-02-20T22:09:14.4712850Z      # Extraire les directions du chemin
2026-02-20T22:09:14.4713463Z -    path_parts = [p.strip().lower() for p in path_str.replace(',', ' ').split() if p.strip()]
2026-02-20T22:09:14.4713580Z -    
2026-02-20T22:09:14.4713708Z +    path_parts = [
2026-02-20T22:09:14.4714033Z +        p.strip().lower() for p in path_str.replace(",", " ").split() if p.strip()
2026-02-20T22:09:14.4714148Z +    ]
2026-02-20T22:09:14.4714260Z +
2026-02-20T22:09:14.4714400Z      row, col = start[0], start[1]
2026-02-20T22:09:14.4714504Z -    
2026-02-20T22:09:14.4714612Z +
2026-02-20T22:09:14.4714751Z      for direction in path_parts:
2026-02-20T22:09:14.4714907Z          if direction not in directions_map:
2026-02-20T22:09:14.4715018Z              continue
2026-02-20T22:09:14.4715127Z -        
2026-02-20T22:09:14.4715226Z +
2026-02-20T22:09:14.4715381Z          dr, dc = directions_map[direction]
2026-02-20T22:09:14.4715549Z          new_row, new_col = row + dr, col + dc
2026-02-20T22:09:14.4715657Z -        
2026-02-20T22:09:14.4715761Z +
2026-02-20T22:09:14.4715994Z          # Vérifier les limites
2026-02-20T22:09:14.4716222Z          if not (0 <= new_row < rows and 0 <= new_col < cols):
2026-02-20T22:09:14.4716347Z              return False
2026-02-20T22:09:14.4716462Z -        
2026-02-20T22:09:14.4716600Z +
2026-02-20T22:09:14.4716812Z          # Vérifier si c'est un mur
2026-02-20T22:09:14.4716951Z          cell = maze[new_row]
2026-02-20T22:09:14.4717093Z          if isinstance(cell, list):
2026-02-20T22:09:14.4717331Z -            cell = cell[new_col] if new_col < len(cell) else '#'
2026-02-20T22:09:14.4717548Z +            cell = cell[new_col] if new_col < len(cell) else "#"
2026-02-20T22:09:14.4717770Z          elif isinstance(cell, str) and new_col < len(cell):
2026-02-20T22:09:14.4717905Z              cell = cell[new_col]
2026-02-20T22:09:14.4718020Z          else:
2026-02-20T22:09:14.4718141Z -            cell = '#'
2026-02-20T22:09:14.4718253Z -        
2026-02-20T22:09:14.4718469Z -        if cell in ['#', '█', '1']:
2026-02-20T22:09:14.4718587Z +            cell = "#"
2026-02-20T22:09:14.4718700Z +
2026-02-20T22:09:14.4718908Z +        if cell in ["#", "█", "1"]:
2026-02-20T22:09:14.4719026Z              return False
2026-02-20T22:09:14.4719132Z -        
2026-02-20T22:09:14.4719239Z +
2026-02-20T22:09:14.4719375Z          row, col = new_row, new_col
2026-02-20T22:09:14.4719477Z -    
2026-02-20T22:09:14.4719591Z +
2026-02-20T22:09:14.4719865Z      # Vérifier si on est arrivé à destination
2026-02-20T22:09:14.4720013Z      return row == end[0] and col == end[1]
2026-02-20T22:09:14.4720115Z -
2026-02-20T22:09:14.4720588Z would reformat /home/runner/work/mathakine/mathakine/app/services/challenge_validator.py
2026-02-20T22:09:14.7869408Z --- /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:14.7872912Z +++ /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py	2026-02-20 22:09:14.783951+00:00
2026-02-20T22:09:14.7876133Z @@ -1,8 +1,9 @@
2026-02-20T22:09:14.7878582Z  """
2026-02-20T22:09:14.7881563Z  Handlers pour la gestion des badges et achievements (API)
2026-02-20T22:09:14.7883547Z  """
2026-02-20T22:09:14.7887751Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/badge_handlers.py
2026-02-20T22:09:14.7888490Z +
2026-02-20T22:09:14.7891967Z  import json
2026-02-20T22:09:14.7894131Z  import traceback
2026-02-20T22:09:14.7897808Z  
2026-02-20T22:09:14.7899845Z  from starlette.requests import Request
2026-02-20T22:09:14.7900393Z  from starlette.responses import JSONResponse
2026-02-20T22:09:14.7900852Z @@ -29,13 +30,18 @@
2026-02-20T22:09:14.7901200Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7901752Z              user_badges_data = badge_service.get_user_badges(user_id)
2026-02-20T22:09:14.7902457Z              return JSONResponse({"success": True, "data": user_badges_data})
2026-02-20T22:09:14.7903185Z  
2026-02-20T22:09:14.7903496Z      except Exception as user_badges_error:
2026-02-20T22:09:14.7904596Z -        logger.error(f"Erreur lors de la récupération des badges utilisateur: {user_badges_error}")
2026-02-20T22:09:14.7905382Z -        traceback.print_exc()
2026-02-20T22:09:14.7906072Z -        return JSONResponse({"error": get_safe_error_message(user_badges_error)}, status_code=500)
2026-02-20T22:09:14.7906862Z +        logger.error(
2026-02-20T22:09:14.7907581Z +            f"Erreur lors de la récupération des badges utilisateur: {user_badges_error}"
2026-02-20T22:09:14.7908208Z +        )
2026-02-20T22:09:14.7908497Z +        traceback.print_exc()
2026-02-20T22:09:14.7908871Z +        return JSONResponse(
2026-02-20T22:09:14.7909412Z +            {"error": get_safe_error_message(user_badges_error)}, status_code=500
2026-02-20T22:09:14.7909983Z +        )
2026-02-20T22:09:14.7910243Z +
2026-02-20T22:09:14.7910483Z  
2026-02-20T22:09:14.7910805Z  async def get_available_badges(request: Request):
2026-02-20T22:09:14.7911519Z      """Récupérer tous les badges disponibles avec traductions"""
2026-02-20T22:09:14.7912026Z      try:
2026-02-20T22:09:14.7912490Z          accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:14.7913203Z @@ -43,19 +49,21 @@
2026-02-20T22:09:14.7913498Z  
2026-02-20T22:09:14.7913775Z          async with db_session() as db:
2026-02-20T22:09:14.7914220Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7914789Z              available_badges = badge_service.get_available_badges()
2026-02-20T22:09:14.7915294Z  
2026-02-20T22:09:14.7915570Z -        return JSONResponse({
2026-02-20T22:09:14.7915940Z -            "success": True,
2026-02-20T22:09:14.7916322Z -            "data": available_badges
2026-02-20T22:09:14.7916695Z -        })
2026-02-20T22:09:14.7917149Z +        return JSONResponse({"success": True, "data": available_badges})
2026-02-20T22:09:14.7917706Z  
2026-02-20T22:09:14.7918025Z      except Exception as available_badges_error:
2026-02-20T22:09:14.7918965Z -        logger.error(f"Erreur lors de la récupération des badges disponibles: {available_badges_error}")
2026-02-20T22:09:14.7919734Z +        logger.error(
2026-02-20T22:09:14.7920450Z +            f"Erreur lors de la récupération des badges disponibles: {available_badges_error}"
2026-02-20T22:09:14.7921101Z +        )
2026-02-20T22:09:14.7921415Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:14.7922193Z -        return JSONResponse({"error": get_safe_error_message(available_badges_error)}, status_code=500)
2026-02-20T22:09:14.7923116Z +        return JSONResponse(
2026-02-20T22:09:14.7923685Z +            {"error": get_safe_error_message(available_badges_error)}, status_code=500
2026-02-20T22:09:14.7924304Z +        )
2026-02-20T22:09:14.7924562Z +
2026-02-20T22:09:14.7924796Z  
2026-02-20T22:09:14.7925045Z  @require_auth
2026-02-20T22:09:14.7925362Z  async def check_user_badges(request):
2026-02-20T22:09:14.7926152Z      """Forcer la vérification des badges pour un utilisateur (utile pour les tests)"""
2026-02-20T22:09:14.7926789Z      try:
2026-02-20T22:09:14.7927054Z @@ -63,21 +71,32 @@
2026-02-20T22:09:14.7927654Z          user_id = current_user.get("id")
2026-02-20T22:09:14.7928052Z  
2026-02-20T22:09:14.7928322Z          async with db_session() as db:
2026-02-20T22:09:14.7928764Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7929364Z              new_badges = badge_service.check_and_award_badges(user_id)
2026-02-20T22:09:14.7930112Z -            return JSONResponse({
2026-02-20T22:09:14.7930514Z -                "success": True,
2026-02-20T22:09:14.7930914Z -                "new_badges": new_badges,
2026-02-20T22:09:14.7931361Z -                "badges_earned": len(new_badges),
2026-02-20T22:09:14.7932159Z -                "message": f"{len(new_badges)} nouveaux badges obtenus" if new_badges else "Aucun nouveau badge",
2026-02-20T22:09:14.7932906Z -            })
2026-02-20T22:09:14.7933392Z +            return JSONResponse(
2026-02-20T22:09:14.7933743Z +                {
2026-02-20T22:09:14.7934048Z +                    "success": True,
2026-02-20T22:09:14.7934466Z +                    "new_badges": new_badges,
2026-02-20T22:09:14.7934937Z +                    "badges_earned": len(new_badges),
2026-02-20T22:09:14.7935387Z +                    "message": (
2026-02-20T22:09:14.7935847Z +                        f"{len(new_badges)} nouveaux badges obtenus"
2026-02-20T22:09:14.7936363Z +                        if new_badges
2026-02-20T22:09:14.7936797Z +                        else "Aucun nouveau badge"
2026-02-20T22:09:14.7937221Z +                    ),
2026-02-20T22:09:14.7937531Z +                }
2026-02-20T22:09:14.7937802Z +            )
2026-02-20T22:09:14.7938069Z  
2026-02-20T22:09:14.7938389Z      except Exception as badge_verification_error:
2026-02-20T22:09:14.7939365Z -        logger.error(f"Erreur lors de la vérification forcée des badges: {badge_verification_error}")
2026-02-20T22:09:14.7940138Z -        traceback.print_exc()
2026-02-20T22:09:14.7940880Z -        return JSONResponse({"error": get_safe_error_message(badge_verification_error)}, status_code=500)
2026-02-20T22:09:14.7941662Z +        logger.error(
2026-02-20T22:09:14.7942364Z +            f"Erreur lors de la vérification forcée des badges: {badge_verification_error}"
2026-02-20T22:09:14.7943204Z +        )
2026-02-20T22:09:14.7943501Z +        traceback.print_exc()
2026-02-20T22:09:14.7943888Z +        return JSONResponse(
2026-02-20T22:09:14.7944484Z +            {"error": get_safe_error_message(badge_verification_error)}, status_code=500
2026-02-20T22:09:14.7945112Z +        )
2026-02-20T22:09:14.7945359Z +
2026-02-20T22:09:14.7945599Z  
2026-02-20T22:09:14.7945848Z  @require_auth
2026-02-20T22:09:14.7946199Z  async def get_user_gamification_stats(request):
2026-02-20T22:09:14.7946955Z      """Récupérer les statistiques de gamification d'un utilisateur"""
2026-02-20T22:09:14.7947500Z      try:
2026-02-20T22:09:14.7947764Z @@ -88,56 +107,70 @@
2026-02-20T22:09:14.7948092Z              from sqlalchemy import text
2026-02-20T22:09:14.7948495Z  
2026-02-20T22:09:14.7948781Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7949318Z              user_data = badge_service.get_user_badges(user_id)
2026-02-20T22:09:14.7949790Z  
2026-02-20T22:09:14.7950071Z -            stats = db.execute(text("""
2026-02-20T22:09:14.7950491Z +            stats = db.execute(
2026-02-20T22:09:14.7950849Z +                text("""
2026-02-20T22:09:14.7951189Z                  SELECT
2026-02-20T22:09:14.7951538Z                      COUNT(*) as total_attempts,
2026-02-20T22:09:14.7952115Z                      COUNT(CASE WHEN is_correct THEN 1 END) as correct_attempts,
2026-02-20T22:09:14.7952724Z                      AVG(time_spent) as avg_time_spent
2026-02-20T22:09:14.7953336Z                  FROM attempts
2026-02-20T22:09:14.7953712Z                  WHERE user_id = :user_id
2026-02-20T22:09:14.7954162Z -            """), {"user_id": user_id}).fetchone()
2026-02-20T22:09:14.7954588Z -
2026-02-20T22:09:14.7954880Z -            badge_stats = db.execute(text("""
2026-02-20T22:09:14.7955299Z +            """),
2026-02-20T22:09:14.7955884Z +                {"user_id": user_id},
2026-02-20T22:09:14.7956279Z +            ).fetchone()
2026-02-20T22:09:14.7956588Z +
2026-02-20T22:09:14.7956859Z +            badge_stats = db.execute(
2026-02-20T22:09:14.7957245Z +                text("""
2026-02-20T22:09:14.7957779Z                  SELECT a.category, COUNT(*) as count
2026-02-20T22:09:14.7958249Z                  FROM achievements a
2026-02-20T22:09:14.7958750Z                  JOIN user_achievements ua ON a.id = ua.achievement_id
2026-02-20T22:09:14.7959312Z                  WHERE ua.user_id = :user_id
2026-02-20T22:09:14.7959727Z                  GROUP BY a.category
2026-02-20T22:09:14.7960152Z -            """), {"user_id": user_id}).fetchall()
2026-02-20T22:09:14.7960568Z +            """),
2026-02-20T22:09:14.7960881Z +                {"user_id": user_id},
2026-02-20T22:09:14.7961260Z +            ).fetchall()
2026-02-20T22:09:14.7961571Z  
2026-02-20T22:09:14.7961836Z              response_data = {
2026-02-20T22:09:14.7962276Z                  "user_stats": user_data.get("user_stats", {}),
2026-02-20T22:09:14.7962778Z                  "badges_summary": {
2026-02-20T22:09:14.7963452Z                      "total_badges": len(user_data.get("earned_badges", [])),
2026-02-20T22:09:14.7964119Z                      "by_category": {row[0]: row[1] for row in badge_stats},
2026-02-20T22:09:14.7964623Z                  },
2026-02-20T22:09:14.7964930Z                  "performance": {
2026-02-20T22:09:14.7965378Z                      "total_attempts": stats[0] if stats else 0,
2026-02-20T22:09:14.7965946Z                      "correct_attempts": stats[1] if stats else 0,
2026-02-20T22:09:14.7966711Z -                    "success_rate": round((stats[1] / stats[0] * 100) if stats and stats[0] > 0 else 0, 1),
2026-02-20T22:09:14.7967414Z +                    "success_rate": round(
2026-02-20T22:09:14.7967961Z +                        (stats[1] / stats[0] * 100) if stats and stats[0] > 0 else 0, 1
2026-02-20T22:09:14.7968509Z +                    ),
2026-02-20T22:09:14.7969007Z                      "avg_time_spent": round(stats[2], 2) if stats and stats[2] else 0,
2026-02-20T22:09:14.7969579Z                  },
2026-02-20T22:09:14.7969867Z              }
2026-02-20T22:09:14.7970314Z              return JSONResponse({"success": True, "data": response_data})
2026-02-20T22:09:14.7970868Z  
2026-02-20T22:09:14.7971206Z      except Exception as gamification_stats_error:
2026-02-20T22:09:14.7972284Z -        logger.error(f"Erreur lors de la récupération des statistiques de gamification: {gamification_stats_error}")
2026-02-20T22:09:14.7973302Z -        traceback.print_exc()
2026-02-20T22:09:14.7974023Z -        return JSONResponse({"error": get_safe_error_message(gamification_stats_error)}, status_code=500)
2026-02-20T22:09:14.7974792Z +        logger.error(
2026-02-20T22:09:14.7975610Z +            f"Erreur lors de la récupération des statistiques de gamification: {gamification_stats_error}"
2026-02-20T22:09:14.7976335Z +        )
2026-02-20T22:09:14.7976624Z +        traceback.print_exc()
2026-02-20T22:09:14.7977009Z +        return JSONResponse(
2026-02-20T22:09:14.7977594Z +            {"error": get_safe_error_message(gamification_stats_error)}, status_code=500
2026-02-20T22:09:14.7978224Z +        )
2026-02-20T22:09:14.7978482Z  
2026-02-20T22:09:14.7978714Z  
2026-02-20T22:09:14.7978974Z  @require_auth
2026-02-20T22:09:14.7979336Z  async def patch_pinned_badges(request: Request):
2026-02-20T22:09:14.7980058Z      """A-4 : Épingler 1-3 badges. Body: { "badge_ids": [1, 2, 3] }"""
2026-02-20T22:09:14.7980561Z      try:
2026-02-20T22:09:14.7980833Z          body = await request.json()
2026-02-20T22:09:14.7981256Z          badge_ids = body.get("badge_ids", [])
2026-02-20T22:09:14.7981726Z          if not isinstance(badge_ids, list):
2026-02-20T22:09:14.7982577Z -            return JSONResponse({"error": "badge_ids doit être une liste"}, status_code=400)
2026-02-20T22:09:14.7983528Z +            return JSONResponse(
2026-02-20T22:09:14.7984240Z +                {"error": "badge_ids doit être une liste"}, status_code=400
2026-02-20T22:09:14.7985081Z +            )
2026-02-20T22:09:14.7985578Z          badge_ids = [int(x) for x in badge_ids if isinstance(x, (int, float))]
2026-02-20T22:09:14.7986230Z          current_user = request.state.user
2026-02-20T22:09:14.7986901Z          user_id = current_user.get("id")
2026-02-20T22:09:14.7987378Z          if not user_id:
2026-02-20T22:09:14.7988087Z              return JSONResponse({"error": "Non authentifié"}, status_code=401)
2026-02-20T22:09:14.7988732Z @@ -185,8 +218,10 @@
2026-02-20T22:09:14.7989096Z              badge_service = BadgeService(db)
2026-02-20T22:09:14.7989659Z              data = badge_service.get_badges_progress(user_id)
2026-02-20T22:09:14.7990176Z  
2026-02-20T22:09:14.7990551Z          return JSONResponse({"success": True, "data": data})
2026-02-20T22:09:14.7991097Z      except Exception as e:
2026-02-20T22:09:14.7991899Z -        logger.error(f"Erreur lors de la récupération de la progression des badges: {e}")
2026-02-20T22:09:14.7992655Z -        traceback.print_exc()
2026-02-20T22:09:14.7993466Z -        return JSONResponse({"error": get_safe_error_message(e)}, status_code=500) 
2026-02-20T22:09:14.7994161Z \ No newline at end of file
2026-02-20T22:09:14.7994543Z +        logger.error(
2026-02-20T22:09:14.7995239Z +            f"Erreur lors de la récupération de la progression des badges: {e}"
2026-02-20T22:09:14.7995846Z +        )
2026-02-20T22:09:14.7996144Z +        traceback.print_exc()
2026-02-20T22:09:14.7996754Z +        return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:15.2685547Z --- /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:15.2695985Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py
2026-02-20T22:09:15.2697131Z +++ /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py	2026-02-20 22:09:15.258100+00:00
2026-02-20T22:09:15.2698125Z @@ -1,8 +1,9 @@
2026-02-20T22:09:15.2698426Z  """
2026-02-20T22:09:15.2699098Z  Handlers pour l'authentification et la vérification d'email
2026-02-20T22:09:15.2699614Z  """
2026-02-20T22:09:15.2699860Z +
2026-02-20T22:09:15.2700121Z  import os
2026-02-20T22:09:15.2700407Z  import secrets
2026-02-20T22:09:15.2700726Z  import traceback
2026-02-20T22:09:15.2701131Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:15.2701606Z  
2026-02-20T22:09:15.2701865Z @@ -11,12 +12,16 @@
2026-02-20T22:09:15.2702187Z  logger = get_logger(__name__)
2026-02-20T22:09:15.2702607Z  from starlette.requests import Request
2026-02-20T22:09:15.2703409Z  from starlette.responses import JSONResponse, RedirectResponse
2026-02-20T22:09:15.2703994Z  
2026-02-20T22:09:15.2704315Z  from app.core.security import decode_token
2026-02-20T22:09:15.2705019Z -from app.services.auth_service import (authenticate_user, create_user_token,
2026-02-20T22:09:15.2705805Z -                                       get_user_by_email, refresh_access_token)
2026-02-20T22:09:15.2706421Z +from app.services.auth_service import (
2026-02-20T22:09:15.2706884Z +    authenticate_user,
2026-02-20T22:09:15.2707238Z +    create_user_token,
2026-02-20T22:09:15.2707586Z +    get_user_by_email,
2026-02-20T22:09:15.2707924Z +    refresh_access_token,
2026-02-20T22:09:15.2708279Z +)
2026-02-20T22:09:15.2708809Z  from app.utils.rate_limit import rate_limit_auth, rate_limit_resend_verification
2026-02-20T22:09:15.2709580Z  from app.utils.csrf import validate_csrf_token
2026-02-20T22:09:15.2710110Z  from server.auth import require_auth
2026-02-20T22:09:15.2710626Z  from app.services.email_service import EmailService
2026-02-20T22:09:15.2711191Z  from app.utils.db_utils import db_session
2026-02-20T22:09:15.2711626Z @@ -34,20 +39,19 @@
2026-02-20T22:09:15.2712178Z      Récupère un token CSRF (pattern double-submit).
2026-02-20T22:09:15.2712703Z      Route: GET /api/auth/csrf
2026-02-20T22:09:15.2713526Z      Retourne le token et le pose en cookie. Le client doit l'envoyer dans X-CSRF-Token.
2026-02-20T22:09:15.2714669Z      """
2026-02-20T22:09:15.2714958Z      import secrets
2026-02-20T22:09:15.2715267Z +
2026-02-20T22:09:15.2715558Z      token = secrets.token_urlsafe(32)
2026-02-20T22:09:15.2716066Z      response = JSONResponse({"csrf_token": token})
2026-02-20T22:09:15.2716762Z      is_production = (
2026-02-20T22:09:15.2717202Z          os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.2717718Z          or os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.2718164Z      )
2026-02-20T22:09:15.2718442Z      cookie_opts = (
2026-02-20T22:09:15.2718804Z -        "Path=/; SameSite=None; Secure"
2026-02-20T22:09:15.2719245Z -        if is_production
2026-02-20T22:09:15.2719626Z -        else "Path=/; SameSite=Lax"
2026-02-20T22:09:15.2720260Z +        "Path=/; SameSite=None; Secure" if is_production else "Path=/; SameSite=Lax"
2026-02-20T22:09:15.2720904Z      )
2026-02-20T22:09:15.2721194Z      response.set_cookie(
2026-02-20T22:09:15.2721547Z          "csrf_token",
2026-02-20T22:09:15.2721879Z          token,
2026-02-20T22:09:15.2722162Z          path="/",
2026-02-20T22:09:15.2722461Z @@ -64,74 +68,82 @@
2026-02-20T22:09:15.2723196Z      Vérifie l'adresse email d'un utilisateur avec un token.
2026-02-20T22:09:15.2723817Z      Route: GET /api/auth/verify-email?token=...
2026-02-20T22:09:15.2724289Z      """
2026-02-20T22:09:15.2724546Z      try:
2026-02-20T22:09:15.2725013Z          # Récupérer le token depuis les query params
2026-02-20T22:09:15.2725548Z -        token = request.query_params.get('token')
2026-02-20T22:09:15.2726015Z -        
2026-02-20T22:09:15.2726340Z +        token = request.query_params.get("token")
2026-02-20T22:09:15.2726790Z +
2026-02-20T22:09:15.2727047Z          if not token:
2026-02-20T22:09:15.2727394Z              return JSONResponse(
2026-02-20T22:09:15.2727979Z -                {"error": "Token de vérification manquant"},
2026-02-20T22:09:15.2728498Z -                status_code=400
2026-02-20T22:09:15.2729169Z +                {"error": "Token de vérification manquant"}, status_code=400
2026-02-20T22:09:15.2729741Z              )
2026-02-20T22:09:15.2730025Z  
2026-02-20T22:09:15.2730347Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2730804Z  
2026-02-20T22:09:15.2731091Z          async with db_session() as db:
2026-02-20T22:09:15.2731569Z              from app.models.user import User
2026-02-20T22:09:15.2732051Z -            user = db.query(User).filter(
2026-02-20T22:09:15.2732551Z -                User.email_verification_token == token
2026-02-20T22:09:15.2733202Z -            ).first()
2026-02-20T22:09:15.2733515Z +
2026-02-20T22:09:15.2734025Z +            user = db.query(User).filter(User.email_verification_token == token).first()
2026-02-20T22:09:15.2734671Z  
2026-02-20T22:09:15.2734942Z              if not user:
2026-02-20T22:09:15.2735302Z                  return JSONResponse(
2026-02-20T22:09:15.2735934Z -                    {"error": "Token de vérification invalide"},
2026-02-20T22:09:15.2736463Z -                    status_code=400
2026-02-20T22:09:15.2737149Z +                    {"error": "Token de vérification invalide"}, status_code=400
2026-02-20T22:09:15.2737725Z                  )
2026-02-20T22:09:15.2738008Z  
2026-02-20T22:09:15.2738475Z              if is_verification_token_expired(user.email_verification_sent_at):
2026-02-20T22:09:15.2739105Z                  return JSONResponse(
2026-02-20T22:09:15.2739975Z -                    {"error": "Le token de vérification a expiré. Veuillez demander un nouveau lien."},
2026-02-20T22:09:15.2740700Z -                    status_code=400
2026-02-20T22:09:15.2741086Z +                    {
2026-02-20T22:09:15.2741836Z +                        "error": "Le token de vérification a expiré. Veuillez demander un nouveau lien."
2026-02-20T22:09:15.2742541Z +                    },
2026-02-20T22:09:15.2742882Z +                    status_code=400,
2026-02-20T22:09:15.2743445Z                  )
2026-02-20T22:09:15.2743733Z  
2026-02-20T22:09:15.2744258Z              if user.is_email_verified:
2026-02-20T22:09:15.2744715Z -                return JSONResponse({
2026-02-20T22:09:15.2745400Z -                    "message": "Votre adresse email est déjà vérifiée",
2026-02-20T22:09:15.2745966Z +                return JSONResponse(
2026-02-20T22:09:15.2746540Z +                    {
2026-02-20T22:09:15.2747136Z +                        "message": "Votre adresse email est déjà vérifiée",
2026-02-20T22:09:15.2747706Z +                        "success": True,
2026-02-20T22:09:15.2748114Z +                        "user": {
2026-02-20T22:09:15.2748512Z +                            "id": user.id,
2026-02-20T22:09:15.2748965Z +                            "username": user.username,
2026-02-20T22:09:15.2749455Z +                            "email": user.email,
2026-02-20T22:09:15.2749932Z +                            "is_email_verified": True,
2026-02-20T22:09:15.2750390Z +                        },
2026-02-20T22:09:15.2750738Z +                    },
2026-02-20T22:09:15.2751090Z +                    status_code=200,
2026-02-20T22:09:15.2751475Z +                )
2026-02-20T22:09:15.2751764Z +
2026-02-20T22:09:15.2752057Z +            user.is_email_verified = True
2026-02-20T22:09:15.2752567Z +            user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2753266Z +            db.commit()
2026-02-20T22:09:15.2753620Z +            db.refresh(user)
2026-02-20T22:09:15.2753972Z +
2026-02-20T22:09:15.2754238Z +            logger.info(
2026-02-20T22:09:15.2754934Z +                f"Email vérifié pour l'utilisateur {user.username} ({user.email})"
2026-02-20T22:09:15.2755539Z +            )
2026-02-20T22:09:15.2755808Z +
2026-02-20T22:09:15.2756086Z +            return JSONResponse(
2026-02-20T22:09:15.2756452Z +                {
2026-02-20T22:09:15.2757068Z +                    "message": "Votre adresse email a été vérifiée avec succès !",
2026-02-20T22:09:15.2757689Z                      "success": True,
2026-02-20T22:09:15.2758093Z                      "user": {
2026-02-20T22:09:15.2758474Z                          "id": user.id,
2026-02-20T22:09:15.2758924Z                          "username": user.username,
2026-02-20T22:09:15.2759406Z                          "email": user.email,
2026-02-20T22:09:15.2759866Z -                        "is_email_verified": True
2026-02-20T22:09:15.2760322Z -                    }
2026-02-20T22:09:15.2760649Z -                }, status_code=200)
2026-02-20T22:09:15.2761035Z -
2026-02-20T22:09:15.2761325Z -            user.is_email_verified = True
2026-02-20T22:09:15.2761853Z -            user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2762345Z -            db.commit()
2026-02-20T22:09:15.2762709Z -            db.refresh(user)
2026-02-20T22:09:15.2763233Z -
2026-02-20T22:09:15.2763948Z -            logger.info(f"Email vérifié pour l'utilisateur {user.username} ({user.email})")
2026-02-20T22:09:15.2764650Z -
2026-02-20T22:09:15.2764935Z -            return JSONResponse({
2026-02-20T22:09:15.2765649Z -                "message": "Votre adresse email a été vérifiée avec succès !",
2026-02-20T22:09:15.2766261Z -                "success": True,
2026-02-20T22:09:15.2766654Z -                "user": {
2026-02-20T22:09:15.2767000Z -                    "id": user.id,
2026-02-20T22:09:15.2767439Z -                    "username": user.username,
2026-02-20T22:09:15.2767908Z -                    "email": user.email,
2026-02-20T22:09:15.2768414Z -                    "is_email_verified": user.is_email_verified
2026-02-20T22:09:15.2768910Z -                }
2026-02-20T22:09:15.2769228Z -            }, status_code=200)
2026-02-20T22:09:15.2769600Z -            
2026-02-20T22:09:15.2769984Z +                        "is_email_verified": user.is_email_verified,
2026-02-20T22:09:15.2770492Z +                    },
2026-02-20T22:09:15.2770809Z +                },
2026-02-20T22:09:15.2771130Z +                status_code=200,
2026-02-20T22:09:15.2771493Z +            )
2026-02-20T22:09:15.2771779Z +
2026-02-20T22:09:15.2772111Z      except Exception as email_verification_error:
2026-02-20T22:09:15.2773456Z -        logger.error(f"Erreur lors de la vérification de l'email: {email_verification_error}")
2026-02-20T22:09:15.2774210Z +        logger.error(
2026-02-20T22:09:15.2774888Z +            f"Erreur lors de la vérification de l'email: {email_verification_error}"
2026-02-20T22:09:15.2775722Z +        )
2026-02-20T22:09:15.2776068Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2776542Z          return JSONResponse(
2026-02-20T22:09:15.2777162Z -            {"error": "Erreur lors de la vérification de l'email"},
2026-02-20T22:09:15.2777715Z -            status_code=500
2026-02-20T22:09:15.2778412Z +            {"error": "Erreur lors de la vérification de l'email"}, status_code=500
2026-02-20T22:09:15.2779007Z          )
2026-02-20T22:09:15.2779264Z  
2026-02-20T22:09:15.2779505Z  
2026-02-20T22:09:15.2779787Z  @rate_limit_resend_verification
2026-02-20T22:09:15.2780278Z  async def resend_verification_email(request: Request):
2026-02-20T22:09:15.2780750Z @@ -153,68 +165,91 @@
2026-02-20T22:09:15.2781007Z  
2026-02-20T22:09:15.2781283Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2781675Z  
2026-02-20T22:09:15.2781911Z          async with db_session() as db:
2026-02-20T22:09:15.2782309Z              user = get_user_by_email(db, email)
2026-02-20T22:09:15.2782678Z -            
2026-02-20T22:09:15.2782909Z +
2026-02-20T22:09:15.2783296Z              if not user:
2026-02-20T22:09:15.2783867Z                  # Pour des raisons de sécurité, ne pas révéler si l'email existe
2026-02-20T22:09:15.2784486Z -                return JSONResponse({
2026-02-20T22:09:15.2785495Z -                    "message": "Si cette adresse email est associée à un compte non vérifié, vous recevrez un email de vérification."
2026-02-20T22:09:15.2786311Z -                }, status_code=200)
2026-02-20T22:09:15.2786667Z -            
2026-02-20T22:09:15.2786966Z +                return JSONResponse(
2026-02-20T22:09:15.2787337Z +                    {
2026-02-20T22:09:15.2788302Z +                        "message": "Si cette adresse email est associée à un compte non vérifié, vous recevrez un email de vérification."
2026-02-20T22:09:15.2789058Z +                    },
2026-02-20T22:09:15.2789336Z +                    status_code=200,
2026-02-20T22:09:15.2789647Z +                )
2026-02-20T22:09:15.2789876Z +
2026-02-20T22:09:15.2790218Z              # Vérifier si l'email est déjà vérifié
2026-02-20T22:09:15.2790697Z              if user.is_email_verified:
2026-02-20T22:09:15.2791140Z -                return JSONResponse({
2026-02-20T22:09:15.2791781Z -                    "message": "Votre adresse email est déjà vérifiée"
2026-02-20T22:09:15.2792337Z -                }, status_code=200)
2026-02-20T22:09:15.2792709Z -            
2026-02-20T22:09:15.2793189Z +                return JSONResponse(
2026-02-20T22:09:15.2793851Z +                    {"message": "Votre adresse email est déjà vérifiée"},
2026-02-20T22:09:15.2794406Z +                    status_code=200,
2026-02-20T22:09:15.2794814Z +                )
2026-02-20T22:09:15.2795096Z +
2026-02-20T22:09:15.2795437Z              # Rate limit : ne pas renvoyer avant 2 minutes
2026-02-20T22:09:15.2795973Z              if user.email_verification_sent_at:
2026-02-20T22:09:15.2796633Z                  cooldown = user.email_verification_sent_at + timedelta(minutes=2)
2026-02-20T22:09:15.2797329Z                  if datetime.now(timezone.utc) < cooldown:
2026-02-20T22:09:15.2797843Z -                    return JSONResponse({
2026-02-20T22:09:15.2798598Z -                        "message": "Veuillez patienter quelques minutes avant de demander un nouvel email."
2026-02-20T22:09:15.2799707Z -                    }, status_code=200)  # 200 pour ne pas révéler l'existence du compte
2026-02-20T22:09:15.2800325Z -            
2026-02-20T22:09:15.2800639Z +                    return JSONResponse(
2026-02-20T22:09:15.2801058Z +                        {
2026-02-20T22:09:15.2801732Z +                            "message": "Veuillez patienter quelques minutes avant de demander un nouvel email."
2026-02-20T22:09:15.2802719Z +                        },
2026-02-20T22:09:15.2803272Z +                        status_code=200,
2026-02-20T22:09:15.2803937Z +                    )  # 200 pour ne pas révéler l'existence du compte
2026-02-20T22:09:15.2804700Z +
2026-02-20T22:09:15.2805094Z              # Générer un nouveau token
2026-02-20T22:09:15.2805632Z              verification_token = generate_verification_token()
2026-02-20T22:09:15.2806268Z              user.email_verification_token = verification_token
2026-02-20T22:09:15.2806951Z              user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.2807521Z -            
2026-02-20T22:09:15.2807804Z +
2026-02-20T22:09:15.2808061Z              db.commit()
2026-02-20T22:09:15.2808411Z              db.refresh(user)
2026-02-20T22:09:15.2808765Z -            
2026-02-20T22:09:15.2809038Z +
2026-02-20T22:09:15.2809313Z              # Envoyer l'email
2026-02-20T22:09:15.2810007Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:15.2810793Z +            frontend_url = os.getenv(
2026-02-20T22:09:15.2811367Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:15.2811956Z +            )
2026-02-20T22:09:15.2812355Z              email_sent = EmailService.send_verification_email(
2026-02-20T22:09:15.2812907Z                  to_email=user.email,
2026-02-20T22:09:15.2813623Z                  username=user.username,
2026-02-20T22:09:15.2814108Z                  verification_token=verification_token,
2026-02-20T22:09:15.2814613Z -                frontend_url=frontend_url
2026-02-20T22:09:15.2815024Z -            )
2026-02-20T22:09:15.2815307Z -            
2026-02-20T22:09:15.2815612Z +                frontend_url=frontend_url,
2026-02-20T22:09:15.2816028Z +            )
2026-02-20T22:09:15.2816293Z +
2026-02-20T22:09:15.2816556Z              if email_sent:
2026-02-20T22:09:15.2817247Z                  logger.info(f"Email de vérification renvoyé à {user.email}")
2026-02-20T22:09:15.2817885Z                  if "localhost" in frontend_url:
2026-02-20T22:09:15.2818563Z -                    verify_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:15.2819486Z -                    logger.info(f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}")
2026-02-20T22:09:15.2820200Z -                return JSONResponse({
2026-02-20T22:09:15.2821018Z -                    "message": "Un nouvel email de vérification a été envoyé à votre adresse."
2026-02-20T22:09:15.2821705Z -                }, status_code=200)
2026-02-20T22:09:15.2822104Z +                    verify_link = (
2026-02-20T22:09:15.2822645Z +                        f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:15.2823404Z +                    )
2026-02-20T22:09:15.2823740Z +                    logger.info(
2026-02-20T22:09:15.2824291Z +                        f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}"
2026-02-20T22:09:15.2824888Z +                    )
2026-02-20T22:09:15.2825239Z +                return JSONResponse(
2026-02-20T22:09:15.2825632Z +                    {
2026-02-20T22:09:15.2826383Z +                        "message": "Un nouvel email de vérification a été envoyé à votre adresse."
2026-02-20T22:09:15.2827066Z +                    },
2026-02-20T22:09:15.2827405Z +                    status_code=200,
2026-02-20T22:09:15.2827797Z +                )
2026-02-20T22:09:15.2828082Z              else:
2026-02-20T22:09:15.2828800Z -                logger.warning(f"Échec de l'envoi de l'email de vérification à {user.email}")
2026-02-20T22:09:15.2829524Z -                return JSONResponse({
2026-02-20T22:09:15.2830436Z -                    "error": "Impossible d'envoyer l'email de vérification. Veuillez réessayer plus tard."
2026-02-20T22:09:15.2831219Z -                }, status_code=500)
2026-02-20T22:09:15.2831629Z +                logger.warning(
2026-02-20T22:09:15.2832561Z +                    f"Échec de l'envoi de l'email de vérification à {user.email}"
2026-02-20T22:09:15.2833319Z +                )
2026-02-20T22:09:15.2833650Z +                return JSONResponse(
2026-02-20T22:09:15.2834046Z +                    {
2026-02-20T22:09:15.2835053Z +                        "error": "Impossible d'envoyer l'email de vérification. Veuillez réessayer plus tard."
2026-02-20T22:09:15.2835800Z +                    },
2026-02-20T22:09:15.2836138Z +                    status_code=500,
2026-02-20T22:09:15.2836524Z +                )
2026-02-20T22:09:15.2836804Z  
2026-02-20T22:09:15.2837153Z      except Exception as resend_verification_error:
2026-02-20T22:09:15.2838138Z -        logger.error(f"Erreur lors du renvoi de l'email de vérification: {resend_verification_error}")
2026-02-20T22:09:15.2838922Z +        logger.error(
2026-02-20T22:09:15.2839639Z +            f"Erreur lors du renvoi de l'email de vérification: {resend_verification_error}"
2026-02-20T22:09:15.2840334Z +        )
2026-02-20T22:09:15.2840659Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2841124Z          return JSONResponse(
2026-02-20T22:09:15.2841770Z              {"error": "Erreur lors du renvoi de l'email de vérification"},
2026-02-20T22:09:15.2842358Z -            status_code=500
2026-02-20T22:09:15.2842738Z +            status_code=500,
2026-02-20T22:09:15.2843255Z          )
2026-02-20T22:09:15.2843522Z  
2026-02-20T22:09:15.2843757Z  
2026-02-20T22:09:15.2844025Z  @rate_limit_auth("login")
2026-02-20T22:09:15.2844411Z  async def api_login(request: Request):
2026-02-20T22:09:15.2844847Z @@ -243,36 +278,41 @@
2026-02-20T22:09:15.2845147Z  
2026-02-20T22:09:15.2845470Z          from app.utils.db_utils import db_session
2026-02-20T22:09:15.2845921Z  
2026-02-20T22:09:15.2846198Z          async with db_session() as db:
2026-02-20T22:09:15.2846723Z              user = authenticate_user(db, username, password)
2026-02-20T22:09:15.2847215Z -            
2026-02-20T22:09:15.2847498Z +
2026-02-20T22:09:15.2847749Z              if not user:
2026-02-20T22:09:15.2848453Z                  logger.warning(f"Échec de connexion pour l'utilisateur: {username}")
2026-02-20T22:09:15.2849116Z                  return JSONResponse(
2026-02-20T22:09:15.2849679Z                      {"error": "Nom d'utilisateur ou mot de passe incorrect"},
2026-02-20T22:09:15.2850263Z -                    status_code=401
2026-02-20T22:09:15.2850641Z -                )
2026-02-20T22:09:15.2850929Z -
2026-02-20T22:09:15.2851287Z -            if not getattr(user, 'is_email_verified', True):
2026-02-20T22:09:15.2851813Z -                return JSONResponse(
2026-02-20T22:09:15.2852896Z -                    {"error": "Veuillez vérifier votre adresse email avant de vous connecter. Consultez votre boîte de réception."},
2026-02-20T22:09:15.2853988Z -                    status_code=403
2026-02-20T22:09:15.2854368Z -                )
2026-02-20T22:09:15.2854669Z -            
2026-02-20T22:09:15.2854990Z +                    status_code=401,
2026-02-20T22:09:15.2855367Z +                )
2026-02-20T22:09:15.2855657Z +
2026-02-20T22:09:15.2856002Z +            if not getattr(user, "is_email_verified", True):
2026-02-20T22:09:15.2856546Z +                return JSONResponse(
2026-02-20T22:09:15.2856979Z +                    {
2026-02-20T22:09:15.2857988Z +                        "error": "Veuillez vérifier votre adresse email avant de vous connecter. Consultez votre boîte de réception."
2026-02-20T22:09:15.2858883Z +                    },
2026-02-20T22:09:15.2859223Z +                    status_code=403,
2026-02-20T22:09:15.2859574Z +                )
2026-02-20T22:09:15.2859817Z +
2026-02-20T22:09:15.2860137Z              # Créer les tokens d'accès
2026-02-20T22:09:15.2860515Z              token_data = create_user_token(user)
2026-02-20T22:09:15.2861270Z              logger.info(f"Connexion réussie pour l'utilisateur: {user.username}")
2026-02-20T22:09:15.2861880Z  
2026-02-20T22:09:15.2862536Z              # Créer une entrée UserSession pour /api/users/me/sessions (sessions actives)
2026-02-20T22:09:15.2863696Z              from app.models.user_session import UserSession
2026-02-20T22:09:15.2864269Z              from app.core.config import settings
2026-02-20T22:09:15.2864721Z +
2026-02-20T22:09:15.2865280Z              ip = request.client.host if request.client else None
2026-02-20T22:09:15.2865958Z              user_agent = request.headers.get("user-agent") or ""
2026-02-20T22:09:15.2866663Z              device_info = {"user_agent": user_agent[:500]} if user_agent else None
2026-02-20T22:09:15.2867358Z              session_token = secrets.token_urlsafe(32)
2026-02-20T22:09:15.2868194Z -            expires_at = datetime.now(timezone.utc) + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
2026-02-20T22:09:15.2869108Z +            expires_at = datetime.now(timezone.utc) + timedelta(
2026-02-20T22:09:15.2869708Z +                days=settings.REFRESH_TOKEN_EXPIRE_DAYS
2026-02-20T22:09:15.2870167Z +            )
2026-02-20T22:09:15.2870515Z              db_session_row = UserSession(
2026-02-20T22:09:15.2870954Z                  user_id=user.id,
2026-02-20T22:09:15.2871378Z                  session_token=session_token,
2026-02-20T22:09:15.2871836Z                  device_info=device_info,
2026-02-20T22:09:15.2872285Z                  ip_address=ip,
2026-02-20T22:09:15.2872645Z @@ -290,66 +330,72 @@
2026-02-20T22:09:15.2873273Z                  "token_type": token_data.get("token_type", "bearer"),
2026-02-20T22:09:15.2873854Z                  "expires_in": access_token_max_age,
2026-02-20T22:09:15.2874317Z                  "user": {
2026-02-20T22:09:15.2874675Z                      "id": user.id,
2026-02-20T22:09:15.2875091Z                      "username": user.username,
2026-02-20T22:09:15.2875668Z -                    "email": user.email if hasattr(user, 'email') else None,
2026-02-20T22:09:15.2876420Z -                    "full_name": user.full_name if hasattr(user, 'full_name') else None,
2026-02-20T22:09:15.2877224Z -                    "role": user.role.value if hasattr(user, 'role') else None,
2026-02-20T22:09:15.2878161Z -                    "is_email_verified": user.is_email_verified if hasattr(user, 'is_email_verified') else False
2026-02-20T22:09:15.2878933Z -                }
2026-02-20T22:09:15.2879374Z +                    "email": user.email if hasattr(user, "email") else None,
2026-02-20T22:09:15.2880106Z +                    "full_name": user.full_name if hasattr(user, "full_name") else None,
2026-02-20T22:09:15.2880864Z +                    "role": user.role.value if hasattr(user, "role") else None,
2026-02-20T22:09:15.2881469Z +                    "is_email_verified": (
2026-02-20T22:09:15.2881920Z +                        user.is_email_verified
2026-02-20T22:09:15.2882426Z +                        if hasattr(user, "is_email_verified")
2026-02-20T22:09:15.2882911Z +                        else False
2026-02-20T22:09:15.2883485Z +                    ),
2026-02-20T22:09:15.2883793Z +                },
2026-02-20T22:09:15.2884153Z              }
2026-02-20T22:09:15.2884432Z -            
2026-02-20T22:09:15.2884717Z +
2026-02-20T22:09:15.2885140Z              # Créer la réponse avec le cookie
2026-02-20T22:09:15.2885729Z              response = JSONResponse(response_data, status_code=200)
2026-02-20T22:09:15.2886291Z -            
2026-02-20T22:09:15.2886562Z +
2026-02-20T22:09:15.2887129Z              # Déterminer la configuration des cookies selon l'environnement
2026-02-20T22:09:15.2887924Z              # En production (cross-domain), utiliser SameSite=None et Secure=True
2026-02-20T22:09:15.2888566Z              import os
2026-02-20T22:09:15.2888874Z +
2026-02-20T22:09:15.2889154Z              is_production = (
2026-02-20T22:09:15.2889588Z -                os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:15.2890171Z -                os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:15.2890748Z -                os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.2891514Z +                os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.2892064Z +                or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.2892631Z +                or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.2893308Z              )
2026-02-20T22:09:15.2893916Z              cookie_samesite = "none" if is_production else "lax"
2026-02-20T22:09:15.2894715Z              cookie_secure = is_production  # Secure=True obligatoire avec SameSite=None
2026-02-20T22:09:15.2895370Z -            
2026-02-20T22:09:15.2895640Z +
2026-02-20T22:09:15.2896306Z              # Définir le cookie access_token (pour compatibilité avec l'ancien système)
2026-02-20T22:09:15.2896983Z              response.set_cookie(
2026-02-20T22:09:15.2897389Z                  key="access_token",
2026-02-20T22:09:15.2897848Z                  value=token_data.get("access_token"),
2026-02-20T22:09:15.2898327Z                  httponly=True,
2026-02-20T22:09:15.2898731Z                  max_age=access_token_max_age,
2026-02-20T22:09:15.2899223Z                  samesite=cookie_samesite,
2026-02-20T22:09:15.2899669Z -                secure=cookie_secure
2026-02-20T22:09:15.2900065Z -            )
2026-02-20T22:09:15.2900347Z -            
2026-02-20T22:09:15.2900651Z +                secure=cookie_secure,
2026-02-20T22:09:15.2901056Z +            )
2026-02-20T22:09:15.2901323Z +
2026-02-20T22:09:15.2901960Z              # Définir le cookie refresh_token (nécessaire pour le refresh automatique)
2026-02-20T22:09:15.2902839Z              refresh_token_max_age = settings.REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60
2026-02-20T22:09:15.2903810Z              refresh_token_value = token_data.get("refresh_token")
2026-02-20T22:09:15.2904372Z              if refresh_token_value:
2026-02-20T22:09:15.2904798Z                  response.set_cookie(
2026-02-20T22:09:15.2905222Z                      key="refresh_token",
2026-02-20T22:09:15.2905673Z                      value=refresh_token_value,
2026-02-20T22:09:15.2906121Z                      httponly=True,
2026-02-20T22:09:15.2906564Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.2907055Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.2907500Z -                    secure=cookie_secure
2026-02-20T22:09:15.2907921Z -                )
2026-02-20T22:09:15.2909090Z -                logger.info(f"Cookie refresh_token défini pour l'utilisateur: {user.username} (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.2910142Z +                    secure=cookie_secure,
2026-02-20T22:09:15.2910549Z +                )
2026-02-20T22:09:15.2910862Z +                logger.info(
2026-02-20T22:09:15.2911963Z +                    f"Cookie refresh_token défini pour l'utilisateur: {user.username} (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.2912906Z +                )
2026-02-20T22:09:15.2913381Z              else:
2026-02-20T22:09:15.2914237Z -                logger.error(f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}")
2026-02-20T22:09:15.2915081Z -            
2026-02-20T22:09:15.2915519Z +                logger.error(
2026-02-20T22:09:15.2916516Z +                    f"ERREUR: refresh_token non créé pour l'utilisateur: {user.username}"
2026-02-20T22:09:15.2931036Z +                )
2026-02-20T22:09:15.2931372Z +
2026-02-20T22:09:15.2931663Z              return response
2026-02-20T22:09:15.2932017Z  
2026-02-20T22:09:15.2932321Z      except Exception as login_error:
2026-02-20T22:09:15.2932883Z          logger.error(f"Erreur lors de la connexion: {login_error}")
2026-02-20T22:09:15.2933708Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.2934176Z -        return JSONResponse(
2026-02-20T22:09:15.2934624Z -            {"error": "Erreur lors de la connexion"},
2026-02-20T22:09:15.2935106Z -            status_code=500
2026-02-20T22:09:15.2935467Z -        )
2026-02-20T22:09:15.2936001Z +        return JSONResponse({"error": "Erreur lors de la connexion"}, status_code=500)
2026-02-20T22:09:15.2936902Z  
2026-02-20T22:09:15.2937158Z  
2026-02-20T22:09:15.2937446Z  @rate_limit_auth("validate-token")
2026-02-20T22:09:15.2937948Z  async def api_validate_token(request: Request):
2026-02-20T22:09:15.2938409Z      """
2026-02-20T22:09:15.2938687Z @@ -371,11 +417,13 @@
2026-02-20T22:09:15.2939310Z                  {"valid": False, "error": "Token manquant"},
2026-02-20T22:09:15.2939834Z                  status_code=400,
2026-02-20T22:09:15.2940212Z              )
2026-02-20T22:09:15.2940520Z          token = data_or_err["token"]
2026-02-20T22:09:15.2940956Z          if not isinstance(token, str):
2026-02-20T22:09:15.2941643Z -            return JSONResponse({"valid": False, "error": "Token invalide"}, status_code=400)
2026-02-20T22:09:15.2942371Z +            return JSONResponse(
2026-02-20T22:09:15.2942893Z +                {"valid": False, "error": "Token invalide"}, status_code=400
2026-02-20T22:09:15.2943639Z +            )
2026-02-20T22:09:15.2943959Z          payload = decode_token(token)
2026-02-20T22:09:15.2944648Z          # Vérifier que c'est un access token (type=access)
2026-02-20T22:09:15.2945200Z          if payload.get("type") != "access":
2026-02-20T22:09:15.2945759Z              return JSONResponse({"valid": False}, status_code=401)
2026-02-20T22:09:15.2946503Z          return JSONResponse({"valid": True, "user_id": payload.get("sub")})
2026-02-20T22:09:15.2947108Z @@ -391,113 +439,141 @@
2026-02-20T22:09:15.2947482Z      Cookie (optionnel): refresh_token
2026-02-20T22:09:15.2947915Z      Returns: New access token
2026-02-20T22:09:15.2948281Z      """
2026-02-20T22:09:15.2948539Z      try:
2026-02-20T22:09:15.2948826Z          refresh_token = None
2026-02-20T22:09:15.2949179Z -        
2026-02-20T22:09:15.2949437Z +
2026-02-20T22:09:15.2950110Z          # Essayer de récupérer le refresh token depuis le body JSON (pour compatibilité)
2026-02-20T22:09:15.2950777Z          try:
2026-02-20T22:09:15.2951124Z              body_content = await request.body()
2026-02-20T22:09:15.2951594Z              if body_content:
2026-02-20T22:09:15.2951968Z                  import json
2026-02-20T22:09:15.2952304Z +
2026-02-20T22:09:15.2952562Z                  try:
2026-02-20T22:09:15.2953149Z -                    data = json.loads(body_content.decode('utf-8'))
2026-02-20T22:09:15.2953912Z -                    refresh_token = data.get('refresh_token', '').strip() if data else None
2026-02-20T22:09:15.2954661Z +                    data = json.loads(body_content.decode("utf-8"))
2026-02-20T22:09:15.2955181Z +                    refresh_token = (
2026-02-20T22:09:15.2955729Z +                        data.get("refresh_token", "").strip() if data else None
2026-02-20T22:09:15.2956278Z +                    )
2026-02-20T22:09:15.2956688Z                  except (ValueError, json.JSONDecodeError):
2026-02-20T22:09:15.2957326Z                      # JSON invalide, ce n'est pas grave, on essaiera les cookies
2026-02-20T22:09:15.2957911Z                      pass
2026-02-20T22:09:15.2958268Z          except Exception:
2026-02-20T22:09:15.2958865Z              # Erreur lors de la lecture du body, ce n'est pas grave, on essaiera les cookies
2026-02-20T22:09:15.2959525Z              pass
2026-02-20T22:09:15.2959807Z -        
2026-02-20T22:09:15.2960067Z +
2026-02-20T22:09:15.2960676Z          # Si pas de token dans le body, essayer de le récupérer depuis les cookies
2026-02-20T22:09:15.2961292Z          if not refresh_token:
2026-02-20T22:09:15.2961837Z -            refresh_token = request.cookies.get('refresh_token', '').strip()
2026-02-20T22:09:15.2962428Z -        
2026-02-20T22:09:15.2962875Z +            refresh_token = request.cookies.get("refresh_token", "").strip()
2026-02-20T22:09:15.2963654Z +
2026-02-20T22:09:15.2963942Z          # Log pour diagnostic
2026-02-20T22:09:15.2964373Z          all_cookies = list(request.cookies.keys())
2026-02-20T22:09:15.2965158Z          logger.debug(f"Cookies présents lors du refresh: {all_cookies}")
2026-02-20T22:09:15.2965733Z -        
2026-02-20T22:09:15.2966236Z +
2026-02-20T22:09:15.2966502Z          if refresh_token:
2026-02-20T22:09:15.2967717Z -            logger.debug(f"Refresh token reçu depuis {'body' if 'refresh_token' not in request.cookies else 'cookie'} (longueur: {len(refresh_token)})")
2026-02-20T22:09:15.2968781Z +            logger.debug(
2026-02-20T22:09:15.2970048Z +                f"Refresh token reçu depuis {'body' if 'refresh_token' not in request.cookies else 'cookie'} (longueur: {len(refresh_token)})"
2026-02-20T22:09:15.2971014Z +            )
2026-02-20T22:09:15.2971293Z          else:
2026-02-20T22:09:15.2971954Z              logger.warning("Aucun refresh_token trouvé dans les cookies ou le body")
2026-02-20T22:09:15.2972856Z              # FALLBACK: Pour les utilisateurs existants qui n'ont pas de refresh_token,
2026-02-20T22:09:15.2973911Z              # essayer d'utiliser l'access_token comme fallback temporaire
2026-02-20T22:09:15.2974712Z -            access_token_fallback = request.cookies.get('access_token', '').strip()
2026-02-20T22:09:15.2975596Z +            access_token_fallback = request.cookies.get("access_token", "").strip()
2026-02-20T22:09:15.2976273Z              if access_token_fallback:
2026-02-20T22:09:15.2977076Z -                logger.warning("Tentative de fallback avec access_token (utilisateur existant sans refresh_token)")
2026-02-20T22:09:15.2977950Z +                logger.warning(
2026-02-20T22:09:15.2978638Z +                    "Tentative de fallback avec access_token (utilisateur existant sans refresh_token)"
2026-02-20T22:09:15.2979353Z +                )
2026-02-20T22:09:15.2979990Z                  # Essayer de décoder l'access_token pour vérifier s'il est valide
2026-02-20T22:09:15.2980580Z                  try:
2026-02-20T22:09:15.2980909Z                      import jwt
2026-02-20T22:09:15.2981344Z                      from app.core.config import settings
2026-02-20T22:09:15.2981805Z +
2026-02-20T22:09:15.2982117Z                      payload = jwt.decode(
2026-02-20T22:09:15.2982617Z                          access_token_fallback,
2026-02-20T22:09:15.2983271Z                          settings.SECRET_KEY,
2026-02-20T22:09:15.2983771Z                          algorithms=[settings.ALGORITHM],
2026-02-20T22:09:15.2984758Z -                        options={"verify_exp": False}  # Ne pas vérifier l'expiration pour le fallback
2026-02-20T22:09:15.2985475Z +                        options={
2026-02-20T22:09:15.2985897Z +                            "verify_exp": False
2026-02-20T22:09:15.2986569Z +                        },  # Ne pas vérifier l'expiration pour le fallback
2026-02-20T22:09:15.2987099Z                      )
2026-02-20T22:09:15.2987802Z                      # Si l'access_token est valide mais expiré, créer un nouveau refresh_token
2026-02-20T22:09:15.2988513Z                      username = payload.get("sub")
2026-02-20T22:09:15.2988968Z                      if username:
2026-02-20T22:09:15.2989947Z -                        logger.info(f"Fallback: Création d'un nouveau refresh_token pour l'utilisateur existant: {username}")
2026-02-20T22:09:15.2990833Z +                        logger.info(
2026-02-20T22:09:15.2991754Z +                            f"Fallback: Création d'un nouveau refresh_token pour l'utilisateur existant: {username}"
2026-02-20T22:09:15.2992529Z +                        )
2026-02-20T22:09:15.2993126Z                          async with db_session() as db_fallback:
2026-02-20T22:09:15.2993916Z -                            from app.services.auth_service import get_user_by_username, create_user_token
2026-02-20T22:09:15.2994749Z +                            from app.services.auth_service import (
2026-02-20T22:09:15.2995287Z +                                get_user_by_username,
2026-02-20T22:09:15.2995768Z +                                create_user_token,
2026-02-20T22:09:15.2996214Z +                            )
2026-02-20T22:09:15.2996554Z +
2026-02-20T22:09:15.2996987Z                              user_fallback = get_user_by_username(db_fallback, username)
2026-02-20T22:09:15.2997850Z                              if user_fallback:
2026-02-20T22:09:15.2998574Z                                  # Créer un nouveau refresh_token pour cet utilisateur
2026-02-20T22:09:15.2999318Z -                                new_token_data_fallback = create_user_token(user_fallback)
2026-02-20T22:09:15.3000345Z -                                refresh_token = new_token_data_fallback.get("refresh_token")
2026-02-20T22:09:15.3001372Z -                                logger.info(f"Fallback: Nouveau refresh_token créé pour {username}")
2026-02-20T22:09:15.3002145Z +                                new_token_data_fallback = create_user_token(
2026-02-20T22:09:15.3002714Z +                                    user_fallback
2026-02-20T22:09:15.3003325Z +                                )
2026-02-20T22:09:15.3003819Z +                                refresh_token = new_token_data_fallback.get(
2026-02-20T22:09:15.3004395Z +                                    "refresh_token"
2026-02-20T22:09:15.3004835Z +                                )
2026-02-20T22:09:15.3005253Z +                                logger.info(
2026-02-20T22:09:15.3005993Z +                                    f"Fallback: Nouveau refresh_token créé pour {username}"
2026-02-20T22:09:15.3006585Z +                                )
2026-02-20T22:09:15.3006960Z                              else:
2026-02-20T22:09:15.3007695Z -                                logger.warning(f"Fallback: Utilisateur {username} non trouvé")
2026-02-20T22:09:15.3008367Z +                                logger.warning(
2026-02-20T22:09:15.3009059Z +                                    f"Fallback: Utilisateur {username} non trouvé"
2026-02-20T22:09:15.3009611Z +                                )
2026-02-20T22:09:15.3010032Z                  except Exception as fallback_error:
2026-02-20T22:09:15.3010730Z                      logger.debug(f"Fallback échoué: {fallback_error}")
2026-02-20T22:09:15.3011248Z -        
2026-02-20T22:09:15.3011517Z +
2026-02-20T22:09:15.3011787Z          if not refresh_token:
2026-02-20T22:09:15.3012196Z              return JSONResponse(
2026-02-20T22:09:15.3012842Z -                {"error": "Refresh token requis (body ou cookie). Veuillez vous reconnecter."},
2026-02-20T22:09:15.3013708Z -                status_code=400
2026-02-20T22:09:15.3014078Z -            )
2026-02-20T22:09:15.3014365Z -        
2026-02-20T22:09:15.3014629Z +                {
2026-02-20T22:09:15.3015178Z +                    "error": "Refresh token requis (body ou cookie). Veuillez vous reconnecter."
2026-02-20T22:09:15.3015842Z +                },
2026-02-20T22:09:15.3016153Z +                status_code=400,
2026-02-20T22:09:15.3016521Z +            )
2026-02-20T22:09:15.3016783Z +
2026-02-20T22:09:15.3017069Z          async with db_session() as db:
2026-02-20T22:09:15.3017587Z              # Rafraîchir le token
2026-02-20T22:09:15.3018093Z              new_token_data = refresh_access_token(db, refresh_token)
2026-02-20T22:09:15.3018620Z -            
2026-02-20T22:09:15.3018882Z +
2026-02-20T22:09:15.3019326Z              logger.info("Token rafraîchi avec succès")
2026-02-20T22:09:15.3019778Z -            
2026-02-20T22:09:15.3020046Z +
2026-02-20T22:09:15.3020737Z              # refresh_token UNIQUEMENT en cookie (HttpOnly) — jamais dans le body (sécurité XSS)
2026-02-20T22:09:15.3021474Z              response_data = {
2026-02-20T22:09:15.3021952Z                  "access_token": new_token_data.get("access_token"),
2026-02-20T22:09:15.3022592Z                  "token_type": new_token_data.get("token_type", "bearer"),
2026-02-20T22:09:15.3023301Z              }
2026-02-20T22:09:15.3023715Z              response = JSONResponse(response_data, status_code=200)
2026-02-20T22:09:15.3024249Z -            
2026-02-20T22:09:15.3024520Z +
2026-02-20T22:09:15.3025092Z              # Déterminer la configuration des cookies selon l'environnement
2026-02-20T22:09:15.3025878Z              # En production (cross-domain), utiliser SameSite=None et Secure=True
2026-02-20T22:09:15.3026499Z              import os
2026-02-20T22:09:15.3027054Z +
2026-02-20T22:09:15.3027320Z              is_production = (
2026-02-20T22:09:15.3027775Z -                os.getenv("NODE_ENV") == "production" or 
2026-02-20T22:09:15.3028348Z -                os.getenv("ENVIRONMENT") == "production" or
2026-02-20T22:09:15.3029108Z -                os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.3029674Z +                os.getenv("NODE_ENV") == "production"
2026-02-20T22:09:15.3030229Z +                or os.getenv("ENVIRONMENT") == "production"
2026-02-20T22:09:15.3030813Z +                or os.getenv("MATH_TRAINER_PROFILE") == "prod"
2026-02-20T22:09:15.3031296Z              )
2026-02-20T22:09:15.3031712Z              cookie_samesite = "none" if is_production else "lax"
2026-02-20T22:09:15.3032474Z              cookie_secure = is_production  # Secure=True obligatoire avec SameSite=None
2026-02-20T22:09:15.3033311Z -            
2026-02-20T22:09:15.3033583Z +
2026-02-20T22:09:15.3034171Z              # Mettre à jour le cookie access_token si présent dans la réponse
2026-02-20T22:09:15.3034839Z              from app.core.config import settings
2026-02-20T22:09:15.3035281Z +
2026-02-20T22:09:15.3035595Z              if "access_token" in new_token_data:
2026-02-20T22:09:15.3036230Z                  access_token_max_age = settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60
2026-02-20T22:09:15.3036882Z                  response.set_cookie(
2026-02-20T22:09:15.3037311Z                      key="access_token",
2026-02-20T22:09:15.3037803Z                      value=new_token_data.get("access_token"),
2026-02-20T22:09:15.3038302Z                      httponly=True,
2026-02-20T22:09:15.3038743Z                      max_age=access_token_max_age,
2026-02-20T22:09:15.3039220Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3039673Z -                    secure=cookie_secure
2026-02-20T22:09:15.3040085Z -                )
2026-02-20T22:09:15.3040371Z -            
2026-02-20T22:09:15.3040682Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3041087Z +                )
2026-02-20T22:09:15.3041373Z +
2026-02-20T22:09:15.3041937Z              # Si le refresh_token a été créé via fallback, l'ajouter au cookie
2026-02-20T22:09:15.3042745Z              # Sinon, s'assurer que le refresh_token existe toujours dans les cookies
2026-02-20T22:09:15.3043792Z              refresh_token_max_age = settings.REFRESH_TOKEN_EXPIRE_DAYS * 24 * 60 * 60
2026-02-20T22:09:15.3044603Z              if refresh_token and "refresh_token" not in request.cookies:
2026-02-20T22:09:15.3045431Z                  # Refresh_token créé via fallback, l'ajouter au cookie
2026-02-20T22:09:15.3045970Z @@ -505,34 +581,37 @@
2026-02-20T22:09:15.3046319Z                      key="refresh_token",
2026-02-20T22:09:15.3046736Z                      value=refresh_token,
2026-02-20T22:09:15.3047150Z                      httponly=True,
2026-02-20T22:09:15.3047575Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.3048076Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3048539Z -                    secure=cookie_secure
2026-02-20T22:09:15.3048936Z -                )
2026-02-20T22:09:15.3050051Z -                logger.info(f"Cookie refresh_token créé via fallback et ajouté à la réponse (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.3051063Z -            
2026-02-20T22:09:15.3051379Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3051781Z +                )
2026-02-20T22:09:15.3052091Z +                logger.info(
2026-02-20T22:09:15.3053327Z +                    f"Cookie refresh_token créé via fallback et ajouté à la réponse (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.3054254Z +                )
2026-02-20T22:09:15.3054547Z +
2026-02-20T22:09:15.3055212Z              # Rotation: nouveau refresh_token à chaque refresh — cookie HttpOnly uniquement
2026-02-20T22:09:15.3055957Z              if "refresh_token" in new_token_data:
2026-02-20T22:09:15.3056435Z                  response.set_cookie(
2026-02-20T22:09:15.3057091Z                      key="refresh_token",
2026-02-20T22:09:15.3057588Z                      value=new_token_data.get("refresh_token"),
2026-02-20T22:09:15.3058115Z                      httponly=True,
2026-02-20T22:09:15.3058742Z                      max_age=refresh_token_max_age,
2026-02-20T22:09:15.3059256Z                      samesite=cookie_samesite,
2026-02-20T22:09:15.3059716Z -                    secure=cookie_secure
2026-02-20T22:09:15.3060116Z -                )
2026-02-20T22:09:15.3060987Z -                logger.debug(f"Cookie refresh_token roté (SameSite={cookie_samesite}, Secure={cookie_secure})")
2026-02-20T22:09:15.3061789Z -            
2026-02-20T22:09:15.3062104Z +                    secure=cookie_secure,
2026-02-20T22:09:15.3062507Z +                )
2026-02-20T22:09:15.3062822Z +                logger.debug(
2026-02-20T22:09:15.3063833Z +                    f"Cookie refresh_token roté (SameSite={cookie_samesite}, Secure={cookie_secure})"
2026-02-20T22:09:15.3064550Z +                )
2026-02-20T22:09:15.3064832Z +
2026-02-20T22:09:15.3065104Z              return response
2026-02-20T22:09:15.3065456Z -            
2026-02-20T22:09:15.3065722Z +
2026-02-20T22:09:15.3066032Z      except Exception as token_refresh_error:
2026-02-20T22:09:15.3066899Z          logger.error(f"Erreur lors du rafraîchissement du token: {token_refresh_error}")
2026-02-20T22:09:15.3067647Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3068124Z          return JSONResponse(
2026-02-20T22:09:15.3068682Z -            {"error": "Refresh token invalide ou expiré"},
2026-02-20T22:09:15.3069189Z -            status_code=401
2026-02-20T22:09:15.3069820Z +            {"error": "Refresh token invalide ou expiré"}, status_code=401
2026-02-20T22:09:15.3070390Z          )
2026-02-20T22:09:15.3070643Z  
2026-02-20T22:09:15.3070887Z  
2026-02-20T22:09:15.3071123Z  @require_auth
2026-02-20T22:09:15.3071495Z  async def api_get_current_user(request: Request):
2026-02-20T22:09:15.3071979Z @@ -542,17 +621,19 @@
2026-02-20T22:09:15.3072303Z      Returns: User info
2026-02-20T22:09:15.3072623Z      """
2026-02-20T22:09:15.3072872Z      try:
2026-02-20T22:09:15.3073355Z          current_user = request.state.user
2026-02-20T22:09:15.3073904Z          return JSONResponse(current_user, status_code=200)
2026-02-20T22:09:15.3074399Z -        
2026-02-20T22:09:15.3074654Z +
2026-02-20T22:09:15.3074970Z      except Exception as user_retrieval_error:
2026-02-20T22:09:15.3075901Z -        logger.error(f"Erreur lors de la récupération de l'utilisateur: {user_retrieval_error}")
2026-02-20T22:09:15.3076642Z +        logger.error(
2026-02-20T22:09:15.3077323Z +            f"Erreur lors de la récupération de l'utilisateur: {user_retrieval_error}"
2026-02-20T22:09:15.3077957Z +        )
2026-02-20T22:09:15.3078290Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3078752Z          return JSONResponse(
2026-02-20T22:09:15.3079399Z              {"error": "Erreur lors de la récupération de l'utilisateur"},
2026-02-20T22:09:15.3079983Z -            status_code=500
2026-02-20T22:09:15.3080359Z +            status_code=500,
2026-02-20T22:09:15.3080701Z          )
2026-02-20T22:09:15.3080962Z  
2026-02-20T22:09:15.3081198Z  
2026-02-20T22:09:15.3081497Z  @rate_limit_auth("forgot-password")
2026-02-20T22:09:15.3082008Z  async def api_forgot_password(request: Request):
2026-02-20T22:09:15.3082478Z @@ -562,17 +643,14 @@
2026-02-20T22:09:15.3082838Z      Route: POST /api/auth/forgot-password
2026-02-20T22:09:15.3083528Z      Body: {"email": "user@example.com"}
2026-02-20T22:09:15.3083941Z      """
2026-02-20T22:09:15.3084253Z      try:
2026-02-20T22:09:15.3084547Z          data = await request.json()
2026-02-20T22:09:15.3084994Z -        email = data.get('email', '').strip().lower()
2026-02-20T22:09:15.3085528Z +        email = data.get("email", "").strip().lower()
2026-02-20T22:09:15.3085978Z  
2026-02-20T22:09:15.3086231Z          if not email:
2026-02-20T22:09:15.3086568Z -            return JSONResponse(
2026-02-20T22:09:15.3087228Z -                {"error": "Adresse email requise"},
2026-02-20T22:09:15.3087708Z -                status_code=400
2026-02-20T22:09:15.3088077Z -            )
2026-02-20T22:09:15.3088601Z +            return JSONResponse({"error": "Adresse email requise"}, status_code=400)
2026-02-20T22:09:15.3089417Z  
2026-02-20T22:09:15.3089727Z          async with db_session() as db:
2026-02-20T22:09:15.3090191Z              user = get_user_by_email(db, email)
2026-02-20T22:09:15.3090619Z  
2026-02-20T22:09:15.3091355Z              # Pour la sécurité, toujours retourner le même message (évite l'énumération d'emails)
2026-02-20T22:09:15.3092075Z @@ -598,38 +676,43 @@
2026-02-20T22:09:15.3092489Z              user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:15.3093122Z  
2026-02-20T22:09:15.3093400Z              db.commit()
2026-02-20T22:09:15.3093744Z              db.refresh(user)
2026-02-20T22:09:15.3094092Z  
2026-02-20T22:09:15.3094668Z -            frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:15.3095449Z +            frontend_url = os.getenv(
2026-02-20T22:09:15.3096030Z +                "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:15.3096599Z +            )
2026-02-20T22:09:15.3097021Z              email_sent = EmailService.send_password_reset_email(
2026-02-20T22:09:15.3097569Z                  to_email=user.email,
2026-02-20T22:09:15.3097996Z                  username=user.username,
2026-02-20T22:09:15.3098431Z                  reset_token=reset_token,
2026-02-20T22:09:15.3098875Z -                frontend_url=frontend_url
2026-02-20T22:09:15.3099334Z +                frontend_url=frontend_url,
2026-02-20T22:09:15.3099739Z              )
2026-02-20T22:09:15.3100012Z  
2026-02-20T22:09:15.3100271Z              if not email_sent:
2026-02-20T22:09:15.3100927Z                  logger.warning(f"Échec envoi email reset à {user.email}")
2026-02-20T22:09:15.3101510Z                  return JSONResponse(
2026-02-20T22:09:15.3102334Z -                    {"error": "Impossible d'envoyer l'email. Veuillez réessayer plus tard."},
2026-02-20T22:09:15.3103185Z -                    status_code=500
2026-02-20T22:09:15.3103585Z +                    {
2026-02-20T22:09:15.3104302Z +                        "error": "Impossible d'envoyer l'email. Veuillez réessayer plus tard."
2026-02-20T22:09:15.3104953Z +                    },
2026-02-20T22:09:15.3105295Z +                    status_code=500,
2026-02-20T22:09:15.3105673Z                  )
2026-02-20T22:09:15.3105964Z  
2026-02-20T22:09:15.3106529Z              logger.info(f"Email de réinitialisation envoyé à {user.email}")
2026-02-20T22:09:15.3107499Z              # En dev avec localhost : Gmail filtre souvent ces emails. Afficher le lien en console pour tester.
2026-02-20T22:09:15.3108328Z              if "localhost" in frontend_url:
2026-02-20T22:09:15.3108959Z                  reset_link = f"{frontend_url}/reset-password?token={reset_token}"
2026-02-20T22:09:15.3109901Z -                logger.info(f"[DEV] Si l'email n'arrive pas (filtre Gmail), copie ce lien : {reset_link}")
2026-02-20T22:09:15.3110661Z +                logger.info(
2026-02-20T22:09:15.3111264Z +                    f"[DEV] Si l'email n'arrive pas (filtre Gmail), copie ce lien : {reset_link}"
2026-02-20T22:09:15.3111916Z +                )
2026-02-20T22:09:15.3112414Z              return JSONResponse({"message": success_message}, status_code=200)
2026-02-20T22:09:15.3113172Z  
2026-02-20T22:09:15.3113472Z      except Exception as forgot_err:
2026-02-20T22:09:15.3114014Z          logger.error(f"Erreur forgot-password: {forgot_err}")
2026-02-20T22:09:15.3114588Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3115057Z          return JSONResponse(
2026-02-20T22:09:15.3115528Z -            {"error": "Erreur lors du traitement de la demande"},
2026-02-20T22:09:15.3116057Z -            status_code=500
2026-02-20T22:09:15.3116592Z +            {"error": "Erreur lors du traitement de la demande"}, status_code=500
2026-02-20T22:09:15.3117396Z          )
2026-02-20T22:09:15.3117651Z  
2026-02-20T22:09:15.3117894Z  
2026-02-20T22:09:15.3118227Z  async def api_reset_password(request: Request):
2026-02-20T22:09:15.3118675Z      """
2026-02-20T22:09:15.3118946Z @@ -641,56 +724,54 @@
2026-02-20T22:09:15.3119466Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:15.3119921Z      if csrf_err:
2026-02-20T22:09:15.3120225Z          return csrf_err
2026-02-20T22:09:15.3120551Z      try:
2026-02-20T22:09:15.3120842Z          data = await request.json()
2026-02-20T22:09:15.3121302Z -        token = (data.get('token') or '').strip()
2026-02-20T22:09:15.3121812Z -        password = data.get('password', '')
2026-02-20T22:09:15.3122363Z -        password_confirm = data.get('password_confirm', '')
2026-02-20T22:09:15.3122938Z +        token = (data.get("token") or "").strip()
2026-02-20T22:09:15.3123602Z +        password = data.get("password", "")
2026-02-20T22:09:15.3124152Z +        password_confirm = data.get("password_confirm", "")
2026-02-20T22:09:15.3124642Z  
2026-02-20T22:09:15.3124907Z          if not token:
2026-02-20T22:09:15.3125245Z              return JSONResponse(
2026-02-20T22:09:15.3125865Z -                {"error": "Token de réinitialisation manquant"},
2026-02-20T22:09:15.3126376Z -                status_code=400
2026-02-20T22:09:15.3127046Z +                {"error": "Token de réinitialisation manquant"}, status_code=400
2026-02-20T22:09:15.3127626Z              )
2026-02-20T22:09:15.3127894Z  
2026-02-20T22:09:15.3128198Z          if not password or len(password) < 8:
2026-02-20T22:09:15.3128658Z              return JSONResponse(
2026-02-20T22:09:15.3129348Z                  {"error": "Le mot de passe doit contenir au moins 8 caractères"},
2026-02-20T22:09:15.3129939Z -                status_code=400
2026-02-20T22:09:15.3130327Z +                status_code=400,
2026-02-20T22:09:15.3130680Z              )
2026-02-20T22:09:15.3131061Z          if not any(char.isdigit() for char in password):
2026-02-20T22:09:15.3131583Z              return JSONResponse(
2026-02-20T22:09:15.3132120Z                  {"error": "Le mot de passe doit contenir au moins un chiffre"},
2026-02-20T22:09:15.3132705Z -                status_code=400
2026-02-20T22:09:15.3133268Z +                status_code=400,
2026-02-20T22:09:15.3133630Z              )
2026-02-20T22:09:15.3134023Z          if not any(char.isupper() for char in password):
2026-02-20T22:09:15.3134566Z              return JSONResponse(
2026-02-20T22:09:15.3135113Z                  {"error": "Le mot de passe doit contenir au moins une majuscule"},
2026-02-20T22:09:15.3135703Z -                status_code=400
2026-02-20T22:09:15.3136084Z +                status_code=400,
2026-02-20T22:09:15.3136432Z              )
2026-02-20T22:09:15.3136708Z  
2026-02-20T22:09:15.3137003Z          if password != password_confirm:
2026-02-20T22:09:15.3137445Z              return JSONResponse(
2026-02-20T22:09:15.3137941Z -                {"error": "Les mots de passe ne correspondent pas"},
2026-02-20T22:09:15.3145691Z -                status_code=400
2026-02-20T22:09:15.3146240Z +                {"error": "Les mots de passe ne correspondent pas"}, status_code=400
2026-02-20T22:09:15.3146855Z              )
2026-02-20T22:09:15.3147144Z  
2026-02-20T22:09:15.3147443Z          async with db_session() as db:
2026-02-20T22:09:15.3147909Z              from app.models.user import User
2026-02-20T22:09:15.3148335Z +
2026-02-20T22:09:15.3148809Z              user = db.query(User).filter(User.password_reset_token == token).first()
2026-02-20T22:09:15.3149425Z  
2026-02-20T22:09:15.3149692Z              if not user:
2026-02-20T22:09:15.3150054Z                  return JSONResponse(
2026-02-20T22:09:15.3150716Z -                    {"error": "Token invalide ou déjà utilisé"},
2026-02-20T22:09:15.3151235Z -                    status_code=400
2026-02-20T22:09:15.3151915Z +                    {"error": "Token invalide ou déjà utilisé"}, status_code=400
2026-02-20T22:09:15.3152726Z                  )
2026-02-20T22:09:15.3153217Z  
2026-02-20T22:09:15.3153703Z              if is_password_reset_token_expired(user.password_reset_expires_at):
2026-02-20T22:09:15.3154335Z                  return JSONResponse(
2026-02-20T22:09:15.3155289Z                      {"error": "Le lien a expiré. Veuillez demander un nouveau lien."},
2026-02-20T22:09:15.3155932Z -                    status_code=400
2026-02-20T22:09:15.3156338Z +                    status_code=400,
2026-02-20T22:09:15.3156722Z                  )
2026-02-20T22:09:15.3157004Z  
2026-02-20T22:09:15.3157378Z              user.hashed_password = get_password_hash(password)
2026-02-20T22:09:15.3157945Z              user.password_reset_token = None
2026-02-20T22:09:15.3158446Z              user.password_reset_expires_at = None
2026-02-20T22:09:15.3158904Z @@ -698,21 +779,24 @@
2026-02-20T22:09:15.3159203Z  
2026-02-20T22:09:15.3159460Z              db.commit()
2026-02-20T22:09:15.3159807Z              db.refresh(user)
2026-02-20T22:09:15.3160165Z  
2026-02-20T22:09:15.3160726Z              logger.info(f"Mot de passe réinitialisé pour {user.username}")
2026-02-20T22:09:15.3161348Z -            return JSONResponse({
2026-02-20T22:09:15.3162171Z -                "message": "Mot de passe réinitialisé avec succès. Vous pouvez vous connecter.",
2026-02-20T22:09:15.3162911Z -                "success": True
2026-02-20T22:09:15.3163485Z -            }, status_code=200)
2026-02-20T22:09:15.3163876Z +            return JSONResponse(
2026-02-20T22:09:15.3164242Z +                {
2026-02-20T22:09:15.3165837Z +                    "message": "Mot de passe réinitialisé avec succès. Vous pouvez vous connecter.",
2026-02-20T22:09:15.3168200Z +                    "success": True,
2026-02-20T22:09:15.3283675Z +                },
2026-02-20T22:09:15.3284035Z +                status_code=200,
2026-02-20T22:09:15.3284488Z +            )
2026-02-20T22:09:15.3284779Z  
2026-02-20T22:09:15.3285064Z      except Exception as reset_err:
2026-02-20T22:09:15.3285627Z          logger.error(f"Erreur reset-password: {reset_err}")
2026-02-20T22:09:15.3286194Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3286666Z          return JSONResponse(
2026-02-20T22:09:15.3287377Z              {"error": "Erreur lors de la réinitialisation du mot de passe"},
2026-02-20T22:09:15.3287982Z -            status_code=500
2026-02-20T22:09:15.3288364Z +            status_code=500,
2026-02-20T22:09:15.3288710Z          )
2026-02-20T22:09:15.3288972Z  
2026-02-20T22:09:15.3289211Z  
2026-02-20T22:09:15.3289495Z  async def api_logout(request: Request):
2026-02-20T22:09:15.3289849Z      """
2026-02-20T22:09:15.3290076Z @@ -749,12 +833,6 @@
2026-02-20T22:09:15.3290688Z          logger.info("Utilisateur déconnecté : cookies d'authentification effacés.")
2026-02-20T22:09:15.3291305Z          return response
2026-02-20T22:09:15.3291642Z      except Exception as logout_error:
2026-02-20T22:09:15.3292264Z          logger.error(f"Erreur lors de la déconnexion: {logout_error}")
2026-02-20T22:09:15.3292856Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:15.3293483Z -        return JSONResponse(
2026-02-20T22:09:15.3293961Z -            {"error": "Erreur lors de la déconnexion"},
2026-02-20T22:09:15.3294374Z -            status_code=500
2026-02-20T22:09:15.3294692Z -        )
2026-02-20T22:09:15.3294949Z -
2026-02-20T22:09:15.3295183Z -
2026-02-20T22:09:15.3295403Z -
2026-02-20T22:09:15.3296037Z +        return JSONResponse({"error": "Erreur lors de la déconnexion"}, status_code=500)
2026-02-20T22:09:15.9446632Z --- /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:15.9451075Z +++ /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py	2026-02-20 22:09:15.936430+00:00
2026-02-20T22:09:15.9451941Z @@ -1,9 +1,10 @@
2026-02-20T22:09:15.9452234Z  """
2026-02-20T22:09:15.9452555Z  Handlers pour le chatbot utilisant OpenAI
2026-02-20T22:09:15.9453751Z  Optimisé avec streaming SSE, smart routing, et best practices AI modernes
2026-02-20T22:09:15.9454816Z  """
2026-02-20T22:09:15.9455074Z +
2026-02-20T22:09:15.9455321Z  import json
2026-02-20T22:09:15.9455610Z  import os
2026-02-20T22:09:15.9455865Z  
2026-02-20T22:09:15.9456303Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:15.9457091Z  
2026-02-20T22:09:15.9457347Z @@ -14,71 +15,96 @@
2026-02-20T22:09:15.9457637Z  
2026-02-20T22:09:15.9457902Z  logger = get_logger(__name__)
2026-02-20T22:09:15.9458258Z  
2026-02-20T22:09:15.9458492Z  try:
2026-02-20T22:09:15.9458787Z      from openai import AsyncOpenAI
2026-02-20T22:09:15.9459165Z +
2026-02-20T22:09:15.9459521Z      OPENAI_AVAILABLE = True
2026-02-20T22:09:15.9459901Z  except ImportError:
2026-02-20T22:09:15.9460245Z      OPENAI_AVAILABLE = False
2026-02-20T22:09:15.9460590Z  
2026-02-20T22:09:15.9460831Z  
2026-02-20T22:09:15.9461306Z  def _detect_complexity(message: str, conversation_history: list) -> str:
2026-02-20T22:09:15.9461925Z      """
2026-02-20T22:09:15.9462494Z      Détecte la complexité de la question pour smart routing.
2026-02-20T22:09:15.9463488Z      Retourne 'simple' ou 'complex' pour choisir le modèle approprié.
2026-02-20T22:09:15.9464063Z -    
2026-02-20T22:09:15.9464309Z +
2026-02-20T22:09:15.9464946Z      Best practice : Utiliser gpt-4o-mini pour questions simples (coût réduit),
2026-02-20T22:09:15.9465798Z      gpt-4o pour questions complexes (meilleure qualité).
2026-02-20T22:09:15.9466292Z      """
2026-02-20T22:09:15.9466589Z      message_lower = message.lower()
2026-02-20T22:09:15.9466975Z -    
2026-02-20T22:09:15.9467227Z +
2026-02-20T22:09:15.9467546Z      # Indicateurs de complexité
2026-02-20T22:09:15.9467950Z      complex_keywords = [
2026-02-20T22:09:15.9468588Z -        'démontrer', 'prouver', 'théorème', 'formule', 'équation complexe',
2026-02-20T22:09:15.9469467Z -        'raisonnement', 'déduction', 'logique avancée', 'grille logique',
2026-02-20T22:09:15.9470381Z -        'combinatoire', 'probabilité', 'séquence complexe', 'pattern avancé',
2026-02-20T22:09:15.9471337Z -        'résoudre étape par étape', 'explique en détail', 'comment fonctionne'
2026-02-20T22:09:15.9472005Z +        "démontrer",
2026-02-20T22:09:15.9472317Z +        "prouver",
2026-02-20T22:09:15.9472686Z +        "théorème",
2026-02-20T22:09:15.9473160Z +        "formule",
2026-02-20T22:09:15.9473567Z +        "équation complexe",
2026-02-20T22:09:15.9473934Z +        "raisonnement",
2026-02-20T22:09:15.9474325Z +        "déduction",
2026-02-20T22:09:15.9474698Z +        "logique avancée",
2026-02-20T22:09:15.9475066Z +        "grille logique",
2026-02-20T22:09:15.9475411Z +        "combinatoire",
2026-02-20T22:09:15.9475809Z +        "probabilité",
2026-02-20T22:09:15.9476214Z +        "séquence complexe",
2026-02-20T22:09:15.9476638Z +        "pattern avancé",
2026-02-20T22:09:15.9477082Z +        "résoudre étape par étape",
2026-02-20T22:09:15.9477556Z +        "explique en détail",
2026-02-20T22:09:15.9477938Z +        "comment fonctionne",
2026-02-20T22:09:15.9478293Z      ]
2026-02-20T22:09:15.9478548Z -    
2026-02-20T22:09:15.9478795Z +
2026-02-20T22:09:15.9479066Z      simple_keywords = [
2026-02-20T22:09:15.9479663Z -        'combien fait', 'c\'est quoi', 'qu\'est-ce que', 'définition',
2026-02-20T22:09:15.9480462Z -        'exemple', 'calcul simple', 'addition', 'soustraction', 'multiplication',
2026-02-20T22:09:15.9481160Z -        'division', 'aide', 'explique simplement'
2026-02-20T22:09:15.9481614Z +        "combien fait",
2026-02-20T22:09:15.9481952Z +        "c'est quoi",
2026-02-20T22:09:15.9482276Z +        "qu'est-ce que",
2026-02-20T22:09:15.9482675Z +        "définition",
2026-02-20T22:09:15.9483128Z +        "exemple",
2026-02-20T22:09:15.9483449Z +        "calcul simple",
2026-02-20T22:09:15.9483781Z +        "addition",
2026-02-20T22:09:15.9484099Z +        "soustraction",
2026-02-20T22:09:15.9484448Z +        "multiplication",
2026-02-20T22:09:15.9484787Z +        "division",
2026-02-20T22:09:15.9485090Z +        "aide",
2026-02-20T22:09:15.9485680Z +        "explique simplement",
2026-02-20T22:09:15.9486042Z      ]
2026-02-20T22:09:15.9486288Z -    
2026-02-20T22:09:15.9486541Z +
2026-02-20T22:09:15.9486952Z      # Questions courtes = généralement simples
2026-02-20T22:09:15.9487435Z      if len(message.split()) <= 5:
2026-02-20T22:09:15.9488014Z -        return 'simple'
2026-02-20T22:09:15.9488351Z -    
2026-02-20T22:09:15.9488614Z +        return "simple"
2026-02-20T22:09:15.9488929Z +
2026-02-20T22:09:15.9489292Z      # Détecter mots-clés complexes
2026-02-20T22:09:15.9489851Z      if any(keyword in message_lower for keyword in complex_keywords):
2026-02-20T22:09:15.9490463Z -        return 'complex'
2026-02-20T22:09:15.9490790Z -    
2026-02-20T22:09:15.9491051Z +        return "complex"
2026-02-20T22:09:15.9491370Z +
2026-02-20T22:09:15.9491711Z      # Détecter mots-clés simples
2026-02-20T22:09:15.9492263Z      if any(keyword in message_lower for keyword in simple_keywords):
2026-02-20T22:09:15.9492825Z -        return 'simple'
2026-02-20T22:09:15.9494104Z -    
2026-02-20T22:09:15.9494412Z +        return "simple"
2026-02-20T22:09:15.9503705Z +
2026-02-20T22:09:15.9504815Z      # Par défaut, utiliser le modèle simple pour économiser les coûts
2026-02-20T22:09:15.9543229Z -    return 'simple'
2026-02-20T22:09:15.9543600Z +    return "simple"
2026-02-20T22:09:15.9543939Z  
2026-02-20T22:09:15.9544197Z  
2026-02-20T22:09:15.9544527Z  def _estimate_age(message: str) -> str | None:
2026-02-20T22:09:15.9544995Z      """
2026-02-20T22:09:15.9545508Z      Estime l'âge de l'utilisateur depuis le message.
2026-02-20T22:09:15.9546335Z      Amélioration : pourrait utiliser le profil utilisateur si disponible.
2026-02-20T22:09:15.9546949Z      """
2026-02-20T22:09:15.9547243Z      message_lower = message.lower()
2026-02-20T22:09:15.9547643Z -    
2026-02-20T22:09:15.9548187Z -    if any(word in message_lower for word in ['cm1', 'cm2', 'cp', 'ce1', 'ce2', 'maternelle']):
2026-02-20T22:09:15.9548893Z -        return '5-8'
2026-02-20T22:09:15.9549638Z -    elif any(word in message_lower for word in ['6ème', '5ème', 'collège', 'primaire']):
2026-02-20T22:09:15.9550328Z -        return '9-12'
2026-02-20T22:09:15.9551013Z -    elif any(word in message_lower for word in ['4ème', '3ème', 'lycée', 'seconde']):
2026-02-20T22:09:15.9551675Z -        return '13-16'
2026-02-20T22:09:15.9552386Z -    elif any(word in message_lower for word in ['terminale', 'bac', 'université']):
2026-02-20T22:09:15.9553324Z -        return '17-20'
2026-02-20T22:09:15.9553657Z -    
2026-02-20T22:09:15.9553909Z +
2026-02-20T22:09:15.9554162Z +    if any(
2026-02-20T22:09:15.9554459Z +        word in message_lower
2026-02-20T22:09:15.9554954Z +        for word in ["cm1", "cm2", "cp", "ce1", "ce2", "maternelle"]
2026-02-20T22:09:15.9555468Z +    ):
2026-02-20T22:09:15.9555743Z +        return "5-8"
2026-02-20T22:09:15.9556463Z +    elif any(word in message_lower for word in ["6ème", "5ème", "collège", "primaire"]):
2026-02-20T22:09:15.9557130Z +        return "9-12"
2026-02-20T22:09:15.9557845Z +    elif any(word in message_lower for word in ["4ème", "3ème", "lycée", "seconde"]):
2026-02-20T22:09:15.9558489Z +        return "13-16"
2026-02-20T22:09:15.9559173Z +    elif any(word in message_lower for word in ["terminale", "bac", "université"]):
2026-02-20T22:09:15.9559894Z +        return "17-20"
2026-02-20T22:09:15.9560218Z +
2026-02-20T22:09:15.9560469Z      return None
2026-02-20T22:09:15.9560775Z  
2026-02-20T22:09:15.9561008Z  
2026-02-20T22:09:15.9561440Z  def _build_system_prompt(estimated_age: str | None = None) -> str:
2026-02-20T22:09:15.9562003Z      """
2026-02-20T22:09:15.9562264Z @@ -134,28 +160,24 @@
2026-02-20T22:09:15.9562566Z  
2026-02-20T22:09:15.9562815Z  @rate_limit_chat
2026-02-20T22:09:15.9563343Z  async def chat_api(request):
2026-02-20T22:09:15.9563706Z      """
2026-02-20T22:09:15.9564724Z      Endpoint API pour le chatbot
2026-02-20T22:09:15.9565710Z -    
2026-02-20T22:09:15.9567008Z +
2026-02-20T22:09:15.9623513Z      Utilise OpenAI pour répondre aux questions sur Mathakine
2026-02-20T22:09:15.9624375Z      """
2026-02-20T22:09:15.9624644Z      try:
2026-02-20T22:09:15.9625109Z          # Vérifier que OpenAI est disponible
2026-02-20T22:09:15.9625587Z          if not OPENAI_AVAILABLE:
2026-02-20T22:09:15.9625990Z -            return JSONResponse(
2026-02-20T22:09:15.9626612Z -                {"error": "OpenAI non disponible"},
2026-02-20T22:09:15.9627099Z -                status_code=503
2026-02-20T22:09:15.9627468Z -            )
2026-02-20T22:09:15.9627744Z -        
2026-02-20T22:09:15.9628250Z +            return JSONResponse({"error": "OpenAI non disponible"}, status_code=503)
2026-02-20T22:09:15.9628885Z +
2026-02-20T22:09:15.9629307Z          # Vérifier que la clé API est configurée
2026-02-20T22:09:15.9629799Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:15.9630235Z              return JSONResponse(
2026-02-20T22:09:15.9630806Z -                {"error": "Clé API OpenAI non configurée"},
2026-02-20T22:09:15.9631302Z -                status_code=503
2026-02-20T22:09:15.9631684Z -            )
2026-02-20T22:09:15.9631958Z -        
2026-02-20T22:09:15.9632511Z +                {"error": "Clé API OpenAI non configurée"}, status_code=503
2026-02-20T22:09:15.9633264Z +            )
2026-02-20T22:09:15.9633554Z +
2026-02-20T22:09:15.9634094Z          # Récupérer les données de la requête (DRY parse_json_body)
2026-02-20T22:09:15.9634752Z          from app.utils.request_utils import parse_json_body
2026-02-20T22:09:15.9635252Z  
2026-02-20T22:09:15.9635546Z          data_or_err = await parse_json_body(
2026-02-20T22:09:15.9635983Z              request,
2026-02-20T22:09:15.9636301Z @@ -166,302 +188,408 @@
2026-02-20T22:09:15.9636640Z              return data_or_err
2026-02-20T22:09:15.9637045Z          message_raw = data_or_err["message"]
2026-02-20T22:09:15.9637705Z          conversation_history = data_or_err.get("conversation_history", [])[:20]
2026-02-20T22:09:15.9638326Z  
2026-02-20T22:09:15.9638844Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:15.9639729Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:15.9640521Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:15.9641011Z +            sanitize_user_prompt,
2026-02-20T22:09:15.9641424Z +            validate_prompt_safety,
2026-02-20T22:09:15.9641813Z +        )
2026-02-20T22:09:15.9642068Z +
2026-02-20T22:09:15.9642473Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:15.9643183Z          if not is_safe:
2026-02-20T22:09:15.9643543Z              return JSONResponse(
2026-02-20T22:09:15.9644025Z -                {"error": f"Message invalide: {safety_reason}"},
2026-02-20T22:09:15.9644537Z -                status_code=400
2026-02-20T22:09:15.9645073Z +                {"error": f"Message invalide: {safety_reason}"}, status_code=400
2026-02-20T22:09:15.9645631Z              )
2026-02-20T22:09:15.9646076Z          message = sanitize_user_prompt(message_raw, max_length=2000)
2026-02-20T22:09:15.9646628Z  
2026-02-20T22:09:15.9646982Z          # Créer le client OpenAI
2026-02-20T22:09:15.9647494Z          client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:15.9648001Z -        
2026-02-20T22:09:15.9648258Z +
2026-02-20T22:09:15.9648736Z          # Détecter si la demande concerne une image mathématique
2026-02-20T22:09:15.9650218Z -        image_keywords = ['image', 'dessine', 'dessin', 'schéma', 'diagramme', 'figure', 'graphique', 'visualise', 'montre', 'créer', 'génère', 'fais', 'montre-moi', 'affiche']
2026-02-20T22:09:15.9652748Z -        math_image_keywords = ['géométrie', 'triangle', 'cercle', 'carré', 'rectangle', 'forme', 'angle', 'fraction', 'graphique', 'courbe', 'polygone', 'losange', 'trapèze', 'cercle', 'ovale', 'ligne', 'point', 'segment', 'exercice', 'problème']
2026-02-20T22:09:15.9684560Z -        
2026-02-20T22:09:15.9684878Z +        image_keywords = [
2026-02-20T22:09:15.9685235Z +            "image",
2026-02-20T22:09:15.9685804Z +            "dessine",
2026-02-20T22:09:15.9686122Z +            "dessin",
2026-02-20T22:09:15.9686535Z +            "schéma",
2026-02-20T22:09:15.9686849Z +            "diagramme",
2026-02-20T22:09:15.9687187Z +            "figure",
2026-02-20T22:09:15.9687494Z +            "graphique",
2026-02-20T22:09:15.9688019Z +            "visualise",
2026-02-20T22:09:15.9688362Z +            "montre",
2026-02-20T22:09:15.9688728Z +            "créer",
2026-02-20T22:09:15.9689096Z +            "génère",
2026-02-20T22:09:15.9689396Z +            "fais",
2026-02-20T22:09:15.9689706Z +            "montre-moi",
2026-02-20T22:09:15.9690044Z +            "affiche",
2026-02-20T22:09:15.9690357Z +        ]
2026-02-20T22:09:15.9690645Z +        math_image_keywords = [
2026-02-20T22:09:15.9691091Z +            "géométrie",
2026-02-20T22:09:15.9691419Z +            "triangle",
2026-02-20T22:09:15.9691765Z +            "cercle",
2026-02-20T22:09:15.9692131Z +            "carré",
2026-02-20T22:09:15.9692433Z +            "rectangle",
2026-02-20T22:09:15.9692775Z +            "forme",
2026-02-20T22:09:15.9693239Z +            "angle",
2026-02-20T22:09:15.9693548Z +            "fraction",
2026-02-20T22:09:15.9693870Z +            "graphique",
2026-02-20T22:09:15.9694199Z +            "courbe",
2026-02-20T22:09:15.9694517Z +            "polygone",
2026-02-20T22:09:15.9694849Z +            "losange",
2026-02-20T22:09:15.9695228Z +            "trapèze",
2026-02-20T22:09:15.9695546Z +            "cercle",
2026-02-20T22:09:15.9695844Z +            "ovale",
2026-02-20T22:09:15.9696149Z +            "ligne",
2026-02-20T22:09:15.9696454Z +            "point",
2026-02-20T22:09:15.9696751Z +            "segment",
2026-02-20T22:09:15.9697073Z +            "exercice",
2026-02-20T22:09:15.9697458Z +            "problème",
2026-02-20T22:09:15.9697781Z +        ]
2026-02-20T22:09:15.9698038Z +
2026-02-20T22:09:15.9698568Z          is_image_request = any(keyword in message.lower() for keyword in image_keywords)
2026-02-20T22:09:15.9699572Z -        is_math_related = any(keyword in message.lower() for keyword in math_image_keywords) or any(
2026-02-20T22:09:15.9700996Z -            keyword in message.lower() for keyword in ['math', 'mathématique', 'calcul', 'nombre', 'équation', 'exercice', 'problème']
2026-02-20T22:09:15.9701891Z -        )
2026-02-20T22:09:15.9702164Z -        
2026-02-20T22:09:15.9702465Z +        is_math_related = any(
2026-02-20T22:09:15.9703146Z +            keyword in message.lower() for keyword in math_image_keywords
2026-02-20T22:09:15.9703719Z +        ) or any(
2026-02-20T22:09:15.9704047Z +            keyword in message.lower()
2026-02-20T22:09:15.9704471Z +            for keyword in [
2026-02-20T22:09:15.9704824Z +                "math",
2026-02-20T22:09:15.9705251Z +                "mathématique",
2026-02-20T22:09:15.9705650Z +                "calcul",
2026-02-20T22:09:15.9705985Z +                "nombre",
2026-02-20T22:09:15.9706386Z +                "équation",
2026-02-20T22:09:15.9706732Z +                "exercice",
2026-02-20T22:09:15.9707162Z +                "problème",
2026-02-20T22:09:15.9707486Z +            ]
2026-02-20T22:09:15.9707759Z +        )
2026-02-20T22:09:15.9708011Z +
2026-02-20T22:09:15.9708565Z          # Si demande d'image ET mathématique, générer une image avec DALL-E
2026-02-20T22:09:15.9709559Z          # MAIS continuer avec la réponse texte complète pour avoir l'exercice résolvable
2026-02-20T22:09:15.9710303Z          if is_image_request and is_math_related:
2026-02-20T22:09:15.9710754Z              try:
2026-02-20T22:09:15.9711452Z                  # Construire un prompt optimisé pour DALL-E (style éducatif, adapté enfants)
2026-02-20T22:09:15.9712615Z                  dalle_prompt = f"""Image éducative mathématique pour enfants de 5 à 20 ans : {message}. 
2026-02-20T22:09:15.9744154Z  Style simple, clair, coloré, adapté aux enfants. Éléments visuels mathématiques uniquement. 
2026-02-20T22:09:15.9745346Z  Pas de texte complexe, formes géométriques simples, couleurs vives et contrastées."""
2026-02-20T22:09:15.9746306Z -                
2026-02-20T22:09:15.9746593Z +
2026-02-20T22:09:15.9747006Z                  # Générer une image avec DALL-E 3
2026-02-20T22:09:15.9747556Z                  image_response = await client.images.generate(
2026-02-20T22:09:15.9748091Z                      model="dall-e-3",
2026-02-20T22:09:15.9748740Z                      prompt=dalle_prompt,
2026-02-20T22:09:15.9749202Z                      size="1024x1024",
2026-02-20T22:09:15.9749614Z                      quality="standard",
2026-02-20T22:09:15.9750021Z                      n=1,
2026-02-20T22:09:15.9750354Z                  )
2026-02-20T22:09:15.9750638Z -                
2026-02-20T22:09:15.9750935Z +
2026-02-20T22:09:15.9751261Z                  image_url = image_response.data[0].url
2026-02-20T22:09:15.9752153Z                  # Ne pas retourner immédiatement - continuer pour générer l'exercice complet
2026-02-20T22:09:15.9753171Z                  # L'image sera ajoutée à la réponse finale
2026-02-20T22:09:15.9753764Z              except Exception as dalle_generation_error:
2026-02-20T22:09:15.9754608Z                  # Si erreur de génération d'image, continuer avec la réponse texte normale
2026-02-20T22:09:15.9755665Z -                logger.error(f"Erreur génération image DALL-E: {str(dalle_generation_error)}")
2026-02-20T22:09:15.9756383Z +                logger.error(
2026-02-20T22:09:15.9757066Z +                    f"Erreur génération image DALL-E: {str(dalle_generation_error)}"
2026-02-20T22:09:15.9757660Z +                )
2026-02-20T22:09:15.9757965Z                  image_url = None
2026-02-20T22:09:15.9758336Z          else:
2026-02-20T22:09:15.9758625Z              image_url = None
2026-02-20T22:09:15.9758977Z -        
2026-02-20T22:09:15.9759235Z +
2026-02-20T22:09:15.9759742Z          # Détecter la complexité pour smart routing
2026-02-20T22:09:15.9760394Z          complexity = _detect_complexity(message, conversation_history)
2026-02-20T22:09:15.9760952Z -        
2026-02-20T22:09:15.9761228Z +
2026-02-20T22:09:15.9761704Z          # Smart routing : choisir le modèle selon la complexité
2026-02-20T22:09:15.9762766Z          # Best practice : gpt-4o-mini pour questions simples (coût réduit), gpt-4o pour complexes (qualité)
2026-02-20T22:09:15.9763888Z -        model = "gpt-4o-mini" if complexity == 'simple' else "gpt-4o"
2026-02-20T22:09:15.9764432Z -        
2026-02-20T22:09:15.9764845Z +        model = "gpt-4o-mini" if complexity == "simple" else "gpt-4o"
2026-02-20T22:09:15.9765376Z +
2026-02-20T22:09:15.9765781Z          # Détecter l'âge pour personnalisation
2026-02-20T22:09:15.9766272Z          estimated_age = _estimate_age(message)
2026-02-20T22:09:15.9766700Z -        
2026-02-20T22:09:15.9766955Z +
2026-02-20T22:09:15.9812304Z          # Construire le prompt système optimisé avec few-shot learning
2026-02-20T22:09:15.9813192Z          system_prompt = _build_system_prompt(estimated_age)
2026-02-20T22:09:15.9813714Z  
2026-02-20T22:09:15.9814035Z          # Construire les messages pour OpenAI
2026-02-20T22:09:15.9814497Z -        messages = [
2026-02-20T22:09:15.9814905Z -            {"role": "system", "content": system_prompt}
2026-02-20T22:09:15.9815361Z -        ]
2026-02-20T22:09:15.9815631Z -        
2026-02-20T22:09:15.9816023Z +        messages = [{"role": "system", "content": system_prompt}]
2026-02-20T22:09:15.9816553Z +
2026-02-20T22:09:15.9817164Z          # Ajouter l'historique de conversation (limité aux 5 derniers messages)
2026-02-20T22:09:15.9817849Z          for msg in conversation_history[-5:]:
2026-02-20T22:09:15.9818319Z -            messages.append({
2026-02-20T22:09:15.9818743Z -                "role": msg.get("role", "user"),
2026-02-20T22:09:15.9819235Z -                "content": msg.get("content", "")
2026-02-20T22:09:15.9819668Z -            })
2026-02-20T22:09:15.9819958Z -        
2026-02-20T22:09:15.9820242Z +            messages.append(
2026-02-20T22:09:15.9820776Z +                {"role": msg.get("role", "user"), "content": msg.get("content", "")}
2026-02-20T22:09:15.9821592Z +            )
2026-02-20T22:09:15.9821874Z +
2026-02-20T22:09:15.9822162Z          # Ajouter le message actuel
2026-02-20T22:09:15.9822578Z -        messages.append({
2026-02-20T22:09:15.9822946Z -            "role": "user",
2026-02-20T22:09:15.9823472Z -            "content": message
2026-02-20T22:09:15.9824017Z -        })
2026-02-20T22:09:15.9824294Z -        
2026-02-20T22:09:15.9824680Z +        messages.append({"role": "user", "content": message})
2026-02-20T22:09:15.9825174Z +
2026-02-20T22:09:15.9825747Z          # Appeler OpenAI avec paramètres optimisés selon la complexité
2026-02-20T22:09:15.9826642Z          # Best practice : Paramètres adaptés selon le modèle et la complexité
2026-02-20T22:09:15.9827626Z          # Augmenté max_tokens pour permettre des exercices complets et résolvables
2026-02-20T22:09:15.9828768Z -        temperature = 0.4 if complexity == 'simple' else 0.6  # Plus prévisible pour questions simples
2026-02-20T22:09:15.9829958Z -        max_tokens = 500 if complexity == 'complex' else 400  # Augmenté pour exercices complets
2026-02-20T22:09:15.9830675Z -        
2026-02-20T22:09:15.9830964Z +        temperature = (
2026-02-20T22:09:15.9831365Z +            0.4 if complexity == "simple" else 0.6
2026-02-20T22:09:15.9831970Z +        )  # Plus prévisible pour questions simples
2026-02-20T22:09:15.9832458Z +        max_tokens = (
2026-02-20T22:09:15.9832843Z +            500 if complexity == "complex" else 400
2026-02-20T22:09:15.9863776Z +        )  # Augmenté pour exercices complets
2026-02-20T22:09:15.9864243Z +
2026-02-20T22:09:15.9864612Z          response = await client.chat.completions.create(
2026-02-20T22:09:15.9865415Z              model=model,  # Smart routing : modèle choisi selon complexité
2026-02-20T22:09:15.9866004Z              messages=messages,
2026-02-20T22:09:15.9866414Z              temperature=temperature,
2026-02-20T22:09:15.9866836Z              max_tokens=max_tokens,
2026-02-20T22:09:15.9867234Z              top_p=0.9,
2026-02-20T22:09:15.9867597Z              frequency_penalty=0.3,
2026-02-20T22:09:15.9868005Z              presence_penalty=0.1,
2026-02-20T22:09:15.9868388Z          )
2026-02-20T22:09:15.9868649Z -        
2026-02-20T22:09:15.9868910Z +
2026-02-20T22:09:15.9869250Z          # Extraire la réponse
2026-02-20T22:09:15.9869763Z          assistant_message = response.choices[0].message.content
2026-02-20T22:09:15.9870283Z -        
2026-02-20T22:09:15.9870546Z +
2026-02-20T22:09:15.9871259Z          # Nettoyer les placeholders d'images Markdown (best practice : éviter les placeholders)
2026-02-20T22:09:15.9872197Z          # Supprimer les patterns comme ![texte](url) ou ![texte](placeholder)
2026-02-20T22:09:15.9872807Z          import re
2026-02-20T22:09:15.9873274Z  
2026-02-20T22:09:15.9873718Z          # Supprimer les images Markdown avec placeholders ou URLs suspectes
2026-02-20T22:09:15.9874334Z          assistant_message = re.sub(
2026-02-20T22:09:15.9874984Z -            r'!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)',
2026-02-20T22:09:15.9875756Z -            r'\1',  # Remplacer par juste le texte alternatif
2026-02-20T22:09:15.9876494Z +            r"!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)",
2026-02-20T22:09:15.9877249Z +            r"\1",  # Remplacer par juste le texte alternatif
2026-02-20T22:09:15.9877745Z              assistant_message,
2026-02-20T22:09:15.9878139Z -            flags=re.IGNORECASE
2026-02-20T22:09:15.9878526Z +            flags=re.IGNORECASE,
2026-02-20T22:09:15.9878892Z          )
2026-02-20T22:09:15.9879463Z          # Supprimer aussi les images Markdown génériques sans URL valide
2026-02-20T22:09:15.9880074Z          assistant_message = re.sub(
2026-02-20T22:09:15.9880477Z -            r'!\[([^\]]*)\]\([^)]*\)',
2026-02-20T22:09:15.9881073Z -            lambda m: m.group(1) if 'http' not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:15.9881704Z -            assistant_message
2026-02-20T22:09:15.9882047Z -        )
2026-02-20T22:09:15.9882539Z -        
2026-02-20T22:09:15.9882816Z +            r"!\[([^\]]*)\]\([^)]*\)",
2026-02-20T22:09:15.9883569Z +            lambda m: m.group(1) if "http" not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:15.9884190Z +            assistant_message,
2026-02-20T22:09:15.9884731Z +        )
2026-02-20T22:09:15.9884995Z +
2026-02-20T22:09:15.9885521Z          # Retourner la réponse avec l'image si elle a été générée
2026-02-20T22:09:15.9886066Z          response_data = {
2026-02-20T22:09:15.9886443Z              "response": assistant_message,
2026-02-20T22:09:15.9887233Z              "model_used": model,  # Debug : indiquer quel modèle a été utilisé
2026-02-20T22:09:15.9888130Z -            "complexity": complexity  # Debug : indiquer la complexité détectée
2026-02-20T22:09:15.9888964Z +            "complexity": complexity,  # Debug : indiquer la complexité détectée
2026-02-20T22:09:15.9889454Z          }
2026-02-20T22:09:15.9889675Z -        
2026-02-20T22:09:15.9889917Z +
2026-02-20T22:09:15.9890310Z          # Ajouter l'URL de l'image si elle a été générée
2026-02-20T22:09:15.9890772Z          if image_url:
2026-02-20T22:09:15.9891132Z              response_data["image_url"] = image_url
2026-02-20T22:09:15.9891596Z              response_data["type"] = "image"
2026-02-20T22:09:15.9891995Z -        
2026-02-20T22:09:15.9892236Z +
2026-02-20T22:09:15.9892501Z          return JSONResponse(response_data)
2026-02-20T22:09:15.9892894Z -        
2026-02-20T22:09:15.9923434Z +
2026-02-20T22:09:15.9923756Z      except Exception as chat_api_error:
2026-02-20T22:09:15.9924331Z          logger.error(f"Erreur dans chat_api: {str(chat_api_error)}")
2026-02-20T22:09:15.9924874Z          import traceback
2026-02-20T22:09:15.9925192Z +
2026-02-20T22:09:15.9925447Z          traceback.print_exc()
2026-02-20T22:09:15.9925822Z          return JSONResponse(
2026-02-20T22:09:15.9926256Z -            {"error": get_safe_error_message(chat_api_error)},
2026-02-20T22:09:15.9926748Z -            status_code=500
2026-02-20T22:09:15.9927253Z +            {"error": get_safe_error_message(chat_api_error)}, status_code=500
2026-02-20T22:09:15.9927780Z          )
2026-02-20T22:09:15.9928006Z  
2026-02-20T22:09:15.9928213Z  
2026-02-20T22:09:15.9928437Z  @rate_limit_chat
2026-02-20T22:09:15.9928734Z  async def chat_api_stream(request):
2026-02-20T22:09:15.9929087Z      """
2026-02-20T22:09:15.9929399Z      Endpoint API pour le chatbot avec streaming SSE.
2026-02-20T22:09:15.9929789Z -    
2026-02-20T22:09:15.9930009Z +
2026-02-20T22:09:15.9930573Z      Best practice : Streaming pour meilleure UX - l'utilisateur voit la réponse
2026-02-20T22:09:15.9931427Z      apparaître progressivement au lieu d'attendre la réponse complète.
2026-02-20T22:09:15.9931948Z -    
2026-02-20T22:09:15.9932170Z +
2026-02-20T22:09:15.9932641Z      Réduit la perception du temps d'attente et améliore l'engagement.
2026-02-20T22:09:15.9933288Z      """
2026-02-20T22:09:15.9933510Z      try:
2026-02-20T22:09:15.9933863Z          # Vérifier que OpenAI est disponible
2026-02-20T22:09:15.9934271Z          if not OPENAI_AVAILABLE:
2026-02-20T22:09:15.9934594Z +
2026-02-20T22:09:15.9934849Z              async def error_generator():
2026-02-20T22:09:15.9935453Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'OpenAI non disponible'})}\n\n"
2026-02-20T22:09:15.9936058Z -            
2026-02-20T22:09:15.9936295Z +
2026-02-20T22:09:15.9936548Z              return StreamingResponse(
2026-02-20T22:09:15.9936916Z                  error_generator(),
2026-02-20T22:09:15.9937296Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9937678Z                  headers={
2026-02-20T22:09:15.9938002Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9938408Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9938767Z -                }
2026-02-20T22:09:15.9939021Z -            )
2026-02-20T22:09:15.9939255Z -        
2026-02-20T22:09:15.9939480Z +                },
2026-02-20T22:09:15.9939950Z +            )
2026-02-20T22:09:15.9940184Z +
2026-02-20T22:09:15.9940530Z          # Vérifier que la clé API est configurée
2026-02-20T22:09:15.9940945Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:15.9941302Z +
2026-02-20T22:09:15.9941536Z              async def error_generator():
2026-02-20T22:09:15.9942470Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Clé API OpenAI non configurée'})}\n\n"
2026-02-20T22:09:15.9943236Z -            
2026-02-20T22:09:15.9943469Z +
2026-02-20T22:09:15.9943708Z              return StreamingResponse(
2026-02-20T22:09:15.9944067Z                  error_generator(),
2026-02-20T22:09:15.9944425Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9944805Z                  headers={
2026-02-20T22:09:15.9945127Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9945524Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9945876Z -                }
2026-02-20T22:09:15.9946114Z -            )
2026-02-20T22:09:15.9946363Z -        
2026-02-20T22:09:15.9946578Z +                },
2026-02-20T22:09:15.9946824Z +            )
2026-02-20T22:09:15.9947044Z +
2026-02-20T22:09:15.9947376Z          # Récupérer les données de la requête
2026-02-20T22:09:15.9947750Z          data = await request.json()
2026-02-20T22:09:15.9948128Z -        message_raw = data.get('message', '')
2026-02-20T22:09:15.9948767Z -        conversation_history = data.get('conversation_history', [])[:20]  # Limiter l'historique
2026-02-20T22:09:15.9949628Z -        use_streaming = data.get('stream', True)  # Streaming par défaut
2026-02-20T22:09:15.9950103Z -        
2026-02-20T22:09:15.9950359Z +        message_raw = data.get("message", "")
2026-02-20T22:09:15.9950848Z +        conversation_history = data.get("conversation_history", [])[
2026-02-20T22:09:15.9951300Z +            :20
2026-02-20T22:09:15.9951558Z +        ]  # Limiter l'historique
2026-02-20T22:09:15.9952103Z +        use_streaming = data.get("stream", True)  # Streaming par défaut
2026-02-20T22:09:15.9952577Z +
2026-02-20T22:09:15.9952795Z          if not message_raw:
2026-02-20T22:09:15.9983389Z +
2026-02-20T22:09:15.9983720Z              async def error_generator():
2026-02-20T22:09:15.9984410Z                  yield f"data: {json.dumps({'type': 'error', 'message': 'Message requis'})}\n\n"
2026-02-20T22:09:15.9985062Z -            
2026-02-20T22:09:15.9985333Z +
2026-02-20T22:09:15.9985623Z              return StreamingResponse(
2026-02-20T22:09:15.9986048Z                  error_generator(),
2026-02-20T22:09:15.9986480Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9986915Z                  headers={
2026-02-20T22:09:15.9987297Z                      "Cache-Control": "no-cache",
2026-02-20T22:09:15.9987772Z                      "Connection": "keep-alive",
2026-02-20T22:09:15.9988188Z -                }
2026-02-20T22:09:15.9988482Z +                },
2026-02-20T22:09:15.9988765Z              )
2026-02-20T22:09:15.9989039Z  
2026-02-20T22:09:15.9989611Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:15.9990487Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:15.9991279Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:15.9991772Z +            sanitize_user_prompt,
2026-02-20T22:09:15.9992182Z +            validate_prompt_safety,
2026-02-20T22:09:15.9992565Z +        )
2026-02-20T22:09:15.9992826Z +
2026-02-20T22:09:15.9993389Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:15.9993947Z          if not is_safe:
2026-02-20T22:09:15.9994263Z +
2026-02-20T22:09:15.9994544Z              async def error_generator():
2026-02-20T22:09:15.9995314Z                  yield f"data: {json.dumps({'type': 'error', 'message': f'Message invalide: {safety_reason}'})}\n\n"
2026-02-20T22:09:15.9996062Z +
2026-02-20T22:09:15.9996346Z              return StreamingResponse(
2026-02-20T22:09:15.9996771Z                  error_generator(),
2026-02-20T22:09:15.9997499Z                  media_type="text/event-stream",
2026-02-20T22:09:15.9998124Z                  headers={"Cache-Control": "no-cache", "Connection": "keep-alive"},
2026-02-20T22:09:15.9998712Z              )
2026-02-20T22:09:15.9999305Z          message = sanitize_user_prompt(message_raw, max_length=2000)
2026-02-20T22:09:15.9999855Z  
2026-02-20T22:09:16.0000212Z          # Créer le client OpenAI
2026-02-20T22:09:16.0000722Z          client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:16.0001232Z -        
2026-02-20T22:09:16.0001488Z +
2026-02-20T22:09:16.0001973Z          # Détecter si la demande concerne une image mathématique
2026-02-20T22:09:16.0003613Z -        image_keywords = ['image', 'dessine', 'dessin', 'schéma', 'diagramme', 'figure', 'graphique', 'visualise', 'montre', 'créer', 'génère', 'fais', 'montre-moi', 'affiche']
2026-02-20T22:09:16.0006129Z -        math_image_keywords = ['géométrie', 'triangle', 'cercle', 'carré', 'rectangle', 'forme', 'angle', 'fraction', 'graphique', 'courbe', 'polygone', 'losange', 'trapèze', 'cercle', 'ovale', 'ligne', 'point', 'segment', 'exercice', 'problème']
2026-02-20T22:09:16.0007651Z -        
2026-02-20T22:09:16.0007933Z +        image_keywords = [
2026-02-20T22:09:16.0008282Z +            "image",
2026-02-20T22:09:16.0008601Z +            "dessine",
2026-02-20T22:09:16.0008924Z +            "dessin",
2026-02-20T22:09:16.0009280Z +            "schéma",
2026-02-20T22:09:16.0009600Z +            "diagramme",
2026-02-20T22:09:16.0009926Z +            "figure",
2026-02-20T22:09:16.0010239Z +            "graphique",
2026-02-20T22:09:16.0010567Z +            "visualise",
2026-02-20T22:09:16.0010890Z +            "montre",
2026-02-20T22:09:16.0011248Z +            "créer",
2026-02-20T22:09:16.0011604Z +            "génère",
2026-02-20T22:09:16.0011907Z +            "fais",
2026-02-20T22:09:16.0012211Z +            "montre-moi",
2026-02-20T22:09:16.0012549Z +            "affiche",
2026-02-20T22:09:16.0012863Z +        ]
2026-02-20T22:09:16.0043439Z +        math_image_keywords = [
2026-02-20T22:09:16.0043957Z +            "géométrie",
2026-02-20T22:09:16.0044313Z +            "triangle",
2026-02-20T22:09:16.0044637Z +            "cercle",
2026-02-20T22:09:16.0045003Z +            "carré",
2026-02-20T22:09:16.0045326Z +            "rectangle",
2026-02-20T22:09:16.0045659Z +            "forme",
2026-02-20T22:09:16.0045959Z +            "angle",
2026-02-20T22:09:16.0046258Z +            "fraction",
2026-02-20T22:09:16.0046591Z +            "graphique",
2026-02-20T22:09:16.0046914Z +            "courbe",
2026-02-20T22:09:16.0047232Z +            "polygone",
2026-02-20T22:09:16.0047551Z +            "losange",
2026-02-20T22:09:16.0047930Z +            "trapèze",
2026-02-20T22:09:16.0048232Z +            "cercle",
2026-02-20T22:09:16.0048539Z +            "ovale",
2026-02-20T22:09:16.0048827Z +            "ligne",
2026-02-20T22:09:16.0049124Z +            "point",
2026-02-20T22:09:16.0049422Z +            "segment",
2026-02-20T22:09:16.0049750Z +            "exercice",
2026-02-20T22:09:16.0050139Z +            "problème",
2026-02-20T22:09:16.0050448Z +        ]
2026-02-20T22:09:16.0050708Z +
2026-02-20T22:09:16.0051221Z          is_image_request = any(keyword in message.lower() for keyword in image_keywords)
2026-02-20T22:09:16.0052216Z -        is_math_related = any(keyword in message.lower() for keyword in math_image_keywords) or any(
2026-02-20T22:09:16.0053787Z -            keyword in message.lower() for keyword in ['math', 'mathématique', 'calcul', 'nombre', 'équation', 'exercice', 'problème']
2026-02-20T22:09:16.0054683Z -        )
2026-02-20T22:09:16.0054950Z -        
2026-02-20T22:09:16.0055231Z +        is_math_related = any(
2026-02-20T22:09:16.0055764Z +            keyword in message.lower() for keyword in math_image_keywords
2026-02-20T22:09:16.0056319Z +        ) or any(
2026-02-20T22:09:16.0056639Z +            keyword in message.lower()
2026-02-20T22:09:16.0057048Z +            for keyword in [
2026-02-20T22:09:16.0057646Z +                "math",
2026-02-20T22:09:16.0058059Z +                "mathématique",
2026-02-20T22:09:16.0058422Z +                "calcul",
2026-02-20T22:09:16.0058759Z +                "nombre",
2026-02-20T22:09:16.0059149Z +                "équation",
2026-02-20T22:09:16.0059747Z +                "exercice",
2026-02-20T22:09:16.0060185Z +                "problème",
2026-02-20T22:09:16.0060521Z +            ]
2026-02-20T22:09:16.0060784Z +        )
2026-02-20T22:09:16.0061034Z +
2026-02-20T22:09:16.0061580Z          # Si demande d'image ET mathématique, générer une image avec DALL-E
2026-02-20T22:09:16.0062556Z          # MAIS continuer avec la réponse texte complète pour avoir l'exercice résolvable
2026-02-20T22:09:16.0063399Z          image_url = None
2026-02-20T22:09:16.0063798Z          if is_image_request and is_math_related:
2026-02-20T22:09:16.0064237Z              try:
2026-02-20T22:09:16.0065010Z                  dalle_prompt = f"""Image éducative mathématique pour enfants de 5 à 20 ans : {message}. 
2026-02-20T22:09:16.0066197Z  Style simple, clair, coloré, adapté aux enfants. Éléments visuels mathématiques uniquement. 
2026-02-20T22:09:16.0067308Z  Pas de texte complexe, formes géométriques simples, couleurs vives et contrastées."""
2026-02-20T22:09:16.0067989Z -                
2026-02-20T22:09:16.0068281Z +
2026-02-20T22:09:16.0068648Z                  image_response = await client.images.generate(
2026-02-20T22:09:16.0069170Z                      model="dall-e-3",
2026-02-20T22:09:16.0069598Z                      prompt=dalle_prompt,
2026-02-20T22:09:16.0070024Z                      size="1024x1024",
2026-02-20T22:09:16.0070425Z                      quality="standard",
2026-02-20T22:09:16.0070828Z                      n=1,
2026-02-20T22:09:16.0071139Z                  )
2026-02-20T22:09:16.0071423Z -                
2026-02-20T22:09:16.0071699Z +
2026-02-20T22:09:16.0072022Z                  image_url = image_response.data[0].url
2026-02-20T22:09:16.0072871Z                  # Ne pas retourner immédiatement - continuer pour générer l'exercice complet
2026-02-20T22:09:16.0104247Z                  # L'image sera envoyée dans le stream avec la réponse texte complète
2026-02-20T22:09:16.0104956Z              except Exception as dalle_stream_error:
2026-02-20T22:09:16.0105815Z -                logger.error(f"Erreur génération image DALL-E: {str(dalle_stream_error)}")
2026-02-20T22:09:16.0106506Z +                logger.error(
2026-02-20T22:09:16.0107146Z +                    f"Erreur génération image DALL-E: {str(dalle_stream_error)}"
2026-02-20T22:09:16.0107713Z +                )
2026-02-20T22:09:16.0108097Z                  # Continuer avec le traitement texte normal
2026-02-20T22:09:16.0108585Z                  image_url = None
2026-02-20T22:09:16.0108953Z -        
2026-02-20T22:09:16.0109206Z +
2026-02-20T22:09:16.0109635Z          # Détecter la complexité pour smart routing
2026-02-20T22:09:16.0110268Z          complexity = _detect_complexity(message, conversation_history)
2026-02-20T22:09:16.0111008Z -        model = "gpt-4o-mini" if complexity == 'simple' else "gpt-4o"
2026-02-20T22:09:16.0111544Z -        
2026-02-20T22:09:16.0111950Z +        model = "gpt-4o-mini" if complexity == "simple" else "gpt-4o"
2026-02-20T22:09:16.0112475Z +
2026-02-20T22:09:16.0112882Z          # Détecter l'âge pour personnalisation
2026-02-20T22:09:16.0113551Z          estimated_age = _estimate_age(message)
2026-02-20T22:09:16.0113979Z -        
2026-02-20T22:09:16.0114240Z +
2026-02-20T22:09:16.0114642Z          # Construire le prompt système optimisé
2026-02-20T22:09:16.0115199Z          system_prompt = _build_system_prompt(estimated_age)
2026-02-20T22:09:16.0115679Z -        
2026-02-20T22:09:16.0115939Z +
2026-02-20T22:09:16.0116239Z          # Construire les messages pour OpenAI
2026-02-20T22:09:16.0116683Z -        messages = [
2026-02-20T22:09:16.0117077Z -            {"role": "system", "content": system_prompt}
2026-02-20T22:09:16.0117531Z -        ]
2026-02-20T22:09:16.0118038Z -        
2026-02-20T22:09:16.0118432Z +        messages = [{"role": "system", "content": system_prompt}]
2026-02-20T22:09:16.0118955Z +
2026-02-20T22:09:16.0119555Z          # Ajouter l'historique de conversation (limité aux 5 derniers messages)
2026-02-20T22:09:16.0120746Z          # Best practice : Limiter l'historique pour éviter dépassement de contexte
2026-02-20T22:09:16.0121441Z          for msg in conversation_history[-5:]:
2026-02-20T22:09:16.0121905Z -            messages.append({
2026-02-20T22:09:16.0122317Z -                "role": msg.get("role", "user"),
2026-02-20T22:09:16.0122789Z -                "content": msg.get("content", "")
2026-02-20T22:09:16.0123387Z -            })
2026-02-20T22:09:16.0123662Z -        
2026-02-20T22:09:16.0123948Z +            messages.append(
2026-02-20T22:09:16.0124472Z +                {"role": msg.get("role", "user"), "content": msg.get("content", "")}
2026-02-20T22:09:16.0125043Z +            )
2026-02-20T22:09:16.0125312Z +
2026-02-20T22:09:16.0125593Z          # Ajouter le message actuel
2026-02-20T22:09:16.0126015Z -        messages.append({
2026-02-20T22:09:16.0126360Z -            "role": "user",
2026-02-20T22:09:16.0126719Z -            "content": message
2026-02-20T22:09:16.0127065Z -        })
2026-02-20T22:09:16.0127326Z -        
2026-02-20T22:09:16.0127716Z +        messages.append({"role": "user", "content": message})
2026-02-20T22:09:16.0128222Z +
2026-02-20T22:09:16.0128648Z          # Paramètres optimisés selon la complexité
2026-02-20T22:09:16.0129471Z          # Augmenté max_tokens pour permettre des exercices complets et résolvables
2026-02-20T22:09:16.0130227Z -        temperature = 0.4 if complexity == 'simple' else 0.6
2026-02-20T22:09:16.0131179Z -        max_tokens = 500 if complexity == 'complex' else 400  # Augmenté pour exercices complets
2026-02-20T22:09:16.0131881Z -        
2026-02-20T22:09:16.0132243Z +        temperature = 0.4 if complexity == "simple" else 0.6
2026-02-20T22:09:16.0132748Z +        max_tokens = (
2026-02-20T22:09:16.0163424Z +            500 if complexity == "complex" else 400
2026-02-20T22:09:16.0164098Z +        )  # Augmenté pour exercices complets
2026-02-20T22:09:16.0164531Z +
2026-02-20T22:09:16.0164822Z          async def generate_stream():
2026-02-20T22:09:16.0165213Z              try:
2026-02-20T22:09:16.0165750Z                  # Si une image a été générée, l'envoyer en premier
2026-02-20T22:09:16.0166274Z                  if image_url:
2026-02-20T22:09:16.0166830Z                      yield f"data: {json.dumps({'type': 'image', 'url': image_url})}\n\n"
2026-02-20T22:09:16.0167433Z -                
2026-02-20T22:09:16.0167715Z +
2026-02-20T22:09:16.0168117Z                  # Envoyer un message de démarrage
2026-02-20T22:09:16.0168988Z                  yield f"data: {json.dumps({'type': 'status', 'message': 'Réflexion en cours...'})}\n\n"
2026-02-20T22:09:16.0169681Z -                
2026-02-20T22:09:16.0169964Z +
2026-02-20T22:09:16.0170325Z                  # Créer le stream OpenAI
2026-02-20T22:09:16.0170879Z                  stream = await client.chat.completions.create(
2026-02-20T22:09:16.0171390Z                      model=model,
2026-02-20T22:09:16.0171791Z                      messages=messages,
2026-02-20T22:09:16.0172250Z                      stream=True,  # Activer le streaming
2026-02-20T22:09:16.0172723Z @@ -469,70 +597,75 @@
2026-02-20T22:09:16.0173213Z                      max_tokens=max_tokens,
2026-02-20T22:09:16.0173644Z                      top_p=0.9,
2026-02-20T22:09:16.0174033Z                      frequency_penalty=0.3,
2026-02-20T22:09:16.0174473Z                      presence_penalty=0.1,
2026-02-20T22:09:16.0174881Z                  )
2026-02-20T22:09:16.0175164Z -                
2026-02-20T22:09:16.0175446Z +
2026-02-20T22:09:16.0175857Z                  # Stream chaque chunk de la réponse
2026-02-20T22:09:16.0176335Z                  full_response = ""
2026-02-20T22:09:16.0176743Z                  async for chunk in stream:
2026-02-20T22:09:16.0177421Z                      if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:16.0178281Z                          content = chunk.choices[0].delta.content
2026-02-20T22:09:16.0178814Z                          full_response += content
2026-02-20T22:09:16.0179579Z                          # Envoyer chaque chunk au client pour affichage progressif
2026-02-20T22:09:16.0180398Z                          yield f"data: {json.dumps({'type': 'chunk', 'content': content})}\n\n"
2026-02-20T22:09:16.0181028Z -                
2026-02-20T22:09:16.0181302Z +
2026-02-20T22:09:16.0181937Z                  # Nettoyer les placeholders d'images Markdown dans la réponse complète
2026-02-20T22:09:16.0182580Z                  import re
2026-02-20T22:09:16.0182912Z +
2026-02-20T22:09:16.0183358Z                  cleaned_response = re.sub(
2026-02-20T22:09:16.0184043Z -                    r'!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)',
2026-02-20T22:09:16.0184733Z -                    r'\1',
2026-02-20T22:09:16.0185337Z +                    r"!\[([^\]]*)\]\([^)]*(?:placeholder|via\.placeholder|example\.com|example\.org)[^)]*\)",
2026-02-20T22:09:16.0186014Z +                    r"\1",
2026-02-20T22:09:16.0186360Z                      full_response,
2026-02-20T22:09:16.0186764Z -                    flags=re.IGNORECASE
2026-02-20T22:09:16.0187211Z +                    flags=re.IGNORECASE,
2026-02-20T22:09:16.0187608Z                  )
2026-02-20T22:09:16.0187939Z                  cleaned_response = re.sub(
2026-02-20T22:09:16.0188366Z -                    r'!\[([^\]]*)\]\([^)]*\)',
2026-02-20T22:09:16.0189006Z -                    lambda m: m.group(1) if 'http' not in m.group(0).lower() else m.group(0),
2026-02-20T22:09:16.0189651Z -                    cleaned_response
2026-02-20T22:09:16.0190039Z -                )
2026-02-20T22:09:16.0190320Z -                
2026-02-20T22:09:16.0190637Z +                    r"!\[([^\]]*)\]\([^)]*\)",
2026-02-20T22:09:16.0191057Z +                    lambda m: (
2026-02-20T22:09:16.0191588Z +                        m.group(1) if "http" not in m.group(0).lower() else m.group(0)
2026-02-20T22:09:16.0192161Z +                    ),
2026-02-20T22:09:16.0192493Z +                    cleaned_response,
2026-02-20T22:09:16.0192888Z +                )
2026-02-20T22:09:16.0213450Z +
2026-02-20T22:09:16.0214199Z                  # Si la réponse a été nettoyée, envoyer un chunk de correction si nécessaire
2026-02-20T22:09:16.0214948Z                  if cleaned_response != full_response:
2026-02-20T22:09:16.0215856Z                      # La réponse a déjà été envoyée chunk par chunk, donc on ne peut pas la modifier
2026-02-20T22:09:16.0216698Z                      # Mais on peut envoyer un message de fin avec indication
2026-02-20T22:09:16.0217260Z                      pass
2026-02-20T22:09:16.0217594Z -                
2026-02-20T22:09:16.0217885Z +
2026-02-20T22:09:16.0218363Z                  # Envoyer un message de fin avec métadonnées
2026-02-20T22:09:16.0219192Z                  yield f"data: {json.dumps({'type': 'done', 'model_used': model, 'complexity': complexity})}\n\n"
2026-02-20T22:09:16.0219973Z -                
2026-02-20T22:09:16.0220263Z +
2026-02-20T22:09:16.0220603Z              except Exception as stream_generation_error:
2026-02-20T22:09:16.0221367Z -                logger.error(f"Erreur dans generate_stream: {str(stream_generation_error)}")
2026-02-20T22:09:16.0222078Z +                logger.error(
2026-02-20T22:09:16.0222634Z +                    f"Erreur dans generate_stream: {str(stream_generation_error)}"
2026-02-20T22:09:16.0223374Z +                )
2026-02-20T22:09:16.0224113Z                  yield f"data: {json.dumps({'type': 'error', 'message': get_safe_error_message(stream_generation_error)})}\n\n"
2026-02-20T22:09:16.0224969Z -        
2026-02-20T22:09:16.0225238Z +
2026-02-20T22:09:16.0225526Z          return StreamingResponse(
2026-02-20T22:09:16.0225932Z              generate_stream(),
2026-02-20T22:09:16.0226349Z              media_type="text/event-stream",
2026-02-20T22:09:16.0227101Z              headers={
2026-02-20T22:09:16.0227468Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:16.0227933Z                  "Connection": "keep-alive",
2026-02-20T22:09:16.0228469Z                  "X-Accel-Buffering": "no",  # Important pour Nginx
2026-02-20T22:09:16.0229160Z -            }
2026-02-20T22:09:16.0229465Z -        )
2026-02-20T22:09:16.0229730Z -        
2026-02-20T22:09:16.0229991Z +            },
2026-02-20T22:09:16.0230276Z +        )
2026-02-20T22:09:16.0230528Z +
2026-02-20T22:09:16.0230833Z      except Exception as chat_stream_error:
2026-02-20T22:09:16.0231468Z          logger.error(f"Erreur dans chat_api_stream: {str(chat_stream_error)}")
2026-02-20T22:09:16.0232108Z          import traceback
2026-02-20T22:09:16.0232431Z +
2026-02-20T22:09:16.0232716Z          traceback.print_exc()
2026-02-20T22:09:16.0233410Z          err = chat_stream_error  # capture for closure (Flake8 F821)
2026-02-20T22:09:16.0233944Z  
2026-02-20T22:09:16.0234249Z          async def error_generator(exc=err):
2026-02-20T22:09:16.0234967Z              yield f"data: {json.dumps({'type': 'error', 'message': get_safe_error_message(exc)})}\n\n"
2026-02-20T22:09:16.0235698Z -        
2026-02-20T22:09:16.0235971Z +
2026-02-20T22:09:16.0236270Z          return StreamingResponse(
2026-02-20T22:09:16.0236701Z              error_generator(),
2026-02-20T22:09:16.0237116Z              media_type="text/event-stream",
2026-02-20T22:09:16.0237541Z              headers={
2026-02-20T22:09:16.0237910Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:16.0238374Z                  "Connection": "keep-alive",
2026-02-20T22:09:16.0238781Z -            }
2026-02-20T22:09:16.0239064Z -        )
2026-02-20T22:09:16.0239319Z -
2026-02-20T22:09:16.0239561Z +            },
2026-02-20T22:09:16.0239829Z +        )
2026-02-20T22:09:16.0240410Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py
2026-02-20T22:09:16.1774445Z --- /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:16.1776418Z +++ /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py	2026-02-20 22:09:16.164187+00:00
2026-02-20T22:09:16.1777724Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.1778190Z  """
2026-02-20T22:09:16.1778871Z  Handlers pour les défis logiques (API Starlette)
2026-02-20T22:09:16.1779342Z  """
2026-02-20T22:09:16.1779596Z +
2026-02-20T22:09:16.1779846Z  import json
2026-02-20T22:09:16.1780155Z  import traceback
2026-02-20T22:09:16.1780498Z  from datetime import datetime
2026-02-20T22:09:16.1780877Z  
2026-02-20T22:09:16.1781222Z  from app.core.logging_config import get_logger
2026-02-20T22:09:16.1781684Z @@ -11,14 +12,21 @@
2026-02-20T22:09:16.1782032Z  from starlette.requests import Request
2026-02-20T22:09:16.1782625Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:16.1783382Z  
2026-02-20T22:09:16.1783824Z  from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:16.1784467Z  from app.core.config import settings
2026-02-20T22:09:16.1784852Z +
2026-02-20T22:09:16.1785322Z  # Importer les constantes et fonctions centralisées
2026-02-20T22:09:16.1786395Z -from app.core.constants import (CHALLENGE_TYPES_API, CHALLENGE_TYPES_DB, normalize_age_group, calculate_difficulty_for_age_group)
2026-02-20T22:09:16.1787405Z +from app.core.constants import (
2026-02-20T22:09:16.1787823Z +    CHALLENGE_TYPES_API,
2026-02-20T22:09:16.1788176Z +    CHALLENGE_TYPES_DB,
2026-02-20T22:09:16.1788524Z +    normalize_age_group,
2026-02-20T22:09:16.1788892Z +    calculate_difficulty_for_age_group,
2026-02-20T22:09:16.1789300Z +)
2026-02-20T22:09:16.1789592Z  import app.core.constants as constants
2026-02-20T22:09:16.1790095Z  from app.core.messages import SystemMessages
2026-02-20T22:09:16.1790541Z +
2026-02-20T22:09:16.1791340Z  # NOTE: challenge_service_translations_adapter archivé - utiliser fonctions de challenge_service.py
2026-02-20T22:09:16.1824376Z  from app.services import challenge_service
2026-02-20T22:09:16.1824878Z  from app.utils.db_utils import db_session
2026-02-20T22:09:16.1825527Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:16.1826344Z  from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:16.1827157Z @@ -32,52 +40,70 @@
2026-02-20T22:09:16.1827747Z      Liste des défis logiques avec filtres optionnels.
2026-02-20T22:09:16.1828270Z      Route: GET /api/challenges
2026-02-20T22:09:16.1828644Z      """
2026-02-20T22:09:16.1829497Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py
2026-02-20T22:09:16.1830243Z      try:
2026-02-20T22:09:16.1830550Z          current_user = request.state.user
2026-02-20T22:09:16.1830967Z -        
2026-02-20T22:09:16.1831223Z +
2026-02-20T22:09:16.1831639Z          # Récupérer les paramètres de requête
2026-02-20T22:09:16.1832261Z -        challenge_type_raw = request.query_params.get('challenge_type')
2026-02-20T22:09:16.1833147Z -        age_group_raw = request.query_params.get('age_group')
2026-02-20T22:09:16.1834066Z -        search = request.query_params.get('search') or request.query_params.get('q')  # Support 'search' et 'q'
2026-02-20T22:09:16.1834965Z -        skip = int(request.query_params.get('skip', 0))
2026-02-20T22:09:16.1835549Z -        limit_param = request.query_params.get('limit')
2026-02-20T22:09:16.1836189Z +        challenge_type_raw = request.query_params.get("challenge_type")
2026-02-20T22:09:16.1836877Z +        age_group_raw = request.query_params.get("age_group")
2026-02-20T22:09:16.1837599Z +        search = request.query_params.get("search") or request.query_params.get(
2026-02-20T22:09:16.1838210Z +            "q"
2026-02-20T22:09:16.1838534Z +        )  # Support 'search' et 'q'
2026-02-20T22:09:16.1839003Z +        skip = int(request.query_params.get("skip", 0))
2026-02-20T22:09:16.1839563Z +        limit_param = request.query_params.get("limit")
2026-02-20T22:09:16.1840111Z          limit = int(limit_param) if limit_param else 20
2026-02-20T22:09:16.1840817Z -        active_only = request.query_params.get('active_only', 'true').lower() == 'true'
2026-02-20T22:09:16.1841628Z -        order = (request.query_params.get('order') or 'random').lower()
2026-02-20T22:09:16.1842479Z -        hide_completed = request.query_params.get('hide_completed', 'false').lower() == 'true'
2026-02-20T22:09:16.1843353Z -        
2026-02-20T22:09:16.1843853Z +        active_only = request.query_params.get("active_only", "true").lower() == "true"
2026-02-20T22:09:16.1844649Z +        order = (request.query_params.get("order") or "random").lower()
2026-02-20T22:09:16.1845205Z +        hide_completed = (
2026-02-20T22:09:16.1845771Z +            request.query_params.get("hide_completed", "false").lower() == "true"
2026-02-20T22:09:16.1846376Z +        )
2026-02-20T22:09:16.1846627Z +
2026-02-20T22:09:16.1847065Z          # Normaliser les filtres pour correspondre aux valeurs PostgreSQL
2026-02-20T22:09:16.1848075Z -        challenge_type = constants.normalize_challenge_type(challenge_type_raw) if challenge_type_raw else None
2026-02-20T22:09:16.1848936Z +        challenge_type = (
2026-02-20T22:09:16.1849429Z +            constants.normalize_challenge_type(challenge_type_raw)
2026-02-20T22:09:16.1850058Z +            if challenge_type_raw
2026-02-20T22:09:16.1850442Z +            else None
2026-02-20T22:09:16.1850768Z +        )
2026-02-20T22:09:16.1851278Z          # Utiliser normalize_age_group_for_db pour obtenir la valeur ENUM PostgreSQL
2026-02-20T22:09:16.1852136Z          from app.services.challenge_service import normalize_age_group_for_db
2026-02-20T22:09:16.1853183Z -        age_group_db = normalize_age_group_for_db(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1854259Z -        age_group = normalize_age_group(age_group_raw) if age_group_raw else None  # Format string pour logs
2026-02-20T22:09:16.1855022Z -        
2026-02-20T22:09:16.1855285Z +
2026-02-20T22:09:16.1855543Z +        age_group_db = (
2026-02-20T22:09:16.1856320Z +            normalize_age_group_for_db(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1856917Z +        )
2026-02-20T22:09:16.1857183Z +        age_group = (
2026-02-20T22:09:16.1857836Z +            normalize_age_group(age_group_raw) if age_group_raw else None
2026-02-20T22:09:16.1858433Z +        )  # Format string pour logs
2026-02-20T22:09:16.1858822Z +
2026-02-20T22:09:16.1859278Z          # Calculer la page à partir de skip et limit
2026-02-20T22:09:16.1859836Z          page = (skip // limit) + 1 if limit > 0 else 1
2026-02-20T22:09:16.1860278Z -        
2026-02-20T22:09:16.1860540Z +
2026-02-20T22:09:16.1861031Z          # Récupérer la locale depuis le header Accept-Language
2026-02-20T22:09:16.1861719Z -        accept_language = request.headers.get('Accept-Language', 'fr')
2026-02-20T22:09:16.1862466Z +        accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.1863291Z          locale = parse_accept_language(accept_language)
2026-02-20T22:09:16.1863774Z  
2026-02-20T22:09:16.1864741Z -        logger.debug(f"API - Paramètres reçus: limit={limit}, skip={skip}, page={page}, order={order}, hide_completed={hide_completed}")
2026-02-20T22:09:16.1865660Z +        logger.debug(
2026-02-20T22:09:16.1866588Z +            f"API - Paramètres reçus: limit={limit}, skip={skip}, page={page}, order={order}, hide_completed={hide_completed}"
2026-02-20T22:09:16.1867408Z +        )
2026-02-20T22:09:16.1867665Z  
2026-02-20T22:09:16.1868019Z          # IDs à exclure si hide_completed
2026-02-20T22:09:16.1868460Z          exclude_ids = []
2026-02-20T22:09:16.1868813Z          if hide_completed:
2026-02-20T22:09:16.1869209Z              user_id = current_user.get("id")
2026-02-20T22:09:16.1869632Z              if user_id:
2026-02-20T22:09:16.1870063Z                  from server.database import get_db_connection
2026-02-20T22:09:16.1870539Z +
2026-02-20T22:09:16.1870814Z                  conn = get_db_connection()
2026-02-20T22:09:16.1871260Z                  cursor = conn.cursor()
2026-02-20T22:09:16.1871647Z                  try:
2026-02-20T22:09:16.1871975Z                      cursor.execute(
2026-02-20T22:09:16.1872806Z                          "SELECT DISTINCT challenge_id FROM logic_challenge_attempts WHERE user_id = %s AND is_correct = true",
2026-02-20T22:09:16.1873835Z -                        (user_id,)
2026-02-20T22:09:16.1874218Z +                        (user_id,),
2026-02-20T22:09:16.1874592Z                      )
2026-02-20T22:09:16.1875119Z -                    exclude_ids = [row[0] for row in cursor.fetchall() if row[0] is not None]
2026-02-20T22:09:16.1875751Z +                    exclude_ids = [
2026-02-20T22:09:16.1876270Z +                        row[0] for row in cursor.fetchall() if row[0] is not None
2026-02-20T22:09:16.1876801Z +                    ]
2026-02-20T22:09:16.1877115Z                  finally:
2026-02-20T22:09:16.1877454Z                      cursor.close()
2026-02-20T22:09:16.1877839Z                      conn.close()
2026-02-20T22:09:16.1878205Z  
2026-02-20T22:09:16.1878535Z          # Utiliser le service ORM challenge_service
2026-02-20T22:09:16.1878989Z @@ -89,14 +115,15 @@
2026-02-20T22:09:16.1879403Z                  age_group=age_group_db,  # Utiliser la valeur ENUM DB
2026-02-20T22:09:16.1880036Z                  tags=search,  # Utiliser search comme filtre tags
2026-02-20T22:09:16.1880539Z                  limit=limit,
2026-02-20T22:09:16.1880904Z                  offset=skip,
2026-02-20T22:09:16.1881257Z                  order=order,
2026-02-20T22:09:16.1881704Z -                exclude_ids=exclude_ids if exclude_ids else None
2026-02-20T22:09:16.1882300Z +                exclude_ids=exclude_ids if exclude_ids else None,
2026-02-20T22:09:16.1882783Z              )
2026-02-20T22:09:16.1883457Z              # Convertir les objets en dicts avec normalisation age_group pour frontend
2026-02-20T22:09:16.1884347Z              from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:16.1885231Z +
2026-02-20T22:09:16.1885501Z              challenges_list = [
2026-02-20T22:09:16.1885867Z                  {
2026-02-20T22:09:16.1886161Z                      "id": c.id,
2026-02-20T22:09:16.1886535Z                      "title": c.title,
2026-02-20T22:09:16.1887126Z                      "description": c.description,
2026-02-20T22:09:16.1887571Z @@ -106,57 +133,68 @@
2026-02-20T22:09:16.1887897Z                      "tags": c.tags,
2026-02-20T22:09:16.1888342Z                      "difficulty_rating": c.difficulty_rating,
2026-02-20T22:09:16.1888956Z                      "estimated_time_minutes": c.estimated_time_minutes,
2026-02-20T22:09:16.1889517Z                      "success_rate": c.success_rate,
2026-02-20T22:09:16.1889988Z                      "view_count": c.view_count,
2026-02-20T22:09:16.1890451Z -                    "is_archived": c.is_archived
2026-02-20T22:09:16.1890916Z -                } for c in challenges
2026-02-20T22:09:16.1891351Z +                    "is_archived": c.is_archived,
2026-02-20T22:09:16.1891775Z +                }
2026-02-20T22:09:16.1892076Z +                for c in challenges
2026-02-20T22:09:16.1892444Z              ]
2026-02-20T22:09:16.1892720Z -            
2026-02-20T22:09:16.1893139Z +
2026-02-20T22:09:16.1893654Z              # Compter le total pour la pagination (même session)
2026-02-20T22:09:16.1894258Z              total = challenge_service.count_challenges(
2026-02-20T22:09:16.1894729Z                  db=db,
2026-02-20T22:09:16.1895090Z                  challenge_type=challenge_type,
2026-02-20T22:09:16.1895551Z                  age_group=age_group_db,
2026-02-20T22:09:16.1896052Z -                exclude_ids=exclude_ids if exclude_ids else None
2026-02-20T22:09:16.1896647Z +                exclude_ids=exclude_ids if exclude_ids else None,
2026-02-20T22:09:16.1897134Z              )
2026-02-20T22:09:16.1897398Z -        
2026-02-20T22:09:16.1897655Z +
2026-02-20T22:09:16.1898394Z          # Filtrer les défis archivés si nécessaire (déjà fait dans la query, mais double vérification)
2026-02-20T22:09:16.1899155Z          if active_only:
2026-02-20T22:09:16.1899733Z -            challenges_list = [c for c in challenges_list if not c.get('is_archived', False)]
2026-02-20T22:09:16.1900416Z +            challenges_list = [
2026-02-20T22:09:16.1900949Z +                c for c in challenges_list if not c.get("is_archived", False)
2026-02-20T22:09:16.1901489Z +            ]
2026-02-20T22:09:16.1901757Z  
2026-02-20T22:09:16.1902090Z          # Log pour déboguer
2026-02-20T22:09:16.1903244Z -        logger.debug(f"API - Retour de {len(challenges_list)} défis sur {total} total (limit demandé: {limit}, page: {page})")
2026-02-20T22:09:16.1904193Z +        logger.debug(
2026-02-20T22:09:16.1905060Z +            f"API - Retour de {len(challenges_list)} défis sur {total} total (limit demandé: {limit}, page: {page})"
2026-02-20T22:09:16.1905781Z +        )
2026-02-20T22:09:16.1906069Z          if len(challenges_list) > 0:
2026-02-20T22:09:16.1907107Z -            logger.debug(f"API - Premier défi: id={challenges_list[0].get('id')}, title={challenges_list[0].get('title')}")
2026-02-20T22:09:16.1907957Z -        
2026-02-20T22:09:16.1908277Z +            logger.debug(
2026-02-20T22:09:16.1909211Z +                f"API - Premier défi: id={challenges_list[0].get('id')}, title={challenges_list[0].get('title')}"
2026-02-20T22:09:16.1910000Z +            )
2026-02-20T22:09:16.1910295Z +
2026-02-20T22:09:16.1910748Z          # Retourner le format paginé standardisé
2026-02-20T22:09:16.1911271Z          has_more = (skip + len(challenges_list)) < total
2026-02-20T22:09:16.1911723Z -        
2026-02-20T22:09:16.1911994Z +
2026-02-20T22:09:16.1912261Z          response_data = {
2026-02-20T22:09:16.1912648Z              "items": challenges_list,
2026-02-20T22:09:16.1913285Z              "total": total,
2026-02-20T22:09:16.1913672Z              "page": page,
2026-02-20T22:09:16.1914026Z              "limit": limit,
2026-02-20T22:09:16.1914405Z -            "hasMore": has_more
2026-02-20T22:09:16.1915096Z +            "hasMore": has_more,
2026-02-20T22:09:16.1915475Z          }
2026-02-20T22:09:16.1915744Z  
2026-02-20T22:09:16.1916702Z -        logger.info(f"Récupération réussie de {len(challenges_list)} défis logiques sur {total} total (locale: {locale})")
2026-02-20T22:09:16.1917852Z +        logger.info(
2026-02-20T22:09:16.1918812Z +            f"Récupération réussie de {len(challenges_list)} défis logiques sur {total} total (locale: {locale})"
2026-02-20T22:09:16.1919631Z +        )
2026-02-20T22:09:16.1919960Z          return JSONResponse(response_data)
2026-02-20T22:09:16.1920490Z      except ValueError as filter_validation_error:
2026-02-20T22:09:16.1921414Z          logger.error(f"Erreur de validation des paramètres: {filter_validation_error}")
2026-02-20T22:09:16.1922193Z          return ErrorHandler.create_validation_error(
2026-02-20T22:09:16.1922756Z              errors=[str(filter_validation_error)],
2026-02-20T22:09:16.1923724Z -            user_message="Les paramètres de filtrage sont invalides."
2026-02-20T22:09:16.1924612Z +            user_message="Les paramètres de filtrage sont invalides.",
2026-02-20T22:09:16.1925177Z          )
2026-02-20T22:09:16.1925557Z      except Exception as challenges_retrieval_error:
2026-02-20T22:09:16.1926556Z -        logger.error(f"Erreur lors de la récupération des défis: {challenges_retrieval_error}")
2026-02-20T22:09:16.1927303Z +        logger.error(
2026-02-20T22:09:16.1928028Z +            f"Erreur lors de la récupération des défis: {challenges_retrieval_error}"
2026-02-20T22:09:16.1928657Z +        )
2026-02-20T22:09:16.1929002Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.1929535Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.1930062Z              error=challenges_retrieval_error,
2026-02-20T22:09:16.1930520Z              status_code=500,
2026-02-20T22:09:16.1931189Z -            user_message="Erreur lors de la récupération des défis."
2026-02-20T22:09:16.1932041Z +            user_message="Erreur lors de la récupération des défis.",
2026-02-20T22:09:16.1932573Z          )
2026-02-20T22:09:16.1932839Z  
2026-02-20T22:09:16.1933274Z  
2026-02-20T22:09:16.1933544Z  @require_auth
2026-02-20T22:09:16.1933900Z  async def get_challenge(request: Request):
2026-02-20T22:09:16.1934362Z @@ -164,28 +202,35 @@
2026-02-20T22:09:16.1934855Z      Récupère un défi logique par son ID.
2026-02-20T22:09:16.1935365Z      Route: GET /api/challenges/{challenge_id}
2026-02-20T22:09:16.1935823Z      """
2026-02-20T22:09:16.1936087Z      try:
2026-02-20T22:09:16.1936404Z          current_user = request.state.user
2026-02-20T22:09:16.1936840Z -        
2026-02-20T22:09:16.1937300Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.1937880Z -        
2026-02-20T22:09:16.1938157Z +
2026-02-20T22:09:16.1938587Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.1939146Z +
2026-02-20T22:09:16.1939695Z          # Récupérer la locale depuis le header Accept-Language
2026-02-20T22:09:16.1940444Z -        accept_language = request.headers.get('Accept-Language', 'fr')
2026-02-20T22:09:16.1941223Z +        accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.1941918Z          locale = parse_accept_language(accept_language)
2026-02-20T22:09:16.1942414Z -        
2026-02-20T22:09:16.1942684Z +
2026-02-20T22:09:16.1943221Z          # Utiliser le service ORM challenge_service
2026-02-20T22:09:16.1943729Z          async with db_session() as db:
2026-02-20T22:09:16.1944408Z              # Récupérer le challenge via get_challenge_by_id
2026-02-20T22:09:16.1945082Z              from app.models.logic_challenge import LogicChallenge
2026-02-20T22:09:16.1945977Z -            challenge = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:16.1946753Z +
2026-02-20T22:09:16.1947031Z +            challenge = (
2026-02-20T22:09:16.1947434Z +                db.query(LogicChallenge)
2026-02-20T22:09:16.1948246Z +                .filter(LogicChallenge.id == challenge_id)
2026-02-20T22:09:16.1948755Z +                .first()
2026-02-20T22:09:16.1949088Z +            )
2026-02-20T22:09:16.1949404Z              if challenge:
2026-02-20T22:09:16.1950169Z                  from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:16.1950708Z  
2026-02-20T22:09:16.1951053Z                  # Normaliser age_group pour le frontend
2026-02-20T22:09:16.1951805Z -                from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:16.1952515Z -                
2026-02-20T22:09:16.1952925Z +                from app.services.challenge_service import (
2026-02-20T22:09:16.1953701Z +                    normalize_age_group_for_frontend,
2026-02-20T22:09:16.1954165Z +                )
2026-02-20T22:09:16.1954468Z +
2026-02-20T22:09:16.1954755Z                  challenge_dict = {
2026-02-20T22:09:16.1955185Z                      "id": challenge.id,
2026-02-20T22:09:16.1955653Z                      "title": challenge.title,
2026-02-20T22:09:16.1956162Z                      "description": challenge.description,
2026-02-20T22:09:16.1956743Z                      "challenge_type": challenge.challenge_type,
2026-02-20T22:09:16.1957225Z @@ -201,36 +246,39 @@
2026-02-20T22:09:16.1957611Z                      "difficulty_rating": challenge.difficulty_rating,
2026-02-20T22:09:16.1958197Z                      "estimated_time_minutes": challenge.estimated_time_minutes,
2026-02-20T22:09:16.1958792Z                      "success_rate": challenge.success_rate,
2026-02-20T22:09:16.1959249Z                      "view_count": challenge.view_count,
2026-02-20T22:09:16.1959690Z                      "is_active": challenge.is_active,
2026-02-20T22:09:16.1960138Z -                    "is_archived": challenge.is_archived
2026-02-20T22:09:16.1960596Z +                    "is_archived": challenge.is_archived,
2026-02-20T22:09:16.1961003Z                  }
2026-02-20T22:09:16.1961264Z              else:
2026-02-20T22:09:16.1961561Z                  challenge_dict = None
2026-02-20T22:09:16.1961923Z -        
2026-02-20T22:09:16.1962146Z +
2026-02-20T22:09:16.1962381Z          if not challenge_dict:
2026-02-20T22:09:16.1962781Z              return ErrorHandler.create_not_found_error(
2026-02-20T22:09:16.1963615Z -                resource_type="Défi logique",
2026-02-20T22:09:16.1964066Z -                resource_id=challenge_id
2026-02-20T22:09:16.1964717Z +                resource_type="Défi logique", resource_id=challenge_id
2026-02-20T22:09:16.1965200Z              )
2026-02-20T22:09:16.1965437Z -        
2026-02-20T22:09:16.1966018Z -        logger.info(f"Récupération réussie du défi logique {challenge_id} (locale: {locale})")
2026-02-20T22:09:16.1966572Z +
2026-02-20T22:09:16.1966812Z +        logger.info(
2026-02-20T22:09:16.1967499Z +            f"Récupération réussie du défi logique {challenge_id} (locale: {locale})"
2026-02-20T22:09:16.1968149Z +        )
2026-02-20T22:09:16.1985458Z          return JSONResponse(challenge_dict)
2026-02-20T22:09:16.1986019Z      except ValueError as id_validation_error:
2026-02-20T22:09:16.1986664Z          logger.error(f"Erreur de validation: {id_validation_error}")
2026-02-20T22:09:16.1987344Z          return ErrorHandler.create_validation_error(
2026-02-20T22:09:16.1988047Z              errors=["ID de défi invalide"],
2026-02-20T22:09:16.1988742Z -            user_message="L'identifiant du défi est invalide."
2026-02-20T22:09:16.1989486Z +            user_message="L'identifiant du défi est invalide.",
2026-02-20T22:09:16.1990001Z          )
2026-02-20T22:09:16.1990371Z      except Exception as challenge_retrieval_error:
2026-02-20T22:09:16.1991327Z -        logger.error(f"Erreur lors de la récupération du défi: {challenge_retrieval_error}")
2026-02-20T22:09:16.1992081Z +        logger.error(
2026-02-20T22:09:16.1992766Z +            f"Erreur lors de la récupération du défi: {challenge_retrieval_error}"
2026-02-20T22:09:16.1993600Z +        )
2026-02-20T22:09:16.1994288Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.1994833Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.1995361Z              error=challenge_retrieval_error,
2026-02-20T22:09:16.1995833Z              status_code=500,
2026-02-20T22:09:16.1996702Z -            user_message="Erreur lors de la récupération du défi."
2026-02-20T22:09:16.1997554Z +            user_message="Erreur lors de la récupération du défi.",
2026-02-20T22:09:16.1998104Z          )
2026-02-20T22:09:16.1998371Z  
2026-02-20T22:09:16.1998629Z  
2026-02-20T22:09:16.1998885Z  @require_auth
2026-02-20T22:09:16.1999298Z  async def submit_challenge_answer(request: Request):
2026-02-20T22:09:16.1999807Z @@ -238,154 +286,222 @@
2026-02-20T22:09:16.2000302Z      Soumet une réponse à un défi logique.
2026-02-20T22:09:16.2000831Z      Route: POST /api/challenges/{challenge_id}/attempt
2026-02-20T22:09:16.2001324Z      """
2026-02-20T22:09:16.2001603Z      try:
2026-02-20T22:09:16.2001929Z          current_user = request.state.user
2026-02-20T22:09:16.2002354Z -        
2026-02-20T22:09:16.2002606Z +
2026-02-20T22:09:16.2002911Z          user_id = current_user.get("id")
2026-02-20T22:09:16.2003534Z          if not user_id:
2026-02-20T22:09:16.2004117Z              return JSONResponse({"error": "Utilisateur invalide"}, status_code=401)
2026-02-20T22:09:16.2004754Z -        
2026-02-20T22:09:16.2005203Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2005786Z +
2026-02-20T22:09:16.2006220Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2006838Z          data = await request.json()
2026-02-20T22:09:16.2007239Z -        
2026-02-20T22:09:16.2007704Z -        user_solution = data.get('user_solution') or data.get('answer')
2026-02-20T22:09:16.2008345Z -        time_spent = data.get('time_spent')
2026-02-20T22:09:16.2008871Z -        hints_used_raw = data.get('hints_used', [])
2026-02-20T22:09:16.2009337Z -        
2026-02-20T22:09:16.2009619Z +
2026-02-20T22:09:16.2010061Z +        user_solution = data.get("user_solution") or data.get("answer")
2026-02-20T22:09:16.2010680Z +        time_spent = data.get("time_spent")
2026-02-20T22:09:16.2011193Z +        hints_used_raw = data.get("hints_used", [])
2026-02-20T22:09:16.2011649Z +
2026-02-20T22:09:16.2012300Z          # Convertir hints_used de liste à entier (nombre d'indices utilisés)
2026-02-20T22:09:16.2013315Z          # Le modèle attend un Integer, pas une liste
2026-02-20T22:09:16.2013871Z          if isinstance(hints_used_raw, list):
2026-02-20T22:09:16.2014375Z              hints_used_count = len(hints_used_raw)
2026-02-20T22:09:16.2014906Z          elif isinstance(hints_used_raw, int):
2026-02-20T22:09:16.2015404Z              hints_used_count = hints_used_raw
2026-02-20T22:09:16.2015828Z          else:
2026-02-20T22:09:16.2016138Z              hints_used_count = 0
2026-02-20T22:09:16.2016519Z -        
2026-02-20T22:09:16.2016792Z +
2026-02-20T22:09:16.2017079Z          if not user_solution:
2026-02-20T22:09:16.2017848Z              return JSONResponse({"error": "Réponse requise"}, status_code=400)
2026-02-20T22:09:16.2018469Z -        
2026-02-20T22:09:16.2018756Z +
2026-02-20T22:09:16.2019052Z          async with db_session() as db:
2026-02-20T22:09:16.2019626Z              # Récupérer le défi
2026-02-20T22:09:16.2020234Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:16.2020885Z              if not challenge:
2026-02-20T22:09:16.2021701Z -                return JSONResponse({"error": "Défi logique non trouvé"}, status_code=404)
2026-02-20T22:09:16.2022364Z -            
2026-02-20T22:09:16.2022683Z +                return JSONResponse(
2026-02-20T22:09:16.2023555Z +                    {"error": "Défi logique non trouvé"}, status_code=404
2026-02-20T22:09:16.2024099Z +                )
2026-02-20T22:09:16.2024402Z +
2026-02-20T22:09:16.2024799Z              # Vérifier la réponse
2026-02-20T22:09:16.2025290Z              def _normalize_accents(text: str) -> str:
2026-02-20T22:09:16.2026413Z                  """Retire les accents pour tolérance (carré→carre, élève→eleve)."""
2026-02-20T22:09:16.2027075Z                  import unicodedata
2026-02-20T22:09:16.2027486Z -                return ''.join(
2026-02-20T22:09:16.2028182Z -                    c for c in unicodedata.normalize('NFD', text)
2026-02-20T22:09:16.2028796Z -                    if unicodedata.category(c) != 'Mn'
2026-02-20T22:09:16.2029301Z -                ) if text else ''
2026-02-20T22:09:16.2029678Z +
2026-02-20T22:09:16.2029941Z +                return (
2026-02-20T22:09:16.2030293Z +                    "".join(
2026-02-20T22:09:16.2030717Z +                        c
2026-02-20T22:09:16.2031171Z +                        for c in unicodedata.normalize("NFD", text)
2026-02-20T22:09:16.2031760Z +                        if unicodedata.category(c) != "Mn"
2026-02-20T22:09:16.2032236Z +                    )
2026-02-20T22:09:16.2032567Z +                    if text
2026-02-20T22:09:16.2032951Z +                    else ""
2026-02-20T22:09:16.2033474Z +                )
2026-02-20T22:09:16.2033772Z  
2026-02-20T22:09:16.2034133Z              def _normalize_shape_answer(text: str) -> str:
2026-02-20T22:09:16.2034854Z                  """Normalise pour VISUAL : synonymes, accents, ordre forme+couleur."""
2026-02-20T22:09:16.2035526Z                  if not text:
2026-02-20T22:09:16.2035887Z -                    return ''
2026-02-20T22:09:16.2036257Z +                    return ""
2026-02-20T22:09:16.2036643Z                  t = text.lower().strip()
2026-02-20T22:09:16.2037332Z -                for old, new in [('rectangle', 'carre'), ('square', 'carre'), ('circle', 'cercle'),
2026-02-20T22:09:16.2038449Z -                                 ('carré', 'carre'), ('étoile', 'etoile'), ('losange', 'losange')]:
2026-02-20T22:09:16.2039114Z +                for old, new in [
2026-02-20T22:09:16.2039544Z +                    ("rectangle", "carre"),
2026-02-20T22:09:16.2040006Z +                    ("square", "carre"),
2026-02-20T22:09:16.2040473Z +                    ("circle", "cercle"),
2026-02-20T22:09:16.2041023Z +                    ("carré", "carre"),
2026-02-20T22:09:16.2041567Z +                    ("étoile", "etoile"),
2026-02-20T22:09:16.2042031Z +                    ("losange", "losange"),
2026-02-20T22:09:16.2042462Z +                ]:
2026-02-20T22:09:16.2042780Z                      if old in t:
2026-02-20T22:09:16.2043394Z                          t = t.replace(old, new)
2026-02-20T22:09:16.2043883Z                  t = _normalize_accents(t)
2026-02-20T22:09:16.2044514Z                  # Accepter "bleu carre" ou "carre bleu" -> normaliser en "carre bleu"
2026-02-20T22:09:16.2045179Z                  mots = t.split()
2026-02-20T22:09:16.2045938Z -                formes = {'carre', 'cercle', 'triangle', 'rectangle', 'losange', 'etoile', 'hexagone', 'pentagone'}
2026-02-20T22:09:16.2047241Z -                couleurs = {'rouge', 'bleu', 'vert', 'jaune', 'orange', 'violet', 'rose', 'gris', 'noir', 'blanc', 'red', 'blue', 'green', 'yellow'}
2026-02-20T22:09:16.2048180Z +                formes = {
2026-02-20T22:09:16.2048548Z +                    "carre",
2026-02-20T22:09:16.2048929Z +                    "cercle",
2026-02-20T22:09:16.2049296Z +                    "triangle",
2026-02-20T22:09:16.2049691Z +                    "rectangle",
2026-02-20T22:09:16.2050156Z +                    "losange",
2026-02-20T22:09:16.2050539Z +                    "etoile",
2026-02-20T22:09:16.2050907Z +                    "hexagone",
2026-02-20T22:09:16.2051301Z +                    "pentagone",
2026-02-20T22:09:16.2051675Z +                }
2026-02-20T22:09:16.2051996Z +                couleurs = {
2026-02-20T22:09:16.2052364Z +                    "rouge",
2026-02-20T22:09:16.2052717Z +                    "bleu",
2026-02-20T22:09:16.2053257Z +                    "vert",
2026-02-20T22:09:16.2053612Z +                    "jaune",
2026-02-20T22:09:16.2053971Z +                    "orange",
2026-02-20T22:09:16.2054599Z +                    "violet",
2026-02-20T22:09:16.2054952Z +                    "rose",
2026-02-20T22:09:16.2055293Z +                    "gris",
2026-02-20T22:09:16.2055723Z +                    "noir",
2026-02-20T22:09:16.2056066Z +                    "blanc",
2026-02-20T22:09:16.2056617Z +                    "red",
2026-02-20T22:09:16.2056976Z +                    "blue",
2026-02-20T22:09:16.2057328Z +                    "green",
2026-02-20T22:09:16.2057690Z +                    "yellow",
2026-02-20T22:09:16.2058024Z +                }
2026-02-20T22:09:16.2058345Z                  f, c = None, None
2026-02-20T22:09:16.2058732Z                  for m in mots:
2026-02-20T22:09:16.2059117Z                      if m in formes:
2026-02-20T22:09:16.2059507Z                          f = m
2026-02-20T22:09:16.2059897Z                      elif m in couleurs:
2026-02-20T22:09:16.2060310Z                          c = m
2026-02-20T22:09:16.2060661Z                  if f and c:
2026-02-20T22:09:16.2061033Z -                    t = f'{f} {c}'
2026-02-20T22:09:16.2061506Z +                    t = f"{f} {c}"
2026-02-20T22:09:16.2061903Z                  return t
2026-02-20T22:09:16.2062225Z  
2026-02-20T22:09:16.2062607Z              def _parse_multi_visual_answer(text: str) -> list:
2026-02-20T22:09:16.2063610Z                  """Parse multi-cellules VISUAL. Formats acceptés :
2026-02-20T22:09:16.2064439Z                  - 'Position 6: carré bleu, Position 9: triangle vert'
2026-02-20T22:09:16.2065220Z                  - '6:cercle rouge,9:étoile jaune' (format IA)
2026-02-20T22:09:16.2065732Z                  """
2026-02-20T22:09:16.2066113Z                  if not text or not text.strip():
2026-02-20T22:09:16.2066575Z                      return []
2026-02-20T22:09:16.2066958Z                  parts = []
2026-02-20T22:09:16.2067429Z -                for segment in text.replace(',', ' , ').split(','):
2026-02-20T22:09:16.2068092Z +                for segment in text.replace(",", " , ").split(","):
2026-02-20T22:09:16.2068686Z                      segment = segment.strip()
2026-02-20T22:09:16.2069159Z                      if not segment:
2026-02-20T22:09:16.2069579Z                          continue
2026-02-20T22:09:16.2070025Z                      # Format "Position 6: xxx" ou "6: xxx"
2026-02-20T22:09:16.2070543Z -                    if ':' in segment:
2026-02-20T22:09:16.2071055Z -                        pos_part, ans_part = segment.split(':', 1)
2026-02-20T22:09:16.2071587Z +                    if ":" in segment:
2026-02-20T22:09:16.2072093Z +                        pos_part, ans_part = segment.split(":", 1)
2026-02-20T22:09:16.2072671Z                          ans_part = ans_part.strip()
2026-02-20T22:09:16.2073470Z -                        pos_digits = ''.join(c for c in pos_part if c.isdigit())
2026-02-20T22:09:16.2074200Z +                        pos_digits = "".join(c for c in pos_part if c.isdigit())
2026-02-20T22:09:16.2074929Z                          if pos_digits and ans_part and not ans_part.isdigit():
2026-02-20T22:09:16.2075889Z                              # Segment ressemble à "6:cercle rouge" ou "Position 6: cercle rouge"
2026-02-20T22:09:16.2076797Z -                            parts.append((int(pos_digits), _normalize_shape_answer(ans_part)))
2026-02-20T22:09:16.2077508Z +                            parts.append(
2026-02-20T22:09:16.2078091Z +                                (int(pos_digits), _normalize_shape_answer(ans_part))
2026-02-20T22:09:16.2078682Z +                            )
2026-02-20T22:09:16.2079057Z                              continue
2026-02-20T22:09:16.2079597Z                      parts.append((0, _normalize_shape_answer(segment)))
2026-02-20T22:09:16.2080156Z                  if parts:
2026-02-20T22:09:16.2080528Z                      return parts
2026-02-20T22:09:16.2081096Z                  return [(0, _normalize_shape_answer(text))] if text.strip() else []
2026-02-20T22:09:16.2081709Z  
2026-02-20T22:09:16.2082400Z              # Fonction helper pour parser une réponse (gère format liste Python et CSV)
2026-02-20T22:09:16.2083641Z              def parse_answer_to_list(answer: str) -> list:
2026-02-20T22:09:16.2084490Z                  """Parse une réponse en liste, gérant plusieurs formats."""
2026-02-20T22:09:16.2085116Z                  answer = str(answer).strip()
2026-02-20T22:09:16.2085762Z -                
2026-02-20T22:09:16.2086079Z +
2026-02-20T22:09:16.2086494Z                  # Format liste Python : "['Rouge', 'Vert', 'Jaune', 'Bleu']"
2026-02-20T22:09:16.2087175Z -                if answer.startswith('[') and answer.endswith(']'):
2026-02-20T22:09:16.2087821Z +                if answer.startswith("[") and answer.endswith("]"):
2026-02-20T22:09:16.2088350Z                      try:
2026-02-20T22:09:16.2088695Z                          import ast
2026-02-20T22:09:16.2089068Z +
2026-02-20T22:09:16.2089397Z                          parsed = ast.literal_eval(answer)
2026-02-20T22:09:16.2089933Z                          if isinstance(parsed, list):
2026-02-20T22:09:16.2090556Z                              return [str(item).strip().lower() for item in parsed]
2026-02-20T22:09:16.2091189Z                      except (ValueError, SyntaxError):
2026-02-20T22:09:16.2091657Z                          pass
2026-02-20T22:09:16.2092171Z                      # Fallback: retirer les crochets et parser manuellement
2026-02-20T22:09:16.2092755Z                      inner = answer[1:-1]
2026-02-20T22:09:16.2093600Z                      # Retirer les quotes autour de chaque élément
2026-02-20T22:09:16.2094130Z                      items = []
2026-02-20T22:09:16.2094545Z -                    for item in inner.split(','):
2026-02-20T22:09:16.2095052Z +                    for item in inner.split(","):
2026-02-20T22:09:16.2095640Z                          item = item.strip().strip("'").strip('"').strip().lower()
2026-02-20T22:09:16.2096219Z                          if item:
2026-02-20T22:09:16.2096641Z                              items.append(item)
2026-02-20T22:09:16.2097073Z                      return items
2026-02-20T22:09:16.2097449Z -                
2026-02-20T22:09:16.2097732Z +
2026-02-20T22:09:16.2098157Z                  # Format CSV simple : "Rouge,Vert,Jaune,Bleu" ou "O, O, X, O"
2026-02-20T22:09:16.2098746Z -                if ',' in answer:
2026-02-20T22:09:16.2099399Z -                    return [item.strip().lower() for item in answer.split(',') if item.strip()]
2026-02-20T22:09:16.2100068Z -                
2026-02-20T22:09:16.2100398Z +                if "," in answer:
2026-02-20T22:09:16.2100797Z +                    return [
2026-02-20T22:09:16.2101197Z +                        item.strip().lower()
2026-02-20T22:09:16.2101701Z +                        for item in answer.split(",")
2026-02-20T22:09:16.2102190Z +                        if item.strip()
2026-02-20T22:09:16.2102614Z +                    ]
2026-02-20T22:09:16.2102922Z +
2026-02-20T22:09:16.2103650Z                  # Séparateur espaces : "O O X O" (sans virgules)
2026-02-20T22:09:16.2104343Z                  parts = [p.strip().lower() for p in answer.split() if p.strip()]
2026-02-20T22:09:16.2104984Z                  if len(parts) > 1:
2026-02-20T22:09:16.2105404Z                      return parts
2026-02-20T22:09:16.2105778Z -                
2026-02-20T22:09:16.2106077Z +
2026-02-20T22:09:16.2106357Z                  # Valeur simple
2026-02-20T22:09:16.2106819Z                  return [answer.lower()] if answer else []
2026-02-20T22:09:16.2107298Z -            
2026-02-20T22:09:16.2107880Z -            def compare_deduction_answers(user_answer: str, correct_answer: str) -> bool:
2026-02-20T22:09:16.2108572Z +
2026-02-20T22:09:16.2108895Z +            def compare_deduction_answers(
2026-02-20T22:09:16.2109406Z +                user_answer: str, correct_answer: str
2026-02-20T22:09:16.2109876Z +            ) -> bool:
2026-02-20T22:09:16.2110208Z                  """
2026-02-20T22:09:16.2110794Z                  Compare les réponses pour les défis de déduction.
2026-02-20T22:09:16.2111557Z                  Format attendu: "Emma:Chimie:700,Lucas:Info:600,..." ou format dict-like
2026-02-20T22:09:16.2112752Z                  L'ordre des associations n'a pas d'importance, seul le contenu compte.
2026-02-20T22:09:16.2114076Z                  Normalise les ordinaux français (1er, 2ème, 3ème...) en chiffres (1, 2, 3...).
2026-02-20T22:09:16.2115001Z                  """
2026-02-20T22:09:16.2115775Z                  # Mapping ordinaux français → chiffre (frontend affiche "1er", "2ème" etc.)
2026-02-20T22:09:16.2116484Z                  _ORDINAL_NORM = {
2026-02-20T22:09:16.2117093Z -                    "1er": "1", "1ère": "1", "1e": "1", "1ere": "1",
2026-02-20T22:09:16.2117756Z -                    "2ème": "2", "2eme": "2", "2e": "2",
2026-02-20T22:09:16.2118351Z -                    "3ème": "3", "3eme": "3", "3e": "3",
2026-02-20T22:09:16.2118954Z -                    "4ème": "4", "4eme": "4", "4e": "4",
2026-02-20T22:09:16.2119556Z -                    "5ème": "5", "5eme": "5", "5e": "5",
2026-02-20T22:09:16.2120174Z -                    "6ème": "6", "6eme": "6", "6e": "6",
2026-02-20T22:09:16.2120771Z -                    "7ème": "7", "7eme": "7", "7e": "7",
2026-02-20T22:09:16.2121362Z -                    "8ème": "8", "8eme": "8", "8e": "8",
2026-02-20T22:09:16.2121957Z -                    "9ème": "9", "9eme": "9", "9e": "9",
2026-02-20T22:09:16.2122591Z -                    "10ème": "10", "10eme": "10", "10e": "10",
2026-02-20T22:09:16.2123276Z +                    "1er": "1",
2026-02-20T22:09:16.2123754Z +                    "1ère": "1",
2026-02-20T22:09:16.2124141Z +                    "1e": "1",
2026-02-20T22:09:16.2124514Z +                    "1ere": "1",
2026-02-20T22:09:16.2124969Z +                    "2ème": "2",
2026-02-20T22:09:16.2125350Z +                    "2eme": "2",
2026-02-20T22:09:16.2125714Z +                    "2e": "2",
2026-02-20T22:09:16.2126158Z +                    "3ème": "3",
2026-02-20T22:09:16.2126528Z +                    "3eme": "3",
2026-02-20T22:09:16.2126901Z +                    "3e": "3",
2026-02-20T22:09:16.2127370Z +                    "4ème": "4",
2026-02-20T22:09:16.2127754Z +                    "4eme": "4",
2026-02-20T22:09:16.2128126Z +                    "4e": "4",
2026-02-20T22:09:16.2128564Z +                    "5ème": "5",
2026-02-20T22:09:16.2128925Z +                    "5eme": "5",
2026-02-20T22:09:16.2129299Z +                    "5e": "5",
2026-02-20T22:09:16.2129727Z +                    "6ème": "6",
2026-02-20T22:09:16.2130079Z +                    "6eme": "6",
2026-02-20T22:09:16.2130441Z +                    "6e": "6",
2026-02-20T22:09:16.2130891Z +                    "7ème": "7",
2026-02-20T22:09:16.2131263Z +                    "7eme": "7",
2026-02-20T22:09:16.2131629Z +                    "7e": "7",
2026-02-20T22:09:16.2132053Z +                    "8ème": "8",
2026-02-20T22:09:16.2132416Z +                    "8eme": "8",
2026-02-20T22:09:16.2132764Z +                    "8e": "8",
2026-02-20T22:09:16.2133434Z +                    "9ème": "9",
2026-02-20T22:09:16.2133832Z +                    "9eme": "9",
2026-02-20T22:09:16.2134203Z +                    "9e": "9",
2026-02-20T22:09:16.2134647Z +                    "10ème": "10",
2026-02-20T22:09:16.2135049Z +                    "10eme": "10",
2026-02-20T22:09:16.2135433Z +                    "10e": "10",
2026-02-20T22:09:16.2135812Z                  }
2026-02-20T22:09:16.2136115Z  
2026-02-20T22:09:16.2136423Z                  def _norm_ordinal(s: str) -> str:
2026-02-20T22:09:16.2137146Z                      """Normalise un ordinal français en chiffre."""
2026-02-20T22:09:16.2137695Z                      t = s.strip().lower()
2026-02-20T22:09:16.2138114Z @@ -393,166 +509,232 @@
2026-02-20T22:09:16.2138423Z  
2026-02-20T22:09:16.2138787Z                  def parse_associations(answer: str) -> set:
2026-02-20T22:09:16.2139592Z                      """Parse les associations en set de tuples normalisés."""
2026-02-20T22:09:16.2140244Z                      answer = str(answer).strip().lower()
2026-02-20T22:09:16.2141035Z                      associations = set()
2026-02-20T22:09:16.2141452Z -                    
2026-02-20T22:09:16.2141772Z +
2026-02-20T22:09:16.2142213Z                      # Format "entité:val1:val2,..."
2026-02-20T22:09:16.2142698Z -                    if ':' in answer:
2026-02-20T22:09:16.2143581Z -                        for part in answer.split(','):
2026-02-20T22:09:16.2144104Z +                    if ":" in answer:
2026-02-20T22:09:16.2144557Z +                        for part in answer.split(","):
2026-02-20T22:09:16.2145069Z                              part = part.strip()
2026-02-20T22:09:16.2145531Z                              if part:
2026-02-20T22:09:16.2146060Z                                  # Normaliser ordinaux + tri pour ignorer l'ordre
2026-02-20T22:09:16.2146786Z -                                raw = [e.strip() for e in part.split(':') if e.strip()]
2026-02-20T22:09:16.2147566Z -                                elements = tuple(sorted([_norm_ordinal(e) for e in raw]))
2026-02-20T22:09:16.2148342Z +                                raw = [e.strip() for e in part.split(":") if e.strip()]
2026-02-20T22:09:16.2148954Z +                                elements = tuple(
2026-02-20T22:09:16.2149495Z +                                    sorted([_norm_ordinal(e) for e in raw])
2026-02-20T22:09:16.2150103Z +                                )
2026-02-20T22:09:16.2150516Z                                  if elements:
2026-02-20T22:09:16.2151019Z                                      associations.add(elements)
2026-02-20T22:09:16.2151559Z                      # Format dict-like ou JSON
2026-02-20T22:09:16.2152028Z -                    elif '{' in answer:
2026-02-20T22:09:16.2152469Z +                    elif "{" in answer:
2026-02-20T22:09:16.2152897Z                          try:
2026-02-20T22:09:16.2153491Z                              import json
2026-02-20T22:09:16.2153886Z +
2026-02-20T22:09:16.2154267Z                              data = json.loads(answer.replace("'", '"'))
2026-02-20T22:09:16.2154859Z                              if isinstance(data, dict):
2026-02-20T22:09:16.2155408Z                                  for key, values in data.items():
2026-02-20T22:09:16.2155952Z                                      if isinstance(values, dict):
2026-02-20T22:09:16.2156828Z -                                        elements = tuple(sorted([str(key).lower()] + [str(v).lower() for v in values.values()]))
2026-02-20T22:09:16.2157705Z +                                        elements = tuple(
2026-02-20T22:09:16.2158197Z +                                            sorted(
2026-02-20T22:09:16.2158705Z +                                                [str(key).lower()]
2026-02-20T22:09:16.2159212Z +                                                + [
2026-02-20T22:09:16.2159716Z +                                                    str(v).lower()
2026-02-20T22:09:16.2160267Z +                                                    for v in values.values()
2026-02-20T22:09:16.2160800Z +                                                ]
2026-02-20T22:09:16.2161491Z +                                            )
2026-02-20T22:09:16.2161915Z +                                        )
2026-02-20T22:09:16.2162339Z                                      else:
2026-02-20T22:09:16.2163180Z -                                        elements = tuple(sorted([str(key).lower(), str(values).lower()]))
2026-02-20T22:09:16.2163934Z +                                        elements = tuple(
2026-02-20T22:09:16.2164420Z +                                            sorted(
2026-02-20T22:09:16.2164979Z +                                                [str(key).lower(), str(values).lower()]
2026-02-20T22:09:16.2165545Z +                                            )
2026-02-20T22:09:16.2165977Z +                                        )
2026-02-20T22:09:16.2166466Z                                      associations.add(elements)
2026-02-20T22:09:16.2167213Z -                        except (json.JSONDecodeError, ValueError, TypeError, AttributeError):
2026-02-20T22:09:16.2167931Z +                        except (
2026-02-20T22:09:16.2168368Z +                            json.JSONDecodeError,
2026-02-20T22:09:16.2168854Z +                            ValueError,
2026-02-20T22:09:16.2169285Z +                            TypeError,
2026-02-20T22:09:16.2169958Z +                            AttributeError,
2026-02-20T22:09:16.2170432Z +                        ):
2026-02-20T22:09:16.2170800Z                              pass
2026-02-20T22:09:16.2171192Z -                    
2026-02-20T22:09:16.2171503Z +
2026-02-20T22:09:16.2171804Z                      return associations
2026-02-20T22:09:16.2172216Z -                
2026-02-20T22:09:16.2172530Z +
2026-02-20T22:09:16.2173163Z                  user_assoc = parse_associations(user_answer)
2026-02-20T22:09:16.2173836Z                  correct_assoc = parse_associations(correct_answer)
2026-02-20T22:09:16.2174374Z -                
2026-02-20T22:09:16.2175019Z -                logger.debug(f"Deduction comparison - User: {user_assoc}, Correct: {correct_assoc}")
2026-02-20T22:09:16.2175785Z -                
2026-02-20T22:09:16.2176081Z +
2026-02-20T22:09:16.2176363Z +                logger.debug(
2026-02-20T22:09:16.2176977Z +                    f"Deduction comparison - User: {user_assoc}, Correct: {correct_assoc}"
2026-02-20T22:09:16.2177639Z +                )
2026-02-20T22:09:16.2177920Z +
2026-02-20T22:09:16.2178195Z                  # Comparer les sets
2026-02-20T22:09:16.2178654Z                  return user_assoc == correct_assoc
2026-02-20T22:09:16.2179101Z -            
2026-02-20T22:09:16.2179393Z +
2026-02-20T22:09:16.2180083Z              # Déterminer le type de challenge pour choisir la méthode de comparaison
2026-02-20T22:09:16.2181136Z -            challenge_type = str(challenge.challenge_type).lower() if challenge.challenge_type else ''
2026-02-20T22:09:16.2181964Z +            challenge_type = (
2026-02-20T22:09:16.2182429Z +                str(challenge.challenge_type).lower()
2026-02-20T22:09:16.2183153Z +                if challenge.challenge_type
2026-02-20T22:09:16.2183623Z +                else ""
2026-02-20T22:09:16.2183961Z +            )
2026-02-20T22:09:16.2184235Z  
2026-02-20T22:09:16.2184773Z              # Comparaison spéciale pour les défis de déduction
2026-02-20T22:09:16.2185468Z -            if 'deduction' in challenge_type and ':' in user_solution:
2026-02-20T22:09:16.2186350Z -                is_correct = compare_deduction_answers(user_solution, challenge.correct_answer)
2026-02-20T22:09:16.2188252Z -                logger.debug(f"Comparaison déduction - User: {user_solution[:100]}, Correct: {challenge.correct_answer[:100] if challenge.correct_answer else 'None'}, Result: {is_correct}")
2026-02-20T22:09:16.2189626Z -            elif 'probability' in challenge_type:
2026-02-20T22:09:16.2190255Z +            if "deduction" in challenge_type and ":" in user_solution:
2026-02-20T22:09:16.2190877Z +                is_correct = compare_deduction_answers(
2026-02-20T22:09:16.2191443Z +                    user_solution, challenge.correct_answer
2026-02-20T22:09:16.2192184Z +                )
2026-02-20T22:09:16.2192522Z +                logger.debug(
2026-02-20T22:09:16.2194200Z +                    f"Comparaison déduction - User: {user_solution[:100]}, Correct: {challenge.correct_answer[:100] if challenge.correct_answer else 'None'}, Result: {is_correct}"
2026-02-20T22:09:16.2195439Z +                )
2026-02-20T22:09:16.2195831Z +            elif "probability" in challenge_type:
2026-02-20T22:09:16.2196282Z +
2026-02-20T22:09:16.2196697Z                  def _parse_probability_value(text: str) -> float | None:
2026-02-20T22:09:16.2197529Z                      """Parse 6/10, 3/5, 0.6, 60% → valeur décimale."""
2026-02-20T22:09:16.2198152Z                      if not text or not isinstance(text, str):
2026-02-20T22:09:16.2198665Z                          return None
2026-02-20T22:09:16.2199080Z                      t = text.strip()
2026-02-20T22:09:16.2199485Z -                    if '/' in t:
2026-02-20T22:09:16.2199892Z +                    if "/" in t:
2026-02-20T22:09:16.2200276Z                          try:
2026-02-20T22:09:16.2200683Z -                            a, b = t.split('/', 1)
2026-02-20T22:09:16.2201181Z +                            a, b = t.split("/", 1)
2026-02-20T22:09:16.2201958Z                              num, den = float(a.strip()), float(b.strip())
2026-02-20T22:09:16.2202612Z                              return num / den if den else None
2026-02-20T22:09:16.2203393Z                          except (ValueError, ZeroDivisionError):
2026-02-20T22:09:16.2203939Z                              return None
2026-02-20T22:09:16.2204381Z -                    if '%' in t:
2026-02-20T22:09:16.2204768Z +                    if "%" in t:
2026-02-20T22:09:16.2205159Z                          try:
2026-02-20T22:09:16.2205629Z -                            return float(t.replace('%', '').strip()) / 100
2026-02-20T22:09:16.2206283Z +                            return float(t.replace("%", "").strip()) / 100
2026-02-20T22:09:16.2206858Z                          except ValueError:
2026-02-20T22:09:16.2207312Z                              return None
2026-02-20T22:09:16.2207736Z                      try:
2026-02-20T22:09:16.2208142Z -                        return float(t.replace(',', '.'))
2026-02-20T22:09:16.2208701Z +                        return float(t.replace(",", "."))
2026-02-20T22:09:16.2209205Z                      except ValueError:
2026-02-20T22:09:16.2209634Z                          return None
2026-02-20T22:09:16.2210012Z  
2026-02-20T22:09:16.2210383Z                  u_val = _parse_probability_value(user_solution)
2026-02-20T22:09:16.2211090Z -                c_val = _parse_probability_value(challenge.correct_answer or '')
2026-02-20T22:09:16.2211883Z +                c_val = _parse_probability_value(challenge.correct_answer or "")
2026-02-20T22:09:16.2212515Z                  is_correct = (
2026-02-20T22:09:16.2212909Z                      u_val is not None
2026-02-20T22:09:16.2213537Z                      and c_val is not None
2026-02-20T22:09:16.2214004Z                      and abs(u_val - c_val) < 0.001
2026-02-20T22:09:16.2214452Z                  )
2026-02-20T22:09:16.2215103Z -                if not is_correct and user_solution.strip() == (challenge.correct_answer or '').strip():
2026-02-20T22:09:16.2215873Z +                if (
2026-02-20T22:09:16.2216204Z +                    not is_correct
2026-02-20T22:09:16.2216638Z +                    and user_solution.strip()
2026-02-20T22:09:16.2217156Z +                    == (challenge.correct_answer or "").strip()
2026-02-20T22:09:16.2217628Z +                ):
2026-02-20T22:09:16.2217949Z                      is_correct = True
2026-02-20T22:09:16.2219072Z -                logger.debug(f"Comparaison PROBABILITY - User: {user_solution}, Correct: {challenge.correct_answer}, Parsed: {u_val}/{c_val}, Result: {is_correct}")
2026-02-20T22:09:16.2220277Z -            elif 'chess' in challenge_type:
2026-02-20T22:09:16.2220733Z +                logger.debug(
2026-02-20T22:09:16.2222058Z +                    f"Comparaison PROBABILITY - User: {user_solution}, Correct: {challenge.correct_answer}, Parsed: {u_val}/{c_val}, Result: {is_correct}"
2026-02-20T22:09:16.2223295Z +                )
2026-02-20T22:09:16.2223656Z +            elif "chess" in challenge_type:
2026-02-20T22:09:16.2224082Z +
2026-02-20T22:09:16.2224447Z                  def _normalize_chess_answer(text: str) -> str:
2026-02-20T22:09:16.2225355Z                      """Normalise une réponse échecs pour comparaison tolérante."""
2026-02-20T22:09:16.2225626Z                      if not text or not isinstance(text, str):
2026-02-20T22:09:16.2225753Z                          return ""
2026-02-20T22:09:16.2225886Z                      import re
2026-02-20T22:09:16.2225990Z +
2026-02-20T22:09:16.2226125Z                      t = text.strip()
2026-02-20T22:09:16.2226470Z                      # Retirer numéros de coups (1. 2. 3. 1) 2) etc.)
2026-02-20T22:09:16.2226637Z -                    t = re.sub(r'\d+[.)]\s*', '', t)
2026-02-20T22:09:16.2226808Z +                    t = re.sub(r"\d+[.)]\s*", "", t)
2026-02-20T22:09:16.2227028Z                      # Collapser espaces multiples et normaliser
2026-02-20T22:09:16.2227188Z -                    t = re.sub(r'\s+', ' ', t).strip()
2026-02-20T22:09:16.2227562Z +                    t = re.sub(r"\s+", " ", t).strip()
2026-02-20T22:09:16.2228048Z                      # Notation anglaise → française (Q->D, R->T, B->F, N->C, K->R)
2026-02-20T22:09:16.2228344Z -                    _en_to_fr = {'Q': 'D', 'R': 'T', 'B': 'F', 'N': 'C', 'K': 'R', 'P': 'P'}
2026-02-20T22:09:16.2228467Z +                    _en_to_fr = {
2026-02-20T22:09:16.2228583Z +                        "Q": "D",
2026-02-20T22:09:16.2228710Z +                        "R": "T",
2026-02-20T22:09:16.2228825Z +                        "B": "F",
2026-02-20T22:09:16.2228937Z +                        "N": "C",
2026-02-20T22:09:16.2229056Z +                        "K": "R",
2026-02-20T22:09:16.2229186Z +                        "P": "P",
2026-02-20T22:09:16.2229295Z +                    }
2026-02-20T22:09:16.2229436Z                      parts = t.split()
2026-02-20T22:09:16.2229572Z                      out = []
2026-02-20T22:09:16.2229709Z                      for p in parts:
2026-02-20T22:09:16.2229944Z                          if len(p) >= 1 and p[0].upper() in _en_to_fr:
2026-02-20T22:09:16.2230190Z                              out.append(_en_to_fr[p[0].upper()] + p[1:])
2026-02-20T22:09:16.2230316Z                          else:
2026-02-20T22:09:16.2230464Z                              out.append(p)
2026-02-20T22:09:16.2230628Z -                    t = ' '.join(out).upper()
2026-02-20T22:09:16.2230779Z +                    t = " ".join(out).upper()
2026-02-20T22:09:16.2231332Z                      # Comparaison sans espaces (tolérance "Dg8+ Txg8 Cf7#" = "Dg8+Txg8Cf7#")
2026-02-20T22:09:16.2231503Z -                    return t.replace(' ', '')
2026-02-20T22:09:16.2231665Z +                    return t.replace(" ", "")
2026-02-20T22:09:16.2231782Z  
2026-02-20T22:09:16.2232007Z                  u_norm = _normalize_chess_answer(user_solution)
2026-02-20T22:09:16.2232235Z -                correct_raw = challenge.correct_answer or ''
2026-02-20T22:09:16.2232450Z +                correct_raw = challenge.correct_answer or ""
2026-02-20T22:09:16.2232875Z                  # Accepter plusieurs solutions (duals) séparées par " | "
2026-02-20T22:09:16.2233446Z -                correct_variants = [s.strip() for s in correct_raw.split('|') if s.strip()]
2026-02-20T22:09:16.2233603Z +                correct_variants = [
2026-02-20T22:09:16.2233853Z +                    s.strip() for s in correct_raw.split("|") if s.strip()
2026-02-20T22:09:16.2233969Z +                ]
2026-02-20T22:09:16.2234315Z                  correct_norms = [_normalize_chess_answer(v) for v in correct_variants]
2026-02-20T22:09:16.2234872Z -                is_correct = u_norm in correct_norms if correct_norms else u_norm == _normalize_chess_answer(correct_raw)
2026-02-20T22:09:16.2235682Z -                logger.debug(f"Comparaison CHESS - User norm: {u_norm}, Correct: {correct_norms}, Result: {is_correct}")
2026-02-20T22:09:16.2235877Z -            elif 'graph' in challenge_type:
2026-02-20T22:09:16.2236016Z +                is_correct = (
2026-02-20T22:09:16.2236189Z +                    u_norm in correct_norms
2026-02-20T22:09:16.2236338Z +                    if correct_norms
2026-02-20T22:09:16.2236581Z +                    else u_norm == _normalize_chess_answer(correct_raw)
2026-02-20T22:09:16.2236701Z +                )
2026-02-20T22:09:16.2236846Z +                logger.debug(
2026-02-20T22:09:16.2237314Z +                    f"Comparaison CHESS - User norm: {u_norm}, Correct: {correct_norms}, Result: {is_correct}"
2026-02-20T22:09:16.2237428Z +                )
2026-02-20T22:09:16.2237588Z +            elif "graph" in challenge_type:
2026-02-20T22:09:16.2238086Z                  # Liste de nœuds : accepter tout ordre (comparaison par ensemble)
2026-02-20T22:09:16.2238335Z                  user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2238671Z -                correct_list = parse_answer_to_list(challenge.correct_answer or '')
2026-02-20T22:09:16.2239223Z +                correct_list = parse_answer_to_list(challenge.correct_answer or "")
2026-02-20T22:09:16.2239539Z                  user_set = {u.strip().upper() for u in user_list if u.strip()}
2026-02-20T22:09:16.2239866Z                  correct_set = {c.strip().upper() for c in correct_list if c.strip()}
2026-02-20T22:09:16.2240509Z                  # Liste de nœuds (set) vs chemin (ordre) : si aucun élément ne contient "-", c'est un set
2026-02-20T22:09:16.2240658Z -                is_node_list = (
2026-02-20T22:09:16.2240812Z -                    len(correct_set) > 1
2026-02-20T22:09:16.2241055Z -                    and not any('-' in str(c) for c in correct_list)
2026-02-20T22:09:16.2241278Z +                is_node_list = len(correct_set) > 1 and not any(
2026-02-20T22:09:16.2241469Z +                    "-" in str(c) for c in correct_list
2026-02-20T22:09:16.2241582Z                  )
2026-02-20T22:09:16.2241725Z                  if is_node_list:
2026-02-20T22:09:16.2241910Z                      is_correct = user_set == correct_set
2026-02-20T22:09:16.2242045Z                  else:
2026-02-20T22:09:16.2242439Z                      # Chemin ou valeur unique : comparaison ordonnée
2026-02-20T22:09:16.2242637Z                      is_correct = user_list == correct_list
2026-02-20T22:09:16.2243726Z -                logger.debug(f"Comparaison GRAPH - User: {user_set if is_node_list else user_list}, Correct: {correct_set if is_node_list else correct_list}, Result: {is_correct}")
2026-02-20T22:09:16.2244053Z -            elif 'visual' in challenge_type or 'pattern' in challenge_type:
2026-02-20T22:09:16.2244196Z +                logger.debug(
2026-02-20T22:09:16.2245005Z +                    f"Comparaison GRAPH - User: {user_set if is_node_list else user_list}, Correct: {correct_set if is_node_list else correct_list}, Result: {is_correct}"
2026-02-20T22:09:16.2245151Z +                )
2026-02-20T22:09:16.2245453Z +            elif "visual" in challenge_type or "pattern" in challenge_type:
2026-02-20T22:09:16.2246135Z                  # PATTERN avec grille : source de vérité = analyse du pattern, pas correct_answer en base
2026-02-20T22:09:16.2246324Z                  computed_pattern_answer = None
2026-02-20T22:09:16.2246513Z -                if 'pattern' in challenge_type:
2026-02-20T22:09:16.2246680Z +                if "pattern" in challenge_type:
2026-02-20T22:09:16.2246846Z                      vd = challenge.visual_data
2026-02-20T22:09:16.2247072Z -                    if isinstance(vd, dict) and vd.get('grid'):
2026-02-20T22:09:16.2247279Z +                    if isinstance(vd, dict) and vd.get("grid"):
2026-02-20T22:09:16.2247533Z                          from app.services.challenge_validator import (
2026-02-20T22:09:16.2247792Z -                            analyze_pattern, compute_pattern_answers_multi)
2026-02-20T22:09:16.2248190Z -                        grid = vd['grid']
2026-02-20T22:09:16.2248350Z +                            analyze_pattern,
2026-02-20T22:09:16.2248554Z +                            compute_pattern_answers_multi,
2026-02-20T22:09:16.2248688Z +                        )
2026-02-20T22:09:16.2248797Z +
2026-02-20T22:09:16.2248938Z +                        grid = vd["grid"]
2026-02-20T22:09:16.2249420Z                          # Plusieurs "?" → format "O, O, X, O" (ordre ligne par ligne)
2026-02-20T22:09:16.2249691Z                          computed_multi = compute_pattern_answers_multi(grid)
2026-02-20T22:09:16.2249842Z                          if computed_multi:
2026-02-20T22:09:16.2250149Z                              computed_pattern_answer = computed_multi
2026-02-20T22:09:16.2250279Z                          else:
2026-02-20T22:09:16.2250468Z                              for i, row in enumerate(grid):
2026-02-20T22:09:16.2250686Z                                  if not isinstance(row, (list, tuple)):
2026-02-20T22:09:16.2250843Z                                      continue
2026-02-20T22:09:16.2251033Z                                  for j, cell in enumerate(row):
2026-02-20T22:09:16.2251563Z -                                    if cell == '?' or (isinstance(cell, str) and '?' in str(cell)):
2026-02-20T22:09:16.2251905Z -                                        computed_pattern_answer = analyze_pattern(grid, i, j)
2026-02-20T22:09:16.2252080Z +                                    if cell == "?" or (
2026-02-20T22:09:16.2252314Z +                                        isinstance(cell, str) and "?" in str(cell)
2026-02-20T22:09:16.2252453Z +                                    ):
2026-02-20T22:09:16.2252695Z +                                        computed_pattern_answer = analyze_pattern(
2026-02-20T22:09:16.2252858Z +                                            grid, i, j
2026-02-20T22:09:16.2253187Z +                                        )
2026-02-20T22:09:16.2253352Z                                          break
2026-02-20T22:09:16.2253574Z                                  if computed_pattern_answer is not None:
2026-02-20T22:09:16.2253717Z                                      break
2026-02-20T22:09:16.2254200Z -                effective_correct = (computed_pattern_answer or challenge.correct_answer or '').strip()
2026-02-20T22:09:16.2254351Z +                effective_correct = (
2026-02-20T22:09:16.2254643Z +                    computed_pattern_answer or challenge.correct_answer or ""
2026-02-20T22:09:16.2254779Z +                ).strip()
2026-02-20T22:09:16.2254936Z                  if computed_pattern_answer:
2026-02-20T22:09:16.2255635Z -                    logger.debug(f"PATTERN: réponse calculée depuis la grille = '{computed_pattern_answer}'")
2026-02-20T22:09:16.2255788Z +                    logger.debug(
2026-02-20T22:09:16.2256354Z +                        f"PATTERN: réponse calculée depuis la grille = '{computed_pattern_answer}'"
2026-02-20T22:09:16.2256489Z +                    )
2026-02-20T22:09:16.2256906Z                  # PATTERN multi-cellules : format "O, O, X, O" (liste de symboles, ordre des "?")
2026-02-20T22:09:16.2257060Z                  is_pattern_multi_csv = (
2026-02-20T22:09:16.2257241Z -                    'pattern' in challenge_type
2026-02-20T22:09:16.2257400Z +                    "pattern" in challenge_type
2026-02-20T22:09:16.2257555Z                      and effective_correct
2026-02-20T22:09:16.2257718Z -                    and ',' in effective_correct
2026-02-20T22:09:16.2257953Z -                    and 'position' not in effective_correct.lower()
2026-02-20T22:09:16.2258116Z +                    and "," in effective_correct
2026-02-20T22:09:16.2258337Z +                    and "position" not in effective_correct.lower()
2026-02-20T22:09:16.2258451Z                  )
2026-02-20T22:09:16.2258608Z                  if is_pattern_multi_csv:
2026-02-20T22:09:16.2258834Z                      user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2259328Z                      correct_list = parse_answer_to_list(effective_correct)
2026-02-20T22:09:16.2259610Z                      user_norm = [_normalize_shape_answer(u) for u in user_list]
2026-02-20T22:09:16.2259738Z @@ -561,64 +743,73 @@
2026-02-20T22:09:16.2259969Z                          u == c for u, c in zip(user_norm, correct_norm)
2026-02-20T22:09:16.2260086Z                      )
2026-02-20T22:09:16.2260204Z                  else:
2026-02-20T22:09:16.2260797Z                      # VISUAL/PATTERN : tolérance synonymes, format "Position 6: x, Position 9: y"
2026-02-20T22:09:16.2261065Z                      user_parts = _parse_multi_visual_answer(user_solution)
2026-02-20T22:09:16.2261407Z -                    correct_parts = _parse_multi_visual_answer(effective_correct or '')
2026-02-20T22:09:16.2261732Z +                    correct_parts = _parse_multi_visual_answer(effective_correct or "")
2026-02-20T22:09:16.2261888Z                      is_multi_position = (
2026-02-20T22:09:16.2262211Z                          len(correct_parts) > 1 and any(p[0] > 0 for p in correct_parts)
2026-02-20T22:09:16.2262338Z -                    ) or (
2026-02-20T22:09:16.2262612Z -                        len(user_parts) > 1 and any(p[0] > 0 for p in user_parts)
2026-02-20T22:09:16.2262931Z -                    )
2026-02-20T22:09:16.2263441Z +                    ) or (len(user_parts) > 1 and any(p[0] > 0 for p in user_parts))
2026-02-20T22:09:16.2263600Z                      if is_multi_position:
2026-02-20T22:09:16.2263854Z                          if len(correct_parts) == 1 and len(user_parts) == 1:
2026-02-20T22:09:16.2264115Z                              is_correct = user_parts[0][1] == correct_parts[0][1]
2026-02-20T22:09:16.2264331Z                          elif len(user_parts) == len(correct_parts):
2026-02-20T22:09:16.2264635Z                              correct_sorted = sorted(correct_parts, key=lambda x: x[0])
2026-02-20T22:09:16.2264899Z                              user_sorted = sorted(user_parts, key=lambda x: x[0])
2026-02-20T22:09:16.2265290Z -                            by_position = all(u[1] == c[1] for u, c in zip(user_sorted, correct_sorted))
2026-02-20T22:09:16.2265460Z +                            by_position = all(
2026-02-20T22:09:16.2265620Z +                                u[1] == c[1]
2026-02-20T22:09:16.2265852Z +                                for u, c in zip(user_sorted, correct_sorted)
2026-02-20T22:09:16.2265976Z +                            )
2026-02-20T22:09:16.2266259Z                              if not by_position and all(u[0] == 0 for u in user_parts):
2026-02-20T22:09:16.2266530Z                                  user_answers = {p[1] for p in user_parts if p[1]}
2026-02-20T22:09:16.2266875Z                                  correct_answers = {p[1] for p in correct_parts if p[1]}
2026-02-20T22:09:16.2267108Z                                  is_correct = user_answers == correct_answers
2026-02-20T22:09:16.2267254Z                              else:
2026-02-20T22:09:16.2267446Z                                  is_correct = by_position
2026-02-20T22:09:16.2267572Z                          else:
2026-02-20T22:09:16.2267831Z                              user_answers = {p[1] for p in user_parts if p[1]}
2026-02-20T22:09:16.2268125Z                              correct_answers = {p[1] for p in correct_parts if p[1]}
2026-02-20T22:09:16.2268616Z -                            is_correct = user_answers == correct_answers and len(user_answers) == len(correct_answers)
2026-02-20T22:09:16.2268893Z +                            is_correct = user_answers == correct_answers and len(
2026-02-20T22:09:16.2269042Z +                                user_answers
2026-02-20T22:09:16.2269210Z +                            ) == len(correct_answers)
2026-02-20T22:09:16.2269351Z                      else:
2026-02-20T22:09:16.2269585Z                          user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2269852Z                          correct_list = parse_answer_to_list(effective_correct)
2026-02-20T22:09:16.2270287Z -                        u = user_list[0] if user_list else ''
2026-02-20T22:09:16.2270514Z -                        c = correct_list[0] if correct_list else ''
2026-02-20T22:09:16.2270874Z -                        is_correct = _normalize_shape_answer(u) == _normalize_shape_answer(c)
2026-02-20T22:09:16.2271066Z +                        u = user_list[0] if user_list else ""
2026-02-20T22:09:16.2271279Z +                        c = correct_list[0] if correct_list else ""
2026-02-20T22:09:16.2271463Z +                        is_correct = _normalize_shape_answer(
2026-02-20T22:09:16.2271581Z +                            u
2026-02-20T22:09:16.2271767Z +                        ) == _normalize_shape_answer(c)
2026-02-20T22:09:16.2272107Z                  logger.debug(f"Comparaison VISUAL/PATTERN - Result: {is_correct}")
2026-02-20T22:09:16.2272227Z              else:
2026-02-20T22:09:16.2272449Z                  user_list = parse_answer_to_list(user_solution)
2026-02-20T22:09:16.2272747Z                  correct_list = parse_answer_to_list(challenge.correct_answer)
2026-02-20T22:09:16.2273524Z -                logger.debug(f"Comparaison réponse - User: {user_list}, Correct: {correct_list}")
2026-02-20T22:09:16.2273664Z +                logger.debug(
2026-02-20T22:09:16.2274381Z +                    f"Comparaison réponse - User: {user_list}, Correct: {correct_list}"
2026-02-20T22:09:16.2274518Z +                )
2026-02-20T22:09:16.2274748Z                  if len(user_list) > 1 or len(correct_list) > 1:
2026-02-20T22:09:16.2274951Z                      is_correct = user_list == correct_list
2026-02-20T22:09:16.2275077Z                  else:
2026-02-20T22:09:16.2275261Z -                    u = user_list[0] if user_list else ''
2026-02-20T22:09:16.2275478Z -                    c = correct_list[0] if correct_list else ''
2026-02-20T22:09:16.2275662Z +                    u = user_list[0] if user_list else ""
2026-02-20T22:09:16.2275857Z +                    c = correct_list[0] if correct_list else ""
2026-02-20T22:09:16.2276016Z                      is_correct = u == c
2026-02-20T22:09:16.2276139Z -            
2026-02-20T22:09:16.2276248Z +
2026-02-20T22:09:16.2276855Z              # NOTE: attempt_service_translations archivé - utiliser LogicChallengeAttempt ORM
2026-02-20T22:09:16.2277184Z              from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:16.2277297Z -            
2026-02-20T22:09:16.2277405Z +
2026-02-20T22:09:16.2277549Z              attempt_data = {
2026-02-20T22:09:16.2277691Z                  "user_id": user_id,
2026-02-20T22:09:16.2277848Z                  "challenge_id": challenge_id,
2026-02-20T22:09:16.2278010Z                  "user_solution": user_solution,
2026-02-20T22:09:16.2278167Z                  "is_correct": is_correct,
2026-02-20T22:09:16.2278319Z                  "time_spent": time_spent,
2026-02-20T22:09:16.2278694Z -                "hints_used": hints_used_count  # Utiliser le nombre d'indices, pas la liste
2026-02-20T22:09:16.2279079Z +                "hints_used": hints_used_count,  # Utiliser le nombre d'indices, pas la liste
2026-02-20T22:09:16.2279190Z              }
2026-02-20T22:09:16.2279300Z -            
2026-02-20T22:09:16.2279802Z -            logger.debug(f"Tentative d'enregistrement de challenge avec attempt_data: {attempt_data}")
2026-02-20T22:09:16.2279923Z +
2026-02-20T22:09:16.2280058Z +            logger.debug(
2026-02-20T22:09:16.2280452Z +                f"Tentative d'enregistrement de challenge avec attempt_data: {attempt_data}"
2026-02-20T22:09:16.2280569Z +            )
2026-02-20T22:09:16.2280799Z              attempt = LogicChallengeAttempt(**attempt_data)
2026-02-20T22:09:16.2280935Z              db.add(attempt)
2026-02-20T22:09:16.2281070Z              db.commit()
2026-02-20T22:09:16.2281207Z              db.refresh(attempt)
2026-02-20T22:09:16.2281636Z              logger.debug(f"Tentative challenge créée: {attempt.id}")
2026-02-20T22:09:16.2281763Z @@ -626,96 +817,115 @@
2026-02-20T22:09:16.2282593Z              # Lot C / B5 : vérifier les badges (défis logiques, mixte) après une tentative correcte
2026-02-20T22:09:16.2282740Z              new_badges = []
2026-02-20T22:09:16.2282873Z              if is_correct:
2026-02-20T22:09:16.2283199Z                  try:
2026-02-20T22:09:16.2283485Z                      from app.services.badge_service import BadgeService
2026-02-20T22:09:16.2283600Z +
2026-02-20T22:09:16.2283802Z                      badge_service = BadgeService(db)
2026-02-20T22:09:16.2284090Z                      new_badges = badge_service.check_and_award_badges(user_id)
2026-02-20T22:09:16.2284265Z                  except Exception as badge_err:
2026-02-20T22:09:16.2284707Z                      logger.warning(f"Badge check après défi: {badge_err}")
2026-02-20T22:09:16.2284825Z  
2026-02-20T22:09:16.2285330Z              # Mettre à jour la série d'entraînement (streak) — toute tentative compte
2026-02-20T22:09:16.2285447Z              try:
2026-02-20T22:09:16.2285763Z                  from app.services.streak_service import update_user_streak
2026-02-20T22:09:16.2285876Z +
2026-02-20T22:09:16.2286049Z                  update_user_streak(db, user_id)
2026-02-20T22:09:16.2286194Z              except Exception:
2026-02-20T22:09:16.2286329Z                  pass
2026-02-20T22:09:16.2286686Z  
2026-02-20T22:09:16.2287220Z              # Notification « Tu approches » si pas de nouveau badge mais un proche
2026-02-20T22:09:16.2287381Z              progress_notif = None
2026-02-20T22:09:16.2287516Z              if not new_badges:
2026-02-20T22:09:16.2287636Z                  try:
2026-02-20T22:09:16.2287905Z                      from app.services.badge_service import BadgeService
2026-02-20T22:09:16.2288014Z +
2026-02-20T22:09:16.2288168Z                      svc = BadgeService(db)
2026-02-20T22:09:16.2288499Z                      progress_notif = svc.get_closest_progress_notification(user_id)
2026-02-20T22:09:16.2288653Z                  except Exception:
2026-02-20T22:09:16.2288802Z                      pass
2026-02-20T22:09:16.2288912Z  
2026-02-20T22:09:16.2289064Z              response_data = {
2026-02-20T22:09:16.2289225Z -                'is_correct': is_correct,
2026-02-20T22:09:16.2289591Z -                'explanation': challenge.solution_explanation if is_correct else None,
2026-02-20T22:09:16.2289765Z -                'new_badges': new_badges,
2026-02-20T22:09:16.2289913Z +                "is_correct": is_correct,
2026-02-20T22:09:16.2290267Z +                "explanation": challenge.solution_explanation if is_correct else None,
2026-02-20T22:09:16.2290418Z +                "new_badges": new_badges,
2026-02-20T22:09:16.2290543Z              }
2026-02-20T22:09:16.2290683Z              if progress_notif:
2026-02-20T22:09:16.2290953Z -                response_data['progress_notification'] = progress_notif
2026-02-20T22:09:16.2291074Z -            
2026-02-20T22:09:16.2291339Z +                response_data["progress_notification"] = progress_notif
2026-02-20T22:09:16.2291456Z +
2026-02-20T22:09:16.2291592Z              if not is_correct:
2026-02-20T22:09:16.2292410Z                  # Ne pas révéler la bonne réponse immédiatement, mais la donner dans l'explication après plusieurs tentatives
2026-02-20T22:09:16.2292804Z -                hints_list = challenge.hints if isinstance(challenge.hints, list) else []
2026-02-20T22:09:16.2293350Z -                response_data['hints_remaining'] = len(hints_list) - hints_used_count
2026-02-20T22:09:16.2293478Z -            
2026-02-20T22:09:16.2293611Z +                hints_list = (
2026-02-20T22:09:16.2293919Z +                    challenge.hints if isinstance(challenge.hints, list) else []
2026-02-20T22:09:16.2294048Z +                )
2026-02-20T22:09:16.2294380Z +                response_data["hints_remaining"] = len(hints_list) - hints_used_count
2026-02-20T22:09:16.2294487Z +
2026-02-20T22:09:16.2294672Z              return JSONResponse(response_data)
2026-02-20T22:09:16.2294807Z      except ValueError:
2026-02-20T22:09:16.2295565Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2295753Z      except Exception as submission_error:
2026-02-20T22:09:16.2296290Z          logger.error(f"Erreur lors de la soumission de la réponse: {submission_error}")
2026-02-20T22:09:16.2296444Z          import traceback
2026-02-20T22:09:16.2296555Z +
2026-02-20T22:09:16.2296737Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.2297184Z -        return JSONResponse({"error": get_safe_error_message(submission_error)}, status_code=500)
2026-02-20T22:09:16.2297332Z +        return JSONResponse(
2026-02-20T22:09:16.2297654Z +            {"error": get_safe_error_message(submission_error)}, status_code=500
2026-02-20T22:09:16.2297771Z +        )
2026-02-20T22:09:16.2297881Z  
2026-02-20T22:09:16.2297992Z  
2026-02-20T22:09:16.2298208Z  async def get_challenge_hint(request: Request):
2026-02-20T22:09:16.2298320Z      """
2026-02-20T22:09:16.2298632Z      Récupère un indice pour un défi logique.
2026-02-20T22:09:16.2298865Z      Route: GET /api/challenges/{challenge_id}/hint
2026-02-20T22:09:16.2298978Z      """
2026-02-20T22:09:16.2299091Z      try:
2026-02-20T22:09:16.2299384Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2299830Z -        level = int(request.query_params.get('level', 1))
2026-02-20T22:09:16.2299955Z -        
2026-02-20T22:09:16.2300250Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2300471Z +        level = int(request.query_params.get("level", 1))
2026-02-20T22:09:16.2300576Z +
2026-02-20T22:09:16.2300725Z          async with db_session() as db:
2026-02-20T22:09:16.2301051Z              challenge = LogicChallengeService.get_challenge(db, challenge_id)
2026-02-20T22:09:16.2301198Z              if not challenge:
2026-02-20T22:09:16.2301761Z -                return JSONResponse({"error": "Défi logique non trouvé"}, status_code=404)
2026-02-20T22:09:16.2301882Z -            
2026-02-20T22:09:16.2302056Z +                return JSONResponse(
2026-02-20T22:09:16.2302439Z +                    {"error": "Défi logique non trouvé"}, status_code=404
2026-02-20T22:09:16.2302557Z +                )
2026-02-20T22:09:16.2302672Z +
2026-02-20T22:09:16.2302885Z              # Récupérer les indices
2026-02-20T22:09:16.2303226Z              hints = challenge.hints
2026-02-20T22:09:16.2303379Z              if isinstance(hints, str):
2026-02-20T22:09:16.2303506Z                  try:
2026-02-20T22:09:16.2303668Z                      hints = json.loads(hints)
2026-02-20T22:09:16.2303886Z                  except (json.JSONDecodeError, ValueError):
2026-02-20T22:09:16.2304285Z                      # Si le parsing échoue, traiter comme une liste vide
2026-02-20T22:09:16.2304413Z                      hints = []
2026-02-20T22:09:16.2304547Z              elif hints is None:
2026-02-20T22:09:16.2304672Z                  hints = []
2026-02-20T22:09:16.2304792Z -            
2026-02-20T22:09:16.2304902Z +
2026-02-20T22:09:16.2305090Z              # S'assurer que hints est une liste
2026-02-20T22:09:16.2305261Z              if not isinstance(hints, list):
2026-02-20T22:09:16.2305382Z                  hints = []
2026-02-20T22:09:16.2305487Z -            
2026-02-20T22:09:16.2305601Z +
2026-02-20T22:09:16.2305773Z              if level < 1 or level > len(hints):
2026-02-20T22:09:16.2306259Z -                return JSONResponse({"error": f"Indice de niveau {level} non disponible"}, status_code=400)
2026-02-20T22:09:16.2306375Z -            
2026-02-20T22:09:16.2306539Z +                return JSONResponse(
2026-02-20T22:09:16.2306796Z +                    {"error": f"Indice de niveau {level} non disponible"},
2026-02-20T22:09:16.2306938Z +                    status_code=400,
2026-02-20T22:09:16.2307064Z +                )
2026-02-20T22:09:16.2307172Z +
2026-02-20T22:09:16.2307660Z              # Retourner l'indice spécifique au niveau demandé (index 0-based)
2026-02-20T22:09:16.2307952Z              hint_text = hints[level - 1] if level <= len(hints) else None
2026-02-20T22:09:16.2308801Z -            return JSONResponse({"hint": hint_text})  # Retourner l'indice spécifique au niveau
2026-02-20T22:09:16.2308957Z +            return JSONResponse(
2026-02-20T22:09:16.2309094Z +                {"hint": hint_text}
2026-02-20T22:09:16.2309417Z +            )  # Retourner l'indice spécifique au niveau
2026-02-20T22:09:16.2309556Z      except ValueError:
2026-02-20T22:09:16.2310084Z          return JSONResponse({"error": "ID de défi ou niveau invalide"}, status_code=400)
2026-02-20T22:09:16.2310285Z      except Exception as hint_retrieval_error:
2026-02-20T22:09:16.2310846Z -        logger.error(f"Erreur lors de la récupération de l'indice: {hint_retrieval_error}")
2026-02-20T22:09:16.2310984Z +        logger.error(
2026-02-20T22:09:16.2311460Z +            f"Erreur lors de la récupération de l'indice: {hint_retrieval_error}"
2026-02-20T22:09:16.2311583Z +        )
2026-02-20T22:09:16.2311734Z          traceback.print_exc()
2026-02-20T22:09:16.2312229Z -        return JSONResponse({"error": get_safe_error_message(hint_retrieval_error)}, status_code=500)
2026-02-20T22:09:16.2312385Z +        return JSONResponse(
2026-02-20T22:09:16.2312713Z +            {"error": get_safe_error_message(hint_retrieval_error)}, status_code=500
2026-02-20T22:09:16.2313294Z +        )
2026-02-20T22:09:16.2313437Z  
2026-02-20T22:09:16.2313543Z  
2026-02-20T22:09:16.2313679Z  @optional_auth
2026-02-20T22:09:16.2313943Z  async def get_completed_challenges_ids(request: Request):
2026-02-20T22:09:16.2314065Z      """
2026-02-20T22:09:16.2314192Z @@ -724,17 +934,18 @@
2026-02-20T22:09:16.2314302Z      """
2026-02-20T22:09:16.2314423Z      try:
2026-02-20T22:09:16.2314592Z          current_user = request.state.user
2026-02-20T22:09:16.2314730Z          if not current_user:
2026-02-20T22:09:16.2315016Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:16.2315138Z -        
2026-02-20T22:09:16.2315245Z +
2026-02-20T22:09:16.2315412Z          user_id = current_user.get("id")
2026-02-20T22:09:16.2315550Z          if not user_id:
2026-02-20T22:09:16.2315831Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:16.2315941Z -        
2026-02-20T22:09:16.2316056Z +
2026-02-20T22:09:16.2316565Z          # Récupérer les IDs de challenges avec au moins une tentative correcte
2026-02-20T22:09:16.2316788Z          from server.database import get_db_connection
2026-02-20T22:09:16.2316901Z +
2026-02-20T22:09:16.2317047Z          conn = get_db_connection()
2026-02-20T22:09:16.2317177Z          cursor = conn.cursor()
2026-02-20T22:09:16.2317287Z          try:
2026-02-20T22:09:16.2317788Z              # D'abord, vérifier combien de tentatives existent pour cet utilisateur
2026-02-20T22:09:16.2317935Z              check_query = """
2026-02-20T22:09:16.2318055Z @@ -743,36 +954,42 @@
2026-02-20T22:09:16.2318228Z                  FROM logic_challenge_attempts 
2026-02-20T22:09:16.2318378Z                  WHERE user_id = %s
2026-02-20T22:09:16.2318506Z              """
2026-02-20T22:09:16.2318698Z              cursor.execute(check_query, (user_id,))
2026-02-20T22:09:16.2318862Z              stats = cursor.fetchone()
2026-02-20T22:09:16.2319363Z -            logger.debug(f"Statistiques pour user_id {user_id}: total={stats[0]}, correctes={stats[1]}")
2026-02-20T22:09:16.2319484Z -            
2026-02-20T22:09:16.2319631Z +            logger.debug(
2026-02-20T22:09:16.2320036Z +                f"Statistiques pour user_id {user_id}: total={stats[0]}, correctes={stats[1]}"
2026-02-20T22:09:16.2320150Z +            )
2026-02-20T22:09:16.2320258Z +
2026-02-20T22:09:16.2320659Z              # Ensuite, récupérer les IDs de challenges complétés
2026-02-20T22:09:16.2320792Z              query = """
2026-02-20T22:09:16.2320963Z                  SELECT DISTINCT challenge_id 
2026-02-20T22:09:16.2321139Z                  FROM logic_challenge_attempts 
2026-02-20T22:09:16.2321335Z                  WHERE user_id = %s AND is_correct = true
2026-02-20T22:09:16.2321690Z              """
2026-02-20T22:09:16.2321863Z              cursor.execute(query, (user_id,))
2026-02-20T22:09:16.2322021Z              rows = cursor.fetchall()
2026-02-20T22:09:16.2322259Z              completed_ids = [row[0] for row in rows] if rows else []
2026-02-20T22:09:16.2322379Z -            
2026-02-20T22:09:16.2323293Z -            logger.debug(f"Récupération de {len(completed_ids)} challenges complétés pour l'utilisateur {user_id}")
2026-02-20T22:09:16.2323403Z +
2026-02-20T22:09:16.2323535Z +            logger.debug(
2026-02-20T22:09:16.2324174Z +                f"Récupération de {len(completed_ids)} challenges complétés pour l'utilisateur {user_id}"
2026-02-20T22:09:16.2324297Z +            )
2026-02-20T22:09:16.2324648Z              logger.debug(f"IDs complétés: {completed_ids}")
2026-02-20T22:09:16.2324913Z              return JSONResponse({"completed_ids": completed_ids})
2026-02-20T22:09:16.2325043Z          finally:
2026-02-20T22:09:16.2325177Z              cursor.close()
2026-02-20T22:09:16.2325324Z              conn.close()
2026-02-20T22:09:16.2325446Z -            
2026-02-20T22:09:16.2325554Z +
2026-02-20T22:09:16.2325765Z      except Exception as completed_challenges_error:
2026-02-20T22:09:16.2326714Z -        logger.error(f"Erreur lors de la récupération des challenges complétés: {completed_challenges_error}")
2026-02-20T22:09:16.2326872Z +        logger.error(
2026-02-20T22:09:16.2327514Z +            f"Erreur lors de la récupération des challenges complétés: {completed_challenges_error}"
2026-02-20T22:09:16.2327638Z +        )
2026-02-20T22:09:16.2327831Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:16.2328036Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:16.2328210Z              error=completed_challenges_error,
2026-02-20T22:09:16.2328357Z              status_code=500,
2026-02-20T22:09:16.2328880Z -            user_message="Erreur lors de la récupération des challenges complétés."
2026-02-20T22:09:16.2329378Z +            user_message="Erreur lors de la récupération des challenges complétés.",
2026-02-20T22:09:16.2329520Z          )
2026-02-20T22:09:16.2329631Z  
2026-02-20T22:09:16.2329736Z  
2026-02-20T22:09:16.2329860Z  @require_auth
2026-02-20T22:09:16.2330057Z  async def start_challenge(request: Request):
2026-02-20T22:09:16.2330194Z @@ -780,18 +997,22 @@
2026-02-20T22:09:16.2330507Z      Handler pour démarrer un défi (placeholder).
2026-02-20T22:09:16.2330733Z      Route: POST /api/challenges/start/{challenge_id}
2026-02-20T22:09:16.2330849Z      """
2026-02-20T22:09:16.2330960Z      try:
2026-02-20T22:09:16.2331122Z          current_user = request.state.user
2026-02-20T22:09:16.2331244Z -        
2026-02-20T22:09:16.2331534Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2331691Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2332441Z -        logger.info(f"Défi {challenge_id} démarré par l'utilisateur {user_id}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2332571Z +
2026-02-20T22:09:16.2332854Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2333205Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2333342Z +        logger.info(
2026-02-20T22:09:16.2334005Z +            f"Défi {challenge_id} démarré par l'utilisateur {user_id}. Fonctionnalité en développement."
2026-02-20T22:09:16.2334122Z +        )
2026-02-20T22:09:16.2334241Z  
2026-02-20T22:09:16.2334387Z          return JSONResponse(
2026-02-20T22:09:16.2335431Z -            {"message": f"Le défi {challenge_id} a été enregistré comme démarré pour l'utilisateur {user_id}. La fonctionnalité est en cours de développement."},
2026-02-20T22:09:16.2335580Z -            status_code=200
2026-02-20T22:09:16.2335692Z +            {
2026-02-20T22:09:16.2336726Z +                "message": f"Le défi {challenge_id} a été enregistré comme démarré pour l'utilisateur {user_id}. La fonctionnalité est en cours de développement."
2026-02-20T22:09:16.2337098Z +            },
2026-02-20T22:09:16.2337233Z +            status_code=200,
2026-02-20T22:09:16.2337342Z          )
2026-02-20T22:09:16.2337483Z      except ValueError:
2026-02-20T22:09:16.2337988Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2338145Z      except Exception as e:
2026-02-20T22:09:16.2338503Z          logger.error(f"Erreur lors du démarrage du défi: {e}")
2026-02-20T22:09:16.2338640Z @@ -805,18 +1026,22 @@
2026-02-20T22:09:16.2339230Z      Handler pour récupérer la progression d'un défi pour l'utilisateur actuel (placeholder).
2026-02-20T22:09:16.2339461Z      Route: GET /api/challenges/progress/{challenge_id}
2026-02-20T22:09:16.2339588Z      """
2026-02-20T22:09:16.2339706Z      try:
2026-02-20T22:09:16.2339873Z          current_user = request.state.user
2026-02-20T22:09:16.2339984Z -        
2026-02-20T22:09:16.2340279Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2340434Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2341327Z -        logger.info(f"Accès à la progression du défi {challenge_id} pour l'utilisateur {user_id}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2341453Z +
2026-02-20T22:09:16.2341736Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2342097Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2342238Z +        logger.info(
2026-02-20T22:09:16.2343232Z +            f"Accès à la progression du défi {challenge_id} pour l'utilisateur {user_id}. Fonctionnalité en développement."
2026-02-20T22:09:16.2343357Z +        )
2026-02-20T22:09:16.2343496Z  
2026-02-20T22:09:16.2343725Z          return JSONResponse(
2026-02-20T22:09:16.2344712Z -            {"message": f"La fonctionnalité de progression pour le défi {challenge_id} pour l'utilisateur {user_id} est en cours de développement."},
2026-02-20T22:09:16.2344859Z -            status_code=200
2026-02-20T22:09:16.2344983Z +            {
2026-02-20T22:09:16.2345968Z +                "message": f"La fonctionnalité de progression pour le défi {challenge_id} pour l'utilisateur {user_id} est en cours de développement."
2026-02-20T22:09:16.2346089Z +            },
2026-02-20T22:09:16.2346235Z +            status_code=200,
2026-02-20T22:09:16.2346348Z          )
2026-02-20T22:09:16.2346504Z      except ValueError:
2026-02-20T22:09:16.2347010Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2347171Z      except Exception as e:
2026-02-20T22:09:16.2347708Z          logger.error(f"Erreur lors de la récupération de la progression du défi: {e}")
2026-02-20T22:09:16.2347842Z @@ -830,17 +1055,21 @@
2026-02-20T22:09:16.2348294Z      Handler pour récupérer les récompenses d'un défi (placeholder).
2026-02-20T22:09:16.2348516Z      Route: GET /api/challenges/rewards/{challenge_id}
2026-02-20T22:09:16.2348627Z      """
2026-02-20T22:09:16.2348737Z      try:
2026-02-20T22:09:16.2348908Z          current_user = request.state.user
2026-02-20T22:09:16.2349040Z -        
2026-02-20T22:09:16.2349331Z -        challenge_id = int(request.path_params.get('challenge_id'))
2026-02-20T22:09:16.2350417Z -        logger.info(f"Accès aux récompenses du défi {challenge_id} par l'utilisateur {current_user.get('id')}. Fonctionnalité en développement.")
2026-02-20T22:09:16.2350549Z +
2026-02-20T22:09:16.2350842Z +        challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:16.2350983Z +        logger.info(
2026-02-20T22:09:16.2351880Z +            f"Accès aux récompenses du défi {challenge_id} par l'utilisateur {current_user.get('id')}. Fonctionnalité en développement."
2026-02-20T22:09:16.2352003Z +        )
2026-02-20T22:09:16.2352110Z  
2026-02-20T22:09:16.2352259Z          return JSONResponse(
2026-02-20T22:09:16.2623415Z -            {"message": f"La fonctionnalité de récompenses pour le défi {challenge_id} est en cours de développement."},
2026-02-20T22:09:16.2623664Z -            status_code=200
2026-02-20T22:09:16.2624145Z +            {
2026-02-20T22:09:16.2625044Z +                "message": f"La fonctionnalité de récompenses pour le défi {challenge_id} est en cours de développement."
2026-02-20T22:09:16.2625164Z +            },
2026-02-20T22:09:16.2625310Z +            status_code=200,
2026-02-20T22:09:16.2625419Z          )
2026-02-20T22:09:16.2625750Z      except ValueError:
2026-02-20T22:09:16.2626251Z          return JSONResponse({"error": "ID de défi invalide"}, status_code=400)
2026-02-20T22:09:16.2626405Z      except Exception as e:
2026-02-20T22:09:16.2626907Z          logger.error(f"Erreur lors de la récupération des récompenses du défi: {e}")
2026-02-20T22:09:16.2627029Z @@ -854,43 +1083,70 @@
2026-02-20T22:09:16.2627346Z      Génère un challenge avec OpenAI en streaming SSE.
2026-02-20T22:09:16.2627667Z      Délègue la logique au service challenge_ai_service.
2026-02-20T22:09:16.2627772Z      """
2026-02-20T22:09:16.2627895Z      try:
2026-02-20T22:09:16.2628054Z          current_user = request.state.user
2026-02-20T22:09:16.2628447Z -        challenge_type_raw = request.query_params.get('challenge_type', 'sequence')
2026-02-20T22:09:16.2628733Z -        age_group_raw = request.query_params.get('age_group', '10-12')
2026-02-20T22:09:16.2628981Z -        prompt_raw = request.query_params.get('prompt', '')
2026-02-20T22:09:16.2629106Z -
2026-02-20T22:09:16.2629546Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:16.2629918Z +        challenge_type_raw = request.query_params.get("challenge_type", "sequence")
2026-02-20T22:09:16.2630198Z +        age_group_raw = request.query_params.get("age_group", "10-12")
2026-02-20T22:09:16.2630427Z +        prompt_raw = request.query_params.get("prompt", "")
2026-02-20T22:09:16.2630543Z +
2026-02-20T22:09:16.2630734Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:16.2630876Z +            sanitize_user_prompt,
2026-02-20T22:09:16.2631013Z +            validate_prompt_safety,
2026-02-20T22:09:16.2631134Z +        )
2026-02-20T22:09:16.2631421Z          from app.utils.sse_utils import SSE_HEADERS, sse_error_response
2026-02-20T22:09:16.2631925Z -        from app.services.challenge_ai_service import generate_challenge_stream as svc_generate_stream
2026-02-20T22:09:16.2632162Z +        from app.services.challenge_ai_service import (
2026-02-20T22:09:16.2632389Z +            generate_challenge_stream as svc_generate_stream,
2026-02-20T22:09:16.2632497Z +        )
2026-02-20T22:09:16.2632605Z  
2026-02-20T22:09:16.2632881Z          is_safe, safety_reason = validate_prompt_safety(prompt_raw)
2026-02-20T22:09:16.2633308Z          if not is_safe:
2026-02-20T22:09:16.2633881Z              logger.warning(f"Prompt utilisateur rejeté pour sécurité: {safety_reason}")
2026-02-20T22:09:16.2634192Z              return sse_error_response(f"Prompt invalide: {safety_reason}")
2026-02-20T22:09:16.2634299Z  
2026-02-20T22:09:16.2634492Z          prompt = sanitize_user_prompt(prompt_raw)
2026-02-20T22:09:16.2634605Z  
2026-02-20T22:09:16.2634810Z          challenge_type = challenge_type_raw.lower()
2026-02-20T22:09:16.2635416Z -        valid_types = ['sequence', 'pattern', 'visual', 'puzzle', 'graph', 'riddle', 'deduction', 'chess', 'coding', 'probability']
2026-02-20T22:09:16.2635555Z +        valid_types = [
2026-02-20T22:09:16.2635685Z +            "sequence",
2026-02-20T22:09:16.2635808Z +            "pattern",
2026-02-20T22:09:16.2635925Z +            "visual",
2026-02-20T22:09:16.2636053Z +            "puzzle",
2026-02-20T22:09:16.2636162Z +            "graph",
2026-02-20T22:09:16.2636274Z +            "riddle",
2026-02-20T22:09:16.2636400Z +            "deduction",
2026-02-20T22:09:16.2636515Z +            "chess",
2026-02-20T22:09:16.2636626Z +            "coding",
2026-02-20T22:09:16.2636754Z +            "probability",
2026-02-20T22:09:16.2636872Z +        ]
2026-02-20T22:09:16.2637046Z          if challenge_type not in valid_types:
2026-02-20T22:09:16.2637806Z -            logger.warning(f"Type de challenge invalide: {challenge_type_raw}, utilisation de 'sequence' par défaut")
2026-02-20T22:09:16.2638203Z -            challenge_type = 'sequence'
2026-02-20T22:09:16.2638340Z +            logger.warning(
2026-02-20T22:09:16.2638974Z +                f"Type de challenge invalide: {challenge_type_raw}, utilisation de 'sequence' par défaut"
2026-02-20T22:09:16.2639322Z +            )
2026-02-20T22:09:16.2639487Z +            challenge_type = "sequence"
2026-02-20T22:09:16.2639595Z  
2026-02-20T22:09:16.2639866Z          normalized_age_group = normalize_age_group(age_group_raw)
2026-02-20T22:09:16.2640381Z -        age_group = normalized_age_group if normalized_age_group else constants.AgeGroups.GROUP_6_8
2026-02-20T22:09:16.2640484Z -
2026-02-20T22:09:16.2640638Z -        user_id = current_user.get('id')
2026-02-20T22:09:16.2640768Z +        age_group = (
2026-02-20T22:09:16.2640908Z +            normalized_age_group
2026-02-20T22:09:16.2641047Z +            if normalized_age_group
2026-02-20T22:09:16.2641221Z +            else constants.AgeGroups.GROUP_6_8
2026-02-20T22:09:16.2641345Z +        )
2026-02-20T22:09:16.2641450Z +
2026-02-20T22:09:16.2641600Z +        user_id = current_user.get("id")
2026-02-20T22:09:16.2641729Z          if user_id:
2026-02-20T22:09:16.2641953Z              from app.utils.rate_limiter import rate_limiter
2026-02-20T22:09:16.2642065Z +
2026-02-20T22:09:16.2642342Z              allowed, rate_limit_reason = rate_limiter.check_rate_limit(
2026-02-20T22:09:16.2642569Z                  user_id=user_id, max_per_hour=10, max_per_day=50
2026-02-20T22:09:16.2642678Z              )
2026-02-20T22:09:16.2642802Z              if not allowed:
2026-02-20T22:09:16.2643438Z -                logger.warning(f"Rate limit atteint pour utilisateur {user_id}: {rate_limit_reason}")
2026-02-20T22:09:16.2644022Z -                return sse_error_response(f"Limite de génération atteinte: {rate_limit_reason}")
2026-02-20T22:09:16.2644159Z +                logger.warning(
2026-02-20T22:09:16.2644507Z +                    f"Rate limit atteint pour utilisateur {user_id}: {rate_limit_reason}"
2026-02-20T22:09:16.2644627Z +                )
2026-02-20T22:09:16.2644769Z +                return sse_error_response(
2026-02-20T22:09:16.2645129Z +                    f"Limite de génération atteinte: {rate_limit_reason}"
2026-02-20T22:09:16.2645242Z +                )
2026-02-20T22:09:16.2645345Z  
2026-02-20T22:09:16.2645503Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:16.2645904Z              return sse_error_response("OpenAI API key non configurée")
2026-02-20T22:09:16.2646010Z  
2026-02-20T22:09:16.2646303Z          accept_language = request.headers.get("Accept-Language", "fr")
2026-02-20T22:09:16.3695800Z --- /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:16.3698797Z +++ /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py	2026-02-20 22:09:16.366252+00:00
2026-02-20T22:09:16.3718187Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py
2026-02-20T22:09:16.3719047Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.3719336Z  """
2026-02-20T22:09:16.3719986Z  Handlers pour les recommandations personnalisées.
2026-02-20T22:09:16.3720482Z  """
2026-02-20T22:09:16.3720751Z +
2026-02-20T22:09:16.3721039Z  import traceback
2026-02-20T22:09:16.3721421Z  from datetime import datetime, timezone
2026-02-20T22:09:16.3721840Z  
2026-02-20T22:09:16.3722168Z  from starlette.responses import JSONResponse
2026-02-20T22:09:16.3722616Z  
2026-02-20T22:09:16.3722863Z @@ -27,20 +28,26 @@
2026-02-20T22:09:16.3723493Z          user_id = current_user.get("id")
2026-02-20T22:09:16.3724500Z          if not user_id:
2026-02-20T22:09:16.3728927Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3729631Z  
2026-02-20T22:09:16.3729938Z          async with db_session() as db:
2026-02-20T22:09:16.3730728Z -            recommendations = RecommendationService.get_user_recommendations(db, user_id, limit=7)
2026-02-20T22:09:16.3732199Z +            recommendations = RecommendationService.get_user_recommendations(
2026-02-20T22:09:16.3732874Z +                db, user_id, limit=7
2026-02-20T22:09:16.3733786Z +            )
2026-02-20T22:09:16.3734075Z  
2026-02-20T22:09:16.3734930Z              # Si aucune recommandation n'existe, générer de nouvelles
2026-02-20T22:09:16.3735526Z              if not recommendations:
2026-02-20T22:09:16.3735914Z                  try:
2026-02-20T22:09:16.3736427Z                      RecommendationService.generate_recommendations(db, user_id)
2026-02-20T22:09:16.3737048Z                      db.commit()
2026-02-20T22:09:16.3737784Z -                    recommendations = RecommendationService.get_user_recommendations(db, user_id, limit=7)
2026-02-20T22:09:16.3753689Z +                    recommendations = RecommendationService.get_user_recommendations(
2026-02-20T22:09:16.3754405Z +                        db, user_id, limit=7
2026-02-20T22:09:16.3754869Z +                    )
2026-02-20T22:09:16.3755246Z                  except Exception as gen_error:
2026-02-20T22:09:16.3756264Z -                    logger.error(f"Erreur lors de la génération des recommandations: {str(gen_error)}")
2026-02-20T22:09:16.3757047Z +                    logger.error(
2026-02-20T22:09:16.3757832Z +                        f"Erreur lors de la génération des recommandations: {str(gen_error)}"
2026-02-20T22:09:16.3758501Z +                    )
2026-02-20T22:09:16.3758853Z                      traceback.print_exc()
2026-02-20T22:09:16.3759305Z                      recommendations = []
2026-02-20T22:09:16.3759715Z  
2026-02-20T22:09:16.3760426Z              # Mapping difficulté → groupe d'âge (inverse du mapping age_group → difficulty)
2026-02-20T22:09:16.3761159Z              difficulty_to_age_group = {
2026-02-20T22:09:16.3762857Z @@ -48,33 +55,37 @@
2026-02-20T22:09:16.3763960Z                  "PADAWAN": "9-11",
2026-02-20T22:09:16.3793242Z                  "CHEVALIER": "12-14",
2026-02-20T22:09:16.3793767Z                  "MAITRE": "15-17",
2026-02-20T22:09:16.3794192Z                  "GRAND_MAITRE": "adulte",
2026-02-20T22:09:16.3794606Z              }
2026-02-20T22:09:16.3794887Z -            
2026-02-20T22:09:16.3795177Z +
2026-02-20T22:09:16.3795641Z              # Sérialiser les recommandations
2026-02-20T22:09:16.3796134Z              recommendations_data = []
2026-02-20T22:09:16.3796589Z              for rec in recommendations:
2026-02-20T22:09:16.3797277Z -                difficulty_str = str(rec.difficulty).upper() if rec.difficulty else "PADAWAN"
2026-02-20T22:09:16.3798081Z +                difficulty_str = (
2026-02-20T22:09:16.3798647Z +                    str(rec.difficulty).upper() if rec.difficulty else "PADAWAN"
2026-02-20T22:09:16.3799239Z +                )
2026-02-20T22:09:16.3799716Z                  age_group = difficulty_to_age_group.get(difficulty_str, "9-11")
2026-02-20T22:09:16.3800302Z -                
2026-02-20T22:09:16.3800601Z +
2026-02-20T22:09:16.3800876Z                  rec_data = {
2026-02-20T22:09:16.3801245Z                      "id": rec.id,
2026-02-20T22:09:16.3801669Z                      "exercise_type": str(rec.exercise_type),
2026-02-20T22:09:16.3802194Z                      "difficulty": difficulty_str,
2026-02-20T22:09:16.3802675Z                      "age_group": age_group,
2026-02-20T22:09:16.3803314Z                      "reason": rec.reason or "",
2026-02-20T22:09:16.3803787Z                      "priority": rec.priority,
2026-02-20T22:09:16.3804526Z -                    "recommendation_type": getattr(rec, "recommendation_type", None) or "exercise",
2026-02-20T22:09:16.3805445Z +                    "recommendation_type": getattr(rec, "recommendation_type", None)
2026-02-20T22:09:16.3806071Z +                    or "exercise",
2026-02-20T22:09:16.3806443Z                  }
2026-02-20T22:09:16.3806741Z  
2026-02-20T22:09:16.3807133Z                  # Ajouter les informations de l'exercice si disponible
2026-02-20T22:09:16.3807950Z                  if rec.exercise_id:
2026-02-20T22:09:16.3808432Z                      rec_data["exercise_id"] = rec.exercise_id
2026-02-20T22:09:16.3809235Z                      # Optionnel: récupérer le titre et la question de l'exercice
2026-02-20T22:09:16.3809839Z                      try:
2026-02-20T22:09:16.3810570Z                          from app.services.exercise_service import ExerciseService
2026-02-20T22:09:16.3811169Z +
2026-02-20T22:09:16.3811615Z                          exercise = ExerciseService.get_exercise(db, rec.exercise_id)
2026-02-20T22:09:16.3812219Z                          if exercise:
2026-02-20T22:09:16.3812715Z                              rec_data["exercise_title"] = exercise.title
2026-02-20T22:09:16.3813523Z                              rec_data["exercise_question"] = exercise.question
2026-02-20T22:09:16.3814095Z                      except Exception:
2026-02-20T22:09:16.3814501Z @@ -82,25 +93,39 @@
2026-02-20T22:09:16.3814789Z  
2026-02-20T22:09:16.3815469Z                  # Ajouter les informations du défi si disponible (recommandation challenge)
2026-02-20T22:09:16.3816219Z                  if getattr(rec, "challenge_id", None):
2026-02-20T22:09:16.3816769Z                      rec_data["challenge_id"] = rec.challenge_id
2026-02-20T22:09:16.3817251Z                      try:
2026-02-20T22:09:16.3817860Z -                        from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:16.3818803Z -                        challenge = LogicChallengeService.get_challenge(db, rec.challenge_id)
2026-02-20T22:09:16.3819608Z +                        from app.services.logic_challenge_service import (
2026-02-20T22:09:16.3820206Z +                            LogicChallengeService,
2026-02-20T22:09:16.3820653Z +                        )
2026-02-20T22:09:16.3820984Z +
2026-02-20T22:09:16.3821364Z +                        challenge = LogicChallengeService.get_challenge(
2026-02-20T22:09:16.3821959Z +                            db, rec.challenge_id
2026-02-20T22:09:16.3822404Z +                        )
2026-02-20T22:09:16.3822771Z                          if challenge:
2026-02-20T22:09:16.3853675Z -                            rec_data["challenge_title"] = getattr(challenge, "title", None)
2026-02-20T22:09:16.3854620Z -                            rec_data["exercise_title"] = rec_data.get("exercise_title") or challenge.title
2026-02-20T22:09:16.3855429Z +                            rec_data["challenge_title"] = getattr(
2026-02-20T22:09:16.3855974Z +                                challenge, "title", None
2026-02-20T22:09:16.3856443Z +                            )
2026-02-20T22:09:16.3856849Z +                            rec_data["exercise_title"] = (
2026-02-20T22:09:16.3857454Z +                                rec_data.get("exercise_title") or challenge.title
2026-02-20T22:09:16.3858002Z +                            )
2026-02-20T22:09:16.3858377Z                      except Exception:
2026-02-20T22:09:16.3858784Z                          pass
2026-02-20T22:09:16.3859129Z  
2026-02-20T22:09:16.3859472Z                  recommendations_data.append(rec_data)
2026-02-20T22:09:16.3859923Z  
2026-02-20T22:09:16.3860258Z              return JSONResponse(recommendations_data)
2026-02-20T22:09:16.3860839Z      except Exception as recommendations_retrieval_error:
2026-02-20T22:09:16.3861979Z -        logger.error(f"Erreur lors de la récupération des recommandations: {recommendations_retrieval_error}")
2026-02-20T22:09:16.3862844Z +        logger.error(
2026-02-20T22:09:16.3863830Z +            f"Erreur lors de la récupération des recommandations: {recommendations_retrieval_error}"
2026-02-20T22:09:16.3864572Z +        )
2026-02-20T22:09:16.3864867Z          traceback.print_exc()
2026-02-20T22:09:16.3865669Z -        return JSONResponse({"error": get_safe_error_message(recommendations_retrieval_error)}, status_code=500)
2026-02-20T22:09:16.3866518Z +        return JSONResponse(
2026-02-20T22:09:16.3867066Z +            {"error": get_safe_error_message(recommendations_retrieval_error)},
2026-02-20T22:09:16.3867945Z +            status_code=500,
2026-02-20T22:09:16.3868296Z +        )
2026-02-20T22:09:16.3868565Z  
2026-02-20T22:09:16.3868806Z  
2026-02-20T22:09:16.3869064Z  @require_auth
2026-02-20T22:09:16.3869419Z  async def generate_recommendations(request):
2026-02-20T22:09:16.3870063Z      """
2026-02-20T22:09:16.3870344Z @@ -112,20 +137,29 @@
2026-02-20T22:09:16.3870709Z          user_id = current_user.get("id")
2026-02-20T22:09:16.3871144Z          if not user_id:
2026-02-20T22:09:16.3871725Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3872370Z  
2026-02-20T22:09:16.3872647Z          async with db_session() as db:
2026-02-20T22:09:16.3873536Z -            recommendations = RecommendationService.generate_recommendations(db, user_id)
2026-02-20T22:09:16.3874494Z +            recommendations = RecommendationService.generate_recommendations(
2026-02-20T22:09:16.3875135Z +                db, user_id
2026-02-20T22:09:16.3875489Z +            )
2026-02-20T22:09:16.3875776Z              db.commit()
2026-02-20T22:09:16.3876131Z -            return JSONResponse({
2026-02-20T22:09:16.3876777Z -                "message": "Recommandations générées avec succès",
2026-02-20T22:09:16.3877459Z -                "count": len(recommendations) if recommendations else 0,
2026-02-20T22:09:16.3878000Z -            })
2026-02-20T22:09:16.3878326Z +            return JSONResponse(
2026-02-20T22:09:16.3878702Z +                {
2026-02-20T22:09:16.3879248Z +                    "message": "Recommandations générées avec succès",
2026-02-20T22:09:16.3879915Z +                    "count": len(recommendations) if recommendations else 0,
2026-02-20T22:09:16.3880458Z +                }
2026-02-20T22:09:16.3880745Z +            )
2026-02-20T22:09:16.3881140Z      except Exception as recommendations_generation_error:
2026-02-20T22:09:16.3882206Z -        logger.error(f"Erreur lors de la génération des recommandations: {recommendations_generation_error}")
2026-02-20T22:09:16.3913280Z +        logger.error(
2026-02-20T22:09:16.3914171Z +            f"Erreur lors de la génération des recommandations: {recommendations_generation_error}"
2026-02-20T22:09:16.3914918Z +        )
2026-02-20T22:09:16.3915223Z          traceback.print_exc()
2026-02-20T22:09:16.3916061Z -        return JSONResponse({"error": get_safe_error_message(recommendations_generation_error)}, status_code=500)
2026-02-20T22:09:16.3916948Z +        return JSONResponse(
2026-02-20T22:09:16.3917517Z +            {"error": get_safe_error_message(recommendations_generation_error)},
2026-02-20T22:09:16.3918127Z +            status_code=500,
2026-02-20T22:09:16.3918477Z +        )
2026-02-20T22:09:16.3918733Z  
2026-02-20T22:09:16.3918977Z  
2026-02-20T22:09:16.3919222Z  @require_auth
2026-02-20T22:09:16.3919612Z  async def handle_recommendation_complete(request):
2026-02-20T22:09:16.3920098Z      """
2026-02-20T22:09:16.3920360Z @@ -140,23 +174,33 @@
2026-02-20T22:09:16.3920915Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:16.3921566Z  
2026-02-20T22:09:16.3921853Z          data = await request.json()
2026-02-20T22:09:16.3922354Z          recommendation_id = data.get("recommendation_id")
2026-02-20T22:09:16.3922888Z          if recommendation_id is None:
2026-02-20T22:09:16.3923731Z -            return JSONResponse({"error": "recommendation_id manquant"}, status_code=400)
2026-02-20T22:09:16.3924441Z +            return JSONResponse(
2026-02-20T22:09:16.3924961Z +                {"error": "recommendation_id manquant"}, status_code=400
2026-02-20T22:09:16.3925488Z +            )
2026-02-20T22:09:16.3925772Z          try:
2026-02-20T22:09:16.3926131Z              recommendation_id = int(recommendation_id)
2026-02-20T22:09:16.3926653Z          except (TypeError, ValueError):
2026-02-20T22:09:16.3927333Z -            return JSONResponse({"error": "recommendation_id invalide"}, status_code=400)
2026-02-20T22:09:16.3928046Z +            return JSONResponse(
2026-02-20T22:09:16.3928826Z +                {"error": "recommendation_id invalide"}, status_code=400
2026-02-20T22:09:16.3929364Z +            )
2026-02-20T22:09:16.3929647Z  
2026-02-20T22:09:16.3929924Z          async with db_session() as db:
2026-02-20T22:09:16.3930584Z -            rec = db.query(Recommendation).filter(
2026-02-20T22:09:16.3931106Z -                Recommendation.id == recommendation_id,
2026-02-20T22:09:16.3931633Z -                Recommendation.user_id == user_id,
2026-02-20T22:09:16.3932083Z -            ).first()
2026-02-20T22:09:16.3932399Z +            rec = (
2026-02-20T22:09:16.3932741Z +                db.query(Recommendation)
2026-02-20T22:09:16.3933341Z +                .filter(
2026-02-20T22:09:16.3933773Z +                    Recommendation.id == recommendation_id,
2026-02-20T22:09:16.3934313Z +                    Recommendation.user_id == user_id,
2026-02-20T22:09:16.3934768Z +                )
2026-02-20T22:09:16.3935062Z +                .first()
2026-02-20T22:09:16.3935388Z +            )
2026-02-20T22:09:16.3935670Z              if not rec:
2026-02-20T22:09:16.3936460Z -                return JSONResponse({"error": "Recommandation non trouvée"}, status_code=404)
2026-02-20T22:09:16.3937190Z +                return JSONResponse(
2026-02-20T22:09:16.3937870Z +                    {"error": "Recommandation non trouvée"}, status_code=404
2026-02-20T22:09:16.3938419Z +                )
2026-02-20T22:09:16.3938737Z              rec.is_completed = True
2026-02-20T22:09:16.3939247Z              rec.completed_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.3939744Z              db.commit()
2026-02-20T22:09:16.3940086Z              db.refresh(rec)
2026-02-20T22:09:16.3940422Z  
2026-02-20T22:09:16.3940679Z @@ -166,6 +210,5 @@
2026-02-20T22:09:16.3940963Z          )
2026-02-20T22:09:16.3941257Z      except Exception as e:
2026-02-20T22:09:16.3942020Z          logger.error(f"Erreur lors de la gestion de la recommandation complétée: {e}")
2026-02-20T22:09:16.3942719Z          traceback.print_exc()
2026-02-20T22:09:16.3973619Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:16.3974276Z -
2026-02-20T22:09:16.9654279Z --- /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:16.9657102Z +++ /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py	2026-02-20 22:09:16.946229+00:00
2026-02-20T22:09:16.9659297Z @@ -1,8 +1,9 @@
2026-02-20T22:09:16.9660909Z  """
2026-02-20T22:09:16.9662852Z  Handlers pour l'espace admin (rôle archiviste).
2026-02-20T22:09:16.9664834Z  """
2026-02-20T22:09:16.9665517Z +
2026-02-20T22:09:16.9665830Z  import csv
2026-02-20T22:09:16.9666125Z  import io
2026-02-20T22:09:16.9666423Z  import json
2026-02-20T22:09:16.9666720Z  import os
2026-02-20T22:09:16.9667127Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:16.9667643Z @@ -63,16 +64,50 @@
2026-02-20T22:09:16.9668080Z      return JSONResponse({"status": "ok", "admin": True})
2026-02-20T22:09:16.9668646Z  
2026-02-20T22:09:16.9668972Z  
2026-02-20T22:09:16.9669643Z  # Schéma des paramètres globaux (connus et modifiables par l'admin)
2026-02-20T22:09:16.9670258Z  CONFIG_SCHEMA = {
2026-02-20T22:09:16.9671131Z -    "maintenance_mode": {"type": "bool", "default": False, "category": "système", "label": "Mode maintenance"},
2026-02-20T22:09:16.9672576Z -    "registration_enabled": {"type": "bool", "default": True, "category": "système", "label": "Inscriptions ouvertes"},
2026-02-20T22:09:16.9674363Z -    "feature_ai_challenges_enabled": {"type": "bool", "default": True, "category": "features", "label": "Défis IA activés"},
2026-02-20T22:09:16.9675849Z -    "feature_chat_enabled": {"type": "bool", "default": True, "category": "features", "label": "Chat IA activé"},
2026-02-20T22:09:16.9677501Z -    "max_generations_per_user_per_hour": {"type": "int", "default": 20, "min": 1, "max": 100, "category": "limites", "label": "Générations max/user/heure"},
2026-02-20T22:09:16.9679480Z -    "max_export_rows": {"type": "int", "default": 10000, "min": 100, "max": 100000, "category": "limites", "label": "Lignes max export CSV"},
2026-02-20T22:09:16.9680432Z +    "maintenance_mode": {
2026-02-20T22:09:16.9680810Z +        "type": "bool",
2026-02-20T22:09:16.9681161Z +        "default": False,
2026-02-20T22:09:16.9681885Z +        "category": "système",
2026-02-20T22:09:16.9682332Z +        "label": "Mode maintenance",
2026-02-20T22:09:16.9682751Z +    },
2026-02-20T22:09:16.9683258Z +    "registration_enabled": {
2026-02-20T22:09:16.9683661Z +        "type": "bool",
2026-02-20T22:09:16.9684025Z +        "default": True,
2026-02-20T22:09:16.9684499Z +        "category": "système",
2026-02-20T22:09:16.9684998Z +        "label": "Inscriptions ouvertes",
2026-02-20T22:09:16.9685434Z +    },
2026-02-20T22:09:16.9685753Z +    "feature_ai_challenges_enabled": {
2026-02-20T22:09:16.9686183Z +        "type": "bool",
2026-02-20T22:09:16.9686542Z +        "default": True,
2026-02-20T22:09:16.9686934Z +        "category": "features",
2026-02-20T22:09:16.9687450Z +        "label": "Défis IA activés",
2026-02-20T22:09:16.9687860Z +    },
2026-02-20T22:09:16.9688147Z +    "feature_chat_enabled": {
2026-02-20T22:09:16.9688526Z +        "type": "bool",
2026-02-20T22:09:16.9688864Z +        "default": True,
2026-02-20T22:09:16.9689241Z +        "category": "features",
2026-02-20T22:09:16.9690177Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py
2026-02-20T22:09:16.9691049Z +        "label": "Chat IA activé",
2026-02-20T22:09:16.9691444Z +    },
2026-02-20T22:09:16.9691752Z +    "max_generations_per_user_per_hour": {
2026-02-20T22:09:16.9692200Z +        "type": "int",
2026-02-20T22:09:16.9692536Z +        "default": 20,
2026-02-20T22:09:16.9692867Z +        "min": 1,
2026-02-20T22:09:16.9693378Z +        "max": 100,
2026-02-20T22:09:16.9693721Z +        "category": "limites",
2026-02-20T22:09:16.9694265Z +        "label": "Générations max/user/heure",
2026-02-20T22:09:16.9694731Z +    },
2026-02-20T22:09:16.9695012Z +    "max_export_rows": {
2026-02-20T22:09:16.9695371Z +        "type": "int",
2026-02-20T22:09:16.9695711Z +        "default": 10000,
2026-02-20T22:09:16.9696052Z +        "min": 100,
2026-02-20T22:09:16.9696367Z +        "max": 100000,
2026-02-20T22:09:16.9696712Z +        "category": "limites",
2026-02-20T22:09:16.9697125Z +        "label": "Lignes max export CSV",
2026-02-20T22:09:16.9697548Z +    },
2026-02-20T22:09:16.9697812Z  }
2026-02-20T22:09:16.9698061Z  
2026-02-20T22:09:16.9698312Z  
2026-02-20T22:09:16.9698816Z  def _parse_setting_value(value: str | None, schema: dict) -> bool | int | str:
2026-02-20T22:09:16.9699497Z      if value is None:
2026-02-20T22:09:16.9699836Z @@ -113,19 +148,21 @@
2026-02-20T22:09:16.9700163Z      result = []
2026-02-20T22:09:16.9700528Z      for key, schema in CONFIG_SCHEMA.items():
2026-02-20T22:09:16.9700992Z          row = by_key.get(key)
2026-02-20T22:09:16.9701407Z          raw = row.value if row else None
2026-02-20T22:09:16.9701899Z          value = _parse_setting_value(raw, schema)
2026-02-20T22:09:16.9702384Z -        result.append({
2026-02-20T22:09:16.9702741Z -            "key": key,
2026-02-20T22:09:16.9703295Z -            "value": value,
2026-02-20T22:09:16.9703675Z -            "type": schema["type"],
2026-02-20T22:09:16.9704158Z -            "category": schema.get("category", ""),
2026-02-20T22:09:16.9704683Z -            "label": schema.get("label", key),
2026-02-20T22:09:16.9705157Z -            "min": schema.get("min"),
2026-02-20T22:09:16.9705592Z -            "max": schema.get("max"),
2026-02-20T22:09:16.9705976Z -        })
2026-02-20T22:09:16.9706274Z +        result.append(
2026-02-20T22:09:16.9706589Z +            {
2026-02-20T22:09:16.9706886Z +                "key": key,
2026-02-20T22:09:16.9707244Z +                "value": value,
2026-02-20T22:09:16.9707723Z +                "type": schema["type"],
2026-02-20T22:09:16.9708206Z +                "category": schema.get("category", ""),
2026-02-20T22:09:16.9709027Z +                "label": schema.get("label", key),
2026-02-20T22:09:16.9709522Z +                "min": schema.get("min"),
2026-02-20T22:09:16.9709970Z +                "max": schema.get("max"),
2026-02-20T22:09:16.9710390Z +            }
2026-02-20T22:09:16.9710669Z +        )
2026-02-20T22:09:16.9711246Z      return JSONResponse({"settings": result})
2026-02-20T22:09:16.9711729Z  
2026-02-20T22:09:16.9711989Z  
2026-02-20T22:09:16.9712248Z  @require_auth
2026-02-20T22:09:16.9712551Z  @require_admin
2026-02-20T22:09:16.9712851Z @@ -139,11 +176,13 @@
2026-02-20T22:09:16.9713415Z          body = await request.json()
2026-02-20T22:09:16.9713844Z      except Exception:
2026-02-20T22:09:16.9714391Z          return JSONResponse({"detail": "Body JSON invalide"}, status_code=400)
2026-02-20T22:09:16.9715100Z      settings_in = body.get("settings") or {}
2026-02-20T22:09:16.9715593Z      if not isinstance(settings_in, dict):
2026-02-20T22:09:16.9716516Z -        return JSONResponse({"detail": "'settings' doit être un objet"}, status_code=400)
2026-02-20T22:09:16.9717260Z +        return JSONResponse(
2026-02-20T22:09:16.9717911Z +            {"detail": "'settings' doit être un objet"}, status_code=400
2026-02-20T22:09:16.9718472Z +        )
2026-02-20T22:09:16.9718741Z  
2026-02-20T22:09:16.9719051Z      async with db_session() as db:
2026-02-20T22:09:16.9719603Z          admin_user_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9720240Z          for key, value in settings_in.items():
2026-02-20T22:09:16.9720722Z              if key not in CONFIG_SCHEMA:
2026-02-20T22:09:16.9721157Z @@ -151,11 +190,15 @@
2026-02-20T22:09:16.9721573Z              schema = CONFIG_SCHEMA[key]
2026-02-20T22:09:16.9722047Z              str_val = _serialize_value(value)
2026-02-20T22:09:16.9722509Z              # Validation
2026-02-20T22:09:16.9722889Z              if schema["type"] == "int":
2026-02-20T22:09:16.9723569Z                  try:
2026-02-20T22:09:16.9724173Z -                    v = int(value) if not isinstance(value, (bool, type(None))) else schema["default"]
2026-02-20T22:09:16.9724905Z +                    v = (
2026-02-20T22:09:16.9725260Z +                        int(value)
2026-02-20T22:09:16.9725769Z +                        if not isinstance(value, (bool, type(None)))
2026-02-20T22:09:16.9726334Z +                        else schema["default"]
2026-02-20T22:09:16.9726779Z +                    )
2026-02-20T22:09:16.9727165Z                      if "min" in schema and v < schema["min"]:
2026-02-20T22:09:16.9727650Z                          v = schema["min"]
2026-02-20T22:09:16.9728139Z                      if "max" in schema and v > schema["max"]:
2026-02-20T22:09:16.9728647Z                          v = schema["max"]
2026-02-20T22:09:16.9729088Z                      str_val = str(v)
2026-02-20T22:09:16.9729493Z @@ -167,21 +210,27 @@
2026-02-20T22:09:16.9729965Z              row = db.query(Setting).filter(Setting.key == key).first()
2026-02-20T22:09:16.9730516Z              if row:
2026-02-20T22:09:16.9730885Z                  row.value = str_val
2026-02-20T22:09:16.9731417Z                  row.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9731910Z              else:
2026-02-20T22:09:16.9732247Z -                db.add(Setting(
2026-02-20T22:09:16.9732640Z -                    key=key,
2026-02-20T22:09:16.9733242Z -                    value=str_val,
2026-02-20T22:09:16.9733713Z -                    category=schema.get("category"),
2026-02-20T22:09:16.9734247Z -                    description=schema.get("label"),
2026-02-20T22:09:16.9734728Z -                    is_system=True,
2026-02-20T22:09:16.9735150Z -                    is_public=False,
2026-02-20T22:09:16.9735554Z -                ))
2026-02-20T22:09:16.9735861Z +                db.add(
2026-02-20T22:09:16.9736208Z +                    Setting(
2026-02-20T22:09:16.9736568Z +                        key=key,
2026-02-20T22:09:16.9736966Z +                        value=str_val,
2026-02-20T22:09:16.9737439Z +                        category=schema.get("category"),
2026-02-20T22:09:16.9738317Z +                        description=schema.get("label"),
2026-02-20T22:09:16.9738814Z +                        is_system=True,
2026-02-20T22:09:16.9739260Z +                        is_public=False,
2026-02-20T22:09:16.9739686Z +                    )
2026-02-20T22:09:16.9740233Z +                )
2026-02-20T22:09:16.9740570Z  
2026-02-20T22:09:16.9740884Z          _log_admin_action(
2026-02-20T22:09:16.9741378Z -            db, admin_user_id, "config_update", "settings", None,
2026-02-20T22:09:16.9741912Z +            db,
2026-02-20T22:09:16.9742233Z +            admin_user_id,
2026-02-20T22:09:16.9742598Z +            "config_update",
2026-02-20T22:09:16.9743186Z +            "settings",
2026-02-20T22:09:16.9743543Z +            None,
2026-02-20T22:09:16.9743941Z              {"updated_keys": list(settings_in.keys())},
2026-02-20T22:09:16.9744447Z          )
2026-02-20T22:09:16.9744793Z          db.commit()
2026-02-20T22:09:16.9745127Z  
2026-02-20T22:09:16.9745436Z      return JSONResponse({"status": "ok"})
2026-02-20T22:09:16.9745880Z @@ -194,22 +243,35 @@
2026-02-20T22:09:16.9746218Z      GET /api/admin/overview
2026-02-20T22:09:16.9746638Z      KPIs globaux de la plateforme.
2026-02-20T22:09:16.9747037Z      """
2026-02-20T22:09:16.9747356Z      async with db_session() as db:
2026-02-20T22:09:16.9747904Z          total_users = db.query(func.count(User.id)).scalar() or 0
2026-02-20T22:09:16.9748863Z -        total_exercises = db.query(func.count(Exercise.id)).filter(Exercise.is_archived == False).scalar() or 0
2026-02-20T22:09:16.9750228Z -        total_challenges = db.query(func.count(LogicChallenge.id)).filter(LogicChallenge.is_archived == False).scalar() or 0
2026-02-20T22:09:16.9751193Z +        total_exercises = (
2026-02-20T22:09:16.9751620Z +            db.query(func.count(Exercise.id))
2026-02-20T22:09:16.9752123Z +            .filter(Exercise.is_archived == False)
2026-02-20T22:09:16.9752592Z +            .scalar()
2026-02-20T22:09:16.9752927Z +            or 0
2026-02-20T22:09:16.9753421Z +        )
2026-02-20T22:09:16.9753731Z +        total_challenges = (
2026-02-20T22:09:16.9754169Z +            db.query(func.count(LogicChallenge.id))
2026-02-20T22:09:16.9754740Z +            .filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:16.9755240Z +            .scalar()
2026-02-20T22:09:16.9755567Z +            or 0
2026-02-20T22:09:16.9755853Z +        )
2026-02-20T22:09:16.9756175Z          # Tentatives (table attempts)
2026-02-20T22:09:16.9756647Z          from app.models.attempt import Attempt
2026-02-20T22:09:16.9757106Z +
2026-02-20T22:09:16.9757558Z          total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:16.9758150Z  
2026-02-20T22:09:16.9758442Z -    return JSONResponse({
2026-02-20T22:09:16.9758839Z -        "total_users": total_users,
2026-02-20T22:09:16.9759301Z -        "total_exercises": total_exercises,
2026-02-20T22:09:16.9759788Z -        "total_challenges": total_challenges,
2026-02-20T22:09:16.9760280Z -        "total_attempts": total_attempts,
2026-02-20T22:09:16.9760696Z -    })
2026-02-20T22:09:16.9760975Z +    return JSONResponse(
2026-02-20T22:09:16.9761304Z +        {
2026-02-20T22:09:16.9761611Z +            "total_users": total_users,
2026-02-20T22:09:16.9762072Z +            "total_exercises": total_exercises,
2026-02-20T22:09:16.9762561Z +            "total_challenges": total_challenges,
2026-02-20T22:09:16.9763243Z +            "total_attempts": total_attempts,
2026-02-20T22:09:16.9763652Z +        }
2026-02-20T22:09:16.9763913Z +    )
2026-02-20T22:09:16.9764169Z  
2026-02-20T22:09:16.9764427Z  
2026-02-20T22:09:16.9764685Z  @require_auth
2026-02-20T22:09:16.9764981Z  @require_admin
2026-02-20T22:09:16.9765330Z  async def admin_users(request: Request):
2026-02-20T22:09:16.9765782Z @@ -235,31 +297,38 @@
2026-02-20T22:09:16.9766175Z                      User.username.ilike(pattern),
2026-02-20T22:09:16.9766673Z                      User.email.ilike(pattern),
2026-02-20T22:09:16.9767449Z                      User.full_name.ilike(pattern),
2026-02-20T22:09:16.9767895Z                  )
2026-02-20T22:09:16.9768172Z              )
2026-02-20T22:09:16.9769229Z -        role_map = {"padawan": UserRole.PADAWAN, "maitre": UserRole.MAITRE, "gardien": UserRole.GARDIEN, "archiviste": UserRole.ARCHIVISTE}
2026-02-20T22:09:16.9770281Z +        role_map = {
2026-02-20T22:09:16.9770644Z +            "padawan": UserRole.PADAWAN,
2026-02-20T22:09:16.9771107Z +            "maitre": UserRole.MAITRE,
2026-02-20T22:09:16.9771560Z +            "gardien": UserRole.GARDIEN,
2026-02-20T22:09:16.9772030Z +            "archiviste": UserRole.ARCHIVISTE,
2026-02-20T22:09:16.9772491Z +        }
2026-02-20T22:09:16.9772803Z          if role and role in role_map:
2026-02-20T22:09:16.9773507Z              q = q.filter(User.role == role_map[role])
2026-02-20T22:09:16.9773999Z          if is_active_param is not None:
2026-02-20T22:09:16.9774576Z              is_active = str(is_active_param).lower() in ("true", "1", "yes")
2026-02-20T22:09:16.9775221Z              q = q.filter(User.is_active == is_active)
2026-02-20T22:09:16.9775682Z          total = q.count()
2026-02-20T22:09:16.9776232Z          users = q.order_by(User.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:16.9776844Z  
2026-02-20T22:09:16.9777109Z          items = []
2026-02-20T22:09:16.9777411Z          for u in users:
2026-02-20T22:09:16.9777770Z -            items.append({
2026-02-20T22:09:16.9778140Z -                "id": u.id,
2026-02-20T22:09:16.9778530Z -                "username": u.username,
2026-02-20T22:09:16.9778960Z -                "email": u.email,
2026-02-20T22:09:16.9779383Z -                "full_name": u.full_name,
2026-02-20T22:09:16.9779905Z -                "role": u.role.value if u.role else "padawan",
2026-02-20T22:09:16.9780438Z -                "is_active": u.is_active,
2026-02-20T22:09:16.9780939Z -                "is_email_verified": u.is_email_verified,
2026-02-20T22:09:16.9781589Z -                "created_at": u.created_at.isoformat() if u.created_at else None,
2026-02-20T22:09:16.9782205Z -            })
2026-02-20T22:09:16.9782508Z +            items.append(
2026-02-20T22:09:16.9782853Z +                {
2026-02-20T22:09:16.9783354Z +                    "id": u.id,
2026-02-20T22:09:16.9783757Z +                    "username": u.username,
2026-02-20T22:09:16.9784205Z +                    "email": u.email,
2026-02-20T22:09:16.9784641Z +                    "full_name": u.full_name,
2026-02-20T22:09:16.9785267Z +                    "role": u.role.value if u.role else "padawan",
2026-02-20T22:09:16.9785819Z +                    "is_active": u.is_active,
2026-02-20T22:09:16.9786334Z +                    "is_email_verified": u.is_email_verified,
2026-02-20T22:09:16.9787018Z +                    "created_at": u.created_at.isoformat() if u.created_at else None,
2026-02-20T22:09:16.9787643Z +                }
2026-02-20T22:09:16.9787953Z +            )
2026-02-20T22:09:16.9788231Z  
2026-02-20T22:09:16.9788633Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:16.9789139Z  
2026-02-20T22:09:16.9789398Z  
2026-02-20T22:09:16.9789655Z  @require_auth
2026-02-20T22:09:16.9789966Z @@ -287,17 +356,24 @@
2026-02-20T22:09:16.9790312Z          return JSONResponse(
2026-02-20T22:09:16.9791032Z              {"error": "Le champ is_active doit être un booléen."},
2026-02-20T22:09:16.9791594Z              status_code=400,
2026-02-20T22:09:16.9791956Z          )
2026-02-20T22:09:16.9792223Z  
2026-02-20T22:09:16.9793253Z -    role_map = {"padawan": UserRole.PADAWAN, "maitre": UserRole.MAITRE, "gardien": UserRole.GARDIEN, "archiviste": UserRole.ARCHIVISTE}
2026-02-20T22:09:16.9794176Z +    role_map = {
2026-02-20T22:09:16.9794535Z +        "padawan": UserRole.PADAWAN,
2026-02-20T22:09:16.9794996Z +        "maitre": UserRole.MAITRE,
2026-02-20T22:09:16.9795427Z +        "gardien": UserRole.GARDIEN,
2026-02-20T22:09:16.9795886Z +        "archiviste": UserRole.ARCHIVISTE,
2026-02-20T22:09:16.9796318Z +    }
2026-02-20T22:09:16.9796860Z      new_role = None
2026-02-20T22:09:16.9797190Z      if role_raw is not None:
2026-02-20T22:09:16.9797583Z          r = str(role_raw).strip().lower()
2026-02-20T22:09:16.9798033Z          if r not in role_map:
2026-02-20T22:09:16.9798410Z              return JSONResponse(
2026-02-20T22:09:16.9799423Z -                {"error": "Rôle invalide. Valeurs: padawan, maitre, gardien, archiviste."},
2026-02-20T22:09:16.9800111Z +                {
2026-02-20T22:09:16.9800832Z +                    "error": "Rôle invalide. Valeurs: padawan, maitre, gardien, archiviste."
2026-02-20T22:09:16.9801488Z +                },
2026-02-20T22:09:16.9801808Z                  status_code=400,
2026-02-20T22:09:16.9802165Z              )
2026-02-20T22:09:16.9802454Z          new_role = role_map[r]
2026-02-20T22:09:16.9802820Z  
2026-02-20T22:09:16.9803342Z      if is_active is None and new_role is None:
2026-02-20T22:09:16.9803821Z @@ -328,11 +404,18 @@
2026-02-20T22:09:16.9804133Z              )
2026-02-20T22:09:16.9804469Z          if is_active is not None:
2026-02-20T22:09:16.9804888Z              user.is_active = is_active
2026-02-20T22:09:16.9805327Z          if new_role is not None:
2026-02-20T22:09:16.9805721Z              user.role = new_role
2026-02-20T22:09:16.9806546Z -        _log_admin_action(db, current_user_id, "user_patch", "user", user_id, {"is_active": is_active, "role": role_raw})
2026-02-20T22:09:16.9807419Z +        _log_admin_action(
2026-02-20T22:09:16.9807760Z +            db,
2026-02-20T22:09:16.9808078Z +            current_user_id,
2026-02-20T22:09:16.9808453Z +            "user_patch",
2026-02-20T22:09:16.9808808Z +            "user",
2026-02-20T22:09:16.9809106Z +            user_id,
2026-02-20T22:09:16.9809485Z +            {"is_active": is_active, "role": role_raw},
2026-02-20T22:09:16.9809947Z +        )
2026-02-20T22:09:16.9810238Z          db.commit()
2026-02-20T22:09:16.9810576Z          db.refresh(user)
2026-02-20T22:09:16.9810914Z  
2026-02-20T22:09:16.9811183Z      result = {
2026-02-20T22:09:16.9811492Z          "id": user.id,
2026-02-20T22:09:16.9811836Z @@ -354,20 +437,25 @@
2026-02-20T22:09:16.9812185Z      async with db_session() as db:
2026-02-20T22:09:16.9812722Z          user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:16.9813466Z          if not user:
2026-02-20T22:09:16.9814222Z              return JSONResponse({"error": "Utilisateur non trouvé."}, status_code=404)
2026-02-20T22:09:16.9814888Z          if not user.is_active:
2026-02-20T22:09:16.9815837Z -            return JSONResponse({"error": "Compte désactivé, impossible d'envoyer l'email."}, status_code=400)
2026-02-20T22:09:16.9816717Z +            return JSONResponse(
2026-02-20T22:09:16.9817425Z +                {"error": "Compte désactivé, impossible d'envoyer l'email."},
2026-02-20T22:09:16.9818038Z +                status_code=400,
2026-02-20T22:09:16.9818418Z +            )
2026-02-20T22:09:16.9818715Z  
2026-02-20T22:09:16.9819050Z          reset_token = generate_verification_token()
2026-02-20T22:09:16.9819721Z          expires_at = datetime.now(timezone.utc) + timedelta(hours=1)
2026-02-20T22:09:16.9820369Z          user.password_reset_token = reset_token
2026-02-20T22:09:16.9820921Z          user.password_reset_expires_at = expires_at
2026-02-20T22:09:16.9821509Z          user.updated_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9821998Z          db.commit()
2026-02-20T22:09:16.9822301Z  
2026-02-20T22:09:16.9822882Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:16.9823869Z +        frontend_url = os.getenv(
2026-02-20T22:09:16.9824531Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:16.9825113Z +        )
2026-02-20T22:09:16.9825530Z          email_sent = EmailService.send_password_reset_email(
2026-02-20T22:09:16.9826080Z              to_email=user.email,
2026-02-20T22:09:16.9826498Z              username=user.username,
2026-02-20T22:09:16.9826927Z              reset_token=reset_token,
2026-02-20T22:09:16.9827684Z              frontend_url=frontend_url,
2026-02-20T22:09:16.9828098Z @@ -398,11 +486,13 @@
2026-02-20T22:09:16.9828619Z          verification_token = generate_verification_token()
2026-02-20T22:09:16.9829234Z          user.email_verification_token = verification_token
2026-02-20T22:09:16.9830134Z          user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:16.9830749Z          db.commit()
2026-02-20T22:09:16.9831057Z  
2026-02-20T22:09:16.9831644Z -        frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:16.9832422Z +        frontend_url = os.getenv(
2026-02-20T22:09:16.9833186Z +            "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:16.9833770Z +        )
2026-02-20T22:09:16.9834166Z          email_sent = EmailService.send_verification_email(
2026-02-20T22:09:16.9834700Z              to_email=user.email,
2026-02-20T22:09:16.9835109Z              username=user.username,
2026-02-20T22:09:16.9835591Z              verification_token=verification_token,
2026-02-20T22:09:16.9836084Z              frontend_url=frontend_url,
2026-02-20T22:09:16.9836507Z @@ -455,11 +545,13 @@
2026-02-20T22:09:16.9836819Z          if ex_ids:
2026-02-20T22:09:16.9837129Z              rows = (
2026-02-20T22:09:16.9837462Z                  db.query(
2026-02-20T22:09:16.9837861Z                      Attempt.exercise_id,
2026-02-20T22:09:16.9838393Z                      func.count(Attempt.id).label("attempt_count"),
2026-02-20T22:09:16.9839198Z -                    func.sum(case((Attempt.is_correct == True, 1), else_=0)).label("correct_count"),
2026-02-20T22:09:16.9840098Z +                    func.sum(case((Attempt.is_correct == True, 1), else_=0)).label(
2026-02-20T22:09:16.9840731Z +                        "correct_count"
2026-02-20T22:09:16.9841149Z +                    ),
2026-02-20T22:09:16.9841465Z                  )
2026-02-20T22:09:16.9841852Z                  .filter(Attempt.exercise_id.in_(ex_ids))
2026-02-20T22:09:16.9842385Z                  .group_by(Attempt.exercise_id)
2026-02-20T22:09:16.9842841Z                  .all()
2026-02-20T22:09:16.9843366Z              )
2026-02-20T22:09:16.9843661Z @@ -473,21 +565,23 @@
2026-02-20T22:09:16.9844003Z          for e in exercises:
2026-02-20T22:09:16.9844599Z              stats = attempt_stats.get(e.id, {"attempt_count": 0, "correct_count": 0})
2026-02-20T22:09:16.9845297Z              a_count = stats["attempt_count"]
2026-02-20T22:09:16.9845767Z              c_count = stats["correct_count"]
2026-02-20T22:09:16.9846406Z              success_rate = round((c_count / a_count * 100), 1) if a_count > 0 else 0.0
2026-02-20T22:09:16.9847054Z -            items.append({
2026-02-20T22:09:16.9847435Z -                "id": e.id,
2026-02-20T22:09:16.9847810Z -                "title": e.title,
2026-02-20T22:09:16.9848257Z -                "exercise_type": e.exercise_type,
2026-02-20T22:09:16.9848763Z -                "difficulty": e.difficulty,
2026-02-20T22:09:16.9849237Z -                "age_group": e.age_group,
2026-02-20T22:09:16.9849714Z -                "is_archived": e.is_archived,
2026-02-20T22:09:16.9850176Z -                "attempt_count": a_count,
2026-02-20T22:09:16.9850638Z -                "success_rate": success_rate,
2026-02-20T22:09:16.9851263Z -                "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:16.9851871Z -            })
2026-02-20T22:09:16.9852191Z +            items.append(
2026-02-20T22:09:16.9852531Z +                {
2026-02-20T22:09:16.9852855Z +                    "id": e.id,
2026-02-20T22:09:16.9853442Z +                    "title": e.title,
2026-02-20T22:09:16.9853915Z +                    "exercise_type": e.exercise_type,
2026-02-20T22:09:16.9854424Z +                    "difficulty": e.difficulty,
2026-02-20T22:09:16.9854906Z +                    "age_group": e.age_group,
2026-02-20T22:09:16.9855380Z +                    "is_archived": e.is_archived,
2026-02-20T22:09:16.9856135Z +                    "attempt_count": a_count,
2026-02-20T22:09:16.9856613Z +                    "success_rate": success_rate,
2026-02-20T22:09:16.9857253Z +                    "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:16.9857872Z +                }
2026-02-20T22:09:16.9858386Z +            )
2026-02-20T22:09:16.9858701Z  
2026-02-20T22:09:16.9859083Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:16.9859597Z  
2026-02-20T22:09:16.9859846Z  
2026-02-20T22:09:16.9860148Z  def _exercise_to_detail(e) -> dict:
2026-02-20T22:09:16.9860565Z @@ -535,11 +629,13 @@
2026-02-20T22:09:16.9860882Z      if not title:
2026-02-20T22:09:16.9861448Z          return JSONResponse({"error": "Le titre est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9862133Z      if not question:
2026-02-20T22:09:16.9862743Z          return JSONResponse({"error": "La question est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9863647Z      if not correct_answer:
2026-02-20T22:09:16.9864543Z -        return JSONResponse({"error": "La réponse correcte est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9865304Z +        return JSONResponse(
2026-02-20T22:09:16.9865988Z +            {"error": "La réponse correcte est obligatoire."}, status_code=400
2026-02-20T22:09:16.9866577Z +        )
2026-02-20T22:09:16.9866851Z  
2026-02-20T22:09:16.9867146Z      async with db_session() as db:
2026-02-20T22:09:16.9867562Z          ex = Exercise(
2026-02-20T22:09:16.9867908Z              title=title,
2026-02-20T22:09:16.9868290Z              exercise_type=exercise_type,
2026-02-20T22:09:16.9868729Z @@ -554,11 +650,13 @@
2026-02-20T22:09:16.9869062Z              ai_generated=False,
2026-02-20T22:09:16.9869439Z          )
2026-02-20T22:09:16.9869720Z          db.add(ex)
2026-02-20T22:09:16.9870018Z          db.flush()
2026-02-20T22:09:16.9870423Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9871228Z -        _log_admin_action(db, admin_id, "exercise_create", "exercise", ex.id, {"title": ex.title})
2026-02-20T22:09:16.9872003Z +        _log_admin_action(
2026-02-20T22:09:16.9872553Z +            db, admin_id, "exercise_create", "exercise", ex.id, {"title": ex.title}
2026-02-20T22:09:16.9873371Z +        )
2026-02-20T22:09:16.9873665Z          db.commit()
2026-02-20T22:09:16.9874001Z          db.refresh(ex)
2026-02-20T22:09:16.9874512Z      return JSONResponse(_exercise_to_detail(ex), status_code=201)
2026-02-20T22:09:16.9875077Z  
2026-02-20T22:09:16.9875340Z  
2026-02-20T22:09:16.9875600Z @@ -583,13 +681,23 @@
2026-02-20T22:09:16.9875964Z          data = await request.json()
2026-02-20T22:09:16.9876398Z      except Exception:
2026-02-20T22:09:16.9876970Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:16.9877592Z  
2026-02-20T22:09:16.9877873Z      allowed_str = {
2026-02-20T22:09:16.9878342Z -        "title", "exercise_type", "difficulty", "age_group", "tags",
2026-02-20T22:09:16.9879062Z -        "context_theme", "complexity", "question", "correct_answer",
2026-02-20T22:09:16.9879718Z -        "explanation", "hint", "image_url", "audio_url",
2026-02-20T22:09:16.9880203Z +        "title",
2026-02-20T22:09:16.9880527Z +        "exercise_type",
2026-02-20T22:09:16.9880881Z +        "difficulty",
2026-02-20T22:09:16.9881219Z +        "age_group",
2026-02-20T22:09:16.9881594Z +        "tags",
2026-02-20T22:09:16.9881907Z +        "context_theme",
2026-02-20T22:09:16.9882257Z +        "complexity",
2026-02-20T22:09:16.9882596Z +        "question",
2026-02-20T22:09:16.9882918Z +        "correct_answer",
2026-02-20T22:09:16.9883485Z +        "explanation",
2026-02-20T22:09:16.9883820Z +        "hint",
2026-02-20T22:09:16.9884123Z +        "image_url",
2026-02-20T22:09:16.9884450Z +        "audio_url",
2026-02-20T22:09:16.9884748Z      }
2026-02-20T22:09:16.9885152Z      allowed_bool = {"is_active", "is_archived"}
2026-02-20T22:09:16.9885642Z      allowed_json = {"choices"}
2026-02-20T22:09:16.9886347Z  
2026-02-20T22:09:16.9886624Z      update_data = {}
2026-02-20T22:09:16.9886965Z @@ -607,11 +715,18 @@
2026-02-20T22:09:16.9887282Z          if not ex:
2026-02-20T22:09:16.9888030Z              return JSONResponse({"error": "Exercice non trouvé."}, status_code=404)
2026-02-20T22:09:16.9888960Z          for k, v in update_data.items():
2026-02-20T22:09:16.9889442Z              setattr(ex, k, v)
2026-02-20T22:09:16.9889945Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9890926Z -        _log_admin_action(db, admin_id, "exercise_update", "exercise", exercise_id, {"fields": list(update_data.keys())})
2026-02-20T22:09:16.9891834Z +        _log_admin_action(
2026-02-20T22:09:16.9892192Z +            db,
2026-02-20T22:09:16.9892506Z +            admin_id,
2026-02-20T22:09:16.9892855Z +            "exercise_update",
2026-02-20T22:09:16.9893443Z +            "exercise",
2026-02-20T22:09:16.9893794Z +            exercise_id,
2026-02-20T22:09:16.9894190Z +            {"fields": list(update_data.keys())},
2026-02-20T22:09:16.9894656Z +        )
2026-02-20T22:09:16.9894938Z          db.commit()
2026-02-20T22:09:16.9895269Z          db.refresh(ex)
2026-02-20T22:09:16.9895675Z      return JSONResponse(_exercise_to_detail(ex))
2026-02-20T22:09:16.9896146Z  
2026-02-20T22:09:16.9896399Z  
2026-02-20T22:09:16.9896674Z @@ -644,11 +759,18 @@
2026-02-20T22:09:16.9897003Z              is_archived=False,
2026-02-20T22:09:16.9897366Z          )
2026-02-20T22:09:16.9897638Z          db.add(copy)
2026-02-20T22:09:16.9897939Z          db.flush()
2026-02-20T22:09:16.9898367Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9899372Z -        _log_admin_action(db, admin_id, "exercise_duplicate", "exercise", copy.id, {"from_id": exercise_id, "title": copy.title})
2026-02-20T22:09:16.9900296Z +        _log_admin_action(
2026-02-20T22:09:16.9900651Z +            db,
2026-02-20T22:09:16.9900954Z +            admin_id,
2026-02-20T22:09:16.9901298Z +            "exercise_duplicate",
2026-02-20T22:09:16.9901720Z +            "exercise",
2026-02-20T22:09:16.9902070Z +            copy.id,
2026-02-20T22:09:16.9902471Z +            {"from_id": exercise_id, "title": copy.title},
2026-02-20T22:09:16.9903147Z +        )
2026-02-20T22:09:16.9903433Z          db.commit()
2026-02-20T22:09:16.9903779Z          db.refresh(copy)
2026-02-20T22:09:16.9904196Z      return JSONResponse(_exercise_to_detail(copy))
2026-02-20T22:09:16.9904675Z  
2026-02-20T22:09:16.9904920Z  
2026-02-20T22:09:16.9905191Z @@ -661,30 +783,42 @@
2026-02-20T22:09:16.9905527Z          data = await request.json()
2026-02-20T22:09:16.9905951Z      except Exception:
2026-02-20T22:09:16.9906519Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:16.9907208Z      is_archived = data.get("is_archived")
2026-02-20T22:09:16.9907703Z      if not isinstance(is_archived, bool):
2026-02-20T22:09:16.9908694Z -        return JSONResponse({"error": "Le champ is_archived doit être un booléen."}, status_code=400)
2026-02-20T22:09:16.9909515Z +        return JSONResponse(
2026-02-20T22:09:16.9910260Z +            {"error": "Le champ is_archived doit être un booléen."}, status_code=400
2026-02-20T22:09:16.9910888Z +        )
2026-02-20T22:09:16.9911164Z  
2026-02-20T22:09:16.9911465Z      async with db_session() as db:
2026-02-20T22:09:16.9912054Z          ex = db.query(Exercise).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:16.9912649Z          if not ex:
2026-02-20T22:09:16.9913571Z              return JSONResponse({"error": "Exercice non trouvé."}, status_code=404)
2026-02-20T22:09:16.9914255Z          ex.is_archived = is_archived
2026-02-20T22:09:16.9914795Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9915708Z -        _log_admin_action(db, admin_id, "exercise_archive", "exercise", exercise_id, {"is_archived": is_archived})
2026-02-20T22:09:16.9916532Z +        _log_admin_action(
2026-02-20T22:09:16.9916891Z +            db,
2026-02-20T22:09:16.9917473Z +            admin_id,
2026-02-20T22:09:16.9917821Z +            "exercise_archive",
2026-02-20T22:09:16.9918203Z +            "exercise",
2026-02-20T22:09:16.9918547Z +            exercise_id,
2026-02-20T22:09:16.9918917Z +            {"is_archived": is_archived},
2026-02-20T22:09:16.9919331Z +        )
2026-02-20T22:09:16.9919815Z          db.commit()
2026-02-20T22:09:16.9920174Z          db.refresh(ex)
2026-02-20T22:09:16.9920502Z  
2026-02-20T22:09:16.9920787Z -    return JSONResponse({
2026-02-20T22:09:16.9921164Z -        "id": ex.id,
2026-02-20T22:09:16.9921498Z -        "title": ex.title,
2026-02-20T22:09:16.9921896Z -        "is_archived": ex.is_archived,
2026-02-20T22:09:16.9922304Z -    })
2026-02-20T22:09:16.9922593Z +    return JSONResponse(
2026-02-20T22:09:16.9922935Z +        {
2026-02-20T22:09:16.9923443Z +            "id": ex.id,
2026-02-20T22:09:16.9923793Z +            "title": ex.title,
2026-02-20T22:09:16.9924205Z +            "is_archived": ex.is_archived,
2026-02-20T22:09:16.9924629Z +        }
2026-02-20T22:09:16.9924903Z +    )
2026-02-20T22:09:16.9925171Z  
2026-02-20T22:09:16.9925416Z  
2026-02-20T22:09:16.9925768Z  # ==================== ADMIN BADGES (Lot B-1) ====================
2026-02-20T22:09:16.9926257Z +
2026-02-20T22:09:16.9926510Z  
2026-02-20T22:09:16.9926878Z  def _achievement_to_detail(a: Achievement) -> dict:
2026-02-20T22:09:16.9927599Z      """Sérialise un badge pour l'édition admin."""
2026-02-20T22:09:16.9928065Z      return {
2026-02-20T22:09:16.9928363Z          "id": a.id,
2026-02-20T22:09:16.9928676Z @@ -708,11 +842,14 @@
2026-02-20T22:09:16.9929003Z      if req is None:
2026-02-20T22:09:16.9929384Z          return False, "requirements est requis"
2026-02-20T22:09:16.9929866Z      if not isinstance(req, dict):
2026-02-20T22:09:16.9930518Z          return False, "requirements doit être un objet JSON"
2026-02-20T22:09:16.9931048Z      if len(req) == 0:
2026-02-20T22:09:16.9932039Z -        return False, "requirements doit contenir au moins une clé (attempts_count, min_attempts+success_rate, etc.)"
2026-02-20T22:09:16.9933164Z +        return (
2026-02-20T22:09:16.9933491Z +            False,
2026-02-20T22:09:16.9934362Z +            "requirements doit contenir au moins une clé (attempts_count, min_attempts+success_rate, etc.)",
2026-02-20T22:09:16.9935162Z +        )
2026-02-20T22:09:16.9935424Z  
2026-02-20T22:09:16.9935679Z      # attempts_count
2026-02-20T22:09:16.9936032Z      if "attempts_count" in req:
2026-02-20T22:09:16.9936429Z          v = req.get("attempts_count")
2026-02-20T22:09:16.9936910Z          if not isinstance(v, (int, float)) or v < 1:
2026-02-20T22:09:16.9937390Z @@ -778,11 +915,13 @@
2026-02-20T22:09:16.9937703Z      """
2026-02-20T22:09:16.9937993Z      GET /api/admin/badges
2026-02-20T22:09:16.9938422Z      Liste tous les badges (actifs et inactifs).
2026-02-20T22:09:16.9938878Z      """
2026-02-20T22:09:16.9939173Z      async with db_session() as db:
2026-02-20T22:09:16.9939894Z -        badges = db.query(Achievement).order_by(Achievement.category, Achievement.code).all()
2026-02-20T22:09:16.9940646Z +        badges = (
2026-02-20T22:09:16.9941236Z +            db.query(Achievement).order_by(Achievement.category, Achievement.code).all()
2026-02-20T22:09:16.9941916Z +        )
2026-02-20T22:09:16.9942200Z          counts = (
2026-02-20T22:09:16.9942776Z              db.query(UserAchievement.achievement_id, func.count(UserAchievement.id))
2026-02-20T22:09:16.9943780Z              .group_by(UserAchievement.achievement_id)
2026-02-20T22:09:16.9944304Z              .all()
2026-02-20T22:09:16.9944608Z          )
2026-02-20T22:09:16.9964418Z @@ -812,16 +951,20 @@
2026-02-20T22:09:16.9965020Z          return JSONResponse({"error": "Le nom est obligatoire."}, status_code=400)
2026-02-20T22:09:16.9965683Z  
2026-02-20T22:09:16.9966017Z      requirements = data.get("requirements")
2026-02-20T22:09:16.9966555Z      ok, err = _validate_requirements(requirements)
2026-02-20T22:09:16.9967021Z      if not ok:
2026-02-20T22:09:16.9967573Z -        return JSONResponse({"error": err or "Requirements invalides."}, status_code=400)
2026-02-20T22:09:16.9968566Z +        return JSONResponse(
2026-02-20T22:09:16.9969110Z +            {"error": err or "Requirements invalides."}, status_code=400
2026-02-20T22:09:16.9969676Z +        )
2026-02-20T22:09:16.9969951Z  
2026-02-20T22:09:16.9970459Z      async with db_session() as db:
2026-02-20T22:09:16.9971121Z          existing = db.query(Achievement).filter(Achievement.code == code).first()
2026-02-20T22:09:16.9971782Z          if existing:
2026-02-20T22:09:16.9972584Z -            return JSONResponse({"error": f"Le code '{code}' existe déjà."}, status_code=409)
2026-02-20T22:09:16.9973669Z +            return JSONResponse(
2026-02-20T22:09:16.9976228Z +                {"error": f"Le code '{code}' existe déjà."}, status_code=409
2026-02-20T22:09:16.9978647Z +            )
2026-02-20T22:09:16.9978962Z  
2026-02-20T22:09:16.9979242Z          a = Achievement(
2026-02-20T22:09:16.9979614Z              code=code,
2026-02-20T22:09:16.9982118Z              name=name,
2026-02-20T22:09:16.9984386Z              description=(data.get("description") or "").strip() or None,
2026-02-20T22:09:16.9986525Z @@ -835,11 +978,18 @@
2026-02-20T22:09:16.9986907Z              is_active=True,
2026-02-20T22:09:16.9987271Z          )
2026-02-20T22:09:16.9987581Z          db.add(a)
2026-02-20T22:09:16.9987904Z          db.flush()
2026-02-20T22:09:16.9988364Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:16.9989307Z -        _log_admin_action(db, admin_id, "badge_create", "achievement", a.id, {"code": a.code, "name": a.name})
2026-02-20T22:09:16.9990122Z +        _log_admin_action(
2026-02-20T22:09:16.9990487Z +            db,
2026-02-20T22:09:16.9990784Z +            admin_id,
2026-02-20T22:09:16.9991128Z +            "badge_create",
2026-02-20T22:09:16.9991571Z +            "achievement",
2026-02-20T22:09:16.9991929Z +            a.id,
2026-02-20T22:09:16.9992268Z +            {"code": a.code, "name": a.name},
2026-02-20T22:09:16.9992713Z +        )
2026-02-20T22:09:16.9993351Z          db.commit()
2026-02-20T22:09:16.9993688Z          db.refresh(a)
2026-02-20T22:09:16.9994174Z      return JSONResponse(_achievement_to_detail(a), status_code=201)
2026-02-20T22:09:16.9994741Z  
2026-02-20T22:09:16.9995006Z  
2026-02-20T22:09:16.9995282Z @@ -851,11 +1001,16 @@
2026-02-20T22:09:16.9995642Z      async with db_session() as db:
2026-02-20T22:09:16.9996243Z          a = db.query(Achievement).filter(Achievement.id == badge_id).first()
2026-02-20T22:09:16.9996860Z          if not a:
2026-02-20T22:09:16.9997570Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:16.9998251Z          d = _achievement_to_detail(a)
2026-02-20T22:09:16.9999190Z -        user_count = db.query(func.count(UserAchievement.id)).filter(UserAchievement.achievement_id == badge_id).scalar() or 0
2026-02-20T22:09:17.0000160Z +        user_count = (
2026-02-20T22:09:17.0000584Z +            db.query(func.count(UserAchievement.id))
2026-02-20T22:09:17.0001218Z +            .filter(UserAchievement.achievement_id == badge_id)
2026-02-20T22:09:17.0001766Z +            .scalar()
2026-02-20T22:09:17.0002094Z +            or 0
2026-02-20T22:09:17.0002388Z +        )
2026-02-20T22:09:17.0002716Z          d["_user_count"] = user_count
2026-02-20T22:09:17.0003376Z          return JSONResponse(d)
2026-02-20T22:09:17.0003758Z  
2026-02-20T22:09:17.0004003Z  
2026-02-20T22:09:17.0004266Z  @require_auth
2026-02-20T22:09:17.0004568Z @@ -874,13 +1029,22 @@
2026-02-20T22:09:17.0005292Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:17.0005937Z  
2026-02-20T22:09:17.0006238Z          if "requirements" in data:
2026-02-20T22:09:17.0006783Z              ok, err = _validate_requirements(data.get("requirements"))
2026-02-20T22:09:17.0007356Z              if not ok:
2026-02-20T22:09:17.0007995Z -                return JSONResponse({"error": err or "Requirements invalides."}, status_code=400)
2026-02-20T22:09:17.0008988Z -
2026-02-20T22:09:17.0009581Z -        str_fields = ("name", "description", "icon_url", "category", "difficulty", "star_wars_title")
2026-02-20T22:09:17.0010453Z +                return JSONResponse(
2026-02-20T22:09:17.0011248Z +                    {"error": err or "Requirements invalides."}, status_code=400
2026-02-20T22:09:17.0011858Z +                )
2026-02-20T22:09:17.0012170Z +
2026-02-20T22:09:17.0012439Z +        str_fields = (
2026-02-20T22:09:17.0012783Z +            "name",
2026-02-20T22:09:17.0013328Z +            "description",
2026-02-20T22:09:17.0013687Z +            "icon_url",
2026-02-20T22:09:17.0014040Z +            "category",
2026-02-20T22:09:17.0014381Z +            "difficulty",
2026-02-20T22:09:17.0014745Z +            "star_wars_title",
2026-02-20T22:09:17.0015107Z +        )
2026-02-20T22:09:17.0015421Z          for k, v in data.items():
2026-02-20T22:09:17.0015803Z              if k == "code":
2026-02-20T22:09:17.0016149Z                  continue
2026-02-20T22:09:17.0016495Z              if k == "points_reward":
2026-02-20T22:09:17.0016996Z                  a.points_reward = int(v) if v is not None else 0
2026-02-20T22:09:17.0017519Z @@ -890,11 +1054,18 @@
2026-02-20T22:09:17.0017866Z                  a.requirements = v
2026-02-20T22:09:17.0018340Z              elif k in str_fields and v is not None:
2026-02-20T22:09:17.0018880Z                  setattr(a, k, (v or "").strip() or None)
2026-02-20T22:09:17.0019350Z  
2026-02-20T22:09:17.0019730Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0020662Z -        _log_admin_action(db, admin_id, "badge_update", "achievement", badge_id, {"fields": list(data.keys())})
2026-02-20T22:09:17.0021512Z +        _log_admin_action(
2026-02-20T22:09:17.0021872Z +            db,
2026-02-20T22:09:17.0022184Z +            admin_id,
2026-02-20T22:09:17.0022524Z +            "badge_update",
2026-02-20T22:09:17.0022902Z +            "achievement",
2026-02-20T22:09:17.0023603Z +            badge_id,
2026-02-20T22:09:17.0023971Z +            {"fields": list(data.keys())},
2026-02-20T22:09:17.0024399Z +        )
2026-02-20T22:09:17.0024701Z          db.commit()
2026-02-20T22:09:17.0025031Z          db.refresh(a)
2026-02-20T22:09:17.0025451Z      return JSONResponse(_achievement_to_detail(a))
2026-02-20T22:09:17.0025940Z  
2026-02-20T22:09:17.0026192Z  
2026-02-20T22:09:17.0026465Z @@ -909,29 +1080,47 @@
2026-02-20T22:09:17.0026813Z      async with db_session() as db:
2026-02-20T22:09:17.0027410Z          a = db.query(Achievement).filter(Achievement.id == badge_id).first()
2026-02-20T22:09:17.0028014Z          if not a:
2026-02-20T22:09:17.0028720Z              return JSONResponse({"error": "Badge non trouvé."}, status_code=404)
2026-02-20T22:09:17.0029348Z  
2026-02-20T22:09:17.0030154Z -        user_count = db.query(func.count(UserAchievement.id)).filter(UserAchievement.achievement_id == badge_id).scalar() or 0
2026-02-20T22:09:17.0031134Z +        user_count = (
2026-02-20T22:09:17.0031560Z +            db.query(func.count(UserAchievement.id))
2026-02-20T22:09:17.0032178Z +            .filter(UserAchievement.achievement_id == badge_id)
2026-02-20T22:09:17.0032706Z +            .scalar()
2026-02-20T22:09:17.0033343Z +            or 0
2026-02-20T22:09:17.0033653Z +        )
2026-02-20T22:09:17.0033970Z          a.is_active = False
2026-02-20T22:09:17.0034443Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0035417Z -        _log_admin_action(db, admin_id, "badge_delete", "achievement", badge_id, {"soft": True, "user_count": user_count})
2026-02-20T22:09:17.0036321Z +        _log_admin_action(
2026-02-20T22:09:17.0036682Z +            db,
2026-02-20T22:09:17.0036993Z +            admin_id,
2026-02-20T22:09:17.0037334Z +            "badge_delete",
2026-02-20T22:09:17.0037717Z +            "achievement",
2026-02-20T22:09:17.0038068Z +            badge_id,
2026-02-20T22:09:17.0038456Z +            {"soft": True, "user_count": user_count},
2026-02-20T22:09:17.0039184Z +        )
2026-02-20T22:09:17.0039493Z          db.commit()
2026-02-20T22:09:17.0039843Z          db.refresh(a)
2026-02-20T22:09:17.0040193Z -    return JSONResponse({
2026-02-20T22:09:17.0040572Z -        "success": True,
2026-02-20T22:09:17.0040921Z -        "id": a.id,
2026-02-20T22:09:17.0041460Z -        "code": a.code,
2026-02-20T22:09:17.0041827Z -        "name": a.name,
2026-02-20T22:09:17.0042174Z -        "is_active": False,
2026-02-20T22:09:17.0042745Z -        "message": "Badge désactivé (soft delete).",
2026-02-20T22:09:17.0043475Z -    })
2026-02-20T22:09:17.0043774Z +    return JSONResponse(
2026-02-20T22:09:17.0044121Z +        {
2026-02-20T22:09:17.0044421Z +            "success": True,
2026-02-20T22:09:17.0044787Z +            "id": a.id,
2026-02-20T22:09:17.0045141Z +            "code": a.code,
2026-02-20T22:09:17.0045498Z +            "name": a.name,
2026-02-20T22:09:17.0045869Z +            "is_active": False,
2026-02-20T22:09:17.0046464Z +            "message": "Badge désactivé (soft delete).",
2026-02-20T22:09:17.0046968Z +        }
2026-02-20T22:09:17.0047233Z +    )
2026-02-20T22:09:17.0047501Z  
2026-02-20T22:09:17.0047752Z  
2026-02-20T22:09:17.0048058Z  def _challenge_to_detail(c) -> dict:
2026-02-20T22:09:17.0048678Z      """Sérialise un défi pour l'édition admin."""
2026-02-20T22:09:17.0049537Z -    ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0050356Z +    ct_val = (
2026-02-20T22:09:17.0050685Z +        c.challenge_type.value
2026-02-20T22:09:17.0051136Z +        if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0051609Z +        else str(c.challenge_type)
2026-02-20T22:09:17.0052001Z +    )
2026-02-20T22:09:17.0052516Z      ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0053387Z      return {
2026-02-20T22:09:17.0053710Z          "id": c.id,
2026-02-20T22:09:17.0054035Z          "title": c.title,
2026-02-20T22:09:17.0054451Z          "description": c.description or "",
2026-02-20T22:09:17.0054921Z @@ -972,11 +1161,13 @@
2026-02-20T22:09:17.0055407Z      age_group_raw = (data.get("age_group") or "GROUP_10_12").strip()
2026-02-20T22:09:17.0055968Z  
2026-02-20T22:09:17.0056245Z      if not title:
2026-02-20T22:09:17.0056810Z          return JSONResponse({"error": "Le titre est obligatoire."}, status_code=400)
2026-02-20T22:09:17.0057502Z      if not description:
2026-02-20T22:09:17.0058149Z -        return JSONResponse({"error": "La description est obligatoire."}, status_code=400)
2026-02-20T22:09:17.0058888Z +        return JSONResponse(
2026-02-20T22:09:17.0059448Z +            {"error": "La description est obligatoire."}, status_code=400
2026-02-20T22:09:17.0060022Z +        )
2026-02-20T22:09:17.0060340Z  
2026-02-20T22:09:17.0060600Z      try:
2026-02-20T22:09:17.0060966Z          ct = LogicChallengeType(challenge_type_raw)
2026-02-20T22:09:17.0061462Z      except ValueError:
2026-02-20T22:09:17.0061847Z          ct = LogicChallengeType.PUZZLE
2026-02-20T22:09:17.0062297Z @@ -993,18 +1184,21 @@
2026-02-20T22:09:17.0062630Z              age_group=ag,
2026-02-20T22:09:17.0063319Z              question=(data.get("question") or "").strip() or None,
2026-02-20T22:09:17.0063984Z              content=(data.get("content") or "").strip() or None,
2026-02-20T22:09:17.0064655Z              solution=(data.get("solution") or "").strip() or None,
2026-02-20T22:09:17.0065378Z              correct_answer=(data.get("correct_answer") or "").strip() or None,
2026-02-20T22:09:17.0066254Z -            solution_explanation=(data.get("solution_explanation") or "").strip() or None,
2026-02-20T22:09:17.0067183Z +            solution_explanation=(data.get("solution_explanation") or "").strip()
2026-02-20T22:09:17.0067809Z +            or None,
2026-02-20T22:09:17.0068188Z              visual_data=data.get("visual_data"),
2026-02-20T22:09:17.0068670Z              hints=data.get("hints"),
2026-02-20T22:09:17.0069077Z          )
2026-02-20T22:09:17.0069348Z          db.add(ch)
2026-02-20T22:09:17.0069907Z          db.flush()
2026-02-20T22:09:17.0070312Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0071137Z -        _log_admin_action(db, admin_id, "challenge_create", "challenge", ch.id, {"title": ch.title})
2026-02-20T22:09:17.0072128Z +        _log_admin_action(
2026-02-20T22:09:17.0072736Z +            db, admin_id, "challenge_create", "challenge", ch.id, {"title": ch.title}
2026-02-20T22:09:17.0073658Z +        )
2026-02-20T22:09:17.0073971Z          db.commit()
2026-02-20T22:09:17.0074319Z          db.refresh(ch)
2026-02-20T22:09:17.0074810Z      return JSONResponse(_challenge_to_detail(ch), status_code=201)
2026-02-20T22:09:17.0075367Z  
2026-02-20T22:09:17.0075611Z  
2026-02-20T22:09:17.0075880Z @@ -1029,13 +1223,20 @@
2026-02-20T22:09:17.0076248Z          data = await request.json()
2026-02-20T22:09:17.0076708Z      except Exception:
2026-02-20T22:09:17.0077270Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:17.0077933Z  
2026-02-20T22:09:17.0078194Z      allowed_str = {
2026-02-20T22:09:17.0078664Z -        "title", "description", "difficulty", "content", "question",
2026-02-20T22:09:17.0079370Z -        "solution", "correct_answer", "solution_explanation",
2026-02-20T22:09:17.0079924Z -        "image_url", "tags",
2026-02-20T22:09:17.0080295Z +        "title",
2026-02-20T22:09:17.0080606Z +        "description",
2026-02-20T22:09:17.0080958Z +        "difficulty",
2026-02-20T22:09:17.0081286Z +        "content",
2026-02-20T22:09:17.0081594Z +        "question",
2026-02-20T22:09:17.0081929Z +        "solution",
2026-02-20T22:09:17.0082259Z +        "correct_answer",
2026-02-20T22:09:17.0082663Z +        "solution_explanation",
2026-02-20T22:09:17.0083305Z +        "image_url",
2026-02-20T22:09:17.0083632Z +        "tags",
2026-02-20T22:09:17.0083915Z      }
2026-02-20T22:09:17.0084257Z      allowed_bool = {"is_active", "is_archived"}
2026-02-20T22:09:17.0084872Z      allowed_int = {"difficulty_rating", "estimated_time_minutes"}
2026-02-20T22:09:17.0085632Z      allowed_json = {"choices", "visual_data", "hints"}
2026-02-20T22:09:17.0086122Z  
2026-02-20T22:09:17.0086398Z @@ -1067,11 +1268,18 @@
2026-02-20T22:09:17.0086734Z          if not ch:
2026-02-20T22:09:17.0087471Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0088171Z          for k, v in update_data.items():
2026-02-20T22:09:17.0088622Z              setattr(ch, k, v)
2026-02-20T22:09:17.0089130Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0090150Z -        _log_admin_action(db, admin_id, "challenge_update", "challenge", challenge_id, {"fields": list(update_data.keys())})
2026-02-20T22:09:17.0091097Z +        _log_admin_action(
2026-02-20T22:09:17.0091469Z +            db,
2026-02-20T22:09:17.0091774Z +            admin_id,
2026-02-20T22:09:17.0092124Z +            "challenge_update",
2026-02-20T22:09:17.0092511Z +            "challenge",
2026-02-20T22:09:17.0092888Z +            challenge_id,
2026-02-20T22:09:17.0093476Z +            {"fields": list(update_data.keys())},
2026-02-20T22:09:17.0093927Z +        )
2026-02-20T22:09:17.0094204Z          db.commit()
2026-02-20T22:09:17.0094520Z          db.refresh(ch)
2026-02-20T22:09:17.0094952Z      return JSONResponse(_challenge_to_detail(ch))
2026-02-20T22:09:17.0095407Z  
2026-02-20T22:09:17.0095653Z  
2026-02-20T22:09:17.0095912Z @@ -1079,11 +1287,13 @@
2026-02-20T22:09:17.0096249Z  @require_admin
2026-02-20T22:09:17.0096670Z  async def admin_challenges_duplicate(request: Request):
2026-02-20T22:09:17.0097626Z      """POST /api/admin/challenges/{challenge_id}/duplicate — crée une copie."""
2026-02-20T22:09:17.0098446Z      challenge_id = int(request.path_params.get("challenge_id"))
2026-02-20T22:09:17.0099060Z      async with db_session() as db:
2026-02-20T22:09:17.0099762Z -        orig = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0100769Z +        orig = (
2026-02-20T22:09:17.0101341Z +            db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0102024Z +        )
2026-02-20T22:09:17.0102317Z          if not orig:
2026-02-20T22:09:17.0103531Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0104223Z          copy = LogicChallenge(
2026-02-20T22:09:17.0104649Z              title=f"{orig.title} (copie)",
2026-02-20T22:09:17.0105129Z              description=orig.description,
2026-02-20T22:09:17.0105578Z @@ -1106,11 +1316,18 @@
2026-02-20T22:09:17.0106033Z              estimated_time_minutes=orig.estimated_time_minutes,
2026-02-20T22:09:17.0106569Z          )
2026-02-20T22:09:17.0106858Z          db.add(copy)
2026-02-20T22:09:17.0107180Z          db.flush()
2026-02-20T22:09:17.0107610Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0108678Z -        _log_admin_action(db, admin_id, "challenge_duplicate", "challenge", copy.id, {"from_id": challenge_id, "title": copy.title})
2026-02-20T22:09:17.0109668Z +        _log_admin_action(
2026-02-20T22:09:17.0110031Z +            db,
2026-02-20T22:09:17.0110336Z +            admin_id,
2026-02-20T22:09:17.0110687Z +            "challenge_duplicate",
2026-02-20T22:09:17.0111104Z +            "challenge",
2026-02-20T22:09:17.0111445Z +            copy.id,
2026-02-20T22:09:17.0111861Z +            {"from_id": challenge_id, "title": copy.title},
2026-02-20T22:09:17.0112338Z +        )
2026-02-20T22:09:17.0112624Z          db.commit()
2026-02-20T22:09:17.0112948Z          db.refresh(copy)
2026-02-20T22:09:17.0113585Z      return JSONResponse(_challenge_to_detail(copy))
2026-02-20T22:09:17.0114065Z  
2026-02-20T22:09:17.0114328Z  
2026-02-20T22:09:17.0114603Z @@ -1150,51 +1367,66 @@
2026-02-20T22:09:17.0115064Z                  q = q.filter(LogicChallenge.challenge_type == ct)
2026-02-20T22:09:17.0115596Z              except ValueError:
2026-02-20T22:09:17.0115904Z                  pass
2026-02-20T22:09:17.0116173Z          if search:
2026-02-20T22:09:17.0116444Z              pattern = f"%{search}%"
2026-02-20T22:09:17.0116797Z -            q = q.filter(or_(
2026-02-20T22:09:17.0117145Z -                LogicChallenge.title.ilike(pattern),
2026-02-20T22:09:17.0117636Z -                LogicChallenge.description.ilike(pattern),
2026-02-20T22:09:17.0118066Z -            ))
2026-02-20T22:09:17.0118309Z +            q = q.filter(
2026-02-20T22:09:17.0118586Z +                or_(
2026-02-20T22:09:17.0118900Z +                    LogicChallenge.title.ilike(pattern),
2026-02-20T22:09:17.0119399Z +                    LogicChallenge.description.ilike(pattern),
2026-02-20T22:09:17.0119815Z +                )
2026-02-20T22:09:17.0120062Z +            )
2026-02-20T22:09:17.0120317Z          total = q.count()
2026-02-20T22:09:17.0120773Z          challenges = q.order_by(order_by).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0121358Z          ch_ids = [c.id for c in challenges]
2026-02-20T22:09:17.0121722Z  
2026-02-20T22:09:17.0121964Z          attempt_stats = {}
2026-02-20T22:09:17.0122274Z          if ch_ids:
2026-02-20T22:09:17.0122534Z              rows = (
2026-02-20T22:09:17.0122808Z                  db.query(
2026-02-20T22:09:17.0123394Z                      LogicChallengeAttempt.challenge_id,
2026-02-20T22:09:17.0123997Z                      func.count(LogicChallengeAttempt.id).label("attempt_count"),
2026-02-20T22:09:17.0124785Z -                    func.sum(case((LogicChallengeAttempt.is_correct == True, 1), else_=0)).label("correct_count"),
2026-02-20T22:09:17.0125493Z +                    func.sum(
2026-02-20T22:09:17.0125985Z +                        case((LogicChallengeAttempt.is_correct == True, 1), else_=0)
2026-02-20T22:09:17.0126609Z +                    ).label("correct_count"),
2026-02-20T22:09:17.0127021Z                  )
2026-02-20T22:09:17.0127498Z                  .filter(LogicChallengeAttempt.challenge_id.in_(ch_ids))
2026-02-20T22:09:17.0128185Z                  .group_by(LogicChallengeAttempt.challenge_id)
2026-02-20T22:09:17.0128990Z                  .all()
2026-02-20T22:09:17.0129312Z              )
2026-02-20T22:09:17.0129659Z              for ch_id, a_count, c_count in rows:
2026-02-20T22:09:17.0130624Z -                attempt_stats[ch_id] = {"attempt_count": a_count or 0, "correct_count": c_count or 0}
2026-02-20T22:09:17.0131406Z +                attempt_stats[ch_id] = {
2026-02-20T22:09:17.0131879Z +                    "attempt_count": a_count or 0,
2026-02-20T22:09:17.0132360Z +                    "correct_count": c_count or 0,
2026-02-20T22:09:17.0132805Z +                }
2026-02-20T22:09:17.0133283Z  
2026-02-20T22:09:17.0133540Z          items = []
2026-02-20T22:09:17.0133864Z          for c in challenges:
2026-02-20T22:09:17.0134455Z              stats = attempt_stats.get(c.id, {"attempt_count": 0, "correct_count": 0})
2026-02-20T22:09:17.0135149Z              a_count = stats["attempt_count"]
2026-02-20T22:09:17.0135628Z              c_count = stats["correct_count"]
2026-02-20T22:09:17.0136293Z              success_rate = round((c_count / a_count * 100), 1) if a_count > 0 else 0.0
2026-02-20T22:09:17.0137314Z -            ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0138386Z -            ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0139097Z -            items.append({
2026-02-20T22:09:17.0139467Z -                "id": c.id,
2026-02-20T22:09:17.0139843Z -                "title": c.title,
2026-02-20T22:09:17.0140250Z -                "challenge_type": ct_val,
2026-02-20T22:09:17.0140712Z -                "age_group": ag_val,
2026-02-20T22:09:17.0141153Z -                "is_archived": c.is_archived,
2026-02-20T22:09:17.0141622Z -                "attempt_count": a_count,
2026-02-20T22:09:17.0142081Z -                "success_rate": success_rate,
2026-02-20T22:09:17.0142702Z -                "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0143544Z -            })
2026-02-20T22:09:17.0143843Z +            ct_val = (
2026-02-20T22:09:17.0144207Z +                c.challenge_type.value
2026-02-20T22:09:17.0144682Z +                if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0145199Z +                else str(c.challenge_type)
2026-02-20T22:09:17.0145618Z +            )
2026-02-20T22:09:17.0145932Z +            ag_val = (
2026-02-20T22:09:17.0146484Z +                c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0147148Z +            )
2026-02-20T22:09:17.0147473Z +            items.append(
2026-02-20T22:09:17.0147818Z +                {
2026-02-20T22:09:17.0148139Z +                    "id": c.id,
2026-02-20T22:09:17.0148525Z +                    "title": c.title,
2026-02-20T22:09:17.0148974Z +                    "challenge_type": ct_val,
2026-02-20T22:09:17.0149432Z +                    "age_group": ag_val,
2026-02-20T22:09:17.0149892Z +                    "is_archived": c.is_archived,
2026-02-20T22:09:17.0150376Z +                    "attempt_count": a_count,
2026-02-20T22:09:17.0150858Z +                    "success_rate": success_rate,
2026-02-20T22:09:17.0151501Z +                    "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0152124Z +                }
2026-02-20T22:09:17.0152437Z +            )
2026-02-20T22:09:17.0152717Z  
2026-02-20T22:09:17.0153308Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:17.0153812Z  
2026-02-20T22:09:17.0154063Z  
2026-02-20T22:09:17.0154311Z  @require_auth
2026-02-20T22:09:17.0154600Z @@ -1206,27 +1438,38 @@
2026-02-20T22:09:17.0154947Z          data = await request.json()
2026-02-20T22:09:17.0155368Z      except Exception:
2026-02-20T22:09:17.0155915Z          return JSONResponse({"error": "Corps JSON invalide."}, status_code=400)
2026-02-20T22:09:17.0156579Z      is_archived = data.get("is_archived")
2026-02-20T22:09:17.0157079Z      if not isinstance(is_archived, bool):
2026-02-20T22:09:17.0158423Z -        return JSONResponse({"error": "Le champ is_archived doit être un booléen."}, status_code=400)
2026-02-20T22:09:17.0159239Z +        return JSONResponse(
2026-02-20T22:09:17.0160216Z +            {"error": "Le champ is_archived doit être un booléen."}, status_code=400
2026-02-20T22:09:17.0160875Z +        )
2026-02-20T22:09:17.0161152Z  
2026-02-20T22:09:17.0161446Z      async with db_session() as db:
2026-02-20T22:09:17.0162126Z          ch = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:17.0162826Z          if not ch:
2026-02-20T22:09:17.0163774Z              return JSONResponse({"error": "Défi non trouvé."}, status_code=404)
2026-02-20T22:09:17.0164447Z          ch.is_archived = is_archived
2026-02-20T22:09:17.0164990Z          admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0165954Z -        _log_admin_action(db, admin_id, "challenge_archive", "challenge", challenge_id, {"is_archived": is_archived})
2026-02-20T22:09:17.0166856Z +        _log_admin_action(
2026-02-20T22:09:17.0167224Z +            db,
2026-02-20T22:09:17.0167531Z +            admin_id,
2026-02-20T22:09:17.0167883Z +            "challenge_archive",
2026-02-20T22:09:17.0168282Z +            "challenge",
2026-02-20T22:09:17.0168664Z +            challenge_id,
2026-02-20T22:09:17.0169052Z +            {"is_archived": is_archived},
2026-02-20T22:09:17.0169470Z +        )
2026-02-20T22:09:17.0169745Z          db.commit()
2026-02-20T22:09:17.0170073Z          db.refresh(ch)
2026-02-20T22:09:17.0170396Z  
2026-02-20T22:09:17.0170692Z -    return JSONResponse({
2026-02-20T22:09:17.0171068Z -        "id": ch.id,
2026-02-20T22:09:17.0171397Z -        "title": ch.title,
2026-02-20T22:09:17.0171784Z -        "is_archived": ch.is_archived,
2026-02-20T22:09:17.0172196Z -    })
2026-02-20T22:09:17.0172500Z +    return JSONResponse(
2026-02-20T22:09:17.0172844Z +        {
2026-02-20T22:09:17.0173344Z +            "id": ch.id,
2026-02-20T22:09:17.0173788Z +            "title": ch.title,
2026-02-20T22:09:17.0174198Z +            "is_archived": ch.is_archived,
2026-02-20T22:09:17.0174577Z +        }
2026-02-20T22:09:17.0174831Z +    )
2026-02-20T22:09:17.0175076Z  
2026-02-20T22:09:17.0175308Z  
2026-02-20T22:09:17.0175555Z  @require_auth
2026-02-20T22:09:17.0175853Z  @require_admin
2026-02-20T22:09:17.0176221Z  async def admin_audit_log(request: Request):
2026-02-20T22:09:17.0176696Z @@ -1253,20 +1496,24 @@
2026-02-20T22:09:17.0177054Z          for log in logs:
2026-02-20T22:09:17.0177418Z              admin_username = None
2026-02-20T22:09:17.0177827Z              if log.admin_user_id:
2026-02-20T22:09:17.0178395Z                  u = db.query(User).filter(User.id == log.admin_user_id).first()
2026-02-20T22:09:17.0179078Z                  admin_username = u.username if u else None
2026-02-20T22:09:17.0179589Z -            items.append({
2026-02-20T22:09:17.0179951Z -                "id": log.id,
2026-02-20T22:09:17.0180376Z -                "admin_user_id": log.admin_user_id,
2026-02-20T22:09:17.0180902Z -                "admin_username": admin_username,
2026-02-20T22:09:17.0181387Z -                "action": log.action,
2026-02-20T22:09:17.0181866Z -                "resource_type": log.resource_type,
2026-02-20T22:09:17.0182388Z -                "resource_id": log.resource_id,
2026-02-20T22:09:17.0183193Z -                "details": json.loads(log.details) if log.details else None,
2026-02-20T22:09:17.0183996Z -                "created_at": log.created_at.isoformat() if log.created_at else None,
2026-02-20T22:09:17.0184640Z -            })
2026-02-20T22:09:17.0184962Z +            items.append(
2026-02-20T22:09:17.0185400Z +                {
2026-02-20T22:09:17.0185711Z +                    "id": log.id,
2026-02-20T22:09:17.0186160Z +                    "admin_user_id": log.admin_user_id,
2026-02-20T22:09:17.0186701Z +                    "admin_username": admin_username,
2026-02-20T22:09:17.0187199Z +                    "action": log.action,
2026-02-20T22:09:17.0187981Z +                    "resource_type": log.resource_type,
2026-02-20T22:09:17.0188499Z +                    "resource_id": log.resource_id,
2026-02-20T22:09:17.0189123Z +                    "details": json.loads(log.details) if log.details else None,
2026-02-20T22:09:17.0189917Z +                    "created_at": (
2026-02-20T22:09:17.0190518Z +                        log.created_at.isoformat() if log.created_at else None
2026-02-20T22:09:17.0191099Z +                    ),
2026-02-20T22:09:17.0191224Z +                }
2026-02-20T22:09:17.0191337Z +            )
2026-02-20T22:09:17.0191443Z  
2026-02-20T22:09:17.0191685Z      return JSONResponse({"items": items, "total": total})
2026-02-20T22:09:17.0191801Z  
2026-02-20T22:09:17.0191909Z  
2026-02-20T22:09:17.0192034Z  @require_auth
2026-02-20T22:09:17.0192165Z @@ -1281,44 +1528,75 @@
2026-02-20T22:09:17.0192367Z      skip = max(0, int(query_params.get("skip", 0)))
2026-02-20T22:09:17.0192622Z      limit = min(100, max(1, int(query_params.get("limit", 50))))
2026-02-20T22:09:17.0192742Z  
2026-02-20T22:09:17.0192893Z      from sqlalchemy import or_
2026-02-20T22:09:17.0193223Z  
2026-02-20T22:09:17.0193617Z -    result = {"exercises": [], "challenges": [], "total_exercises": 0, "total_challenges": 0}
2026-02-20T22:09:17.0193745Z +    result = {
2026-02-20T22:09:17.0193881Z +        "exercises": [],
2026-02-20T22:09:17.0194013Z +        "challenges": [],
2026-02-20T22:09:17.0194156Z +        "total_exercises": 0,
2026-02-20T22:09:17.0194295Z +        "total_challenges": 0,
2026-02-20T22:09:17.0194399Z +    }
2026-02-20T22:09:17.0194499Z  
2026-02-20T22:09:17.0194644Z      async with db_session() as db:
2026-02-20T22:09:17.0194804Z          if mod_type in ("exercises", "all"):
2026-02-20T22:09:17.0195090Z              q_ex = db.query(Exercise).filter(Exercise.ai_generated == True)
2026-02-20T22:09:17.0195290Z              result["total_exercises"] = q_ex.count()
2026-02-20T22:09:17.0195690Z -            rows_ex = q_ex.order_by(Exercise.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0195823Z +            rows_ex = (
2026-02-20T22:09:17.0196032Z +                q_ex.order_by(Exercise.created_at.desc())
2026-02-20T22:09:17.0196168Z +                .offset(skip)
2026-02-20T22:09:17.0196302Z +                .limit(limit)
2026-02-20T22:09:17.0196422Z +                .all()
2026-02-20T22:09:17.0196547Z +            )
2026-02-20T22:09:17.0196674Z              for e in rows_ex:
2026-02-20T22:09:17.0196837Z -                result["exercises"].append({
2026-02-20T22:09:17.0196973Z -                    "id": e.id,
2026-02-20T22:09:17.0197113Z -                    "title": e.title,
2026-02-20T22:09:17.0197313Z -                    "exercise_type": e.exercise_type or "",
2026-02-20T22:09:17.0197486Z -                    "age_group": e.age_group or "",
2026-02-20T22:09:17.0197661Z -                    "is_archived": e.is_archived,
2026-02-20T22:09:17.0197975Z -                    "created_at": e.created_at.isoformat() if e.created_at else None,
2026-02-20T22:09:17.0198099Z -                })
2026-02-20T22:09:17.0198269Z +                result["exercises"].append(
2026-02-20T22:09:17.0198386Z +                    {
2026-02-20T22:09:17.0198515Z +                        "id": e.id,
2026-02-20T22:09:17.0198670Z +                        "title": e.title,
2026-02-20T22:09:17.0198878Z +                        "exercise_type": e.exercise_type or "",
2026-02-20T22:09:17.0199053Z +                        "age_group": e.age_group or "",
2026-02-20T22:09:17.0199221Z +                        "is_archived": e.is_archived,
2026-02-20T22:09:17.0199370Z +                        "created_at": (
2026-02-20T22:09:17.0199621Z +                            e.created_at.isoformat() if e.created_at else None
2026-02-20T22:09:17.0199741Z +                        ),
2026-02-20T22:09:17.0199863Z +                    }
2026-02-20T22:09:17.0199976Z +                )
2026-02-20T22:09:17.0200083Z  
2026-02-20T22:09:17.0200255Z          if mod_type in ("challenges", "all"):
2026-02-20T22:09:17.0201064Z              # Tous les défis sont générés par IA pour le moment ; generation_parameters
2026-02-20T22:09:17.0201459Z              # est renseigné pour les créations futures via le flux IA
2026-02-20T22:09:17.0201627Z              q_ch = db.query(LogicChallenge)
2026-02-20T22:09:17.0202101Z              result["total_challenges"] = q_ch.count()
2026-02-20T22:09:17.0202600Z -            rows_ch = q_ch.order_by(LogicChallenge.created_at.desc()).offset(skip).limit(limit).all()
2026-02-20T22:09:17.0202735Z +            rows_ch = (
2026-02-20T22:09:17.0203194Z +                q_ch.order_by(LogicChallenge.created_at.desc())
2026-02-20T22:09:17.0203340Z +                .offset(skip)
2026-02-20T22:09:17.0203547Z +                .limit(limit)
2026-02-20T22:09:17.0203717Z +                .all()
2026-02-20T22:09:17.0203830Z +            )
2026-02-20T22:09:17.0203961Z              for c in rows_ch:
2026-02-20T22:09:17.0204486Z -                ct_val = c.challenge_type.value if hasattr(c.challenge_type, "value") else str(c.challenge_type)
2026-02-20T22:09:17.0204921Z -                ag_val = c.age_group.value if hasattr(c.age_group, "value") else str(c.age_group)
2026-02-20T22:09:17.0205096Z -                result["challenges"].append({
2026-02-20T22:09:17.0205236Z -                    "id": c.id,
2026-02-20T22:09:17.0205386Z -                    "title": c.title,
2026-02-20T22:09:17.0205551Z -                    "challenge_type": ct_val,
2026-02-20T22:09:17.0205700Z -                    "age_group": ag_val,
2026-02-20T22:09:17.0205876Z -                    "is_archived": c.is_archived,
2026-02-20T22:09:17.0206196Z -                    "created_at": c.created_at.isoformat() if c.created_at else None,
2026-02-20T22:09:17.0206311Z -                })
2026-02-20T22:09:17.0206438Z +                ct_val = (
2026-02-20T22:09:17.0206597Z +                    c.challenge_type.value
2026-02-20T22:09:17.0206794Z +                    if hasattr(c.challenge_type, "value")
2026-02-20T22:09:17.0206965Z +                    else str(c.challenge_type)
2026-02-20T22:09:17.0207089Z +                )
2026-02-20T22:09:17.0207212Z +                ag_val = (
2026-02-20T22:09:17.0207352Z +                    c.age_group.value
2026-02-20T22:09:17.0207540Z +                    if hasattr(c.age_group, "value")
2026-02-20T22:09:17.0207699Z +                    else str(c.age_group)
2026-02-20T22:09:17.0207813Z +                )
2026-02-20T22:09:17.0207973Z +                result["challenges"].append(
2026-02-20T22:09:17.0208098Z +                    {
2026-02-20T22:09:17.0208227Z +                        "id": c.id,
2026-02-20T22:09:17.0208368Z +                        "title": c.title,
2026-02-20T22:09:17.0208552Z +                        "challenge_type": ct_val,
2026-02-20T22:09:17.0208720Z +                        "age_group": ag_val,
2026-02-20T22:09:17.0208895Z +                        "is_archived": c.is_archived,
2026-02-20T22:09:17.0209033Z +                        "created_at": (
2026-02-20T22:09:17.0209313Z +                            c.created_at.isoformat() if c.created_at else None
2026-02-20T22:09:17.0209435Z +                        ),
2026-02-20T22:09:17.0209550Z +                    }
2026-02-20T22:09:17.0209675Z +                )
2026-02-20T22:09:17.0209783Z  
2026-02-20T22:09:17.0209938Z      return JSONResponse(result)
2026-02-20T22:09:17.0210049Z  
2026-02-20T22:09:17.0210166Z  
2026-02-20T22:09:17.0210289Z  @require_auth
2026-02-20T22:09:17.0210415Z @@ -1340,17 +1618,21 @@
2026-02-20T22:09:17.0210579Z      days = 7 if period == "7d" else 30
2026-02-20T22:09:17.0210846Z      since = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:17.0210954Z  
2026-02-20T22:09:17.0211109Z      async with db_session() as db:
2026-02-20T22:09:17.0211539Z          # Inscriptions (nouveaux utilisateurs dans la période)
2026-02-20T22:09:17.0211981Z -        new_users = db.query(func.count(User.id)).filter(User.created_at >= since).scalar() or 0
2026-02-20T22:09:17.0212359Z +        new_users = (
2026-02-20T22:09:17.0212734Z +            db.query(func.count(User.id)).filter(User.created_at >= since).scalar() or 0
2026-02-20T22:09:17.0212850Z +        )
2026-02-20T22:09:17.0213164Z  
2026-02-20T22:09:17.0213510Z          # Tentatives exercices dans la période
2026-02-20T22:09:17.0213878Z          attempts_exercises = (
2026-02-20T22:09:17.0214022Z              db.query(
2026-02-20T22:09:17.0214219Z                  func.count(Attempt.id).label("total"),
2026-02-20T22:09:17.0214587Z -                func.sum(case((Attempt.is_correct == True, 1), else_=0)).label("correct"),
2026-02-20T22:09:17.0214896Z +                func.sum(case((Attempt.is_correct == True, 1), else_=0)).label(
2026-02-20T22:09:17.0215034Z +                    "correct"
2026-02-20T22:09:17.0215160Z +                ),
2026-02-20T22:09:17.0215274Z              )
2026-02-20T22:09:17.0215457Z              .filter(Attempt.created_at >= since)
2026-02-20T22:09:17.0215592Z              .first()
2026-02-20T22:09:17.0215716Z          )
2026-02-20T22:09:17.0215919Z          total_attempts = attempts_exercises[0] or 0
2026-02-20T22:09:17.0216046Z @@ -1373,29 +1655,40 @@
2026-02-20T22:09:17.0216172Z              or 0
2026-02-20T22:09:17.0216280Z          )
2026-02-20T22:09:17.0216387Z  
2026-02-20T22:09:17.0216979Z          # Utilisateurs actifs (au moins 1 tentative exercice ou défi dans la période)
2026-02-20T22:09:17.0217146Z          from sqlalchemy import union
2026-02-20T22:09:17.0217252Z +
2026-02-20T22:09:17.0217608Z          q1 = db.query(Attempt.user_id).filter(Attempt.created_at >= since).distinct()
2026-02-20T22:09:17.0218195Z -        q2 = db.query(LogicChallengeAttempt.user_id).filter(LogicChallengeAttempt.created_at >= since).distinct()
2026-02-20T22:09:17.0218308Z +        q2 = (
2026-02-20T22:09:17.0218507Z +            db.query(LogicChallengeAttempt.user_id)
2026-02-20T22:09:17.0218761Z +            .filter(LogicChallengeAttempt.created_at >= since)
2026-02-20T22:09:17.0218887Z +            .distinct()
2026-02-20T22:09:17.0219008Z +        )
2026-02-20T22:09:17.0219161Z          u = union(q1, q2).subquery()
2026-02-20T22:09:17.0219494Z          active_users_count = db.query(func.count()).select_from(u).scalar() or 0
2026-02-20T22:09:17.0219602Z  
2026-02-20T22:09:17.0219907Z          total_attempts_all = total_attempts + challenge_attempts_count
2026-02-20T22:09:17.0220171Z          total_correct_all = correct_attempts + challenge_correct
2026-02-20T22:09:17.0220701Z -        success_rate = round((total_correct_all / total_attempts_all * 100), 1) if total_attempts_all > 0 else 0.0
2026-02-20T22:09:17.0220809Z -
2026-02-20T22:09:17.0220962Z -    return JSONResponse({
2026-02-20T22:09:17.0221099Z -        "period": period,
2026-02-20T22:09:17.0221221Z -        "days": days,
2026-02-20T22:09:17.0221358Z -        "new_users": new_users,
2026-02-20T22:09:17.0221540Z -        "attempts_exercises": total_attempts,
2026-02-20T22:09:17.0221760Z -        "attempts_challenges": challenge_attempts_count,
2026-02-20T22:09:17.0221936Z -        "total_attempts": total_attempts_all,
2026-02-20T22:09:17.0222100Z -        "success_rate": success_rate,
2026-02-20T22:09:17.0222256Z -        "active_users": active_users_count,
2026-02-20T22:09:17.0222370Z -    })
2026-02-20T22:09:17.0222509Z +        success_rate = (
2026-02-20T22:09:17.0222767Z +            round((total_correct_all / total_attempts_all * 100), 1)
2026-02-20T22:09:17.0222915Z +            if total_attempts_all > 0
2026-02-20T22:09:17.0223266Z +            else 0.0
2026-02-20T22:09:17.0223385Z +        )
2026-02-20T22:09:17.0223487Z +
2026-02-20T22:09:17.0223623Z +    return JSONResponse(
2026-02-20T22:09:17.0223743Z +        {
2026-02-20T22:09:17.0223883Z +            "period": period,
2026-02-20T22:09:17.0224009Z +            "days": days,
2026-02-20T22:09:17.0224149Z +            "new_users": new_users,
2026-02-20T22:09:17.0224340Z +            "attempts_exercises": total_attempts,
2026-02-20T22:09:17.0224576Z +            "attempts_challenges": challenge_attempts_count,
2026-02-20T22:09:17.0225069Z +            "total_attempts": total_attempts_all,
2026-02-20T22:09:17.0225245Z +            "success_rate": success_rate,
2026-02-20T22:09:17.0225430Z +            "active_users": active_users_count,
2026-02-20T22:09:17.0225545Z +        }
2026-02-20T22:09:17.0225663Z +    )
2026-02-20T22:09:17.0225934Z  
2026-02-20T22:09:17.0226074Z  
2026-02-20T22:09:17.0226207Z  @require_auth
2026-02-20T22:09:17.0226340Z  @require_admin
2026-02-20T22:09:17.0226500Z  async def admin_export(request: Request):
2026-02-20T22:09:17.0226616Z @@ -1413,11 +1706,18 @@
2026-02-20T22:09:17.0226740Z              status_code=400,
2026-02-20T22:09:17.0226849Z          )
2026-02-20T22:09:17.0226945Z  
2026-02-20T22:09:17.0227184Z      admin_id = getattr(request.state, "user", {}).get("id")
2026-02-20T22:09:17.0227338Z      async with db_session() as _db:
2026-02-20T22:09:17.0227807Z -        _log_admin_action(_db, admin_id, "export_csv", None, None, {"type": export_type, "period": period})
2026-02-20T22:09:17.0227956Z +        _log_admin_action(
2026-02-20T22:09:17.0228078Z +            _db,
2026-02-20T22:09:17.0228196Z +            admin_id,
2026-02-20T22:09:17.0228325Z +            "export_csv",
2026-02-20T22:09:17.0228440Z +            None,
2026-02-20T22:09:17.0228560Z +            None,
2026-02-20T22:09:17.0228758Z +            {"type": export_type, "period": period},
2026-02-20T22:09:17.0228870Z +        )
2026-02-20T22:09:17.0228999Z          _db.commit()
2026-02-20T22:09:17.0229106Z  
2026-02-20T22:09:17.0229222Z      since = None
2026-02-20T22:09:17.0229352Z      if period == "7d":
2026-02-20T22:09:17.0229620Z          since = datetime.now(timezone.utc) - timedelta(days=7)
2026-02-20T22:09:17.0229744Z @@ -1432,34 +1732,80 @@
2026-02-20T22:09:17.0229883Z              q = db.query(User)
2026-02-20T22:09:17.0230018Z              if since:
2026-02-20T22:09:17.0230211Z                  q = q.filter(User.created_at >= since)
2026-02-20T22:09:17.0230504Z              rows = q.order_by(User.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0230645Z              rows_data = [
2026-02-20T22:09:17.0231397Z -                [u.id, u.username or "", u.email or "", u.full_name or "", u.role.value if u.role else "", u.is_active, u.created_at.isoformat() if u.created_at else ""]
2026-02-20T22:09:17.0231522Z +                [
2026-02-20T22:09:17.0231646Z +                    u.id,
2026-02-20T22:09:17.0231795Z +                    u.username or "",
2026-02-20T22:09:17.0231928Z +                    u.email or "",
2026-02-20T22:09:17.0232066Z +                    u.full_name or "",
2026-02-20T22:09:17.0232250Z +                    u.role.value if u.role else "",
2026-02-20T22:09:17.0232376Z +                    u.is_active,
2026-02-20T22:09:17.0232608Z +                    u.created_at.isoformat() if u.created_at else "",
2026-02-20T22:09:17.0232718Z +                ]
2026-02-20T22:09:17.0232839Z                  for u in rows
2026-02-20T22:09:17.0232946Z              ]
2026-02-20T22:09:17.0233565Z -            headers = ["id", "username", "email", "full_name", "role", "is_active", "created_at"]
2026-02-20T22:09:17.0233713Z +            headers = [
2026-02-20T22:09:17.0233831Z +                "id",
2026-02-20T22:09:17.0233958Z +                "username",
2026-02-20T22:09:17.0234092Z +                "email",
2026-02-20T22:09:17.0234241Z +                "full_name",
2026-02-20T22:09:17.0234359Z +                "role",
2026-02-20T22:09:17.0234482Z +                "is_active",
2026-02-20T22:09:17.0234618Z +                "created_at",
2026-02-20T22:09:17.0234727Z +            ]
2026-02-20T22:09:17.0234888Z          elif export_type == "exercises":
2026-02-20T22:09:17.0235048Z              q = db.query(Exercise)
2026-02-20T22:09:17.0235174Z              if since:
2026-02-20T22:09:17.0235375Z                  q = q.filter(Exercise.created_at >= since)
2026-02-20T22:09:17.0235693Z              rows = q.order_by(Exercise.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0235838Z              rows_data = [
2026-02-20T22:09:17.0236926Z -                [e.id, (e.title or "").replace("\n", " "), e.exercise_type or "", e.difficulty or "", e.age_group or "", e.is_archived, e.created_at.isoformat() if e.created_at else ""]
2026-02-20T22:09:17.0237053Z +                [
2026-02-20T22:09:17.0237418Z +                    e.id,
2026-02-20T22:09:17.0237623Z +                    (e.title or "").replace("\n", " "),
2026-02-20T22:09:17.0237779Z +                    e.exercise_type or "",
2026-02-20T22:09:17.0237936Z +                    e.difficulty or "",
2026-02-20T22:09:17.0238078Z +                    e.age_group or "",
2026-02-20T22:09:17.0238211Z +                    e.is_archived,
2026-02-20T22:09:17.0238450Z +                    e.created_at.isoformat() if e.created_at else "",
2026-02-20T22:09:17.0238573Z +                ]
2026-02-20T22:09:17.0238705Z                  for e in rows
2026-02-20T22:09:17.0238818Z              ]
2026-02-20T22:09:17.0239294Z -            headers = ["id", "title", "exercise_type", "difficulty", "age_group", "is_archived", "created_at"]
2026-02-20T22:09:17.0239436Z +            headers = [
2026-02-20T22:09:17.0239563Z +                "id",
2026-02-20T22:09:17.0239692Z +                "title",
2026-02-20T22:09:17.0239821Z +                "exercise_type",
2026-02-20T22:09:17.0239960Z +                "difficulty",
2026-02-20T22:09:17.0240089Z +                "age_group",
2026-02-20T22:09:17.0240226Z +                "is_archived",
2026-02-20T22:09:17.0240353Z +                "created_at",
2026-02-20T22:09:17.0240460Z +            ]
2026-02-20T22:09:17.0240636Z          elif export_type == "attempts":
2026-02-20T22:09:17.0240786Z              q = db.query(Attempt)
2026-02-20T22:09:17.0240909Z              if since:
2026-02-20T22:09:17.0241103Z                  q = q.filter(Attempt.created_at >= since)
2026-02-20T22:09:17.0241410Z              rows = q.order_by(Attempt.created_at.desc()).limit(MAX_ROWS).all()
2026-02-20T22:09:17.0241567Z              rows_data = [
2026-02-20T22:09:17.0242158Z -                [a.id, a.user_id, a.exercise_id, a.is_correct, a.time_spent or "", a.created_at.isoformat() if a.created_at else ""]
2026-02-20T22:09:17.0242307Z +                [
2026-02-20T22:09:17.0242429Z +                    a.id,
2026-02-20T22:09:17.0242558Z +                    a.user_id,
2026-02-20T22:09:17.0242713Z +                    a.exercise_id,
2026-02-20T22:09:17.0242845Z +                    a.is_correct,
2026-02-20T22:09:17.0243190Z +                    a.time_spent or "",
2026-02-20T22:09:17.0243450Z +                    a.created_at.isoformat() if a.created_at else "",
2026-02-20T22:09:17.0243571Z +                ]
2026-02-20T22:09:17.0243694Z                  for a in rows
2026-02-20T22:09:17.0243805Z              ]
2026-02-20T22:09:17.0244191Z -            headers = ["id", "user_id", "exercise_id", "is_correct", "time_spent", "created_at"]
2026-02-20T22:09:17.0244318Z +            headers = [
2026-02-20T22:09:17.0244439Z +                "id",
2026-02-20T22:09:17.0244582Z +                "user_id",
2026-02-20T22:09:17.0244712Z +                "exercise_id",
2026-02-20T22:09:17.0244836Z +                "is_correct",
2026-02-20T22:09:17.0244967Z +                "time_spent",
2026-02-20T22:09:17.0245100Z +                "created_at",
2026-02-20T22:09:17.0245214Z +            ]
2026-02-20T22:09:17.0245353Z          else:  # overview
2026-02-20T22:09:17.0245629Z              total_users = db.query(func.count(User.id)).scalar() or 0
2026-02-20T22:09:17.0245946Z              total_exercises = db.query(func.count(Exercise.id)).scalar() or 0
2026-02-20T22:09:17.0246301Z              total_challenges = db.query(func.count(LogicChallenge.id)).scalar() or 0
2026-02-20T22:09:17.0246627Z              total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:17.1643948Z --- /home/runner/work/mathakine/mathakine/server/middleware.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.1649254Z +++ /home/runner/work/mathakine/mathakine/server/middleware.py	2026-02-20 22:09:17.161827+00:00
2026-02-20T22:09:17.1660045Z would reformat /home/runner/work/mathakine/mathakine/server/middleware.py
2026-02-20T22:09:17.1665533Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.1669011Z  Middleware for Mathakine.
2026-02-20T22:09:17.1671621Z  
2026-02-20T22:09:17.1674808Z  This module centralizes Starlette middleware logic for consistent
2026-02-20T22:09:17.1677765Z  request processing across the application.
2026-02-20T22:09:17.1680518Z  """
2026-02-20T22:09:17.1683178Z +
2026-02-20T22:09:17.1686697Z  import os
2026-02-20T22:09:17.1690996Z  from typing import Callable, List
2026-02-20T22:09:17.1696082Z  
2026-02-20T22:09:17.1698719Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.1701609Z  from app.utils.settings_reader import get_setting_bool
2026-02-20T22:09:17.1704228Z @@ -36,95 +37,100 @@
2026-02-20T22:09:17.1706779Z          if any(request.url.path.startswith(p) for p in MAINTENANCE_EXEMPT_PREFIXES):
2026-02-20T22:09:17.1713624Z              return await call_next(request)
2026-02-20T22:09:17.1714115Z          try:
2026-02-20T22:09:17.1714551Z              if await get_setting_bool("maintenance_mode", False):
2026-02-20T22:09:17.1715124Z                  return JSONResponse(
2026-02-20T22:09:17.1744880Z -                    {"error": "maintenance", "message": "Le temple est en maintenance. Réessayez plus tard."},
2026-02-20T22:09:17.1747793Z +                    {
2026-02-20T22:09:17.1750193Z +                        "error": "maintenance",
2026-02-20T22:09:17.1753303Z +                        "message": "Le temple est en maintenance. Réessayez plus tard.",
2026-02-20T22:09:17.1756017Z +                    },
2026-02-20T22:09:17.1758397Z                      status_code=503,
2026-02-20T22:09:17.1760814Z                  )
2026-02-20T22:09:17.1763304Z          except Exception as e:
2026-02-20T22:09:17.1765889Z              logger.debug(f"Maintenance check failed (default: off): {e}")
2026-02-20T22:09:17.1768547Z          return await call_next(request)
2026-02-20T22:09:17.1771000Z  
2026-02-20T22:09:17.1773455Z  
2026-02-20T22:09:17.1775381Z  class AuthenticationMiddleware(BaseHTTPMiddleware):
2026-02-20T22:09:17.1804221Z      """
2026-02-20T22:09:17.1804922Z      Middleware for authenticating users.
2026-02-20T22:09:17.1805519Z -    
2026-02-20T22:09:17.1805910Z +
2026-02-20T22:09:17.1806520Z      This middleware checks for authentication tokens in cookies and
2026-02-20T22:09:17.1807405Z      redirects unauthenticated users for protected routes.
2026-02-20T22:09:17.1808079Z      """
2026-02-20T22:09:17.1808473Z -    
2026-02-20T22:09:17.1808864Z +
2026-02-20T22:09:17.1809433Z      async def dispatch(self, request: Request, call_next: Callable):
2026-02-20T22:09:17.1810140Z          """
2026-02-20T22:09:17.1810650Z          Process the request through the middleware.
2026-02-20T22:09:17.1811260Z -        
2026-02-20T22:09:17.1811674Z +
2026-02-20T22:09:17.1812023Z          Args:
2026-02-20T22:09:17.1812463Z              request: The Starlette request object
2026-02-20T22:09:17.1813364Z              call_next: The next middleware or route handler
2026-02-20T22:09:17.1814018Z -            
2026-02-20T22:09:17.1814445Z +
2026-02-20T22:09:17.1814830Z          Returns:
2026-02-20T22:09:17.1815940Z              Starlette Response
2026-02-20T22:09:17.1816666Z          """
2026-02-20T22:09:17.1817844Z          # List of routes that don't require authentication
2026-02-20T22:09:17.1818711Z          public_routes = [
2026-02-20T22:09:17.1819764Z              "/",
2026-02-20T22:09:17.1820416Z              "/metrics",
2026-02-20T22:09:17.1821489Z -            "/login", 
2026-02-20T22:09:17.1822255Z -            "/register", 
2026-02-20T22:09:17.1823546Z -            "/api/auth/login", 
2026-02-20T22:09:17.1824366Z +            "/login",
2026-02-20T22:09:17.1825398Z +            "/register",
2026-02-20T22:09:17.1826289Z +            "/api/auth/login",
2026-02-20T22:09:17.1827796Z              "/api/auth/logout",  # Permet la déconnexion même sans token valide
2026-02-20T22:09:17.1829421Z              "/api/auth/validate-token",  # Validation token pour sync-cookie (sans session)
2026-02-20T22:09:17.1830958Z              "/api/auth/csrf",  # Token CSRF (sans auth)
2026-02-20T22:09:17.1831831Z              "/api/auth/forgot-password",
2026-02-20T22:09:17.1833226Z              "/api/auth/verify-email",
2026-02-20T22:09:17.1834292Z              "/api/auth/resend-verification",
2026-02-20T22:09:17.1835534Z              "/api/users/",
2026-02-20T22:09:17.1836325Z              "/api/exercises",  # API exercises (publique)
2026-02-20T22:09:17.1837625Z              "/api/challenges",  # API challenges (publique)
2026-02-20T22:09:17.1839758Z              "/static",
2026-02-20T22:09:17.1840546Z -            "/exercises"  # On permet l'accès à la liste des exercices sans connexion
2026-02-20T22:09:17.1841586Z +            "/exercises",  # On permet l'accès à la liste des exercices sans connexion
2026-02-20T22:09:17.1842231Z          ]
2026-02-20T22:09:17.1842515Z -        
2026-02-20T22:09:17.1842808Z +
2026-02-20T22:09:17.1843298Z          # Check if the route is public
2026-02-20T22:09:17.1844001Z          is_public = any(request.url.path.startswith(route) for route in public_routes)
2026-02-20T22:09:17.1844683Z -        
2026-02-20T22:09:17.1844962Z +
2026-02-20T22:09:17.1845230Z          if is_public:
2026-02-20T22:09:17.1845648Z              response = await call_next(request)
2026-02-20T22:09:17.1846122Z              return response
2026-02-20T22:09:17.1846484Z -        
2026-02-20T22:09:17.1846743Z +
2026-02-20T22:09:17.1847040Z          # Check for authentication token
2026-02-20T22:09:17.1847587Z          access_token = request.cookies.get("access_token")
2026-02-20T22:09:17.1848121Z          if not access_token:
2026-02-20T22:09:17.1848698Z              logger.info(f"Unauthorized access attempt to {request.url.path}")
2026-02-20T22:09:17.1849459Z              # Return 401 JSON response (API backend, no HTML redirect)
2026-02-20T22:09:17.1850054Z              return JSONResponse(
2026-02-20T22:09:17.1850634Z                  {"error": "Unauthorized", "message": "Authentication required"},
2026-02-20T22:09:17.1851252Z -                status_code=401
2026-02-20T22:09:17.1851659Z +                status_code=401,
2026-02-20T22:09:17.1852039Z              )
2026-02-20T22:09:17.1852331Z -            
2026-02-20T22:09:17.1852609Z +
2026-02-20T22:09:17.1852868Z          try:
2026-02-20T22:09:17.1853368Z              # Verify the token
2026-02-20T22:09:17.1853834Z              from app.core.security import decode_token
2026-02-20T22:09:17.1854300Z +
2026-02-20T22:09:17.1854631Z              payload = decode_token(access_token)
2026-02-20T22:09:17.1855089Z -            
2026-02-20T22:09:17.1855378Z +
2026-02-20T22:09:17.1855726Z              # Continue with the request if token is valid
2026-02-20T22:09:17.1856277Z              response = await call_next(request)
2026-02-20T22:09:17.1856746Z              return response
2026-02-20T22:09:17.1857094Z -            
2026-02-20T22:09:17.1857373Z +
2026-02-20T22:09:17.1857680Z          except Exception as auth_error:
2026-02-20T22:09:17.1858351Z              logger.error(f"Invalid token for {request.url.path}: {str(auth_error)}")
2026-02-20T22:09:17.1859157Z              # Return 401 JSON response (API backend, no HTML redirect)
2026-02-20T22:09:17.1859752Z              return JSONResponse(
2026-02-20T22:09:17.1860323Z                  {"error": "Unauthorized", "message": "Invalid or expired token"},
2026-02-20T22:09:17.1860958Z -                status_code=401
2026-02-20T22:09:17.1861344Z +                status_code=401,
2026-02-20T22:09:17.1861701Z              )
2026-02-20T22:09:17.1861975Z  
2026-02-20T22:09:17.1862211Z +
2026-02-20T22:09:17.1862533Z  def get_middleware() -> List[Middleware]:
2026-02-20T22:09:17.1863161Z      """
2026-02-20T22:09:17.1863647Z      Get the list of middleware for use in Starlette app initialization.
2026-02-20T22:09:17.1864247Z -    
2026-02-20T22:09:17.1864519Z +
2026-02-20T22:09:17.1864778Z      Returns:
2026-02-20T22:09:17.1865392Z          List of Middleware instances
2026-02-20T22:09:17.1865813Z      """
2026-02-20T22:09:17.1866288Z      # Liste des origines autorisées pour CORS
2026-02-20T22:09:17.1867175Z      # IMPORTANT: Ne pas utiliser "*" quand credentials='include' est utilisé côté client
2026-02-20T22:09:17.1867881Z @@ -132,56 +138,64 @@
2026-02-20T22:09:17.1868489Z          "http://localhost:3000",
2026-02-20T22:09:17.1868974Z          "http://localhost:5173",
2026-02-20T22:09:17.1869416Z          "http://127.0.0.1:3000",
2026-02-20T22:09:17.1869831Z          "http://127.0.0.1:5173",
2026-02-20T22:09:17.1870214Z      ]
2026-02-20T22:09:17.1870484Z -    
2026-02-20T22:09:17.1870741Z +
2026-02-20T22:09:17.1871391Z      # Ajouter FRONTEND_URL + variantes www/non-www pour éviter OPTIONS 400
2026-02-20T22:09:17.1872135Z      frontend_url = os.getenv("FRONTEND_URL", "").strip()
2026-02-20T22:09:17.1872654Z      if frontend_url:
2026-02-20T22:09:17.1903321Z          allowed_origins.append(frontend_url)
2026-02-20T22:09:17.1904162Z          # Si https://mathakine.fun, ajouter https://www.mathakine.fun et inversement
2026-02-20T22:09:17.1904860Z          try:
2026-02-20T22:09:17.1905216Z              from urllib.parse import urlparse
2026-02-20T22:09:17.1905665Z +
2026-02-20T22:09:17.1905977Z              parsed = urlparse(frontend_url)
2026-02-20T22:09:17.1906738Z -            if parsed.netloc and "." in parsed.netloc and not parsed.netloc.startswith("www."):
2026-02-20T22:09:17.1907462Z +            if (
2026-02-20T22:09:17.1907794Z +                parsed.netloc
2026-02-20T22:09:17.1908200Z +                and "." in parsed.netloc
2026-02-20T22:09:17.1908713Z +                and not parsed.netloc.startswith("www.")
2026-02-20T22:09:17.1909188Z +            ):
2026-02-20T22:09:17.1909703Z                  allowed_origins.append(f"{parsed.scheme}://www.{parsed.netloc}")
2026-02-20T22:09:17.1910415Z              elif parsed.netloc.startswith("www."):
2026-02-20T22:09:17.1911104Z                  allowed_origins.append(f"{parsed.scheme}://{parsed.netloc[4:]}")
2026-02-20T22:09:17.1911776Z          except Exception:
2026-02-20T22:09:17.1912130Z              pass
2026-02-20T22:09:17.1912716Z          # Fallback Render frontend si déployé sur Render
2026-02-20T22:09:17.1913677Z          if "mathakine" in frontend_url.lower() and "render.com" not in frontend_url:
2026-02-20T22:09:17.1914594Z              allowed_origins.append("https://mathakine-frontend.onrender.com")
2026-02-20T22:09:17.1915263Z -    
2026-02-20T22:09:17.1915534Z +
2026-02-20T22:09:17.1915966Z      # Filtrer les chaînes vides et doublons
2026-02-20T22:09:17.1916604Z      allowed_origins = list(dict.fromkeys(o for o in allowed_origins if o))
2026-02-20T22:09:17.1917230Z  
2026-02-20T22:09:17.1917541Z      middleware_list = []
2026-02-20T22:09:17.1917860Z  
2026-02-20T22:09:17.1918578Z      # Prometheus métriques (audit HIGH #1) — en premier pour capturer toutes les requêtes
2026-02-20T22:09:17.1919302Z      try:
2026-02-20T22:09:17.1919759Z          from app.core.monitoring import PrometheusMetricsMiddleware
2026-02-20T22:09:17.1920367Z +
2026-02-20T22:09:17.1920848Z          middleware_list.append(Middleware(PrometheusMetricsMiddleware))
2026-02-20T22:09:17.1921500Z      except ImportError:
2026-02-20T22:09:17.1921857Z          pass
2026-02-20T22:09:17.1922151Z  
2026-02-20T22:09:17.1922458Z -    middleware_list.extend([
2026-02-20T22:09:17.1922857Z -        Middleware(
2026-02-20T22:09:17.1953856Z -            CORSMiddleware,
2026-02-20T22:09:17.1954316Z -            allow_origins=allowed_origins,
2026-02-20T22:09:17.1954959Z -            allow_methods=["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
2026-02-20T22:09:17.1955947Z -            # Audit 4.2: restreindre aux headers utilisés par le frontend
2026-02-20T22:09:17.1956620Z -            allow_headers=[
2026-02-20T22:09:17.1957019Z -                "Content-Type",
2026-02-20T22:09:17.1957435Z -                "Authorization",
2026-02-20T22:09:17.1957825Z -                "Accept",
2026-02-20T22:09:17.1958206Z -                "Accept-Language",
2026-02-20T22:09:17.1959005Z -                "X-CSRF-Token",  # Protection CSRF (audit 3.2)
2026-02-20T22:09:17.1959524Z -            ],
2026-02-20T22:09:17.1960038Z -            allow_credentials=True,  # Important pour les cookies HTTP-only
2026-02-20T22:09:17.1960646Z -        ),
2026-02-20T22:09:17.1976750Z -        Middleware(MaintenanceMiddleware),
2026-02-20T22:09:17.1977341Z -        Middleware(AuthenticationMiddleware)
2026-02-20T22:09:17.1977836Z -    ])
2026-02-20T22:09:17.1978142Z +    middleware_list.extend(
2026-02-20T22:09:17.1978523Z +        [
2026-02-20T22:09:17.1978811Z +            Middleware(
2026-02-20T22:09:17.1979186Z +                CORSMiddleware,
2026-02-20T22:09:17.1979698Z +                allow_origins=allowed_origins,
2026-02-20T22:09:17.1980366Z +                allow_methods=["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
2026-02-20T22:09:17.1981368Z +                # Audit 4.2: restreindre aux headers utilisés par le frontend
2026-02-20T22:09:17.1982007Z +                allow_headers=[
2026-02-20T22:09:17.1982417Z +                    "Content-Type",
2026-02-20T22:09:17.1982845Z +                    "Authorization",
2026-02-20T22:09:17.2013604Z +                    "Accept",
2026-02-20T22:09:17.2014030Z +                    "Accept-Language",
2026-02-20T22:09:17.2014584Z +                    "X-CSRF-Token",  # Protection CSRF (audit 3.2)
2026-02-20T22:09:17.2015102Z +                ],
2026-02-20T22:09:17.2015620Z +                allow_credentials=True,  # Important pour les cookies HTTP-only
2026-02-20T22:09:17.2016257Z +            ),
2026-02-20T22:09:17.2016616Z +            Middleware(MaintenanceMiddleware),
2026-02-20T22:09:17.2017163Z +            Middleware(AuthenticationMiddleware),
2026-02-20T22:09:17.2017632Z +        ]
2026-02-20T22:09:17.2017906Z +    )
2026-02-20T22:09:17.2018168Z  
2026-02-20T22:09:17.2018448Z      return middleware_list
2026-02-20T22:09:17.2603984Z --- /home/runner/work/mathakine/mathakine/server/exercise_generator.py	2026-02-20 22:09:02.837965+00:00
2026-02-20T22:09:17.2605303Z +++ /home/runner/work/mathakine/mathakine/server/exercise_generator.py	2026-02-20 22:09:17.228467+00:00
2026-02-20T22:09:17.2606134Z @@ -1,15 +1,24 @@
2026-02-20T22:09:17.2606431Z  """
2026-02-20T22:09:17.2607154Z  Module de génération d'exercices pour enhanced_server.py
2026-02-20T22:09:17.2607696Z  """
2026-02-20T22:09:17.2607961Z +
2026-02-20T22:09:17.2608217Z  import json
2026-02-20T22:09:17.2608522Z  import os
2026-02-20T22:09:17.2608800Z  import random
2026-02-20T22:09:17.2609174Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:17.2609634Z  
2026-02-20T22:09:17.2609968Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.2611064Z -from app.core.constants import (DIFFICULTY_LIMITS, DifficultyLevels, ExerciseTypes, Messages, Tags, AgeGroups, normalize_age_group)
2026-02-20T22:09:17.2612147Z +from app.core.constants import (
2026-02-20T22:09:17.2612581Z +    DIFFICULTY_LIMITS,
2026-02-20T22:09:17.2613143Z +    DifficultyLevels,
2026-02-20T22:09:17.2613512Z +    ExerciseTypes,
2026-02-20T22:09:17.2613828Z +    Messages,
2026-02-20T22:09:17.2614120Z +    Tags,
2026-02-20T22:09:17.2614403Z +    AgeGroups,
2026-02-20T22:09:17.2614710Z +    normalize_age_group,
2026-02-20T22:09:17.2615056Z +)
2026-02-20T22:09:17.2615309Z  
2026-02-20T22:09:17.2615611Z  logger = get_logger(__name__)
2026-02-20T22:09:17.2616183Z  from app.core.messages import ExerciseMessages, StarWarsNarratives
2026-02-20T22:09:17.2617015Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:17.2617632Z  
2026-02-20T22:09:17.2617900Z @@ -33,20 +42,23 @@
2026-02-20T22:09:17.2618195Z  
2026-02-20T22:09:17.2618576Z      # Parcourir tous les types d'exercices et leurs alias
2026-02-20T22:09:17.2619244Z      for type_key, aliases in ExerciseTypes.TYPE_ALIASES.items():
2026-02-20T22:09:17.2619838Z          if exercise_type_lower in aliases:
2026-02-20T22:09:17.2620297Z              return type_key
2026-02-20T22:09:17.2621063Z -    
2026-02-20T22:09:17.2621338Z +
2026-02-20T22:09:17.2621994Z      # Si aucune correspondance trouvée, essayer de convertir en majuscule
2026-02-20T22:09:17.2622804Z      # et vérifier si c'est une valeur enum valide
2026-02-20T22:09:17.2623533Z      exercise_type_upper = exercise_type.upper()
2026-02-20T22:09:17.2624332Z      if exercise_type_upper in ExerciseTypes.ALL_TYPES:
2026-02-20T22:09:17.2624870Z          return exercise_type_upper
2026-02-20T22:09:17.2625233Z -    
2026-02-20T22:09:17.2634035Z +
2026-02-20T22:09:17.2634915Z      # Si toujours aucune correspondance, logger un avertissement et retourner ADDITION par défaut
2026-02-20T22:09:17.2636309Z -    logger.info(f"⚠️ Type d'exercice non reconnu: {exercise_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.2637124Z +    logger.info(
2026-02-20T22:09:17.2637900Z +        f"⚠️ Type d'exercice non reconnu: {exercise_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.2638629Z +    )
2026-02-20T22:09:17.2638948Z      return ExerciseTypes.ADDITION
2026-02-20T22:09:17.2639376Z +
2026-02-20T22:09:17.2639626Z  
2026-02-20T22:09:17.2639929Z  def normalize_difficulty(difficulty):
2026-02-20T22:09:17.2640517Z      """Normalise le niveau de difficulté"""
2026-02-20T22:09:17.2640986Z      if not difficulty:
2026-02-20T22:09:17.2641389Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2641834Z @@ -55,52 +67,60 @@
2026-02-20T22:09:17.2642126Z  
2026-02-20T22:09:17.2642678Z      # Parcourir tous les niveaux de difficulté et leurs alias
2026-02-20T22:09:17.2643706Z      for level_key, aliases in DifficultyLevels.LEVEL_ALIASES.items():
2026-02-20T22:09:17.2644352Z          if difficulty_lower in aliases:
2026-02-20T22:09:17.2644794Z              return level_key
2026-02-20T22:09:17.2645128Z -    
2026-02-20T22:09:17.2645413Z +
2026-02-20T22:09:17.2646059Z      # Si aucune correspondance trouvée, essayer de convertir en majuscule
2026-02-20T22:09:17.2646891Z      # et vérifier si c'est une valeur enum valide
2026-02-20T22:09:17.2647456Z      difficulty_upper = difficulty.upper()
2026-02-20T22:09:17.2648045Z      if difficulty_upper in DifficultyLevels.ALL_LEVELS:
2026-02-20T22:09:17.2648566Z          return difficulty_upper
2026-02-20T22:09:17.2648925Z -            
2026-02-20T22:09:17.2649193Z +
2026-02-20T22:09:17.2649976Z      # Si toujours aucune correspondance, logger un avertissement et retourner PADAWAN par défaut
2026-02-20T22:09:17.2651385Z -    logger.info(f"⚠️ Niveau de difficulté non reconnu: {difficulty}, utilisation de PADAWAN par défaut")
2026-02-20T22:09:17.2652239Z +    logger.info(
2026-02-20T22:09:17.2653236Z +        f"⚠️ Niveau de difficulté non reconnu: {difficulty}, utilisation de PADAWAN par défaut"
2026-02-20T22:09:17.2653993Z +    )
2026-02-20T22:09:17.2654315Z      return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2654737Z  
2026-02-20T22:09:17.2654986Z  
2026-02-20T22:09:17.2655745Z -def normalize_and_validate_exercise_params(exercise_type_raw: Optional[str], age_group_raw: Optional[str]) -> tuple:
2026-02-20T22:09:17.2656770Z +def normalize_and_validate_exercise_params(
2026-02-20T22:09:17.2657386Z +    exercise_type_raw: Optional[str], age_group_raw: Optional[str]
2026-02-20T22:09:17.2657971Z +) -> tuple:
2026-02-20T22:09:17.2658247Z      """
2026-02-20T22:09:17.2658906Z      Normalise et valide les paramètres d'exercice (type et groupe d'âge).
2026-02-20T22:09:17.2659809Z      Retourne le type, le groupe d'âge, et la difficulté dérivée.
2026-02-20T22:09:17.2660379Z      """
2026-02-20T22:09:17.2660790Z      from app.core.constants import ExerciseTypes, AgeGroups
2026-02-20T22:09:17.2661319Z  
2026-02-20T22:09:17.2661709Z      # Normaliser les paramètres
2026-02-20T22:09:17.2662247Z      exercise_type = normalize_exercise_type(exercise_type_raw)
2026-02-20T22:09:17.2662874Z      age_group = normalize_age_group(age_group_raw)
2026-02-20T22:09:17.2671198Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.2671774Z -    
2026-02-20T22:09:17.2672039Z +
2026-02-20T22:09:17.2672801Z      # Valider que le type normalisé est valide
2026-02-20T22:09:17.2673567Z      if exercise_type not in ExerciseTypes.ALL_TYPES:
2026-02-20T22:09:17.2674616Z -        logger.info(f"⚠️ Type normalisé invalide: {exercise_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.2675705Z +        logger.info(
2026-02-20T22:09:17.2676552Z +            f"⚠️ Type normalisé invalide: {exercise_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.2677270Z +        )
2026-02-20T22:09:17.2677604Z          exercise_type = ExerciseTypes.ADDITION
2026-02-20T22:09:17.2678025Z  
2026-02-20T22:09:17.2678478Z      # Valider que le groupe d'âge normalisé est valide
2026-02-20T22:09:17.2678990Z      if age_group not in AgeGroups.ALL_GROUPS:
2026-02-20T22:09:17.2680096Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group_raw}, utilisation de {AgeGroups.GROUP_6_8} par défaut")
2026-02-20T22:09:17.2680904Z +        logger.info(
2026-02-20T22:09:17.2681755Z +            f"⚠️ Groupe d'âge non reconnu: {age_group_raw}, utilisation de {AgeGroups.GROUP_6_8} par défaut"
2026-02-20T22:09:17.2682476Z +        )
2026-02-20T22:09:17.2682795Z          age_group = AgeGroups.GROUP_6_8
2026-02-20T22:09:17.2683603Z          derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.2684178Z -    
2026-02-20T22:09:17.2684451Z +
2026-02-20T22:09:17.2684823Z      return exercise_type, age_group, derived_difficulty
2026-02-20T22:09:17.2685322Z  
2026-02-20T22:09:17.2685566Z  
2026-02-20T22:09:17.2685957Z  def get_difficulty_from_age_group(age_group: str) -> str:
2026-02-20T22:09:17.2686471Z      """
2026-02-20T22:09:17.2687187Z      Détermine le niveau de difficulté (INITIE, PADAWAN, ...) à partir du groupe d'âge.
2026-02-20T22:09:17.2687859Z -    
2026-02-20T22:09:17.2688117Z +
2026-02-20T22:09:17.2688521Z      Mapping (aligné avec app/core/constants.py) :
2026-02-20T22:09:17.2689108Z      - 6-8 ans → INITIE (débutant)
2026-02-20T22:09:17.2689626Z      - 9-11 ans → PADAWAN (intermédiaire)
2026-02-20T22:09:17.2690193Z      - 12-14 ans → CHEVALIER (avancé)
2026-02-20T22:09:17.2690720Z      - 15-17 ans → MAITRE (expert)
2026-02-20T22:09:17.2691107Z @@ -120,482 +140,585 @@
2026-02-20T22:09:17.2691479Z          return DifficultyLevels.MAITRE
2026-02-20T22:09:17.2691936Z      elif age_group == AgeGroups.ADULT:
2026-02-20T22:09:17.2692431Z          return DifficultyLevels.GRAND_MAITRE
2026-02-20T22:09:17.2692871Z      else:
2026-02-20T22:09:17.2693611Z          # Valeur par défaut si le groupe d'âge n'est pas reconnu
2026-02-20T22:09:17.2694754Z -        logger.info(f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut")
2026-02-20T22:09:17.2695635Z +        logger.info(
2026-02-20T22:09:17.2696498Z +            f"⚠️ Groupe d'âge non reconnu: {age_group}, utilisation de {DifficultyLevels.PADAWAN} par défaut"
2026-02-20T22:09:17.2697264Z +        )
2026-02-20T22:09:17.2697585Z          return DifficultyLevels.PADAWAN
2026-02-20T22:09:17.2698003Z +
2026-02-20T22:09:17.2698277Z  
2026-02-20T22:09:17.2698651Z  # Fonctions de génération d'exercices
2026-02-20T22:09:17.2699162Z  def generate_ai_exercise(exercise_type, age_group):
2026-02-20T22:09:17.2699630Z      """
2026-02-20T22:09:17.2700229Z      Génère un exercice avec IA en utilisant des prompts et contextes Star Wars
2026-02-20T22:09:17.2700859Z      """
2026-02-20T22:09:17.2701251Z      normalized_type = normalize_exercise_type(exercise_type)
2026-02-20T22:09:17.2701910Z      normalized_age_group = normalize_age_group(age_group)
2026-02-20T22:09:17.2702751Z -    derived_difficulty = get_difficulty_from_age_group(normalized_age_group) # Derive difficulty
2026-02-20T22:09:17.2703659Z -    
2026-02-20T22:09:17.2704027Z +    derived_difficulty = get_difficulty_from_age_group(
2026-02-20T22:09:17.2704546Z +        normalized_age_group
2026-02-20T22:09:17.2704920Z +    )  # Derive difficulty
2026-02-20T22:09:17.2705243Z +
2026-02-20T22:09:17.2705823Z      # Récupérer les limites pour ce type d'exercice et cette difficulté
2026-02-20T22:09:17.2707273Z -    difficulty_config = DIFFICULTY_LIMITS.get(derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]) # Use derived_difficulty
2026-02-20T22:09:17.2708759Z -    type_limits = difficulty_config.get(normalized_type, difficulty_config.get("default", {"min": 1, "max": 10}))
2026-02-20T22:09:17.2709784Z -    
2026-02-20T22:09:17.2710141Z +    difficulty_config = DIFFICULTY_LIMITS.get(
2026-02-20T22:09:17.2710797Z +        derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]
2026-02-20T22:09:17.2711410Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2711821Z +    type_limits = difficulty_config.get(
2026-02-20T22:09:17.2712454Z +        normalized_type, difficulty_config.get("default", {"min": 1, "max": 10})
2026-02-20T22:09:17.2713260Z +    )
2026-02-20T22:09:17.2713501Z +
2026-02-20T22:09:17.2714125Z      # Structure de base commune pour tous les types d'exercices générés par IA
2026-02-20T22:09:17.2714752Z      exercise_data = {
2026-02-20T22:09:17.2715128Z          "exercise_type": normalized_type,
2026-02-20T22:09:17.2715647Z -        "age_group": normalized_age_group, # Store age_group
2026-02-20T22:09:17.2716237Z +        "age_group": normalized_age_group,  # Store age_group
2026-02-20T22:09:17.2716892Z          "difficulty": derived_difficulty,  # Store derived difficulty
2026-02-20T22:09:17.2717460Z          "ai_generated": True,
2026-02-20T22:09:17.2717940Z -        "tags": Tags.AI + "," + Tags.GENERATIVE + "," + Tags.STARWARS
2026-02-20T22:09:17.2718595Z +        "tags": Tags.AI + "," + Tags.GENERATIVE + "," + Tags.STARWARS,
2026-02-20T22:09:17.2719116Z      }
2026-02-20T22:09:17.2719363Z -    
2026-02-20T22:09:17.2719611Z +
2026-02-20T22:09:17.2720059Z      # Préfixe et suffixe pour enrichir l'explication
2026-02-20T22:09:17.2720990Z -    explanation_prefix = StarWarsNarratives.get_explanation_prefix(derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2722310Z -    explanation_suffix = StarWarsNarratives.get_explanation_suffix(derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2723397Z -    
2026-02-20T22:09:17.2723872Z +    explanation_prefix = StarWarsNarratives.get_explanation_prefix(
2026-02-20T22:09:17.2724482Z +        derived_difficulty
2026-02-20T22:09:17.2724855Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2725431Z +    explanation_suffix = StarWarsNarratives.get_explanation_suffix(
2026-02-20T22:09:17.2726041Z +        derived_difficulty
2026-02-20T22:09:17.2726412Z +    )  # Use derived_difficulty
2026-02-20T22:09:17.2726765Z +
2026-02-20T22:09:17.2727114Z      if normalized_type == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.2727995Z          # Utiliser les limites de difficulté pour déterminer les plages de nombres
2026-02-20T22:09:17.2728695Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.2729161Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.2729584Z -        
2026-02-20T22:09:17.2729852Z +
2026-02-20T22:09:17.2730158Z          num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2730666Z          num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2731108Z          result = num1 + num2
2026-02-20T22:09:17.2731460Z -        
2026-02-20T22:09:17.2731709Z +
2026-02-20T22:09:17.2732088Z          # Thème Star Wars pour l'addition
2026-02-20T22:09:17.2732745Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2733656Z -            question_template = random.choice([
2026-02-20T22:09:17.2734722Z -                f"Tu as trouvé {num1} cristaux Kyber et ton ami en a trouvé {num2}. Combien avez-vous de cristaux au total?",
2026-02-20T22:09:17.2736156Z -                f"Il y a {num1} droïdes dans le hangar et {num2} droïdes dans l'atelier. Combien y a-t-il de droïdes en tout?",
2026-02-20T22:09:17.2737426Z -                f"Tu as parcouru {num1} parsecs hier et {num2} parsecs aujourd'hui. Quelle distance as-tu parcourue en tout?"
2026-02-20T22:09:17.2738282Z -            ])
2026-02-20T22:09:17.2738827Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2739782Z +            question_template = random.choice(
2026-02-20T22:09:17.2740213Z +                [
2026-02-20T22:09:17.2741336Z +                    f"Tu as trouvé {num1} cristaux Kyber et ton ami en a trouvé {num2}. Combien avez-vous de cristaux au total?",
2026-02-20T22:09:17.2742846Z +                    f"Il y a {num1} droïdes dans le hangar et {num2} droïdes dans l'atelier. Combien y a-t-il de droïdes en tout?",
2026-02-20T22:09:17.2744347Z +                    f"Tu as parcouru {num1} parsecs hier et {num2} parsecs aujourd'hui. Quelle distance as-tu parcourue en tout?",
2026-02-20T22:09:17.2745206Z +                ]
2026-02-20T22:09:17.2745503Z +            )
2026-02-20T22:09:17.2746373Z              explanation_template = f"Pour trouver la réponse, tu dois additionner {num1} et {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2747295Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2747844Z -            question_template = random.choice([
2026-02-20T22:09:17.2749222Z -                f"Un escadron de {num1} X-wings et un escadron de {num2} Y-wings se préparent pour attaquer l'Étoile de la Mort. Combien de vaisseaux y a-t-il au total?",
2026-02-20T22:09:17.2751154Z -                f"L'Empire a envoyé {num1} stormtroopers sur Endor et {num2} stormtroopers sur Hoth. Combien de stormtroopers ont été déployés en tout?",
2026-02-20T22:09:17.2752884Z -                f"Un destroyer stellaire contient {num1} TIE fighters et {num2} navettes. Combien de vaisseaux sont à bord au total?"
2026-02-20T22:09:17.2753977Z -            ])
2026-02-20T22:09:17.2754376Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2754910Z +            question_template = random.choice(
2026-02-20T22:09:17.2755354Z +                [
2026-02-20T22:09:17.2756615Z +                    f"Un escadron de {num1} X-wings et un escadron de {num2} Y-wings se préparent pour attaquer l'Étoile de la Mort. Combien de vaisseaux y a-t-il au total?",
2026-02-20T22:09:17.2758663Z +                    f"L'Empire a envoyé {num1} stormtroopers sur Endor et {num2} stormtroopers sur Hoth. Combien de stormtroopers ont été déployés en tout?",
2026-02-20T22:09:17.2765407Z +                    f"Un destroyer stellaire contient {num1} TIE fighters et {num2} navettes. Combien de vaisseaux sont à bord au total?",
2026-02-20T22:09:17.2766354Z +                ]
2026-02-20T22:09:17.2766673Z +            )
2026-02-20T22:09:17.2767422Z              explanation_template = f"Pour calculer le total, on additionne les deux nombres: {num1} + {num2} = {result}."
2026-02-20T22:09:17.2768312Z -        
2026-02-20T22:09:17.2768593Z +
2026-02-20T22:09:17.2769122Z          # Générer des choix intelligents avec erreurs typiques
2026-02-20T22:09:17.2770104Z -        choices = generate_smart_choices("ADDITION", num1, num2, result, derived_difficulty) # Use derived_difficulty
2026-02-20T22:09:17.2770969Z -        
2026-02-20T22:09:17.2771305Z -        exercise_data.update({
2026-02-20T22:09:17.2772320Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Alliance Rebelle - Addition pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2773609Z -            "question": question_template,
2026-02-20T22:09:17.2774110Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2774545Z -            "choices": choices,
2026-02-20T22:09:17.2774940Z -            "num1": num1,
2026-02-20T22:09:17.2775295Z -            "num2": num2,
2026-02-20T22:09:17.2776143Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2777057Z -        })
2026-02-20T22:09:17.2777438Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2777967Z +        choices = generate_smart_choices(
2026-02-20T22:09:17.2778502Z +            "ADDITION", num1, num2, result, derived_difficulty
2026-02-20T22:09:17.2779302Z +        )  # Use derived_difficulty
2026-02-20T22:09:17.2779700Z +
2026-02-20T22:09:17.2780084Z +        exercise_data.update(
2026-02-20T22:09:17.2780455Z +            {
2026-02-20T22:09:17.2781620Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Alliance Rebelle - Addition pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2782749Z +                "question": question_template,
2026-02-20T22:09:17.2783454Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2783920Z +                "choices": choices,
2026-02-20T22:09:17.2784319Z +                "num1": num1,
2026-02-20T22:09:17.2784688Z +                "num2": num2,
2026-02-20T22:09:17.2785536Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2786456Z +            }
2026-02-20T22:09:17.2786731Z +        )
2026-02-20T22:09:17.2787065Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2787633Z      elif normalized_type == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.2788474Z          # Paramètres pour la soustraction avec des limites adaptatives
2026-02-20T22:09:17.2789074Z          min1 = type_limits.get("min1", 5)
2026-02-20T22:09:17.2789538Z          max1 = type_limits.get("max1", 20)
2026-02-20T22:09:17.2789999Z          min2 = type_limits.get("min2", 1)
2026-02-20T22:09:17.2790438Z          max2 = type_limits.get("max2", 5)
2026-02-20T22:09:17.2790842Z -        
2026-02-20T22:09:17.2791105Z +
2026-02-20T22:09:17.2791408Z          num1 = random.randint(min1, max1)
2026-02-20T22:09:17.2792349Z -        num2 = random.randint(min2, min(num1-1, max2))  # Eviter les soustractions avec résultat négatif
2026-02-20T22:09:17.2793327Z +        num2 = random.randint(
2026-02-20T22:09:17.2793730Z +            min2, min(num1 - 1, max2)
2026-02-20T22:09:17.2794342Z +        )  # Eviter les soustractions avec résultat négatif
2026-02-20T22:09:17.2794870Z          result = num1 - num2
2026-02-20T22:09:17.2795237Z -        
2026-02-20T22:09:17.2795504Z +
2026-02-20T22:09:17.2795903Z          # Thème Star Wars pour la soustraction
2026-02-20T22:09:17.2796590Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2797319Z -            question_template = random.choice([
2026-02-20T22:09:17.2798279Z -                f"Tu as {num1} portions de rations, mais tu en as utilisé {num2}. Combien te reste-t-il?",
2026-02-20T22:09:17.2799636Z -                f"Il y avait {num1} droïdes dans le hangar, mais {num2} sont partis en mission. Combien reste-t-il de droïdes?",
2026-02-20T22:09:17.2813813Z -                f"Tu as parcouru {num1} années-lumière, mais il te reste encore {num2} années-lumière à faire. Quelle distance as-tu déjà parcourue?"
2026-02-20T22:09:17.2814827Z -            ])
2026-02-20T22:09:17.2815359Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2816102Z +            question_template = random.choice(
2026-02-20T22:09:17.2816584Z +                [
2026-02-20T22:09:17.2817420Z +                    f"Tu as {num1} portions de rations, mais tu en as utilisé {num2}. Combien te reste-t-il?",
2026-02-20T22:09:17.2818873Z +                    f"Il y avait {num1} droïdes dans le hangar, mais {num2} sont partis en mission. Combien reste-t-il de droïdes?",
2026-02-20T22:09:17.2820575Z +                    f"Tu as parcouru {num1} années-lumière, mais il te reste encore {num2} années-lumière à faire. Quelle distance as-tu déjà parcourue?",
2026-02-20T22:09:17.2821601Z +                ]
2026-02-20T22:09:17.2821914Z +            )
2026-02-20T22:09:17.2822867Z              explanation_template = f"Pour trouver la réponse, tu dois soustraire {num2} de {num1}, ce qui donne {result}."
2026-02-20T22:09:17.2825086Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2825632Z -            question_template = random.choice([
2026-02-20T22:09:17.2826923Z -                f"La flotte rebelle comptait {num1} vaisseaux, mais {num2} ont été détruits dans la bataille. Combien de vaisseaux reste-t-il?",
2026-02-20T22:09:17.2828937Z -                f"L'Empire avait {num1} planètes sous son contrôle, mais {num2} se sont rebellées. Combien de planètes restent loyales?",
2026-02-20T22:09:17.2830933Z -                f"Le Faucon Millenium a {num1} pièces de contrebande, mais {num2} sont confisquées par les Impériaux. Combien de pièces reste-t-il?"
2026-02-20T22:09:17.2832063Z -            ])
2026-02-20T22:09:17.2832758Z -            explanation_template = f"Pour calculer ce qui reste, on soustrait: {num1} - {num2} = {result}."
2026-02-20T22:09:17.2833742Z -        
2026-02-20T22:09:17.2834108Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2834652Z +            question_template = random.choice(
2026-02-20T22:09:17.2835109Z +                [
2026-02-20T22:09:17.2836257Z +                    f"La flotte rebelle comptait {num1} vaisseaux, mais {num2} ont été détruits dans la bataille. Combien de vaisseaux reste-t-il?",
2026-02-20T22:09:17.2838025Z +                    f"L'Empire avait {num1} planètes sous son contrôle, mais {num2} se sont rebellées. Combien de planètes restent loyales?",
2026-02-20T22:09:17.2839819Z +                    f"Le Faucon Millenium a {num1} pièces de contrebande, mais {num2} sont confisquées par les Impériaux. Combien de pièces reste-t-il?",
2026-02-20T22:09:17.2840850Z +                ]
2026-02-20T22:09:17.2841142Z +            )
2026-02-20T22:09:17.2841473Z +            explanation_template = (
2026-02-20T22:09:17.2842096Z +                f"Pour calculer ce qui reste, on soustrait: {num1} - {num2} = {result}."
2026-02-20T22:09:17.2842784Z +            )
2026-02-20T22:09:17.2843270Z +
2026-02-20T22:09:17.2843754Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2844232Z          choices = [
2026-02-20T22:09:17.2844561Z              str(result),
2026-02-20T22:09:17.2844996Z              str(result + random.randint(1, min(5, max2))),
2026-02-20T22:09:17.2845632Z -            str(result - random.randint(1, min(3, result//2))),
2026-02-20T22:09:17.2846355Z -            str(num2 - num1)  # Erreur commune: inverser l'ordre de la soustraction
2026-02-20T22:09:17.2847144Z +            str(result - random.randint(1, min(3, result // 2))),
2026-02-20T22:09:17.2847899Z +            str(num2 - num1),  # Erreur commune: inverser l'ordre de la soustraction
2026-02-20T22:09:17.2848496Z          ]
2026-02-20T22:09:17.2848800Z          random.shuffle(choices)
2026-02-20T22:09:17.2849165Z -        
2026-02-20T22:09:17.2849459Z -        exercise_data.update({
2026-02-20T22:09:17.2850527Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Conflit galactique - Soustraction pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2851672Z -            "question": question_template,
2026-02-20T22:09:17.2852132Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2852513Z -            "choices": choices,
2026-02-20T22:09:17.2852887Z -            "num1": num1,
2026-02-20T22:09:17.2853417Z -            "num2": num2,
2026-02-20T22:09:17.2854254Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2855170Z -        })
2026-02-20T22:09:17.2855566Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2856056Z +
2026-02-20T22:09:17.2856335Z +        exercise_data.update(
2026-02-20T22:09:17.2856699Z +            {
2026-02-20T22:09:17.2857659Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Conflit galactique - Soustraction pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2858779Z +                "question": question_template,
2026-02-20T22:09:17.2859250Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2859693Z +                "choices": choices,
2026-02-20T22:09:17.2860081Z +                "num1": num1,
2026-02-20T22:09:17.2860677Z +                "num2": num2,
2026-02-20T22:09:17.2861553Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2862467Z +            }
2026-02-20T22:09:17.2862749Z +        )
2026-02-20T22:09:17.2863441Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2864041Z      elif normalized_type == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.2864844Z          # Utiliser des limites adaptées pour la multiplication
2026-02-20T22:09:17.2865421Z          min_val = type_limits.get("min", 2)
2026-02-20T22:09:17.2865892Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.2866307Z -        
2026-02-20T22:09:17.2866571Z +
2026-02-20T22:09:17.2866869Z          num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2867360Z          num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.2867808Z          result = num1 * num2
2026-02-20T22:09:17.2868163Z -        
2026-02-20T22:09:17.2868423Z +
2026-02-20T22:09:17.2868832Z          # Thème Star Wars pour la multiplication
2026-02-20T22:09:17.2869516Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2870227Z -            question_template = random.choice([
2026-02-20T22:09:17.2871113Z -                f"Chaque Padawan a {num2} cristaux Kyber. S'il y a {num1} Padawans, combien de cristaux y a-t-il au total?",
2026-02-20T22:09:17.2872427Z -                f"Chaque droïde astromech a {num2} outils. Combien d'outils ont {num1} droïdes au total?",
2026-02-20T22:09:17.2873748Z -                f"Chaque module de formation a {num2} exercices. Combien d'exercices y a-t-il dans {num1} modules?"
2026-02-20T22:09:17.2874573Z -            ])
2026-02-20T22:09:17.2875145Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2875886Z +            question_template = random.choice(
2026-02-20T22:09:17.2876320Z +                [
2026-02-20T22:09:17.2877071Z +                    f"Chaque Padawan a {num2} cristaux Kyber. S'il y a {num1} Padawans, combien de cristaux y a-t-il au total?",
2026-02-20T22:09:17.2878441Z +                    f"Chaque droïde astromech a {num2} outils. Combien d'outils ont {num1} droïdes au total?",
2026-02-20T22:09:17.2879607Z +                    f"Chaque module de formation a {num2} exercices. Combien d'exercices y a-t-il dans {num1} modules?",
2026-02-20T22:09:17.2880482Z +                ]
2026-02-20T22:09:17.2880776Z +            )
2026-02-20T22:09:17.2881598Z              explanation_template = f"Pour trouver le total, tu dois multiplier le nombre de {num1} par {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2882595Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2883310Z -            question_template = random.choice([
2026-02-20T22:09:17.2884138Z -                f"Chaque escadron comprend {num2} X-wings. Combien de X-wings y a-t-il dans {num1} escadrons?",
2026-02-20T22:09:17.2885480Z -                f"Chaque Star Destroyer transporte {num2} TIE Fighters. Combien de TIE Fighters y a-t-il sur {num1} Star Destroyers?",
2026-02-20T22:09:17.2887053Z -                f"Chaque secteur contient {num2} systèmes stellaires. Combien de systèmes y a-t-il dans {num1} secteurs?"
2026-02-20T22:09:17.2887905Z -            ])
2026-02-20T22:09:17.2888710Z -            explanation_template = f"Pour calculer le total, on multiplie: {num1} × {num2} = {result}."
2026-02-20T22:09:17.2889455Z -        
2026-02-20T22:09:17.2889841Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2890384Z +            question_template = random.choice(
2026-02-20T22:09:17.2890810Z +                [
2026-02-20T22:09:17.2891500Z +                    f"Chaque escadron comprend {num2} X-wings. Combien de X-wings y a-t-il dans {num1} escadrons?",
2026-02-20T22:09:17.2892843Z +                    f"Chaque Star Destroyer transporte {num2} TIE Fighters. Combien de TIE Fighters y a-t-il sur {num1} Star Destroyers?",
2026-02-20T22:09:17.2894946Z +                    f"Chaque secteur contient {num2} systèmes stellaires. Combien de systèmes y a-t-il dans {num1} secteurs?",
2026-02-20T22:09:17.2895811Z +                ]
2026-02-20T22:09:17.2896103Z +            )
2026-02-20T22:09:17.2896581Z +            explanation_template = (
2026-02-20T22:09:17.2897330Z +                f"Pour calculer le total, on multiplie: {num1} × {num2} = {result}."
2026-02-20T22:09:17.2897941Z +            )
2026-02-20T22:09:17.2898205Z +
2026-02-20T22:09:17.2898629Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2899086Z          choices = [
2026-02-20T22:09:17.2899419Z              str(result),
2026-02-20T22:09:17.2899842Z              str(result + num1),  # Erreur: une fois de trop
2026-02-20T22:09:17.2900424Z              str(result - num2),  # Erreur: une fois de moins
2026-02-20T22:09:17.2901062Z -            str(num1 + num2)  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.2901793Z +            str(num1 + num2),  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.2902341Z          ]
2026-02-20T22:09:17.2902634Z          random.shuffle(choices)
2026-02-20T22:09:17.2903169Z -        
2026-02-20T22:09:17.2903466Z -        exercise_data.update({
2026-02-20T22:09:17.2904501Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Forces galactiques - Multiplication pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2905628Z -            "question": question_template,
2026-02-20T22:09:17.2906105Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2906562Z -            "choices": choices,
2026-02-20T22:09:17.2906957Z -            "num1": num1,
2026-02-20T22:09:17.2907324Z -            "num2": num2,
2026-02-20T22:09:17.2908173Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2909101Z -        })
2026-02-20T22:09:17.2909507Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.2910009Z +
2026-02-20T22:09:17.2910300Z +        exercise_data.update(
2026-02-20T22:09:17.2910673Z +            {
2026-02-20T22:09:17.2911686Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Forces galactiques - Multiplication pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2912849Z +                "question": question_template,
2026-02-20T22:09:17.2913592Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2914040Z +                "choices": choices,
2026-02-20T22:09:17.2914452Z +                "num1": num1,
2026-02-20T22:09:17.2914815Z +                "num2": num2,
2026-02-20T22:09:17.2915684Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2916623Z +            }
2026-02-20T22:09:17.2916909Z +        )
2026-02-20T22:09:17.2917251Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2917812Z      elif normalized_type == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.2918507Z          # Générer une division avec reste nul
2026-02-20T22:09:17.2919040Z          min_divisor = type_limits.get("min_divisor", 2)
2026-02-20T22:09:17.2919640Z          max_divisor = type_limits.get("max_divisor", 10)
2026-02-20T22:09:17.2920224Z          min_result = type_limits.get("min_result", 1)
2026-02-20T22:09:17.2920801Z          max_result = type_limits.get("max_result", 10)
2026-02-20T22:09:17.2921274Z -        
2026-02-20T22:09:17.2921535Z +
2026-02-20T22:09:17.2922277Z          # Pour assurer une division sans reste, on génère d'abord le diviseur et le quotient
2026-02-20T22:09:17.2923337Z          num2 = random.randint(min_divisor, max_divisor)  # diviseur
2026-02-20T22:09:17.2924046Z          result = random.randint(min_result, max_result)  # quotient
2026-02-20T22:09:17.2924615Z          num1 = num2 * result  # dividende
2026-02-20T22:09:17.2925024Z -        
2026-02-20T22:09:17.2925550Z +
2026-02-20T22:09:17.2925997Z          # Thème Star Wars pour la division
2026-02-20T22:09:17.2926678Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2927405Z -            question_template = random.choice([
2026-02-20T22:09:17.2928901Z -                f"Tu as {num1} cristaux Kyber à distribuer équitablement entre {num2} Padawans. Combien de cristaux chaque Padawan recevra-t-il?",
2026-02-20T22:09:17.2930578Z -                f"Il y a {num1} droïdes à répartir dans {num2} hangars. Combien de droïdes y aura-t-il dans chaque hangar?",
2026-02-20T22:09:17.2931854Z -                f"Tu dois parcourir {num1} parsecs en {num2} jours. Combien de parsecs dois-tu parcourir chaque jour?"
2026-02-20T22:09:17.2932704Z -            ])
2026-02-20T22:09:17.2933461Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2934193Z +            question_template = random.choice(
2026-02-20T22:09:17.2934647Z +                [
2026-02-20T22:09:17.2935801Z +                    f"Tu as {num1} cristaux Kyber à distribuer équitablement entre {num2} Padawans. Combien de cristaux chaque Padawan recevra-t-il?",
2026-02-20T22:09:17.2937432Z +                    f"Il y a {num1} droïdes à répartir dans {num2} hangars. Combien de droïdes y aura-t-il dans chaque hangar?",
2026-02-20T22:09:17.2938684Z +                    f"Tu dois parcourir {num1} parsecs en {num2} jours. Combien de parsecs dois-tu parcourir chaque jour?",
2026-02-20T22:09:17.2939530Z +                ]
2026-02-20T22:09:17.2939830Z +            )
2026-02-20T22:09:17.2940767Z              explanation_template = f"Pour trouver la réponse, tu dois diviser {num1} par {num2}, ce qui donne {result}."
2026-02-20T22:09:17.2941709Z -        else: # Default for other difficulty levels
2026-02-20T22:09:17.2942263Z -            question_template = random.choice([
2026-02-20T22:09:17.2943724Z -                f"L'Alliance a {num1} soldats à répartir équitablement dans {num2} bases. Combien de soldats seront affectés à chaque base?",
2026-02-20T22:09:17.2945638Z -                f"L'Empire a fabriqué {num1} blasters qui doivent être distribués à {num2} escouades. Combien de blasters chaque escouade recevra-t-elle?",
2026-02-20T22:09:17.2947647Z -                f"Un convoi de {num1} containers doit être réparti sur {num2} vaisseaux de transport. Combien de containers chaque vaisseau transportera-t-il?"
2026-02-20T22:09:17.2948742Z -            ])
2026-02-20T22:09:17.2949583Z -            explanation_template = f"Pour calculer le résultat, on divise: {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.2950358Z -        
2026-02-20T22:09:17.2950720Z +        else:  # Default for other difficulty levels
2026-02-20T22:09:17.2951265Z +            question_template = random.choice(
2026-02-20T22:09:17.2951711Z +                [
2026-02-20T22:09:17.2952829Z +                    f"L'Alliance a {num1} soldats à répartir équitablement dans {num2} bases. Combien de soldats seront affectés à chaque base?",
2026-02-20T22:09:17.2954860Z +                    f"L'Empire a fabriqué {num1} blasters qui doivent être distribués à {num2} escouades. Combien de blasters chaque escouade recevra-t-elle?",
2026-02-20T22:09:17.2956903Z +                    f"Un convoi de {num1} containers doit être réparti sur {num2} vaisseaux de transport. Combien de containers chaque vaisseau transportera-t-il?",
2026-02-20T22:09:17.2958024Z +                ]
2026-02-20T22:09:17.2958337Z +            )
2026-02-20T22:09:17.2958670Z +            explanation_template = (
2026-02-20T22:09:17.2959463Z +                f"Pour calculer le résultat, on divise: {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.2960103Z +            )
2026-02-20T22:09:17.2960389Z +
2026-02-20T22:09:17.2960850Z          # Générer des choix proches mais différents
2026-02-20T22:09:17.2961351Z          choices = [
2026-02-20T22:09:17.2961679Z              str(result),
2026-02-20T22:09:17.2962133Z              str(result + random.randint(1, min(5, result))),
2026-02-20T22:09:17.2963342Z              str(result - random.randint(1, min(3, result - 1) if result > 1 else 1)),
2026-02-20T22:09:17.2964417Z -            str(num1 // (num2 + random.randint(1, 3)))  # Diviseur légèrement différent
2026-02-20T22:09:17.2965725Z +            str(num1 // (num2 + random.randint(1, 3))),  # Diviseur légèrement différent
2026-02-20T22:09:17.2966430Z          ]
2026-02-20T22:09:17.2966747Z          random.shuffle(choices)
2026-02-20T22:09:17.2967140Z -        
2026-02-20T22:09:17.2967464Z -        exercise_data.update({
2026-02-20T22:09:17.2968787Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Stratégie galactique - Division pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.2969950Z -            "question": question_template,
2026-02-20T22:09:17.2970428Z -            "correct_answer": str(result),
2026-02-20T22:09:17.2970880Z -            "choices": choices,
2026-02-20T22:09:17.2971265Z -            "num1": num1,
2026-02-20T22:09:17.2971654Z -            "num2": num2,
2026-02-20T22:09:17.2972530Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.2973625Z -        })
2026-02-20T22:09:17.2973878Z +
2026-02-20T22:09:17.2974141Z +        exercise_data.update(
2026-02-20T22:09:17.2974491Z +            {
2026-02-20T22:09:17.2975704Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Stratégie galactique - Division pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.2976828Z +                "question": question_template,
2026-02-20T22:09:17.2977329Z +                "correct_answer": str(result),
2026-02-20T22:09:17.2977791Z +                "choices": choices,
2026-02-20T22:09:17.2978210Z +                "num1": num1,
2026-02-20T22:09:17.2978582Z +                "num2": num2,
2026-02-20T22:09:17.2979466Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.2980476Z +            }
2026-02-20T22:09:17.2980772Z +        )
2026-02-20T22:09:17.2981106Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.2981682Z      elif normalized_type == ExerciseTypes.FRACTIONS:
2026-02-20T22:09:17.2982569Z          # Génération IA d'un exercice sur les fractions avec thème Star Wars
2026-02-20T22:09:17.2983422Z          from fractions import Fraction
2026-02-20T22:09:17.2983836Z  
2026-02-20T22:09:17.2984253Z          # Paramètres selon la difficulté
2026-02-20T22:09:17.2984945Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.2985856Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.2986720Z              denom1, denom2 = random.choice([2, 3, 4]), random.choice([2, 3, 4])
2026-02-20T22:09:17.2987530Z -            num1, num2 = random.randint(1, denom1-1), random.randint(1, denom2-1)
2026-02-20T22:09:17.2988382Z +            num1, num2 = random.randint(1, denom1 - 1), random.randint(1, denom2 - 1)
2026-02-20T22:09:17.2989055Z              operation = "+"
2026-02-20T22:09:17.2989694Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.2990657Z -            denom1, denom2 = random.choice([2, 3, 4, 5, 6]), random.choice([2, 3, 4, 5, 6])
2026-02-20T22:09:17.2991519Z -            num1, num2 = random.randint(1, denom1-1), random.randint(1, denom2-1)
2026-02-20T22:09:17.2992407Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.2993471Z +            denom1, denom2 = random.choice([2, 3, 4, 5, 6]), random.choice(
2026-02-20T22:09:17.2994057Z +                [2, 3, 4, 5, 6]
2026-02-20T22:09:17.2994426Z +            )
2026-02-20T22:09:17.2994929Z +            num1, num2 = random.randint(1, denom1 - 1), random.randint(1, denom2 - 1)
2026-02-20T22:09:17.2995622Z              operation = random.choice(["+", "-"])
2026-02-20T22:09:17.2996617Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.2997626Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.2998706Z              denom1, denom2 = random.randint(2, 8), random.randint(2, 8)
2026-02-20T22:09:17.2999478Z              num1, num2 = random.randint(1, denom1), random.randint(1, denom2)
2026-02-20T22:09:17.3000311Z              operation = random.choice(["+", "-", "×"])
2026-02-20T22:09:17.3000864Z          else:  # MAITRE
2026-02-20T22:09:17.3001378Z              denom1, denom2 = random.randint(2, 12), random.randint(2, 12)
2026-02-20T22:09:17.3002142Z -            num1, num2 = random.randint(1, denom1*2), random.randint(1, denom2*2)
2026-02-20T22:09:17.3003164Z +            num1, num2 = random.randint(1, denom1 * 2), random.randint(1, denom2 * 2)
2026-02-20T22:09:17.3004048Z              operation = random.choice(["+", "-", "×", "÷"])
2026-02-20T22:09:17.3004542Z -        
2026-02-20T22:09:17.3004822Z +
2026-02-20T22:09:17.3005195Z          # Calcul du résultat
2026-02-20T22:09:17.3005736Z          frac1, frac2 = Fraction(num1, denom1), Fraction(num2, denom2)
2026-02-20T22:09:17.3006321Z          if operation == "+":
2026-02-20T22:09:17.3006744Z              result = frac1 + frac2
2026-02-20T22:09:17.3007178Z              op_word = "additionner"
2026-02-20T22:09:17.3007598Z          elif operation == "-":
2026-02-20T22:09:17.3008318Z -            if frac1 < frac2: frac1, frac2 = frac2, frac1  # Éviter les négatifs
2026-02-20T22:09:17.3008926Z +            if frac1 < frac2:
2026-02-20T22:09:17.3009517Z +                frac1, frac2 = frac2, frac1  # Éviter les négatifs
2026-02-20T22:09:17.3010047Z              result = frac1 - frac2
2026-02-20T22:09:17.3010474Z              op_word = "soustraire"
2026-02-20T22:09:17.3010958Z          elif operation == "×":
2026-02-20T22:09:17.3011356Z              result = frac1 * frac2
2026-02-20T22:09:17.3011763Z              op_word = "multiplier"
2026-02-20T22:09:17.3012194Z          else:  # "÷"
2026-02-20T22:09:17.3012524Z -            if num2 == 0: num2 = 1
2026-02-20T22:09:17.3012911Z +            if num2 == 0:
2026-02-20T22:09:17.3013465Z +                num2 = 1
2026-02-20T22:09:17.3013839Z              result = frac1 / frac2
2026-02-20T22:09:17.3014257Z              op_word = "diviser"
2026-02-20T22:09:17.3014624Z -        
2026-02-20T22:09:17.3014899Z +
2026-02-20T22:09:17.3015266Z          # Format du résultat
2026-02-20T22:09:17.3015668Z          if result.denominator == 1:
2026-02-20T22:09:17.3016163Z              formatted_result = str(result.numerator)
2026-02-20T22:09:17.3016628Z          else:
2026-02-20T22:09:17.3017101Z              formatted_result = f"{result.numerator}/{result.denominator}"
2026-02-20T22:09:17.3017680Z -        
2026-02-20T22:09:17.3017948Z +
2026-02-20T22:09:17.3018355Z          # Questions Star Wars selon la difficulté
2026-02-20T22:09:17.3019082Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3019807Z -            question_template = random.choice([
2026-02-20T22:09:17.3021043Z -                f"Luke mange {num1}/{denom1} de sa ration et Leia mange {num2}/{denom2} de la sienne. Quelle fraction ont-ils mangée ensemble?",
2026-02-20T22:09:17.3022675Z -                f"R2-D2 a réparé {num1}/{denom1} des systèmes et C-3PO {num2}/{denom2}. Quelle fraction totale ont-ils réparée?",
2026-02-20T22:09:17.3024659Z -                f"Dans le Faucon Millenium, {num1}/{denom1} des moteurs fonctionnent et {num2}/{denom2} des boucliers. Quelle fraction totale est opérationnelle?"
2026-02-20T22:09:17.3025779Z -            ])
2026-02-20T22:09:17.3026349Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3027096Z +            question_template = random.choice(
2026-02-20T22:09:17.3027557Z +                [
2026-02-20T22:09:17.3028644Z +                    f"Luke mange {num1}/{denom1} de sa ration et Leia mange {num2}/{denom2} de la sienne. Quelle fraction ont-ils mangée ensemble?",
2026-02-20T22:09:17.3030535Z +                    f"R2-D2 a réparé {num1}/{denom1} des systèmes et C-3PO {num2}/{denom2}. Quelle fraction totale ont-ils réparée?",
2026-02-20T22:09:17.3032533Z +                    f"Dans le Faucon Millenium, {num1}/{denom1} des moteurs fonctionnent et {num2}/{denom2} des boucliers. Quelle fraction totale est opérationnelle?",
2026-02-20T22:09:17.3033865Z +                ]
2026-02-20T22:09:17.3034172Z +            )
2026-02-20T22:09:17.3034455Z          else:
2026-02-20T22:09:17.3034806Z -            question_template = random.choice([
2026-02-20T22:09:17.3036109Z -                f"L'Étoile de la Mort a détruit {num1}/{denom1} de la flotte rebelle, puis {num2}/{denom2} de plus. Quelle fraction totale a été détruite?",
2026-02-20T22:09:17.3037876Z -                f"Yoda maîtrise {num1}/{denom1} de la Force et enseigne {num2}/{denom2} de ses connaissances. Quelle fraction a-t-il transmise?",
2026-02-20T22:09:17.3039649Z -                f"L'Empire contrôle {num1}/{denom1} de la galaxie et conquiert {num2}/{denom2} de plus. Quelle fraction contrôle-t-il maintenant?"
2026-02-20T22:09:17.3040648Z -            ])
2026-02-20T22:09:17.3040961Z -        
2026-02-20T22:09:17.3041310Z +            question_template = random.choice(
2026-02-20T22:09:17.3041782Z +                [
2026-02-20T22:09:17.3042942Z +                    f"L'Étoile de la Mort a détruit {num1}/{denom1} de la flotte rebelle, puis {num2}/{denom2} de plus. Quelle fraction totale a été détruite?",
2026-02-20T22:09:17.3044951Z +                    f"Yoda maîtrise {num1}/{denom1} de la Force et enseigne {num2}/{denom2} de ses connaissances. Quelle fraction a-t-il transmise?",
2026-02-20T22:09:17.3046741Z +                    f"L'Empire contrôle {num1}/{denom1} de la galaxie et conquiert {num2}/{denom2} de plus. Quelle fraction contrôle-t-il maintenant?",
2026-02-20T22:09:17.3047645Z +                ]
2026-02-20T22:09:17.3047954Z +            )
2026-02-20T22:09:17.3048223Z +
2026-02-20T22:09:17.3048520Z          # Choix avec erreurs typiques
2026-02-20T22:09:17.3049182Z          incorrect1 = f"{num1+num2}/{denom1+denom2}"  # Erreur: additionner num et denom
2026-02-20T22:09:17.3050178Z          incorrect2 = f"{num1}/{denom2}"  # Confusion des dénominateurs
2026-02-20T22:09:17.3050834Z          incorrect3 = f"{num2}/{denom1}"  # Inversion
2026-02-20T22:09:17.3051290Z -        
2026-02-20T22:09:17.3051571Z +
2026-02-20T22:09:17.3052018Z          choices = [formatted_result, incorrect1, incorrect2, incorrect3]
2026-02-20T22:09:17.3052664Z          random.shuffle(choices)
2026-02-20T22:09:17.3053247Z -        
2026-02-20T22:09:17.3053565Z -        exercise_data.update({
2026-02-20T22:09:17.3054506Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Fractions Jedi - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3056517Z -            "question": f"Problème galactique: {question_template.replace(f'{num1}/{denom1} {operation} {num2}/{denom2}', f'{num1}/{denom1} {operation} {num2}/{denom2}')}",
2026-02-20T22:09:17.3057773Z -            "correct_answer": formatted_result,
2026-02-20T22:09:17.3058252Z -            "choices": choices,
2026-02-20T22:09:17.3059883Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour {op_word} les fractions {num1}/{denom1} et {num2}/{denom2}, le résultat est {formatted_result}. {explanation_suffix}"
2026-02-20T22:09:17.3061217Z -        })
2026-02-20T22:09:17.3061509Z +
2026-02-20T22:09:17.3061802Z +        exercise_data.update(
2026-02-20T22:09:17.3062190Z +            {
2026-02-20T22:09:17.3063246Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Fractions Jedi - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3065242Z +                "question": f"Problème galactique: {question_template.replace(f'{num1}/{denom1} {operation} {num2}/{denom2}', f'{num1}/{denom1} {operation} {num2}/{denom2}')}",
2026-02-20T22:09:17.3066748Z +                "correct_answer": formatted_result,
2026-02-20T22:09:17.3067184Z +                "choices": choices,
2026-02-20T22:09:17.3068785Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour {op_word} les fractions {num1}/{denom1} et {num2}/{denom2}, le résultat est {formatted_result}. {explanation_suffix}",
2026-02-20T22:09:17.3069960Z +            }
2026-02-20T22:09:17.3070206Z +        )
2026-02-20T22:09:17.3070517Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3071045Z      elif normalized_type == ExerciseTypes.GEOMETRIE:
2026-02-20T22:09:17.3071782Z          # Génération IA d'un exercice de géométrie avec thème Star Wars
2026-02-20T22:09:17.3072330Z          import math
2026-02-20T22:09:17.3072627Z  
2026-02-20T22:09:17.3073236Z          # Formes et propriétés selon la difficulté
2026-02-20T22:09:17.3073887Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3074635Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3075355Z              shape = random.choice(["carré", "rectangle"])
2026-02-20T22:09:17.3075995Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3076756Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3077721Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3078727Z              shape = random.choice(["carré", "rectangle", "triangle"])
2026-02-20T22:09:17.3079503Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3080372Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3081365Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3082416Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3083541Z              property = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3084075Z          else:  # MAITRE
2026-02-20T22:09:17.3084766Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3085702Z              property = random.choice(["périmètre", "aire", "volume"])
2026-02-20T22:09:17.3086286Z -        
2026-02-20T22:09:17.3086568Z +
2026-02-20T22:09:17.3087007Z          # Génération des valeurs et calculs
2026-02-20T22:09:17.3087531Z          if shape == "carré":
2026-02-20T22:09:17.3088140Z              side = random.randint(type_limits.get("min", 3), type_limits.get("max", 15))
2026-02-20T22:09:17.3088901Z              if property == "périmètre":
2026-02-20T22:09:17.3089306Z                  result = 4 * side
2026-02-20T22:09:17.3089764Z                  formula = f"4 × {side}"
2026-02-20T22:09:17.3090143Z              else:  # aire
2026-02-20T22:09:17.3090529Z                  result = side * side
2026-02-20T22:09:17.3091012Z                  formula = f"{side}²"
2026-02-20T22:09:17.3091385Z -            
2026-02-20T22:09:17.3091726Z -            question_template = random.choice([
2026-02-20T22:09:17.3092681Z -                f"L'Étoile de la Mort a une section carrée de côté {side} km. Quel est son {property}?",
2026-02-20T22:09:17.3094083Z -                f"La base rebelle a un hangar carré de {side} m de côté. Calcule son {property}.",
2026-02-20T22:09:17.3095231Z -                f"Le Temple Jedi a une salle carrée de {side} m de côté. Quel est son {property}?"
2026-02-20T22:09:17.3095943Z -            ])
2026-02-20T22:09:17.3096227Z -            
2026-02-20T22:09:17.3096510Z +
2026-02-20T22:09:17.3096814Z +            question_template = random.choice(
2026-02-20T22:09:17.3097260Z +                [
2026-02-20T22:09:17.3098050Z +                    f"L'Étoile de la Mort a une section carrée de côté {side} km. Quel est son {property}?",
2026-02-20T22:09:17.3099515Z +                    f"La base rebelle a un hangar carré de {side} m de côté. Calcule son {property}.",
2026-02-20T22:09:17.3100667Z +                    f"Le Temple Jedi a une salle carrée de {side} m de côté. Quel est son {property}?",
2026-02-20T22:09:17.3101367Z +                ]
2026-02-20T22:09:17.3101875Z +            )
2026-02-20T22:09:17.3102165Z +
2026-02-20T22:09:17.3102452Z          elif shape == "rectangle":
2026-02-20T22:09:17.3103325Z -            length = random.randint(type_limits.get("min", 4), type_limits.get("max", 20))
2026-02-20T22:09:17.3104176Z -            width = random.randint(type_limits.get("min", 3), length-1)
2026-02-20T22:09:17.3104778Z +            length = random.randint(
2026-02-20T22:09:17.3105292Z +                type_limits.get("min", 4), type_limits.get("max", 20)
2026-02-20T22:09:17.3105814Z +            )
2026-02-20T22:09:17.3106251Z +            width = random.randint(type_limits.get("min", 3), length - 1)
2026-02-20T22:09:17.3106968Z              if property == "périmètre":
2026-02-20T22:09:17.3107445Z                  result = 2 * (length + width)
2026-02-20T22:09:17.3108028Z                  formula = f"2 × ({length} + {width})"
2026-02-20T22:09:17.3108491Z              else:  # aire
2026-02-20T22:09:17.3108857Z                  result = length * width
2026-02-20T22:09:17.3109408Z                  formula = f"{length} × {width}"
2026-02-20T22:09:17.3109833Z -            
2026-02-20T22:09:17.3110172Z -            question_template = random.choice([
2026-02-20T22:09:17.3111196Z -                f"Le Faucon Millenium a une soute rectangulaire de {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3112326Z -                f"Un Star Destroyer a un hangar de {length} km sur {width} km. Calcule son {property}.",
2026-02-20T22:09:17.3113665Z -                f"La cantina de Mos Eisley mesure {length}m × {width}m. Quel est son {property}?"
2026-02-20T22:09:17.3114380Z -            ])
2026-02-20T22:09:17.3114690Z -            
2026-02-20T22:09:17.3114994Z +
2026-02-20T22:09:17.3115316Z +            question_template = random.choice(
2026-02-20T22:09:17.3115752Z +                [
2026-02-20T22:09:17.3116675Z +                    f"Le Faucon Millenium a une soute rectangulaire de {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3117854Z +                    f"Un Star Destroyer a un hangar de {length} km sur {width} km. Calcule son {property}.",
2026-02-20T22:09:17.3119063Z +                    f"La cantina de Mos Eisley mesure {length}m × {width}m. Quel est son {property}?",
2026-02-20T22:09:17.3119783Z +                ]
2026-02-20T22:09:17.3120079Z +            )
2026-02-20T22:09:17.3120369Z +
2026-02-20T22:09:17.3120649Z          elif shape == "triangle":
2026-02-20T22:09:17.3121308Z              base = random.randint(type_limits.get("min", 4), type_limits.get("max", 15))
2026-02-20T22:09:17.3122239Z -            height = random.randint(type_limits.get("min", 3), type_limits.get("max", 12))
2026-02-20T22:09:17.3123162Z +            height = random.randint(
2026-02-20T22:09:17.3123741Z +                type_limits.get("min", 3), type_limits.get("max", 12)
2026-02-20T22:09:17.3124273Z +            )
2026-02-20T22:09:17.3124587Z              if property == "aire":
2026-02-20T22:09:17.3125004Z                  result = (base * height) / 2
2026-02-20T22:09:17.3125618Z                  formula = f"({base} × {height}) ÷ 2"
2026-02-20T22:09:17.3126201Z              else:  # périmètre approximatif
2026-02-20T22:09:17.3126796Z -                hypotenuse = round(math.sqrt(base*base + height*height), 1)
2026-02-20T22:09:17.3127544Z +                hypotenuse = round(math.sqrt(base * base + height * height), 1)
2026-02-20T22:09:17.3128186Z                  result = base + height + hypotenuse
2026-02-20T22:09:17.3128716Z                  formula = f"{base} + {height} + {hypotenuse}"
2026-02-20T22:09:17.3129179Z -            
2026-02-20T22:09:17.3129518Z -            question_template = random.choice([
2026-02-20T22:09:17.3130363Z -                f"Un X-wing a des ailes triangulaires de base {base}m et hauteur {height}m. Quelle est leur {property}?",
2026-02-20T22:09:17.3131889Z -                f"Le sabre laser de Yoda forme un triangle de base {base} cm et hauteur {height} cm. Calcule son {property}.",
2026-02-20T22:09:17.3134009Z -                f"Une voile solaire triangulaire mesure {base}km × {height}km. Quel est son {property}?"
2026-02-20T22:09:17.3134750Z -            ])
2026-02-20T22:09:17.3135034Z -            
2026-02-20T22:09:17.3135296Z +
2026-02-20T22:09:17.3135571Z +            question_template = random.choice(
2026-02-20T22:09:17.3135963Z +                [
2026-02-20T22:09:17.3136673Z +                    f"Un X-wing a des ailes triangulaires de base {base}m et hauteur {height}m. Quelle est leur {property}?",
2026-02-20T22:09:17.3137940Z +                    f"Le sabre laser de Yoda forme un triangle de base {base} cm et hauteur {height} cm. Calcule son {property}.",
2026-02-20T22:09:17.3139346Z +                    f"Une voile solaire triangulaire mesure {base}km × {height}km. Quel est son {property}?",
2026-02-20T22:09:17.3140141Z +                ]
2026-02-20T22:09:17.3140425Z +            )
2026-02-20T22:09:17.3140700Z +
2026-02-20T22:09:17.3140960Z          else:  # cercle
2026-02-20T22:09:17.3141583Z -            radius = random.randint(type_limits.get("min", 2), type_limits.get("max", 10))
2026-02-20T22:09:17.3142305Z +            radius = random.randint(
2026-02-20T22:09:17.3164670Z +                type_limits.get("min", 2), type_limits.get("max", 10)
2026-02-20T22:09:17.3165232Z +            )
2026-02-20T22:09:17.3165719Z              if property == "périmètre":
2026-02-20T22:09:17.3166224Z                  result = round(2 * math.pi * radius, 2)
2026-02-20T22:09:17.3166838Z                  formula = f"2 × π × {radius}"
2026-02-20T22:09:17.3167278Z              else:  # aire
2026-02-20T22:09:17.3167726Z                  result = round(math.pi * radius * radius, 2)
2026-02-20T22:09:17.3168338Z                  formula = f"π × {radius}²"
2026-02-20T22:09:17.3168765Z -            
2026-02-20T22:09:17.3169117Z -            question_template = random.choice([
2026-02-20T22:09:17.3169960Z -                f"L'Étoile de la Mort a un rayon de {radius} km. Quel est son {property}?",
2026-02-20T22:09:17.3171095Z -                f"La planète Tatooine a un rayon de {radius} milliers de km. Calcule son {property}.",
2026-02-20T22:09:17.3172308Z -                f"Un bouclier déflecteur circulaire a un rayon de {radius}m. Quel est son {property}?"
2026-02-20T22:09:17.3173226Z -            ])
2026-02-20T22:09:17.3173512Z -        
2026-02-20T22:09:17.3173774Z +
2026-02-20T22:09:17.3174087Z +            question_template = random.choice(
2026-02-20T22:09:17.3174525Z +                [
2026-02-20T22:09:17.3175224Z +                    f"L'Étoile de la Mort a un rayon de {radius} km. Quel est son {property}?",
2026-02-20T22:09:17.3176333Z +                    f"La planète Tatooine a un rayon de {radius} milliers de km. Calcule son {property}.",
2026-02-20T22:09:17.3177582Z +                    f"Un bouclier déflecteur circulaire a un rayon de {radius}m. Quel est son {property}?",
2026-02-20T22:09:17.3178317Z +                ]
2026-02-20T22:09:17.3178610Z +            )
2026-02-20T22:09:17.3178884Z +
2026-02-20T22:09:17.3179186Z          # Choix avec erreurs typiques
2026-02-20T22:09:17.3179611Z          choices = [
2026-02-20T22:09:17.3179997Z              str(result),
2026-02-20T22:09:17.3180468Z              str(round(result * 0.5, 2)),  # Moitié
2026-02-20T22:09:17.3180956Z -            str(round(result * 2, 2)),    # Double
2026-02-20T22:09:17.3181466Z -            str(round(result * 1.5, 2))   # 1.5 fois
2026-02-20T22:09:17.3181948Z +            str(round(result * 2, 2)),  # Double
2026-02-20T22:09:17.3182395Z +            str(round(result * 1.5, 2)),  # 1.5 fois
2026-02-20T22:09:17.3182806Z          ]
2026-02-20T22:09:17.3183264Z          random.shuffle(choices)
2026-02-20T22:09:17.3183635Z -        
2026-02-20T22:09:17.3183928Z -        exercise_data.update({
2026-02-20T22:09:17.3185397Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Géométrie Galactique - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3186439Z -            "question": question_template,
2026-02-20T22:09:17.3187103Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3187557Z -            "choices": choices,
2026-02-20T22:09:17.3188720Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour calculer le {property} d'un {shape}, on utilise: {formula} = {result}. {explanation_suffix}"
2026-02-20T22:09:17.3189909Z -        })
2026-02-20T22:09:17.3190172Z +
2026-02-20T22:09:17.3190458Z +        exercise_data.update(
2026-02-20T22:09:17.3190819Z +            {
2026-02-20T22:09:17.3191926Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Géométrie Galactique - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3193153Z +                "question": question_template,
2026-02-20T22:09:17.3193652Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3194096Z +                "choices": choices,
2026-02-20T22:09:17.3195255Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour calculer le {property} d'un {shape}, on utilise: {formula} = {result}. {explanation_suffix}",
2026-02-20T22:09:17.3195363Z +            }
2026-02-20T22:09:17.3195477Z +        )
2026-02-20T22:09:17.3195641Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3195833Z      elif normalized_type == ExerciseTypes.DIVERS:
2026-02-20T22:09:17.3196197Z          # Génération IA d'exercices divers avec thème Star Wars
2026-02-20T22:09:17.3196309Z -        
2026-02-20T22:09:17.3196415Z +
2026-02-20T22:09:17.3196708Z          # Types de problèmes selon la difficulté
2026-02-20T22:09:17.3197073Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3197431Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3197707Z              problem_type = random.choice(["age", "monnaie", "temps"])
2026-02-20T22:09:17.3198091Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3198500Z -            problem_type = random.choice(["age", "monnaie", "vitesse", "pourcentage_simple"])
2026-02-20T22:09:17.3198883Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3199261Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3199414Z +            problem_type = random.choice(
2026-02-20T22:09:17.3199633Z +                ["age", "monnaie", "vitesse", "pourcentage_simple"]
2026-02-20T22:09:17.3199755Z +            )
2026-02-20T22:09:17.3200146Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3200634Z              problem_type = random.choice(["vitesse", "pourcentage", "probabilité"])
2026-02-20T22:09:17.3200780Z          else:  # MAITRE
2026-02-20T22:09:17.3201279Z              problem_type = random.choice(["probabilité", "séquence", "logique_avancée"])
2026-02-20T22:09:17.3201392Z -        
2026-02-20T22:09:17.3201499Z +
2026-02-20T22:09:17.3201743Z          # Génération selon le type
2026-02-20T22:09:17.3201882Z          if problem_type == "age":
2026-02-20T22:09:17.3202285Z -            age_actuel = random.randint(type_limits.get("min", 8), type_limits.get("max", 25))
2026-02-20T22:09:17.3202446Z +            age_actuel = random.randint(
2026-02-20T22:09:17.3202688Z +                type_limits.get("min", 8), type_limits.get("max", 25)
2026-02-20T22:09:17.3202796Z +            )
2026-02-20T22:09:17.3203238Z              années = random.randint(1, 10)
2026-02-20T22:09:17.3203461Z              result = age_actuel + années
2026-02-20T22:09:17.3203564Z -            
2026-02-20T22:09:17.3203736Z -            question_template = random.choice([
2026-02-20T22:09:17.3204468Z -                f"Luke a {age_actuel} ans. Dans {années} ans, quel âge aura-t-il?",
2026-02-20T22:09:17.3204999Z -                f"Leia a {age_actuel} ans aujourd'hui. Quel âge aura-t-elle dans {années} ans?",
2026-02-20T22:09:17.3205686Z -                f"Anakin a {age_actuel} ans. Dans combien d'années aura-t-il {result} ans?"
2026-02-20T22:09:17.3205819Z -            ])
2026-02-20T22:09:17.3206447Z -            explanation_template = f"Pour trouver l'âge futur: {age_actuel} + {années} = {result} ans."
2026-02-20T22:09:17.3206558Z -            
2026-02-20T22:09:17.3206671Z +
2026-02-20T22:09:17.3206837Z +            question_template = random.choice(
2026-02-20T22:09:17.3206945Z +                [
2026-02-20T22:09:17.3207380Z +                    f"Luke a {age_actuel} ans. Dans {années} ans, quel âge aura-t-il?",
2026-02-20T22:09:17.3207899Z +                    f"Leia a {age_actuel} ans aujourd'hui. Quel âge aura-t-elle dans {années} ans?",
2026-02-20T22:09:17.3208429Z +                    f"Anakin a {age_actuel} ans. Dans combien d'années aura-t-il {result} ans?",
2026-02-20T22:09:17.3208544Z +                ]
2026-02-20T22:09:17.3208663Z +            )
2026-02-20T22:09:17.3208813Z +            explanation_template = (
2026-02-20T22:09:17.3209265Z +                f"Pour trouver l'âge futur: {age_actuel} + {années} = {result} ans."
2026-02-20T22:09:17.3209384Z +            )
2026-02-20T22:09:17.3209490Z +
2026-02-20T22:09:17.3209645Z          elif problem_type == "monnaie":
2026-02-20T22:09:17.3210007Z              prix = random.randint(type_limits.get("min", 5), type_limits.get("max", 50))
2026-02-20T22:09:17.3210331Z              payé = random.randint(prix + 1, prix + 20)
2026-02-20T22:09:17.3210559Z              result = payé - prix
2026-02-20T22:09:17.3210667Z -            
2026-02-20T22:09:17.3210848Z -            question_template = random.choice([
2026-02-20T22:09:17.3211474Z -                f"Tu achètes un sabre laser à {prix} crédits. Tu paies {payé} crédits. Combien de monnaie?",
2026-02-20T22:09:17.3212040Z -                f"Un droïde coûte {prix} crédits. Tu donnes {payé} crédits. Quelle est la monnaie?",
2026-02-20T22:09:17.3212669Z -                f"Des rations coûtent {prix} crédits. Tu paies avec {payé} crédits. Combien récupères-tu?"
2026-02-20T22:09:17.3212804Z -            ])
2026-02-20T22:09:17.3213642Z -            explanation_template = f"Monnaie = montant payé - prix: {payé} - {prix} = {result} crédits."
2026-02-20T22:09:17.3213759Z -            
2026-02-20T22:09:17.3213876Z +
2026-02-20T22:09:17.3214048Z +            question_template = random.choice(
2026-02-20T22:09:17.3214155Z +                [
2026-02-20T22:09:17.3214797Z +                    f"Tu achètes un sabre laser à {prix} crédits. Tu paies {payé} crédits. Combien de monnaie?",
2026-02-20T22:09:17.3215341Z +                    f"Un droïde coûte {prix} crédits. Tu donnes {payé} crédits. Quelle est la monnaie?",
2026-02-20T22:09:17.3215963Z +                    f"Des rations coûtent {prix} crédits. Tu paies avec {payé} crédits. Combien récupères-tu?",
2026-02-20T22:09:17.3216114Z +                ]
2026-02-20T22:09:17.3216218Z +            )
2026-02-20T22:09:17.3216368Z +            explanation_template = (
2026-02-20T22:09:17.3216855Z +                f"Monnaie = montant payé - prix: {payé} - {prix} = {result} crédits."
2026-02-20T22:09:17.3216975Z +            )
2026-02-20T22:09:17.3217080Z +
2026-02-20T22:09:17.3217231Z          elif problem_type == "vitesse":
2026-02-20T22:09:17.3217643Z -            distance = random.randint(type_limits.get("min", 10), type_limits.get("max", 100))
2026-02-20T22:09:17.3217790Z +            distance = random.randint(
2026-02-20T22:09:17.3218034Z +                type_limits.get("min", 10), type_limits.get("max", 100)
2026-02-20T22:09:17.3218151Z +            )
2026-02-20T22:09:17.3218308Z              temps = random.randint(2, 10)
2026-02-20T22:09:17.3218455Z              result = distance // temps
2026-02-20T22:09:17.3218561Z -            
2026-02-20T22:09:17.3218961Z -            question_template = random.choice([
2026-02-20T22:09:17.3219451Z -                f"Le Faucon Millenium parcourt {distance} parsecs en {temps} heures. Quelle est sa vitesse?",
2026-02-20T22:09:17.3220031Z -                f"Un X-wing vole {distance} km en {temps} minutes. Quelle est sa vitesse par minute?",
2026-02-20T22:09:17.3220696Z -                f"Un Star Destroyer voyage {distance} années-lumière en {temps} jours. Vitesse par jour?"
2026-02-20T22:09:17.3220811Z -            ])
2026-02-20T22:09:17.3221397Z -            explanation_template = f"Vitesse = distance ÷ temps: {distance} ÷ {temps} = {result}."
2026-02-20T22:09:17.3221506Z -            
2026-02-20T22:09:17.3221610Z +
2026-02-20T22:09:17.3221780Z +            question_template = random.choice(
2026-02-20T22:09:17.3221899Z +                [
2026-02-20T22:09:17.3222396Z +                    f"Le Faucon Millenium parcourt {distance} parsecs en {temps} heures. Quelle est sa vitesse?",
2026-02-20T22:09:17.3222827Z +                    f"Un X-wing vole {distance} km en {temps} minutes. Quelle est sa vitesse par minute?",
2026-02-20T22:09:17.3223662Z +                    f"Un Star Destroyer voyage {distance} années-lumière en {temps} jours. Vitesse par jour?",
2026-02-20T22:09:17.3223777Z +                ]
2026-02-20T22:09:17.3223900Z +            )
2026-02-20T22:09:17.3224059Z +            explanation_template = (
2026-02-20T22:09:17.3224478Z +                f"Vitesse = distance ÷ temps: {distance} ÷ {temps} = {result}."
2026-02-20T22:09:17.3224587Z +            )
2026-02-20T22:09:17.3224689Z +
2026-02-20T22:09:17.3225051Z          elif problem_type == "pourcentage" or problem_type == "pourcentage_simple":
2026-02-20T22:09:17.3225437Z -            initial = random.randint(type_limits.get("min", 20), type_limits.get("max", 100))
2026-02-20T22:09:17.3225589Z +            initial = random.randint(
2026-02-20T22:09:17.3225845Z +                type_limits.get("min", 20), type_limits.get("max", 100)
2026-02-20T22:09:17.3225971Z +            )
2026-02-20T22:09:17.3226174Z              pourcentage = random.choice([10, 20, 25, 50])
2026-02-20T22:09:17.3226405Z              result = initial + (initial * pourcentage // 100)
2026-02-20T22:09:17.3226513Z -            
2026-02-20T22:09:17.3226697Z -            question_template = random.choice([
2026-02-20T22:09:17.3227167Z -                f"L'Empire a {initial} vaisseaux. Leur nombre augmente de {pourcentage}%. Nouveau total?",
2026-02-20T22:09:17.3227823Z -                f"La Rébellion a {initial} soldats. Ils recrutent {pourcentage}% de plus. Combien maintenant?",
2026-02-20T22:09:17.3228399Z -                f"Jabba possède {initial} crédits. Il gagne {pourcentage}% de plus. Nouveau montant?"
2026-02-20T22:09:17.3228509Z -            ])
2026-02-20T22:09:17.3229131Z -            explanation_template = f"Augmentation: {initial} + ({initial} × {pourcentage}%) = {result}."
2026-02-20T22:09:17.3229239Z -            
2026-02-20T22:09:17.3229342Z +
2026-02-20T22:09:17.3229534Z +            question_template = random.choice(
2026-02-20T22:09:17.3229644Z +                [
2026-02-20T22:09:17.3230113Z +                    f"L'Empire a {initial} vaisseaux. Leur nombre augmente de {pourcentage}%. Nouveau total?",
2026-02-20T22:09:17.3230787Z +                    f"La Rébellion a {initial} soldats. Ils recrutent {pourcentage}% de plus. Combien maintenant?",
2026-02-20T22:09:17.3231361Z +                    f"Jabba possède {initial} crédits. Il gagne {pourcentage}% de plus. Nouveau montant?",
2026-02-20T22:09:17.3231471Z +                ]
2026-02-20T22:09:17.3231588Z +            )
2026-02-20T22:09:17.3231736Z +            explanation_template = (
2026-02-20T22:09:17.3232193Z +                f"Augmentation: {initial} + ({initial} × {pourcentage}%) = {result}."
2026-02-20T22:09:17.3232302Z +            )
2026-02-20T22:09:17.3232412Z +
2026-02-20T22:09:17.3232659Z          elif problem_type == "probabilité":
2026-02-20T22:09:17.3232809Z              total = random.randint(10, 30)
2026-02-20T22:09:17.3233405Z              favorables = random.randint(1, total // 3)
2026-02-20T22:09:17.3233563Z              result = f"{favorables}/{total}"
2026-02-20T22:09:17.3233667Z -            
2026-02-20T22:09:17.3233834Z -            question_template = random.choice([
2026-02-20T22:09:17.3234702Z -                f"Dans un sac, {total} cristaux dont {favorables} sont bleus. Probabilité d'un cristal bleu?",
2026-02-20T22:09:17.3235385Z -                f"Sur {total} planètes, {favorables} sont habitées. Probabilité qu'une planète soit habitée?",
2026-02-20T22:09:17.3236024Z -                f"Parmi {total} droïdes, {favorables} sont défaillants. Probabilité d'un droïde défaillant?"
2026-02-20T22:09:17.3236144Z -            ])
2026-02-20T22:09:17.3236249Z +
2026-02-20T22:09:17.3236420Z +            question_template = random.choice(
2026-02-20T22:09:17.3236530Z +                [
2026-02-20T22:09:17.3237176Z +                    f"Dans un sac, {total} cristaux dont {favorables} sont bleus. Probabilité d'un cristal bleu?",
2026-02-20T22:09:17.3237860Z +                    f"Sur {total} planètes, {favorables} sont habitées. Probabilité qu'une planète soit habitée?",
2026-02-20T22:09:17.3238527Z +                    f"Parmi {total} droïdes, {favorables} sont défaillants. Probabilité d'un droïde défaillant?",
2026-02-20T22:09:17.3238663Z +                ]
2026-02-20T22:09:17.3238770Z +            )
2026-02-20T22:09:17.3239445Z              explanation_template = f"Probabilité = cas favorables ÷ total: {favorables} ÷ {total} = {result}."
2026-02-20T22:09:17.3239559Z -            
2026-02-20T22:09:17.3239660Z +
2026-02-20T22:09:17.3239904Z          elif problem_type == "séquence":
2026-02-20T22:09:17.3240066Z              start = random.randint(2, 8)
2026-02-20T22:09:17.3240212Z              diff = random.randint(2, 5)
2026-02-20T22:09:17.3240417Z -            sequence = [start + diff*i for i in range(4)]
2026-02-20T22:09:17.3240636Z +            sequence = [start + diff * i for i in range(4)]
2026-02-20T22:09:17.3240799Z              result = sequence[-1] + diff
2026-02-20T22:09:17.3240905Z -            
2026-02-20T22:09:17.3241011Z +
2026-02-20T22:09:17.3241686Z              question_template = f"Séquence Jedi: {', '.join(map(str, sequence))}, ... Quel est le terme suivant?"
2026-02-20T22:09:17.3242320Z -            explanation_template = f"La séquence augmente de {diff}: {sequence[-1]} + {diff} = {result}."
2026-02-20T22:09:17.3242426Z -            
2026-02-20T22:09:17.3242587Z +            explanation_template = (
2026-02-20T22:09:17.3243369Z +                f"La séquence augmente de {diff}: {sequence[-1]} + {diff} = {result}."
2026-02-20T22:09:17.3243495Z +            )
2026-02-20T22:09:17.3243611Z +
2026-02-20T22:09:17.3243837Z          else:  # logique_avancée
2026-02-20T22:09:17.3244058Z              a, b = random.randint(5, 15), random.randint(2, 8)
2026-02-20T22:09:17.3244188Z              result = a * b
2026-02-20T22:09:17.3244309Z -            
2026-02-20T22:09:17.3244481Z -            question_template = random.choice([
2026-02-20T22:09:17.3245106Z -                f"Yoda dit: 'Si {a} Padawans s'entraînent {b} heures chacun, combien d'heures au total?'",
2026-02-20T22:09:17.3245642Z -                f"L'Empire déploie {a} escadrons de {b} TIE Fighters. Combien de TIE Fighters?",
2026-02-20T22:09:17.3246158Z -                f"Dans {a} systèmes, il y a {b} planètes chacun. Combien de planètes au total?"
2026-02-20T22:09:17.3246267Z -            ])
2026-02-20T22:09:17.3246382Z +
2026-02-20T22:09:17.3246552Z +            question_template = random.choice(
2026-02-20T22:09:17.3246666Z +                [
2026-02-20T22:09:17.3247276Z +                    f"Yoda dit: 'Si {a} Padawans s'entraînent {b} heures chacun, combien d'heures au total?'",
2026-02-20T22:09:17.3247829Z +                    f"L'Empire déploie {a} escadrons de {b} TIE Fighters. Combien de TIE Fighters?",
2026-02-20T22:09:17.3248337Z +                    f"Dans {a} systèmes, il y a {b} planètes chacun. Combien de planètes au total?",
2026-02-20T22:09:17.3248708Z +                ]
2026-02-20T22:09:17.3248821Z +            )
2026-02-20T22:09:17.3249154Z              explanation_template = f"Total = {a} × {b} = {result}."
2026-02-20T22:09:17.3249260Z -        
2026-02-20T22:09:17.3249364Z +
2026-02-20T22:09:17.3249841Z          # Choix appropriés selon le type de résultat
2026-02-20T22:09:17.3250049Z          if isinstance(result, str) and "/" in result:
2026-02-20T22:09:17.3250320Z              # Pour les fractions (probabilités)
2026-02-20T22:09:17.3250504Z              num, denom = map(int, result.split("/"))
2026-02-20T22:09:17.3250816Z              choices = [result, f"{num+1}/{denom}", f"{num}/{denom+1}", f"{denom}/{num}"]
2026-02-20T22:09:17.3250942Z @@ -603,619 +726,749 @@
2026-02-20T22:09:17.3251080Z              # Pour les entiers
2026-02-20T22:09:17.3251198Z              choices = [
2026-02-20T22:09:17.3251324Z                  str(result),
2026-02-20T22:09:17.3251496Z                  str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3251721Z                  str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3251852Z -                str(result * 2)
2026-02-20T22:09:17.3251981Z +                str(result * 2),
2026-02-20T22:09:17.3252093Z              ]
2026-02-20T22:09:17.3252233Z          random.shuffle(choices)
2026-02-20T22:09:17.3252353Z -        
2026-02-20T22:09:17.3252504Z -        exercise_data.update({
2026-02-20T22:09:17.3253608Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Défis Galactiques - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3253782Z -            "question": question_template,
2026-02-20T22:09:17.3253935Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3254079Z -            "choices": choices,
2026-02-20T22:09:17.3254697Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.3254808Z -        })
2026-02-20T22:09:17.3254921Z +
2026-02-20T22:09:17.3255072Z +        exercise_data.update(
2026-02-20T22:09:17.3255177Z +            {
2026-02-20T22:09:17.3256109Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Défis Galactiques - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3256288Z +                "question": question_template,
2026-02-20T22:09:17.3256441Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3256573Z +                "choices": choices,
2026-02-20T22:09:17.3257205Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.3257317Z +            }
2026-02-20T22:09:17.3257431Z +        )
2026-02-20T22:09:17.3257636Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3257832Z      elif normalized_type == ExerciseTypes.MIXTE:
2026-02-20T22:09:17.3258364Z          # Génération IA d'un exercice mixte avec PLUSIEURS opérations et thème Star Wars
2026-02-20T22:09:17.3258547Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3258713Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3258821Z -        
2026-02-20T22:09:17.3258925Z +
2026-02-20T22:09:17.3259453Z          # Choisir un pattern de calcul mixte selon la difficulté avec contexte Star Wars
2026-02-20T22:09:17.3259680Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3259970Z              # Pour les débutants: 2 opérations simples
2026-02-20T22:09:17.3260149Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3260293Z              b = random.randint(2, 6)
2026-02-20T22:09:17.3260433Z              c = random.randint(1, 4)
2026-02-20T22:09:17.3260549Z -            
2026-02-20T22:09:17.3260656Z +
2026-02-20T22:09:17.3260786Z              patterns = [
2026-02-20T22:09:17.3260967Z -                (lambda: a + b - c, f"{a} + {b} - {c}",
2026-02-20T22:09:17.3261516Z -                 f"Luke a trouvé {a} cristaux, puis {b} de plus, mais il en a donné {c} à Leia.",
2026-02-20T22:09:17.3262249Z -                 f"On calcule étape par étape: {a} + {b} = {a+b}, puis {a+b} - {c} = {a+b-c}."),
2026-02-20T22:09:17.3262518Z -                (lambda: a * b + c, f"{a} × {b} + {c}",
2026-02-20T22:09:17.3263456Z -                 f"Chaque Padawan a {b} sabres et il y a {a} Padawans, plus {c} sabres de réserve.",
2026-02-20T22:09:17.3264076Z -                 f"D'abord la multiplication: {a} × {b} = {a*b}, puis on ajoute {c}: {a*b} + {c} = {a*b+c}."),
2026-02-20T22:09:17.3264193Z +                (
2026-02-20T22:09:17.3264342Z +                    lambda: a + b - c,
2026-02-20T22:09:17.3264477Z +                    f"{a} + {b} - {c}",
2026-02-20T22:09:17.3265021Z +                    f"Luke a trouvé {a} cristaux, puis {b} de plus, mais il en a donné {c} à Leia.",
2026-02-20T22:09:17.3265535Z +                    f"On calcule étape par étape: {a} + {b} = {a+b}, puis {a+b} - {c} = {a+b-c}.",
2026-02-20T22:09:17.3265649Z +                ),
2026-02-20T22:09:17.3265773Z +                (
2026-02-20T22:09:17.3265901Z +                    lambda: a * b + c,
2026-02-20T22:09:17.3266110Z +                    f"{a} × {b} + {c}",
2026-02-20T22:09:17.3266652Z +                    f"Chaque Padawan a {b} sabres et il y a {a} Padawans, plus {c} sabres de réserve.",
2026-02-20T22:09:17.3267252Z +                    f"D'abord la multiplication: {a} × {b} = {a*b}, puis on ajoute {c}: {a*b} + {c} = {a*b+c}.",
2026-02-20T22:09:17.3267369Z +                ),
2026-02-20T22:09:17.3267474Z              ]
2026-02-20T22:09:17.3267724Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3268019Z              # Intermédiaire: priorité des opérations
2026-02-20T22:09:17.3268184Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3268328Z              b = random.randint(2, 8)
2026-02-20T22:09:17.3268465Z              c = random.randint(2, 6)
2026-02-20T22:09:17.3268572Z -            
2026-02-20T22:09:17.3268672Z +
2026-02-20T22:09:17.3268811Z              patterns = [
2026-02-20T22:09:17.3269085Z -                (lambda: a + b * c, f"{a} + {b} × {c}",
2026-02-20T22:09:17.3269444Z -                 f"L'Alliance a {a} vaisseaux, plus {b} escadrons de {c} chasseurs chacun.",
2026-02-20T22:09:17.3270008Z -                 f"Attention à la priorité! D'abord {b} × {c} = {b*c}, puis {a} + {b*c} = {a + b*c}."),
2026-02-20T22:09:17.3270284Z -                (lambda: a * b - c, f"{a} × {b} - {c}",
2026-02-20T22:09:17.3270762Z -                 f"L'Empire a {a} bataillons de {b} stormtroopers, mais {c} ont déserté.",
2026-02-20T22:09:17.3271242Z -                 f"D'abord {a} × {b} = {a*b}, puis on soustrait {c}: {a*b} - {c} = {a*b - c}."),
2026-02-20T22:09:17.3271357Z +                (
2026-02-20T22:09:17.3271499Z +                    lambda: a + b * c,
2026-02-20T22:09:17.3271710Z +                    f"{a} + {b} × {c}",
2026-02-20T22:09:17.3272074Z +                    f"L'Alliance a {a} vaisseaux, plus {b} escadrons de {c} chasseurs chacun.",
2026-02-20T22:09:17.3272642Z +                    f"Attention à la priorité! D'abord {b} × {c} = {b*c}, puis {a} + {b*c} = {a + b*c}.",
2026-02-20T22:09:17.3272755Z +                ),
2026-02-20T22:09:17.3272863Z +                (
2026-02-20T22:09:17.3273177Z +                    lambda: a * b - c,
2026-02-20T22:09:17.3273408Z +                    f"{a} × {b} - {c}",
2026-02-20T22:09:17.3273853Z +                    f"L'Empire a {a} bataillons de {b} stormtroopers, mais {c} ont déserté.",
2026-02-20T22:09:17.3274235Z +                    f"D'abord {a} × {b} = {a*b}, puis on soustrait {c}: {a*b} - {c} = {a*b - c}.",
2026-02-20T22:09:17.3274330Z +                ),
2026-02-20T22:09:17.3274421Z              ]
2026-02-20T22:09:17.3274508Z          else:
2026-02-20T22:09:17.3274766Z              # Avancé: parenthèses et opérations complexes
2026-02-20T22:09:17.3274906Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3275018Z              b = random.randint(2, 8)
2026-02-20T22:09:17.3275354Z              c = random.randint(2, 6)
2026-02-20T22:09:17.3275449Z -            
2026-02-20T22:09:17.3275537Z +
2026-02-20T22:09:17.3275839Z              # S'assurer que a > b pour éviter les résultats négatifs
2026-02-20T22:09:17.3275943Z              if a <= b:
2026-02-20T22:09:17.3276194Z                  a, b = b + 2, a
2026-02-20T22:09:17.3276290Z -            
2026-02-20T22:09:17.3276385Z +
2026-02-20T22:09:17.3276493Z              patterns = [
2026-02-20T22:09:17.3276735Z -                (lambda: (a + b) * c, f"({a} + {b}) × {c}",
2026-02-20T22:09:17.3277178Z -                 f"Luke et Leia ont ensemble {a} + {b} cristaux, chaque cristal vaut {c} crédits.",
2026-02-20T22:09:17.3277571Z -                 f"D'abord les parenthèses: ({a} + {b}) = {a+b}, puis × {c} = {(a+b)*c}."),
2026-02-20T22:09:17.3277826Z -                (lambda: (a - b) * c, f"({a} - {b}) × {c}",
2026-02-20T22:09:17.3278420Z -                 f"L'Empire avait {a} vaisseaux, {b} ont été détruits, les {a-b} restants ont {c} équipages chacun.",
2026-02-20T22:09:17.3278735Z -                 f"D'abord ({a} - {b}) = {a-b}, puis × {c} = {(a-b)*c}."),
2026-02-20T22:09:17.3278964Z -                (lambda: a * (b + c), f"{a} × ({b} + {c})",
2026-02-20T22:09:17.3279328Z -                 f"Chaque base rebelle ({a} bases) a {b} + {c} défenseurs.",
2026-02-20T22:09:17.3279663Z -                 f"D'abord ({b} + {c}) = {b+c}, puis {a} × {b+c} = {a*(b+c)}."),
2026-02-20T22:09:17.3279762Z -            ]
2026-02-20T22:09:17.3279856Z -        
2026-02-20T22:09:17.3280027Z +                (
2026-02-20T22:09:17.3280151Z +                    lambda: (a + b) * c,
2026-02-20T22:09:17.3280344Z +                    f"({a} + {b}) × {c}",
2026-02-20T22:09:17.3280793Z +                    f"Luke et Leia ont ensemble {a} + {b} cristaux, chaque cristal vaut {c} crédits.",
2026-02-20T22:09:17.3281165Z +                    f"D'abord les parenthèses: ({a} + {b}) = {a+b}, puis × {c} = {(a+b)*c}.",
2026-02-20T22:09:17.3281251Z +                ),
2026-02-20T22:09:17.3281346Z +                (
2026-02-20T22:09:17.3281458Z +                    lambda: (a - b) * c,
2026-02-20T22:09:17.3281648Z +                    f"({a} - {b}) × {c}",
2026-02-20T22:09:17.3282302Z +                    f"L'Empire avait {a} vaisseaux, {b} ont été détruits, les {a-b} restants ont {c} équipages chacun.",
2026-02-20T22:09:17.3282668Z +                    f"D'abord ({a} - {b}) = {a-b}, puis × {c} = {(a-b)*c}.",
2026-02-20T22:09:17.3282781Z +                ),
2026-02-20T22:09:17.3282892Z +                (
2026-02-20T22:09:17.3283209Z +                    lambda: a * (b + c),
2026-02-20T22:09:17.3283436Z +                    f"{a} × ({b} + {c})",
2026-02-20T22:09:17.3283836Z +                    f"Chaque base rebelle ({a} bases) a {b} + {c} défenseurs.",
2026-02-20T22:09:17.3284208Z +                    f"D'abord ({b} + {c}) = {b+c}, puis {a} × {b+c} = {a*(b+c)}.",
2026-02-20T22:09:17.3284326Z +                ),
2026-02-20T22:09:17.3284433Z +            ]
2026-02-20T22:09:17.3284554Z +
2026-02-20T22:09:17.3284842Z          calc_func, formula, context, explain = random.choice(patterns)
2026-02-20T22:09:17.3284983Z          result = calc_func()
2026-02-20T22:09:17.3285087Z -        
2026-02-20T22:09:17.3285187Z +
2026-02-20T22:09:17.3285535Z          question_template = f"{context} Combien au total? (Calcul: {formula})"
2026-02-20T22:09:17.3285687Z          explanation_template = explain
2026-02-20T22:09:17.3285790Z -        
2026-02-20T22:09:17.3285897Z +
2026-02-20T22:09:17.3286171Z          # Générer des choix avec erreurs typiques
2026-02-20T22:09:17.3286287Z          choices = [
2026-02-20T22:09:17.3286409Z              str(result),
2026-02-20T22:09:17.3286577Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3286772Z              str(max(1, result - random.randint(1, 5))),
2026-02-20T22:09:17.3286986Z -            str(a + b + c)  # Erreur courante: additionner tout
2026-02-20T22:09:17.3287207Z +            str(a + b + c),  # Erreur courante: additionner tout
2026-02-20T22:09:17.3287584Z          ]
2026-02-20T22:09:17.3287733Z          choices = list(set(choices))
2026-02-20T22:09:17.3287868Z          while len(choices) < 4:
2026-02-20T22:09:17.3288121Z              choices.append(str(result + random.randint(-10, 10)))
2026-02-20T22:09:17.3288429Z          choices = list(set(choices))[:4]
2026-02-20T22:09:17.3288571Z          random.shuffle(choices)
2026-02-20T22:09:17.3288683Z -        
2026-02-20T22:09:17.3288820Z -        exercise_data.update({
2026-02-20T22:09:17.3289506Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Opération Mixte Galactique (Niveau: {derived_difficulty})",
2026-02-20T22:09:17.3289676Z -            "question": question_template,
2026-02-20T22:09:17.3289827Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3289959Z -            "choices": choices,
2026-02-20T22:09:17.3290083Z -            "formula": formula,
2026-02-20T22:09:17.3290701Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}"
2026-02-20T22:09:17.3290824Z -        })
2026-02-20T22:09:17.3291032Z -        return _apply_test_title(exercise_data)        
2026-02-20T22:09:17.3291146Z +
2026-02-20T22:09:17.3291281Z +        exercise_data.update(
2026-02-20T22:09:17.3291385Z +            {
2026-02-20T22:09:17.3292108Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Opération Mixte Galactique (Niveau: {derived_difficulty})",
2026-02-20T22:09:17.3292272Z +                "question": question_template,
2026-02-20T22:09:17.3292425Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3292561Z +                "choices": choices,
2026-02-20T22:09:17.3292697Z +                "formula": formula,
2026-02-20T22:09:17.3293504Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} {explanation_template} {explanation_suffix}",
2026-02-20T22:09:17.3293619Z +            }
2026-02-20T22:09:17.3293736Z +        )
2026-02-20T22:09:17.3293921Z +        return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3294139Z      elif normalized_type == ExerciseTypes.TEXTE:
2026-02-20T22:09:17.3294551Z          # Génération IA d'exercices textuels avec thème Star Wars
2026-02-20T22:09:17.3294663Z -        
2026-02-20T22:09:17.3294768Z +
2026-02-20T22:09:17.3295128Z          # Générer des nombres aléatoirement selon la difficulté
2026-02-20T22:09:17.3295511Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3295866Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3296025Z              base_num = random.randint(3, 8)
2026-02-20T22:09:17.3296187Z              modifier = random.randint(2, 5)
2026-02-20T22:09:17.3296347Z              large_num = random.randint(10, 20)
2026-02-20T22:09:17.3296726Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3297095Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3297269Z              base_num = random.randint(5, 12)
2026-02-20T22:09:17.3297420Z              modifier = random.randint(3, 7)
2026-02-20T22:09:17.3297569Z              large_num = random.randint(15, 30)
2026-02-20T22:09:17.3297977Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3298369Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3298524Z              base_num = random.randint(8, 15)
2026-02-20T22:09:17.3298682Z              modifier = random.randint(4, 9)
2026-02-20T22:09:17.3298836Z              large_num = random.randint(20, 50)
2026-02-20T22:09:17.3298960Z          else:  # MAITRE
2026-02-20T22:09:17.3299124Z              base_num = random.randint(10, 25)
2026-02-20T22:09:17.3299277Z              modifier = random.randint(5, 12)
2026-02-20T22:09:17.3299435Z              large_num = random.randint(30, 100)
2026-02-20T22:09:17.3299775Z -        
2026-02-20T22:09:17.3299886Z +
2026-02-20T22:09:17.3300234Z          # Choisir un type de problème selon la difficulté
2026-02-20T22:09:17.3300600Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3301198Z -            problem_types = ["simple_addition", "simple_subtraction", "simple_multiplication"]
2026-02-20T22:09:17.3301599Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3301952Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3302094Z +            problem_types = [
2026-02-20T22:09:17.3302228Z +                "simple_addition",
2026-02-20T22:09:17.3302367Z +                "simple_subtraction",
2026-02-20T22:09:17.3302519Z +                "simple_multiplication",
2026-02-20T22:09:17.3302633Z +            ]
2026-02-20T22:09:17.3303189Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3303453Z              problem_types = ["two_step", "sequence", "comparison"]
2026-02-20T22:09:17.3303852Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3304252Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3304500Z              problem_types = ["multi_step", "ratio", "logic_puzzle"]
2026-02-20T22:09:17.3304629Z          else:  # MAITRE
2026-02-20T22:09:17.3304944Z              problem_types = ["complex_multi_step", "algebraic", "advanced_logic"]
2026-02-20T22:09:17.3305049Z -        
2026-02-20T22:09:17.3305160Z +
2026-02-20T22:09:17.3305358Z          problem_type = random.choice(problem_types)
2026-02-20T22:09:17.3305463Z -        
2026-02-20T22:09:17.3305562Z +
2026-02-20T22:09:17.3305839Z          # Générer le problème selon le type
2026-02-20T22:09:17.3306002Z          if problem_type == "simple_addition":
2026-02-20T22:09:17.3306154Z              result = base_num + modifier
2026-02-20T22:09:17.3306344Z -            question_template = random.choice([
2026-02-20T22:09:17.3307109Z -                f"R2-D2 a {base_num} droïdes amis. C-3PO en a {modifier} de plus que R2-D2. Combien C-3PO a-t-il d'amis droïdes?",
2026-02-20T22:09:17.3307703Z -                f"Luke a {base_num} sabres laser. Il en trouve {modifier} autres dans un temple Jedi. Combien en a-t-il maintenant?",
2026-02-20T22:09:17.3308365Z -                f"Dans la cantina, il y a {base_num} contrebandiers et {modifier} pilotes rebelles arrivent. Combien de personnes au total?"
2026-02-20T22:09:17.3308481Z -            ])
2026-02-20T22:09:17.3308588Z -            
2026-02-20T22:09:17.3308756Z +            question_template = random.choice(
2026-02-20T22:09:17.3308874Z +                [
2026-02-20T22:09:17.3309647Z +                    f"R2-D2 a {base_num} droïdes amis. C-3PO en a {modifier} de plus que R2-D2. Combien C-3PO a-t-il d'amis droïdes?",
2026-02-20T22:09:17.3310255Z +                    f"Luke a {base_num} sabres laser. Il en trouve {modifier} autres dans un temple Jedi. Combien en a-t-il maintenant?",
2026-02-20T22:09:17.3310949Z +                    f"Dans la cantina, il y a {base_num} contrebandiers et {modifier} pilotes rebelles arrivent. Combien de personnes au total?",
2026-02-20T22:09:17.3311073Z +                ]
2026-02-20T22:09:17.3311179Z +            )
2026-02-20T22:09:17.3311289Z +
2026-02-20T22:09:17.3311473Z          elif problem_type == "simple_subtraction":
2026-02-20T22:09:17.3311629Z              result = large_num - base_num
2026-02-20T22:09:17.3311796Z -            question_template = random.choice([
2026-02-20T22:09:17.3312522Z -                f"Luke avait {large_num} sabres laser. Il en donne {base_num} à ses Padawans. Combien lui en reste-t-il?",
2026-02-20T22:09:17.3313458Z -                f"L'Empire avait {large_num} TIE Fighters. {base_num} ont été détruits par la Rébellion. Combien en reste-t-il?",
2026-02-20T22:09:17.3314268Z -                f"Yoda possédait {large_num} cristaux Kyber. Il en utilise {base_num} pour l'entraînement. Combien lui reste-t-il?"
2026-02-20T22:09:17.3314605Z -            ])
2026-02-20T22:09:17.3314710Z -            
2026-02-20T22:09:17.3314881Z +            question_template = random.choice(
2026-02-20T22:09:17.3314997Z +                [
2026-02-20T22:09:17.3315903Z +                    f"Luke avait {large_num} sabres laser. Il en donne {base_num} à ses Padawans. Combien lui en reste-t-il?",
2026-02-20T22:09:17.3316715Z +                    f"L'Empire avait {large_num} TIE Fighters. {base_num} ont été détruits par la Rébellion. Combien en reste-t-il?",
2026-02-20T22:09:17.3317535Z +                    f"Yoda possédait {large_num} cristaux Kyber. Il en utilise {base_num} pour l'entraînement. Combien lui reste-t-il?",
2026-02-20T22:09:17.3317645Z +                ]
2026-02-20T22:09:17.3317751Z +            )
2026-02-20T22:09:17.3317863Z +
2026-02-20T22:09:17.3318064Z          elif problem_type == "simple_multiplication":
2026-02-20T22:09:17.3318228Z              result = base_num * modifier
2026-02-20T22:09:17.3318434Z -            question_template = random.choice([
2026-02-20T22:09:17.3319253Z -                f"Dans la cantina, il y a {base_num} tables. Chaque table peut accueillir {modifier} personnes. Combien de personnes peuvent s'asseoir au total?",
2026-02-20T22:09:17.3319671Z -                f"Chaque X-wing a {modifier} missiles. Combien de missiles ont {base_num} X-wings?",
2026-02-20T22:09:17.3320376Z -                f"Chaque Padawan s'entraîne {modifier} heures par jour. Combien d'heures pour {base_num} Padawans?"
2026-02-20T22:09:17.3320496Z -            ])
2026-02-20T22:09:17.3320603Z -            
2026-02-20T22:09:17.3320765Z +            question_template = random.choice(
2026-02-20T22:09:17.3320882Z +                [
2026-02-20T22:09:17.3321686Z +                    f"Dans la cantina, il y a {base_num} tables. Chaque table peut accueillir {modifier} personnes. Combien de personnes peuvent s'asseoir au total?",
2026-02-20T22:09:17.3322131Z +                    f"Chaque X-wing a {modifier} missiles. Combien de missiles ont {base_num} X-wings?",
2026-02-20T22:09:17.3322854Z +                    f"Chaque Padawan s'entraîne {modifier} heures par jour. Combien d'heures pour {base_num} Padawans?",
2026-02-20T22:09:17.3323140Z +                ]
2026-02-20T22:09:17.3323256Z +            )
2026-02-20T22:09:17.3323363Z +
2026-02-20T22:09:17.3323532Z          elif problem_type == "two_step":
2026-02-20T22:09:17.3323685Z              step1_result = base_num * modifier
2026-02-20T22:09:17.3323841Z              result = step1_result - base_num
2026-02-20T22:09:17.3324017Z -            question_template = random.choice([
2026-02-20T22:09:17.3324799Z -                f"Leia a {base_num} crédits. Elle achète {modifier} blasters à {base_num} crédits chacun. Combien lui reste-t-il?",
2026-02-20T22:09:17.3325675Z -                f"Un X-wing consomme {modifier} unités de carburant par parsec. Pour un voyage de {base_num} parsecs, combien d'unités faut-il?",
2026-02-20T22:09:17.3326167Z -                f"Obi-Wan a {base_num} Padawans. Chacun a {modifier} sabres laser. Combien de sabres au total?"
2026-02-20T22:09:17.3326274Z -            ])
2026-02-20T22:09:17.3326439Z +            question_template = random.choice(
2026-02-20T22:09:17.3326566Z +                [
2026-02-20T22:09:17.3327335Z +                    f"Leia a {base_num} crédits. Elle achète {modifier} blasters à {base_num} crédits chacun. Combien lui reste-t-il?",
2026-02-20T22:09:17.3328213Z +                    f"Un X-wing consomme {modifier} unités de carburant par parsec. Pour un voyage de {base_num} parsecs, combien d'unités faut-il?",
2026-02-20T22:09:17.3328697Z +                    f"Obi-Wan a {base_num} Padawans. Chacun a {modifier} sabres laser. Combien de sabres au total?",
2026-02-20T22:09:17.3328801Z +                ]
2026-02-20T22:09:17.3328906Z +            )
2026-02-20T22:09:17.3329074Z              if "reste-t-il" in question_template:
2026-02-20T22:09:17.3329757Z -                result = base_num - step1_result if base_num > step1_result else step1_result - base_num
2026-02-20T22:09:17.3329893Z +                result = (
2026-02-20T22:09:17.3330046Z +                    base_num - step1_result
2026-02-20T22:09:17.3330210Z +                    if base_num > step1_result
2026-02-20T22:09:17.3330588Z +                    else step1_result - base_num
2026-02-20T22:09:17.3330719Z +                )
2026-02-20T22:09:17.3330850Z              else:
2026-02-20T22:09:17.3331008Z                  result = step1_result
2026-02-20T22:09:17.3331120Z -                
2026-02-20T22:09:17.3331234Z +
2026-02-20T22:09:17.3331409Z          elif problem_type == "sequence":
2026-02-20T22:09:17.3331678Z              # Séquence arithmétique
2026-02-20T22:09:17.3331813Z              start = base_num
2026-02-20T22:09:17.3331952Z              step = modifier
2026-02-20T22:09:17.3332251Z              result = start + (3 * step)  # 4ème terme
2026-02-20T22:09:17.3332585Z              sequence = f"{start}, {start + step}, {start + 2*step}, {start + 3*step}"
2026-02-20T22:09:17.3332788Z -            question_template = random.choice([
2026-02-20T22:09:17.3334033Z -                f"Yoda entraîne ses Padawans en séquence: {start}, {start + step}, {start + 2*step}... Quel est le prochain nombre dans cette séquence de la Force?",
2026-02-20T22:09:17.3335019Z -                f"Les coordonnées galactiques suivent cette séquence: {start}, {start + step}, {start + 2*step}... Quelle est la prochaine coordonnée?",
2026-02-20T22:09:17.3335717Z would reformat /home/runner/work/mathakine/mathakine/server/exercise_generator.py
2026-02-20T22:09:17.3336475Z -                f"Le code d'accès Jedi suit ce motif: {start}, {start + step}, {start + 2*step}... Quel est le nombre suivant?"
2026-02-20T22:09:17.3336599Z -            ])
2026-02-20T22:09:17.3336707Z -            
2026-02-20T22:09:17.3336896Z +            question_template = random.choice(
2026-02-20T22:09:17.3337008Z +                [
2026-02-20T22:09:17.3338051Z +                    f"Yoda entraîne ses Padawans en séquence: {start}, {start + step}, {start + 2*step}... Quel est le prochain nombre dans cette séquence de la Force?",
2026-02-20T22:09:17.3339047Z +                    f"Les coordonnées galactiques suivent cette séquence: {start}, {start + step}, {start + 2*step}... Quelle est la prochaine coordonnée?",
2026-02-20T22:09:17.3339805Z +                    f"Le code d'accès Jedi suit ce motif: {start}, {start + step}, {start + 2*step}... Quel est le nombre suivant?",
2026-02-20T22:09:17.3339927Z +                ]
2026-02-20T22:09:17.3340049Z +            )
2026-02-20T22:09:17.3340161Z +
2026-02-20T22:09:17.3340332Z          elif problem_type == "comparison":
2026-02-20T22:09:17.3340519Z              multiplier = random.randint(2, 4)
2026-02-20T22:09:17.3340673Z              result = base_num * multiplier
2026-02-20T22:09:17.3340849Z -            question_template = random.choice([
2026-02-20T22:09:17.3341815Z -                f"Dans une bataille, l'Alliance a {multiplier} fois plus de X-wings que l'Empire a de TIE Fighters. Si l'Empire a {base_num} TIE Fighters, combien l'Alliance a-t-elle de X-wings?",
2026-02-20T22:09:17.3342730Z -                f"Un destroyer stellaire transporte {multiplier} fois plus de soldats qu'une corvette. Si une corvette a {base_num} soldats, combien le destroyer en a-t-il?",
2026-02-20T22:09:17.3343707Z -                f"Jabba a {multiplier} fois plus de crédits que Han Solo. Si Han a {base_num} crédits, combien Jabba en a-t-il?"
2026-02-20T22:09:17.3343833Z -            ])
2026-02-20T22:09:17.3343953Z -            
2026-02-20T22:09:17.3344128Z +            question_template = random.choice(
2026-02-20T22:09:17.3344242Z +                [
2026-02-20T22:09:17.3345242Z +                    f"Dans une bataille, l'Alliance a {multiplier} fois plus de X-wings que l'Empire a de TIE Fighters. Si l'Empire a {base_num} TIE Fighters, combien l'Alliance a-t-elle de X-wings?",
2026-02-20T22:09:17.3346137Z +                    f"Un destroyer stellaire transporte {multiplier} fois plus de soldats qu'une corvette. Si une corvette a {base_num} soldats, combien le destroyer en a-t-il?",
2026-02-20T22:09:17.3347228Z +                    f"Jabba a {multiplier} fois plus de crédits que Han Solo. Si Han a {base_num} crédits, combien Jabba en a-t-il?",
2026-02-20T22:09:17.3347573Z +                ]
2026-02-20T22:09:17.3347705Z +            )
2026-02-20T22:09:17.3347814Z +
2026-02-20T22:09:17.3348198Z          else:  # Types plus complexes pour niveaux élevés
2026-02-20T22:09:17.3348357Z              result = base_num + modifier
2026-02-20T22:09:17.3349342Z              question_template = f"Problème Jedi complexe: La somme de deux nombres consécutifs est {result + result - 1}. Quel est le plus petit nombre?"
2026-02-20T22:09:17.3349705Z              result = base_num  # Pour les problèmes algébriques
2026-02-20T22:09:17.3349819Z -        
2026-02-20T22:09:17.3349926Z +
2026-02-20T22:09:17.3350214Z          # Générer des choix incorrects plausibles
2026-02-20T22:09:17.3350372Z          choices = [
2026-02-20T22:09:17.3350502Z              str(result),
2026-02-20T22:09:17.3350675Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3350878Z              str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3351115Z -            str(result * 2) if result < 50 else str(result // 2)
2026-02-20T22:09:17.3351346Z +            str(result * 2) if result < 50 else str(result // 2),
2026-02-20T22:09:17.3351457Z          ]
2026-02-20T22:09:17.3351610Z          random.shuffle(choices)
2026-02-20T22:09:17.3351716Z -        
2026-02-20T22:09:17.3351859Z -        exercise_data.update({
2026-02-20T22:09:17.3352717Z -            "title": f"[{Messages.AI_EXERCISE_PREFIX}] Énigme Jedi - pour les {age_group} (Niveau: {derived_difficulty})", # Update title
2026-02-20T22:09:17.3352879Z -            "question": question_template,
2026-02-20T22:09:17.3353223Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3353368Z -            "choices": choices,
2026-02-20T22:09:17.3354791Z -            "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour résoudre ce problème, il faut analyser les données et appliquer les bonnes opérations mathématiques. {explanation_suffix}"
2026-02-20T22:09:17.3354910Z -        })
2026-02-20T22:09:17.3355092Z +
2026-02-20T22:09:17.3355265Z +        exercise_data.update(
2026-02-20T22:09:17.3355372Z +            {
2026-02-20T22:09:17.3356244Z +                "title": f"[{Messages.AI_EXERCISE_PREFIX}] Énigme Jedi - pour les {age_group} (Niveau: {derived_difficulty})",  # Update title
2026-02-20T22:09:17.3356424Z +                "question": question_template,
2026-02-20T22:09:17.3356579Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3356711Z +                "choices": choices,
2026-02-20T22:09:17.3358118Z +                "explanation": f"[{Messages.AI_EXERCISE_PREFIX}] {explanation_prefix} Pour résoudre ce problème, il faut analyser les données et appliquer les bonnes opérations mathématiques. {explanation_suffix}",
2026-02-20T22:09:17.3358483Z +            }
2026-02-20T22:09:17.3358590Z +        )
2026-02-20T22:09:17.3358782Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3359257Z      # Si aucun type correspondant, retourner un exercice d'addition par défaut
2026-02-20T22:09:17.3359427Z      min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3359580Z      max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3359750Z      num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3359906Z      num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3360031Z      result = num1 + num2
2026-02-20T22:09:17.3360142Z -    
2026-02-20T22:09:17.3360280Z -    exercise_data.update({
2026-02-20T22:09:17.3360458Z -        "title": ExerciseMessages.TITLE_DEFAULT,
2026-02-20T22:09:17.3360838Z -        "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3360995Z -        "correct_answer": str(result),
2026-02-20T22:09:17.3361298Z -        "choices": [str(result), str(result-1), str(result+1), str(result+2)],
2026-02-20T22:09:17.3361421Z -        "num1": num1,
2026-02-20T22:09:17.3361541Z -        "num2": num2,
2026-02-20T22:09:17.3362300Z -        "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3362421Z -    })
2026-02-20T22:09:17.3362530Z -    
2026-02-20T22:09:17.3362709Z -    return _apply_test_title(exercise_data) 
2026-02-20T22:09:17.3362814Z +
2026-02-20T22:09:17.3362948Z +    exercise_data.update(
2026-02-20T22:09:17.3363246Z +        {
2026-02-20T22:09:17.3363438Z +            "title": ExerciseMessages.TITLE_DEFAULT,
2026-02-20T22:09:17.3363829Z +            "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3363987Z +            "correct_answer": str(result),
2026-02-20T22:09:17.3364324Z +            "choices": [str(result), str(result - 1), str(result + 1), str(result + 2)],
2026-02-20T22:09:17.3364457Z +            "num1": num1,
2026-02-20T22:09:17.3364582Z +            "num2": num2,
2026-02-20T22:09:17.3365144Z +            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3365255Z +        }
2026-02-20T22:09:17.3365370Z +    )
2026-02-20T22:09:17.3365480Z +
2026-02-20T22:09:17.3365651Z +    return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3365754Z +
2026-02-20T22:09:17.3365863Z  
2026-02-20T22:09:17.3366033Z  def ensure_explanation(exercise_dict):
2026-02-20T22:09:17.3366255Z      """S'assure qu'un exercice a une explication valide"""
2026-02-20T22:09:17.3366637Z      # S'assurer que l'explication est définie et n'est pas None
2026-02-20T22:09:17.3367482Z -    if 'explanation' not in exercise_dict or exercise_dict['explanation'] is None or exercise_dict['explanation'] == "None" or exercise_dict['explanation'] == "":
2026-02-20T22:09:17.3367765Z -        if exercise_dict['exercise_type'] == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3368724Z -            exercise_dict['explanation'] = f"Pour additionner {exercise_dict.get('num1', '?')} et {exercise_dict.get('num2', '?')}, il faut calculer leur somme: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3369058Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3370295Z -            exercise_dict['explanation'] = f"Pour soustraire {exercise_dict.get('num2', '?')} de {exercise_dict.get('num1', '?')}, il faut calculer leur différence: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3370632Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3371601Z -            exercise_dict['explanation'] = f"Pour multiplier {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur produit: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3371902Z -        elif exercise_dict['exercise_type'] == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3373236Z -            exercise_dict['explanation'] = f"Pour diviser {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur quotient: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3373375Z +    if (
2026-02-20T22:09:17.3373553Z +        "explanation" not in exercise_dict
2026-02-20T22:09:17.3373734Z +        or exercise_dict["explanation"] is None
2026-02-20T22:09:17.3373924Z +        or exercise_dict["explanation"] == "None"
2026-02-20T22:09:17.3374087Z +        or exercise_dict["explanation"] == ""
2026-02-20T22:09:17.3374194Z +    ):
2026-02-20T22:09:17.3374478Z +        if exercise_dict["exercise_type"] == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3374636Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3375387Z +                f"Pour additionner {exercise_dict.get('num1', '?')} et {exercise_dict.get('num2', '?')}, il faut calculer leur somme: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3375510Z +            )
2026-02-20T22:09:17.3375827Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3375983Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3377214Z +                f"Pour soustraire {exercise_dict.get('num2', '?')} de {exercise_dict.get('num1', '?')}, il faut calculer leur différence: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3377346Z +            )
2026-02-20T22:09:17.3377684Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3377851Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3378634Z +                f"Pour multiplier {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur produit: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3378744Z +            )
2026-02-20T22:09:17.3379033Z +        elif exercise_dict["exercise_type"] == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3379200Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3380040Z +                f"Pour diviser {exercise_dict.get('num1', '?')} par {exercise_dict.get('num2', '?')}, il faut calculer leur quotient: {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3380155Z +            )
2026-02-20T22:09:17.3380272Z          else:
2026-02-20T22:09:17.3380927Z -            exercise_dict['explanation'] = f"La réponse correcte est {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3381041Z -    
2026-02-20T22:09:17.3381176Z -    return exercise_dict 
2026-02-20T22:09:17.3381341Z +            exercise_dict["explanation"] = (
2026-02-20T22:09:17.3381743Z +                f"La réponse correcte est {exercise_dict['correct_answer']}"
2026-02-20T22:09:17.3381850Z +            )
2026-02-20T22:09:17.3381961Z +
2026-02-20T22:09:17.3382090Z +    return exercise_dict
2026-02-20T22:09:17.3382198Z +
2026-02-20T22:09:17.3382307Z  
2026-02-20T22:09:17.3382538Z  def generate_simple_exercise(exercise_type, age_group):
2026-02-20T22:09:17.3382785Z      """Génère un exercice simple sans IA"""
2026-02-20T22:09:17.3382904Z -    
2026-02-20T22:09:17.3383214Z +
2026-02-20T22:09:17.3383475Z      normalized_type = normalize_exercise_type(exercise_type)
2026-02-20T22:09:17.3383712Z      normalized_age_group = normalize_age_group(age_group)
2026-02-20T22:09:17.3384074Z      derived_difficulty = get_difficulty_from_age_group(normalized_age_group)
2026-02-20T22:09:17.3384182Z -    
2026-02-20T22:09:17.3384286Z +
2026-02-20T22:09:17.3384787Z      # Récupérer les limites pour ce type d'exercice et cette difficulté dérivée
2026-02-20T22:09:17.3385373Z -    difficulty_config = DIFFICULTY_LIMITS.get(derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN])
2026-02-20T22:09:17.3385942Z -    type_limits = difficulty_config.get(normalized_type, difficulty_config.get("default", {"min": 1, "max": 10}))
2026-02-20T22:09:17.3386059Z -    
2026-02-20T22:09:17.3386260Z +    difficulty_config = DIFFICULTY_LIMITS.get(
2026-02-20T22:09:17.3386582Z +        derived_difficulty, DIFFICULTY_LIMITS[DifficultyLevels.PADAWAN]
2026-02-20T22:09:17.3386991Z +    )
2026-02-20T22:09:17.3387176Z +    type_limits = difficulty_config.get(
2026-02-20T22:09:17.3387529Z +        normalized_type, difficulty_config.get("default", {"min": 1, "max": 10})
2026-02-20T22:09:17.3387643Z +    )
2026-02-20T22:09:17.3387748Z +
2026-02-20T22:09:17.3388048Z      # Structure de base commune pour tous les types d'exercices
2026-02-20T22:09:17.3388184Z      exercise_data = {
2026-02-20T22:09:17.3388342Z          "exercise_type": normalized_type,
2026-02-20T22:09:17.3388510Z          "age_group": normalized_age_group,
2026-02-20T22:09:17.3388665Z          "difficulty": derived_difficulty,
2026-02-20T22:09:17.3388800Z          "ai_generated": False,
2026-02-20T22:09:17.3388951Z -        "tags": Tags.ALGORITHMIC
2026-02-20T22:09:17.3389090Z +        "tags": Tags.ALGORITHMIC,
2026-02-20T22:09:17.3389201Z      }
2026-02-20T22:09:17.3389307Z -    
2026-02-20T22:09:17.3389421Z +
2026-02-20T22:09:17.3389635Z      if normalized_type == ExerciseTypes.ADDITION:
2026-02-20T22:09:17.3389923Z          # Génération d'une addition
2026-02-20T22:09:17.3390255Z          min_val, max_val = type_limits.get("min", 1), type_limits.get("max", 10)
2026-02-20T22:09:17.3390844Z          num1, num2 = random.randint(min_val, max_val), random.randint(min_val, max_val)
2026-02-20T22:09:17.3390976Z -        
2026-02-20T22:09:17.3391086Z +
2026-02-20T22:09:17.3391234Z          result = num1 + num2
2026-02-20T22:09:17.3391620Z          question = ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3391774Z          correct_answer = str(result)
2026-02-20T22:09:17.3391895Z -        
2026-02-20T22:09:17.3392005Z +
2026-02-20T22:09:17.3392457Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3393314Z -        error_margin = max(1, min(int(max_val * 0.1), 10))  # Marge d'erreur proportionnelle à la difficulté
2026-02-20T22:09:17.3393435Z -        
2026-02-20T22:09:17.3393575Z +        error_margin = max(
2026-02-20T22:09:17.3393745Z +            1, min(int(max_val * 0.1), 10)
2026-02-20T22:09:17.3394118Z +        )  # Marge d'erreur proportionnelle à la difficulté
2026-02-20T22:09:17.3394234Z +
2026-02-20T22:09:17.3394362Z          choices = [
2026-02-20T22:09:17.3394637Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3394851Z              str(result + random.randint(1, error_margin)),
2026-02-20T22:09:17.3395063Z              str(result - random.randint(1, error_margin)),
2026-02-20T22:09:17.3395574Z -            str(num1 * num2) if num1 * num2 != result else str(result + error_margin + 1)  # Distraction: multiplication
2026-02-20T22:09:17.3395697Z +            (
2026-02-20T22:09:17.3395828Z +                str(num1 * num2)
2026-02-20T22:09:17.3395963Z +                if num1 * num2 != result
2026-02-20T22:09:17.3396150Z +                else str(result + error_margin + 1)
2026-02-20T22:09:17.3396315Z +            ),  # Distraction: multiplication
2026-02-20T22:09:17.3396439Z          ]
2026-02-20T22:09:17.3396593Z          random.shuffle(choices)
2026-02-20T22:09:17.3396698Z  
2026-02-20T22:09:17.3396843Z -        exercise_data.update({
2026-02-20T22:09:17.3397047Z -            "title": ExerciseMessages.TITLE_ADDITION,
2026-02-20T22:09:17.3397199Z -            "question": question,
2026-02-20T22:09:17.3397379Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3397514Z -            "choices": choices,
2026-02-20T22:09:17.3397721Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3397844Z -            "num1": num1,
2026-02-20T22:09:17.3397965Z -            "num2": num2,
2026-02-20T22:09:17.3398544Z -            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3398654Z -        })
2026-02-20T22:09:17.3398794Z +        exercise_data.update(
2026-02-20T22:09:17.3398902Z +            {
2026-02-20T22:09:17.3399110Z +                "title": ExerciseMessages.TITLE_ADDITION,
2026-02-20T22:09:17.3399554Z +                "question": question,
2026-02-20T22:09:17.3399727Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3399867Z +                "choices": choices,
2026-02-20T22:09:17.3400082Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3400208Z +                "num1": num1,
2026-02-20T22:09:17.3400329Z +                "num2": num2,
2026-02-20T22:09:17.3400930Z +                "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3401045Z +            }
2026-02-20T22:09:17.3401156Z +        )
2026-02-20T22:09:17.3401345Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3401455Z  
2026-02-20T22:09:17.3401688Z      elif normalized_type == ExerciseTypes.SUBTRACTION:
2026-02-20T22:09:17.3401978Z          # Génération d'une soustraction
2026-02-20T22:09:17.3402121Z          limits = type_limits
2026-02-20T22:09:17.3402457Z          num1 = random.randint(limits.get("min1", 5), limits.get("max1", 20))
2026-02-20T22:09:17.3402951Z -        num2 = random.randint(limits.get("min2", 1), min(num1-1, limits.get("max2", 5)))  # Assurer num2 < num1
2026-02-20T22:09:17.3403283Z -        
2026-02-20T22:09:17.3403651Z +        num2 = random.randint(
2026-02-20T22:09:17.3403943Z +            limits.get("min2", 1), min(num1 - 1, limits.get("max2", 5))
2026-02-20T22:09:17.3404092Z +        )  # Assurer num2 < num1
2026-02-20T22:09:17.3404194Z +
2026-02-20T22:09:17.3404317Z          result = num1 - num2
2026-02-20T22:09:17.3404725Z          question = ExerciseMessages.QUESTION_SUBTRACTION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3404879Z          correct_answer = str(result)
2026-02-20T22:09:17.3404988Z -        
2026-02-20T22:09:17.3405093Z +
2026-02-20T22:09:17.3405562Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3405847Z          error_margin = max(1, min(int(limits.get("max2", 5) * 0.2), 10))
2026-02-20T22:09:17.3405975Z -        
2026-02-20T22:09:17.3406089Z +
2026-02-20T22:09:17.3406213Z          choices = [
2026-02-20T22:09:17.3406468Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3406686Z              str(result + random.randint(1, error_margin)),
2026-02-20T22:09:17.3407111Z -            str(result - random.randint(1, min(error_margin, result-1) if result > 1 else 1)),
2026-02-20T22:09:17.3407531Z -            str(num2 - num1) if num2 > num1 else str(result + error_margin + 2)  # Erreur: inversion de l'ordre
2026-02-20T22:09:17.3407637Z +            str(
2026-02-20T22:09:17.3407758Z +                result
2026-02-20T22:09:17.3408066Z +                - random.randint(1, min(error_margin, result - 1) if result > 1 else 1)
2026-02-20T22:09:17.3408174Z +            ),
2026-02-20T22:09:17.3408282Z +            (
2026-02-20T22:09:17.3408564Z +                str(num2 - num1) if num2 > num1 else str(result + error_margin + 2)
2026-02-20T22:09:17.3408752Z +            ),  # Erreur: inversion de l'ordre
2026-02-20T22:09:17.3408872Z          ]
2026-02-20T22:09:17.3409024Z          random.shuffle(choices)
2026-02-20T22:09:17.3409138Z  
2026-02-20T22:09:17.3409281Z -        exercise_data.update({
2026-02-20T22:09:17.3409516Z -            "title": ExerciseMessages.TITLE_SUBTRACTION,
2026-02-20T22:09:17.3409654Z -            "question": question,
2026-02-20T22:09:17.3409815Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3409956Z -            "choices": choices,
2026-02-20T22:09:17.3410152Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3410280Z -            "num1": num1,
2026-02-20T22:09:17.3410400Z -            "num2": num2,
2026-02-20T22:09:17.3411272Z -            "explanation": f"Pour soustraire {num2} de {num1}, il faut calculer leur différence, donc {num1} - {num2} = {result}."
2026-02-20T22:09:17.3411387Z -        })
2026-02-20T22:09:17.3411544Z +        exercise_data.update(
2026-02-20T22:09:17.3411936Z +            {
2026-02-20T22:09:17.3412158Z +                "title": ExerciseMessages.TITLE_SUBTRACTION,
2026-02-20T22:09:17.3412304Z +                "question": question,
2026-02-20T22:09:17.3412480Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3412642Z +                "choices": choices,
2026-02-20T22:09:17.3412845Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3413187Z +                "num1": num1,
2026-02-20T22:09:17.3413331Z +                "num2": num2,
2026-02-20T22:09:17.3414178Z +                "explanation": f"Pour soustraire {num2} de {num1}, il faut calculer leur différence, donc {num1} - {num2} = {result}.",
2026-02-20T22:09:17.3414292Z +            }
2026-02-20T22:09:17.3414409Z +        )
2026-02-20T22:09:17.3414584Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3414690Z  
2026-02-20T22:09:17.3414937Z      elif normalized_type == ExerciseTypes.MULTIPLICATION:
2026-02-20T22:09:17.3415198Z          # Génération d'une multiplication
2026-02-20T22:09:17.3415525Z          min_val, max_val = type_limits.get("min", 1), type_limits.get("max", 10)
2026-02-20T22:09:17.3415895Z          num1, num2 = random.randint(min_val, max_val), random.randint(min_val, max_val)
2026-02-20T22:09:17.3416020Z -        
2026-02-20T22:09:17.3416369Z +
2026-02-20T22:09:17.3416523Z          result = num1 * num2
2026-02-20T22:09:17.3416957Z          question = ExerciseMessages.QUESTION_MULTIPLICATION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3417108Z          correct_answer = str(result)
2026-02-20T22:09:17.3417216Z -        
2026-02-20T22:09:17.3417318Z +
2026-02-20T22:09:17.3417749Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3417867Z          choices = [
2026-02-20T22:09:17.3418090Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3418298Z              str(result + num1),  # Erreur: une fois de trop
2026-02-20T22:09:17.3418509Z              str(result - num2),  # Erreur: une fois de moins
2026-02-20T22:09:17.3418793Z -            str(num1 + num2)  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.3419075Z +            str(num1 + num2),  # Erreur: addition au lieu de multiplication
2026-02-20T22:09:17.3419182Z          ]
2026-02-20T22:09:17.3419339Z          random.shuffle(choices)
2026-02-20T22:09:17.3419445Z  
2026-02-20T22:09:17.3419590Z -        exercise_data.update({
2026-02-20T22:09:17.3419806Z -            "title": ExerciseMessages.TITLE_MULTIPLICATION,
2026-02-20T22:09:17.3419937Z -            "question": question,
2026-02-20T22:09:17.3420105Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3420233Z -            "choices": choices,
2026-02-20T22:09:17.3420430Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3420554Z -            "num1": num1,
2026-02-20T22:09:17.3420681Z -            "num2": num2,
2026-02-20T22:09:17.3421469Z -            "explanation": f"Pour multiplier {num1} par {num2}, il faut calculer leur produit, donc {num1} × {num2} = {result}."
2026-02-20T22:09:17.3421589Z -        })
2026-02-20T22:09:17.3421738Z +        exercise_data.update(
2026-02-20T22:09:17.3421842Z +            {
2026-02-20T22:09:17.3422070Z +                "title": ExerciseMessages.TITLE_MULTIPLICATION,
2026-02-20T22:09:17.3422226Z +                "question": question,
2026-02-20T22:09:17.3422390Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3422522Z +                "choices": choices,
2026-02-20T22:09:17.3422719Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3422847Z +                "num1": num1,
2026-02-20T22:09:17.3423146Z +                "num2": num2,
2026-02-20T22:09:17.3423953Z +                "explanation": f"Pour multiplier {num1} par {num2}, il faut calculer leur produit, donc {num1} × {num2} = {result}.",
2026-02-20T22:09:17.3424074Z +            }
2026-02-20T22:09:17.3424180Z +        )
2026-02-20T22:09:17.3424357Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3424675Z  
2026-02-20T22:09:17.3424896Z      elif normalized_type == ExerciseTypes.DIVISION:
2026-02-20T22:09:17.3425133Z          # Génération d'une division
2026-02-20T22:09:17.3425268Z          limits = type_limits
2026-02-20T22:09:17.3425471Z          min_divisor = limits.get("min_divisor", 2)
2026-02-20T22:09:17.3425652Z          max_divisor = limits.get("max_divisor", 5)
2026-02-20T22:09:17.3425820Z          min_result = limits.get("min_result", 1)
2026-02-20T22:09:17.3425993Z          max_result = limits.get("max_result", 5)
2026-02-20T22:09:17.3426106Z -        
2026-02-20T22:09:17.3426208Z +
2026-02-20T22:09:17.3426699Z          # Générer d'abord le diviseur et le résultat pour assurer une division exacte
2026-02-20T22:09:17.3426969Z          num2 = random.randint(min_divisor, max_divisor)  # diviseur
2026-02-20T22:09:17.3427226Z          result = random.randint(min_result, max_result)  # quotient
2026-02-20T22:09:17.3427372Z          num1 = num2 * result  # dividende
2026-02-20T22:09:17.3427496Z  
2026-02-20T22:09:17.3427866Z          question = ExerciseMessages.QUESTION_DIVISION.format(num1=num1, num2=num2)
2026-02-20T22:09:17.3428014Z          correct_answer = str(result)
2026-02-20T22:09:17.3428128Z -        
2026-02-20T22:09:17.3428234Z +
2026-02-20T22:09:17.3428853Z          # Générer des choix proches mais différents selon la difficulté
2026-02-20T22:09:17.3428986Z          choices = [
2026-02-20T22:09:17.3429236Z              str(result),  # Bonne réponse
2026-02-20T22:09:17.3429384Z              str(result + 1),  # Une de plus
2026-02-20T22:09:17.3429610Z              str(max(1, result - 1)),  # Une de moins (minimum 1)
2026-02-20T22:09:17.3430170Z -            str(num1 // (num2 + 1)) if num2 < 9 else str(result + 2)  # Diviseur légèrement différent
2026-02-20T22:09:17.3430283Z +            (
2026-02-20T22:09:17.3430518Z +                str(num1 // (num2 + 1)) if num2 < 9 else str(result + 2)
2026-02-20T22:09:17.3430781Z +            ),  # Diviseur légèrement différent
2026-02-20T22:09:17.3430902Z          ]
2026-02-20T22:09:17.3431040Z          random.shuffle(choices)
2026-02-20T22:09:17.3431143Z  
2026-02-20T22:09:17.3431290Z -        exercise_data.update({
2026-02-20T22:09:17.3431484Z -            "title": ExerciseMessages.TITLE_DIVISION,
2026-02-20T22:09:17.3431630Z -            "question": question,
2026-02-20T22:09:17.3431799Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3431927Z -            "choices": choices,
2026-02-20T22:09:17.3432119Z -            "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3432245Z -            "num1": num1,
2026-02-20T22:09:17.3432366Z -            "num2": num2,
2026-02-20T22:09:17.3433327Z -            "explanation": f"Pour diviser {num1} par {num2}, il faut calculer leur quotient, donc {num1} ÷ {num2} = {result}."
2026-02-20T22:09:17.3433442Z -        })
2026-02-20T22:09:17.3433592Z +        exercise_data.update(
2026-02-20T22:09:17.3433699Z +            {
2026-02-20T22:09:17.3433915Z +                "title": ExerciseMessages.TITLE_DIVISION,
2026-02-20T22:09:17.3434060Z +                "question": question,
2026-02-20T22:09:17.3434224Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3434355Z +                "choices": choices,
2026-02-20T22:09:17.3434562Z +                "tags": Tags.ALGORITHMIC + "," + Tags.SIMPLE,
2026-02-20T22:09:17.3434698Z +                "num1": num1,
2026-02-20T22:09:17.3434822Z +                "num2": num2,
2026-02-20T22:09:17.3435603Z +                "explanation": f"Pour diviser {num1} par {num2}, il faut calculer leur quotient, donc {num1} ÷ {num2} = {result}.",
2026-02-20T22:09:17.3435723Z +            }
2026-02-20T22:09:17.3435829Z +        )
2026-02-20T22:09:17.3436003Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3436107Z -    
2026-02-20T22:09:17.3436214Z +
2026-02-20T22:09:17.3436408Z      elif normalized_type == ExerciseTypes.TEXTE:
2026-02-20T22:09:17.3436858Z          # Génération d'un exercice textuel (problèmes logiques, énigmes, etc.)
2026-02-20T22:09:17.3437230Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3437387Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3437495Z -        
2026-02-20T22:09:17.3437604Z +
2026-02-20T22:09:17.3438230Z          # Choisir un type de problème textuel en fonction du groupe d'âge (via la difficulté dérivée)
2026-02-20T22:09:17.3438454Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3438748Z              # Problèmes textuels simples pour débutants
2026-02-20T22:09:17.3439219Z -            problem_type = random.choice(["logique_simple", "devinette_nombre", "probleme_concret"])
2026-02-20T22:09:17.3439373Z +            problem_type = random.choice(
2026-02-20T22:09:17.3439633Z +                ["logique_simple", "devinette_nombre", "probleme_concret"]
2026-02-20T22:09:17.3439749Z +            )
2026-02-20T22:09:17.3439999Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3440579Z -            problem_type = random.choice(["logique_simple", "devinette_nombre", "probleme_concret", "sequence_simple"])
2026-02-20T22:09:17.3440743Z +            problem_type = random.choice(
2026-02-20T22:09:17.3440852Z +                [
2026-02-20T22:09:17.3441175Z +                    "logique_simple",
2026-02-20T22:09:17.3441333Z +                    "devinette_nombre",
2026-02-20T22:09:17.3441486Z +                    "probleme_concret",
2026-02-20T22:09:17.3441624Z +                    "sequence_simple",
2026-02-20T22:09:17.3441730Z +                ]
2026-02-20T22:09:17.3441848Z +            )
2026-02-20T22:09:17.3442097Z          elif derived_difficulty == DifficultyLevels.CHEVALIER:
2026-02-20T22:09:17.3442608Z -            problem_type = random.choice(["logique_avance", "enigme_math", "probleme_etapes", "sequence_avance"])
2026-02-20T22:09:17.3442773Z +            problem_type = random.choice(
2026-02-20T22:09:17.3443271Z +                ["logique_avance", "enigme_math", "probleme_etapes", "sequence_avance"]
2026-02-20T22:09:17.3443399Z +            )
2026-02-20T22:09:17.3443526Z          else:  # MAITRE
2026-02-20T22:09:17.3444100Z -            problem_type = random.choice(["logique_complexe", "enigme_complexe", "probleme_multi_etapes", "code_secret"])
2026-02-20T22:09:17.3444211Z -        
2026-02-20T22:09:17.3444372Z +            problem_type = random.choice(
2026-02-20T22:09:17.3444493Z +                [
2026-02-20T22:09:17.3444633Z +                    "logique_complexe",
2026-02-20T22:09:17.3444772Z +                    "enigme_complexe",
2026-02-20T22:09:17.3444937Z +                    "probleme_multi_etapes",
2026-02-20T22:09:17.3445066Z +                    "code_secret",
2026-02-20T22:09:17.3445180Z +                ]
2026-02-20T22:09:17.3445290Z +            )
2026-02-20T22:09:17.3445405Z +
2026-02-20T22:09:17.3445762Z          # Logique pour chaque type de problème textuel
2026-02-20T22:09:17.3445935Z          if problem_type == "logique_simple":
2026-02-20T22:09:17.3446185Z              # Problème logique simple
2026-02-20T22:09:17.3446330Z -            objets = random.choice([
2026-02-20T22:09:17.3446470Z -                ("sabres laser", "Luke"),
2026-02-20T22:09:17.3446690Z -                ("droïdes", "R2-D2"),
2026-02-20T22:09:17.3446864Z -                ("vaisseaux", "l'Alliance"),
2026-02-20T22:09:17.3447003Z -                ("cristaux", "Yoda")
2026-02-20T22:09:17.3447114Z -            ])
2026-02-20T22:09:17.3447261Z +            objets = random.choice(
2026-02-20T22:09:17.3447367Z +                [
2026-02-20T22:09:17.3447523Z +                    ("sabres laser", "Luke"),
2026-02-20T22:09:17.3447766Z +                    ("droïdes", "R2-D2"),
2026-02-20T22:09:17.3447930Z +                    ("vaisseaux", "l'Alliance"),
2026-02-20T22:09:17.3448064Z +                    ("cristaux", "Yoda"),
2026-02-20T22:09:17.3448174Z +                ]
2026-02-20T22:09:17.3448294Z +            )
2026-02-20T22:09:17.3448440Z              objet, personnage = objets
2026-02-20T22:09:17.3448801Z -            
2026-02-20T22:09:17.3448920Z +
2026-02-20T22:09:17.3449120Z              initial = random.randint(min_val, max_val)
2026-02-20T22:09:17.3449416Z -            donnés = random.randint(1, initial-1)
2026-02-20T22:09:17.3449700Z +            donnés = random.randint(1, initial - 1)
2026-02-20T22:09:17.3449943Z              result = initial - donnés
2026-02-20T22:09:17.3450057Z -            
2026-02-20T22:09:17.3450161Z +
2026-02-20T22:09:17.3450874Z              problem = f"{personnage} a {initial} {objet}. Il en donne {donnés} à ses amis. Combien lui en reste-t-il ?"
2026-02-20T22:09:17.3451777Z              explanation = f"Pour trouver ce qui reste, on soustrait ce qui a été donné du total initial. Donc {initial} - {donnés} = {result}."
2026-02-20T22:09:17.3451925Z              answer_type = "number"
2026-02-20T22:09:17.3452043Z -            
2026-02-20T22:09:17.3452153Z +
2026-02-20T22:09:17.3452342Z          elif problem_type == "devinette_nombre":
2026-02-20T22:09:17.3452510Z              # Devinette sur un nombre
2026-02-20T22:09:17.3452755Z              if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3452901Z                  # Devinette simple
2026-02-20T22:09:17.3453278Z                  nombre = random.randint(1, 10)
2026-02-20T22:09:17.3453670Z                  indices = []
2026-02-20T22:09:17.3453835Z                  if nombre % 2 == 0:
2026-02-20T22:09:17.3454002Z                      indices.append("pair")
2026-02-20T22:09:17.3454122Z                  else:
2026-02-20T22:09:17.3454294Z                      indices.append("impair")
2026-02-20T22:09:17.3454407Z -                
2026-02-20T22:09:17.3454512Z +
2026-02-20T22:09:17.3454651Z                  if nombre < 5:
2026-02-20T22:09:17.3454838Z                      indices.append("plus petit que 5")
2026-02-20T22:09:17.3454959Z                  else:
2026-02-20T22:09:17.3455142Z                      indices.append("plus grand que 4")
2026-02-20T22:09:17.3455251Z -                
2026-02-20T22:09:17.3455367Z +
2026-02-20T22:09:17.3456102Z                  problem = f"Je pense à un nombre entre 1 et 10. Il est {indices[0]} et {indices[1]}. Quel est ce nombre ?"
2026-02-20T22:09:17.3456567Z                  explanation = f"En cherchant un nombre {indices[0]} et {indices[1]}, on trouve {nombre}."
2026-02-20T22:09:17.3456721Z                  result = nombre
2026-02-20T22:09:17.3456838Z              else:
2026-02-20T22:09:17.3457000Z                  # Devinette plus complexe
2026-02-20T22:09:17.3457166Z                  nombre = random.randint(10, 50)
2026-02-20T22:09:17.3457445Z                  operation = random.choice(["addition", "multiplication"])
2026-02-20T22:09:17.3457562Z -                
2026-02-20T22:09:17.3457667Z +
2026-02-20T22:09:17.3457826Z                  if operation == "addition":
2026-02-20T22:09:17.3457992Z                      ajout = random.randint(5, 15)
2026-02-20T22:09:17.3458165Z                      resultat_op = nombre + ajout
2026-02-20T22:09:17.3458870Z                      problem = f"Je pense à un nombre. Si j'ajoute {ajout}, j'obtiens {resultat_op}. Quel est mon nombre ?"
2026-02-20T22:09:17.3459531Z                      explanation = f"Pour trouver le nombre, on soustrait {ajout} de {resultat_op}. Donc {resultat_op} - {ajout} = {nombre}."
2026-02-20T22:09:17.3459675Z                  else:
2026-02-20T22:09:17.3459847Z                      facteur = random.randint(2, 5)
2026-02-20T22:09:17.3460010Z                      resultat_op = nombre * facteur
2026-02-20T22:09:17.3460801Z                      problem = f"Je pense à un nombre. Si je le multiplie par {facteur}, j'obtiens {resultat_op}. Quel est mon nombre ?"
2026-02-20T22:09:17.3461658Z                      explanation = f"Pour trouver le nombre, on divise {resultat_op} par {facteur}. Donc {resultat_op} ÷ {facteur} = {nombre}."
2026-02-20T22:09:17.3461776Z -                
2026-02-20T22:09:17.3461890Z +
2026-02-20T22:09:17.3462026Z                  result = nombre
2026-02-20T22:09:17.3462165Z              answer_type = "number"
2026-02-20T22:09:17.3462528Z -            
2026-02-20T22:09:17.3462640Z +
2026-02-20T22:09:17.3462843Z          elif problem_type == "probleme_concret":
2026-02-20T22:09:17.3463366Z              # Problème concret avec contexte Star Wars
2026-02-20T22:09:17.3463509Z              scenarios = [
2026-02-20T22:09:17.3463633Z                  {
2026-02-20T22:09:17.3463838Z                      "context": "Dans la cantina de Mos Eisley",
2026-02-20T22:09:17.3464305Z                      "action": "Luke commande {nb1} boissons à {prix} crédits chacune",
2026-02-20T22:09:17.3464530Z                      "question": "Combien paie-t-il au total ?",
2026-02-20T22:09:17.3464713Z                      "calc": lambda nb1, prix: nb1 * prix,
2026-02-20T22:09:17.3465627Z -                    "explanation": "Pour calculer le total, on multiplie le nombre de boissons par le prix unitaire. Donc {nb1} × {prix} = {result}."
2026-02-20T22:09:17.3466561Z +                    "explanation": "Pour calculer le total, on multiplie le nombre de boissons par le prix unitaire. Donc {nb1} × {prix} = {result}.",
2026-02-20T22:09:17.3466701Z                  },
2026-02-20T22:09:17.3466816Z                  {
2026-02-20T22:09:17.3467146Z                      "context": "Sur la planète Tatooine",
2026-02-20T22:09:17.3467876Z                      "action": "Anakin trouve {nb1} pièces. Il en perd {nb2} dans le désert",
2026-02-20T22:09:17.3468118Z                      "question": "Combien lui en reste-t-il ?",
2026-02-20T22:09:17.3468320Z                      "calc": lambda nb1, nb2: nb1 - nb2,
2026-02-20T22:09:17.3468977Z -                    "explanation": "Pour trouver ce qui reste, on soustrait ce qui est perdu du total initial. Donc {nb1} - {nb2} = {result}."
2026-02-20T22:09:17.3469630Z +                    "explanation": "Pour trouver ce qui reste, on soustrait ce qui est perdu du total initial. Donc {nb1} - {nb2} = {result}.",
2026-02-20T22:09:17.3469762Z                  },
2026-02-20T22:09:17.3469873Z                  {
2026-02-20T22:09:17.3470093Z                      "context": "Dans l'escadron de X-Wings",
2026-02-20T22:09:17.3470658Z                      "action": "Il y a {nb1} pilotes répartis équitablement dans {nb2} escouades",
2026-02-20T22:09:17.3470906Z                      "question": "Combien de pilotes par escouade ?",
2026-02-20T22:09:17.3471106Z                      "calc": lambda nb1, nb2: nb1 // nb2,
2026-02-20T22:09:17.3472037Z -                    "explanation": "Pour répartir équitablement, on divise le nombre total par le nombre d'escouades. Donc {nb1} ÷ {nb2} = {result}."
2026-02-20T22:09:17.3472169Z -                }
2026-02-20T22:09:17.3472277Z -            ]
2026-02-20T22:09:17.3472386Z -            
2026-02-20T22:09:17.3473527Z +                    "explanation": "Pour répartir équitablement, on divise le nombre total par le nombre d'escouades. Donc {nb1} ÷ {nb2} = {result}.",
2026-02-20T22:09:17.3473653Z +                },
2026-02-20T22:09:17.3473760Z +            ]
2026-02-20T22:09:17.3473868Z +
2026-02-20T22:09:17.3474080Z              scenario = random.choice(scenarios)
2026-02-20T22:09:17.3474256Z              nb1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3474779Z -            nb2 = random.randint(2, min(nb1, 5)) if "divise" in scenario["explanation"] else random.randint(1, min_val)
2026-02-20T22:09:17.3474912Z -            
2026-02-20T22:09:17.3475030Z +            nb2 = (
2026-02-20T22:09:17.3475191Z +                random.randint(2, min(nb1, 5))
2026-02-20T22:09:17.3475379Z +                if "divise" in scenario["explanation"]
2026-02-20T22:09:17.3475539Z +                else random.randint(1, min_val)
2026-02-20T22:09:17.3475643Z +            )
2026-02-20T22:09:17.3475748Z +
2026-02-20T22:09:17.3476102Z              # Ajuster pour éviter les divisions impossibles
2026-02-20T22:09:17.3476555Z              if "÷" in scenario["explanation"] and nb1 % nb2 != 0:
2026-02-20T22:09:17.3476838Z                  nb1 = nb2 * random.randint(2, 5)  # Assurer une division exacte
2026-02-20T22:09:17.3477182Z -            
2026-02-20T22:09:17.3477287Z +
2026-02-20T22:09:17.3477455Z              result = scenario["calc"](nb1, nb2)
2026-02-20T22:09:17.3477567Z -            
2026-02-20T22:09:17.3477665Z +
2026-02-20T22:09:17.3478253Z              problem = f"{scenario['context']}, {scenario['action'].format(nb1=nb1, nb2=nb2, prix=nb2)}. {scenario['question']}"
2026-02-20T22:09:17.3478696Z -            explanation = scenario["explanation"].format(nb1=nb1, nb2=nb2, prix=nb2, result=result)
2026-02-20T22:09:17.3478916Z +            explanation = scenario["explanation"].format(
2026-02-20T22:09:17.3479104Z +                nb1=nb1, nb2=nb2, prix=nb2, result=result
2026-02-20T22:09:17.3479213Z +            )
2026-02-20T22:09:17.3479440Z              answer_type = "number"
2026-02-20T22:09:17.3479548Z -            
2026-02-20T22:09:17.3479650Z +
2026-02-20T22:09:17.3479822Z          elif problem_type == "sequence_simple":
2026-02-20T22:09:17.3480057Z              # Séquence simple
2026-02-20T22:09:17.3480215Z              start = random.randint(1, 5)
2026-02-20T22:09:17.3480360Z              step = random.randint(1, 3)
2026-02-20T22:09:17.3480570Z -            sequence = [start + step*i for i in range(4)]
2026-02-20T22:09:17.3480776Z +            sequence = [start + step * i for i in range(4)]
2026-02-20T22:09:17.3481111Z              result = sequence[-1] + step
2026-02-20T22:09:17.3481241Z -            
2026-02-20T22:09:17.3481345Z +
2026-02-20T22:09:17.3481870Z              problem = f"Quelle est la suite logique : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ... ?"
2026-02-20T22:09:17.3482738Z              explanation = f"Cette séquence augmente de {step} à chaque terme. Le terme suivant est donc {sequence[3]} + {step} = {result}."
2026-02-20T22:09:17.3482890Z              answer_type = "number"
2026-02-20T22:09:17.3483174Z -            
2026-02-20T22:09:17.3483283Z +
2026-02-20T22:09:17.3483405Z          else:
2026-02-20T22:09:17.3483782Z              # Problème par défaut pour les types non implémentés
2026-02-20T22:09:17.3483968Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3484136Z              b = random.randint(min_val, max_val)
2026-02-20T22:09:17.3484266Z              result = a + b
2026-02-20T22:09:17.3484371Z -            
2026-02-20T22:09:17.3484471Z +
2026-02-20T22:09:17.3485068Z              problem = f"Luke a {a} sabres laser. Leia lui en donne {b} de plus. Combien Luke a-t-il de sabres laser maintenant ?"
2026-02-20T22:09:17.3485702Z              explanation = f"Pour trouver le total, on additionne les sabres laser de Luke et ceux de Leia. Donc {a} + {b} = {result}."
2026-02-20T22:09:17.3485845Z              answer_type = "number"
2026-02-20T22:09:17.3485964Z -        
2026-02-20T22:09:17.3486067Z +
2026-02-20T22:09:17.3486311Z          # Créer des choix appropriés
2026-02-20T22:09:17.3486462Z          if answer_type == "number":
2026-02-20T22:09:17.3486583Z              choices = [
2026-02-20T22:09:17.3486710Z                  str(result),
2026-02-20T22:09:17.3486898Z                  str(result + random.randint(1, 3)),
2026-02-20T22:09:17.3487111Z                  str(max(1, result - random.randint(1, 3))),
2026-02-20T22:09:17.3487282Z -                str(result + random.randint(4, 6))
2026-02-20T22:09:17.3487449Z +                str(result + random.randint(4, 6)),
2026-02-20T22:09:17.3487576Z              ]
2026-02-20T22:09:17.3487686Z          else:
2026-02-20T22:09:17.3488000Z              # Pour les réponses textuelles (si nécessaire)
2026-02-20T22:09:17.3488515Z -            choices = [str(result), "Autre réponse 1", "Autre réponse 2", "Autre réponse 3"]
2026-02-20T22:09:17.3488639Z -            
2026-02-20T22:09:17.3488758Z +            choices = [
2026-02-20T22:09:17.3488880Z +                str(result),
2026-02-20T22:09:17.3489099Z +                "Autre réponse 1",
2026-02-20T22:09:17.3489292Z +                "Autre réponse 2",
2026-02-20T22:09:17.3489487Z +                "Autre réponse 3",
2026-02-20T22:09:17.3489602Z +            ]
2026-02-20T22:09:17.3489918Z +
2026-02-20T22:09:17.3490066Z          random.shuffle(choices)
2026-02-20T22:09:17.3490172Z -        
2026-02-20T22:09:17.3490281Z +
2026-02-20T22:09:17.3490413Z          # Construire l'exercice
2026-02-20T22:09:17.3490550Z -        exercise_data.update({
2026-02-20T22:09:17.3490820Z -            "title": "Problème textuel",
2026-02-20T22:09:17.3490961Z -            "question": problem,
2026-02-20T22:09:17.3491113Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3491245Z -            "choices": choices,
2026-02-20T22:09:17.3491438Z -            "tags": Tags.ALGORITHMIC + "," + "texte",
2026-02-20T22:09:17.3491593Z -            "explanation": explanation,
2026-02-20T22:09:17.3491975Z -            "answer_type": answer_type  # Métadonnée pour l'interface
2026-02-20T22:09:17.3492091Z -        })
2026-02-20T22:09:17.3492196Z -        
2026-02-20T22:09:17.3492331Z +        exercise_data.update(
2026-02-20T22:09:17.3492439Z +            {
2026-02-20T22:09:17.3492689Z +                "title": "Problème textuel",
2026-02-20T22:09:17.3492838Z +                "question": problem,
2026-02-20T22:09:17.3493166Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3493314Z +                "choices": choices,
2026-02-20T22:09:17.3493744Z +                "tags": Tags.ALGORITHMIC + "," + "texte",
2026-02-20T22:09:17.3493915Z +                "explanation": explanation,
2026-02-20T22:09:17.3494330Z +                "answer_type": answer_type,  # Métadonnée pour l'interface
2026-02-20T22:09:17.3494442Z +            }
2026-02-20T22:09:17.3494549Z +        )
2026-02-20T22:09:17.3494652Z +
2026-02-20T22:09:17.3494833Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3494938Z  
2026-02-20T22:09:17.3495153Z      elif normalized_type == ExerciseTypes.FRACTIONS:
2026-02-20T22:09:17.3495440Z          # Génération d'un exercice sur les fractions
2026-02-20T22:09:17.3495592Z          from fractions import Fraction
2026-02-20T22:09:17.3495702Z -        
2026-02-20T22:09:17.3496080Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3496193Z +
2026-02-20T22:09:17.3496540Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3496710Z              denominator = random.choice([2, 3, 4])
2026-02-20T22:09:17.3496858Z              numerator = 1
2026-02-20T22:09:17.3497239Z -        elif derived_difficulty == DifficultyLevels.PADAWAN: # Use derived_difficulty
2026-02-20T22:09:17.3497610Z +        elif derived_difficulty == DifficultyLevels.PADAWAN:  # Use derived_difficulty
2026-02-20T22:09:17.3497797Z              denominator = random.choice([2, 3, 4, 5])
2026-02-20T22:09:17.3498008Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3498374Z -        elif derived_difficulty == DifficultyLevels.CHEVALIER: # Use derived_difficulty
2026-02-20T22:09:17.3498768Z +        elif derived_difficulty == DifficultyLevels.CHEVALIER:  # Use derived_difficulty
2026-02-20T22:09:17.3498958Z              denominator = random.choice([4, 5, 6, 8])
2026-02-20T22:09:17.3499167Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3499286Z          else:  # MAITRE
2026-02-20T22:09:17.3499472Z              denominator = random.choice([6, 8, 9, 12])
2026-02-20T22:09:17.3499682Z              numerator = random.randint(1, denominator - 1)
2026-02-20T22:09:17.3499789Z -        
2026-02-20T22:09:17.3499902Z +
2026-02-20T22:09:17.3500626Z          question = f"Quelle fraction représente {numerator} part{'s' if numerator > 1 else ''} sur {denominator} ?"
2026-02-20T22:09:17.3500827Z          correct_answer = f"{numerator}/{denominator}"
2026-02-20T22:09:17.3500942Z -        
2026-02-20T22:09:17.3501047Z +
2026-02-20T22:09:17.3501167Z          choices = [
2026-02-20T22:09:17.3501295Z              correct_answer,
2026-02-20T22:09:17.3501479Z              f"{denominator}/{numerator}",  # Inversion
2026-02-20T22:09:17.3501862Z              f"{numerator}/{denominator + 1}",  # Dénominateur incorrect
2026-02-20T22:09:17.3502430Z -            f"{numerator + 1}/{denominator}"  # Numérateur incorrect
2026-02-20T22:09:17.3502793Z +            f"{numerator + 1}/{denominator}",  # Numérateur incorrect
2026-02-20T22:09:17.3502902Z          ]
2026-02-20T22:09:17.3503231Z          random.shuffle(choices)
2026-02-20T22:09:17.3503347Z -        
2026-02-20T22:09:17.3503505Z -        exercise_data.update({
2026-02-20T22:09:17.3503689Z -            "title": "Exercice sur les fractions",
2026-02-20T22:09:17.3503831Z -            "question": question,
2026-02-20T22:09:17.3504005Z -            "correct_answer": correct_answer,
2026-02-20T22:09:17.3504138Z -            "choices": choices,
2026-02-20T22:09:17.3504350Z -            "tags": Tags.ALGORITHMIC + "," + Tags.FRACTIONS,
2026-02-20T22:09:17.3505442Z -            "explanation": f"Une fraction représente une partie d'un tout. {numerator} part{'s' if numerator > 1 else ''} sur {denominator} s'écrit {correct_answer}."
2026-02-20T22:09:17.3505577Z -        })
2026-02-20T22:09:17.3505688Z +
2026-02-20T22:09:17.3505835Z +        exercise_data.update(
2026-02-20T22:09:17.3505953Z +            {
2026-02-20T22:09:17.3506133Z +                "title": "Exercice sur les fractions",
2026-02-20T22:09:17.3506274Z +                "question": question,
2026-02-20T22:09:17.3506727Z +                "correct_answer": correct_answer,
2026-02-20T22:09:17.3506891Z +                "choices": choices,
2026-02-20T22:09:17.3507116Z +                "tags": Tags.ALGORITHMIC + "," + Tags.FRACTIONS,
2026-02-20T22:09:17.3508231Z +                "explanation": f"Une fraction représente une partie d'un tout. {numerator} part{'s' if numerator > 1 else ''} sur {denominator} s'écrit {correct_answer}.",
2026-02-20T22:09:17.3508356Z +            }
2026-02-20T22:09:17.3508466Z +        )
2026-02-20T22:09:17.3508655Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3508771Z  
2026-02-20T22:09:17.3508995Z      elif normalized_type == ExerciseTypes.GEOMETRIE:
2026-02-20T22:09:17.3509305Z          # Génération d'un exercice de géométrie
2026-02-20T22:09:17.3509441Z          import math
2026-02-20T22:09:17.3509550Z -        
2026-02-20T22:09:17.3509922Z -        if derived_difficulty == DifficultyLevels.INITIE: # Use derived_difficulty
2026-02-20T22:09:17.3510031Z +
2026-02-20T22:09:17.3510423Z +        if derived_difficulty == DifficultyLevels.INITIE:  # Use derived_difficulty
2026-02-20T22:09:17.3510758Z              shape = random.choice(["carré", "rectangle"])
2026-02-20T22:09:17.3510978Z              if shape == "carré":
2026-02-20T22:09:17.3511147Z                  side = random.randint(3, 10)
2026-02-20T22:09:17.3511518Z                  property_type = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3511800Z                  if property_type == "périmètre":
2026-02-20T22:09:17.3511952Z                      result = 4 * side
2026-02-20T22:09:17.3512470Z -                    question = f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3512638Z +                    question = (
2026-02-20T22:09:17.3513329Z +                        f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3513478Z +                    )
2026-02-20T22:09:17.3514044Z                      explanation = f"Le périmètre d'un carré = 4 × côté = 4 × {side} = {result} cm."
2026-02-20T22:09:17.3514155Z                  else:
2026-02-20T22:09:17.3514296Z                      result = side * side
2026-02-20T22:09:17.3514717Z                      question = f"Un carré a un côté de {side} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3515230Z                      explanation = f"L'aire d'un carré = côté × côté = {side} × {side} = {result} cm²."
2026-02-20T22:09:17.3515367Z @@ -1232,16 +1485,18 @@
2026-02-20T22:09:17.3515928Z                      question = f"Un rectangle mesure {length} cm de longueur et {width} cm de largeur. Quelle est son aire ?"
2026-02-20T22:09:17.3516584Z                      explanation = f"L'aire d'un rectangle = longueur × largeur = {length} × {width} = {result} cm²."
2026-02-20T22:09:17.3516955Z          else:
2026-02-20T22:09:17.3517346Z              shape = random.choice(["carré", "rectangle", "triangle", "cercle"])
2026-02-20T22:09:17.3517661Z              property_type = random.choice(["périmètre", "aire"])
2026-02-20T22:09:17.3517959Z -            
2026-02-20T22:09:17.3518070Z +
2026-02-20T22:09:17.3518282Z              if shape == "carré":
2026-02-20T22:09:17.3518435Z                  side = random.randint(5, 15)
2026-02-20T22:09:17.3518691Z                  if property_type == "périmètre":
2026-02-20T22:09:17.3518826Z                      result = 4 * side
2026-02-20T22:09:17.3519303Z -                    question = f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3519432Z +                    question = (
2026-02-20T22:09:17.3519822Z +                        f"Un carré a un côté de {side} cm. Quel est son périmètre ?"
2026-02-20T22:09:17.3519933Z +                    )
2026-02-20T22:09:17.3520463Z                      explanation = f"Le périmètre d'un carré = 4 × côté = 4 × {side} = {result} cm."
2026-02-20T22:09:17.3520588Z                  else:
2026-02-20T22:09:17.3520725Z                      result = side * side
2026-02-20T22:09:17.3521181Z                      question = f"Un carré a un côté de {side} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3521630Z                      explanation = f"L'aire d'un carré = côté² = {side}² = {result} cm²."
2026-02-20T22:09:17.3521748Z @@ -1262,11 +1517,11 @@
2026-02-20T22:09:17.3521900Z                  if property_type == "aire":
2026-02-20T22:09:17.3522064Z                      result = (base * height) / 2
2026-02-20T22:09:17.3522560Z                      question = f"Un triangle a une base de {base} cm et une hauteur de {height} cm. Quelle est son aire ?"
2026-02-20T22:09:17.3523418Z                      explanation = f"L'aire d'un triangle = (base × hauteur) ÷ 2 = ({base} × {height}) ÷ 2 = {result} cm²."
2026-02-20T22:09:17.3523554Z                  else:
2026-02-20T22:09:17.3523825Z -                    hypotenuse = round(math.sqrt(base*base + height*height), 1)
2026-02-20T22:09:17.3524103Z +                    hypotenuse = round(math.sqrt(base * base + height * height), 1)
2026-02-20T22:09:17.3524313Z                      result = round(base + height + hypotenuse, 1)
2026-02-20T22:09:17.3525156Z                      question = f"Un triangle rectangle a une base de {base} cm et une hauteur de {height} cm. Quel est son périmètre approximatif ?"
2026-02-20T22:09:17.3525856Z                      explanation = f"Le périmètre ≈ base + hauteur + hypoténuse ≈ {base} + {height} + {hypotenuse} ≈ {result} cm."
2026-02-20T22:09:17.3525994Z              else:  # cercle
2026-02-20T22:09:17.3526166Z                  radius = random.randint(3, 10)
2026-02-20T22:09:17.3526292Z @@ -1276,34 +1531,36 @@
2026-02-20T22:09:17.3526906Z                      explanation = f"Le périmètre d'un cercle = 2 × π × rayon = 2 × 3.14 × {radius} ≈ {result} cm."
2026-02-20T22:09:17.3527050Z                  else:
2026-02-20T22:09:17.3527262Z                      result = round(math.pi * radius * radius, 2)
2026-02-20T22:09:17.3527850Z                      question = f"Un cercle a un rayon de {radius} cm. Quelle est son aire ? (Utilise π ≈ 3.14)"
2026-02-20T22:09:17.3528414Z                      explanation = f"L'aire d'un cercle = π × rayon² = 3.14 × {radius}² ≈ {result} cm²."
2026-02-20T22:09:17.3528524Z -        
2026-02-20T22:09:17.3528628Z +
2026-02-20T22:09:17.3528746Z          choices = [
2026-02-20T22:09:17.3528868Z              str(result),
2026-02-20T22:09:17.3528988Z              str(round(result * 0.5, 2)),
2026-02-20T22:09:17.3529126Z              str(round(result * 2, 2)),
2026-02-20T22:09:17.3529279Z -            str(round(result * 1.5, 2))
2026-02-20T22:09:17.3529416Z +            str(round(result * 1.5, 2)),
2026-02-20T22:09:17.3529527Z          ]
2026-02-20T22:09:17.3529671Z          random.shuffle(choices)
2026-02-20T22:09:17.3529779Z -        
2026-02-20T22:09:17.3530150Z -        exercise_data.update({
2026-02-20T22:09:17.3530423Z -            "title": "Exercice de géométrie",
2026-02-20T22:09:17.3530566Z -            "question": question,
2026-02-20T22:09:17.3530712Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3531000Z -            "choices": choices,
2026-02-20T22:09:17.3531218Z -            "tags": Tags.ALGORITHMIC + "," + Tags.GEOMETRY,
2026-02-20T22:09:17.3531361Z -            "explanation": explanation
2026-02-20T22:09:17.3531459Z -        })
2026-02-20T22:09:17.3531556Z +
2026-02-20T22:09:17.3531693Z +        exercise_data.update(
2026-02-20T22:09:17.3531796Z +            {
2026-02-20T22:09:17.3532052Z +                "title": "Exercice de géométrie",
2026-02-20T22:09:17.3532192Z +                "question": question,
2026-02-20T22:09:17.3532345Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3532467Z +                "choices": choices,
2026-02-20T22:09:17.3532661Z +                "tags": Tags.ALGORITHMIC + "," + Tags.GEOMETRY,
2026-02-20T22:09:17.3532818Z +                "explanation": explanation,
2026-02-20T22:09:17.3532919Z +            }
2026-02-20T22:09:17.3533210Z +        )
2026-02-20T22:09:17.3533391Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3533593Z      elif normalized_type == ExerciseTypes.MIXTE:
2026-02-20T22:09:17.3534049Z          # Génération d'un exercice mixte avec PLUSIEURS opérations combinées
2026-02-20T22:09:17.3534215Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3534376Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3534599Z          num_operations = type_limits.get("operations", 2)
2026-02-20T22:09:17.3534708Z -        
2026-02-20T22:09:17.3534821Z +
2026-02-20T22:09:17.3535129Z          # Choisir un pattern de calcul mixte selon la difficulté
2026-02-20T22:09:17.3535353Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3535786Z              # Pour les débutants: 2 opérations simples sans priorité complexe
2026-02-20T22:09:17.3535936Z              patterns = [
2026-02-20T22:09:17.3536225Z                  ("add_sub", lambda a, b, c: a + b - c, "{a} + {b} - {c}"),
2026-02-20T22:09:17.3536361Z @@ -1324,18 +1581,20 @@
2026-02-20T22:09:17.3536805Z                  ("paren_add_mult", lambda a, b, c: (a + b) * c, "({a} + {b}) × {c}"),
2026-02-20T22:09:17.3537224Z                  ("paren_sub_mult", lambda a, b, c: (a - b) * c, "({a} - {b}) × {c}"),
2026-02-20T22:09:17.3537641Z                  ("mult_paren_add", lambda a, b, c: a * (b + c), "{a} × ({b} + {c})"),
2026-02-20T22:09:17.3538039Z                  ("div_paren", lambda a, b, c: (a * b) // c, "({a} × {b}) ÷ {c}"),
2026-02-20T22:09:17.3538151Z              ]
2026-02-20T22:09:17.3538259Z -        
2026-02-20T22:09:17.3538368Z +
2026-02-20T22:09:17.3538657Z          pattern_name, calc_func, template = random.choice(patterns)
2026-02-20T22:09:17.3538765Z -        
2026-02-20T22:09:17.3538879Z +
2026-02-20T22:09:17.3539125Z          # Générer des nombres appropriés
2026-02-20T22:09:17.3539308Z          a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3539870Z -        b = random.randint(2, min(max_val, 10))  # Garder b petit pour éviter les grands résultats
2026-02-20T22:09:17.3540015Z +        b = random.randint(
2026-02-20T22:09:17.3540162Z +            2, min(max_val, 10)
2026-02-20T22:09:17.3540488Z +        )  # Garder b petit pour éviter les grands résultats
2026-02-20T22:09:17.3540673Z          c = random.randint(2, min(max_val, 10))
2026-02-20T22:09:17.3540781Z -        
2026-02-20T22:09:17.3540882Z +
2026-02-20T22:09:17.3541384Z          # Ajustements pour éviter les résultats négatifs ou les divisions impossibles
2026-02-20T22:09:17.3541638Z          if "sub" in pattern_name and "paren" not in pattern_name:
2026-02-20T22:09:17.3541818Z              # Pour a - b * c, s'assurer que a > b * c
2026-02-20T22:09:17.3541942Z              if a <= b * c:
2026-02-20T22:09:17.3542112Z                  a = b * c + random.randint(1, 10)
2026-02-20T22:09:17.3542454Z @@ -1348,62 +1607,73 @@
2026-02-20T22:09:17.3542762Z                      c = random.choice([d for d in range(2, 6) if temp % d == 0] or [1])
2026-02-20T22:09:17.3542885Z              else:
2026-02-20T22:09:17.3543309Z                  # a ÷ b doit être exact
2026-02-20T22:09:17.3543633Z                  if a % b != 0:
2026-02-20T22:09:17.3543808Z                      a = b * random.randint(2, 5)
2026-02-20T22:09:17.3543922Z -        
2026-02-20T22:09:17.3544021Z +
2026-02-20T22:09:17.3544165Z          result = calc_func(a, b, c)
2026-02-20T22:09:17.3544444Z          question = f"Calcule : {template.format(a=a, b=b, c=c)} = ?"
2026-02-20T22:09:17.3544551Z -        
2026-02-20T22:09:17.3544656Z +
2026-02-20T22:09:17.3544882Z          # Explication détaillée
2026-02-20T22:09:17.3545026Z          if "paren" in pattern_name:
2026-02-20T22:09:17.3545743Z              explanation = f"Avec les parenthèses, on calcule d'abord l'intérieur, puis le reste. Résultat : {result}."
2026-02-20T22:09:17.3545872Z          else:
2026-02-20T22:09:17.3546902Z              explanation = f"Attention à la priorité des opérations ! La multiplication/division se fait avant l'addition/soustraction. Résultat : {result}."
2026-02-20T22:09:17.3547014Z -        
2026-02-20T22:09:17.3547119Z +
2026-02-20T22:09:17.3547259Z          choices = [
2026-02-20T22:09:17.3547386Z              str(result),
2026-02-20T22:09:17.3547552Z              str(result + random.randint(1, 5)),
2026-02-20T22:09:17.3547744Z              str(max(1, result - random.randint(1, 5))),
2026-02-20T22:09:17.3547967Z -            str(a + b + c)  # Erreur courante: additionner tout
2026-02-20T22:09:17.3548190Z +            str(a + b + c),  # Erreur courante: additionner tout
2026-02-20T22:09:17.3548297Z          ]
2026-02-20T22:09:17.3548542Z          choices = list(set(choices))  # Supprimer les doublons
2026-02-20T22:09:17.3548680Z          while len(choices) < 4:
2026-02-20T22:09:17.3548924Z              choices.append(str(result + random.randint(-10, 10)))
2026-02-20T22:09:17.3549093Z          choices = list(set(choices))[:4]
2026-02-20T22:09:17.3549232Z          random.shuffle(choices)
2026-02-20T22:09:17.3549336Z -        
2026-02-20T22:09:17.3549475Z -        exercise_data.update({
2026-02-20T22:09:17.3549629Z -            "title": "Exercice mixte",
2026-02-20T22:09:17.3549768Z -            "question": question,
2026-02-20T22:09:17.3549918Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3550052Z -            "choices": choices,
2026-02-20T22:09:17.3550265Z -            "tags": Tags.ALGORITHMIC + "," + Tags.ADVANCED,
2026-02-20T22:09:17.3550417Z -            "explanation": explanation
2026-02-20T22:09:17.3550530Z -        })
2026-02-20T22:09:17.3550631Z +
2026-02-20T22:09:17.3550764Z +        exercise_data.update(
2026-02-20T22:09:17.3550869Z +            {
2026-02-20T22:09:17.3551021Z +                "title": "Exercice mixte",
2026-02-20T22:09:17.3551159Z +                "question": question,
2026-02-20T22:09:17.3551318Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3551458Z +                "choices": choices,
2026-02-20T22:09:17.3551663Z +                "tags": Tags.ALGORITHMIC + "," + Tags.ADVANCED,
2026-02-20T22:09:17.3551814Z +                "explanation": explanation,
2026-02-20T22:09:17.3551919Z +            }
2026-02-20T22:09:17.3552038Z +        )
2026-02-20T22:09:17.3552211Z          return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3552311Z  
2026-02-20T22:09:17.3552511Z      elif normalized_type == ExerciseTypes.DIVERS:
2026-02-20T22:09:17.3553188Z          # Génération d'un exercice divers (logique, conversions, probabilités, etc.)
2026-02-20T22:09:17.3553645Z          # Différent de TEXTE qui est orienté problèmes concrets avec contexte
2026-02-20T22:09:17.3553810Z          min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3553967Z          max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3554363Z -        problem_types = ["sequence", "conversion", "comparaison", "pourcentage", "moyenne"]
2026-02-20T22:09:17.3554695Z -        
2026-02-20T22:09:17.3554847Z +        problem_types = [
2026-02-20T22:09:17.3554972Z +            "sequence",
2026-02-20T22:09:17.3555091Z +            "conversion",
2026-02-20T22:09:17.3555219Z +            "comparaison",
2026-02-20T22:09:17.3555507Z +            "pourcentage",
2026-02-20T22:09:17.3555633Z +            "moyenne",
2026-02-20T22:09:17.3555736Z +        ]
2026-02-20T22:09:17.3555849Z +
2026-02-20T22:09:17.3556079Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3556346Z              problem_type = random.choice(["sequence", "comparaison"])
2026-02-20T22:09:17.3556609Z          elif derived_difficulty == DifficultyLevels.PADAWAN:
2026-02-20T22:09:17.3556943Z              problem_type = random.choice(["sequence", "conversion", "comparaison"])
2026-02-20T22:09:17.3557056Z          else:
2026-02-20T22:09:17.3557269Z              problem_type = random.choice(problem_types)
2026-02-20T22:09:17.3557374Z -        
2026-02-20T22:09:17.3557500Z +
2026-02-20T22:09:17.3557647Z          if problem_type == "sequence":
2026-02-20T22:09:17.3558002Z              # Séquence logique (plus variée selon difficulté)
2026-02-20T22:09:17.3558404Z -            if derived_difficulty in [DifficultyLevels.INITIE, DifficultyLevels.PADAWAN]:
2026-02-20T22:09:17.3558560Z +            if derived_difficulty in [
2026-02-20T22:09:17.3558728Z +                DifficultyLevels.INITIE,
2026-02-20T22:09:17.3558891Z +                DifficultyLevels.PADAWAN,
2026-02-20T22:09:17.3558998Z +            ]:
2026-02-20T22:09:17.3559159Z                  start = random.randint(1, 10)
2026-02-20T22:09:17.3559320Z                  step = random.randint(1, 5)
2026-02-20T22:09:17.3559524Z -                sequence = [start + step*i for i in range(4)]
2026-02-20T22:09:17.3559732Z +                sequence = [start + step * i for i in range(4)]
2026-02-20T22:09:17.3559886Z                  result = sequence[-1] + step
2026-02-20T22:09:17.3560401Z                  question = f"Trouve le nombre suivant : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ?"
2026-02-20T22:09:17.3561234Z                  explanation = f"C'est une suite arithmétique où on ajoute {step} à chaque fois. Donc {sequence[3]} + {step} = {result}."
2026-02-20T22:09:17.3561358Z              else:
2026-02-20T22:09:17.3561582Z                  # Séquence géométrique
2026-02-20T22:09:17.3561706Z @@ -1411,218 +1681,282 @@
2026-02-20T22:09:17.3561869Z                  factor = random.randint(2, 3)
2026-02-20T22:09:17.3562089Z                  sequence = [start * (factor**i) for i in range(4)]
2026-02-20T22:09:17.3562242Z                  result = sequence[-1] * factor
2026-02-20T22:09:17.3562744Z                  question = f"Trouve le nombre suivant : {sequence[0]}, {sequence[1]}, {sequence[2]}, {sequence[3]}, ?"
2026-02-20T22:09:17.3563770Z                  explanation = f"C'est une suite géométrique où on multiplie par {factor} à chaque fois. Donc {sequence[3]} × {factor} = {result}."
2026-02-20T22:09:17.3563891Z -                
2026-02-20T22:09:17.3563987Z +
2026-02-20T22:09:17.3564141Z          elif problem_type == "conversion":
2026-02-20T22:09:17.3564353Z              # Conversion d'unités
2026-02-20T22:09:17.3564485Z              conversions = [
2026-02-20T22:09:17.3565135Z -                (60, "minutes", "heure", "Combien y a-t-il de minutes dans {n} heure(s) ?", "{n} × 60 = {r} minutes"),
2026-02-20T22:09:17.3565893Z -                (100, "centimètres", "mètre", "Combien y a-t-il de centimètres dans {n} mètre(s) ?", "{n} × 100 = {r} centimètres"),
2026-02-20T22:09:17.3566645Z -                (1000, "grammes", "kilogramme", "Combien y a-t-il de grammes dans {n} kilogramme(s) ?", "{n} × 1000 = {r} grammes"),
2026-02-20T22:09:17.3567237Z -                (24, "heures", "jour", "Combien y a-t-il d'heures dans {n} jour(s) ?", "{n} × 24 = {r} heures"),
2026-02-20T22:09:17.3567345Z -            ]
2026-02-20T22:09:17.3567751Z -            factor, unit_small, unit_big, q_template, exp_template = random.choice(conversions)
2026-02-20T22:09:17.3568083Z +                (
2026-02-20T22:09:17.3568207Z +                    60,
2026-02-20T22:09:17.3568326Z +                    "minutes",
2026-02-20T22:09:17.3568442Z +                    "heure",
2026-02-20T22:09:17.3568844Z +                    "Combien y a-t-il de minutes dans {n} heure(s) ?",
2026-02-20T22:09:17.3569091Z +                    "{n} × 60 = {r} minutes",
2026-02-20T22:09:17.3569200Z +                ),
2026-02-20T22:09:17.3569313Z +                (
2026-02-20T22:09:17.3569421Z +                    100,
2026-02-20T22:09:17.3569624Z +                    "centimètres",
2026-02-20T22:09:17.3569799Z +                    "mètre",
2026-02-20T22:09:17.3570173Z +                    "Combien y a-t-il de centimètres dans {n} mètre(s) ?",
2026-02-20T22:09:17.3570413Z +                    "{n} × 100 = {r} centimètres",
2026-02-20T22:09:17.3570519Z +                ),
2026-02-20T22:09:17.3570631Z +                (
2026-02-20T22:09:17.3570756Z +                    1000,
2026-02-20T22:09:17.3570874Z +                    "grammes",
2026-02-20T22:09:17.3570996Z +                    "kilogramme",
2026-02-20T22:09:17.3571261Z +                    "Combien y a-t-il de grammes dans {n} kilogramme(s) ?",
2026-02-20T22:09:17.3571500Z +                    "{n} × 1000 = {r} grammes",
2026-02-20T22:09:17.3571604Z +                ),
2026-02-20T22:09:17.3571714Z +                (
2026-02-20T22:09:17.3571824Z +                    24,
2026-02-20T22:09:17.3571942Z +                    "heures",
2026-02-20T22:09:17.3572074Z +                    "jour",
2026-02-20T22:09:17.3572291Z +                    "Combien y a-t-il d'heures dans {n} jour(s) ?",
2026-02-20T22:09:17.3572506Z +                    "{n} × 24 = {r} heures",
2026-02-20T22:09:17.3572611Z +                ),
2026-02-20T22:09:17.3572722Z +            ]
2026-02-20T22:09:17.3573244Z +            factor, unit_small, unit_big, q_template, exp_template = random.choice(
2026-02-20T22:09:17.3573376Z +                conversions
2026-02-20T22:09:17.3573505Z +            )
2026-02-20T22:09:17.3573646Z              n = random.randint(1, 5)
2026-02-20T22:09:17.3573776Z              result = n * factor
2026-02-20T22:09:17.3573936Z              question = q_template.format(n=n)
2026-02-20T22:09:17.3574266Z              explanation = exp_template.format(n=n, r=result)
2026-02-20T22:09:17.3574421Z -            
2026-02-20T22:09:17.3574575Z +
2026-02-20T22:09:17.3574883Z          elif problem_type == "comparaison":
2026-02-20T22:09:17.3575070Z              # Comparaison de nombres
2026-02-20T22:09:17.3575534Z              a = random.randint(min_val, max_val)
2026-02-20T22:09:17.3590969Z              b = random.randint(min_val, max_val)
2026-02-20T22:09:17.3591135Z              if a == b:
2026-02-20T22:09:17.3591308Z                  b = a + random.choice([-1, 1])
2026-02-20T22:09:17.3591442Z              result = max(a, b)
2026-02-20T22:09:17.3591717Z              question = f"Quel est le plus grand nombre : {a} ou {b} ?"
2026-02-20T22:09:17.3592060Z              explanation = f"En comparant {a} et {b}, le plus grand est {result}."
2026-02-20T22:09:17.3592169Z -            
2026-02-20T22:09:17.3592275Z +
2026-02-20T22:09:17.3592453Z          elif problem_type == "pourcentage":
2026-02-20T22:09:17.3592597Z              # Pourcentage simple
2026-02-20T22:09:17.3592780Z              base = random.choice([10, 20, 50, 100])
2026-02-20T22:09:17.3592949Z              pct = random.choice([10, 20, 25, 50])
2026-02-20T22:09:17.3593305Z              result = base * pct // 100
2026-02-20T22:09:17.3593514Z              question = f"Combien font {pct}% de {base} ?"
2026-02-20T22:09:17.3594138Z              explanation = f"Pour calculer {pct}% de {base}, on fait {base} × {pct} ÷ 100 = {result}."
2026-02-20T22:09:17.3594261Z -            
2026-02-20T22:09:17.3594362Z +
2026-02-20T22:09:17.3594491Z          else:  # moyenne
2026-02-20T22:09:17.3594629Z              # Calcul de moyenne
2026-02-20T22:09:17.3594782Z              count = random.randint(3, 5)
2026-02-20T22:09:17.3595361Z              numbers = [random.randint(min_val, max_val) for _ in range(count)]
2026-02-20T22:09:17.3595499Z              total = sum(numbers)
2026-02-20T22:09:17.3595647Z              result = total // count
2026-02-20T22:09:17.3596005Z              numbers_str = ", ".join(map(str, numbers))
2026-02-20T22:09:17.3596329Z              question = f"Quelle est la moyenne de ces nombres : {numbers_str} ?"
2026-02-20T22:09:17.3596929Z              explanation = f"La moyenne = somme ÷ nombre de valeurs = ({total}) ÷ {count} = {result}."
2026-02-20T22:09:17.3597044Z -        
2026-02-20T22:09:17.3597150Z +
2026-02-20T22:09:17.3597373Z          # Générer les choix
2026-02-20T22:09:17.3597510Z          choices = [str(result)]
2026-02-20T22:09:17.3597642Z          while len(choices) < 4:
2026-02-20T22:09:17.3597822Z              wrong = result + random.randint(-5, 10)
2026-02-20T22:09:17.3598023Z              if wrong > 0 and str(wrong) not in choices:
2026-02-20T22:09:17.3598185Z                  choices.append(str(wrong))
2026-02-20T22:09:17.3598323Z          random.shuffle(choices)
2026-02-20T22:09:17.3598438Z -        
2026-02-20T22:09:17.3598575Z -        exercise_data.update({
2026-02-20T22:09:17.3598721Z -            "title": "Exercice divers",
2026-02-20T22:09:17.3598868Z -            "question": question,
2026-02-20T22:09:17.3599025Z -            "correct_answer": str(result),
2026-02-20T22:09:17.3599152Z -            "choices": choices,
2026-02-20T22:09:17.3599345Z -            "tags": Tags.ALGORITHMIC + "," + Tags.LOGIC,
2026-02-20T22:09:17.3599505Z -            "explanation": explanation
2026-02-20T22:09:17.3599615Z -        })
2026-02-20T22:09:17.3599721Z +
2026-02-20T22:09:17.3599865Z +        exercise_data.update(
2026-02-20T22:09:17.3599975Z +            {
2026-02-20T22:09:17.3600122Z +                "title": "Exercice divers",
2026-02-20T22:09:17.3600259Z +                "question": question,
2026-02-20T22:09:17.3600426Z +                "correct_answer": str(result),
2026-02-20T22:09:17.3600563Z +                "choices": choices,
2026-02-20T22:09:17.3600762Z +                "tags": Tags.ALGORITHMIC + "," + Tags.LOGIC,
2026-02-20T22:09:17.3600924Z +                "explanation": explanation,
2026-02-20T22:09:17.3601035Z +            }
2026-02-20T22:09:17.3601141Z +        )
2026-02-20T22:09:17.3601283Z          return exercise_data
2026-02-20T22:09:17.3601780Z      # Si aucun type correspondant, retourner un exercice d'addition par défaut
2026-02-20T22:09:17.3602671Z -    logger.info(f"⚠️ Type d'exercice non géré dans generate_simple_exercise: {normalized_type}, utilisation de ADDITION par défaut")
2026-02-20T22:09:17.3602794Z +    logger.info(
2026-02-20T22:09:17.3603767Z +        f"⚠️ Type d'exercice non géré dans generate_simple_exercise: {normalized_type}, utilisation de ADDITION par défaut"
2026-02-20T22:09:17.3603879Z +    )
2026-02-20T22:09:17.3604034Z      min_val = type_limits.get("min", 1)
2026-02-20T22:09:17.3604188Z      max_val = type_limits.get("max", 10)
2026-02-20T22:09:17.3604363Z      num1 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3604520Z      num2 = random.randint(min_val, max_val)
2026-02-20T22:09:17.3604651Z      result = num1 + num2
2026-02-20T22:09:17.3604765Z -    
2026-02-20T22:09:17.3604905Z -    exercise_data.update({
2026-02-20T22:09:17.3605723Z -        "title": ExerciseMessages.TITLE_DEFAULT if hasattr(ExerciseMessages, 'TITLE_DEFAULT') else "Exercice par défaut",
2026-02-20T22:09:17.3606119Z -        "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3606262Z -        "correct_answer": str(result),
2026-02-20T22:09:17.3606567Z -        "choices": [str(result), str(result-1), str(result+1), str(result+2)],
2026-02-20T22:09:17.3606694Z -        "num1": num1,
2026-02-20T22:09:17.3606807Z -        "num2": num2,
2026-02-20T22:09:17.3607374Z -        "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}."
2026-02-20T22:09:17.3607688Z -    })
2026-02-20T22:09:17.3607804Z -    
2026-02-20T22:09:17.3607901Z +
2026-02-20T22:09:17.3608036Z +    exercise_data.update(
2026-02-20T22:09:17.3608147Z +        {
2026-02-20T22:09:17.3608259Z +            "title": (
2026-02-20T22:09:17.3608427Z +                ExerciseMessages.TITLE_DEFAULT
2026-02-20T22:09:17.3608816Z +                if hasattr(ExerciseMessages, "TITLE_DEFAULT")
2026-02-20T22:09:17.3609096Z +                else "Exercice par défaut"
2026-02-20T22:09:17.3609209Z +            ),
2026-02-20T22:09:17.3609605Z +            "question": ExerciseMessages.QUESTION_ADDITION.format(num1=num1, num2=num2),
2026-02-20T22:09:17.3609765Z +            "correct_answer": str(result),
2026-02-20T22:09:17.3610101Z +            "choices": [str(result), str(result - 1), str(result + 1), str(result + 2)],
2026-02-20T22:09:17.3610226Z +            "num1": num1,
2026-02-20T22:09:17.3610354Z +            "num2": num2,
2026-02-20T22:09:17.3610926Z +            "explanation": f"Pour additionner {num1} et {num2}, il faut calculer leur somme, donc {num1} + {num2} = {result}.",
2026-02-20T22:09:17.3611045Z +        }
2026-02-20T22:09:17.3611152Z +    )
2026-02-20T22:09:17.3611267Z +
2026-02-20T22:09:17.3611439Z      return _apply_test_title(exercise_data)
2026-02-20T22:09:17.3611544Z +
2026-02-20T22:09:17.3611654Z  
2026-02-20T22:09:17.3612052Z  def generate_contextual_question(operation_type, num1, num2, result, age_group):
2026-02-20T22:09:17.3612624Z      """Génère une question contextualisée selon le type d'opération et le groupe d'âge"""
2026-02-20T22:09:17.3613214Z      contexts = StarWarsNarratives.CONTEXTS_BY_TYPE.get(operation_type.upper(), {})
2026-02-20T22:09:17.3613465Z -    
2026-02-20T22:09:17.3613574Z +
2026-02-20T22:09:17.3613701Z      if not contexts:
2026-02-20T22:09:17.3613875Z          # Fallback vers les questions de base
2026-02-20T22:09:17.3614050Z          if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3614202Z              return f"Calcule {num1} + {num2}"
2026-02-20T22:09:17.3614426Z          elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3614581Z              return f"Calcule {num1} - {num2}"
2026-02-20T22:09:17.3614799Z          elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3615060Z              return f"Calcule {num1} × {num2}"
2026-02-20T22:09:17.3615253Z          elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3615493Z              return f"Calcule {num1} ÷ {num2}"
2026-02-20T22:09:17.3615600Z -    
2026-02-20T22:09:17.3615715Z +
2026-02-20T22:09:17.3616005Z      objects = contexts.get("objects", ["éléments"])
2026-02-20T22:09:17.3616215Z      actions = contexts.get("actions", ["se combinent"])
2026-02-20T22:09:17.3616477Z      locations = contexts.get("locations", ["dans la galaxie"])
2026-02-20T22:09:17.3616587Z -    
2026-02-20T22:09:17.3616691Z +
2026-02-20T22:09:17.3616835Z      obj = random.choice(objects)
2026-02-20T22:09:17.3616990Z      action = random.choice(actions)
2026-02-20T22:09:17.3617148Z      location = random.choice(locations)
2026-02-20T22:09:17.3617265Z -    
2026-02-20T22:09:17.3617374Z +
2026-02-20T22:09:17.3617657Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.3617762Z  
2026-02-20T22:09:17.3618105Z      # Templates selon la difficulté dérivée et l'opération
2026-02-20T22:09:17.3618293Z      if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3618517Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3618650Z              templates = [
2026-02-20T22:09:17.3619161Z                  f"Dans {location}, tu trouves {num1} {obj} et ton ami en trouve {num2}. Combien en avez-vous ensemble?",
2026-02-20T22:09:17.3619498Z                  f"R2-D2 compte {num1} {obj} et C-3PO en compte {num2}. Quel est le total?",
2026-02-20T22:09:17.3619795Z -                f"Luke a {num1} {obj} et Leia en a {num2}. Combien ont-ils au total?"
2026-02-20T22:09:17.3620102Z +                f"Luke a {num1} {obj} et Leia en a {num2}. Combien ont-ils au total?",
2026-02-20T22:09:17.3620436Z              ]
2026-02-20T22:09:17.3620547Z          else:
2026-02-20T22:09:17.3620669Z              templates = [
2026-02-20T22:09:17.3621061Z                  f"Dans {location}, {num1} {obj} {action} avec {num2} autres. Quel est le total?",
2026-02-20T22:09:17.3621826Z                  f"L'Alliance déploie {num1} {obj} qui {action} avec {num2} renforts. Combien au total?",
2026-02-20T22:09:17.3622167Z -                f"Sur {location}, {num1} {obj} {action} et {num2} autres arrivent. Total?"
2026-02-20T22:09:17.3622292Z -            ]
2026-02-20T22:09:17.3622398Z -    
2026-02-20T22:09:17.3622727Z +                f"Sur {location}, {num1} {obj} {action} et {num2} autres arrivent. Total?",
2026-02-20T22:09:17.3622840Z +            ]
2026-02-20T22:09:17.3622933Z +
2026-02-20T22:09:17.3623334Z      elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3623576Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3623708Z              templates = [
2026-02-20T22:09:17.3624028Z                  f"Tu avais {num1} {obj}, mais {num2} {action}. Combien te reste-t-il?",
2026-02-20T22:09:17.3624410Z                  f"Dans {location}, il y avait {num1} {obj}, mais {num2} {action}. Combien restent?",
2026-02-20T22:09:17.3624968Z -                f"Yoda possédait {num1} {obj}, mais {num2} {action}. Combien lui reste-t-il?"
2026-02-20T22:09:17.3625444Z +                f"Yoda possédait {num1} {obj}, mais {num2} {action}. Combien lui reste-t-il?",
2026-02-20T22:09:17.3625549Z              ]
2026-02-20T22:09:17.3625661Z          else:
2026-02-20T22:09:17.3625780Z              templates = [
2026-02-20T22:09:17.3626173Z                  f"L'Empire avait {num1} {obj}, mais {num2} {action} lors de {location}. Combien restent?",
2026-02-20T22:09:17.3626669Z                  f"Dans {location}, {num1} {obj} étaient présents, mais {num2} {action}. Reste?",
2026-02-20T22:09:17.3627082Z -                f"La flotte comptait {num1} {obj}, mais {num2} {action} pendant {location}. Combien survivent?"
2026-02-20T22:09:17.3627203Z -            ]
2026-02-20T22:09:17.3627309Z -    
2026-02-20T22:09:17.3627733Z +                f"La flotte comptait {num1} {obj}, mais {num2} {action} pendant {location}. Combien survivent?",
2026-02-20T22:09:17.3627842Z +            ]
2026-02-20T22:09:17.3627961Z +
2026-02-20T22:09:17.3628183Z      elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3628405Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3628523Z              templates = [
2026-02-20T22:09:17.3628878Z                  f"Chaque Padawan a {num2} {obj}. S'il y a {num1} Padawans, combien de {obj} au total?",
2026-02-20T22:09:17.3629207Z                  f"Dans chaque {location}, il y a {num2} {obj}. Combien dans {num1} {location}?",
2026-02-20T22:09:17.3629687Z -                f"Chaque droïde transporte {num2} {obj}. Combien pour {num1} droïdes?"
2026-02-20T22:09:17.3630157Z +                f"Chaque droïde transporte {num2} {obj}. Combien pour {num1} droïdes?",
2026-02-20T22:09:17.3630278Z              ]
2026-02-20T22:09:17.3630392Z          else:
2026-02-20T22:09:17.3630516Z              templates = [
2026-02-20T22:09:17.3631027Z                  f"Chaque {location} déploie {num2} {obj}. Combien pour {num1} {location}?",
2026-02-20T22:09:17.3631528Z                  f"Dans {location}, chaque unité a {num2} {obj}. Total pour {num1} unités?",
2026-02-20T22:09:17.3631926Z -                f"L'Empire organise {num1} {location} avec {num2} {obj} chacun. Combien au total?"
2026-02-20T22:09:17.3632053Z -            ]
2026-02-20T22:09:17.3632159Z -    
2026-02-20T22:09:17.3632559Z +                f"L'Empire organise {num1} {location} avec {num2} {obj} chacun. Combien au total?",
2026-02-20T22:09:17.3632680Z +            ]
2026-02-20T22:09:17.3632788Z +
2026-02-20T22:09:17.3633221Z      elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3633467Z          if derived_difficulty == DifficultyLevels.INITIE:
2026-02-20T22:09:17.3633857Z              templates = [
2026-02-20T22:09:17.3634409Z                  f"Tu as {num1} {obj} à distribuer entre {num2} Padawans. Combien chacun en aura?",
2026-02-20T22:09:17.3634905Z                  f"Il faut répartir {num1} {obj} dans {num2} {location}. Combien par {location}?",
2026-02-20T22:09:17.3635585Z -                f"Yoda doit partager {num1} {obj} entre {num2} élèves. Combien chacun?"
2026-02-20T22:09:17.3636048Z +                f"Yoda doit partager {num1} {obj} entre {num2} élèves. Combien chacun?",
2026-02-20T22:09:17.3636162Z              ]
2026-02-20T22:09:17.3636281Z          else:
2026-02-20T22:09:17.3636415Z              templates = [
2026-02-20T22:09:17.3637008Z                  f"L'Alliance doit répartir {num1} {obj} dans {num2} {location}. Combien par {location}?",
2026-02-20T22:09:17.3637609Z                  f"Un convoi de {num1} {obj} doit être distribué sur {num2} {location}. Combien par site?",
2026-02-20T22:09:17.3638129Z -                f"L'Empire divise {num1} {obj} entre {num2} {location}. Répartition par zone?"
2026-02-20T22:09:17.3638269Z -            ]
2026-02-20T22:09:17.3638373Z -    
2026-02-20T22:09:17.3638950Z -    return random.choice(templates) if 'templates' in locals() else f"Calcule {num1} {operation_type.lower()} {num2}"
2026-02-20T22:09:17.3639062Z -
2026-02-20T22:09:17.3639669Z -def generate_smart_choices(operation_type, num1, num2, correct_result, age_group): # Changed difficulty to age_group
2026-02-20T22:09:17.3640203Z +                f"L'Empire divise {num1} {obj} entre {num2} {location}. Répartition par zone?",
2026-02-20T22:09:17.3640325Z +            ]
2026-02-20T22:09:17.3640430Z +
2026-02-20T22:09:17.3640541Z +    return (
2026-02-20T22:09:17.3640680Z +        random.choice(templates)
2026-02-20T22:09:17.3640824Z +        if "templates" in locals()
2026-02-20T22:09:17.3641063Z +        else f"Calcule {num1} {operation_type.lower()} {num2}"
2026-02-20T22:09:17.3641168Z +    )
2026-02-20T22:09:17.3641276Z +
2026-02-20T22:09:17.3641377Z +
2026-02-20T22:09:17.3641534Z +def generate_smart_choices(
2026-02-20T22:09:17.3641755Z +    operation_type, num1, num2, correct_result, age_group
2026-02-20T22:09:17.3641914Z +):  # Changed difficulty to age_group
2026-02-20T22:09:17.3642396Z      """Génère des choix de réponses avec des erreurs typiques selon l'opération"""
2026-02-20T22:09:17.3642558Z      choices = [str(correct_result)]
2026-02-20T22:09:17.3642674Z -    
2026-02-20T22:09:17.3642783Z +
2026-02-20T22:09:17.3642954Z      if operation_type.upper() == "ADDITION":
2026-02-20T22:09:17.3643328Z          # Erreurs typiques en addition
2026-02-20T22:09:17.3643466Z -        choices.extend([
2026-02-20T22:09:17.3643795Z -            str(correct_result + random.randint(1, 3)),  # Erreur de calcul simple
2026-02-20T22:09:17.3644168Z -            str(correct_result - random.randint(1, 2)),  # Oubli d'une unité
2026-02-20T22:09:17.3644721Z -            str(num1 * num2) if num1 * num2 != correct_result else str(correct_result + 5)  # Confusion avec multiplication
2026-02-20T22:09:17.3644842Z -        ])
2026-02-20T22:09:17.3644946Z -    
2026-02-20T22:09:17.3645086Z +        choices.extend(
2026-02-20T22:09:17.3645195Z +            [
2026-02-20T22:09:17.3645523Z +                str(correct_result + random.randint(1, 3)),  # Erreur de calcul simple
2026-02-20T22:09:17.3645904Z +                str(correct_result - random.randint(1, 2)),  # Oubli d'une unité
2026-02-20T22:09:17.3646025Z +                (
2026-02-20T22:09:17.3646158Z +                    str(num1 * num2)
2026-02-20T22:09:17.3646325Z +                    if num1 * num2 != correct_result
2026-02-20T22:09:17.3646498Z +                    else str(correct_result + 5)
2026-02-20T22:09:17.3646668Z +                ),  # Confusion avec multiplication
2026-02-20T22:09:17.3646775Z +            ]
2026-02-20T22:09:17.3646876Z +        )
2026-02-20T22:09:17.3646990Z +
2026-02-20T22:09:17.3647180Z      elif operation_type.upper() == "SUBTRACTION":
2026-02-20T22:09:17.3647335Z          # Erreurs typiques en soustraction
2026-02-20T22:09:17.3647687Z -        choices.extend([
2026-02-20T22:09:17.3648079Z -            str(num2 - num1) if num2 != num1 else str(correct_result + 3),  # Inversion de l'ordre
2026-02-20T22:09:17.3648367Z -            str(correct_result + random.randint(1, 3)),  # Erreur de calcul
2026-02-20T22:09:17.3649164Z -            str(num1 + num2) if num1 + num2 != correct_result else str(correct_result - 2)  # Addition au lieu de soustraction
2026-02-20T22:09:17.3649291Z -        ])
2026-02-20T22:09:17.3649398Z -    
2026-02-20T22:09:17.3649537Z +        choices.extend(
2026-02-20T22:09:17.3649649Z +            [
2026-02-20T22:09:17.3649751Z +                (
2026-02-20T22:09:17.3650037Z +                    str(num2 - num1) if num2 != num1 else str(correct_result + 3)
2026-02-20T22:09:17.3650191Z +                ),  # Inversion de l'ordre
2026-02-20T22:09:17.3651061Z +                str(correct_result + random.randint(1, 3)),  # Erreur de calcul
2026-02-20T22:09:17.3651192Z +                (
2026-02-20T22:09:17.3651356Z +                    str(num1 + num2)
2026-02-20T22:09:17.3651529Z +                    if num1 + num2 != correct_result
2026-02-20T22:09:17.3651697Z +                    else str(correct_result - 2)
2026-02-20T22:09:17.3651869Z +                ),  # Addition au lieu de soustraction
2026-02-20T22:09:17.3651994Z +            ]
2026-02-20T22:09:17.3652101Z +        )
2026-02-20T22:09:17.3652205Z +
2026-02-20T22:09:17.3652425Z      elif operation_type.upper() == "MULTIPLICATION":
2026-02-20T22:09:17.3652591Z          # Erreurs typiques en multiplication
2026-02-20T22:09:17.3652719Z -        choices.extend([
2026-02-20T22:09:17.3652953Z -            str(num1 + num2),  # Addition au lieu de multiplication
2026-02-20T22:09:17.3653340Z -            str(correct_result + num1),  # Une fois de trop
2026-02-20T22:09:17.3653579Z -            str(max(1, correct_result - num2))  # Une fois de moins
2026-02-20T22:09:17.3653685Z -        ])
2026-02-20T22:09:17.3653797Z -    
2026-02-20T22:09:17.3653934Z +        choices.extend(
2026-02-20T22:09:17.3654042Z +            [
2026-02-20T22:09:17.3654295Z +                str(num1 + num2),  # Addition au lieu de multiplication
2026-02-20T22:09:17.3654501Z +                str(correct_result + num1),  # Une fois de trop
2026-02-20T22:09:17.3654753Z +                str(max(1, correct_result - num2)),  # Une fois de moins
2026-02-20T22:09:17.3654861Z +            ]
2026-02-20T22:09:17.3654973Z +        )
2026-02-20T22:09:17.3655075Z +
2026-02-20T22:09:17.3655255Z      elif operation_type.upper() == "DIVISION":
2026-02-20T22:09:17.3655408Z          # Erreurs typiques en division
2026-02-20T22:09:17.3655539Z -        choices.extend([
2026-02-20T22:09:17.3655757Z -            str(correct_result + 1),  # Erreur de calcul simple
2026-02-20T22:09:17.3656006Z -            str(max(1, correct_result - 1)),  # Erreur de calcul simple
2026-02-20T22:09:17.3656479Z -            str(num1 - num2) if num1 > num2 else str(correct_result + 2)  # Soustraction au lieu de division
2026-02-20T22:09:17.3656595Z -        ])
2026-02-20T22:09:17.3656699Z -    
2026-02-20T22:09:17.3656831Z +        choices.extend(
2026-02-20T22:09:17.3656937Z +            [
2026-02-20T22:09:17.3657159Z +                str(correct_result + 1),  # Erreur de calcul simple
2026-02-20T22:09:17.3657428Z +                str(max(1, correct_result - 1)),  # Erreur de calcul simple
2026-02-20T22:09:17.3657537Z +                (
2026-02-20T22:09:17.3657805Z +                    str(num1 - num2) if num1 > num2 else str(correct_result + 2)
2026-02-20T22:09:17.3657981Z +                ),  # Soustraction au lieu de division
2026-02-20T22:09:17.3658091Z +            ]
2026-02-20T22:09:17.3658195Z +        )
2026-02-20T22:09:17.3658300Z +
2026-02-20T22:09:17.3658582Z      derived_difficulty = get_difficulty_from_age_group(age_group)
2026-02-20T22:09:17.3658954Z      # Ajuster selon la difficulté dérivée du groupe d'âge
2026-02-20T22:09:17.3659360Z      if derived_difficulty in [DifficultyLevels.CHEVALIER, DifficultyLevels.MAITRE]:
2026-02-20T22:09:17.3660026Z          # Pour les niveaux avancés, ajouter des erreurs plus subtiles
2026-02-20T22:09:17.3660213Z          margin = max(1, int(correct_result * 0.1))
2026-02-20T22:09:17.3660388Z          choices[1] = str(correct_result + margin)
2026-02-20T22:09:17.3660814Z          choices[2] = str(max(1, correct_result - margin))
2026-02-20T22:09:17.3660943Z -    
2026-02-20T22:09:17.3661050Z +
2026-02-20T22:09:17.3661374Z      # S'assurer qu'il n'y a pas de doublons et que tous les choix sont positifs
2026-02-20T22:09:17.3661518Z      unique_choices = []
2026-02-20T22:09:17.3661653Z      for choice in choices:
2026-02-20T22:09:17.3661763Z          try:
2026-02-20T22:09:17.3661998Z              if choice not in unique_choices and int(choice) > 0:
2026-02-20T22:09:17.3662112Z @@ -1634,9 +1968,9 @@
2026-02-20T22:09:17.3662345Z      # Compléter si nécessaire
2026-02-20T22:09:17.3662499Z      while len(unique_choices) < 4:
2026-02-20T22:09:17.3662750Z          new_choice = str(correct_result + random.randint(-3, 5))
2026-02-20T22:09:17.3663212Z          if new_choice not in unique_choices and int(new_choice) > 0:
2026-02-20T22:09:17.3663386Z              unique_choices.append(new_choice)
2026-02-20T22:09:17.3663499Z -    
2026-02-20T22:09:17.3663604Z +
2026-02-20T22:09:17.3663871Z      # Mélanger et retourner les 4 premiers
2026-02-20T22:09:17.3664017Z      random.shuffle(unique_choices)
2026-02-20T22:09:17.3664165Z -    return unique_choices[:4]
2026-02-20T22:09:17.3664299Z \ No newline at end of file
2026-02-20T22:09:17.3664435Z +    return unique_choices[:4]
2026-02-20T22:09:17.3880574Z would reformat /home/runner/work/mathakine/mathakine/server/template_handler.py
2026-02-20T22:09:17.3881104Z --- /home/runner/work/mathakine/mathakine/server/template_handler.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.3881588Z +++ /home/runner/work/mathakine/mathakine/server/template_handler.py	2026-02-20 22:09:17.385194+00:00
2026-02-20T22:09:17.3881702Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.3881880Z  Template handler module for Mathakine.
2026-02-20T22:09:17.3881989Z  
2026-02-20T22:09:17.3882303Z  This module centralizes template rendering logic, providing consistent
2026-02-20T22:09:17.3882620Z  error handling and template context preparation across the application.
2026-02-20T22:09:17.3882728Z  """
2026-02-20T22:09:17.3882837Z +
2026-02-20T22:09:17.3882954Z  import json
2026-02-20T22:09:17.3883249Z  import traceback
2026-02-20T22:09:17.3883403Z  from pathlib import Path
2026-02-20T22:09:17.3883510Z  
2026-02-20T22:09:17.3883705Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.3883826Z @@ -15,99 +16,93 @@
2026-02-20T22:09:17.3884012Z  from starlette.responses import HTMLResponse
2026-02-20T22:09:17.3884213Z  from starlette.templating import Jinja2Templates
2026-02-20T22:09:17.3884323Z  
2026-02-20T22:09:17.3884457Z  # Get templates directory
2026-02-20T22:09:17.3884646Z  BASE_DIR = Path(__file__).resolve().parent.parent
2026-02-20T22:09:17.3884822Z -TEMPLATES_DIR = str(BASE_DIR / 'templates')
2026-02-20T22:09:17.3885006Z +TEMPLATES_DIR = str(BASE_DIR / "templates")
2026-02-20T22:09:17.3885110Z  
2026-02-20T22:09:17.3885240Z  # Initialize templates
2026-02-20T22:09:17.3885470Z  templates = Jinja2Templates(directory=TEMPLATES_DIR)
2026-02-20T22:09:17.3885572Z  
2026-02-20T22:09:17.3885701Z  # Add tojson filter
2026-02-20T22:09:17.3885975Z  templates.env.filters["tojson"] = lambda obj: json.dumps(obj)
2026-02-20T22:09:17.3886083Z  
2026-02-20T22:09:17.3886184Z +
2026-02-20T22:09:17.3886310Z  def render_template(
2026-02-20T22:09:17.3886445Z -    template_name: str,
2026-02-20T22:09:17.3886566Z -    request: Request,
2026-02-20T22:09:17.3886696Z -    context: dict = None,
2026-02-20T22:09:17.3886823Z -    status_code: int = 200
2026-02-20T22:09:17.3887210Z +    template_name: str, request: Request, context: dict = None, status_code: int = 200
2026-02-20T22:09:17.3887330Z  ) -> HTMLResponse:
2026-02-20T22:09:17.3887438Z      """
2026-02-20T22:09:17.3887651Z      Render a template with consistent error handling.
2026-02-20T22:09:17.3888088Z -    
2026-02-20T22:09:17.3888193Z +
2026-02-20T22:09:17.3888304Z      Args:
2026-02-20T22:09:17.3888513Z          template_name: Name of the template to render
2026-02-20T22:09:17.3888679Z          request: The Starlette request object
2026-02-20T22:09:17.3889072Z          context: Template context dictionary
2026-02-20T22:09:17.3889236Z          status_code: HTTP status code
2026-02-20T22:09:17.3889345Z -        
2026-02-20T22:09:17.3889446Z +
2026-02-20T22:09:17.3889558Z      Returns:
2026-02-20T22:09:17.3889747Z          HTMLResponse with the rendered template
2026-02-20T22:09:17.3889859Z      """
2026-02-20T22:09:17.3889972Z      try:
2026-02-20T22:09:17.3890127Z          # Initialize context if None
2026-02-20T22:09:17.3890264Z          context = context or {}
2026-02-20T22:09:17.3890371Z -        
2026-02-20T22:09:17.3890472Z +
2026-02-20T22:09:17.3890628Z          # Ensure 'request' is in context
2026-02-20T22:09:17.3890766Z -        context['request'] = request
2026-02-20T22:09:17.3890877Z -        
2026-02-20T22:09:17.3891022Z +        context["request"] = request
2026-02-20T22:09:17.3891125Z +
2026-02-20T22:09:17.3891380Z          # Ensure current_user is set (default to unauthenticated)
2026-02-20T22:09:17.3891546Z -        if 'current_user' not in context:
2026-02-20T22:09:17.3891786Z -            context['current_user'] = {"is_authenticated": False}
2026-02-20T22:09:17.3891894Z -            
2026-02-20T22:09:17.3892039Z +        if "current_user" not in context:
2026-02-20T22:09:17.3892278Z +            context["current_user"] = {"is_authenticated": False}
2026-02-20T22:09:17.3892381Z +
2026-02-20T22:09:17.3892511Z          # Render template
2026-02-20T22:09:17.3892687Z          return templates.TemplateResponse(
2026-02-20T22:09:17.3892814Z -            template_name,
2026-02-20T22:09:17.3892942Z -            context=context,
2026-02-20T22:09:17.3893254Z -            status_code=status_code
2026-02-20T22:09:17.3893520Z +            template_name, context=context, status_code=status_code
2026-02-20T22:09:17.3893634Z          )
2026-02-20T22:09:17.3893770Z      except Exception as e:
2026-02-20T22:09:17.3894061Z          logger.error(f"Error rendering template {template_name}: {e}")
2026-02-20T22:09:17.3894200Z          traceback.print_exc()
2026-02-20T22:09:17.3894311Z -        
2026-02-20T22:09:17.3894421Z +
2026-02-20T22:09:17.3894556Z          # Render error template
2026-02-20T22:09:17.3894691Z          return render_error(
2026-02-20T22:09:17.3894821Z              request=request,
2026-02-20T22:09:17.3894973Z              error="Template Error",
2026-02-20T22:09:17.3895183Z              message=f"Error rendering template: {str(e)}",
2026-02-20T22:09:17.3895309Z -            status_code=500
2026-02-20T22:09:17.3895442Z +            status_code=500,
2026-02-20T22:09:17.3895549Z          )
2026-02-20T22:09:17.3895653Z  
2026-02-20T22:09:17.3895756Z +
2026-02-20T22:09:17.3895888Z  def render_error(
2026-02-20T22:09:17.3896011Z -    request: Request,
2026-02-20T22:09:17.3896131Z -    error: str,
2026-02-20T22:09:17.3896269Z -    message: str = None,
2026-02-20T22:09:17.3896396Z -    status_code: int = 500
2026-02-20T22:09:17.3896719Z +    request: Request, error: str, message: str = None, status_code: int = 500
2026-02-20T22:09:17.3896844Z  ) -> HTMLResponse:
2026-02-20T22:09:17.3896970Z      """
2026-02-20T22:09:17.3897105Z      Render an error template.
2026-02-20T22:09:17.3897209Z -    
2026-02-20T22:09:17.3897318Z +
2026-02-20T22:09:17.3897422Z      Args:
2026-02-20T22:09:17.3897590Z          request: The Starlette request object
2026-02-20T22:09:17.3897715Z          error: Error title
2026-02-20T22:09:17.3897853Z          message: Error message
2026-02-20T22:09:17.3898000Z          status_code: HTTP status code
2026-02-20T22:09:17.3898104Z -        
2026-02-20T22:09:17.3898214Z +
2026-02-20T22:09:17.3898325Z      Returns:
2026-02-20T22:09:17.3898525Z          HTMLResponse with the rendered error template
2026-02-20T22:09:17.3898626Z      """
2026-02-20T22:09:17.3898970Z      try:
2026-02-20T22:09:17.3899152Z          return templates.TemplateResponse(
2026-02-20T22:09:17.3899282Z              "error.html",
2026-02-20T22:09:17.3899397Z              {
2026-02-20T22:09:17.3899527Z                  "request": request,
2026-02-20T22:09:17.3899834Z                  "error": error,
2026-02-20T22:09:17.3900051Z                  "message": message or "An error occurred.",
2026-02-20T22:09:17.3900259Z -                "current_user": {"is_authenticated": False}
2026-02-20T22:09:17.3900457Z +                "current_user": {"is_authenticated": False},
2026-02-20T22:09:17.3900561Z              },
2026-02-20T22:09:17.3900704Z -            status_code=status_code
2026-02-20T22:09:17.3900842Z +            status_code=status_code,
2026-02-20T22:09:17.3900946Z          )
2026-02-20T22:09:17.3901108Z      except Exception as template_error:
2026-02-20T22:09:17.3901365Z          # If rendering error template fails, fallback to basic HTML
2026-02-20T22:09:17.3901696Z          logger.critical(f"Error rendering error template: {template_error}")
2026-02-20T22:09:17.3901873Z          logger.critical(traceback.format_exc())
2026-02-20T22:09:17.3901987Z -        
2026-02-20T22:09:17.3902090Z +
2026-02-20T22:09:17.3902225Z          return HTMLResponse(
2026-02-20T22:09:17.3902347Z              f"""
2026-02-20T22:09:17.3902457Z              <html>
2026-02-20T22:09:17.3902627Z                  <head><title>Error</title></head>
2026-02-20T22:09:17.3902743Z                  <body>
2026-02-20T22:09:17.3902865Z @@ -116,16 +111,17 @@
2026-02-20T22:09:17.3904387Z                      <p>Additionally, an error occurred while rendering the error page.</p>
2026-02-20T22:09:17.3904574Z                      <a href="/">Return to home</a>
2026-02-20T22:09:17.3905271Z                  </body>
2026-02-20T22:09:17.3905399Z              </html>
2026-02-20T22:09:17.3905508Z              """,
2026-02-20T22:09:17.3906583Z -            status_code=status_code
2026-02-20T22:09:17.3906751Z +            status_code=status_code,
2026-02-20T22:09:17.3906869Z          )
2026-02-20T22:09:17.3907504Z +
2026-02-20T22:09:17.3907622Z  
2026-02-20T22:09:17.3907799Z  def get_templates() -> Jinja2Templates:
2026-02-20T22:09:17.3907908Z      """
2026-02-20T22:09:17.3908206Z      Get the templates object for use in application initialization.
2026-02-20T22:09:17.3908316Z -    
2026-02-20T22:09:17.3908416Z +
2026-02-20T22:09:17.3908525Z      Returns:
2026-02-20T22:09:17.3908674Z          Jinja2Templates object
2026-02-20T22:09:17.3908781Z      """
2026-02-20T22:09:17.3908909Z -    return templates 
2026-02-20T22:09:17.3909044Z \ No newline at end of file
2026-02-20T22:09:17.3909174Z +    return templates
2026-02-20T22:09:17.4906396Z --- /home/runner/work/mathakine/mathakine/server/routes.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.4906881Z +++ /home/runner/work/mathakine/mathakine/server/routes.py	2026-02-20 22:09:17.488495+00:00
2026-02-20T22:09:17.4908964Z @@ -2,10 +2,11 @@
2026-02-20T22:09:17.4909207Z  Routes API pour Mathakine (backend Starlette).
2026-02-20T22:09:17.4911932Z  
2026-02-20T22:09:17.4912676Z  Ce module définit uniquement les routes API JSON utilisées par le frontend Next.js.
2026-02-20T22:09:17.4913374Z  Toutes les routes HTML/templates ont été supprimées (frontend géré par Next.js).
2026-02-20T22:09:17.4913526Z  """
2026-02-20T22:09:17.4913632Z +
2026-02-20T22:09:17.4913772Z  from typing import List
2026-02-20T22:09:17.4913889Z  
2026-02-20T22:09:17.4914102Z  from starlette.responses import PlainTextResponse
2026-02-20T22:09:17.4914281Z  from starlette.routing import Mount, Route
2026-02-20T22:09:17.4914391Z  
2026-02-20T22:09:17.4914518Z @@ -39,82 +40,104 @@
2026-02-20T22:09:17.4914629Z      admin_users,
2026-02-20T22:09:17.4914750Z      admin_users_patch,
2026-02-20T22:09:17.4914907Z      admin_users_resend_verification,
2026-02-20T22:09:17.4915050Z      admin_users_send_reset_password,
2026-02-20T22:09:17.4915157Z  )
2026-02-20T22:09:17.4915256Z +
2026-02-20T22:09:17.4915410Z  # Imports API handlers - Auth
2026-02-20T22:09:17.4916155Z -from server.handlers.auth_handlers import (api_get_current_user, api_login,
2026-02-20T22:09:17.4916379Z -                                           api_refresh_token, api_validate_token,
2026-02-20T22:09:17.4916734Z -                                           api_get_csrf_token,
2026-02-20T22:09:17.4916951Z -                                           api_logout, api_forgot_password,
2026-02-20T22:09:17.4917123Z -                                           api_reset_password,
2026-02-20T22:09:17.4917318Z -                                           resend_verification_email,
2026-02-20T22:09:17.4917475Z -                                           verify_email)
2026-02-20T22:09:17.4917653Z +from server.handlers.auth_handlers import (
2026-02-20T22:09:17.4917931Z +    api_get_current_user,
2026-02-20T22:09:17.4918472Z +    api_login,
2026-02-20T22:09:17.4918608Z +    api_refresh_token,
2026-02-20T22:09:17.4918997Z +    api_validate_token,
2026-02-20T22:09:17.4919174Z +    api_get_csrf_token,
2026-02-20T22:09:17.4919297Z +    api_logout,
2026-02-20T22:09:17.4919432Z +    api_forgot_password,
2026-02-20T22:09:17.4919563Z +    api_reset_password,
2026-02-20T22:09:17.4919718Z +    resend_verification_email,
2026-02-20T22:09:17.4919839Z +    verify_email,
2026-02-20T22:09:17.4919950Z +)
2026-02-20T22:09:17.4920073Z +
2026-02-20T22:09:17.4920225Z  # Imports API handlers - Badges
2026-02-20T22:09:17.4920521Z -from server.handlers.badge_handlers import (check_user_badges,
2026-02-20T22:09:17.4920720Z -                                            get_available_badges,
2026-02-20T22:09:17.4920896Z -                                            get_badges_rarity,
2026-02-20T22:09:17.4921065Z -                                            get_user_badges,
2026-02-20T22:09:17.4921252Z -                                            get_user_gamification_stats,
2026-02-20T22:09:17.4921440Z -                                            get_user_badges_progress,
2026-02-20T22:09:17.4921619Z -                                            patch_pinned_badges)
2026-02-20T22:09:17.4921804Z +from server.handlers.badge_handlers import (
2026-02-20T22:09:17.4921942Z +    check_user_badges,
2026-02-20T22:09:17.4922072Z +    get_available_badges,
2026-02-20T22:09:17.4922188Z +    get_badges_rarity,
2026-02-20T22:09:17.4922324Z +    get_user_badges,
2026-02-20T22:09:17.4922440Z +    get_user_gamification_stats,
2026-02-20T22:09:17.4922522Z +    get_user_badges_progress,
2026-02-20T22:09:17.4922601Z +    patch_pinned_badges,
2026-02-20T22:09:17.4922668Z +)
2026-02-20T22:09:17.4922730Z +
2026-02-20T22:09:17.4922823Z  # Imports API handlers - Challenges
2026-02-20T22:09:17.4923323Z -from server.handlers.challenge_handlers import (generate_ai_challenge_stream,
2026-02-20T22:09:17.4923449Z -                                                get_challenge,
2026-02-20T22:09:17.4923561Z -                                                get_challenge_hint,
2026-02-20T22:09:17.4923670Z -                                                get_challenges_list,
2026-02-20T22:09:17.4923802Z -                                                get_completed_challenges_ids,
2026-02-20T22:09:17.4923915Z -                                                submit_challenge_answer,
2026-02-20T22:09:17.4924020Z -                                                start_challenge,
2026-02-20T22:09:17.4924137Z -                                                get_challenge_progress,
2026-02-20T22:09:17.4924244Z -                                                get_challenge_rewards)
2026-02-20T22:09:17.4924366Z +from server.handlers.challenge_handlers import (
2026-02-20T22:09:17.4924454Z +    generate_ai_challenge_stream,
2026-02-20T22:09:17.4924526Z +    get_challenge,
2026-02-20T22:09:17.4924602Z +    get_challenge_hint,
2026-02-20T22:09:17.4924677Z +    get_challenges_list,
2026-02-20T22:09:17.4924764Z +    get_completed_challenges_ids,
2026-02-20T22:09:17.4924841Z +    submit_challenge_answer,
2026-02-20T22:09:17.4924912Z +    start_challenge,
2026-02-20T22:09:17.4925196Z +    get_challenge_progress,
2026-02-20T22:09:17.4925271Z +    get_challenge_rewards,
2026-02-20T22:09:17.4925332Z +)
2026-02-20T22:09:17.4925390Z +
2026-02-20T22:09:17.4925479Z  # Imports API handlers - Chat
2026-02-20T22:09:17.4925769Z  from server.handlers.chat_handlers import chat_api, chat_api_stream
2026-02-20T22:09:17.4925830Z +
2026-02-20T22:09:17.4925926Z  # Imports API handlers - Exercises
2026-02-20T22:09:17.4926125Z -from server.handlers.exercise_handlers import (generate_ai_exercise_stream,
2026-02-20T22:09:17.4926229Z -                                               generate_exercise,
2026-02-20T22:09:17.4926343Z -                                               generate_exercise_api,
2026-02-20T22:09:17.4926457Z -                                               get_completed_exercises_ids,
2026-02-20T22:09:17.4926562Z -                                               get_exercise, submit_answer,
2026-02-20T22:09:17.4926665Z -                                               get_exercises_list,
2026-02-20T22:09:17.4926777Z -                                               get_exercises_stats)
2026-02-20T22:09:17.4926890Z +from server.handlers.exercise_handlers import (
2026-02-20T22:09:17.4926972Z +    generate_ai_exercise_stream,
2026-02-20T22:09:17.4927049Z +    generate_exercise,
2026-02-20T22:09:17.4927127Z +    generate_exercise_api,
2026-02-20T22:09:17.4927205Z +    get_completed_exercises_ids,
2026-02-20T22:09:17.4927276Z +    get_exercise,
2026-02-20T22:09:17.4927343Z +    submit_answer,
2026-02-20T22:09:17.4927414Z +    get_exercises_list,
2026-02-20T22:09:17.4927487Z +    get_exercises_stats,
2026-02-20T22:09:17.4927553Z +)
2026-02-20T22:09:17.4927612Z +
2026-02-20T22:09:17.4927707Z  # Imports API handlers - Recommendations
2026-02-20T22:09:17.4927933Z -from server.handlers.recommendation_handlers import (generate_recommendations,
2026-02-20T22:09:17.4928048Z -                                                     get_recommendations,
2026-02-20T22:09:17.4928177Z -                                                     handle_recommendation_complete)
2026-02-20T22:09:17.4928316Z +from server.handlers.recommendation_handlers import (
2026-02-20T22:09:17.4928405Z +    generate_recommendations,
2026-02-20T22:09:17.4928481Z +    get_recommendations,
2026-02-20T22:09:17.4928573Z +    handle_recommendation_complete,
2026-02-20T22:09:17.4928640Z +)
2026-02-20T22:09:17.4928700Z +
2026-02-20T22:09:17.4928784Z  # Imports API handlers - Users
2026-02-20T22:09:17.4928994Z -from server.handlers.user_handlers import (create_user_account, get_all_users,
2026-02-20T22:09:17.4929093Z -                                           get_user_stats,
2026-02-20T22:09:17.4929201Z -                                           get_users_leaderboard,
2026-02-20T22:09:17.4929302Z -                                           get_all_user_progress,
2026-02-20T22:09:17.4929428Z -                                           get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4929541Z -                                           get_challenges_progress,
2026-02-20T22:09:17.4929638Z -                                           update_user_me,
2026-02-20T22:09:17.4929747Z -                                           update_user_password_me,
2026-02-20T22:09:17.4929840Z -                                           delete_user,
2026-02-20T22:09:17.4929934Z -                                           delete_user_me,
2026-02-20T22:09:17.4930039Z -                                           export_user_data,
2026-02-20T22:09:17.4930140Z -                                           get_user_sessions,
2026-02-20T22:09:17.4930239Z -                                           revoke_user_session)
2026-02-20T22:09:17.4930346Z +from server.handlers.user_handlers import (
2026-02-20T22:09:17.4930421Z +    create_user_account,
2026-02-20T22:09:17.4930489Z +    get_all_users,
2026-02-20T22:09:17.4930559Z +    get_user_stats,
2026-02-20T22:09:17.4930641Z +    get_users_leaderboard,
2026-02-20T22:09:17.4930714Z +    get_all_user_progress,
2026-02-20T22:09:17.4930891Z +    get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4930977Z +    get_challenges_progress,
2026-02-20T22:09:17.4931045Z +    update_user_me,
2026-02-20T22:09:17.4931122Z +    update_user_password_me,
2026-02-20T22:09:17.4931189Z +    delete_user,
2026-02-20T22:09:17.4931263Z +    delete_user_me,
2026-02-20T22:09:17.4931408Z +    export_user_data,
2026-02-20T22:09:17.4931482Z +    get_user_sessions,
2026-02-20T22:09:17.4931561Z +    revoke_user_session,
2026-02-20T22:09:17.4931623Z +)
2026-02-20T22:09:17.4931682Z  
2026-02-20T22:09:17.4931740Z  
2026-02-20T22:09:17.4931831Z  async def health_handler(request):
2026-02-20T22:09:17.4931984Z      """GET /health - Health check pour Render et load balancers."""
2026-02-20T22:09:17.4932106Z      return PlainTextResponse("ok", status_code=200)
2026-02-20T22:09:17.4932172Z  
2026-02-20T22:09:17.4932231Z  
2026-02-20T22:09:17.4932312Z  async def robots_txt(request):
2026-02-20T22:09:17.4932587Z      """robots.txt - évite les 404 des crawlers sur le backend."""
2026-02-20T22:09:17.4932688Z -    return PlainTextResponse(
2026-02-20T22:09:17.4932781Z -        "User-agent: *\nDisallow: /\n",
2026-02-20T22:09:17.4932865Z -        media_type="text/plain"
2026-02-20T22:09:17.4932929Z -    )
2026-02-20T22:09:17.4933362Z +    return PlainTextResponse("User-agent: *\nDisallow: /\n", media_type="text/plain")
2026-02-20T22:09:17.4933429Z  
2026-02-20T22:09:17.4933488Z  
2026-02-20T22:09:17.4933585Z  async def metrics_handler(request):
2026-02-20T22:09:17.4933844Z      """GET /metrics - métriques Prometheus (p50/p95/p99, taux d'erreur)."""
2026-02-20T22:09:17.4933970Z      from app.core.monitoring import metrics_endpoint
2026-02-20T22:09:17.4934033Z +
2026-02-20T22:09:17.4934127Z      return await metrics_endpoint(request)
2026-02-20T22:09:17.4934186Z  
2026-02-20T22:09:17.4934243Z  
2026-02-20T22:09:17.4934328Z  def get_routes() -> List:
2026-02-20T22:09:17.4934390Z      """
2026-02-20T22:09:17.4934458Z @@ -127,120 +150,257 @@
2026-02-20T22:09:17.4934546Z          # ========================================
2026-02-20T22:09:17.4934629Z          # AUTH API (7 routes)
2026-02-20T22:09:17.4934708Z          # ========================================
2026-02-20T22:09:17.4934873Z          Route("/api/auth/login", endpoint=api_login, methods=["POST"]),
2026-02-20T22:09:17.4935048Z          Route("/api/auth/csrf", endpoint=api_get_csrf_token, methods=["GET"]),
2026-02-20T22:09:17.4935269Z -        Route("/api/auth/validate-token", endpoint=api_validate_token, methods=["POST"]),
2026-02-20T22:09:17.4935332Z +        Route(
2026-02-20T22:09:17.4935530Z +            "/api/auth/validate-token", endpoint=api_validate_token, methods=["POST"]
2026-02-20T22:09:17.4935593Z +        ),
2026-02-20T22:09:17.4935774Z          Route("/api/auth/refresh", endpoint=api_refresh_token, methods=["POST"]),
2026-02-20T22:09:17.4935936Z          Route("/api/auth/logout", endpoint=api_logout, methods=["POST"]),
2026-02-20T22:09:17.4936163Z -        Route("/api/auth/forgot-password", endpoint=api_forgot_password, methods=["POST"]),
2026-02-20T22:09:17.4936381Z -        Route("/api/auth/reset-password", endpoint=api_reset_password, methods=["POST"]),
2026-02-20T22:09:17.4936448Z +        Route(
2026-02-20T22:09:17.4936647Z +            "/api/auth/forgot-password", endpoint=api_forgot_password, methods=["POST"]
2026-02-20T22:09:17.4936711Z +        ),
2026-02-20T22:09:17.4936772Z +        Route(
2026-02-20T22:09:17.4936970Z +            "/api/auth/reset-password", endpoint=api_reset_password, methods=["POST"]
2026-02-20T22:09:17.4937031Z +        ),
2026-02-20T22:09:17.4937214Z          Route("/api/auth/verify-email", endpoint=verify_email, methods=["GET"]),
2026-02-20T22:09:17.4937492Z -        Route("/api/auth/resend-verification", endpoint=resend_verification_email, methods=["POST"]),
2026-02-20T22:09:17.4937555Z -        
2026-02-20T22:09:17.4937617Z +        Route(
2026-02-20T22:09:17.4937726Z +            "/api/auth/resend-verification",
2026-02-20T22:09:17.4937824Z +            endpoint=resend_verification_email,
2026-02-20T22:09:17.4938054Z +            methods=["POST"],
2026-02-20T22:09:17.4938115Z +        ),
2026-02-20T22:09:17.4938206Z          # ========================================
2026-02-20T22:09:17.4938289Z          # USERS API (13 routes)
2026-02-20T22:09:17.4938465Z          # ========================================
2026-02-20T22:09:17.4938636Z          Route("/api/users/", endpoint=get_all_users, methods=["GET"]),
2026-02-20T22:09:17.4938810Z          Route("/api/users/", endpoint=create_user_account, methods=["POST"]),
2026-02-20T22:09:17.4938983Z          Route("/api/users/me", endpoint=api_get_current_user, methods=["GET"]),
2026-02-20T22:09:17.4939144Z          Route("/api/users/me", endpoint=update_user_me, methods=["PUT"]),
2026-02-20T22:09:17.4939365Z -        Route("/api/users/me/password", endpoint=update_user_password_me, methods=["PUT"]),
2026-02-20T22:09:17.4939428Z +        Route(
2026-02-20T22:09:17.4939625Z +            "/api/users/me/password", endpoint=update_user_password_me, methods=["PUT"]
2026-02-20T22:09:17.4939691Z +        ),
2026-02-20T22:09:17.4939854Z          Route("/api/users/me", endpoint=delete_user_me, methods=["DELETE"]),
2026-02-20T22:09:17.4940038Z          Route("/api/users/me/export", endpoint=export_user_data, methods=["GET"]),
2026-02-20T22:09:17.4940235Z          Route("/api/users/me/sessions", endpoint=get_user_sessions, methods=["GET"]),
2026-02-20T22:09:17.4940502Z -        Route("/api/users/me/sessions/{session_id:int}", endpoint=revoke_user_session, methods=["DELETE"]),
2026-02-20T22:09:17.4940705Z -        Route("/api/users/me/progress", endpoint=get_all_user_progress, methods=["GET"]),
2026-02-20T22:09:17.4941019Z -        Route("/api/users/me/progress/{exercise_type}", endpoint=get_user_progress_by_exercise_type, methods=["GET"]),
2026-02-20T22:09:17.4941283Z -        Route("/api/users/me/challenges/progress", endpoint=get_challenges_progress, methods=["GET"]),
2026-02-20T22:09:17.4941348Z +        Route(
2026-02-20T22:09:17.4941468Z +            "/api/users/me/sessions/{session_id:int}",
2026-02-20T22:09:17.4941560Z +            endpoint=revoke_user_session,
2026-02-20T22:09:17.4941638Z +            methods=["DELETE"],
2026-02-20T22:09:17.4941706Z +        ),
2026-02-20T22:09:17.4941767Z +        Route(
2026-02-20T22:09:17.4941959Z +            "/api/users/me/progress", endpoint=get_all_user_progress, methods=["GET"]
2026-02-20T22:09:17.4942020Z +        ),
2026-02-20T22:09:17.4942087Z +        Route(
2026-02-20T22:09:17.4942195Z +            "/api/users/me/progress/{exercise_type}",
2026-02-20T22:09:17.4942308Z +            endpoint=get_user_progress_by_exercise_type,
2026-02-20T22:09:17.4942388Z +            methods=["GET"],
2026-02-20T22:09:17.4942447Z +        ),
2026-02-20T22:09:17.4942530Z +        Route(
2026-02-20T22:09:17.4942630Z +            "/api/users/me/challenges/progress",
2026-02-20T22:09:17.4942730Z +            endpoint=get_challenges_progress,
2026-02-20T22:09:17.4942801Z +            methods=["GET"],
2026-02-20T22:09:17.4942866Z +        ),
2026-02-20T22:09:17.4943228Z          Route("/api/users/stats", endpoint=get_user_stats, methods=["GET"]),
2026-02-20T22:09:17.4943455Z -        Route("/api/users/leaderboard", endpoint=get_users_leaderboard, methods=["GET"]),
2026-02-20T22:09:17.4943519Z +        Route(
2026-02-20T22:09:17.4943716Z +            "/api/users/leaderboard", endpoint=get_users_leaderboard, methods=["GET"]
2026-02-20T22:09:17.4943777Z +        ),
2026-02-20T22:09:17.4943960Z          Route("/api/users/{user_id:int}", endpoint=delete_user, methods=["DELETE"]),
2026-02-20T22:09:17.4944022Z -        
2026-02-20T22:09:17.4944108Z          # ========================================
2026-02-20T22:09:17.4944190Z          # EXERCISES API (9 routes)
2026-02-20T22:09:17.4944268Z          # ========================================
2026-02-20T22:09:17.4944450Z          Route("/api/exercises", endpoint=get_exercises_list, methods=["GET"]),
2026-02-20T22:09:17.4944734Z -        Route("/api/exercises/stats", endpoint=get_exercises_stats, methods=["GET"]),  # Statistiques Holocron
2026-02-20T22:09:17.4945076Z -        Route("/api/exercises/{exercise_id:int}", endpoint=get_exercise, methods=["GET"]),
2026-02-20T22:09:17.4945146Z +        Route(
2026-02-20T22:09:17.4945418Z +            "/api/exercises/stats", endpoint=get_exercises_stats, methods=["GET"]
2026-02-20T22:09:17.4945502Z +        ),  # Statistiques Holocron
2026-02-20T22:09:17.4945567Z +        Route(
2026-02-20T22:09:17.4945762Z +            "/api/exercises/{exercise_id:int}", endpoint=get_exercise, methods=["GET"]
2026-02-20T22:09:17.4945824Z +        ),
2026-02-20T22:09:17.4946022Z          Route("/api/exercises/generate", endpoint=generate_exercise, methods=["GET"]),
2026-02-20T22:09:17.4946251Z -        Route("/api/exercises/generate", endpoint=generate_exercise_api, methods=["POST"]),
2026-02-20T22:09:17.4946528Z -        Route("/api/exercises/generate-ai-stream", endpoint=generate_ai_exercise_stream, methods=["GET"]),
2026-02-20T22:09:17.4946779Z -        Route("/api/exercises/completed-ids", endpoint=get_completed_exercises_ids, methods=["GET"]),
2026-02-20T22:09:17.4947050Z -        Route("/api/exercises/{exercise_id:int}/attempt", endpoint=submit_answer, methods=["POST"]),
2026-02-20T22:09:17.4947115Z -        
2026-02-20T22:09:17.4947178Z +        Route(
2026-02-20T22:09:17.4947380Z +            "/api/exercises/generate", endpoint=generate_exercise_api, methods=["POST"]
2026-02-20T22:09:17.4947440Z +        ),
2026-02-20T22:09:17.4947501Z +        Route(
2026-02-20T22:09:17.4947600Z +            "/api/exercises/generate-ai-stream",
2026-02-20T22:09:17.4947701Z +            endpoint=generate_ai_exercise_stream,
2026-02-20T22:09:17.4947773Z +            methods=["GET"],
2026-02-20T22:09:17.4947833Z +        ),
2026-02-20T22:09:17.4947897Z +        Route(
2026-02-20T22:09:17.4947989Z +            "/api/exercises/completed-ids",
2026-02-20T22:09:17.4948083Z +            endpoint=get_completed_exercises_ids,
2026-02-20T22:09:17.4948152Z +            methods=["GET"],
2026-02-20T22:09:17.4948222Z +        ),
2026-02-20T22:09:17.4948282Z +        Route(
2026-02-20T22:09:17.4948390Z +            "/api/exercises/{exercise_id:int}/attempt",
2026-02-20T22:09:17.4948477Z +            endpoint=submit_answer,
2026-02-20T22:09:17.4948552Z +            methods=["POST"],
2026-02-20T22:09:17.4948617Z +        ),
2026-02-20T22:09:17.4948695Z          # ========================================
2026-02-20T22:09:17.4948776Z          # BADGES API (5 routes)
2026-02-20T22:09:17.4948854Z          # ========================================
2026-02-20T22:09:17.4949021Z          Route("/api/badges/user", endpoint=get_user_badges, methods=["GET"]),
2026-02-20T22:09:17.4949226Z          Route("/api/badges/available", endpoint=get_available_badges, methods=["GET"]),
2026-02-20T22:09:17.4949406Z          Route("/api/badges/check", endpoint=check_user_badges, methods=["POST"]),
2026-02-20T22:09:17.4949613Z -        Route("/api/badges/stats", endpoint=get_user_gamification_stats, methods=["GET"]),
2026-02-20T22:09:17.4949685Z +        Route(
2026-02-20T22:09:17.4949868Z +            "/api/badges/stats", endpoint=get_user_gamification_stats, methods=["GET"]
2026-02-20T22:09:17.4949928Z +        ),
2026-02-20T22:09:17.4950111Z          Route("/api/badges/rarity", endpoint=get_badges_rarity, methods=["GET"]),
2026-02-20T22:09:17.4950304Z          Route("/api/badges/pin", endpoint=patch_pinned_badges, methods=["PATCH"]),
2026-02-20T22:09:17.4950554Z -        Route("/api/challenges/badges/progress", endpoint=get_user_badges_progress, methods=["GET"]),
2026-02-20T22:09:17.4950616Z -        
2026-02-20T22:09:17.4950683Z +        Route(
2026-02-20T22:09:17.4950781Z +            "/api/challenges/badges/progress",
2026-02-20T22:09:17.4950871Z +            endpoint=get_user_badges_progress,
2026-02-20T22:09:17.4950948Z +            methods=["GET"],
2026-02-20T22:09:17.4951009Z +        ),
2026-02-20T22:09:17.4951088Z          # ========================================
2026-02-20T22:09:17.4951347Z          # ADMIN API (rôle archiviste) — Mount pour éviter conflits de routage
2026-02-20T22:09:17.4951548Z          # ========================================
2026-02-20T22:09:17.4951612Z          Mount(
2026-02-20T22:09:17.4951684Z              "/api/admin",
2026-02-20T22:09:17.4951756Z              routes=[
2026-02-20T22:09:17.4951972Z                  Route("/health", endpoint=admin_health, methods=["GET"]),
2026-02-20T22:09:17.4952125Z                  Route("/overview", endpoint=admin_overview, methods=["GET"]),
2026-02-20T22:09:17.4952264Z                  Route("/users", endpoint=admin_users, methods=["GET"]),
2026-02-20T22:09:17.4952465Z -                Route("/users/{user_id:int}", endpoint=admin_users_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4952791Z -                Route("/users/{user_id:int}/send-reset-password", endpoint=admin_users_send_reset_password, methods=["POST"]),
2026-02-20T22:09:17.4953324Z -                Route("/users/{user_id:int}/resend-verification", endpoint=admin_users_resend_verification, methods=["POST"]),
2026-02-20T22:09:17.4953406Z +                Route(
2026-02-20T22:09:17.4953493Z +                    "/users/{user_id:int}",
2026-02-20T22:09:17.4953594Z +                    endpoint=admin_users_patch,
2026-02-20T22:09:17.4953680Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4953751Z +                ),
2026-02-20T22:09:17.4953818Z +                Route(
2026-02-20T22:09:17.4953951Z +                    "/users/{user_id:int}/send-reset-password",
2026-02-20T22:09:17.4954069Z +                    endpoint=admin_users_send_reset_password,
2026-02-20T22:09:17.4954149Z +                    methods=["POST"],
2026-02-20T22:09:17.4954218Z +                ),
2026-02-20T22:09:17.4954285Z +                Route(
2026-02-20T22:09:17.4954397Z +                    "/users/{user_id:int}/resend-verification",
2026-02-20T22:09:17.4954510Z +                    endpoint=admin_users_resend_verification,
2026-02-20T22:09:17.4954594Z +                    methods=["POST"],
2026-02-20T22:09:17.4954660Z +                ),
2026-02-20T22:09:17.4954828Z                  Route("/exercises", endpoint=admin_exercises, methods=["GET"]),
2026-02-20T22:09:17.4955014Z                  Route("/exercises", endpoint=admin_exercises_post, methods=["POST"]),
2026-02-20T22:09:17.4955311Z -                Route("/exercises/{exercise_id:int}/duplicate", endpoint=admin_exercises_duplicate, methods=["POST"]),
2026-02-20T22:09:17.4955538Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercise_get, methods=["GET"]),
2026-02-20T22:09:17.4955771Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercises_put, methods=["PUT"]),
2026-02-20T22:09:17.4956010Z -                Route("/exercises/{exercise_id:int}", endpoint=admin_exercises_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4956076Z +                Route(
2026-02-20T22:09:17.4956192Z +                    "/exercises/{exercise_id:int}/duplicate",
2026-02-20T22:09:17.4956298Z +                    endpoint=admin_exercises_duplicate,
2026-02-20T22:09:17.4956379Z +                    methods=["POST"],
2026-02-20T22:09:17.4956442Z +                ),
2026-02-20T22:09:17.4956514Z +                Route(
2026-02-20T22:09:17.4956609Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4956710Z +                    endpoint=admin_exercise_get,
2026-02-20T22:09:17.4956796Z +                    methods=["GET"],
2026-02-20T22:09:17.4956857Z +                ),
2026-02-20T22:09:17.4956924Z +                Route(
2026-02-20T22:09:17.4957025Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4957119Z +                    endpoint=admin_exercises_put,
2026-02-20T22:09:17.4957197Z +                    methods=["PUT"],
2026-02-20T22:09:17.4957259Z +                ),
2026-02-20T22:09:17.4957330Z +                Route(
2026-02-20T22:09:17.4957422Z +                    "/exercises/{exercise_id:int}",
2026-02-20T22:09:17.4957513Z +                    endpoint=admin_exercises_patch,
2026-02-20T22:09:17.4957737Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4957800Z +                ),
2026-02-20T22:09:17.4957969Z                  Route("/challenges", endpoint=admin_challenges, methods=["GET"]),
2026-02-20T22:09:17.4958261Z                  Route("/challenges", endpoint=admin_challenges_post, methods=["POST"]),
2026-02-20T22:09:17.4958567Z -                Route("/challenges/{challenge_id:int}/duplicate", endpoint=admin_challenges_duplicate, methods=["POST"]),
2026-02-20T22:09:17.4958802Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenge_get, methods=["GET"]),
2026-02-20T22:09:17.4959037Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenges_put, methods=["PUT"]),
2026-02-20T22:09:17.4959290Z -                Route("/challenges/{challenge_id:int}", endpoint=admin_challenges_patch, methods=["PATCH"]),
2026-02-20T22:09:17.4959354Z +                Route(
2026-02-20T22:09:17.4959469Z +                    "/challenges/{challenge_id:int}/duplicate",
2026-02-20T22:09:17.4959583Z +                    endpoint=admin_challenges_duplicate,
2026-02-20T22:09:17.4959659Z +                    methods=["POST"],
2026-02-20T22:09:17.4959720Z +                ),
2026-02-20T22:09:17.4959788Z +                Route(
2026-02-20T22:09:17.4959892Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4959986Z +                    endpoint=admin_challenge_get,
2026-02-20T22:09:17.4960062Z +                    methods=["GET"],
2026-02-20T22:09:17.4960127Z +                ),
2026-02-20T22:09:17.4960191Z +                Route(
2026-02-20T22:09:17.4960284Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4960383Z +                    endpoint=admin_challenges_put,
2026-02-20T22:09:17.4960460Z +                    methods=["PUT"],
2026-02-20T22:09:17.4960521Z +                ),
2026-02-20T22:09:17.4960590Z +                Route(
2026-02-20T22:09:17.4960683Z +                    "/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4960784Z +                    endpoint=admin_challenges_patch,
2026-02-20T22:09:17.4960861Z +                    methods=["PATCH"],
2026-02-20T22:09:17.4960928Z +                ),
2026-02-20T22:09:17.4961077Z                  Route("/reports", endpoint=admin_reports, methods=["GET"]),
2026-02-20T22:09:17.4961242Z                  Route("/audit-log", endpoint=admin_audit_log, methods=["GET"]),
2026-02-20T22:09:17.4961417Z                  Route("/moderation", endpoint=admin_moderation, methods=["GET"]),
2026-02-20T22:09:17.4961572Z                  Route("/config", endpoint=admin_config_get, methods=["GET"]),
2026-02-20T22:09:17.4961719Z                  Route("/config", endpoint=admin_config_put, methods=["PUT"]),
2026-02-20T22:09:17.4961867Z                  Route("/export", endpoint=admin_export, methods=["GET"]),
2026-02-20T22:09:17.4961948Z                  # Lot B-1 : CRUD badges
2026-02-20T22:09:17.4962084Z                  Route("/badges", endpoint=admin_badges, methods=["GET"]),
2026-02-20T22:09:17.4962247Z                  Route("/badges", endpoint=admin_badges_post, methods=["POST"]),
2026-02-20T22:09:17.4962441Z -                Route("/badges/{badge_id:int}", endpoint=admin_badge_get, methods=["GET"]),
2026-02-20T22:09:17.4962639Z -                Route("/badges/{badge_id:int}", endpoint=admin_badges_put, methods=["PUT"]),
2026-02-20T22:09:17.4962855Z -                Route("/badges/{badge_id:int}", endpoint=admin_badges_delete, methods=["DELETE"]),
2026-02-20T22:09:17.4962929Z +                Route(
2026-02-20T22:09:17.4963418Z +                    "/badges/{badge_id:int}", endpoint=admin_badge_get, methods=["GET"]
2026-02-20T22:09:17.4963494Z +                ),
2026-02-20T22:09:17.4963566Z +                Route(
2026-02-20T22:09:17.4963740Z +                    "/badges/{badge_id:int}", endpoint=admin_badges_put, methods=["PUT"]
2026-02-20T22:09:17.4963802Z +                ),
2026-02-20T22:09:17.4963872Z +                Route(
2026-02-20T22:09:17.4963962Z +                    "/badges/{badge_id:int}",
2026-02-20T22:09:17.4964204Z +                    endpoint=admin_badges_delete,
2026-02-20T22:09:17.4964284Z +                    methods=["DELETE"],
2026-02-20T22:09:17.4964351Z +                ),
2026-02-20T22:09:17.4964413Z              ],
2026-02-20T22:09:17.4964473Z          ),
2026-02-20T22:09:17.4964640Z -        
2026-02-20T22:09:17.4964725Z          # ========================================
2026-02-20T22:09:17.4964816Z          # RECOMMENDATIONS API (3 routes)
2026-02-20T22:09:17.4964896Z          # ========================================
2026-02-20T22:09:17.4965111Z          Route("/api/recommendations", endpoint=get_recommendations, methods=["GET"]),
2026-02-20T22:09:17.4965370Z -        Route("/api/recommendations/generate", endpoint=generate_recommendations, methods=["POST"]),
2026-02-20T22:09:17.4965650Z -        Route("/api/recommendations/complete", endpoint=handle_recommendation_complete, methods=["POST"]),
2026-02-20T22:09:17.4965718Z -        
2026-02-20T22:09:17.4965785Z +        Route(
2026-02-20T22:09:17.4965879Z +            "/api/recommendations/generate",
2026-02-20T22:09:17.4965982Z +            endpoint=generate_recommendations,
2026-02-20T22:09:17.4966058Z +            methods=["POST"],
2026-02-20T22:09:17.4966119Z +        ),
2026-02-20T22:09:17.4966190Z +        Route(
2026-02-20T22:09:17.4966288Z +            "/api/recommendations/complete",
2026-02-20T22:09:17.4966392Z +            endpoint=handle_recommendation_complete,
2026-02-20T22:09:17.4966465Z +            methods=["POST"],
2026-02-20T22:09:17.4966530Z +        ),
2026-02-20T22:09:17.4966609Z          # ========================================
2026-02-20T22:09:17.4966681Z          # CHAT API (2 routes)
2026-02-20T22:09:17.4966763Z          # ========================================
2026-02-20T22:09:17.4966898Z          Route("/api/chat", endpoint=chat_api, methods=["POST"]),
2026-02-20T22:09:17.4967072Z          Route("/api/chat/stream", endpoint=chat_api_stream, methods=["POST"]),
2026-02-20T22:09:17.4967138Z -        
2026-02-20T22:09:17.4967221Z          # ========================================
2026-02-20T22:09:17.4967452Z          # CHALLENGES API (10 routes) ⚠️ CRITIQUE pour Next.js
2026-02-20T22:09:17.4967532Z          # ========================================
2026-02-20T22:09:17.4967732Z          Route("/api/challenges", endpoint=get_challenges_list, methods=["GET"]),
2026-02-20T22:09:17.4967954Z -        Route("/api/challenges/{challenge_id:int}", endpoint=get_challenge, methods=["GET"]),
2026-02-20T22:09:17.4968243Z -        Route("/api/challenges/{challenge_id:int}/attempt", endpoint=submit_challenge_answer, methods=["POST"]),
2026-02-20T22:09:17.4968502Z -        Route("/api/challenges/{challenge_id:int}/hint", endpoint=get_challenge_hint, methods=["GET"]),
2026-02-20T22:09:17.4968762Z -        Route("/api/challenges/completed-ids", endpoint=get_completed_challenges_ids, methods=["GET"]),
2026-02-20T22:09:17.4969013Z -        Route("/api/challenges/start/{challenge_id:int}", endpoint=start_challenge, methods=["POST"]),
2026-02-20T22:09:17.4969307Z -        Route("/api/challenges/progress/{challenge_id:int}", endpoint=get_challenge_progress, methods=["GET"]),
2026-02-20T22:09:17.4969581Z -        Route("/api/challenges/rewards/{challenge_id:int}", endpoint=get_challenge_rewards, methods=["GET"]),
2026-02-20T22:09:17.4969866Z -        Route("/api/challenges/generate-ai-stream", endpoint=generate_ai_challenge_stream, methods=["GET"]),
2026-02-20T22:09:17.4969937Z +        Route(
2026-02-20T22:09:17.4970034Z +            "/api/challenges/{challenge_id:int}",
2026-02-20T22:09:17.4970117Z +            endpoint=get_challenge,
2026-02-20T22:09:17.4970194Z +            methods=["GET"],
2026-02-20T22:09:17.4970266Z +        ),
2026-02-20T22:09:17.4970328Z +        Route(
2026-02-20T22:09:17.4970441Z +            "/api/challenges/{challenge_id:int}/attempt",
2026-02-20T22:09:17.4970538Z +            endpoint=submit_challenge_answer,
2026-02-20T22:09:17.4970613Z +            methods=["POST"],
2026-02-20T22:09:17.4970758Z +        ),
2026-02-20T22:09:17.4970820Z +        Route(
2026-02-20T22:09:17.4970932Z +            "/api/challenges/{challenge_id:int}/hint",
2026-02-20T22:09:17.4971020Z +            endpoint=get_challenge_hint,
2026-02-20T22:09:17.4971093Z +            methods=["GET"],
2026-02-20T22:09:17.4971230Z +        ),
2026-02-20T22:09:17.4971293Z +        Route(
2026-02-20T22:09:17.4971387Z +            "/api/challenges/completed-ids",
2026-02-20T22:09:17.4971491Z +            endpoint=get_completed_challenges_ids,
2026-02-20T22:09:17.4971562Z +            methods=["GET"],
2026-02-20T22:09:17.4971623Z +        ),
2026-02-20T22:09:17.4971684Z +        Route(
2026-02-20T22:09:17.4971796Z +            "/api/challenges/start/{challenge_id:int}",
2026-02-20T22:09:17.4971877Z +            endpoint=start_challenge,
2026-02-20T22:09:17.4971948Z +            methods=["POST"],
2026-02-20T22:09:17.4972013Z +        ),
2026-02-20T22:09:17.4972074Z +        Route(
2026-02-20T22:09:17.4972193Z +            "/api/challenges/progress/{challenge_id:int}",
2026-02-20T22:09:17.4972287Z +            endpoint=get_challenge_progress,
2026-02-20T22:09:17.4972363Z +            methods=["GET"],
2026-02-20T22:09:17.4972423Z +        ),
2026-02-20T22:09:17.4972484Z +        Route(
2026-02-20T22:09:17.4972602Z +            "/api/challenges/rewards/{challenge_id:int}",
2026-02-20T22:09:17.4972690Z +            endpoint=get_challenge_rewards,
2026-02-20T22:09:17.4972760Z +            methods=["GET"],
2026-02-20T22:09:17.4972818Z +        ),
2026-02-20T22:09:17.4972886Z +        Route(
2026-02-20T22:09:17.4973193Z +            "/api/challenges/generate-ai-stream",
2026-02-20T22:09:17.4973361Z +            endpoint=generate_ai_challenge_stream,
2026-02-20T22:09:17.4973492Z +            methods=["GET"],
2026-02-20T22:09:17.4973594Z +        ),
2026-02-20T22:09:17.4973658Z      ]
2026-02-20T22:09:17.4973906Z would reformat /home/runner/work/mathakine/mathakine/server/routes.py
2026-02-20T22:09:17.5468338Z --- /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.5469733Z +++ /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py	2026-02-20 22:09:17.535433+00:00
2026-02-20T22:09:17.5470576Z @@ -1,479 +1,600 @@
2026-02-20T22:09:17.5471121Z  """
2026-02-20T22:09:17.5471727Z  Handlers pour la génération d'exercices (API)
2026-02-20T22:09:17.5472212Z  """
2026-02-20T22:09:17.5472459Z +
2026-02-20T22:09:17.5472762Z  import json
2026-02-20T22:09:17.5473339Z  import traceback
2026-02-20T22:09:17.5473666Z  
2026-02-20T22:09:17.5474004Z  from app.core.logging_config import get_logger
2026-02-20T22:09:17.5474425Z  
2026-02-20T22:09:17.5474669Z  logger = get_logger(__name__)
2026-02-20T22:09:17.5475042Z  from starlette.requests import Request
2026-02-20T22:09:17.5475610Z -from starlette.responses import (JSONResponse, RedirectResponse,
2026-02-20T22:09:17.5476230Z -                                 StreamingResponse)
2026-02-20T22:09:17.5476949Z +from starlette.responses import JSONResponse, RedirectResponse, StreamingResponse
2026-02-20T22:09:17.5477620Z  
2026-02-20T22:09:17.5477913Z  from app.core.config import settings
2026-02-20T22:09:17.5478347Z  from app.core.ai_config import AIConfig
2026-02-20T22:09:17.5478799Z  from app.core.messages import SystemMessages
2026-02-20T22:09:17.5479309Z  from app.models.exercise import ExerciseType
2026-02-20T22:09:17.5479756Z +
2026-02-20T22:09:17.5480038Z  # Import du service de badges
2026-02-20T22:09:17.5480546Z  from app.services.badge_service import BadgeService
2026-02-20T22:09:17.5481091Z  from app.utils.db_utils import db_session
2026-02-20T22:09:17.5481767Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:17.5482598Z  from app.utils.error_handler import ErrorHandler, get_safe_error_message
2026-02-20T22:09:17.5483536Z  from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:17.5483970Z -from server.exercise_generator import (ensure_explanation,
2026-02-20T22:09:17.5485064Z -                                       generate_ai_exercise,
2026-02-20T22:09:17.5485532Z -                                       generate_simple_exercise)
2026-02-20T22:09:17.5485838Z +from server.exercise_generator import (
2026-02-20T22:09:17.5486091Z +    ensure_explanation,
2026-02-20T22:09:17.5486448Z +    generate_ai_exercise,
2026-02-20T22:09:17.5486668Z +    generate_simple_exercise,
2026-02-20T22:09:17.5486875Z +)
2026-02-20T22:09:17.5487022Z  
2026-02-20T22:09:17.5487157Z  
2026-02-20T22:09:17.5487328Z  async def generate_exercise(request):
2026-02-20T22:09:17.5487802Z      """Génère un nouvel exercice en utilisant le groupe d'âge."""
2026-02-20T22:09:17.5488139Z      params = request.query_params
2026-02-20T22:09:17.5488493Z -    exercise_type_raw = params.get('type') or params.get('exercise_type')
2026-02-20T22:09:17.5488925Z -    age_group_raw = params.get('age_group') # Changed from difficulty
2026-02-20T22:09:17.5489265Z -    use_ai = params.get('ai', False)
2026-02-20T22:09:17.5489496Z -    
2026-02-20T22:09:17.5489759Z +    exercise_type_raw = params.get("type") or params.get("exercise_type")
2026-02-20T22:09:17.5490186Z +    age_group_raw = params.get("age_group")  # Changed from difficulty
2026-02-20T22:09:17.5490516Z +    use_ai = params.get("ai", False)
2026-02-20T22:09:17.5490743Z +
2026-02-20T22:09:17.5490967Z      # Normaliser et valider les paramètres
2026-02-20T22:09:17.5491246Z -    from server.exercise_generator import \
2026-02-20T22:09:17.5491521Z -        normalize_and_validate_exercise_params
2026-02-20T22:09:17.5491767Z -    
2026-02-20T22:09:17.5492194Z -    exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5492705Z -    
2026-02-20T22:09:17.5493207Z +    from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5493575Z +
2026-02-20T22:09:17.5493780Z +    exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5494171Z +        normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5494523Z +    )
2026-02-20T22:09:17.5494665Z +
2026-02-20T22:09:17.5494822Z      ai_generated = False
2026-02-20T22:09:17.5495094Z -    if use_ai and str(use_ai).lower() in ['true', '1', 'yes', 'y']:
2026-02-20T22:09:17.5495471Z +    if use_ai and str(use_ai).lower() in ["true", "1", "yes", "y"]:
2026-02-20T22:09:17.5495860Z          exercise_dict = generate_ai_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5496178Z          ai_generated = True
2026-02-20T22:09:17.5496381Z      else:
2026-02-20T22:09:17.5496633Z          exercise_dict = generate_simple_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5496953Z -        
2026-02-20T22:09:17.5497100Z +
2026-02-20T22:09:17.5497300Z      exercise_dict = ensure_explanation(exercise_dict)
2026-02-20T22:09:17.5497746Z      logger.debug(f"Explication générée: {exercise_dict['explanation']}")
2026-02-20T22:09:17.5498077Z      try:
2026-02-20T22:09:17.5498254Z          # Extraire la locale
2026-02-20T22:09:17.5498534Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5498827Z +
2026-02-20T22:09:17.5499054Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5499431Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5499709Z -        
2026-02-20T22:09:17.5499860Z +
2026-02-20T22:09:17.5500048Z          async with db_session() as db:
2026-02-20T22:09:17.5500446Z              # Sauvegarder l'exercice avec age_group et la difficulté dérivée
2026-02-20T22:09:17.5500893Z              created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5501239Z                  db=db,
2026-02-20T22:09:17.5501480Z -                exercise_type=exercise_dict['exercise_type'],
2026-02-20T22:09:17.5501823Z -                age_group=exercise_dict['age_group'], # Save age_group
2026-02-20T22:09:17.5502229Z -                difficulty=exercise_dict['difficulty'], # Save derived difficulty
2026-02-20T22:09:17.5502751Z -                title=exercise_dict['title'],
2026-02-20T22:09:17.5503208Z -                question=exercise_dict['question'],
2026-02-20T22:09:17.5503530Z -                correct_answer=exercise_dict['correct_answer'],
2026-02-20T22:09:17.5503956Z -                choices=exercise_dict['choices'],
2026-02-20T22:09:17.5504259Z -                explanation=exercise_dict['explanation'],
2026-02-20T22:09:17.5504549Z -                hint=exercise_dict.get('hint'),
2026-02-20T22:09:17.5504839Z -                tags=exercise_dict.get('tags', 'generated'),
2026-02-20T22:09:17.5505156Z +                exercise_type=exercise_dict["exercise_type"],
2026-02-20T22:09:17.5505499Z +                age_group=exercise_dict["age_group"],  # Save age_group
2026-02-20T22:09:17.5505905Z +                difficulty=exercise_dict["difficulty"],  # Save derived difficulty
2026-02-20T22:09:17.5506266Z +                title=exercise_dict["title"],
2026-02-20T22:09:17.5506542Z +                question=exercise_dict["question"],
2026-02-20T22:09:17.5506840Z +                correct_answer=exercise_dict["correct_answer"],
2026-02-20T22:09:17.5507140Z +                choices=exercise_dict["choices"],
2026-02-20T22:09:17.5507427Z +                explanation=exercise_dict["explanation"],
2026-02-20T22:09:17.5507717Z +                hint=exercise_dict.get("hint"),
2026-02-20T22:09:17.5507998Z +                tags=exercise_dict.get("tags", "generated"),
2026-02-20T22:09:17.5508284Z                  ai_generated=ai_generated,
2026-02-20T22:09:17.5508530Z -                locale=locale
2026-02-20T22:09:17.5508735Z +                locale=locale,
2026-02-20T22:09:17.5508936Z              )
2026-02-20T22:09:17.5509109Z              if created_exercise:
2026-02-20T22:09:17.5509353Z -                exercise_id = created_exercise['id']
2026-02-20T22:09:17.5509628Z +                exercise_id = created_exercise["id"]
2026-02-20T22:09:17.5510031Z                  logger.info(f"Nouvel exercice créé avec ID={exercise_id}")
2026-02-20T22:09:17.5510440Z                  logger.debug(f"Explication: {exercise_dict['explanation']}")
2026-02-20T22:09:17.5510753Z              else:
2026-02-20T22:09:17.5511045Z                  logger.error("Erreur: L'exercice n'a pas été créé")
2026-02-20T22:09:17.5511381Z                  templates = request.app.state.templates
2026-02-20T22:09:17.5511716Z -                return templates.TemplateResponse("error.html", {
2026-02-20T22:09:17.5512015Z -                    "request": request,
2026-02-20T22:09:17.5512320Z -                    "error": "Erreur de génération",
2026-02-20T22:09:17.5512748Z -                    "message": "Impossible de créer l'exercice dans la base de données."
2026-02-20T22:09:17.5513397Z -                }, status_code=500)
2026-02-20T22:09:17.5513679Z +                return templates.TemplateResponse(
2026-02-20T22:09:17.5513954Z +                    "error.html",
2026-02-20T22:09:17.5514173Z +                    {
2026-02-20T22:09:17.5514376Z +                        "request": request,
2026-02-20T22:09:17.5514703Z +                        "error": "Erreur de génération",
2026-02-20T22:09:17.5515147Z +                        "message": "Impossible de créer l'exercice dans la base de données.",
2026-02-20T22:09:17.5515512Z +                    },
2026-02-20T22:09:17.5515711Z +                    status_code=500,
2026-02-20T22:09:17.5515927Z +                )
2026-02-20T22:09:17.5516230Z          return RedirectResponse(url="/exercises?generated=true", status_code=303)
2026-02-20T22:09:17.5516632Z      except Exception as exercise_generation_error:
2026-02-20T22:09:17.5517126Z -        logger.error(f"Erreur lors de la génération d'exercice: {exercise_generation_error}")
2026-02-20T22:09:17.5517519Z +        logger.error(
2026-02-20T22:09:17.5517880Z +            f"Erreur lors de la génération d'exercice: {exercise_generation_error}"
2026-02-20T22:09:17.5518221Z +        )
2026-02-20T22:09:17.5518405Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5518846Z          templates = request.app.state.templates
2026-02-20T22:09:17.5519163Z -        return templates.TemplateResponse("error.html", {
2026-02-20T22:09:17.5519464Z -            "request": request,
2026-02-20T22:09:17.5519845Z -            "error": "Erreur de génération",
2026-02-20T22:09:17.5520302Z -            "message": f"Impossible de générer l'exercice: {str(exercise_generation_error)}"
2026-02-20T22:09:17.5520683Z -        }, status_code=500)
2026-02-20T22:09:17.5520926Z +        return templates.TemplateResponse(
2026-02-20T22:09:17.5521185Z +            "error.html",
2026-02-20T22:09:17.5521372Z +            {
2026-02-20T22:09:17.5521552Z +                "request": request,
2026-02-20T22:09:17.5521840Z +                "error": "Erreur de génération",
2026-02-20T22:09:17.5522305Z +                "message": f"Impossible de générer l'exercice: {str(exercise_generation_error)}",
2026-02-20T22:09:17.5522672Z +            },
2026-02-20T22:09:17.5522857Z +            status_code=500,
2026-02-20T22:09:17.5523263Z +        )
2026-02-20T22:09:17.5523427Z +
2026-02-20T22:09:17.5523567Z  
2026-02-20T22:09:17.5523727Z  async def get_exercise(request):
2026-02-20T22:09:17.5524112Z      """Récupère un exercice par son ID avec support des traductions"""
2026-02-20T22:09:17.5524507Z -    exercise_id = request.path_params.get('exercise_id')
2026-02-20T22:09:17.5524850Z +    exercise_id = request.path_params.get("exercise_id")
2026-02-20T22:09:17.5525114Z  
2026-02-20T22:09:17.5525256Z      try:
2026-02-20T22:09:17.5525475Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5525840Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5526129Z +
2026-02-20T22:09:17.5526361Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5526729Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5527008Z -        
2026-02-20T22:09:17.5527170Z +
2026-02-20T22:09:17.5527350Z          # Utiliser le service ORM ExerciseService
2026-02-20T22:09:17.5527630Z          async with db_session() as db:
2026-02-20T22:09:17.5527901Z              from app.models.exercise import Exercise
2026-02-20T22:09:17.5528226Z              from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:17.5528531Z              from sqlalchemy import String, cast
2026-02-20T22:09:17.5528778Z  
2026-02-20T22:09:17.5529173Z              # IMPORTANT: Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:17.5529837Z              # SQLAlchemy essaie de convertir automatiquement et échoue si la DB contient des minuscules
2026-02-20T22:09:17.5530460Z              # Solution: Utiliser cast() pour forcer le chargement en string dès le début
2026-02-20T22:09:17.5530835Z -            exercise_row = db.query(
2026-02-20T22:09:17.5531076Z -                Exercise.id,
2026-02-20T22:09:17.5531287Z -                Exercise.title,
2026-02-20T22:09:17.5531520Z -                Exercise.question,
2026-02-20T22:09:17.5531759Z -                Exercise.correct_answer,
2026-02-20T22:09:17.5532006Z -                Exercise.choices,
2026-02-20T22:09:17.5532243Z -                Exercise.explanation,
2026-02-20T22:09:17.5532477Z -                Exercise.hint,
2026-02-20T22:09:17.5532698Z -                Exercise.tags,
2026-02-20T22:09:17.5532910Z -                Exercise.ai_generated,
2026-02-20T22:09:17.5533393Z -                Exercise.age_group,
2026-02-20T22:09:17.5533721Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5534145Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:17.5534503Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:17.5534764Z -            
2026-02-20T22:09:17.5534945Z +            exercise_row = (
2026-02-20T22:09:17.5535146Z +                db.query(
2026-02-20T22:09:17.5535350Z +                    Exercise.id,
2026-02-20T22:09:17.5535714Z +                    Exercise.title,
2026-02-20T22:09:17.5535950Z +                    Exercise.question,
2026-02-20T22:09:17.5536195Z +                    Exercise.correct_answer,
2026-02-20T22:09:17.5536447Z +                    Exercise.choices,
2026-02-20T22:09:17.5536792Z +                    Exercise.explanation,
2026-02-20T22:09:17.5537037Z +                    Exercise.hint,
2026-02-20T22:09:17.5537269Z +                    Exercise.tags,
2026-02-20T22:09:17.5537496Z +                    Exercise.ai_generated,
2026-02-20T22:09:17.5537741Z +                    Exercise.age_group,
2026-02-20T22:09:17.5538077Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5538520Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5538843Z +                )
2026-02-20T22:09:17.5539045Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:17.5539302Z +                .first()
2026-02-20T22:09:17.5539486Z +            )
2026-02-20T22:09:17.5539643Z +
2026-02-20T22:09:17.5539795Z              if not exercise_row:
2026-02-20T22:09:17.5540215Z -                return ErrorHandler.create_not_found_error(resource_type="Exercice", resource_id=exercise_id)
2026-02-20T22:09:17.5540650Z -            
2026-02-20T22:09:17.5540866Z +                return ErrorHandler.create_not_found_error(
2026-02-20T22:09:17.5541199Z +                    resource_type="Exercice", resource_id=exercise_id
2026-02-20T22:09:17.5541478Z +                )
2026-02-20T22:09:17.5541639Z +
2026-02-20T22:09:17.5541787Z              exercise = {
2026-02-20T22:09:17.5541991Z                  "id": exercise_row.id,
2026-02-20T22:09:17.5542229Z                  "title": exercise_row.title,
2026-02-20T22:09:17.5542718Z -                "exercise_type": exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION",
2026-02-20T22:09:17.5543655Z -                "difficulty": exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN",
2026-02-20T22:09:17.5544119Z +                "exercise_type": (
2026-02-20T22:09:17.5544381Z +                    exercise_row.exercise_type_str.upper()
2026-02-20T22:09:17.5544678Z +                    if exercise_row.exercise_type_str
2026-02-20T22:09:17.5544944Z +                    else "ADDITION"
2026-02-20T22:09:17.5545155Z +                ),
2026-02-20T22:09:17.5545340Z +                "difficulty": (
2026-02-20T22:09:17.5545582Z +                    exercise_row.difficulty_str.upper()
2026-02-20T22:09:17.5545866Z +                    if exercise_row.difficulty_str
2026-02-20T22:09:17.5546126Z +                    else "PADAWAN"
2026-02-20T22:09:17.5546335Z +                ),
2026-02-20T22:09:17.5546537Z                  "age_group": exercise_row.age_group,
2026-02-20T22:09:17.5546809Z                  "question": exercise_row.question,
2026-02-20T22:09:17.5547380Z                  # correct_answer volontairement omis pour éviter la triche (renvoyé uniquement après soumission)
2026-02-20T22:09:17.5547897Z                  "choices": safe_parse_json(exercise_row.choices, []),
2026-02-20T22:09:17.5548235Z                  "explanation": exercise_row.explanation,
2026-02-20T22:09:17.5548512Z                  "hint": exercise_row.hint,
2026-02-20T22:09:17.5548805Z                  "tags": safe_parse_json(exercise_row.tags, []),
2026-02-20T22:09:17.5549138Z -                "ai_generated": exercise_row.ai_generated or False
2026-02-20T22:09:17.5549489Z +                "ai_generated": exercise_row.ai_generated or False,
2026-02-20T22:09:17.5549773Z              }
2026-02-20T22:09:17.5549931Z -        
2026-02-20T22:09:17.5550083Z +
2026-02-20T22:09:17.5550234Z          if not exercise:
2026-02-20T22:09:17.5550613Z -            return JSONResponse({"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404)
2026-02-20T22:09:17.5551032Z -                
2026-02-20T22:09:17.5551215Z +            return JSONResponse(
2026-02-20T22:09:17.5551679Z +                {"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404
2026-02-20T22:09:17.5552014Z +            )
2026-02-20T22:09:17.5552176Z +
2026-02-20T22:09:17.5552341Z          return JSONResponse(exercise)
2026-02-20T22:09:17.5552565Z -    
2026-02-20T22:09:17.5552710Z +
2026-02-20T22:09:17.5553126Z      except Exception as exercise_retrieval_error:
2026-02-20T22:09:17.5553649Z -        logger.error(f"Erreur lors de la récupération de l'exercice: {exercise_retrieval_error}")
2026-02-20T22:09:17.5554058Z +        logger.error(
2026-02-20T22:09:17.5554424Z +            f"Erreur lors de la récupération de l'exercice: {exercise_retrieval_error}"
2026-02-20T22:09:17.5554769Z +        )
2026-02-20T22:09:17.5554957Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5555677Z -        return ErrorHandler.create_error_response(exercise_retrieval_error, status_code=500, user_message="Erreur lors de la récupération de l'exercice")
2026-02-20T22:09:17.5556325Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5556599Z +            exercise_retrieval_error,
2026-02-20T22:09:17.5556834Z +            status_code=500,
2026-02-20T22:09:17.5557178Z +            user_message="Erreur lors de la récupération de l'exercice",
2026-02-20T22:09:17.5557482Z +        )
2026-02-20T22:09:17.5557644Z +
2026-02-20T22:09:17.5557779Z  
2026-02-20T22:09:17.5557926Z  @require_auth
2026-02-20T22:09:17.5558105Z  async def submit_answer(request):
2026-02-20T22:09:17.5558434Z      """Traite la soumission d'une réponse à un exercice"""
2026-02-20T22:09:17.5558706Z      try:
2026-02-20T22:09:17.5558990Z          # Utilisateur authentifié via le décorateur @require_auth
2026-02-20T22:09:17.5559314Z          current_user = request.state.user
2026-02-20T22:09:17.5559545Z -        
2026-02-20T22:09:17.5572327Z +
2026-02-20T22:09:17.5572692Z          # Récupérer les données de la requête
2026-02-20T22:09:17.5573154Z          data = await request.json()
2026-02-20T22:09:17.5573616Z -        exercise_id = int(request.path_params.get('exercise_id')) # Get from path_params
2026-02-20T22:09:17.5574178Z -        selected_answer = data.get('answer') or data.get('selected_answer')  # Support both formats
2026-02-20T22:09:17.5574641Z -        time_spent = data.get('time_spent', 0)
2026-02-20T22:09:17.5575165Z -        user_id = current_user.get('id', 1)  # Utiliser l'ID de l'utilisateur authentifié
2026-02-20T22:09:17.5575547Z +        exercise_id = int(
2026-02-20T22:09:17.5575789Z +            request.path_params.get("exercise_id")
2026-02-20T22:09:17.5576057Z +        )  # Get from path_params
2026-02-20T22:09:17.5576329Z +        selected_answer = data.get("answer") or data.get(
2026-02-20T22:09:17.5576614Z +            "selected_answer"
2026-02-20T22:09:17.5576826Z +        )  # Support both formats
2026-02-20T22:09:17.5577064Z +        time_spent = data.get("time_spent", 0)
2026-02-20T22:09:17.5577327Z +        user_id = current_user.get(
2026-02-20T22:09:17.5577547Z +            "id", 1
2026-02-20T22:09:17.5577807Z +        )  # Utiliser l'ID de l'utilisateur authentifié
2026-02-20T22:09:17.5578068Z  
2026-02-20T22:09:17.5578279Z          # Valider les paramètres requis
2026-02-20T22:09:17.5578815Z          # exercise_id est maintenant garanti par le path_params, donc pas besoin de vérifier s'il est None
2026-02-20T22:09:17.5579243Z -        
2026-02-20T22:09:17.5579396Z +
2026-02-20T22:09:17.5579549Z          if selected_answer is None:
2026-02-20T22:09:17.5579788Z -            return JSONResponse(
2026-02-20T22:09:17.5580088Z -                {"error": "La réponse est requise."},
2026-02-20T22:09:17.5580364Z -                status_code=400
2026-02-20T22:09:17.5580573Z -            )
2026-02-20T22:09:17.5580730Z -
2026-02-20T22:09:17.5581194Z -        logger.debug(f"Traitement de la réponse: exercise_id={exercise_id}, selected_answer={selected_answer}")
2026-02-20T22:09:17.5581842Z +            return JSONResponse({"error": "La réponse est requise."}, status_code=400)
2026-02-20T22:09:17.5582394Z +
2026-02-20T22:09:17.5582539Z +        logger.debug(
2026-02-20T22:09:17.5583099Z +            f"Traitement de la réponse: exercise_id={exercise_id}, selected_answer={selected_answer}"
2026-02-20T22:09:17.5583515Z +        )
2026-02-20T22:09:17.5583671Z  
2026-02-20T22:09:17.5584013Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5584392Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5584691Z +
2026-02-20T22:09:17.5584917Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5585287Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5585569Z -        
2026-02-20T22:09:17.5585726Z +
2026-02-20T22:09:17.5586060Z          # Utiliser le service ORM ExerciseService (une seule session pour lecture + tentative + badges)
2026-02-20T22:09:17.5586502Z          async with db_session() as db:
2026-02-20T22:09:17.5586766Z              from sqlalchemy import String, cast
2026-02-20T22:09:17.5587011Z  
2026-02-20T22:09:17.5587251Z -            from app.models.exercise import (DifficultyLevel, Exercise,
2026-02-20T22:09:17.5587598Z -                                             ExerciseType)
2026-02-20T22:09:17.5587989Z +            from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:17.5588334Z  
2026-02-20T22:09:17.5588724Z              # IMPORTANT: Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:17.5589139Z -            exercise_row = db.query(
2026-02-20T22:09:17.5589369Z -                Exercise.id,
2026-02-20T22:09:17.5589584Z -                Exercise.question,
2026-02-20T22:09:17.5589816Z -                Exercise.correct_answer,
2026-02-20T22:09:17.5590060Z -                Exercise.choices,
2026-02-20T22:09:17.5590289Z -                Exercise.explanation,
2026-02-20T22:09:17.5590621Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5591041Z -                cast(Exercise.difficulty, String).label('difficulty_str')
2026-02-20T22:09:17.5591399Z -            ).filter(Exercise.id == exercise_id).first()
2026-02-20T22:09:17.5591664Z -            
2026-02-20T22:09:17.5591863Z +            exercise_row = (
2026-02-20T22:09:17.5592079Z +                db.query(
2026-02-20T22:09:17.5592271Z +                    Exercise.id,
2026-02-20T22:09:17.5592495Z +                    Exercise.question,
2026-02-20T22:09:17.5592735Z +                    Exercise.correct_answer,
2026-02-20T22:09:17.5593177Z +                    Exercise.choices,
2026-02-20T22:09:17.5593458Z +                    Exercise.explanation,
2026-02-20T22:09:17.5593805Z +                    cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5594241Z +                    cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5594564Z +                )
2026-02-20T22:09:17.5594774Z +                .filter(Exercise.id == exercise_id)
2026-02-20T22:09:17.5595027Z +                .first()
2026-02-20T22:09:17.5595208Z +            )
2026-02-20T22:09:17.5595361Z +
2026-02-20T22:09:17.5595514Z              if not exercise_row:
2026-02-20T22:09:17.5595917Z -                return JSONResponse({"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404)
2026-02-20T22:09:17.5596335Z -            
2026-02-20T22:09:17.5596516Z +                return JSONResponse(
2026-02-20T22:09:17.5596847Z +                    {"error": SystemMessages.ERROR_EXERCISE_NOT_FOUND}, status_code=404
2026-02-20T22:09:17.5597190Z +                )
2026-02-20T22:09:17.5597350Z +
2026-02-20T22:09:17.5597537Z              # Normaliser les valeurs enum en majuscules
2026-02-20T22:09:17.5598062Z -            exercise_type_normalized = exercise_row.exercise_type_str.upper() if exercise_row.exercise_type_str else "ADDITION"
2026-02-20T22:09:17.5598811Z -            difficulty_normalized = exercise_row.difficulty_str.upper() if exercise_row.difficulty_str else "PADAWAN"
2026-02-20T22:09:17.5599416Z -            
2026-02-20T22:09:17.5599589Z +            exercise_type_normalized = (
2026-02-20T22:09:17.5599866Z +                exercise_row.exercise_type_str.upper()
2026-02-20T22:09:17.5600186Z +                if exercise_row.exercise_type_str
2026-02-20T22:09:17.5600591Z +                else "ADDITION"
2026-02-20T22:09:17.5600793Z +            )
2026-02-20T22:09:17.5600974Z +            difficulty_normalized = (
2026-02-20T22:09:17.5601227Z +                exercise_row.difficulty_str.upper()
2026-02-20T22:09:17.5601507Z +                if exercise_row.difficulty_str
2026-02-20T22:09:17.5601767Z +                else "PADAWAN"
2026-02-20T22:09:17.5601969Z +            )
2026-02-20T22:09:17.5602132Z +
2026-02-20T22:09:17.5602289Z              exercise = {
2026-02-20T22:09:17.5602491Z                  "id": exercise_row.id,
2026-02-20T22:09:17.5602769Z                  "exercise_type": exercise_type_normalized,
2026-02-20T22:09:17.5603186Z                  "difficulty": difficulty_normalized,
2026-02-20T22:09:17.5603503Z                  "correct_answer": exercise_row.correct_answer,
2026-02-20T22:09:17.5603804Z                  "choices": exercise_row.choices,
2026-02-20T22:09:17.5604073Z                  "question": exercise_row.question,
2026-02-20T22:09:17.5604373Z -                "explanation": exercise_row.explanation
2026-02-20T22:09:17.5604668Z +                "explanation": exercise_row.explanation,
2026-02-20T22:09:17.5604925Z              }
2026-02-20T22:09:17.5605078Z  
2026-02-20T22:09:17.5605333Z              # Déterminer si la réponse est correcte
2026-02-20T22:09:17.5605588Z              is_correct = False
2026-02-20T22:09:17.5605785Z -            
2026-02-20T22:09:17.5605941Z +
2026-02-20T22:09:17.5606148Z              # Vérifier que correct_answer existe
2026-02-20T22:09:17.5606451Z -            correct_answer = exercise.get('correct_answer')
2026-02-20T22:09:17.5606768Z +            correct_answer = exercise.get("correct_answer")
2026-02-20T22:09:17.5607054Z              if not correct_answer:
2026-02-20T22:09:17.5607403Z -                logger.error(f"ERREUR: L'exercice {exercise_id} n'a pas de correct_answer")
2026-02-20T22:09:17.5607792Z +                logger.error(
2026-02-20T22:09:17.5608089Z +                    f"ERREUR: L'exercice {exercise_id} n'a pas de correct_answer"
2026-02-20T22:09:17.5608412Z +                )
2026-02-20T22:09:17.5608642Z                  return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5609066Z                      ValueError("L'exercice n'a pas de réponse correcte définie"),
2026-02-20T22:09:17.5609403Z                      status_code=500,
2026-02-20T22:09:17.5609776Z -                    user_message="L'exercice n'a pas de réponse correcte définie."
2026-02-20T22:09:17.5610103Z -                )
2026-02-20T22:09:17.5610265Z -            
2026-02-20T22:09:17.5610589Z +                    user_message="L'exercice n'a pas de réponse correcte définie.",
2026-02-20T22:09:17.5610913Z +                )
2026-02-20T22:09:17.5611074Z +
2026-02-20T22:09:17.5611419Z              # Types d'exercices qui devraient avoir une comparaison insensible à la casse
2026-02-20T22:09:17.5611906Z              text_based_types = [ExerciseType.TEXTE.value, ExerciseType.MIXTE.value]
2026-02-20T22:09:17.5612338Z -            exercise_type_str = exercise.get('exercise_type', '')
2026-02-20T22:09:17.5612622Z -            
2026-02-20T22:09:17.5612846Z +            exercise_type_str = exercise.get("exercise_type", "")
2026-02-20T22:09:17.5613344Z +
2026-02-20T22:09:17.5613721Z              # Pour les types de questions textuelles, la comparaison est insensible à la casse
2026-02-20T22:09:17.5614140Z              if exercise_type_str in text_based_types:
2026-02-20T22:09:17.5614568Z -                is_correct = str(selected_answer).lower().strip() == str(correct_answer).lower().strip()
2026-02-20T22:09:17.5614982Z +                is_correct = (
2026-02-20T22:09:17.5615216Z +                    str(selected_answer).lower().strip()
2026-02-20T22:09:17.5615655Z +                    == str(correct_answer).lower().strip()
2026-02-20T22:09:17.5615903Z +                )
2026-02-20T22:09:17.5616066Z              else:
2026-02-20T22:09:17.5616390Z                  # Pour les questions numériques et autres, comparaison stricte
2026-02-20T22:09:17.5616921Z                  is_correct = str(selected_answer).strip() == str(correct_answer).strip()
2026-02-20T22:09:17.5617271Z -                
2026-02-20T22:09:17.5617747Z -            logger.debug(f"Réponse correcte? {is_correct} (selected: '{selected_answer}', correct: '{correct_answer}')")
2026-02-20T22:09:17.5618206Z +
2026-02-20T22:09:17.5618355Z +            logger.debug(
2026-02-20T22:09:17.5618806Z +                f"Réponse correcte? {is_correct} (selected: '{selected_answer}', correct: '{correct_answer}')"
2026-02-20T22:09:17.5619219Z +            )
2026-02-20T22:09:17.5619369Z  
2026-02-20T22:09:17.5619572Z              # Enregistrer la tentative avec PostgreSQL direct
2026-02-20T22:09:17.5619853Z              try:
2026-02-20T22:09:17.5620107Z                  # Préparer les données de la tentative
2026-02-20T22:09:17.5620367Z                  attempt_data = {
2026-02-20T22:09:17.5620589Z                      "user_id": user_id,
2026-02-20T22:09:17.5620833Z                      "exercise_id": exercise_id,
2026-02-20T22:09:17.5621117Z                      "user_answer": selected_answer,
2026-02-20T22:09:17.5621384Z                      "is_correct": is_correct,
2026-02-20T22:09:17.5621634Z -                    "time_spent": time_spent
2026-02-20T22:09:17.5621889Z +                    "time_spent": time_spent,
2026-02-20T22:09:17.5622114Z                  }
2026-02-20T22:09:17.5622276Z -                
2026-02-20T22:09:17.5622598Z -                logger.debug(f"Tentative d'enregistrement avec attempt_data: {attempt_data}")
2026-02-20T22:09:17.5623086Z +
2026-02-20T22:09:17.5623239Z +                logger.debug(
2026-02-20T22:09:17.5623542Z +                    f"Tentative d'enregistrement avec attempt_data: {attempt_data}"
2026-02-20T22:09:17.5623879Z +                )
2026-02-20T22:09:17.5624119Z                  # Utiliser le service ORM ExerciseService.record_attempt
2026-02-20T22:09:17.5624514Z                  from app.services.exercise_service import ExerciseService
2026-02-20T22:09:17.5624819Z +
2026-02-20T22:09:17.5625068Z                  attempt_obj = ExerciseService.record_attempt(db, attempt_data)
2026-02-20T22:09:17.5625534Z                  logger.debug(f"Résultat de record_attempt: {attempt_obj}")
2026-02-20T22:09:17.5625850Z -                
2026-02-20T22:09:17.5626014Z +
2026-02-20T22:09:17.5626312Z                  # Convertir l'objet Attempt en dictionnaire pour la réponse
2026-02-20T22:09:17.5626639Z                  if attempt_obj:
2026-02-20T22:09:17.5626851Z                      attempt = {
2026-02-20T22:09:17.5627075Z                          "id": attempt_obj.id,
2026-02-20T22:09:17.5627340Z                          "user_id": attempt_obj.user_id,
2026-02-20T22:09:17.5627641Z                          "exercise_id": attempt_obj.exercise_id,
2026-02-20T22:09:17.5627941Z                          "user_answer": attempt_obj.user_answer,
2026-02-20T22:09:17.5628246Z                          "is_correct": attempt_obj.is_correct,
2026-02-20T22:09:17.5628550Z                          "time_spent": attempt_obj.time_spent,
2026-02-20T22:09:17.5628987Z -                        "created_at": attempt_obj.created_at.isoformat() if attempt_obj.created_at else None
2026-02-20T22:09:17.5629408Z +                        "created_at": (
2026-02-20T22:09:17.5629672Z +                            attempt_obj.created_at.isoformat()
2026-02-20T22:09:17.5629966Z +                            if attempt_obj.created_at
2026-02-20T22:09:17.5630217Z +                            else None
2026-02-20T22:09:17.5630439Z +                        ),
2026-02-20T22:09:17.5630630Z                      }
2026-02-20T22:09:17.5630800Z                  else:
2026-02-20T22:09:17.5630992Z                      attempt = None
2026-02-20T22:09:17.5631323Z -                
2026-02-20T22:09:17.5631488Z +
2026-02-20T22:09:17.5631642Z                  if not attempt:
2026-02-20T22:09:17.5632062Z -                    logger.error("ERREUR: La tentative n'a pas été enregistrée correctement")
2026-02-20T22:09:17.5632559Z -                    return JSONResponse({
2026-02-20T22:09:17.5632824Z -                        "is_correct": is_correct,
2026-02-20T22:09:17.5633202Z -                        "correct_answer": correct_answer,
2026-02-20T22:09:17.5633526Z -                        "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5633906Z -                        "error": "Erreur lors de l'enregistrement de la tentative"
2026-02-20T22:09:17.5634235Z -                    }, status_code=500)
2026-02-20T22:09:17.5634455Z -                
2026-02-20T22:09:17.5634630Z +                    logger.error(
2026-02-20T22:09:17.5635004Z +                        "ERREUR: La tentative n'a pas été enregistrée correctement"
2026-02-20T22:09:17.5635330Z +                    )
2026-02-20T22:09:17.5635521Z +                    return JSONResponse(
2026-02-20T22:09:17.5635751Z +                        {
2026-02-20T22:09:17.5635958Z +                            "is_correct": is_correct,
2026-02-20T22:09:17.5636245Z +                            "correct_answer": correct_answer,
2026-02-20T22:09:17.5636562Z +                            "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5636953Z +                            "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5637277Z +                        },
2026-02-20T22:09:17.5637481Z +                        status_code=500,
2026-02-20T22:09:17.5637703Z +                    )
2026-02-20T22:09:17.5637866Z +
2026-02-20T22:09:17.5638131Z                  logger.info("Tentative enregistrée avec succès")
2026-02-20T22:09:17.5638404Z  
2026-02-20T22:09:17.5638723Z                  # 🎖️ NOUVEAU: Vérifier et attribuer les badges (même session)
2026-02-20T22:09:17.5639052Z                  new_badges = []
2026-02-20T22:09:17.5639261Z                  try:
2026-02-20T22:09:17.5639464Z                      badge_service = BadgeService(db)
2026-02-20T22:09:17.5639712Z -                
2026-02-20T22:09:17.5639870Z +
2026-02-20T22:09:17.5640127Z                      # Préparer les données de la tentative pour l'évaluation des badges
2026-02-20T22:09:17.5640212Z                      attempt_for_badges = {
2026-02-20T22:09:17.5640343Z -                        "exercise_type": exercise.get('exercise_type'),
2026-02-20T22:09:17.5640473Z +                        "exercise_type": exercise.get("exercise_type"),
2026-02-20T22:09:17.5640562Z                          "is_correct": is_correct,
2026-02-20T22:09:17.5640651Z                          "time_spent": time_spent,
2026-02-20T22:09:17.5640748Z                          "exercise_id": exercise_id,
2026-02-20T22:09:17.5641049Z -                        "created_at": attempt_obj.created_at.isoformat() if attempt_obj and attempt_obj.created_at else None,
2026-02-20T22:09:17.5641135Z +                        "created_at": (
2026-02-20T22:09:17.5641250Z +                            attempt_obj.created_at.isoformat()
2026-02-20T22:09:17.5641367Z +                            if attempt_obj and attempt_obj.created_at
2026-02-20T22:09:17.5641447Z +                            else None
2026-02-20T22:09:17.5641516Z +                        ),
2026-02-20T22:09:17.5641584Z                      }
2026-02-20T22:09:17.5641648Z -                    
2026-02-20T22:09:17.5641705Z +
2026-02-20T22:09:17.5641875Z                      # Vérifier et attribuer les nouveaux badges
2026-02-20T22:09:17.5642103Z -                    new_badges = badge_service.check_and_award_badges(user_id, attempt_for_badges)
2026-02-20T22:09:17.5642165Z -                
2026-02-20T22:09:17.5642295Z +                    new_badges = badge_service.check_and_award_badges(
2026-02-20T22:09:17.5642391Z +                        user_id, attempt_for_badges
2026-02-20T22:09:17.5642577Z +                    )
2026-02-20T22:09:17.5642635Z +
2026-02-20T22:09:17.5642715Z                      if new_badges:
2026-02-20T22:09:17.5643167Z -                        logger.info(f"🎖️ {len(new_badges)} nouveaux badges attribués à l'utilisateur {user_id}")
2026-02-20T22:09:17.5643361Z +                        logger.info(
2026-02-20T22:09:17.5643660Z +                            f"🎖️ {len(new_badges)} nouveaux badges attribués à l'utilisateur {user_id}"
2026-02-20T22:09:17.5643728Z +                        )
2026-02-20T22:09:17.5643818Z                          for badge in new_badges:
2026-02-20T22:09:17.5644007Z -                            logger.debug(f"   - {badge['name']} ({badge['star_wars_title']})")
2026-02-20T22:09:17.5644072Z -                    
2026-02-20T22:09:17.5644152Z +                            logger.debug(
2026-02-20T22:09:17.5644285Z +                                f"   - {badge['name']} ({badge['star_wars_title']})"
2026-02-20T22:09:17.5644361Z +                            )
2026-02-20T22:09:17.5644428Z +
2026-02-20T22:09:17.5644521Z                  except Exception as badge_error:
2026-02-20T22:09:17.5644820Z -                    logger.warning(f"⚠️ Erreur lors de la vérification des badges: {badge_error}")
2026-02-20T22:09:17.5644909Z +                    logger.warning(
2026-02-20T22:09:17.5645130Z +                        f"⚠️ Erreur lors de la vérification des badges: {badge_error}"
2026-02-20T22:09:17.5645199Z +                    )
2026-02-20T22:09:17.5645309Z                      logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5645522Z                      # Ne pas faire échouer la soumission si les badges échouent
2026-02-20T22:09:17.5645584Z  
2026-02-20T22:09:17.5645761Z                  # Mettre à jour la série d'entraînement (streak)
2026-02-20T22:09:17.5645828Z                  try:
2026-02-20T22:09:17.5645987Z                      from app.services.streak_service import update_user_streak
2026-02-20T22:09:17.5646055Z +
2026-02-20T22:09:17.5646163Z                      update_user_streak(db, user_id)
2026-02-20T22:09:17.5646256Z                  except Exception as streak_err:
2026-02-20T22:09:17.5646395Z                      logger.debug(f"Streak update skipped: {streak_err}")
2026-02-20T22:09:17.5646462Z  
2026-02-20T22:09:17.5646705Z                  # Retourner le résultat avec l'ID de tentative et les nouveaux badges
2026-02-20T22:09:17.5646848Z                  from app.utils.json_utils import make_json_serializable
2026-02-20T22:09:17.5646915Z -                
2026-02-20T22:09:17.5646973Z +
2026-02-20T22:09:17.5647050Z                  response_data = {
2026-02-20T22:09:17.5647142Z                      "is_correct": is_correct,
2026-02-20T22:09:17.5647239Z                      "correct_answer": correct_answer,
2026-02-20T22:09:17.5647370Z -                    "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5647499Z -                    "attempt_id": attempt.get('id') if attempt else None
2026-02-20T22:09:17.5647633Z +                    "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5647763Z +                    "attempt_id": attempt.get("id") if attempt else None,
2026-02-20T22:09:17.5647826Z                  }
2026-02-20T22:09:17.5647892Z -                
2026-02-20T22:09:17.5647951Z +
2026-02-20T22:09:17.5648234Z                  # Ajouter les nouveaux badges à la réponse (nettoyer pour sérialisation JSON)
2026-02-20T22:09:17.5648314Z                  if new_badges:
2026-02-20T22:09:17.5648486Z                      response_data["new_badges"] = make_json_serializable(new_badges)
2026-02-20T22:09:17.5648610Z                      response_data["badges_earned"] = len(new_badges)
2026-02-20T22:09:17.5648676Z                  else:
2026-02-20T22:09:17.5648950Z                      # Notification « Tu approches » si un badge est proche (>= 50 %, target > 0)
2026-02-20T22:09:17.5649150Z -                    progress_notif = badge_service.get_closest_progress_notification(user_id)
2026-02-20T22:09:17.5649479Z +                    progress_notif = badge_service.get_closest_progress_notification(
2026-02-20T22:09:17.5649558Z +                        user_id
2026-02-20T22:09:17.5649623Z +                    )
2026-02-20T22:09:17.5649705Z                      if progress_notif:
2026-02-20T22:09:17.5649937Z                          response_data["progress_notification"] = progress_notif
2026-02-20T22:09:17.5650002Z -                
2026-02-20T22:09:17.5650062Z +
2026-02-20T22:09:17.5650399Z                  # Nettoyer toutes les données avant sérialisation JSON (gère les MagicMock dans les tests)
2026-02-20T22:09:17.5650550Z                  response_data = make_json_serializable(response_data)
2026-02-20T22:09:17.5650611Z -                
2026-02-20T22:09:17.5650671Z +
2026-02-20T22:09:17.5650778Z                  return JSONResponse(response_data)
2026-02-20T22:09:17.5650840Z -            
2026-02-20T22:09:17.5650899Z +
2026-02-20T22:09:17.5650995Z              except Exception as db_error:
2026-02-20T22:09:17.5651189Z                  # Gérer les erreurs spécifiques à la base de données
2026-02-20T22:09:17.5651270Z                  error_msg = str(db_error)
2026-02-20T22:09:17.5651369Z                  error_type = type(db_error).__name__
2026-02-20T22:09:17.5651671Z -                logger.error(f"❌ ERREUR DB lors de l'enregistrement: {error_type}: {error_msg}")
2026-02-20T22:09:17.5651747Z +                logger.error(
2026-02-20T22:09:17.5651976Z +                    f"❌ ERREUR DB lors de l'enregistrement: {error_type}: {error_msg}"
2026-02-20T22:09:17.5652046Z +                )
2026-02-20T22:09:17.5652147Z                  logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5652208Z -                
2026-02-20T22:09:17.5652273Z +
2026-02-20T22:09:17.5652551Z                  # Retourner quand même le résultat de validation même si l'enregistrement échoue
2026-02-20T22:09:17.5652637Z -                return JSONResponse({
2026-02-20T22:09:17.5652726Z -                    "is_correct": is_correct,
2026-02-20T22:09:17.5652836Z -                    "correct_answer": correct_answer,
2026-02-20T22:09:17.5653141Z -                    "explanation": exercise.get('explanation', ""),
2026-02-20T22:09:17.5653351Z -                    "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5653457Z -                    "error_type": error_type,
2026-02-20T22:09:17.5653547Z -                    "error_message": error_msg
2026-02-20T22:09:17.5653623Z -                }, status_code=500)
2026-02-20T22:09:17.5653708Z +                return JSONResponse(
2026-02-20T22:09:17.5653773Z +                    {
2026-02-20T22:09:17.5653861Z +                        "is_correct": is_correct,
2026-02-20T22:09:17.5653963Z +                        "correct_answer": correct_answer,
2026-02-20T22:09:17.5654095Z +                        "explanation": exercise.get("explanation", ""),
2026-02-20T22:09:17.5654246Z +                        "error": "Erreur lors de l'enregistrement de la tentative",
2026-02-20T22:09:17.5654340Z +                        "error_type": error_type,
2026-02-20T22:09:17.5654441Z +                        "error_message": error_msg,
2026-02-20T22:09:17.5654506Z +                    },
2026-02-20T22:09:17.5654582Z +                    status_code=500,
2026-02-20T22:09:17.5654651Z +                )
2026-02-20T22:09:17.5654714Z  
2026-02-20T22:09:17.5654824Z      except Exception as response_processing_error:
2026-02-20T22:09:17.5655329Z -        logger.error(f"❌ ERREUR lors du traitement de la réponse: {type(response_processing_error).__name__}: {str(response_processing_error)}")
2026-02-20T22:09:17.5655405Z +        logger.error(
2026-02-20T22:09:17.5655835Z +            f"❌ ERREUR lors du traitement de la réponse: {type(response_processing_error).__name__}: {str(response_processing_error)}"
2026-02-20T22:09:17.5655898Z +        )
2026-02-20T22:09:17.5656004Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5656064Z -        
2026-02-20T22:09:17.5656124Z +
2026-02-20T22:09:17.5656440Z          # Retourner une réponse d'erreur standardisée
2026-02-20T22:09:17.5656552Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5656639Z              response_processing_error,
2026-02-20T22:09:17.5656715Z              status_code=500,
2026-02-20T22:09:17.5657016Z -            user_message="Erreur lors du traitement de la réponse"
2026-02-20T22:09:17.5657081Z -        )
2026-02-20T22:09:17.5657275Z +            user_message="Erreur lors du traitement de la réponse",
2026-02-20T22:09:17.5657342Z +        )
2026-02-20T22:09:17.5657401Z +
2026-02-20T22:09:17.5657459Z  
2026-02-20T22:09:17.5657528Z  @optional_auth
2026-02-20T22:09:17.5657620Z  async def get_exercises_list(request):
2026-02-20T22:09:17.5658013Z      """Retourne la liste des exercices avec pagination. Ordre aléatoire par défaut pour varier l'entraînement."""
2026-02-20T22:09:17.5658077Z      try:
2026-02-20T22:09:17.5658263Z          logger.debug("[STEP 1] Début de get_exercises_list")
2026-02-20T22:09:17.5658401Z -        current_user = getattr(request.state, 'user', None)
2026-02-20T22:09:17.5658520Z +        current_user = getattr(request.state, "user", None)
2026-02-20T22:09:17.5658589Z  
2026-02-20T22:09:17.5658727Z          # Récupérer les paramètres de requête
2026-02-20T22:09:17.5658852Z -        limit_param = request.query_params.get('limit')
2026-02-20T22:09:17.5658963Z +        limit_param = request.query_params.get("limit")
2026-02-20T22:09:17.5659076Z          limit = int(limit_param) if limit_param else 20
2026-02-20T22:09:17.5659185Z -        skip = int(request.query_params.get('skip', 0))
2026-02-20T22:09:17.5659360Z -        exercise_type_raw = request.query_params.get('exercise_type', None)
2026-02-20T22:09:17.5659591Z -        age_group_raw = request.query_params.get('age_group', None) # Changed from difficulty
2026-02-20T22:09:17.5659875Z -        search = request.query_params.get('search') or request.query_params.get('q')  # Support 'search' et 'q'
2026-02-20T22:09:17.5660026Z -        order = (request.query_params.get('order') or 'random').lower()
2026-02-20T22:09:17.5660268Z -        hide_completed = request.query_params.get('hide_completed', 'false').lower() == 'true'
2026-02-20T22:09:17.5660332Z -        
2026-02-20T22:09:17.5660638Z -        logger.debug(f"[STEP 2] Params: limit={limit}, skip={skip}, type={exercise_type_raw}, age_group={age_group_raw}")
2026-02-20T22:09:17.5660708Z -        
2026-02-20T22:09:17.5660820Z +        skip = int(request.query_params.get("skip", 0))
2026-02-20T22:09:17.5660990Z +        exercise_type_raw = request.query_params.get("exercise_type", None)
2026-02-20T22:09:17.5661092Z +        age_group_raw = request.query_params.get(
2026-02-20T22:09:17.5661173Z +            "age_group", None
2026-02-20T22:09:17.5661253Z +        )  # Changed from difficulty
2026-02-20T22:09:17.5661438Z +        search = request.query_params.get("search") or request.query_params.get(
2026-02-20T22:09:17.5661507Z +            "q"
2026-02-20T22:09:17.5661586Z +        )  # Support 'search' et 'q'
2026-02-20T22:09:17.5661736Z +        order = (request.query_params.get("order") or "random").lower()
2026-02-20T22:09:17.5661817Z +        hide_completed = (
2026-02-20T22:09:17.5661997Z +            request.query_params.get("hide_completed", "false").lower() == "true"
2026-02-20T22:09:17.5662064Z +        )
2026-02-20T22:09:17.5662124Z +
2026-02-20T22:09:17.5662200Z +        logger.debug(
2026-02-20T22:09:17.5662452Z +            f"[STEP 2] Params: limit={limit}, skip={skip}, type={exercise_type_raw}, age_group={age_group_raw}"
2026-02-20T22:09:17.5662513Z +        )
2026-02-20T22:09:17.5662578Z +
2026-02-20T22:09:17.5662721Z          # Normaliser les paramètres de filtrage
2026-02-20T22:09:17.5662819Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5662919Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5663329Z -        exercise_type, age_group, _ = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5663512Z -        
2026-02-20T22:09:17.5663843Z -        logger.debug(f"[STEP 3] Après normalisation: type={exercise_type}, age_group={age_group}")
2026-02-20T22:09:17.5663915Z -        
2026-02-20T22:09:17.5664123Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5664286Z +
2026-02-20T22:09:17.5664470Z +        exercise_type, age_group, _ = normalize_and_validate_exercise_params(
2026-02-20T22:09:17.5664562Z +            exercise_type_raw, age_group_raw
2026-02-20T22:09:17.5664626Z +        )
2026-02-20T22:09:17.5664687Z +
2026-02-20T22:09:17.5664766Z +        logger.debug(
2026-02-20T22:09:17.5665027Z +            f"[STEP 3] Après normalisation: type={exercise_type}, age_group={age_group}"
2026-02-20T22:09:17.5665090Z +        )
2026-02-20T22:09:17.5665155Z +
2026-02-20T22:09:17.5665397Z          # Si aucun paramètre n'était fourni, remettre à None pour ne pas filtrer
2026-02-20T22:09:17.5665480Z          if not exercise_type_raw:
2026-02-20T22:09:17.5665573Z              exercise_type = None
2026-02-20T22:09:17.5665649Z          if not age_group_raw:
2026-02-20T22:09:17.5665723Z              age_group = None
2026-02-20T22:09:17.5665783Z -        
2026-02-20T22:09:17.5665847Z +
2026-02-20T22:09:17.5665999Z          # Calculer la page à partir de skip et limit
2026-02-20T22:09:17.5666118Z          page = (skip // limit) + 1 if limit > 0 else 1
2026-02-20T22:09:17.5666185Z -        
2026-02-20T22:09:17.5666243Z +
2026-02-20T22:09:17.5666373Z          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5666514Z          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5666578Z +
2026-02-20T22:09:17.5666733Z          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5666867Z          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5666931Z -        
2026-02-20T22:09:17.5667573Z -        logger.debug(f"[STEP 4] API - Paramètres finaux: limit={limit}, skip={skip}, page={page}, exercise_type={exercise_type}, age_group={age_group}, search={search}, locale={locale}")
2026-02-20T22:09:17.5667641Z -        
2026-02-20T22:09:17.5667703Z +
2026-02-20T22:09:17.5667773Z +        logger.debug(
2026-02-20T22:09:17.5668348Z +            f"[STEP 4] API - Paramètres finaux: limit={limit}, skip={skip}, page={page}, exercise_type={exercise_type}, age_group={age_group}, search={search}, locale={locale}"
2026-02-20T22:09:17.5668408Z +        )
2026-02-20T22:09:17.5668471Z +
2026-02-20T22:09:17.5668751Z          # Utiliser le service ORM ExerciseService (100% ORM comme recommandé par l'audit)
2026-02-20T22:09:17.5668836Z          async with db_session() as db:
2026-02-20T22:09:17.5668951Z              logger.debug("[STEP 5] Session DB obtenue")
2026-02-20T22:09:17.5669110Z              logger.debug("[STEP 6] Début du bloc try DB")
2026-02-20T22:09:17.5669226Z              from sqlalchemy import String, cast, or_, text
2026-02-20T22:09:17.5669289Z  
2026-02-20T22:09:17.5669445Z -            from app.models.exercise import (DifficultyLevel, Exercise,
2026-02-20T22:09:17.5669545Z -                                             ExerciseType)
2026-02-20T22:09:17.5669738Z +            from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:17.5669801Z  
2026-02-20T22:09:17.5669959Z              logger.debug("[STEP 7] Imports effectués")
2026-02-20T22:09:17.5670046Z              from sqlalchemy import func
2026-02-20T22:09:17.5670110Z  
2026-02-20T22:09:17.5670304Z              # IDs à exclure si hide_completed et utilisateur connecté
2026-02-20T22:09:17.5670391Z              completed_ids_to_exclude = []
2026-02-20T22:09:17.5670556Z              if hide_completed and current_user and current_user.get("id"):
2026-02-20T22:09:17.5670661Z                  from app.models.attempt import Attempt
2026-02-20T22:09:17.5670778Z -                subq = db.query(Attempt.exercise_id).filter(
2026-02-20T22:09:17.5670880Z -                    Attempt.user_id == current_user["id"],
2026-02-20T22:09:17.5671067Z -                    Attempt.is_correct == True
2026-02-20T22:09:17.5671145Z -                ).distinct().all()
2026-02-20T22:09:17.5671207Z +
2026-02-20T22:09:17.5671281Z +                subq = (
2026-02-20T22:09:17.5671376Z +                    db.query(Attempt.exercise_id)
2026-02-20T22:09:17.5671519Z +                    .filter(
2026-02-20T22:09:17.5671638Z +                        Attempt.user_id == current_user["id"],
2026-02-20T22:09:17.5671734Z +                        Attempt.is_correct == True,
2026-02-20T22:09:17.5671799Z +                    )
2026-02-20T22:09:17.5671872Z +                    .distinct()
2026-02-20T22:09:17.5671948Z +                    .all()
2026-02-20T22:09:17.5672012Z +                )
2026-02-20T22:09:17.5672180Z                  completed_ids_to_exclude = [r[0] for r in subq if r[0] is not None]
2026-02-20T22:09:17.5672248Z -            
2026-02-20T22:09:17.5672308Z +
2026-02-20T22:09:17.5672434Z              # Construire la requête ORM
2026-02-20T22:09:17.5672601Z              query = db.query(Exercise).filter(Exercise.is_archived == False)
2026-02-20T22:09:17.5672767Z              logger.debug("[STEP 8] Query de base créée")
2026-02-20T22:09:17.5672829Z -            
2026-02-20T22:09:17.5672888Z +
2026-02-20T22:09:17.5673309Z              # Filtrer par type si spécifié (utiliser l'enum normalisé)
2026-02-20T22:09:17.5673393Z              if exercise_type:
2026-02-20T22:09:17.5673556Z                  query = query.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:17.5673622Z -            
2026-02-20T22:09:17.5673681Z +
2026-02-20T22:09:17.5673830Z              # Filtrer par groupe d'âge si spécifié
2026-02-20T22:09:17.5673904Z              if age_group:
2026-02-20T22:09:17.5674045Z                  query = query.filter(Exercise.age_group == age_group)
2026-02-20T22:09:17.5674106Z -            
2026-02-20T22:09:17.5674165Z +
2026-02-20T22:09:17.5674307Z              # Recherche textuelle si spécifié
2026-02-20T22:09:17.5674386Z              if search:
2026-02-20T22:09:17.5674477Z                  search_pattern = f"%{search}%"
2026-02-20T22:09:17.5674559Z                  query = query.filter(
2026-02-20T22:09:17.5674633Z                      or_(
2026-02-20T22:09:17.5674745Z                          Exercise.title.ilike(search_pattern),
2026-02-20T22:09:17.5674869Z -                        Exercise.question.ilike(search_pattern)
2026-02-20T22:09:17.5675000Z +                        Exercise.question.ilike(search_pattern),
2026-02-20T22:09:17.5675067Z                      )
2026-02-20T22:09:17.5675130Z                  )
2026-02-20T22:09:17.5675197Z  
2026-02-20T22:09:17.5675366Z              # Exclure les exercices déjà réussis si demandé
2026-02-20T22:09:17.5675453Z              if completed_ids_to_exclude:
2026-02-20T22:09:17.5675629Z                  query = query.filter(Exercise.id.notin_(completed_ids_to_exclude))
2026-02-20T22:09:17.5675698Z -            
2026-02-20T22:09:17.5675757Z +
2026-02-20T22:09:17.5675910Z              logger.debug("[STEP 9] Filtres appliqués")
2026-02-20T22:09:17.5675988Z -            
2026-02-20T22:09:17.5676047Z +
2026-02-20T22:09:17.5676122Z              # Compter le total
2026-02-20T22:09:17.5676200Z              total = query.count()
2026-02-20T22:09:17.5676384Z              logger.debug(f"[STEP 10] Total compté: {total}")
2026-02-20T22:09:17.5676445Z -            
2026-02-20T22:09:17.5676505Z +
2026-02-20T22:09:17.5676801Z              # Récupérer les exercices avec pagination (mêmes filtres que la query principale)
2026-02-20T22:09:17.5676892Z              exercises_objs_raw = db.query(
2026-02-20T22:09:17.5676967Z                  Exercise.id,
2026-02-20T22:09:17.5677044Z                  Exercise.title,
2026-02-20T22:09:17.5677131Z                  Exercise.question,
2026-02-20T22:09:17.5677200Z @@ -484,163 +605,220 @@
2026-02-20T22:09:17.5677272Z                  Exercise.tags,
2026-02-20T22:09:17.5677361Z                  Exercise.ai_generated,
2026-02-20T22:09:17.5677439Z                  Exercise.is_active,
2026-02-20T22:09:17.5677697Z                  Exercise.view_count,
2026-02-20T22:09:17.5677788Z                  Exercise.created_at,
2026-02-20T22:09:17.5677972Z -                cast(Exercise.exercise_type, String).label('exercise_type_str'),
2026-02-20T22:09:17.5678227Z -                cast(Exercise.difficulty, String).label('difficulty_str'),
2026-02-20T22:09:17.5678428Z -                Exercise.age_group # Récupérer aussi le groupe d'âge
2026-02-20T22:09:17.5678604Z +                cast(Exercise.exercise_type, String).label("exercise_type_str"),
2026-02-20T22:09:17.5678754Z +                cast(Exercise.difficulty, String).label("difficulty_str"),
2026-02-20T22:09:17.5678949Z +                Exercise.age_group,  # Récupérer aussi le groupe d'âge
2026-02-20T22:09:17.5679059Z              ).filter(Exercise.is_archived == False)
2026-02-20T22:09:17.5679120Z -            
2026-02-20T22:09:17.5679178Z +
2026-02-20T22:09:17.5679376Z              # Appliquer les mêmes filtres que la requête principale
2026-02-20T22:09:17.5679461Z              if exercise_type:
2026-02-20T22:09:17.5679714Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.exercise_type == exercise_type)
2026-02-20T22:09:17.5679837Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5679962Z +                    Exercise.exercise_type == exercise_type
2026-02-20T22:09:17.5680026Z +                )
2026-02-20T22:09:17.5680098Z              if age_group:
2026-02-20T22:09:17.5680323Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.age_group == age_group)
2026-02-20T22:09:17.5680441Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5680536Z +                    Exercise.age_group == age_group
2026-02-20T22:09:17.5680603Z +                )
2026-02-20T22:09:17.5680672Z              if search:
2026-02-20T22:09:17.5680763Z                  search_pattern = f"%{search}%"
2026-02-20T22:09:17.5680884Z                  exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5680967Z                      or_(
2026-02-20T22:09:17.5681085Z                          Exercise.title.ilike(search_pattern),
2026-02-20T22:09:17.5681201Z -                        Exercise.question.ilike(search_pattern)
2026-02-20T22:09:17.5681335Z +                        Exercise.question.ilike(search_pattern),
2026-02-20T22:09:17.5681400Z                      )
2026-02-20T22:09:17.5681461Z                  )
2026-02-20T22:09:17.5681554Z              if completed_ids_to_exclude:
2026-02-20T22:09:17.5681821Z -                exercises_objs_raw = exercises_objs_raw.filter(Exercise.id.notin_(completed_ids_to_exclude))
2026-02-20T22:09:17.5681941Z +                exercises_objs_raw = exercises_objs_raw.filter(
2026-02-20T22:09:17.5682063Z +                    Exercise.id.notin_(completed_ids_to_exclude)
2026-02-20T22:09:17.5682126Z +                )
2026-02-20T22:09:17.5682185Z  
2026-02-20T22:09:17.5682410Z              # Ordre : aléatoire par défaut (varier l'entraînement), ou récent
2026-02-20T22:09:17.5682500Z              if order == "recent":
2026-02-20T22:09:17.5682820Z -                exercises_objs_raw = exercises_objs_raw.order_by(Exercise.created_at.desc()).limit(limit).offset(skip).all()
2026-02-20T22:09:17.5682910Z +                exercises_objs_raw = (
2026-02-20T22:09:17.5683178Z +                    exercises_objs_raw.order_by(Exercise.created_at.desc())
2026-02-20T22:09:17.5683253Z +                    .limit(limit)
2026-02-20T22:09:17.5683324Z +                    .offset(skip)
2026-02-20T22:09:17.5683399Z +                    .all()
2026-02-20T22:09:17.5683461Z +                )
2026-02-20T22:09:17.5683528Z              else:
2026-02-20T22:09:17.5683797Z -                exercises_objs_raw = exercises_objs_raw.order_by(func.random()).limit(limit).offset(skip).all()
2026-02-20T22:09:17.5684100Z -            logger.debug(f"[STEP 11] Exercices récupérés: {len(exercises_objs_raw)} éléments")
2026-02-20T22:09:17.5684163Z -            
2026-02-20T22:09:17.5684370Z +                exercises_objs_raw = (
2026-02-20T22:09:17.5684493Z +                    exercises_objs_raw.order_by(func.random())
2026-02-20T22:09:17.5684564Z +                    .limit(limit)
2026-02-20T22:09:17.5684637Z +                    .offset(skip)
2026-02-20T22:09:17.5684805Z +                    .all()
2026-02-20T22:09:17.5684875Z +                )
2026-02-20T22:09:17.5684954Z +            logger.debug(
2026-02-20T22:09:17.5685194Z +                f"[STEP 11] Exercices récupérés: {len(exercises_objs_raw)} éléments"
2026-02-20T22:09:17.5685265Z +            )
2026-02-20T22:09:17.5685326Z +
2026-02-20T22:09:17.5685408Z              import json as json_module
2026-02-20T22:09:17.5685473Z +
2026-02-20T22:09:17.5685582Z              def safe_parse_json(value, default=None):
2026-02-20T22:09:17.5685731Z -                if not value: return default if default is not None else []
2026-02-20T22:09:17.5685807Z +                if not value:
2026-02-20T22:09:17.5685943Z +                    return default if default is not None else []
2026-02-20T22:09:17.5686030Z                  if isinstance(value, str):
2026-02-20T22:09:17.5686140Z -                    try: return json_module.loads(value)
2026-02-20T22:09:17.5686442Z -                    except (json_module.JSONDecodeError, ValueError): return default if default is not None else []
2026-02-20T22:09:17.5686515Z +                    try:
2026-02-20T22:09:17.5686619Z +                        return json_module.loads(value)
2026-02-20T22:09:17.5686761Z +                    except (json_module.JSONDecodeError, ValueError):
2026-02-20T22:09:17.5686883Z +                        return default if default is not None else []
2026-02-20T22:09:17.5686957Z                  return value
2026-02-20T22:09:17.5687018Z  
2026-02-20T22:09:17.5687278Z              logger.debug("[STEP 12] Début de la construction de la liste d'exercices")
2026-02-20T22:09:17.5687352Z              exercises = []
2026-02-20T22:09:17.5687470Z              for idx, row in enumerate(exercises_objs_raw):
2026-02-20T22:09:17.5687549Z                  try:
2026-02-20T22:09:17.5687931Z -                    logger.debug(f"[STEP 12.{idx}] Processing row id={row.id}, type={type(row.exercise_type_str)}, diff={type(row.difficulty_str)}")
2026-02-20T22:09:17.5688016Z +                    logger.debug(
2026-02-20T22:09:17.5688346Z +                        f"[STEP 12.{idx}] Processing row id={row.id}, type={type(row.exercise_type_str)}, diff={type(row.difficulty_str)}"
2026-02-20T22:09:17.5688411Z +                    )
2026-02-20T22:09:17.5688492Z                      exercise_dict = {
2026-02-20T22:09:17.5688569Z                          "id": row.id,
2026-02-20T22:09:17.5688660Z                          "title": row.title,
2026-02-20T22:09:17.5688918Z -                        "exercise_type": row.exercise_type_str.upper() if row.exercise_type_str else "ADDITION",
2026-02-20T22:09:17.5689149Z -                        "difficulty": row.difficulty_str.upper() if row.difficulty_str else "PADAWAN",
2026-02-20T22:09:17.5689243Z +                        "exercise_type": (
2026-02-20T22:09:17.5689348Z +                            row.exercise_type_str.upper()
2026-02-20T22:09:17.5689447Z +                            if row.exercise_type_str
2026-02-20T22:09:17.5689550Z +                            else "ADDITION"
2026-02-20T22:09:17.5689620Z +                        ),
2026-02-20T22:09:17.5689698Z +                        "difficulty": (
2026-02-20T22:09:17.5689804Z +                            row.difficulty_str.upper()
2026-02-20T22:09:17.5689897Z +                            if row.difficulty_str
2026-02-20T22:09:17.5689975Z +                            else "PADAWAN"
2026-02-20T22:09:17.5690041Z +                        ),
2026-02-20T22:09:17.5690141Z                          "age_group": row.age_group,
2026-02-20T22:09:17.5690232Z                          "question": row.question,
2026-02-20T22:09:17.5690340Z                          "correct_answer": row.correct_answer,
2026-02-20T22:09:17.5690555Z                          "choices": safe_parse_json(row.choices, []),
2026-02-20T22:09:17.5690660Z                          "explanation": row.explanation,
2026-02-20T22:09:17.5690738Z                          "hint": row.hint,
2026-02-20T22:09:17.5690922Z                          "tags": safe_parse_json(row.tags, []),
2026-02-20T22:09:17.5691024Z                          "ai_generated": row.ai_generated,
2026-02-20T22:09:17.5691114Z                          "is_active": row.is_active,
2026-02-20T22:09:17.5691208Z -                        "view_count": row.view_count
2026-02-20T22:09:17.5691306Z +                        "view_count": row.view_count,
2026-02-20T22:09:17.5691371Z                      }
2026-02-20T22:09:17.5691467Z                      exercises.append(exercise_dict)
2026-02-20T22:09:17.5691566Z                  except Exception as row_error:
2026-02-20T22:09:17.5691742Z                      logger.error(f"[STEP 12.{idx}] ERROR processing row: {row_error}")
2026-02-20T22:09:17.5691820Z                      raise
2026-02-20T22:09:17.5692113Z -            logger.debug(f"[STEP 13] Liste d'exercices construite: {len(exercises)} éléments")
2026-02-20T22:09:17.5692185Z +            logger.debug(
2026-02-20T22:09:17.5692421Z +                f"[STEP 13] Liste d'exercices construite: {len(exercises)} éléments"
2026-02-20T22:09:17.5692484Z +            )
2026-02-20T22:09:17.5692551Z  
2026-02-20T22:09:17.5692651Z          has_more = (skip + len(exercises)) < total
2026-02-20T22:09:17.5692714Z -        
2026-02-20T22:09:17.5692777Z +
2026-02-20T22:09:17.5692849Z          response_data = {
2026-02-20T22:09:17.5692926Z              "items": exercises,
2026-02-20T22:09:17.5693172Z              "total": total,
2026-02-20T22:09:17.5693279Z              "page": page,
2026-02-20T22:09:17.5693352Z              "limit": limit,
2026-02-20T22:09:17.5693429Z -            "hasMore": has_more
2026-02-20T22:09:17.5693509Z +            "hasMore": has_more,
2026-02-20T22:09:17.5693570Z          }
2026-02-20T22:09:17.5693639Z -        
2026-02-20T22:09:17.5693700Z +
2026-02-20T22:09:17.5693798Z          return JSONResponse(response_data)
2026-02-20T22:09:17.5693857Z  
2026-02-20T22:09:17.5693957Z      except Exception as exercises_list_error:
2026-02-20T22:09:17.5694273Z -        logger.error(f"Erreur lors de la récupération des exercices: {exercises_list_error}")
2026-02-20T22:09:17.5694345Z +        logger.error(
2026-02-20T22:09:17.5694585Z +            f"Erreur lors de la récupération des exercices: {exercises_list_error}"
2026-02-20T22:09:17.5694652Z +        )
2026-02-20T22:09:17.5694749Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5695279Z -        return ErrorHandler.create_error_response(exercises_list_error, status_code=500, user_message="Erreur lors de la récupération des exercices")
2026-02-20T22:09:17.5695385Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5695468Z +            exercises_list_error,
2026-02-20T22:09:17.5695541Z +            status_code=500,
2026-02-20T22:09:17.5695758Z +            user_message="Erreur lors de la récupération des exercices",
2026-02-20T22:09:17.5695827Z +        )
2026-02-20T22:09:17.5695885Z +
2026-02-20T22:09:17.5695944Z  
2026-02-20T22:09:17.5696043Z  async def generate_exercise_api(request):
2026-02-20T22:09:17.5696310Z      """Génère un nouvel exercice via API JSON (POST) en utilisant le groupe d'âge."""
2026-02-20T22:09:17.5696373Z      try:
2026-02-20T22:09:17.5696518Z          # Récupérer les données JSON de la requête
2026-02-20T22:09:17.5696609Z          data = await request.json()
2026-02-20T22:09:17.5696719Z -        exercise_type_raw = data.get('exercise_type')
2026-02-20T22:09:17.5696875Z -        age_group_raw = data.get('age_group') # Changed from difficulty
2026-02-20T22:09:17.5696963Z -        use_ai = data.get('ai', False)
2026-02-20T22:09:17.5697024Z -        
2026-02-20T22:09:17.5697130Z +        exercise_type_raw = data.get("exercise_type")
2026-02-20T22:09:17.5697282Z +        age_group_raw = data.get("age_group")  # Changed from difficulty
2026-02-20T22:09:17.5697507Z +        use_ai = data.get("ai", False)
2026-02-20T22:09:17.5697566Z +
2026-02-20T22:09:17.5697709Z          # Normaliser et valider les paramètres
2026-02-20T22:09:17.5697815Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5698017Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5698081Z -        
2026-02-20T22:09:17.5698442Z -        exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5698504Z -        
2026-02-20T22:09:17.5698964Z -        logger.debug(f"Génération API: type={exercise_type_raw}→{exercise_type}, groupe d'âge={age_group_raw}→{age_group}, IA={use_ai}")
2026-02-20T22:09:17.5699031Z -        
2026-02-20T22:09:17.5699237Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5699296Z +
2026-02-20T22:09:17.5699417Z +        exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5699623Z +            normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5699683Z +        )
2026-02-20T22:09:17.5699742Z +
2026-02-20T22:09:17.5699823Z +        logger.debug(
2026-02-20T22:09:17.5700275Z +            f"Génération API: type={exercise_type_raw}→{exercise_type}, groupe d'âge={age_group_raw}→{age_group}, IA={use_ai}"
2026-02-20T22:09:17.5700339Z +        )
2026-02-20T22:09:17.5700399Z +
2026-02-20T22:09:17.5700522Z          # Valider les paramètres
2026-02-20T22:09:17.5700637Z          if not exercise_type_raw or not age_group_raw:
2026-02-20T22:09:17.5700720Z -            return JSONResponse({
2026-02-20T22:09:17.5700960Z -                "error": "Les paramètres 'exercise_type' et 'age_group' sont requis"
2026-02-20T22:09:17.5701035Z -            }, status_code=400)
2026-02-20T22:09:17.5701096Z -        
2026-02-20T22:09:17.5701179Z +            return JSONResponse(
2026-02-20T22:09:17.5701421Z +                {"error": "Les paramètres 'exercise_type' et 'age_group' sont requis"},
2026-02-20T22:09:17.5701507Z +                status_code=400,
2026-02-20T22:09:17.5701568Z +            )
2026-02-20T22:09:17.5701635Z +
2026-02-20T22:09:17.5701740Z          # Générer l'exercice
2026-02-20T22:09:17.5701826Z          ai_generated = False
2026-02-20T22:09:17.5701980Z -        if use_ai and str(use_ai).lower() in ['true', '1', 'yes', 'y']:
2026-02-20T22:09:17.5702118Z +        if use_ai and str(use_ai).lower() in ["true", "1", "yes", "y"]:
2026-02-20T22:09:17.5702282Z              exercise_dict = generate_ai_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5702365Z              ai_generated = True
2026-02-20T22:09:17.5702429Z          else:
2026-02-20T22:09:17.5702596Z              exercise_dict = generate_simple_exercise(exercise_type, age_group)
2026-02-20T22:09:17.5702656Z -        
2026-02-20T22:09:17.5702722Z +
2026-02-20T22:09:17.5702842Z          exercise_dict = ensure_explanation(exercise_dict)
2026-02-20T22:09:17.5702910Z -        
2026-02-20T22:09:17.5703083Z +
2026-02-20T22:09:17.5703253Z          # Optionnellement sauvegarder en base de données
2026-02-20T22:09:17.5703345Z -        save_to_db = data.get('save', True)
2026-02-20T22:09:17.5703429Z +        save_to_db = data.get("save", True)
2026-02-20T22:09:17.5703512Z          if save_to_db:
2026-02-20T22:09:17.5703579Z              try:
2026-02-20T22:09:17.5703659Z                  # Extraire la locale
2026-02-20T22:09:17.5703814Z                  from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5703873Z +
2026-02-20T22:09:17.5704023Z                  accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5704159Z                  locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5704228Z -                
2026-02-20T22:09:17.5704286Z +
2026-02-20T22:09:17.5704376Z                  async with db_session() as db:
2026-02-20T22:09:17.5704619Z                      # Sauvegarder l'exercice avec age_group et la difficulté dérivée
2026-02-20T22:09:17.5704937Z                      created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5705008Z                          db=db,
2026-02-20T22:09:17.5705236Z -                        exercise_type=exercise_dict['exercise_type'],
2026-02-20T22:09:17.5705380Z -                        age_group=exercise_dict['age_group'], # Save age_group
2026-02-20T22:09:17.5705561Z -                        difficulty=exercise_dict['difficulty'], # Save derived difficulty
2026-02-20T22:09:17.5705660Z -                        title=exercise_dict['title'],
2026-02-20T22:09:17.5705765Z -                        question=exercise_dict['question'],
2026-02-20T22:09:17.5705887Z -                        correct_answer=exercise_dict['correct_answer'],
2026-02-20T22:09:17.5705986Z -                        choices=exercise_dict['choices'],
2026-02-20T22:09:17.5706110Z -                        explanation=exercise_dict['explanation'],
2026-02-20T22:09:17.5706218Z -                        hint=exercise_dict.get('hint'),
2026-02-20T22:09:17.5706338Z -                        tags=exercise_dict.get('tags', 'generated'),
2026-02-20T22:09:17.5706470Z +                        exercise_type=exercise_dict["exercise_type"],
2026-02-20T22:09:17.5706619Z +                        age_group=exercise_dict["age_group"],  # Save age_group
2026-02-20T22:09:17.5706712Z +                        difficulty=exercise_dict[
2026-02-20T22:09:17.5706799Z +                            "difficulty"
2026-02-20T22:09:17.5706891Z +                        ],  # Save derived difficulty
2026-02-20T22:09:17.5706983Z +                        title=exercise_dict["title"],
2026-02-20T22:09:17.5707087Z +                        question=exercise_dict["question"],
2026-02-20T22:09:17.5707218Z +                        correct_answer=exercise_dict["correct_answer"],
2026-02-20T22:09:17.5707317Z +                        choices=exercise_dict["choices"],
2026-02-20T22:09:17.5707433Z +                        explanation=exercise_dict["explanation"],
2026-02-20T22:09:17.5707540Z +                        hint=exercise_dict.get("hint"),
2026-02-20T22:09:17.5707656Z +                        tags=exercise_dict.get("tags", "generated"),
2026-02-20T22:09:17.5707755Z                          ai_generated=ai_generated,
2026-02-20T22:09:17.5707841Z -                        locale=locale
2026-02-20T22:09:17.5707916Z +                        locale=locale,
2026-02-20T22:09:17.5707980Z                      )
2026-02-20T22:09:17.5708062Z                      if created_exercise:
2026-02-20T22:09:17.5708179Z -                        exercise_dict['id'] = created_exercise['id']
2026-02-20T22:09:17.5708441Z -                        logger.info(f"Exercice sauvegardé avec ID={created_exercise['id']}")
2026-02-20T22:09:17.5708551Z +                        exercise_dict["id"] = created_exercise["id"]
2026-02-20T22:09:17.5708630Z +                        logger.info(
2026-02-20T22:09:17.5708840Z +                            f"Exercice sauvegardé avec ID={created_exercise['id']}"
2026-02-20T22:09:17.5708914Z +                        )
2026-02-20T22:09:17.5709009Z              except Exception as save_error:
2026-02-20T22:09:17.5709168Z                  logger.warning(f"Erreur lors de la sauvegarde: {save_error}")
2026-02-20T22:09:17.5709327Z                  # Continuer même si la sauvegarde échoue
2026-02-20T22:09:17.5709397Z -        
2026-02-20T22:09:17.5709457Z +
2026-02-20T22:09:17.5709577Z          # Retourner l'exercice généré
2026-02-20T22:09:17.5709667Z          return JSONResponse(exercise_dict)
2026-02-20T22:09:17.5709730Z -        
2026-02-20T22:09:17.5709788Z +
2026-02-20T22:09:17.5709887Z      except Exception as api_generation_error:
2026-02-20T22:09:17.5710182Z -        logger.error(f"Erreur lors de la génération d'exercice API: {api_generation_error}")
2026-02-20T22:09:17.5710254Z +        logger.error(
2026-02-20T22:09:17.5710488Z +            f"Erreur lors de la génération d'exercice API: {api_generation_error}"
2026-02-20T22:09:17.5710642Z +        )
2026-02-20T22:09:17.5710743Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5711262Z -        return ErrorHandler.create_error_response(api_generation_error, status_code=500, user_message="Erreur lors de la génération de l'exercice")
2026-02-20T22:09:17.5711466Z +        return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5711553Z +            api_generation_error,
2026-02-20T22:09:17.5711625Z +            status_code=500,
2026-02-20T22:09:17.5711823Z +            user_message="Erreur lors de la génération de l'exercice",
2026-02-20T22:09:17.5711891Z +        )
2026-02-20T22:09:17.5711948Z +
2026-02-20T22:09:17.5712005Z  
2026-02-20T22:09:17.5712071Z  @require_auth_sse
2026-02-20T22:09:17.5712183Z  async def generate_ai_exercise_stream(request):
2026-02-20T22:09:17.5712245Z      """
2026-02-20T22:09:17.5712405Z      Génère un exercice avec OpenAI en streaming SSE.
2026-02-20T22:09:17.5712482Z @@ -649,61 +827,101 @@
2026-02-20T22:09:17.5712551Z      try:
2026-02-20T22:09:17.5712759Z          # Utilisateur authentifié via le décorateur @require_auth_sse
2026-02-20T22:09:17.5712846Z          current_user = request.state.user
2026-02-20T22:09:17.5712908Z  
2026-02-20T22:09:17.5713162Z          # Récupérer les paramètres de la requête
2026-02-20T22:09:17.5713363Z -        exercise_type_raw = request.query_params.get('exercise_type', 'addition')
2026-02-20T22:09:17.5713552Z +        exercise_type_raw = request.query_params.get("exercise_type", "addition")
2026-02-20T22:09:17.5713799Z          # Support des deux paramètres : age_group (nouveau) et difficulty (legacy)
2026-02-20T22:09:17.5714086Z -        age_group_raw = request.query_params.get('age_group') or request.query_params.get('difficulty', '6-8')
2026-02-20T22:09:17.5714221Z -        prompt_raw = request.query_params.get('prompt', '')
2026-02-20T22:09:17.5714325Z +        age_group_raw = request.query_params.get(
2026-02-20T22:09:17.5714397Z +            "age_group"
2026-02-20T22:09:17.5714536Z +        ) or request.query_params.get("difficulty", "6-8")
2026-02-20T22:09:17.5714659Z +        prompt_raw = request.query_params.get("prompt", "")
2026-02-20T22:09:17.5714718Z  
2026-02-20T22:09:17.5714911Z          # Sanitizer le prompt utilisateur pour éviter l'injection
2026-02-20T22:09:17.5715079Z -        from app.utils.prompt_sanitizer import (sanitize_user_prompt,
2026-02-20T22:09:17.5715190Z -                                                validate_prompt_safety)
2026-02-20T22:09:17.5715293Z +        from app.utils.prompt_sanitizer import (
2026-02-20T22:09:17.5715378Z +            sanitize_user_prompt,
2026-02-20T22:09:17.5715459Z +            validate_prompt_safety,
2026-02-20T22:09:17.5715519Z +        )
2026-02-20T22:09:17.5715582Z +
2026-02-20T22:09:17.5715726Z          is_safe, safety_reason = validate_prompt_safety(prompt_raw)
2026-02-20T22:09:17.5715799Z          if not is_safe:
2026-02-20T22:09:17.5716067Z              logger.warning(f"Prompt utilisateur rejeté pour sécurité: {safety_reason}")
2026-02-20T22:09:17.5716207Z              from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5716268Z +
2026-02-20T22:09:17.5716427Z              return sse_error_response(f"Prompt invalide: {safety_reason}")
2026-02-20T22:09:17.5716542Z          prompt = sanitize_user_prompt(prompt_raw)
2026-02-20T22:09:17.5716603Z -        
2026-02-20T22:09:17.5716662Z +
2026-02-20T22:09:17.5716869Z          # Normaliser et valider les paramètres de manière centralisée
2026-02-20T22:09:17.5716973Z -        from server.exercise_generator import \
2026-02-20T22:09:17.5717075Z -            normalize_and_validate_exercise_params
2026-02-20T22:09:17.5717135Z -        
2026-02-20T22:09:17.5717486Z -        exercise_type, age_group, derived_difficulty = normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5717547Z -        
2026-02-20T22:09:17.5717750Z +        from server.exercise_generator import normalize_and_validate_exercise_params
2026-02-20T22:09:17.5717935Z +
2026-02-20T22:09:17.5718055Z +        exercise_type, age_group, derived_difficulty = (
2026-02-20T22:09:17.5718241Z +            normalize_and_validate_exercise_params(exercise_type_raw, age_group_raw)
2026-02-20T22:09:17.5718302Z +        )
2026-02-20T22:09:17.5718365Z +
2026-02-20T22:09:17.5718622Z          # Vérifier que la clé OpenAI est configurée
2026-02-20T22:09:17.5718716Z          if not settings.OPENAI_API_KEY:
2026-02-20T22:09:17.5718847Z              from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5718906Z +
2026-02-20T22:09:17.5719112Z              return sse_error_response("OpenAI API key non configurée")
2026-02-20T22:09:17.5719178Z -        
2026-02-20T22:09:17.5719238Z +
2026-02-20T22:09:17.5719315Z          async def generate():
2026-02-20T22:09:17.5719378Z              try:
2026-02-20T22:09:17.5719543Z                  # Importer OpenAI de manière conditionnelle
2026-02-20T22:09:17.5719609Z                  try:
2026-02-20T22:09:17.5719703Z                      from openai import AsyncOpenAI
2026-02-20T22:09:17.5719798Z                  except ImportError:
2026-02-20T22:09:17.5720150Z                      yield f"data: {json.dumps({'type': 'error', 'message': 'Bibliothèque OpenAI non installée'})}\n\n"
2026-02-20T22:09:17.5720220Z                      return
2026-02-20T22:09:17.5720289Z -                
2026-02-20T22:09:17.5720355Z +
2026-02-20T22:09:17.5720497Z                  client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
2026-02-20T22:09:17.5720557Z -                
2026-02-20T22:09:17.5720622Z +
2026-02-20T22:09:17.5720805Z                  # Définir les plages de nombres selon la difficulté
2026-02-20T22:09:17.5720888Z                  difficulty_ranges = {
2026-02-20T22:09:17.5721128Z -                    "INITIE": {"min": 1, "max": 20, "desc": "nombres simples de 1 à 20"},
2026-02-20T22:09:17.5721202Z +                    "INITIE": {
2026-02-20T22:09:17.5721276Z +                        "min": 1,
2026-02-20T22:09:17.5721349Z +                        "max": 20,
2026-02-20T22:09:17.5721521Z +                        "desc": "nombres simples de 1 à 20",
2026-02-20T22:09:17.5721589Z +                    },
2026-02-20T22:09:17.5721806Z                      "PADAWAN": {"min": 1, "max": 100, "desc": "nombres jusqu'à 100"},
2026-02-20T22:09:17.5722135Z -                    "CHEVALIER": {"min": 10, "max": 500, "desc": "nombres jusqu'à 500, calculs intermédiaires"},
2026-02-20T22:09:17.5722433Z -                    "MAITRE": {"min": 50, "max": 1000, "desc": "nombres jusqu'à 1000, problèmes complexes"},
2026-02-20T22:09:17.5722726Z -                    "GRAND_MAITRE": {"min": 100, "max": 10000, "desc": "grands nombres, problèmes avancés"}
2026-02-20T22:09:17.5722809Z +                    "CHEVALIER": {
2026-02-20T22:09:17.5722878Z +                        "min": 10,
2026-02-20T22:09:17.5722948Z +                        "max": 500,
2026-02-20T22:09:17.5723406Z +                        "desc": "nombres jusqu'à 500, calculs intermédiaires",
2026-02-20T22:09:17.5723497Z +                    },
2026-02-20T22:09:17.5723571Z +                    "MAITRE": {
2026-02-20T22:09:17.5723641Z +                        "min": 50,
2026-02-20T22:09:17.5723722Z +                        "max": 1000,
2026-02-20T22:09:17.5723934Z +                        "desc": "nombres jusqu'à 1000, problèmes complexes",
2026-02-20T22:09:17.5724000Z +                    },
2026-02-20T22:09:17.5724093Z +                    "GRAND_MAITRE": {
2026-02-20T22:09:17.5724162Z +                        "min": 100,
2026-02-20T22:09:17.5724234Z +                        "max": 10000,
2026-02-20T22:09:17.5724413Z +                        "desc": "grands nombres, problèmes avancés",
2026-02-20T22:09:17.5724486Z +                    },
2026-02-20T22:09:17.5724550Z                  }
2026-02-20T22:09:17.5724792Z -                diff_info = difficulty_ranges.get(derived_difficulty, difficulty_ranges["PADAWAN"])
2026-02-20T22:09:17.5724863Z -                
2026-02-20T22:09:17.5724963Z +                diff_info = difficulty_ranges.get(
2026-02-20T22:09:17.5725235Z +                    derived_difficulty, difficulty_ranges["PADAWAN"]
2026-02-20T22:09:17.5725306Z +                )
2026-02-20T22:09:17.5725366Z +
2026-02-20T22:09:17.5725517Z                  # Déterminer le contexte thématique
2026-02-20T22:09:17.5726094Z -                has_custom_theme = prompt and any(word in prompt.lower() for word in ['thème', 'theme', 'contexte', 'histoire', 'univers', 'monde'])
2026-02-20T22:09:17.5726579Z -                default_theme = "spatial/galactique (vaisseaux, planètes, étoiles - sans références Star Wars)" if not has_custom_theme else ""
2026-02-20T22:09:17.5726644Z -                
2026-02-20T22:09:17.5726742Z +                has_custom_theme = prompt and any(
2026-02-20T22:09:17.5726836Z +                    word in prompt.lower()
2026-02-20T22:09:17.5726910Z +                    for word in [
2026-02-20T22:09:17.5727016Z +                        "thème",
2026-02-20T22:09:17.5727091Z +                        "theme",
2026-02-20T22:09:17.5727173Z +                        "contexte",
2026-02-20T22:09:17.5727243Z +                        "histoire",
2026-02-20T22:09:17.5727313Z +                        "univers",
2026-02-20T22:09:17.5727387Z +                        "monde",
2026-02-20T22:09:17.5727451Z +                    ]
2026-02-20T22:09:17.5727523Z +                )
2026-02-20T22:09:17.5727601Z +                default_theme = (
2026-02-20T22:09:17.5727904Z +                    "spatial/galactique (vaisseaux, planètes, étoiles - sans références Star Wars)"
2026-02-20T22:09:17.5727991Z +                    if not has_custom_theme
2026-02-20T22:09:17.5728071Z +                    else ""
2026-02-20T22:09:17.5728132Z +                )
2026-02-20T22:09:17.5728190Z +
2026-02-20T22:09:17.5728361Z                  # Construire le prompt système optimisé
2026-02-20T22:09:17.5728646Z                  system_prompt = f"""Tu es un créateur d'exercices mathématiques pédagogiques.
2026-02-20T22:09:17.5728706Z  
2026-02-20T22:09:17.5728794Z  ## CONTRAINTES OBLIGATOIRES
2026-02-20T22:09:17.5728976Z  - Type d'exercice : **{exercise_type}** (STRICTEMENT ce type, aucun autre)
2026-02-20T22:09:17.5729044Z @@ -734,139 +952,155 @@
2026-02-20T22:09:17.5729204Z    "correct_answer": "Réponse numérique uniquement",
2026-02-20T22:09:17.5729324Z    "choices": ["choix1", "choix2", "choix3", "choix4"],
2026-02-20T22:09:17.5729496Z    "explanation": "Explication pédagogique détaillée",
2026-02-20T22:09:17.5729626Z    "hint": "Piste sans révéler la solution"
2026-02-20T22:09:17.5729689Z  }}"""
2026-02-20T22:09:17.5729755Z -                
2026-02-20T22:09:17.5729814Z +
2026-02-20T22:09:17.5730142Z                  # Modèle : o1/o3 pour fractions/texte/mixte/divers quand OPENAI_MODEL_REASONING est défini
2026-02-20T22:09:17.5730297Z                  _reasoning_types = ("fractions", "texte", "mixte", "divers")
2026-02-20T22:09:17.5730506Z -                model = (settings.OPENAI_MODEL_REASONING if settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5730700Z -                         and exercise_type in _reasoning_types else settings.OPENAI_MODEL)
2026-02-20T22:09:17.5730772Z +                model = (
2026-02-20T22:09:17.5730873Z +                    settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5730983Z +                    if settings.OPENAI_MODEL_REASONING
2026-02-20T22:09:17.5731089Z +                    and exercise_type in _reasoning_types
2026-02-20T22:09:17.5731187Z +                    else settings.OPENAI_MODEL
2026-02-20T22:09:17.5731251Z +                )
2026-02-20T22:09:17.5731348Z                  use_o1 = AIConfig.is_o1_model(model)
2026-02-20T22:09:17.5731447Z                  use_o3 = AIConfig.is_o3_model(model)
2026-02-20T22:09:17.5731518Z                  if use_o1:
2026-02-20T22:09:17.5731935Z                      system_prompt += "\n\nCRITIQUE : Retourne UNIQUEMENT un objet JSON valide, sans texte ou markdown avant/après."
2026-02-20T22:09:17.5731997Z -                
2026-02-20T22:09:17.5732063Z +
2026-02-20T22:09:17.5732477Z                  # Construire le prompt utilisateur - PRIORITÉ à la description personnalisée
2026-02-20T22:09:17.5732576Z                  if prompt and prompt.strip():
2026-02-20T22:09:17.5732735Z                      # Si l'utilisateur a une description, elle est PRIORITAIRE
2026-02-20T22:09:17.5733370Z                      user_prompt = f"""INSTRUCTIONS PERSONNALISÉES DE L'UTILISATEUR (PRIORITAIRES) :
2026-02-20T22:09:17.5733459Z  "{prompt.strip()}"
2026-02-20T22:09:17.5733530Z  
2026-02-20T22:09:17.5733901Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py
2026-02-20T22:09:17.5734343Z  Crée un exercice de type {exercise_type} (niveau {derived_difficulty}) en respectant ces instructions personnalisées."""
2026-02-20T22:09:17.5734419Z                  else:
2026-02-20T22:09:17.5734673Z                      # Pas de description personnalisée, utiliser le contexte par défaut
2026-02-20T22:09:17.5735153Z                      user_prompt = f"Crée un exercice de type {exercise_type} pour le niveau {derived_difficulty} avec un contexte spatial engageant."
2026-02-20T22:09:17.5735235Z -                
2026-02-20T22:09:17.5735294Z +
2026-02-20T22:09:17.5735516Z                  # Envoyer un message de démarrage (sans afficher le JSON brut)
2026-02-20T22:09:17.5735833Z                  yield f"data: {json.dumps({'type': 'status', 'message': 'Génération en cours...'})}\n\n"
2026-02-20T22:09:17.5735903Z -                
2026-02-20T22:09:17.5735970Z +
2026-02-20T22:09:17.5736048Z                  api_kwargs = {
2026-02-20T22:09:17.5736129Z                      "model": model,
2026-02-20T22:09:17.5736204Z                      "messages": [
2026-02-20T22:09:17.5736325Z                          {"role": "system", "content": system_prompt},
2026-02-20T22:09:17.5736438Z -                        {"role": "user", "content": user_prompt}
2026-02-20T22:09:17.5736560Z +                        {"role": "user", "content": user_prompt},
2026-02-20T22:09:17.5736631Z                      ],
2026-02-20T22:09:17.5736713Z                      "stream": True,
2026-02-20T22:09:17.5736783Z                  }
2026-02-20T22:09:17.5736853Z                  if use_o1:
2026-02-20T22:09:17.5736970Z                      api_kwargs["max_completion_tokens"] = 4000
2026-02-20T22:09:17.5737053Z                  elif use_o3:
2026-02-20T22:09:17.5737197Z                      api_kwargs["response_format"] = {"type": "json_object"}
2026-02-20T22:09:17.5737309Z                      api_kwargs["max_completion_tokens"] = 4000
2026-02-20T22:09:17.5737585Z -                    api_kwargs["reasoning_effort"] = "low"  # Exercices plus simples que défis
2026-02-20T22:09:17.5737694Z +                    api_kwargs["reasoning_effort"] = (
2026-02-20T22:09:17.5737862Z +                        "low"  # Exercices plus simples que défis
2026-02-20T22:09:17.5737931Z +                    )
2026-02-20T22:09:17.5738004Z                  else:
2026-02-20T22:09:17.5738102Z                      api_kwargs["temperature"] = 0.7
2026-02-20T22:09:17.5738246Z                      api_kwargs["response_format"] = {"type": "json_object"}
2026-02-20T22:09:17.5738314Z -                
2026-02-20T22:09:17.5738373Z +
2026-02-20T22:09:17.5738530Z                  stream = await client.chat.completions.create(**api_kwargs)
2026-02-20T22:09:17.5738600Z -                
2026-02-20T22:09:17.5738667Z +
2026-02-20T22:09:17.5738746Z                  full_response = ""
2026-02-20T22:09:17.5738943Z                  # Ne pas envoyer les chunks JSON au client (pas utile pour l'utilisateur)
2026-02-20T22:09:17.5739150Z                  # On accumule juste la réponse complète en arrière-plan
2026-02-20T22:09:17.5739237Z                  async for chunk in stream:
2026-02-20T22:09:17.5739376Z                      if chunk.choices and chunk.choices[0].delta.content:
2026-02-20T22:09:17.5739496Z                          content = chunk.choices[0].delta.content
2026-02-20T22:09:17.5739590Z                          full_response += content
2026-02-20T22:09:17.5739976Z                          # Ne plus envoyer les chunks JSON au client (masqué pour meilleure UX)
2026-02-20T22:09:17.5740044Z -                
2026-02-20T22:09:17.5740111Z +
2026-02-20T22:09:17.5740385Z                  # Parser la réponse JSON complète (o1 peut renvoyer du texte autour du JSON)
2026-02-20T22:09:17.5740606Z                  from app.utils.json_utils import extract_json_from_text
2026-02-20T22:09:17.5740677Z  
2026-02-20T22:09:17.5740745Z                  try:
2026-02-20T22:09:17.5740884Z                      exercise_data = extract_json_from_text(full_response)
2026-02-20T22:09:17.5740953Z -                    
2026-02-20T22:09:17.5741013Z +
2026-02-20T22:09:17.5741235Z                      # Normaliser les données pour correspondre au format attendu
2026-02-20T22:09:17.5741467Z                      # Utiliser les valeurs normalisées (déjà normalisées plus haut)
2026-02-20T22:09:17.5741561Z                      normalized_exercise = {
2026-02-20T22:09:17.5741747Z                          "exercise_type": exercise_type,  # Déjà normalisé
2026-02-20T22:09:17.5741936Z                          "age_group": age_group,  # Groupe d'âge normalisé
2026-02-20T22:09:17.5742210Z                          "difficulty": derived_difficulty,  # Difficulté dérivée du groupe d'âge
2026-02-20T22:09:17.5742431Z -                        "title": exercise_data.get("title", f"Exercice {exercise_type} {age_group}"),
2026-02-20T22:09:17.5742527Z +                        "title": exercise_data.get(
2026-02-20T22:09:17.5742658Z +                            "title", f"Exercice {exercise_type} {age_group}"
2026-02-20T22:09:17.5742727Z +                        ),
2026-02-20T22:09:17.5742851Z                          "question": exercise_data.get("question", ""),
2026-02-20T22:09:17.5743161Z                          "correct_answer": str(exercise_data.get("correct_answer", "")),
2026-02-20T22:09:17.5743283Z                          "choices": exercise_data.get("choices", []),
2026-02-20T22:09:17.5743419Z                          "explanation": exercise_data.get("explanation", ""),
2026-02-20T22:09:17.5743534Z                          "hint": exercise_data.get("hint", ""),
2026-02-20T22:09:17.5743630Z                          "ai_generated": True,
2026-02-20T22:09:17.5743722Z -                        "tags": "ai,generated"
2026-02-20T22:09:17.5743814Z +                        "tags": "ai,generated",
2026-02-20T22:09:17.5743885Z                      }
2026-02-20T22:09:17.5743949Z -                    
2026-02-20T22:09:17.5744009Z +
2026-02-20T22:09:17.5744200Z                      # Optionnellement sauvegarder en base de données
2026-02-20T22:09:17.5744269Z                      try:
2026-02-20T22:09:17.5744406Z                          # Extraire la locale depuis le header Accept-Language
2026-02-20T22:09:17.5744560Z                          from app.utils.translation import parse_accept_language
2026-02-20T22:09:17.5744629Z +
2026-02-20T22:09:17.5744786Z                          accept_language = request.headers.get("Accept-Language")
2026-02-20T22:09:17.5744934Z                          locale = parse_accept_language(accept_language) or "fr"
2026-02-20T22:09:17.5745007Z -                        
2026-02-20T22:09:17.5745066Z +
2026-02-20T22:09:17.5745165Z                          async with db_session() as db:
2026-02-20T22:09:17.5745383Z -                            created_exercise = EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5745460Z -                                db=db,
2026-02-20T22:09:17.5745604Z -                                exercise_type=normalized_exercise['exercise_type'],
2026-02-20T22:09:17.5745728Z -                                age_group=normalized_exercise['age_group'],
2026-02-20T22:09:17.5745863Z -                                difficulty=normalized_exercise['difficulty'],
2026-02-20T22:09:17.5745974Z -                                title=normalized_exercise['title'],
2026-02-20T22:09:17.5746092Z -                                question=normalized_exercise['question'],
2026-02-20T22:09:17.5746371Z -                                correct_answer=normalized_exercise['correct_answer'],
2026-02-20T22:09:17.5746488Z -                                choices=normalized_exercise['choices'],
2026-02-20T22:09:17.5746620Z -                                explanation=normalized_exercise['explanation'],
2026-02-20T22:09:17.5746841Z -                                hint=normalized_exercise.get('hint'),
2026-02-20T22:09:17.5746992Z -                                tags=normalized_exercise.get('tags', 'ai,generated'),
2026-02-20T22:09:17.5747085Z -                                ai_generated=True,
2026-02-20T22:09:17.5747177Z -                                locale=locale
2026-02-20T22:09:17.5747268Z +                            created_exercise = (
2026-02-20T22:09:17.5747414Z +                                EnhancedServerAdapter.create_generated_exercise(
2026-02-20T22:09:17.5747497Z +                                    db=db,
2026-02-20T22:09:17.5747645Z +                                    exercise_type=normalized_exercise["exercise_type"],
2026-02-20T22:09:17.5747780Z +                                    age_group=normalized_exercise["age_group"],
2026-02-20T22:09:17.5747913Z +                                    difficulty=normalized_exercise["difficulty"],
2026-02-20T22:09:17.5748038Z +                                    title=normalized_exercise["title"],
2026-02-20T22:09:17.5748162Z +                                    question=normalized_exercise["question"],
2026-02-20T22:09:17.5748274Z +                                    correct_answer=normalized_exercise[
2026-02-20T22:09:17.5748373Z +                                        "correct_answer"
2026-02-20T22:09:17.5748444Z +                                    ],
2026-02-20T22:09:17.5748559Z +                                    choices=normalized_exercise["choices"],
2026-02-20T22:09:17.5748717Z +                                    explanation=normalized_exercise["explanation"],
2026-02-20T22:09:17.5748831Z +                                    hint=normalized_exercise.get("hint"),
2026-02-20T22:09:17.5748947Z +                                    tags=normalized_exercise.get(
2026-02-20T22:09:17.5749051Z +                                        "tags", "ai,generated"
2026-02-20T22:09:17.5749122Z +                                    ),
2026-02-20T22:09:17.5749217Z +                                    ai_generated=True,
2026-02-20T22:09:17.5749301Z +                                    locale=locale,
2026-02-20T22:09:17.5749377Z +                                )
2026-02-20T22:09:17.5749448Z                              )
2026-02-20T22:09:17.5749537Z                              if created_exercise:
2026-02-20T22:09:17.5749686Z -                                normalized_exercise['id'] = created_exercise['id']
2026-02-20T22:09:17.5749821Z +                                normalized_exercise["id"] = created_exercise["id"]
2026-02-20T22:09:17.5749919Z                      except Exception as save_error:
2026-02-20T22:09:17.5750095Z                          logger.warning(f"Erreur lors de la sauvegarde: {save_error}")
2026-02-20T22:09:17.5750270Z                          # Continuer même si la sauvegarde échoue
2026-02-20T22:09:17.5750337Z -                    
2026-02-20T22:09:17.5750397Z +
2026-02-20T22:09:17.5750495Z                      # Envoyer l'exercice complet
2026-02-20T22:09:17.5750737Z                      yield f"data: {json.dumps({'type': 'exercise', 'exercise': normalized_exercise})}\n\n"
2026-02-20T22:09:17.5750802Z -                    
2026-02-20T22:09:17.5750868Z +
2026-02-20T22:09:17.5750985Z                  except json.JSONDecodeError as json_error:
2026-02-20T22:09:17.5751277Z                      yield f"data: {json.dumps({'type': 'error', 'message': f'Erreur de parsing JSON: {str(json_error)}'})}\n\n"
2026-02-20T22:09:17.5751348Z -                    
2026-02-20T22:09:17.5751409Z +
2026-02-20T22:09:17.5751516Z              except Exception as ai_generation_error:
2026-02-20T22:09:17.5751772Z                  logger.error(f"Erreur lors de la génération IA: {ai_generation_error}")
2026-02-20T22:09:17.5751972Z                  logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5752195Z                  yield f"data: {json.dumps({'type': 'error', 'message': str(ai_generation_error)})}\n\n"
2026-02-20T22:09:17.5752258Z -        
2026-02-20T22:09:17.5752394Z +
2026-02-20T22:09:17.5752481Z          return StreamingResponse(
2026-02-20T22:09:17.5752555Z              generate(),
2026-02-20T22:09:17.5752654Z              media_type="text/event-stream",
2026-02-20T22:09:17.5752723Z              headers={
2026-02-20T22:09:17.5752815Z                  "Cache-Control": "no-cache",
2026-02-20T22:09:17.5752901Z                  "Connection": "keep-alive",
2026-02-20T22:09:17.5753400Z                  "X-Accel-Buffering": "no",  # Désactiver le buffering pour nginx
2026-02-20T22:09:17.5753469Z -            }
2026-02-20T22:09:17.5753531Z -        )
2026-02-20T22:09:17.5753601Z -        
2026-02-20T22:09:17.5753661Z +            },
2026-02-20T22:09:17.5753740Z +        )
2026-02-20T22:09:17.5753801Z +
2026-02-20T22:09:17.5753899Z      except Exception as stream_error:
2026-02-20T22:09:17.5754084Z          logger.error(f"Erreur dans generate_ai_exercise_stream: {stream_error}")
2026-02-20T22:09:17.5754179Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5754318Z          from app.utils.sse_utils import sse_error_response
2026-02-20T22:09:17.5754378Z +
2026-02-20T22:09:17.5754484Z          return sse_error_response(str(stream_error))
2026-02-20T22:09:17.5754543Z  
2026-02-20T22:09:17.5754606Z  
2026-02-20T22:09:17.5754674Z  @optional_auth
2026-02-20T22:09:17.5754807Z  async def get_completed_exercises_ids(request: Request):
2026-02-20T22:09:17.5754883Z @@ -877,17 +1111,18 @@
2026-02-20T22:09:17.5754947Z      try:
2026-02-20T22:09:17.5755217Z          # Utilisateur optionnellement authentifié via le décorateur @optional_auth
2026-02-20T22:09:17.5755317Z          current_user = request.state.user
2026-02-20T22:09:17.5755394Z          if not current_user:
2026-02-20T22:09:17.5755555Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:17.5755618Z -        
2026-02-20T22:09:17.5755683Z +
2026-02-20T22:09:17.5755768Z          user_id = current_user.get("id")
2026-02-20T22:09:17.5755839Z          if not user_id:
2026-02-20T22:09:17.5755996Z              return JSONResponse({"completed_ids": []}, status_code=200)
2026-02-20T22:09:17.5756056Z -        
2026-02-20T22:09:17.5756114Z +
2026-02-20T22:09:17.5756337Z          # Récupérer les IDs d'exercices avec au moins une tentative correcte
2026-02-20T22:09:17.5756472Z          from server.database import get_db_connection
2026-02-20T22:09:17.5756532Z +
2026-02-20T22:09:17.5756611Z          conn = get_db_connection()
2026-02-20T22:09:17.5756696Z          cursor = conn.cursor()
2026-02-20T22:09:17.5756760Z          try:
2026-02-20T22:09:17.5756830Z              query = """
2026-02-20T22:09:17.5756922Z                  SELECT DISTINCT exercise_id 
2026-02-20T22:09:17.5757001Z @@ -895,40 +1130,44 @@
2026-02-20T22:09:17.5757106Z                  WHERE user_id = %s AND is_correct = true
2026-02-20T22:09:17.5757169Z              """
2026-02-20T22:09:17.5757266Z              cursor.execute(query, (user_id,))
2026-02-20T22:09:17.5757350Z              rows = cursor.fetchall()
2026-02-20T22:09:17.5757496Z              completed_ids = [row[0] for row in rows] if rows else []
2026-02-20T22:09:17.5757572Z -            
2026-02-20T22:09:17.5757947Z -            logger.debug(f"Récupération de {len(completed_ids)} exercices complétés pour l'utilisateur {user_id}")
2026-02-20T22:09:17.5758008Z +
2026-02-20T22:09:17.5758083Z +            logger.debug(
2026-02-20T22:09:17.5758409Z +                f"Récupération de {len(completed_ids)} exercices complétés pour l'utilisateur {user_id}"
2026-02-20T22:09:17.5758474Z +            )
2026-02-20T22:09:17.5758610Z              return JSONResponse({"completed_ids": completed_ids})
2026-02-20T22:09:17.5758680Z          finally:
2026-02-20T22:09:17.5758907Z              cursor.close()
2026-02-20T22:09:17.5758979Z              conn.close()
2026-02-20T22:09:17.5759046Z -            
2026-02-20T22:09:17.5759105Z +
2026-02-20T22:09:17.5759216Z      except Exception as completed_retrieval_error:
2026-02-20T22:09:17.5759670Z -        logger.error(f"Erreur lors de la récupération des exercices complétés: {completed_retrieval_error}")
2026-02-20T22:09:17.5759751Z +        logger.error(
2026-02-20T22:09:17.5760056Z +            f"Erreur lors de la récupération des exercices complétés: {completed_retrieval_error}"
2026-02-20T22:09:17.5760120Z +        )
2026-02-20T22:09:17.5760227Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.5760335Z          return ErrorHandler.create_error_response(
2026-02-20T22:09:17.5760424Z              error=completed_retrieval_error,
2026-02-20T22:09:17.5760499Z              status_code=500,
2026-02-20T22:09:17.5760751Z -            user_message="Erreur lors de la récupération des exercices complétés."
2026-02-20T22:09:17.5761004Z +            user_message="Erreur lors de la récupération des exercices complétés.",
2026-02-20T22:09:17.5761067Z          )
2026-02-20T22:09:17.5761133Z  
2026-02-20T22:09:17.5761191Z  
2026-02-20T22:09:17.5761301Z  async def get_exercises_stats(request: Request):
2026-02-20T22:09:17.5761368Z      """
2026-02-20T22:09:17.5761589Z      Statistiques globales des Épreuves de l'Académie (exercices).
2026-02-20T22:09:17.5761651Z -    
2026-02-20T22:09:17.5761711Z +
2026-02-20T22:09:17.5761799Z      Route: GET /api/exercises/stats
2026-02-20T22:09:17.5761859Z -    
2026-02-20T22:09:17.5761920Z +
2026-02-20T22:09:17.5762100Z      Retourne les statistiques sur l'ensemble des exercices disponibles :
2026-02-20T22:09:17.5762244Z      - Nombre total d'épreuves dans l'Académie
2026-02-20T22:09:17.5762397Z      - Répartition par discipline (type d'exercice)
2026-02-20T22:09:17.5762527Z      - Répartition par rang (difficulté)
2026-02-20T22:09:17.5762704Z      - Répartition par groupe d'apprentis (groupe d'âge)
2026-02-20T22:09:17.5762845Z      - Statistiques de complétion globales
2026-02-20T22:09:17.5762906Z -    
2026-02-20T22:09:17.5763164Z +
2026-02-20T22:09:17.5763383Z      Thème Académie des Sages :
2026-02-20T22:09:17.5763525Z      - Types → Disciplines mathématiques
2026-02-20T22:09:17.5763758Z      - Difficultés → Rangs de l'Académie (Initié → Grand Maître)
2026-02-20T22:09:17.5763906Z      - Groupes d'âge → Niveaux d'apprentissage
2026-02-20T22:09:17.5763967Z      """
2026-02-20T22:09:17.5764037Z @@ -937,232 +1176,353 @@
2026-02-20T22:09:17.5764139Z          logger.debug("Import des modules...")
2026-02-20T22:09:17.5764231Z          from sqlalchemy import func, case
2026-02-20T22:09:17.5764426Z          from app.models.exercise import Exercise, ExerciseType, DifficultyLevel
2026-02-20T22:09:17.5764544Z          from app.models.attempt import Attempt
2026-02-20T22:09:17.5764752Z          from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.5764813Z +
2026-02-20T22:09:17.5764908Z          logger.debug("Imports OK")
2026-02-20T22:09:17.5764977Z -        
2026-02-20T22:09:17.5765040Z +
2026-02-20T22:09:17.5765126Z          async with db_session() as db:
2026-02-20T22:09:17.5765362Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5765606Z              # 1. STATISTIQUES GÉNÉRALES - Chroniques de l'Académie (Exercices)
2026-02-20T22:09:17.5765818Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5765885Z -            
2026-02-20T22:09:17.5766053Z -            total_exercises = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5766142Z -                Exercise.is_active == True
2026-02-20T22:09:17.5766216Z -            ).scalar() or 0
2026-02-20T22:09:17.5766283Z -            
2026-02-20T22:09:17.5766430Z -            total_archived = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5766519Z -                Exercise.is_archived == True
2026-02-20T22:09:17.5766745Z -            ).scalar() or 0
2026-02-20T22:09:17.5766806Z -            
2026-02-20T22:09:17.5766966Z -            ai_generated_count = db.query(func.count(Exercise.id)).filter(
2026-02-20T22:09:17.5767063Z -                Exercise.ai_generated == True,
2026-02-20T22:09:17.5767260Z -                Exercise.is_active == True
2026-02-20T22:09:17.5767336Z -            ).scalar() or 0
2026-02-20T22:09:17.5767399Z -            
2026-02-20T22:09:17.5767463Z +
2026-02-20T22:09:17.5767541Z +            total_exercises = (
2026-02-20T22:09:17.5767642Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5767747Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5767817Z +                .scalar()
2026-02-20T22:09:17.5767883Z +                or 0
2026-02-20T22:09:17.5767947Z +            )
2026-02-20T22:09:17.5768015Z +
2026-02-20T22:09:17.5768088Z +            total_archived = (
2026-02-20T22:09:17.5768185Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5768298Z +                .filter(Exercise.is_archived == True)
2026-02-20T22:09:17.5768366Z +                .scalar()
2026-02-20T22:09:17.5768431Z +                or 0
2026-02-20T22:09:17.5768493Z +            )
2026-02-20T22:09:17.5768556Z +
2026-02-20T22:09:17.5768640Z +            ai_generated_count = (
2026-02-20T22:09:17.5768732Z +                db.query(func.count(Exercise.id))
2026-02-20T22:09:17.5768920Z +                .filter(Exercise.ai_generated == True, Exercise.is_active == True)
2026-02-20T22:09:17.5768988Z +                .scalar()
2026-02-20T22:09:17.5769052Z +                or 0
2026-02-20T22:09:17.5769112Z +            )
2026-02-20T22:09:17.5769179Z +
2026-02-20T22:09:17.5769400Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5769583Z              # 2. RÉPARTITION PAR DISCIPLINE (Type d'exercice)
2026-02-20T22:09:17.5769799Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5769872Z -            
2026-02-20T22:09:17.5769930Z +
2026-02-20T22:09:17.5770074Z              # Noms des disciplines mathématiques
2026-02-20T22:09:17.5770155Z              discipline_names = {
2026-02-20T22:09:17.5770247Z                  "ADDITION": "Art de l'Addition",
2026-02-20T22:09:17.5770436Z                  "SOUSTRACTION": "Maîtrise de la Soustraction",
2026-02-20T22:09:17.5770567Z                  "MULTIPLICATION": "Puissance Multiplicative",
2026-02-20T22:09:17.5770665Z                  "DIVISION": "Science de la Division",
2026-02-20T22:09:17.5770760Z                  "FRACTIONS": "Sagesse des Fractions",
2026-02-20T22:09:17.5770859Z                  "GEOMETRIE": "Vision Spatiale",
2026-02-20T22:09:17.5770985Z                  "TEXTE": "Énigmes Logiques",
2026-02-20T22:09:17.5771118Z                  "MIXTE": "Épreuves Combinées",
2026-02-20T22:09:17.5771245Z -                "DIVERS": "Défis Variés"
2026-02-20T22:09:17.5771366Z +                "DIVERS": "Défis Variés",
2026-02-20T22:09:17.5771518Z              }
2026-02-20T22:09:17.5771579Z -            
2026-02-20T22:09:17.5771674Z -            by_type_query = db.query(
2026-02-20T22:09:17.5771760Z -                Exercise.exercise_type,
2026-02-20T22:09:17.5771864Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5772014Z -            ).filter(
2026-02-20T22:09:17.5772102Z -                Exercise.is_active == True
2026-02-20T22:09:17.5772208Z -            ).group_by(Exercise.exercise_type).all()
2026-02-20T22:09:17.5772269Z -            
2026-02-20T22:09:17.5772335Z +
2026-02-20T22:09:17.5772411Z +            by_type_query = (
2026-02-20T22:09:17.5772610Z +                db.query(Exercise.exercise_type, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5772712Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5772809Z +                .group_by(Exercise.exercise_type)
2026-02-20T22:09:17.5772876Z +                .all()
2026-02-20T22:09:17.5772942Z +            )
2026-02-20T22:09:17.5773251Z +
2026-02-20T22:09:17.5773337Z              by_discipline = {}
2026-02-20T22:09:17.5773462Z              for exercise_type, count in by_type_query:
2026-02-20T22:09:17.5773658Z                  type_upper = str(exercise_type).upper() if exercise_type else "DIVERS"
2026-02-20T22:09:17.5773832Z                  discipline_name = discipline_names.get(type_upper, type_upper)
2026-02-20T22:09:17.5773926Z                  by_discipline[type_upper] = {
2026-02-20T22:09:17.5774009Z                      "count": count,
2026-02-20T22:09:17.5774115Z                      "discipline_name": discipline_name,
2026-02-20T22:09:17.5774348Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5774431Z +                    "percentage": (
2026-02-20T22:09:17.5774548Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5774636Z +                        if total_exercises > 0
2026-02-20T22:09:17.5774709Z +                        else 0
2026-02-20T22:09:17.5774781Z +                    ),
2026-02-20T22:09:17.5774845Z                  }
2026-02-20T22:09:17.5774904Z -            
2026-02-20T22:09:17.5774969Z +
2026-02-20T22:09:17.5775198Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5775355Z              # 3. RÉPARTITION PAR RANG (Difficulté)
2026-02-20T22:09:17.5775572Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5775635Z -            
2026-02-20T22:09:17.5775694Z +
2026-02-20T22:09:17.5775847Z              # Rangs de l'Académie avec descriptions
2026-02-20T22:09:17.5775932Z              academy_ranks = {
2026-02-20T22:09:17.5776253Z -                "INITIE": {"name": "Initié", "description": "Premier pas vers la sagesse", "min_age": 6},
2026-02-20T22:09:17.5776480Z -                "PADAWAN": {"name": "Apprenti", "description": "En cours de formation", "min_age": 9},
2026-02-20T22:09:17.5776794Z -                "CHEVALIER": {"name": "Chevalier", "description": "Maîtrise confirmée", "min_age": 12},
2026-02-20T22:09:17.5777059Z -                "MAITRE": {"name": "Maître", "description": "Sagesse avancée", "min_age": 15},
2026-02-20T22:09:17.5777393Z -                "GRAND_MAITRE": {"name": "Grand Maître", "description": "Sommité de l'Académie", "min_age": 17}
2026-02-20T22:09:17.5777473Z +                "INITIE": {
2026-02-20T22:09:17.5777589Z +                    "name": "Initié",
2026-02-20T22:09:17.5777717Z +                    "description": "Premier pas vers la sagesse",
2026-02-20T22:09:17.5777792Z +                    "min_age": 6,
2026-02-20T22:09:17.5777860Z +                },
2026-02-20T22:09:17.5777933Z +                "PADAWAN": {
2026-02-20T22:09:17.5778014Z +                    "name": "Apprenti",
2026-02-20T22:09:17.5778133Z +                    "description": "En cours de formation",
2026-02-20T22:09:17.5778203Z +                    "min_age": 9,
2026-02-20T22:09:17.5778404Z +                },
2026-02-20T22:09:17.5778486Z +                "CHEVALIER": {
2026-02-20T22:09:17.5778568Z +                    "name": "Chevalier",
2026-02-20T22:09:17.5778730Z +                    "description": "Maîtrise confirmée",
2026-02-20T22:09:17.5778805Z +                    "min_age": 12,
2026-02-20T22:09:17.5779035Z +                },
2026-02-20T22:09:17.5779110Z +                "MAITRE": {
2026-02-20T22:09:17.5779226Z +                    "name": "Maître",
2026-02-20T22:09:17.5779381Z +                    "description": "Sagesse avancée",
2026-02-20T22:09:17.5779454Z +                    "min_age": 15,
2026-02-20T22:09:17.5779515Z +                },
2026-02-20T22:09:17.5779591Z +                "GRAND_MAITRE": {
2026-02-20T22:09:17.5779725Z +                    "name": "Grand Maître",
2026-02-20T22:09:17.5779883Z +                    "description": "Sommité de l'Académie",
2026-02-20T22:09:17.5779954Z +                    "min_age": 17,
2026-02-20T22:09:17.5780022Z +                },
2026-02-20T22:09:17.5780094Z              }
2026-02-20T22:09:17.5780155Z -            
2026-02-20T22:09:17.5780251Z -            by_difficulty_query = db.query(
2026-02-20T22:09:17.5780334Z -                Exercise.difficulty,
2026-02-20T22:09:17.5780442Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5780517Z -            ).filter(
2026-02-20T22:09:17.5780609Z -                Exercise.is_active == True
2026-02-20T22:09:17.5780712Z -            ).group_by(Exercise.difficulty).all()
2026-02-20T22:09:17.5780775Z -            
2026-02-20T22:09:17.5780843Z +
2026-02-20T22:09:17.5780925Z +            by_difficulty_query = (
2026-02-20T22:09:17.5781115Z +                db.query(Exercise.difficulty, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5781214Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5781316Z +                .group_by(Exercise.difficulty)
2026-02-20T22:09:17.5781384Z +                .all()
2026-02-20T22:09:17.5781447Z +            )
2026-02-20T22:09:17.5781517Z +
2026-02-20T22:09:17.5781589Z              by_rank = {}
2026-02-20T22:09:17.5790925Z              for difficulty, count in by_difficulty_query:
2026-02-20T22:09:17.5791154Z                  diff_upper = str(difficulty).upper() if difficulty else "PADAWAN"
2026-02-20T22:09:17.5791615Z -                rank_info = academy_ranks.get(diff_upper, {"name": diff_upper, "description": "Rang spécial", "min_age": 10})
2026-02-20T22:09:17.5791719Z +                rank_info = academy_ranks.get(
2026-02-20T22:09:17.5791795Z +                    diff_upper,
2026-02-20T22:09:17.5792036Z +                    {"name": diff_upper, "description": "Rang spécial", "min_age": 10},
2026-02-20T22:09:17.5792098Z +                )
2026-02-20T22:09:17.5792189Z                  by_rank[diff_upper] = {
2026-02-20T22:09:17.5792265Z                      "count": count,
2026-02-20T22:09:17.5792364Z                      "rank_name": rank_info["name"],
2026-02-20T22:09:17.5792488Z                      "description": rank_info["description"],
2026-02-20T22:09:17.5792594Z                      "min_age": rank_info["min_age"],
2026-02-20T22:09:17.5792831Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5792915Z +                    "percentage": (
2026-02-20T22:09:17.5793181Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5793279Z +                        if total_exercises > 0
2026-02-20T22:09:17.5793351Z +                        else 0
2026-02-20T22:09:17.5793426Z +                    ),
2026-02-20T22:09:17.5793490Z                  }
2026-02-20T22:09:17.5793553Z -            
2026-02-20T22:09:17.5793622Z +
2026-02-20T22:09:17.5793853Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5794059Z              # 4. RÉPARTITION PAR GROUPE D'APPRENTIS (Groupe d'âge)
2026-02-20T22:09:17.5794280Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5794525Z -            
2026-02-20T22:09:17.5794585Z +
2026-02-20T22:09:17.5794674Z              apprentice_groups = {
2026-02-20T22:09:17.5794949Z -                "6-8": {"name": "Novices", "description": "Futurs espoirs de l'Académie"},
2026-02-20T22:09:17.5795356Z -                "8-10": {"name": "Apprentis Débutants", "description": "En début de formation"},
2026-02-20T22:09:17.5795630Z -                "9-11": {"name": "Apprentis Juniors", "description": "Formation intermédiaire"},
2026-02-20T22:09:17.5795926Z -                "10-12": {"name": "Apprentis Confirmés", "description": "Prêts pour les épreuves"},
2026-02-20T22:09:17.5796229Z -                "11-13": {"name": "Aspirants Chevaliers", "description": "Sur le chemin de la maîtrise"},
2026-02-20T22:09:17.5796479Z -                "12-14": {"name": "Chevaliers en Devenir", "description": "Défis avancés"},
2026-02-20T22:09:17.5796755Z -                "14-16": {"name": "Élite de l'Académie", "description": "Formation d'excellence"},
2026-02-20T22:09:17.5797021Z -                "15-17": {"name": "Candidats Maîtres", "description": "Ultimes épreuves"},
2026-02-20T22:09:17.5797263Z -                "17+": {"name": "Conseil des Sages", "description": "Niveau Grand Maître"}
2026-02-20T22:09:17.5797342Z +                "6-8": {
2026-02-20T22:09:17.5797433Z +                    "name": "Novices",
2026-02-20T22:09:17.5797612Z +                    "description": "Futurs espoirs de l'Académie",
2026-02-20T22:09:17.5797677Z +                },
2026-02-20T22:09:17.5797754Z +                "8-10": {
2026-02-20T22:09:17.5797895Z +                    "name": "Apprentis Débutants",
2026-02-20T22:09:17.5798054Z +                    "description": "En début de formation",
2026-02-20T22:09:17.5798126Z +                },
2026-02-20T22:09:17.5798194Z +                "9-11": {
2026-02-20T22:09:17.5798287Z +                    "name": "Apprentis Juniors",
2026-02-20T22:09:17.5798456Z +                    "description": "Formation intermédiaire",
2026-02-20T22:09:17.5798528Z +                },
2026-02-20T22:09:17.5798596Z +                "10-12": {
2026-02-20T22:09:17.5798735Z +                    "name": "Apprentis Confirmés",
2026-02-20T22:09:17.5798909Z +                    "description": "Prêts pour les épreuves",
2026-02-20T22:09:17.5798981Z +                },
2026-02-20T22:09:17.5799049Z +                "11-13": {
2026-02-20T22:09:17.5799158Z +                    "name": "Aspirants Chevaliers",
2026-02-20T22:09:17.5799339Z +                    "description": "Sur le chemin de la maîtrise",
2026-02-20T22:09:17.5799404Z +                },
2026-02-20T22:09:17.5799482Z +                "12-14": {
2026-02-20T22:09:17.5799586Z +                    "name": "Chevaliers en Devenir",
2026-02-20T22:09:17.5799726Z +                    "description": "Défis avancés",
2026-02-20T22:09:17.5799789Z +                },
2026-02-20T22:09:17.5799864Z +                "14-16": {
2026-02-20T22:09:17.5799999Z +                    "name": "Élite de l'Académie",
2026-02-20T22:09:17.5800174Z +                    "description": "Formation d'excellence",
2026-02-20T22:09:17.5800244Z +                },
2026-02-20T22:09:17.5800309Z +                "15-17": {
2026-02-20T22:09:17.5800442Z +                    "name": "Candidats Maîtres",
2026-02-20T22:09:17.5800599Z +                    "description": "Ultimes épreuves",
2026-02-20T22:09:17.5800670Z +                },
2026-02-20T22:09:17.5800739Z +                "17+": {
2026-02-20T22:09:17.5800826Z +                    "name": "Conseil des Sages",
2026-02-20T22:09:17.5800984Z +                    "description": "Niveau Grand Maître",
2026-02-20T22:09:17.5801045Z +                },
2026-02-20T22:09:17.5801107Z              }
2026-02-20T22:09:17.5801169Z -            
2026-02-20T22:09:17.5801260Z -            by_age_query = db.query(
2026-02-20T22:09:17.5801342Z -                Exercise.age_group,
2026-02-20T22:09:17.5801447Z -                func.count(Exercise.id).label('count')
2026-02-20T22:09:17.5801613Z -            ).filter(
2026-02-20T22:09:17.5801705Z -                Exercise.is_active == True
2026-02-20T22:09:17.5801802Z -            ).group_by(Exercise.age_group).all()
2026-02-20T22:09:17.5801872Z -            
2026-02-20T22:09:17.5801932Z +
2026-02-20T22:09:17.5802010Z +            by_age_query = (
2026-02-20T22:09:17.5802272Z +                db.query(Exercise.age_group, func.count(Exercise.id).label("count"))
2026-02-20T22:09:17.5802378Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5802469Z +                .group_by(Exercise.age_group)
2026-02-20T22:09:17.5802536Z +                .all()
2026-02-20T22:09:17.5802603Z +            )
2026-02-20T22:09:17.5802663Z +
2026-02-20T22:09:17.5802748Z              by_apprentice_group = {}
2026-02-20T22:09:17.5802844Z              for age_group, count in by_age_query:
2026-02-20T22:09:17.5803109Z                  group_key = str(age_group) if age_group else "10-12"
2026-02-20T22:09:17.5803539Z -                group_info = apprentice_groups.get(group_key, {"name": f"Groupe {group_key}", "description": "Formation spéciale"})
2026-02-20T22:09:17.5803649Z +                group_info = apprentice_groups.get(
2026-02-20T22:09:17.5803729Z +                    group_key,
2026-02-20T22:09:17.5803796Z +                    {
2026-02-20T22:09:17.5803900Z +                        "name": f"Groupe {group_key}",
2026-02-20T22:09:17.5804062Z +                        "description": "Formation spéciale",
2026-02-20T22:09:17.5804131Z +                    },
2026-02-20T22:09:17.5804194Z +                )
2026-02-20T22:09:17.5804291Z                  by_apprentice_group[group_key] = {
2026-02-20T22:09:17.5804377Z                      "count": count,
2026-02-20T22:09:17.5804474Z                      "group_name": group_info["name"],
2026-02-20T22:09:17.5804587Z                      "description": group_info["description"],
2026-02-20T22:09:17.5804828Z -                    "percentage": round((count / total_exercises * 100), 1) if total_exercises > 0 else 0
2026-02-20T22:09:17.5804911Z +                    "percentage": (
2026-02-20T22:09:17.5805023Z +                        round((count / total_exercises * 100), 1)
2026-02-20T22:09:17.5805119Z +                        if total_exercises > 0
2026-02-20T22:09:17.5805189Z +                        else 0
2026-02-20T22:09:17.5805262Z +                    ),
2026-02-20T22:09:17.5805324Z                  }
2026-02-20T22:09:17.5805392Z -            
2026-02-20T22:09:17.5805452Z +
2026-02-20T22:09:17.5805675Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5805833Z              # 5. STATISTIQUES DE COMPLÉTION GLOBALES
2026-02-20T22:09:17.5806045Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5806108Z -            
2026-02-20T22:09:17.5806176Z +
2026-02-20T22:09:17.5806289Z              # Total des tentatives sur tous les exercices
2026-02-20T22:09:17.5806455Z              total_attempts = db.query(func.count(Attempt.id)).scalar() or 0
2026-02-20T22:09:17.5806741Z -            correct_attempts = db.query(func.count(Attempt.id)).filter(
2026-02-20T22:09:17.5806839Z -                Attempt.is_correct == True
2026-02-20T22:09:17.5806917Z -            ).scalar() or 0
2026-02-20T22:09:17.5806978Z -            
2026-02-20T22:09:17.5807376Z -            global_success_rate = round((correct_attempts / total_attempts * 100), 1) if total_attempts > 0 else 0
2026-02-20T22:09:17.5807442Z -            
2026-02-20T22:09:17.5807524Z +            correct_attempts = (
2026-02-20T22:09:17.5807631Z +                db.query(func.count(Attempt.id))
2026-02-20T22:09:17.5807730Z +                .filter(Attempt.is_correct == True)
2026-02-20T22:09:17.5807800Z +                .scalar()
2026-02-20T22:09:17.5807868Z +                or 0
2026-02-20T22:09:17.5807938Z +            )
2026-02-20T22:09:17.5807997Z +
2026-02-20T22:09:17.5808075Z +            global_success_rate = (
2026-02-20T22:09:17.5808217Z +                round((correct_attempts / total_attempts * 100), 1)
2026-02-20T22:09:17.5808304Z +                if total_attempts > 0
2026-02-20T22:09:17.5808371Z +                else 0
2026-02-20T22:09:17.5808431Z +            )
2026-02-20T22:09:17.5808500Z +
2026-02-20T22:09:17.5808634Z              # Exercices les plus populaires (plus de tentatives)
2026-02-20T22:09:17.5808724Z -            popular_query = db.query(
2026-02-20T22:09:17.5808807Z -                Exercise.id,
2026-02-20T22:09:17.5808884Z -                Exercise.title,
2026-02-20T22:09:17.5808972Z -                Exercise.exercise_type,
2026-02-20T22:09:17.5809056Z -                Exercise.difficulty,
2026-02-20T22:09:17.5809189Z -                func.count(Attempt.id).label('attempt_count')
2026-02-20T22:09:17.5809343Z -            ).join(Attempt, Attempt.exercise_id == Exercise.id).filter(
2026-02-20T22:09:17.5809432Z -                Exercise.is_active == True
2026-02-20T22:09:17.5809512Z -            ).group_by(
2026-02-20T22:09:17.5809717Z -                Exercise.id, Exercise.title, Exercise.exercise_type, Exercise.difficulty
2026-02-20T22:09:17.5809863Z -            ).order_by(func.count(Attempt.id).desc()).limit(5).all()
2026-02-20T22:09:17.5809935Z -            
2026-02-20T22:09:17.5810016Z +            popular_query = (
2026-02-20T22:09:17.5810088Z +                db.query(
2026-02-20T22:09:17.5810167Z +                    Exercise.id,
2026-02-20T22:09:17.5810250Z +                    Exercise.title,
2026-02-20T22:09:17.5810343Z +                    Exercise.exercise_type,
2026-02-20T22:09:17.5810427Z +                    Exercise.difficulty,
2026-02-20T22:09:17.5810561Z +                    func.count(Attempt.id).label("attempt_count"),
2026-02-20T22:09:17.5810627Z +                )
2026-02-20T22:09:17.5810756Z +                .join(Attempt, Attempt.exercise_id == Exercise.id)
2026-02-20T22:09:17.5810865Z +                .filter(Exercise.is_active == True)
2026-02-20T22:09:17.5810936Z +                .group_by(
2026-02-20T22:09:17.5811010Z +                    Exercise.id,
2026-02-20T22:09:17.5811090Z +                    Exercise.title,
2026-02-20T22:09:17.5811186Z +                    Exercise.exercise_type,
2026-02-20T22:09:17.5811268Z +                    Exercise.difficulty,
2026-02-20T22:09:17.5811337Z +                )
2026-02-20T22:09:17.5811455Z +                .order_by(func.count(Attempt.id).desc())
2026-02-20T22:09:17.5811525Z +                .limit(5)
2026-02-20T22:09:17.5811591Z +                .all()
2026-02-20T22:09:17.5811657Z +            )
2026-02-20T22:09:17.5811724Z +
2026-02-20T22:09:17.5811804Z              popular_challenges = []
2026-02-20T22:09:17.5811963Z              for ex_id, title, ex_type, diff, attempt_count in popular_query:
2026-02-20T22:09:17.5812121Z                  type_upper = str(ex_type).upper() if ex_type else "DIVERS"
2026-02-20T22:09:17.5812219Z -                popular_challenges.append({
2026-02-20T22:09:17.5812290Z -                    "id": ex_id,
2026-02-20T22:09:17.5812371Z -                    "title": title,
2026-02-20T22:09:17.5812623Z -                    "discipline": discipline_names.get(type_upper, type_upper),
2026-02-20T22:09:17.5812804Z -                    "rank": academy_ranks.get(str(diff).upper(), {}).get("name", diff),
2026-02-20T22:09:17.5812916Z -                    "apprentices_trained": attempt_count
2026-02-20T22:09:17.5813356Z -                })
2026-02-20T22:09:17.5813441Z -            
2026-02-20T22:09:17.5813546Z +                popular_challenges.append(
2026-02-20T22:09:17.5813622Z +                    {
2026-02-20T22:09:17.5813699Z +                        "id": ex_id,
2026-02-20T22:09:17.5813777Z +                        "title": title,
2026-02-20T22:09:17.5813953Z +                        "discipline": discipline_names.get(type_upper, type_upper),
2026-02-20T22:09:17.5814100Z +                        "rank": academy_ranks.get(str(diff).upper(), {}).get(
2026-02-20T22:09:17.5814178Z +                            "name", diff
2026-02-20T22:09:17.5814247Z +                        ),
2026-02-20T22:09:17.5814376Z +                        "apprentices_trained": attempt_count,
2026-02-20T22:09:17.5814442Z +                    }
2026-02-20T22:09:17.5814504Z +                )
2026-02-20T22:09:17.5814571Z +
2026-02-20T22:09:17.5814819Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5814999Z              # 6. STATISTIQUES DES DÉFIS LOGIQUES (Challenges)
2026-02-20T22:09:17.5815214Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5815280Z -            
2026-02-20T22:09:17.5815485Z -            total_logic_challenges = db.query(func.count(LogicChallenge.id)).filter(
2026-02-20T22:09:17.5815593Z -                LogicChallenge.is_archived == False
2026-02-20T22:09:17.5815669Z -            ).scalar() or 0
2026-02-20T22:09:17.5815736Z -            
2026-02-20T22:09:17.5815796Z +
2026-02-20T22:09:17.5815881Z +            total_logic_challenges = (
2026-02-20T22:09:17.5815996Z +                db.query(func.count(LogicChallenge.id))
2026-02-20T22:09:17.5816133Z +                .filter(LogicChallenge.is_archived == False)
2026-02-20T22:09:17.5816203Z +                .scalar()
2026-02-20T22:09:17.5816270Z +                or 0
2026-02-20T22:09:17.5816338Z +            )
2026-02-20T22:09:17.5816398Z +
2026-02-20T22:09:17.5816596Z              # Tous les challenges sont actuellement générés par IA
2026-02-20T22:09:17.5816714Z              ai_generated_challenges = total_logic_challenges
2026-02-20T22:09:17.5816783Z -            
2026-02-20T22:09:17.5816843Z +
2026-02-20T22:09:17.5816981Z              # Tentatives sur les défis logiques
2026-02-20T22:09:17.5817235Z -            total_challenge_attempts = db.query(func.count(LogicChallengeAttempt.id)).scalar() or 0
2026-02-20T22:09:17.5817467Z -            correct_challenge_attempts = db.query(func.count(LogicChallengeAttempt.id)).filter(
2026-02-20T22:09:17.5817581Z -                LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:17.5817665Z -            ).scalar() or 0
2026-02-20T22:09:17.5817728Z -            
2026-02-20T22:09:17.5818128Z -            challenge_success_rate = round((correct_challenge_attempts / total_challenge_attempts * 100), 1) if total_challenge_attempts > 0 else 0
2026-02-20T22:09:17.5818189Z -            
2026-02-20T22:09:17.5818290Z +            total_challenge_attempts = (
2026-02-20T22:09:17.5818452Z +                db.query(func.count(LogicChallengeAttempt.id)).scalar() or 0
2026-02-20T22:09:17.5818515Z +            )
2026-02-20T22:09:17.5818608Z +            correct_challenge_attempts = (
2026-02-20T22:09:17.5818740Z +                db.query(func.count(LogicChallengeAttempt.id))
2026-02-20T22:09:17.5818875Z +                .filter(LogicChallengeAttempt.is_correct == True)
2026-02-20T22:09:17.5818950Z +                .scalar()
2026-02-20T22:09:17.5819017Z +                or 0
2026-02-20T22:09:17.5819079Z +            )
2026-02-20T22:09:17.5819139Z +
2026-02-20T22:09:17.5819228Z +            challenge_success_rate = (
2026-02-20T22:09:17.5819540Z +                round((correct_challenge_attempts / total_challenge_attempts * 100), 1)
2026-02-20T22:09:17.5819637Z +                if total_challenge_attempts > 0
2026-02-20T22:09:17.5819713Z +                else 0
2026-02-20T22:09:17.5819774Z +            )
2026-02-20T22:09:17.5819904Z +
2026-02-20T22:09:17.5820130Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5820347Z              # 7. CONSTRUCTION DE LA RÉPONSE - Chroniques de l'Académie
2026-02-20T22:09:17.5820559Z              # ════════════════════════════════════════════════════════════════
2026-02-20T22:09:17.5820620Z -            
2026-02-20T22:09:17.5820686Z +
2026-02-20T22:09:17.5820822Z              # Totaux combinés pour les stats AI
2026-02-20T22:09:17.5820986Z              total_ai_generated = ai_generated_count + ai_generated_challenges
2026-02-20T22:09:17.5821138Z              total_content = total_exercises + total_logic_challenges
2026-02-20T22:09:17.5821213Z -            
2026-02-20T22:09:17.5821272Z +
2026-02-20T22:09:17.5821349Z              response_data = {
2026-02-20T22:09:17.5821475Z                  "archive_status": "Chroniques accessibles",
2026-02-20T22:09:17.5821558Z                  "academy_statistics": {
2026-02-20T22:09:17.5821672Z                      "total_exercises": total_exercises,
2026-02-20T22:09:17.5821792Z                      "total_challenges": total_logic_challenges,
2026-02-20T22:09:17.5821888Z                      "total_content": total_content,
2026-02-20T22:09:17.5821992Z                      "archived_exercises": total_archived,
2026-02-20T22:09:17.5822093Z                      "ai_generated": total_ai_generated,
2026-02-20T22:09:17.5822210Z                      "ai_generated_exercises": ai_generated_count,
2026-02-20T22:09:17.5822340Z                      "ai_generated_challenges": ai_generated_challenges,
2026-02-20T22:09:17.5822647Z -                    "ai_generated_percentage": round((total_ai_generated / total_content * 100), 1) if total_content > 0 else 0
2026-02-20T22:09:17.5822751Z +                    "ai_generated_percentage": (
2026-02-20T22:09:17.5822889Z +                        round((total_ai_generated / total_content * 100), 1)
2026-02-20T22:09:17.5823094Z +                        if total_content > 0
2026-02-20T22:09:17.5823185Z +                        else 0
2026-02-20T22:09:17.5823252Z +                    ),
2026-02-20T22:09:17.5823313Z                  },
2026-02-20T22:09:17.5823410Z                  "by_discipline": by_discipline,
2026-02-20T22:09:17.5823491Z                  "by_rank": by_rank,
2026-02-20T22:09:17.5823606Z                  "by_apprentice_group": by_apprentice_group,
2026-02-20T22:09:17.5823688Z                  "global_performance": {
2026-02-20T22:09:17.5823852Z                      "total_attempts": total_attempts + total_challenge_attempts,
2026-02-20T22:09:17.5823956Z                      "exercise_attempts": total_attempts,
2026-02-20T22:09:17.5824081Z                      "challenge_attempts": total_challenge_attempts,
2026-02-20T22:09:17.5824285Z -                    "successful_attempts": correct_attempts + correct_challenge_attempts,
2026-02-20T22:09:17.5824390Z +                    "successful_attempts": correct_attempts
2026-02-20T22:09:17.5824487Z +                    + correct_challenge_attempts,
2026-02-20T22:09:17.5824595Z                      "mastery_rate": global_success_rate,
2026-02-20T22:09:17.5824722Z                      "challenge_mastery_rate": challenge_success_rate,
2026-02-20T22:09:17.5824852Z -                    "message": _get_mastery_message(global_success_rate)
2026-02-20T22:09:17.5824986Z +                    "message": _get_mastery_message(global_success_rate),
2026-02-20T22:09:17.5825052Z                  },
2026-02-20T22:09:17.5825161Z                  "legendary_challenges": popular_challenges,
2026-02-20T22:09:17.5825253Z -                "sage_wisdom": _get_sage_wisdom()
2026-02-20T22:09:17.5825352Z +                "sage_wisdom": _get_sage_wisdom(),
2026-02-20T22:09:17.5825535Z              }
2026-02-20T22:09:17.5825600Z -            
2026-02-20T22:09:17.5825947Z -            logger.info(f"Statistiques des épreuves récupérées: {total_exercises} épreuves actives")
2026-02-20T22:09:17.5826009Z +
2026-02-20T22:09:17.5826085Z +            logger.info(
2026-02-20T22:09:17.5826467Z +                f"Statistiques des épreuves récupérées: {total_exercises} épreuves actives"
2026-02-20T22:09:17.5826533Z +            )
2026-02-20T22:09:17.5826634Z              return JSONResponse(response_data)
2026-02-20T22:09:17.5826695Z -            
2026-02-20T22:09:17.5826760Z +
2026-02-20T22:09:17.5826838Z      except Exception as e:
2026-02-20T22:09:17.5827115Z -        logger.error(f"Erreur lors de la récupération des statistiques d'exercices: {e}")
2026-02-20T22:09:17.5827193Z +        logger.error(
2026-02-20T22:09:17.5827422Z +            f"Erreur lors de la récupération des statistiques d'exercices: {e}"
2026-02-20T22:09:17.5827484Z +        )
2026-02-20T22:09:17.5827575Z          traceback.print_exc()
2026-02-20T22:09:17.5827660Z -        return JSONResponse({
2026-02-20T22:09:17.5827777Z -            "archive_status": "Chroniques inaccessibles",
2026-02-20T22:09:17.5828053Z -            "error": "Une perturbation empêche l'accès aux archives. Réessayez plus tard.",
2026-02-20T22:09:17.5828216Z -            "details": str(e) if settings.LOG_LEVEL == "DEBUG" else None
2026-02-20T22:09:17.5828292Z -        }, status_code=500)
2026-02-20T22:09:17.5828371Z +        return JSONResponse(
2026-02-20T22:09:17.5828442Z +            {
2026-02-20T22:09:17.5828561Z +                "archive_status": "Chroniques inaccessibles",
2026-02-20T22:09:17.5828848Z +                "error": "Une perturbation empêche l'accès aux archives. Réessayez plus tard.",
2026-02-20T22:09:17.5828994Z +                "details": str(e) if settings.LOG_LEVEL == "DEBUG" else None,
2026-02-20T22:09:17.5829063Z +            },
2026-02-20T22:09:17.5829135Z +            status_code=500,
2026-02-20T22:09:17.5829204Z +        )
2026-02-20T22:09:17.5829271Z  
2026-02-20T22:09:17.5829331Z  
2026-02-20T22:09:17.5829452Z  def _get_mastery_message(success_rate: float) -> str:
2026-02-20T22:09:17.5829693Z      """Retourne un message thématique basé sur le taux de réussite global."""
2026-02-20T22:09:17.5829779Z      if success_rate >= 90:
2026-02-20T22:09:17.5829851Z @@ -1170,24 +1530,27 @@
2026-02-20T22:09:17.5829927Z      elif success_rate >= 75:
2026-02-20T22:09:17.5830106Z          return "Belle progression des apprentis. Le Conseil est satisfait."
2026-02-20T22:09:17.5830181Z      elif success_rate >= 60:
2026-02-20T22:09:17.5830368Z          return "Les apprentis progressent. La patience est une vertu des sages."
2026-02-20T22:09:17.5830448Z      elif success_rate >= 40:
2026-02-20T22:09:17.5830721Z -        return "L'entraînement doit s'intensifier. La voie de la maîtrise est exigeante."
2026-02-20T22:09:17.5830785Z +        return (
2026-02-20T22:09:17.5831039Z +            "L'entraînement doit s'intensifier. La voie de la maîtrise est exigeante."
2026-02-20T22:09:17.5831107Z +        )
2026-02-20T22:09:17.5831169Z      else:
2026-02-20T22:09:17.5831436Z          return "Beaucoup reste à apprendre. Persévérance et courage sont essentiels."
2026-02-20T22:09:17.5831509Z  
2026-02-20T22:09:17.5831569Z  
2026-02-20T22:09:17.5831663Z  def _get_sage_wisdom() -> str:
2026-02-20T22:09:17.5831824Z      """Retourne une citation de sagesse aléatoire."""
2026-02-20T22:09:17.5831895Z      import random
2026-02-20T22:09:17.5831954Z +
2026-02-20T22:09:17.5832020Z      wisdoms = [
2026-02-20T22:09:17.5832256Z          "La connaissance est le premier pas vers la sagesse. — Les Anciens",
2026-02-20T22:09:17.5832571Z          "Fais-le, ou ne le fais pas. L'hésitation est l'ennemi du progrès. — Proverbe des Maîtres",
2026-02-20T22:09:17.5832795Z          "L'erreur est le chemin de l'apprentissage. — Sagesse ancestrale",
2026-02-20T22:09:17.5833253Z          "Celui qui pose des questions ne s'égare jamais. — Dicton des Sages",
2026-02-20T22:09:17.5833648Z          "L'apprentissage est une voie sans fin. — Chroniques de l'Académie",
2026-02-20T22:09:17.5833879Z          "La patience transforme l'apprenti en maître. — Conseil des Sages",
2026-02-20T22:09:17.5834302Z          "Chaque problème résolu ouvre la porte à de nouveaux défis. — Tradition mathématique",
2026-02-20T22:09:17.5834577Z -        "La persévérance est l'arme secrète du mathématicien. — Archives de l'Académie"
2026-02-20T22:09:17.5834844Z +        "La persévérance est l'arme secrète du mathématicien. — Archives de l'Académie",
2026-02-20T22:09:17.5834913Z      ]
2026-02-20T22:09:17.5835000Z      return random.choice(wisdoms)
2026-02-20T22:09:17.8443860Z --- /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py	2026-02-20 22:09:02.838965+00:00
2026-02-20T22:09:17.8446109Z +++ /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py	2026-02-20 22:09:17.833240+00:00
2026-02-20T22:09:17.8447214Z @@ -1,8 +1,9 @@
2026-02-20T22:09:17.8447538Z  """
2026-02-20T22:09:17.8447950Z  Handlers pour la gestion des utilisateurs et statistiques (API)
2026-02-20T22:09:17.8448424Z  """
2026-02-20T22:09:17.8448661Z +
2026-02-20T22:09:17.8448907Z  import json
2026-02-20T22:09:17.8449191Z  import re
2026-02-20T22:09:17.8449476Z  import traceback
2026-02-20T22:09:17.8449883Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:17.8450410Z  
2026-02-20T22:09:17.8450734Z @@ -33,54 +34,67 @@
2026-02-20T22:09:17.8451448Z      Paramètres de requête:
2026-02-20T22:09:17.8452025Z          - timeRange: "7" (7 jours), "30" (30 jours), "90" (3 mois), "all" (tout)
2026-02-20T22:09:17.8452666Z      """
2026-02-20T22:09:17.8453133Z      try:
2026-02-20T22:09:17.8453492Z          current_user = request.state.user
2026-02-20T22:09:17.8454002Z -        
2026-02-20T22:09:17.8454319Z +
2026-02-20T22:09:17.8454654Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8455234Z          username = current_user.get("username")
2026-02-20T22:09:17.8455763Z -        
2026-02-20T22:09:17.8456063Z +
2026-02-20T22:09:17.8456346Z          if not user_id:
2026-02-20T22:09:17.8456835Z              logger.warning(f"ID utilisateur manquant pour {username}")
2026-02-20T22:09:17.8457440Z              return JSONResponse({"error": "ID utilisateur manquant"}, status_code=400)
2026-02-20T22:09:17.8457818Z -        
2026-02-20T22:09:17.8457977Z +
2026-02-20T22:09:17.8458338Z          # Récupérer le paramètre timeRange depuis la requête
2026-02-20T22:09:17.8458692Z          from starlette.requests import Request
2026-02-20T22:09:17.8458950Z +
2026-02-20T22:09:17.8459133Z          query_params = dict(request.query_params)
2026-02-20T22:09:17.8459583Z          time_range = query_params.get("timeRange", "30")  # Par défaut 30 jours
2026-02-20T22:09:17.8459931Z -        
2026-02-20T22:09:17.8460224Z +
2026-02-20T22:09:17.8460488Z          # Valider timeRange
2026-02-20T22:09:17.8460870Z          valid_ranges = ["7", "30", "90", "all"]
2026-02-20T22:09:17.8461238Z          if time_range not in valid_ranges:
2026-02-20T22:09:17.8461791Z -            logger.debug(f"TimeRange invalide '{time_range}', utilisation de la valeur par défaut '30'")
2026-02-20T22:09:17.8462229Z +            logger.debug(
2026-02-20T22:09:17.8462644Z +                f"TimeRange invalide '{time_range}', utilisation de la valeur par défaut '30'"
2026-02-20T22:09:17.8463275Z +            )
2026-02-20T22:09:17.8463491Z              time_range = "30"  # Fallback sur 30 jours
2026-02-20T22:09:17.8463742Z -        
2026-02-20T22:09:17.8464520Z -        logger.debug(f"Récupération des statistiques pour l'utilisateur {username} (ID: {user_id}), période: {time_range}")
2026-02-20T22:09:17.8465421Z -        
2026-02-20T22:09:17.8465697Z +
2026-02-20T22:09:17.8465973Z +        logger.debug(
2026-02-20T22:09:17.8466878Z +            f"Récupération des statistiques pour l'utilisateur {username} (ID: {user_id}), période: {time_range}"
2026-02-20T22:09:17.8467341Z +        )
2026-02-20T22:09:17.8467493Z +
2026-02-20T22:09:17.8467659Z          async with db_session() as db:
2026-02-20T22:09:17.8468660Z -            stats = EnhancedServerAdapter.get_user_stats(db, user_id, time_range=time_range)
2026-02-20T22:09:17.8469496Z +            stats = EnhancedServerAdapter.get_user_stats(
2026-02-20T22:09:17.8470037Z +                db, user_id, time_range=time_range
2026-02-20T22:09:17.8470633Z +            )
2026-02-20T22:09:17.8470932Z              if not stats:
2026-02-20T22:09:17.8471896Z -                logger.debug(f"Aucune statistique trouvée pour l'utilisateur {username}, utilisation de valeurs par défaut")
2026-02-20T22:09:17.8472409Z +                logger.debug(
2026-02-20T22:09:17.8472921Z +                    f"Aucune statistique trouvée pour l'utilisateur {username}, utilisation de valeurs par défaut"
2026-02-20T22:09:17.8473741Z +                )
2026-02-20T22:09:17.8473929Z                  stats = {
2026-02-20T22:09:17.8474147Z                      "total_attempts": 0,
2026-02-20T22:09:17.8474394Z                      "correct_attempts": 0,
2026-02-20T22:09:17.8474657Z                      "success_rate": 0,
2026-02-20T22:09:17.8474893Z -                    "by_exercise_type": {}
2026-02-20T22:09:17.8475143Z +                    "by_exercise_type": {},
2026-02-20T22:09:17.8475366Z                  }
2026-02-20T22:09:17.8475530Z -            
2026-02-20T22:09:17.8476080Z would reformat /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py
2026-02-20T22:09:17.8476809Z -            logger.debug(f"Statistiques récupérées pour {username}: {stats.get('total_attempts', 0)} tentatives")
2026-02-20T22:09:17.8477276Z -            
2026-02-20T22:09:17.8477432Z +
2026-02-20T22:09:17.8477592Z +            logger.debug(
2026-02-20T22:09:17.8478042Z +                f"Statistiques récupérées pour {username}: {stats.get('total_attempts', 0)} tentatives"
2026-02-20T22:09:17.8478732Z +            )
2026-02-20T22:09:17.8479019Z +
2026-02-20T22:09:17.8479417Z              experience_points = stats.get("total_attempts", 0) * 10
2026-02-20T22:09:17.8479991Z              performance_by_type = {}
2026-02-20T22:09:17.8481077Z              # Les types sont déjà normalisés en minuscules dans user_service.py
2026-02-20T22:09:17.8481623Z              for exercise_type, type_stats in stats.get("by_exercise_type", {}).items():
2026-02-20T22:09:17.8482207Z                  # S'assurer que la clé est en minuscules (déjà normalisée mais sécurité)
2026-02-20T22:09:17.8482666Z -                type_key = str(exercise_type).lower() if exercise_type else 'unknown'
2026-02-20T22:09:17.8483333Z +                type_key = str(exercise_type).lower() if exercise_type else "unknown"
2026-02-20T22:09:17.8483706Z                  performance_by_type[type_key] = {
2026-02-20T22:09:17.8484011Z                      "completed": type_stats.get("total", 0),
2026-02-20T22:09:17.8484309Z                      "correct": type_stats.get("correct", 0),
2026-02-20T22:09:17.8484720Z -                    "success_rate": (type_stats.get("correct", 0) / type_stats.get("total", 1) * 100)
2026-02-20T22:09:17.8485153Z +                    "success_rate": (
2026-02-20T22:09:17.8485475Z +                        type_stats.get("correct", 0) / type_stats.get("total", 1) * 100
2026-02-20T22:09:17.8485800Z +                    ),
2026-02-20T22:09:17.8485979Z                  }
2026-02-20T22:09:17.8486300Z              # Récupérer l'activité récente (dernières 10 tentatives)
2026-02-20T22:09:17.8486684Z              # Filtrer selon time_range si différent de "all"
2026-02-20T22:09:17.8486967Z              recent_activity = []
2026-02-20T22:09:17.8487170Z              try:
2026-02-20T22:09:17.8487337Z @@ -93,81 +107,130 @@
2026-02-20T22:09:17.8487527Z                  if time_range != "all":
2026-02-20T22:09:17.8487769Z                      days = int(time_range)
2026-02-20T22:09:17.8488097Z                      cutoff_date = datetime.now(timezone.utc) - timedelta(days=days)
2026-02-20T22:09:17.8488430Z                  else:
2026-02-20T22:09:17.8488622Z                      cutoff_date = None
2026-02-20T22:09:17.8489039Z -                
2026-02-20T22:09:17.8489212Z +
2026-02-20T22:09:17.8489471Z                  # Récupérer les tentatives d'exercices récentes
2026-02-20T22:09:17.8489858Z                  # IMPORTANT: Appliquer tous les filter() AVANT limit() et order_by()
2026-02-20T22:09:17.8490396Z                  exercise_attempts_query = db.query(Attempt).filter(
2026-02-20T22:09:17.8490718Z                      Attempt.user_id == user_id
2026-02-20T22:09:17.8490949Z                  )
2026-02-20T22:09:17.8491114Z -                
2026-02-20T22:09:17.8491277Z +
2026-02-20T22:09:17.8491426Z                  if cutoff_date:
2026-02-20T22:09:17.8491837Z -                    exercise_attempts_query = exercise_attempts_query.filter(Attempt.created_at >= cutoff_date)
2026-02-20T22:09:17.8492263Z -                
2026-02-20T22:09:17.8492640Z -                exercise_attempts = exercise_attempts_query.order_by(Attempt.created_at.desc()).limit(5).all()
2026-02-20T22:09:17.8493291Z -                
2026-02-20T22:09:17.8493570Z +                    exercise_attempts_query = exercise_attempts_query.filter(
2026-02-20T22:09:17.8493934Z +                        Attempt.created_at >= cutoff_date
2026-02-20T22:09:17.8494189Z +                    )
2026-02-20T22:09:17.8494365Z +
2026-02-20T22:09:17.8494529Z +                exercise_attempts = (
2026-02-20T22:09:17.8494850Z +                    exercise_attempts_query.order_by(Attempt.created_at.desc())
2026-02-20T22:09:17.8495172Z +                    .limit(5)
2026-02-20T22:09:17.8495374Z +                    .all()
2026-02-20T22:09:17.8495556Z +                )
2026-02-20T22:09:17.8495727Z +
2026-02-20T22:09:17.8495895Z                  for attempt in exercise_attempts:
2026-02-20T22:09:17.8496175Z -                    recent_activity.append({
2026-02-20T22:09:17.8496435Z -                        "type": "exercise",
2026-02-20T22:09:17.8496768Z -                        "description": f"Exercice complété",
2026-02-20T22:09:17.8497290Z -                        "time": attempt.created_at.isoformat() if attempt.created_at else datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8497804Z -                        "is_correct": attempt.is_correct
2026-02-20T22:09:17.8498060Z -                    })
2026-02-20T22:09:17.8498231Z -                
2026-02-20T22:09:17.8498427Z +                    recent_activity.append(
2026-02-20T22:09:17.8498661Z +                        {
2026-02-20T22:09:17.8498862Z +                            "type": "exercise",
2026-02-20T22:09:17.8499197Z +                            "description": f"Exercice complété",
2026-02-20T22:09:17.8499465Z +                            "time": (
2026-02-20T22:09:17.8499724Z +                                attempt.created_at.isoformat()
2026-02-20T22:09:17.8500017Z +                                if attempt.created_at
2026-02-20T22:09:17.8500317Z +                                else datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8500601Z +                            ),
2026-02-20T22:09:17.8500852Z +                            "is_correct": attempt.is_correct,
2026-02-20T22:09:17.8501110Z +                        }
2026-02-20T22:09:17.8501287Z +                    )
2026-02-20T22:09:17.8501452Z +
2026-02-20T22:09:17.8501706Z                  # Récupérer les tentatives de challenges récentes
2026-02-20T22:09:17.8502104Z                  # IMPORTANT: Appliquer tous les filter() AVANT limit() et order_by()
2026-02-20T22:09:17.8502557Z                  challenge_attempts_query = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8502950Z                      LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8503529Z                  )
2026-02-20T22:09:17.8503692Z -                
2026-02-20T22:09:17.8503855Z +
2026-02-20T22:09:17.8504003Z                  if cutoff_date:
2026-02-20T22:09:17.8504481Z -                    challenge_attempts_query = challenge_attempts_query.filter(LogicChallengeAttempt.created_at >= cutoff_date)
2026-02-20T22:09:17.8504968Z -                
2026-02-20T22:09:17.8505629Z -                challenge_attempts = challenge_attempts_query.order_by(LogicChallengeAttempt.created_at.desc()).limit(5).all()
2026-02-20T22:09:17.8506180Z -                
2026-02-20T22:09:17.8506666Z +                    challenge_attempts_query = challenge_attempts_query.filter(
2026-02-20T22:09:17.8507624Z +                        LogicChallengeAttempt.created_at >= cutoff_date
2026-02-20T22:09:17.8508184Z +                    )
2026-02-20T22:09:17.8508463Z +
2026-02-20T22:09:17.8508633Z +                challenge_attempts = (
2026-02-20T22:09:17.8508911Z +                    challenge_attempts_query.order_by(
2026-02-20T22:09:17.8509355Z +                        LogicChallengeAttempt.created_at.desc()
2026-02-20T22:09:17.8509815Z +                    )
2026-02-20T22:09:17.8510113Z +                    .limit(5)
2026-02-20T22:09:17.8510455Z +                    .all()
2026-02-20T22:09:17.8510782Z +                )
2026-02-20T22:09:17.8511058Z +
2026-02-20T22:09:17.8511385Z                  for attempt in challenge_attempts:
2026-02-20T22:09:17.8511853Z -                    recent_activity.append({
2026-02-20T22:09:17.8512303Z -                        "type": "challenge",
2026-02-20T22:09:17.8512898Z -                        "description": f"Défi logique complété",
2026-02-20T22:09:17.8513995Z -                        "time": attempt.created_at.isoformat() if attempt.created_at else datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8514836Z -                        "is_correct": attempt.is_correct
2026-02-20T22:09:17.8515253Z -                    })
2026-02-20T22:09:17.8515536Z -                
2026-02-20T22:09:17.8515834Z +                    recent_activity.append(
2026-02-20T22:09:17.8516225Z +                        {
2026-02-20T22:09:17.8516562Z +                            "type": "challenge",
2026-02-20T22:09:17.8517168Z +                            "description": f"Défi logique complété",
2026-02-20T22:09:17.8517642Z +                            "time": (
2026-02-20T22:09:17.8518089Z +                                attempt.created_at.isoformat()
2026-02-20T22:09:17.8518570Z +                                if attempt.created_at
2026-02-20T22:09:17.8519102Z +                                else datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8519610Z +                            ),
2026-02-20T22:09:17.8520008Z +                            "is_correct": attempt.is_correct,
2026-02-20T22:09:17.8520455Z +                        }
2026-02-20T22:09:17.8520759Z +                    )
2026-02-20T22:09:17.8521050Z +
2026-02-20T22:09:17.8521571Z                  # Trier par date décroissante et prendre les 10 plus récentes
2026-02-20T22:09:17.8522330Z                  recent_activity.sort(key=lambda x: x.get("time", ""), reverse=True)
2026-02-20T22:09:17.8523144Z                  recent_activity = recent_activity[:10]
2026-02-20T22:09:17.8523577Z -                
2026-02-20T22:09:17.8523852Z +
2026-02-20T22:09:17.8524143Z              except Exception as activity_error:
2026-02-20T22:09:17.8525031Z -                logger.error(f"Erreur lors de la récupération de l'activité récente: {activity_error}")
2026-02-20T22:09:17.8525750Z +                logger.error(
2026-02-20T22:09:17.8526450Z +                    f"Erreur lors de la récupération de l'activité récente: {activity_error}"
2026-02-20T22:09:17.8527060Z +                )
2026-02-20T22:09:17.8527373Z                  recent_activity = []
2026-02-20T22:09:17.8527751Z -            
2026-02-20T22:09:17.8528006Z +
2026-02-20T22:09:17.8528273Z              # Calculer le niveau et XP
2026-02-20T22:09:17.8528717Z              def calculate_user_level(xp: int) -> dict:
2026-02-20T22:09:17.8529138Z                  """
2026-02-20T22:09:17.8529697Z                  Calcule le niveau utilisateur basé sur les points d'expérience.
2026-02-20T22:09:17.8530228Z -                
2026-02-20T22:09:17.8530474Z +
2026-02-20T22:09:17.8530703Z                  Args:
2026-02-20T22:09:17.8531115Z                      xp: Points d'expérience totaux
2026-02-20T22:09:17.8531736Z -                
2026-02-20T22:09:17.8532003Z +
2026-02-20T22:09:17.8532231Z                  Returns:
2026-02-20T22:09:17.8532698Z                      Dictionnaire avec current, title, current_xp, next_level_xp
2026-02-20T22:09:17.8533390Z                  """
2026-02-20T22:09:17.8533908Z                  # Seuils de niveau (100 points par niveau)
2026-02-20T22:09:17.8534562Z -                level_thresholds = [0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 4500, 5500]
2026-02-20T22:09:17.8535159Z -                
2026-02-20T22:09:17.8535458Z +                level_thresholds = [
2026-02-20T22:09:17.8535824Z +                    0,
2026-02-20T22:09:17.8536122Z +                    100,
2026-02-20T22:09:17.8536427Z +                    300,
2026-02-20T22:09:17.8536733Z +                    600,
2026-02-20T22:09:17.8537029Z +                    1000,
2026-02-20T22:09:17.8537340Z +                    1500,
2026-02-20T22:09:17.8537640Z +                    2100,
2026-02-20T22:09:17.8537959Z +                    2800,
2026-02-20T22:09:17.8538253Z +                    3600,
2026-02-20T22:09:17.8538556Z +                    4500,
2026-02-20T22:09:17.8538864Z +                    5500,
2026-02-20T22:09:17.8539160Z +                ]
2026-02-20T22:09:17.8539427Z +
2026-02-20T22:09:17.8539695Z                  # Trouver le niveau actuel
2026-02-20T22:09:17.8540108Z                  current_level = 1
2026-02-20T22:09:17.8540561Z                  for i, threshold in enumerate(level_thresholds):
2026-02-20T22:09:17.8541055Z                      if xp >= threshold:
2026-02-20T22:09:17.8541465Z                          current_level = i + 1
2026-02-20T22:09:17.8541857Z -                
2026-02-20T22:09:17.8542112Z +
2026-02-20T22:09:17.8542459Z                  # Calculer les XP pour le niveau actuel et suivant
2026-02-20T22:09:17.8543378Z -                current_xp = xp - level_thresholds[current_level - 1] if current_level > 1 else xp
2026-02-20T22:09:17.8544660Z -                next_level_xp = level_thresholds[current_level] - level_thresholds[current_level - 1] if current_level < len(level_thresholds) else 100
2026-02-20T22:09:17.8545649Z -                
2026-02-20T22:09:17.8545933Z +                current_xp = (
2026-02-20T22:09:17.8546359Z +                    xp - level_thresholds[current_level - 1]
2026-02-20T22:09:17.8546836Z +                    if current_level > 1
2026-02-20T22:09:17.8547227Z +                    else xp
2026-02-20T22:09:17.8547542Z +                )
2026-02-20T22:09:17.8547830Z +                next_level_xp = (
2026-02-20T22:09:17.8548243Z +                    level_thresholds[current_level]
2026-02-20T22:09:17.8548732Z +                    - level_thresholds[current_level - 1]
2026-02-20T22:09:17.8549246Z +                    if current_level < len(level_thresholds)
2026-02-20T22:09:17.8549686Z +                    else 100
2026-02-20T22:09:17.8550005Z +                )
2026-02-20T22:09:17.8550264Z +
2026-02-20T22:09:17.8550524Z                  # Titres de niveau
2026-02-20T22:09:17.8550918Z                  level_titles = {
2026-02-20T22:09:17.8551281Z                      1: "Jeune Padawan",
2026-02-20T22:09:17.8551673Z                      2: "Padawan",
2026-02-20T22:09:17.8552041Z                      3: "Chevalier Jedi",
2026-02-20T22:09:17.8552421Z @@ -176,121 +239,153 @@
2026-02-20T22:09:17.8552841Z                      6: "Maître du Conseil",
2026-02-20T22:09:17.8553464Z                      7: "Légende Jedi",
2026-02-20T22:09:17.8553833Z                      8: "Gardien de la Force",
2026-02-20T22:09:17.8554248Z                      9: "Seigneur Jedi",
2026-02-20T22:09:17.8554628Z                      10: "Archiviste Jedi",
2026-02-20T22:09:17.8554998Z -                    11: "Grand Archiviste"
2026-02-20T22:09:17.8555390Z +                    11: "Grand Archiviste",
2026-02-20T22:09:17.8555766Z                  }
2026-02-20T22:09:17.8556031Z -                
2026-02-20T22:09:17.8556289Z +
2026-02-20T22:09:17.8556706Z                  title = level_titles.get(current_level, f"Niveau {current_level}")
2026-02-20T22:09:17.8557468Z -                
2026-02-20T22:09:17.8557741Z +
2026-02-20T22:09:17.8557978Z                  return {
2026-02-20T22:09:17.8558328Z                      "current": current_level,
2026-02-20T22:09:17.8558918Z                      "title": title,
2026-02-20T22:09:17.8559314Z                      "current_xp": current_xp,
2026-02-20T22:09:17.8559761Z -                    "next_level_xp": next_level_xp
2026-02-20T22:09:17.8560215Z +                    "next_level_xp": next_level_xp,
2026-02-20T22:09:17.8560631Z                  }
2026-02-20T22:09:17.8560890Z -            
2026-02-20T22:09:17.8561151Z +
2026-02-20T22:09:17.8561497Z              level_data = calculate_user_level(experience_points)
2026-02-20T22:09:17.8561985Z -            
2026-02-20T22:09:17.8562245Z +
2026-02-20T22:09:17.8562541Z              # Calculer la progression dans le temps
2026-02-20T22:09:17.8563158Z              progress_over_time = []
2026-02-20T22:09:17.8563566Z              exercises_by_day = []
2026-02-20T22:09:17.8563926Z -            
2026-02-20T22:09:17.8564175Z +
2026-02-20T22:09:17.8564409Z              try:
2026-02-20T22:09:17.8564736Z                  from collections import defaultdict
2026-02-20T22:09:17.8565283Z                  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:17.8565767Z  
2026-02-20T22:09:17.8566183Z                  # Calculer la date de début selon time_range
2026-02-20T22:09:17.8566649Z                  if time_range == "all":
2026-02-20T22:09:17.8567441Z -                    start_date = datetime.now(timezone.utc) - timedelta(days=90)  # Par défaut 90 jours
2026-02-20T22:09:17.8568216Z +                    start_date = datetime.now(timezone.utc) - timedelta(
2026-02-20T22:09:17.8568711Z +                        days=90
2026-02-20T22:09:17.8569148Z +                    )  # Par défaut 90 jours
2026-02-20T22:09:17.8569521Z                  else:
2026-02-20T22:09:17.8570041Z -                    start_date = datetime.now(timezone.utc) - timedelta(days=int(time_range))
2026-02-20T22:09:17.8570659Z -                
2026-02-20T22:09:17.8571032Z +                    start_date = datetime.now(timezone.utc) - timedelta(
2026-02-20T22:09:17.8571550Z +                        days=int(time_range)
2026-02-20T22:09:17.8571931Z +                    )
2026-02-20T22:09:17.8572208Z +
2026-02-20T22:09:17.8572584Z                  # Récupérer les tentatives par jour
2026-02-20T22:09:17.8573294Z                  daily_stats = defaultdict(lambda: {"total": 0, "correct": 0})
2026-02-20T22:09:17.8573817Z -                
2026-02-20T22:09:17.8574163Z -                attempts_query = db.query(Attempt).filter(
2026-02-20T22:09:17.8574642Z -                    Attempt.user_id == user_id,
2026-02-20T22:09:17.8575100Z -                    Attempt.created_at >= start_date
2026-02-20T22:09:17.8575532Z -                ).all()
2026-02-20T22:09:17.8575831Z -                
2026-02-20T22:09:17.8576093Z +
2026-02-20T22:09:17.8576345Z +                attempts_query = (
2026-02-20T22:09:17.8576714Z +                    db.query(Attempt)
2026-02-20T22:09:17.8577076Z +                    .filter(
2026-02-20T22:09:17.8577572Z +                        Attempt.user_id == user_id, Attempt.created_at >= start_date
2026-02-20T22:09:17.8578137Z +                    )
2026-02-20T22:09:17.8578428Z +                    .all()
2026-02-20T22:09:17.8578736Z +                )
2026-02-20T22:09:17.8578994Z +
2026-02-20T22:09:17.8579269Z                  for attempt in attempts_query:
2026-02-20T22:09:17.8579691Z                      if attempt.created_at:
2026-02-20T22:09:17.8580181Z                          day_key = attempt.created_at.date().isoformat()
2026-02-20T22:09:17.8580706Z                          daily_stats[day_key]["total"] += 1
2026-02-20T22:09:17.8581164Z                          if attempt.is_correct:
2026-02-20T22:09:17.8581626Z                              daily_stats[day_key]["correct"] += 1
2026-02-20T22:09:17.8582059Z -                
2026-02-20T22:09:17.8582496Z +
2026-02-20T22:09:17.8582894Z                  # Créer les datasets pour les graphiques
2026-02-20T22:09:17.8583561Z                  sorted_days = sorted(daily_stats.keys())
2026-02-20T22:09:17.8584008Z                  progress_over_time = {
2026-02-20T22:09:17.8584634Z                      "labels": sorted_days,
2026-02-20T22:09:17.8585041Z -                    "datasets": [{
2026-02-20T22:09:17.8585553Z -                        "label": "Taux de réussite (%)",
2026-02-20T22:09:17.8585989Z -                        "data": [
2026-02-20T22:09:17.8586519Z -                            (daily_stats[day]["correct"] / daily_stats[day]["total"] * 100) 
2026-02-20T22:09:17.8587185Z -                            if daily_stats[day]["total"] > 0 else 0
2026-02-20T22:09:17.8587677Z -                            for day in sorted_days
2026-02-20T22:09:17.8588094Z -                        ]
2026-02-20T22:09:17.8588403Z -                    }]
2026-02-20T22:09:17.8588721Z +                    "datasets": [
2026-02-20T22:09:17.8589085Z +                        {
2026-02-20T22:09:17.8589560Z +                            "label": "Taux de réussite (%)",
2026-02-20T22:09:17.8590010Z +                            "data": [
2026-02-20T22:09:17.8590376Z +                                (
2026-02-20T22:09:17.8590738Z +                                    (
2026-02-20T22:09:17.8591163Z +                                        daily_stats[day]["correct"]
2026-02-20T22:09:17.8591678Z +                                        / daily_stats[day]["total"]
2026-02-20T22:09:17.8592150Z +                                        * 100
2026-02-20T22:09:17.8592540Z +                                    )
2026-02-20T22:09:17.8593119Z +                                    if daily_stats[day]["total"] > 0
2026-02-20T22:09:17.8593582Z +                                    else 0
2026-02-20T22:09:17.8593967Z +                                )
2026-02-20T22:09:17.8594355Z +                                for day in sorted_days
2026-02-20T22:09:17.8594788Z +                            ],
2026-02-20T22:09:17.8595111Z +                        }
2026-02-20T22:09:17.8595419Z +                    ],
2026-02-20T22:09:17.8595700Z                  }
2026-02-20T22:09:17.8595972Z -                
2026-02-20T22:09:17.8596233Z +
2026-02-20T22:09:17.8596503Z                  exercises_by_day = {
2026-02-20T22:09:17.8596907Z                      "labels": sorted_days,
2026-02-20T22:09:17.8597308Z -                    "datasets": [{
2026-02-20T22:09:17.8597828Z -                        "label": "Exercices complétés",
2026-02-20T22:09:17.8598399Z -                        "data": [daily_stats[day]["total"] for day in sorted_days],
2026-02-20T22:09:17.8598994Z -                        "borderColor": "rgb(139, 92, 246)",
2026-02-20T22:09:17.8599500Z -                        "backgroundColor": "rgba(139, 92, 246, 0.1)"
2026-02-20T22:09:17.8599968Z -                    }]
2026-02-20T22:09:17.8600282Z +                    "datasets": [
2026-02-20T22:09:17.8600637Z +                        {
2026-02-20T22:09:17.8601101Z +                            "label": "Exercices complétés",
2026-02-20T22:09:17.8601668Z +                            "data": [daily_stats[day]["total"] for day in sorted_days],
2026-02-20T22:09:17.8602276Z +                            "borderColor": "rgb(139, 92, 246)",
2026-02-20T22:09:17.8602787Z +                            "backgroundColor": "rgba(139, 92, 246, 0.1)",
2026-02-20T22:09:17.8603407Z +                        }
2026-02-20T22:09:17.8603712Z +                    ],
2026-02-20T22:09:17.8604008Z                  }
2026-02-20T22:09:17.8604289Z -                
2026-02-20T22:09:17.8604549Z +
2026-02-20T22:09:17.8604885Z              except Exception as progress_calculation_error:
2026-02-20T22:09:17.8605649Z -                logger.error(f"Erreur lors du calcul de la progression: {progress_calculation_error}")
2026-02-20T22:09:17.8606366Z +                logger.error(
2026-02-20T22:09:17.8606931Z +                    f"Erreur lors du calcul de la progression: {progress_calculation_error}"
2026-02-20T22:09:17.8607714Z +                )
2026-02-20T22:09:17.8608095Z                  progress_over_time = {"labels": [], "datasets": []}
2026-02-20T22:09:17.8608657Z                  exercises_by_day = {"labels": [], "datasets": []}
2026-02-20T22:09:17.8609272Z -            
2026-02-20T22:09:17.8609513Z +
2026-02-20T22:09:17.8609878Z              # Compter les challenges complétés
2026-02-20T22:09:17.8610306Z              try:
2026-02-20T22:09:17.8610755Z                  from app.models.logic_challenge import LogicChallengeAttempt
2026-02-20T22:09:17.8611456Z -                total_challenges = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8612097Z -                    LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:17.8612649Z -                    LogicChallengeAttempt.is_correct == True
2026-02-20T22:09:17.8613501Z -                ).count()
2026-02-20T22:09:17.8613811Z +
2026-02-20T22:09:17.8614071Z +                total_challenges = (
2026-02-20T22:09:17.8614485Z +                    db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8614886Z +                    .filter(
2026-02-20T22:09:17.8615284Z +                        LogicChallengeAttempt.user_id == user_id,
2026-02-20T22:09:17.8615807Z +                        LogicChallengeAttempt.is_correct == True,
2026-02-20T22:09:17.8616240Z +                    )
2026-02-20T22:09:17.8616531Z +                    .count()
2026-02-20T22:09:17.8616846Z +                )
2026-02-20T22:09:17.8617199Z              except Exception as challenge_count_error:
2026-02-20T22:09:17.8617893Z -                logger.error(f"Erreur lors du comptage des challenges: {challenge_count_error}")
2026-02-20T22:09:17.8618514Z +                logger.error(
2026-02-20T22:09:17.8618835Z +                    f"Erreur lors du comptage des challenges: {challenge_count_error}"
2026-02-20T22:09:17.8619177Z +                )
2026-02-20T22:09:17.8619360Z                  total_challenges = 0
2026-02-20T22:09:17.8619583Z -            
2026-02-20T22:09:17.8619740Z +
2026-02-20T22:09:17.8619885Z              response_data = {
2026-02-20T22:09:17.8620155Z -                'total_exercises': stats.get("total_attempts", 0),
2026-02-20T22:09:17.8620478Z -                'total_challenges': total_challenges,
2026-02-20T22:09:17.8620795Z -                'correct_answers': stats.get("correct_attempts", 0),
2026-02-20T22:09:17.8621132Z -                'success_rate': stats.get("success_rate", 0),
2026-02-20T22:09:17.8621445Z -                'experience_points': experience_points,
2026-02-20T22:09:17.8621748Z -                'performance_by_type': performance_by_type,
2026-02-20T22:09:17.8622038Z -                'recent_activity': recent_activity,
2026-02-20T22:09:17.8622295Z -                'level': level_data,
2026-02-20T22:09:17.8622545Z -                'progress_over_time': progress_over_time,
2026-02-20T22:09:17.8622832Z -                'exercises_by_day': exercises_by_day,
2026-02-20T22:09:17.8623388Z -                'lastUpdated': datetime.now(timezone.utc).isoformat()
2026-02-20T22:09:17.8623742Z +                "total_exercises": stats.get("total_attempts", 0),
2026-02-20T22:09:17.8624049Z +                "total_challenges": total_challenges,
2026-02-20T22:09:17.8624354Z +                "correct_answers": stats.get("correct_attempts", 0),
2026-02-20T22:09:17.8624677Z +                "success_rate": stats.get("success_rate", 0),
2026-02-20T22:09:17.8624972Z +                "experience_points": experience_points,
2026-02-20T22:09:17.8625273Z +                "performance_by_type": performance_by_type,
2026-02-20T22:09:17.8625556Z +                "recent_activity": recent_activity,
2026-02-20T22:09:17.8625817Z +                "level": level_data,
2026-02-20T22:09:17.8626059Z +                "progress_over_time": progress_over_time,
2026-02-20T22:09:17.8626341Z +                "exercises_by_day": exercises_by_day,
2026-02-20T22:09:17.8626662Z +                "lastUpdated": datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8627121Z              }
2026-02-20T22:09:17.8627280Z -            
2026-02-20T22:09:17.8627428Z +
2026-02-20T22:09:17.8627606Z              return JSONResponse(response_data)
2026-02-20T22:09:17.8627841Z -            
2026-02-20T22:09:17.8627997Z +
2026-02-20T22:09:17.8628277Z      except Exception as stats_retrieval_error:
2026-02-20T22:09:17.8628813Z -        logger.error(f"Erreur lors de la récupération des statistiques: {stats_retrieval_error}")
2026-02-20T22:09:17.8629225Z +        logger.error(
2026-02-20T22:09:17.8629584Z +            f"Erreur lors de la récupération des statistiques: {stats_retrieval_error}"
2026-02-20T22:09:17.8629930Z +        )
2026-02-20T22:09:17.8630107Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8630626Z -        return JSONResponse({"error": "Erreur lors de la récupération des statistiques"}, status_code=500)
2026-02-20T22:09:17.8631060Z +        return JSONResponse(
2026-02-20T22:09:17.8631404Z +            {"error": "Erreur lors de la récupération des statistiques"},
2026-02-20T22:09:17.8631727Z +            status_code=500,
2026-02-20T22:09:17.8631916Z +        )
2026-02-20T22:09:17.8632063Z  
2026-02-20T22:09:17.8632195Z  
2026-02-20T22:09:17.8632347Z  @rate_limit_register
2026-02-20T22:09:17.8632576Z  async def create_user_account(request: Request):
2026-02-20T22:09:17.8632834Z      """
2026-02-20T22:09:17.8633287Z      Endpoint pour créer un nouveau compte utilisateur.
2026-02-20T22:09:17.8633579Z      Route: POST /api/users/
2026-02-20T22:09:17.8633767Z -    
2026-02-20T22:09:17.8633911Z +
2026-02-20T22:09:17.8634046Z      Body JSON:
2026-02-20T22:09:17.8634208Z      {
2026-02-20T22:09:17.8634377Z          "username": "nom_utilisateur",
2026-02-20T22:09:17.8634612Z          "email": "email@example.com",
2026-02-20T22:09:17.8634854Z          "password": "MotDePasse123",
2026-02-20T22:09:17.8635071Z @@ -303,169 +398,183 @@
2026-02-20T22:09:17.8635254Z              status_code=403,
2026-02-20T22:09:17.8635445Z          )
2026-02-20T22:09:17.8635592Z      try:
2026-02-20T22:09:17.8635825Z          # Récupérer les données JSON de la requête
2026-02-20T22:09:17.8636093Z          data = await request.json()
2026-02-20T22:09:17.8636301Z -        
2026-02-20T22:09:17.8636444Z +
2026-02-20T22:09:17.8636612Z          # Extraire les champs requis
2026-02-20T22:09:17.8636861Z -        username = data.get('username', '').strip()
2026-02-20T22:09:17.8637139Z -        email = data.get('email', '').strip()
2026-02-20T22:09:17.8637396Z -        password = data.get('password', '')
2026-02-20T22:09:17.8637690Z -        full_name = data.get('full_name', '').strip() or None
2026-02-20T22:09:17.8637955Z -        
2026-02-20T22:09:17.8638141Z +        username = data.get("username", "").strip()
2026-02-20T22:09:17.8638404Z +        email = data.get("email", "").strip()
2026-02-20T22:09:17.8638660Z +        password = data.get("password", "")
2026-02-20T22:09:17.8638943Z +        full_name = data.get("full_name", "").strip() or None
2026-02-20T22:09:17.8639208Z +
2026-02-20T22:09:17.8639414Z          # Validation basique côté serveur
2026-02-20T22:09:17.8639645Z          if not username:
2026-02-20T22:09:17.8639846Z              return JSONResponse(
2026-02-20T22:09:17.8640096Z -                {"error": "Le nom d'utilisateur est requis"},
2026-02-20T22:09:17.8640375Z -                status_code=400
2026-02-20T22:09:17.8640569Z -            )
2026-02-20T22:09:17.8640724Z -        
2026-02-20T22:09:17.8640953Z +                {"error": "Le nom d'utilisateur est requis"}, status_code=400
2026-02-20T22:09:17.8641014Z +            )
2026-02-20T22:09:17.8641072Z +
2026-02-20T22:09:17.8641149Z          if len(username) < 3:
2026-02-20T22:09:17.8641232Z              return JSONResponse(
2026-02-20T22:09:17.8641465Z                  {"error": "Le nom d'utilisateur doit contenir au moins 3 caractères"},
2026-02-20T22:09:17.8641538Z -                status_code=400
2026-02-20T22:09:17.8641605Z -            )
2026-02-20T22:09:17.8641868Z -        
2026-02-20T22:09:17.8641943Z +                status_code=400,
2026-02-20T22:09:17.8642004Z +            )
2026-02-20T22:09:17.8642067Z +
2026-02-20T22:09:17.8642134Z          if not email:
2026-02-20T22:09:17.8642210Z -            return JSONResponse(
2026-02-20T22:09:17.8642419Z -                {"error": "L'email est requis"},
2026-02-20T22:09:17.8642493Z -                status_code=400
2026-02-20T22:09:17.8642553Z -            )
2026-02-20T22:09:17.8642613Z -        
2026-02-20T22:09:17.8642803Z +            return JSONResponse({"error": "L'email est requis"}, status_code=400)
2026-02-20T22:09:17.8642861Z +
2026-02-20T22:09:17.8642945Z          # Validation email basique
2026-02-20T22:09:17.8643286Z -        email_pattern = r'^[^\s@]+@[^\s@]+\.[^\s@]+$'
2026-02-20T22:09:17.8643393Z +        email_pattern = r"^[^\s@]+@[^\s@]+\.[^\s@]+$"
2026-02-20T22:09:17.8643494Z          if not re.match(email_pattern, email):
2026-02-20T22:09:17.8643580Z -            return JSONResponse(
2026-02-20T22:09:17.8643686Z -                {"error": "Format d'email invalide"},
2026-02-20T22:09:17.8643759Z -                status_code=400
2026-02-20T22:09:17.8643819Z -            )
2026-02-20T22:09:17.8643883Z -        
2026-02-20T22:09:17.8644075Z +            return JSONResponse({"error": "Format d'email invalide"}, status_code=400)
2026-02-20T22:09:17.8644138Z +
2026-02-20T22:09:17.8644222Z          if not password:
2026-02-20T22:09:17.8644299Z              return JSONResponse(
2026-02-20T22:09:17.8644402Z -                {"error": "Le mot de passe est requis"},
2026-02-20T22:09:17.8644473Z -                status_code=400
2026-02-20T22:09:17.8644539Z -            )
2026-02-20T22:09:17.8644597Z -        
2026-02-20T22:09:17.8644733Z +                {"error": "Le mot de passe est requis"}, status_code=400
2026-02-20T22:09:17.8644798Z +            )
2026-02-20T22:09:17.8644855Z +
2026-02-20T22:09:17.8645053Z          # Validation mot de passe selon le schéma UserCreate
2026-02-20T22:09:17.8645134Z          if len(password) < 8:
2026-02-20T22:09:17.8645215Z              return JSONResponse(
2026-02-20T22:09:17.8645432Z                  {"error": "Le mot de passe doit contenir au moins 8 caractères"},
2026-02-20T22:09:17.8645503Z -                status_code=400
2026-02-20T22:09:17.8645568Z -            )
2026-02-20T22:09:17.8645631Z -        
2026-02-20T22:09:17.8645699Z +                status_code=400,
2026-02-20T22:09:17.8645766Z +            )
2026-02-20T22:09:17.8645823Z +
2026-02-20T22:09:17.8645936Z          if not any(char.isdigit() for char in password):
2026-02-20T22:09:17.8646008Z              return JSONResponse(
2026-02-20T22:09:17.8646160Z                  {"error": "Le mot de passe doit contenir au moins un chiffre"},
2026-02-20T22:09:17.8646229Z -                status_code=400
2026-02-20T22:09:17.8646287Z -            )
2026-02-20T22:09:17.8646352Z -        
2026-02-20T22:09:17.8646419Z +                status_code=400,
2026-02-20T22:09:17.8646478Z +            )
2026-02-20T22:09:17.8646538Z +
2026-02-20T22:09:17.8646658Z          if not any(char.isupper() for char in password):
2026-02-20T22:09:17.8646730Z              return JSONResponse(
2026-02-20T22:09:17.8646886Z                  {"error": "Le mot de passe doit contenir au moins une majuscule"},
2026-02-20T22:09:17.8646960Z -                status_code=400
2026-02-20T22:09:17.8647023Z -            )
2026-02-20T22:09:17.8647080Z -        
2026-02-20T22:09:17.8647153Z +                status_code=400,
2026-02-20T22:09:17.8647211Z +            )
2026-02-20T22:09:17.8647269Z +
2026-02-20T22:09:17.8647402Z          # Créer l'utilisateur via le service
2026-02-20T22:09:17.8647467Z          try:
2026-02-20T22:09:17.8647549Z              async with db_session() as db:
2026-02-20T22:09:17.8647672Z                  # Créer le schéma UserCreate
2026-02-20T22:09:17.8647759Z                  user_create = UserCreate(
2026-02-20T22:09:17.8647836Z                      username=username,
2026-02-20T22:09:17.8647904Z                      email=email,
2026-02-20T22:09:17.8648438Z                      ***
2026-02-20T22:09:17.8648524Z -                    full_name=full_name
2026-02-20T22:09:17.8648587Z -                )
2026-02-20T22:09:17.8648647Z -                
2026-02-20T22:09:17.8648747Z +                    full_name=full_name,
2026-02-20T22:09:17.8648816Z +                )
2026-02-20T22:09:17.8648989Z +
2026-02-20T22:09:17.8649125Z                  # Créer l'utilisateur
2026-02-20T22:09:17.8649229Z                  user = create_user(db, user_create)
2026-02-20T22:09:17.8649291Z -                
2026-02-20T22:09:17.8649351Z +
2026-02-20T22:09:17.8649511Z                  # Générer un token de vérification email
2026-02-20T22:09:17.8649622Z                  from datetime import datetime, timezone
2026-02-20T22:09:17.8649681Z  
2026-02-20T22:09:17.8649803Z -                from app.utils.email_verification import \
2026-02-20T22:09:17.8649896Z -                    generate_verification_token
2026-02-20T22:09:17.8649958Z -                
2026-02-20T22:09:17.8650159Z +                from app.utils.email_verification import generate_verification_token
2026-02-20T22:09:17.8650218Z +
2026-02-20T22:09:17.8650351Z                  verification_token = generate_verification_token()
2026-02-20T22:09:17.8650477Z                  user.email_verification_token = verification_token
2026-02-20T22:09:17.8650785Z                  user.email_verification_sent_at = datetime.now(timezone.utc)
2026-02-20T22:09:17.8651147Z                  user.is_email_verified = False  # Par défaut non vérifié
2026-02-20T22:09:17.8651257Z -                
2026-02-20T22:09:17.8651357Z +
2026-02-20T22:09:17.8651457Z                  # Sauvegarder les modifications
2026-02-20T22:09:17.8651534Z                  db.commit()
2026-02-20T22:09:17.8651608Z                  db.refresh(user)
2026-02-20T22:09:17.8651676Z -                
2026-02-20T22:09:17.8651733Z +
2026-02-20T22:09:17.8651876Z                  # Envoyer l'email de vérification
2026-02-20T22:09:17.8651947Z                  try:
2026-02-20T22:09:17.8652229Z -                    logger.info(f"Préparation envoi email de vérification à {user.email}")
2026-02-20T22:09:17.8652302Z +                    logger.info(
2026-02-20T22:09:17.8652532Z +                        f"Préparation envoi email de vérification à {user.email}"
2026-02-20T22:09:17.8652606Z +                    )
2026-02-20T22:09:17.8652678Z                      import os
2026-02-20T22:09:17.8652736Z  
2026-02-20T22:09:17.8652882Z                      from app.services.email_service import EmailService
2026-02-20T22:09:17.8653353Z -                    frontend_url = os.getenv("FRONTEND_URL", "https://mathakine-frontend.onrender.com")
2026-02-20T22:09:17.8653424Z -                    
2026-02-20T22:09:17.8653664Z -                    logger.debug(f"Frontend URL: {frontend_url}, Token: {verification_token[:10]}...")
2026-02-20T22:09:17.8653728Z -                    
2026-02-20T22:09:17.8653787Z +
2026-02-20T22:09:17.8653882Z +                    frontend_url = os.getenv(
2026-02-20T22:09:17.8654057Z +                        "FRONTEND_URL", "https://mathakine-frontend.onrender.com"
2026-02-20T22:09:17.8654123Z +                    )
2026-02-20T22:09:17.8654181Z +
2026-02-20T22:09:17.8654263Z +                    logger.debug(
2026-02-20T22:09:17.8654448Z +                        f"Frontend URL: {frontend_url}, Token: {verification_token[:10]}..."
2026-02-20T22:09:17.8654512Z +                    )
2026-02-20T22:09:17.8654578Z +
2026-02-20T22:09:17.8654713Z                      email_sent = EmailService.send_verification_email(
2026-02-20T22:09:17.8654799Z                          to_email=user.email,
2026-02-20T22:09:17.8654889Z                          username=user.username,
2026-02-20T22:09:17.8655009Z                          verification_token=verification_token,
2026-02-20T22:09:17.8655101Z -                        frontend_url=frontend_url
2026-02-20T22:09:17.8655190Z +                        frontend_url=frontend_url,
2026-02-20T22:09:17.8655258Z                      )
2026-02-20T22:09:17.8655467Z -                    
2026-02-20T22:09:17.8655526Z +
2026-02-20T22:09:17.8655606Z                      if email_sent:
2026-02-20T22:09:17.8655911Z -                        logger.info(f"✅ Email de vérification envoyé avec succès à {user.email}")
2026-02-20T22:09:17.8655989Z +                        logger.info(
2026-02-20T22:09:17.8656334Z +                            f"✅ Email de vérification envoyé avec succès à {user.email}"
2026-02-20T22:09:17.8656410Z +                        )
2026-02-20T22:09:17.8656515Z                          if "localhost" in frontend_url:
2026-02-20T22:09:17.8656716Z                              verify_link = f"{frontend_url}/verify-email?token={verification_token}"
2026-02-20T22:09:17.8656933Z -                            logger.info(f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}")
2026-02-20T22:09:17.8657010Z +                            logger.info(
2026-02-20T22:09:17.8657175Z +                                f"[DEV] Si l'email n'arrive pas, copie ce lien : {verify_link}"
2026-02-20T22:09:17.8657260Z +                            )
2026-02-20T22:09:17.8657327Z                      else:
2026-02-20T22:09:17.8657635Z -                        logger.warning(f"⚠️ Échec de l'envoi de l'email de vérification à {user.email}")
2026-02-20T22:09:17.8657972Z -                        logger.warning(f"Vérifiez la configuration SMTP dans les variables d'environnement")
2026-02-20T22:09:17.8658051Z +                        logger.warning(
2026-02-20T22:09:17.8658285Z +                            f"⚠️ Échec de l'envoi de l'email de vérification à {user.email}"
2026-02-20T22:09:17.8658349Z +                        )
2026-02-20T22:09:17.8658428Z +                        logger.warning(
2026-02-20T22:09:17.8658689Z +                            f"Vérifiez la configuration SMTP dans les variables d'environnement"
2026-02-20T22:09:17.8658755Z +                        )
2026-02-20T22:09:17.8658855Z                  except Exception as email_error:
2026-02-20T22:09:17.8659054Z                      # Ne pas faire échouer l'inscription si l'email échoue
2026-02-20T22:09:17.8659374Z -                    logger.error(f"❌ Erreur lors de l'envoi de l'email de vérification: {email_error}")
2026-02-20T22:09:17.8659455Z +                    logger.error(
2026-02-20T22:09:17.8659711Z +                        f"❌ Erreur lors de l'envoi de l'email de vérification: {email_error}"
2026-02-20T22:09:17.8659775Z +                    )
2026-02-20T22:09:17.8659888Z                      logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8659949Z -                
2026-02-20T22:09:17.8660007Z +
2026-02-20T22:09:17.8660249Z                  # Retourner les données de l'utilisateur créé (sans le mot de passe)
2026-02-20T22:09:17.8660329Z                  user_data = {
2026-02-20T22:09:17.8660400Z                      "id": user.id,
2026-02-20T22:09:17.8660490Z                      "username": user.username,
2026-02-20T22:09:17.8660573Z                      "email": user.email,
2026-02-20T22:09:17.8660670Z                      "full_name": user.full_name,
2026-02-20T22:09:17.8660871Z -                    "role": user.role.value if hasattr(user.role, 'value') else str(user.role),
2026-02-20T22:09:17.8674649Z +                    "role": (
2026-02-20T22:09:17.8674837Z +                        user.role.value
2026-02-20T22:09:17.8675049Z +                        if hasattr(user.role, "value")
2026-02-20T22:09:17.8675233Z +                        else str(user.role)
2026-02-20T22:09:17.8675341Z +                    ),
2026-02-20T22:09:17.8675483Z                      "is_active": user.is_active,
2026-02-20T22:09:17.8675675Z                      "is_email_verified": user.is_email_verified,
2026-02-20T22:09:17.8675988Z -                    "created_at": user.created_at.isoformat() if user.created_at else None,
2026-02-20T22:09:17.8676118Z +                    "created_at": (
2026-02-20T22:09:17.8676380Z +                        user.created_at.isoformat() if user.created_at else None
2026-02-20T22:09:17.8676716Z +                    ),
2026-02-20T22:09:17.8676816Z                  }
2026-02-20T22:09:17.8676925Z -                
2026-02-20T22:09:17.8677019Z +
2026-02-20T22:09:17.8677451Z                  logger.info(f"Nouvel utilisateur créé: {username} ({email})")
2026-02-20T22:09:17.8677552Z -                
2026-02-20T22:09:17.8677833Z +
2026-02-20T22:09:17.8678049Z                  return JSONResponse(user_data, status_code=201)
2026-02-20T22:09:17.8678208Z          except HTTPException as http_error:
2026-02-20T22:09:17.8678568Z              # Gérer les erreurs HTTP (ex: utilisateur déjà existant)
2026-02-20T22:09:17.8678986Z -            logger.warning(f"Erreur HTTP lors de la création de l'utilisateur: {http_error.detail}")
2026-02-20T22:09:17.8679073Z -            return JSONResponse(
2026-02-20T22:09:17.8679175Z -                {"error": http_error.detail},
2026-02-20T22:09:17.8679278Z -                status_code=http_error.status_code
2026-02-20T22:09:17.8679356Z +            logger.warning(
2026-02-20T22:09:17.8679635Z +                f"Erreur HTTP lors de la création de l'utilisateur: {http_error.detail}"
2026-02-20T22:09:17.8679707Z +            )
2026-02-20T22:09:17.8679791Z +            return JSONResponse(
2026-02-20T22:09:17.8679961Z +                {"error": http_error.detail}, status_code=http_error.status_code
2026-02-20T22:09:17.8680035Z              )
2026-02-20T22:09:17.8680142Z          except Exception as user_creation_error:
2026-02-20T22:09:17.8680442Z -            logger.error(f"Erreur lors de la création de l'utilisateur: {user_creation_error}")
2026-02-20T22:09:17.8680527Z +            logger.error(
2026-02-20T22:09:17.8680763Z +                f"Erreur lors de la création de l'utilisateur: {user_creation_error}"
2026-02-20T22:09:17.8680825Z +            )
2026-02-20T22:09:17.8680923Z              logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8681011Z              return JSONResponse(
2026-02-20T22:09:17.8681191Z -                {"error": "Erreur lors de la création du compte"},
2026-02-20T22:09:17.8681275Z -                status_code=500
2026-02-20T22:09:17.8681340Z -            )
2026-02-20T22:09:17.8681401Z -            
2026-02-20T22:09:17.8681627Z +                {"error": "Erreur lors de la création du compte"}, status_code=500
2026-02-20T22:09:17.8681689Z +            )
2026-02-20T22:09:17.8681761Z +
2026-02-20T22:09:17.8681847Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8681928Z -        return JSONResponse(
2026-02-20T22:09:17.8682028Z -            {"error": "Format JSON invalide"},
2026-02-20T22:09:17.8682101Z -            status_code=400
2026-02-20T22:09:17.8682163Z -        )
2026-02-20T22:09:17.8682347Z +        return JSONResponse({"error": "Format JSON invalide"}, status_code=400)
2026-02-20T22:09:17.8682469Z      except Exception as unexpected_creation_error:
2026-02-20T22:09:17.8682823Z -        logger.error(f"Erreur inattendue lors de la création de l'utilisateur: {unexpected_creation_error}")
2026-02-20T22:09:17.8682897Z +        logger.error(
2026-02-20T22:09:17.8683482Z +            f"Erreur inattendue lors de la création de l'utilisateur: {unexpected_creation_error}"
2026-02-20T22:09:17.8683549Z +        )
2026-02-20T22:09:17.8683649Z          logger.debug(traceback.format_exc())
2026-02-20T22:09:17.8683737Z          return JSONResponse(
2026-02-20T22:09:17.8683951Z -            {"error": "Erreur lors de la création du compte"},
2026-02-20T22:09:17.8684026Z -            status_code=500
2026-02-20T22:09:17.8684248Z +            {"error": "Erreur lors de la création du compte"}, status_code=500
2026-02-20T22:09:17.8684311Z          )
2026-02-20T22:09:17.8684371Z  
2026-02-20T22:09:17.8684430Z  
2026-02-20T22:09:17.8684501Z  @require_auth
2026-02-20T22:09:17.8684599Z  async def get_all_users(request: Request):
2026-02-20T22:09:17.8684668Z @@ -473,16 +582,20 @@
2026-02-20T22:09:17.8684884Z      Handler pour récupérer tous les utilisateurs (placeholder).
2026-02-20T22:09:17.8684964Z      Route: GET /api/users/
2026-02-20T22:09:17.8685024Z      """
2026-02-20T22:09:17.8685275Z      try:
2026-02-20T22:09:17.8685377Z          current_user = request.state.user
2026-02-20T22:09:17.8685438Z -        
2026-02-20T22:09:17.8685925Z -        logger.info(f"Accès à la liste de tous les utilisateurs par {current_user.get('username')}. Fonctionnalité en développement.")
2026-02-20T22:09:17.8686097Z +
2026-02-20T22:09:17.8686170Z +        logger.info(
2026-02-20T22:09:17.8686592Z +            f"Accès à la liste de tous les utilisateurs par {current_user.get('username')}. Fonctionnalité en développement."
2026-02-20T22:09:17.8686652Z +        )
2026-02-20T22:09:17.8686718Z  
2026-02-20T22:09:17.8686797Z          return JSONResponse(
2026-02-20T22:09:17.8687081Z -            {"message": "La liste de tous les utilisateurs est en cours de développement."},
2026-02-20T22:09:17.8687163Z -            status_code=200
2026-02-20T22:09:17.8687224Z +            {
2026-02-20T22:09:17.8687494Z +                "message": "La liste de tous les utilisateurs est en cours de développement."
2026-02-20T22:09:17.8687572Z +            },
2026-02-20T22:09:17.8687646Z +            status_code=200,
2026-02-20T22:09:17.8687705Z          )
2026-02-20T22:09:17.8687783Z      except Exception as e:
2026-02-20T22:09:17.8688055Z          logger.error(f"Erreur lors de la récupération de tous les utilisateurs: {e}")
2026-02-20T22:09:17.8688148Z          traceback.print_exc()
2026-02-20T22:09:17.8688349Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8688425Z @@ -509,24 +622,32 @@
2026-02-20T22:09:17.8688588Z              users = q.order_by(User.total_points.desc()).limit(limit).all()
2026-02-20T22:09:17.8688653Z  
2026-02-20T22:09:17.8688726Z              leaderboard = []
2026-02-20T22:09:17.8688806Z              for user in users:
2026-02-20T22:09:17.8688927Z                  settings = user.accessibility_settings or {}
2026-02-20T22:09:17.8689257Z -                privacy = (settings.get("privacy_settings") or {}) if isinstance(settings.get("privacy_settings"), dict) else {}
2026-02-20T22:09:17.8689344Z +                privacy = (
2026-02-20T22:09:17.8689457Z +                    (settings.get("privacy_settings") or {})
2026-02-20T22:09:17.8689605Z +                    if isinstance(settings.get("privacy_settings"), dict)
2026-02-20T22:09:17.8689685Z +                    else {}
2026-02-20T22:09:17.8689749Z +                )
2026-02-20T22:09:17.8689879Z                  if privacy.get("show_in_leaderboards") is False:
2026-02-20T22:09:17.8689956Z                      continue
2026-02-20T22:09:17.8690044Z -                leaderboard.append({
2026-02-20T22:09:17.8690137Z -                    "username": user.username,
2026-02-20T22:09:17.8690246Z -                    "total_points": user.total_points or 0,
2026-02-20T22:09:17.8690367Z -                    "current_level": user.current_level or 1,
2026-02-20T22:09:17.8690479Z -                    "jedi_rank": user.jedi_rank or "youngling",
2026-02-20T22:09:17.8690580Z -                    "is_current_user": user.id == user_id,
2026-02-20T22:09:17.8690655Z -                })
2026-02-20T22:09:17.8690736Z +                leaderboard.append(
2026-02-20T22:09:17.8690802Z +                    {
2026-02-20T22:09:17.8690897Z +                        "username": user.username,
2026-02-20T22:09:17.8691016Z +                        "total_points": user.total_points or 0,
2026-02-20T22:09:17.8691132Z +                        "current_level": user.current_level or 1,
2026-02-20T22:09:17.8691250Z +                        "jedi_rank": user.jedi_rank or "youngling",
2026-02-20T22:09:17.8691360Z +                        "is_current_user": user.id == user_id,
2026-02-20T22:09:17.8691425Z +                    }
2026-02-20T22:09:17.8691486Z +                )
2026-02-20T22:09:17.8691609Z              for i, entry in enumerate(leaderboard, start=1):
2026-02-20T22:09:17.8691686Z                  entry["rank"] = i
2026-02-20T22:09:17.8691746Z  
2026-02-20T22:09:17.8692132Z -            logger.info(f"Classement récupéré par {current_user.get('username')}: {len(leaderboard)} utilisateurs")
2026-02-20T22:09:17.8692302Z +            logger.info(
2026-02-20T22:09:17.8692650Z +                f"Classement récupéré par {current_user.get('username')}: {len(leaderboard)} utilisateurs"
2026-02-20T22:09:17.8692712Z +            )
2026-02-20T22:09:17.8693156Z              return JSONResponse({"leaderboard": leaderboard}, status_code=200)
2026-02-20T22:09:17.8693239Z  
2026-02-20T22:09:17.8693328Z      except Exception as e:
2026-02-20T22:09:17.8693583Z          logger.error(f"Erreur lors de la récupération du classement: {e}")
2026-02-20T22:09:17.8693668Z          traceback.print_exc()
2026-02-20T22:09:17.8693736Z @@ -539,99 +660,118 @@
2026-02-20T22:09:17.8694028Z      Handler pour récupérer la progression globale de l'utilisateur avec vraies données.
2026-02-20T22:09:17.8694124Z      Route: GET /api/users/me/progress
2026-02-20T22:09:17.8694185Z      """
2026-02-20T22:09:17.8694247Z      try:
2026-02-20T22:09:17.8694343Z          current_user = request.state.user
2026-02-20T22:09:17.8694414Z -        
2026-02-20T22:09:17.8694503Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8694790Z -        logger.info(f"Récupération de la progression globale pour l'utilisateur {user_id}")
2026-02-20T22:09:17.8694851Z -        
2026-02-20T22:09:17.8694911Z +
2026-02-20T22:09:17.8695004Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8695079Z +        logger.info(
2026-02-20T22:09:17.8695316Z +            f"Récupération de la progression globale pour l'utilisateur {user_id}"
2026-02-20T22:09:17.8695377Z +        )
2026-02-20T22:09:17.8695441Z +
2026-02-20T22:09:17.8695525Z          async with db_session() as db:
2026-02-20T22:09:17.8695633Z              from app.models.attempt import Attempt
2026-02-20T22:09:17.8695741Z              from app.models.exercise import Exercise
2026-02-20T22:09:17.8695811Z -            
2026-02-20T22:09:17.8695871Z +
2026-02-20T22:09:17.8696080Z              # Récupérer toutes les tentatives avec jointure sur exercises
2026-02-20T22:09:17.8696223Z -            attempts_query = db.query(Attempt, Exercise).join(
2026-02-20T22:09:17.8696343Z -                Exercise, Attempt.exercise_id == Exercise.id
2026-02-20T22:09:17.8696409Z -            ).filter(
2026-02-20T22:09:17.8696502Z -                Attempt.user_id == user_id
2026-02-20T22:09:17.8696609Z -            ).order_by(Attempt.created_at).all()
2026-02-20T22:09:17.8696671Z -            
2026-02-20T22:09:17.8696748Z +            attempts_query = (
2026-02-20T22:09:17.8696846Z +                db.query(Attempt, Exercise)
2026-02-20T22:09:17.8696981Z +                .join(Exercise, Attempt.exercise_id == Exercise.id)
2026-02-20T22:09:17.8697080Z +                .filter(Attempt.user_id == user_id)
2026-02-20T22:09:17.8697180Z +                .order_by(Attempt.created_at)
2026-02-20T22:09:17.8697247Z +                .all()
2026-02-20T22:09:17.8697308Z +            )
2026-02-20T22:09:17.8697367Z +
2026-02-20T22:09:17.8697623Z              # Streak depuis la table users (série de jours consécutifs avec activité)
2026-02-20T22:09:17.8697721Z              from app.models.user import User
2026-02-20T22:09:17.8697780Z +
2026-02-20T22:09:17.8697936Z              user_row = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8698101Z              current_streak = getattr(user_row, "current_streak", None) or 0
2026-02-20T22:09:17.8698238Z              best_streak = getattr(user_row, "best_streak", None) or 0
2026-02-20T22:09:17.8698306Z  
2026-02-20T22:09:17.8698387Z              if not attempts_query:
2026-02-20T22:09:17.8698474Z -                return JSONResponse({
2026-02-20T22:09:17.8698558Z -                    "total_attempts": 0,
2026-02-20T22:09:17.8698647Z -                    "correct_attempts": 0,
2026-02-20T22:09:17.8698723Z -                    "accuracy": 0.0,
2026-02-20T22:09:17.8698804Z -                    "average_time": 0.0,
2026-02-20T22:09:17.8698899Z -                    "exercises_completed": 0,
2026-02-20T22:09:17.8699128Z -                    "highest_streak": best_streak,
2026-02-20T22:09:17.8699230Z -                    "current_streak": current_streak,
2026-02-20T22:09:17.8699312Z -                    "by_category": {}
2026-02-20T22:09:17.8699390Z -                }, status_code=200)
2026-02-20T22:09:17.8699453Z -            
2026-02-20T22:09:17.8699634Z +                return JSONResponse(
2026-02-20T22:09:17.8699710Z +                    {
2026-02-20T22:09:17.8699803Z +                        "total_attempts": 0,
2026-02-20T22:09:17.8699890Z +                        "correct_attempts": 0,
2026-02-20T22:09:17.8699967Z +                        "accuracy": 0.0,
2026-02-20T22:09:17.8700051Z +                        "average_time": 0.0,
2026-02-20T22:09:17.8700140Z +                        "exercises_completed": 0,
2026-02-20T22:09:17.8700237Z +                        "highest_streak": best_streak,
2026-02-20T22:09:17.8700339Z +                        "current_streak": current_streak,
2026-02-20T22:09:17.8700425Z +                        "by_category": {},
2026-02-20T22:09:17.8700497Z +                    },
2026-02-20T22:09:17.8700572Z +                    status_code=200,
2026-02-20T22:09:17.8700641Z +                )
2026-02-20T22:09:17.8700700Z +
2026-02-20T22:09:17.8700773Z              # Stats globales
2026-02-20T22:09:17.8700878Z              total_attempts = len(attempts_query)
2026-02-20T22:09:17.8701092Z -            correct_attempts = sum(1 for attempt, _ in attempts_query if attempt.is_correct)
2026-02-20T22:09:17.8701171Z +            correct_attempts = sum(
2026-02-20T22:09:17.8701311Z +                1 for attempt, _ in attempts_query if attempt.is_correct
2026-02-20T22:09:17.8701379Z +            )
2026-02-20T22:09:17.8701574Z              accuracy = correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8701639Z -            
2026-02-20T22:09:17.8701707Z +
2026-02-20T22:09:17.8701778Z              # Temps moyen
2026-02-20T22:09:17.8702002Z -            times = [attempt.time_spent for attempt, _ in attempts_query if attempt.time_spent]
2026-02-20T22:09:17.8702080Z +            times = [
2026-02-20T22:09:17.8702158Z +                attempt.time_spent
2026-02-20T22:09:17.8702251Z +                for attempt, _ in attempts_query
2026-02-20T22:09:17.8702329Z +                if attempt.time_spent
2026-02-20T22:09:17.8702400Z +            ]
2026-02-20T22:09:17.8702539Z              average_time = sum(times) / len(times) if times else 0.0
2026-02-20T22:09:17.8702599Z -            
2026-02-20T22:09:17.8702662Z +
2026-02-20T22:09:17.8702794Z              # Exercices uniques complétés
2026-02-20T22:09:17.8702880Z              completed_exercise_ids = set()
2026-02-20T22:09:17.8703236Z              for attempt, exercise in attempts_query:
2026-02-20T22:09:17.8703385Z                  if attempt.is_correct:
2026-02-20T22:09:17.8703509Z                      completed_exercise_ids.add(exercise.id)
2026-02-20T22:09:17.8703640Z              exercises_completed = len(completed_exercise_ids)
2026-02-20T22:09:17.8703721Z -            
2026-02-20T22:09:17.8703782Z +
2026-02-20T22:09:17.8703914Z              # Grouper par catégorie
2026-02-20T22:09:17.8703992Z              by_category = {}
2026-02-20T22:09:17.8704078Z              category_attempts = {}
2026-02-20T22:09:17.8704140Z -            
2026-02-20T22:09:17.8704209Z +
2026-02-20T22:09:17.8704327Z              for attempt, exercise in attempts_query:
2026-02-20T22:09:17.8704465Z                  exercise_type = exercise.exercise_type or "unknown"
2026-02-20T22:09:17.8704528Z -                
2026-02-20T22:09:17.8704595Z +
2026-02-20T22:09:17.8704708Z                  if exercise_type not in category_attempts:
2026-02-20T22:09:17.8704816Z                      category_attempts[exercise_type] = {
2026-02-20T22:09:17.8704889Z                          "total": 0,
2026-02-20T22:09:17.8704974Z                          "correct": 0,
2026-02-20T22:09:17.8705067Z -                        "completed_ids": set()
2026-02-20T22:09:17.8705156Z +                        "completed_ids": set(),
2026-02-20T22:09:17.8705370Z                      }
2026-02-20T22:09:17.8705433Z -                
2026-02-20T22:09:17.8705494Z +
2026-02-20T22:09:17.8705620Z                  category_attempts[exercise_type]["total"] += 1
2026-02-20T22:09:17.8705710Z                  if attempt.is_correct:
2026-02-20T22:09:17.8705941Z                      category_attempts[exercise_type]["correct"] += 1
2026-02-20T22:09:17.8706129Z                      category_attempts[exercise_type]["completed_ids"].add(exercise.id)
2026-02-20T22:09:17.8706195Z -            
2026-02-20T22:09:17.8706253Z +
2026-02-20T22:09:17.8706392Z              for exercise_type, stats in category_attempts.items():
2026-02-20T22:09:17.8706478Z                  total = stats["total"]
2026-02-20T22:09:17.8706560Z                  correct = stats["correct"]
2026-02-20T22:09:17.8706651Z                  by_category[exercise_type] = {
2026-02-20T22:09:17.8706770Z                      "completed": len(stats["completed_ids"]),
2026-02-20T22:09:17.8706930Z -                    "accuracy": round(correct / total, 2) if total > 0 else 0.0
2026-02-20T22:09:17.8707081Z +                    "accuracy": round(correct / total, 2) if total > 0 else 0.0,
2026-02-20T22:09:17.8707143Z                  }
2026-02-20T22:09:17.8707207Z -            
2026-02-20T22:09:17.8707294Z -            return JSONResponse({
2026-02-20T22:09:17.8707391Z -                "total_attempts": total_attempts,
2026-02-20T22:09:17.8707497Z -                "correct_attempts": correct_attempts,
2026-02-20T22:09:17.8707590Z -                "accuracy": round(accuracy, 2),
2026-02-20T22:09:17.8707694Z -                "average_time": round(average_time, 1),
2026-02-20T22:09:17.8707806Z -                "exercises_completed": exercises_completed,
2026-02-20T22:09:17.8707898Z -                "highest_streak": best_streak,
2026-02-20T22:09:17.8707986Z -                "current_streak": current_streak,
2026-02-20T22:09:17.8708066Z -                "by_category": by_category
2026-02-20T22:09:17.8708153Z -            }, status_code=200)
2026-02-20T22:09:17.8708212Z -            
2026-02-20T22:09:17.8708270Z +
2026-02-20T22:09:17.8708349Z +            return JSONResponse(
2026-02-20T22:09:17.8708416Z +                {
2026-02-20T22:09:17.8708515Z +                    "total_attempts": total_attempts,
2026-02-20T22:09:17.8708619Z +                    "correct_attempts": correct_attempts,
2026-02-20T22:09:17.8708718Z +                    "accuracy": round(accuracy, 2),
2026-02-20T22:09:17.8708819Z +                    "average_time": round(average_time, 1),
2026-02-20T22:09:17.8708934Z +                    "exercises_completed": exercises_completed,
2026-02-20T22:09:17.8709034Z +                    "highest_streak": best_streak,
2026-02-20T22:09:17.8709125Z +                    "current_streak": current_streak,
2026-02-20T22:09:17.8709212Z +                    "by_category": by_category,
2026-02-20T22:09:17.8709274Z +                },
2026-02-20T22:09:17.8709354Z +                status_code=200,
2026-02-20T22:09:17.8709419Z +            )
2026-02-20T22:09:17.8709478Z +
2026-02-20T22:09:17.8709561Z      except Exception as e:
2026-02-20T22:09:17.8709910Z -        logger.error(f"Erreur lors de la récupération de la progression globale de l'utilisateur: {e}")
2026-02-20T22:09:17.8709991Z +        logger.error(
2026-02-20T22:09:17.8710269Z +            f"Erreur lors de la récupération de la progression globale de l'utilisateur: {e}"
2026-02-20T22:09:17.8710330Z +        )
2026-02-20T22:09:17.8710412Z          traceback.print_exc()
2026-02-20T22:09:17.8710602Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8710666Z  
2026-02-20T22:09:17.8710724Z  
2026-02-20T22:09:17.8710788Z  @require_auth
2026-02-20T22:09:17.8710862Z @@ -640,21 +780,27 @@
2026-02-20T22:09:17.8711165Z      Handler pour récupérer la progression de l'utilisateur par type d'exercice (placeholder).
2026-02-20T22:09:17.8711278Z      Route: GET /api/users/me/progress/{exercise_type}
2026-02-20T22:09:17.8711467Z      """
2026-02-20T22:09:17.8711539Z      try:
2026-02-20T22:09:17.8711632Z          current_user = request.state.user
2026-02-20T22:09:17.8711695Z -        
2026-02-20T22:09:17.8711787Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8712010Z -        exercise_type = request.path_params.get('exercise_type')
2026-02-20T22:09:17.8712518Z -        logger.info(f"Accès à la progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}'. Fonctionnalité en développement.")
2026-02-20T22:09:17.8712587Z +
2026-02-20T22:09:17.8712668Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8712808Z +        exercise_type = request.path_params.get("exercise_type")
2026-02-20T22:09:17.8712878Z +        logger.info(
2026-02-20T22:09:17.8713808Z +            f"Accès à la progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}'. Fonctionnalité en développement."
2026-02-20T22:09:17.8713916Z +        )
2026-02-20T22:09:17.8714012Z  
2026-02-20T22:09:17.8714104Z          return JSONResponse(
2026-02-20T22:09:17.8714575Z -            {"message": f"La progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}' est en cours de développement."},
2026-02-20T22:09:17.8714650Z -            status_code=200
2026-02-20T22:09:17.8714730Z +            {
2026-02-20T22:09:17.8715182Z +                "message": f"La progression de l'utilisateur {user_id} pour le type d'exercice '{exercise_type}' est en cours de développement."
2026-02-20T22:09:17.8715241Z +            },
2026-02-20T22:09:17.8715317Z +            status_code=200,
2026-02-20T22:09:17.8715391Z          )
2026-02-20T22:09:17.8715467Z      except Exception as e:
2026-02-20T22:09:17.8715775Z -        logger.error(f"Erreur lors de la récupération de la progression par type d'exercice: {e}")
2026-02-20T22:09:17.8715852Z +        logger.error(
2026-02-20T22:09:17.8716102Z +            f"Erreur lors de la récupération de la progression par type d'exercice: {e}"
2026-02-20T22:09:17.8716168Z +        )
2026-02-20T22:09:17.8716253Z          traceback.print_exc()
2026-02-20T22:09:17.8716446Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8716504Z  
2026-02-20T22:09:17.8716560Z  
2026-02-20T22:09:17.8716628Z  @require_auth
2026-02-20T22:09:17.8716701Z @@ -663,104 +809,130 @@
2026-02-20T22:09:17.8716947Z      Handler pour récupérer la progression des défis logiques de l'utilisateur.
2026-02-20T22:09:17.8717062Z      Route: GET /api/users/me/challenges/progress
2026-02-20T22:09:17.8717121Z      """
2026-02-20T22:09:17.8717181Z      try:
2026-02-20T22:09:17.8717269Z          current_user = request.state.user
2026-02-20T22:09:17.8717333Z -        
2026-02-20T22:09:17.8717414Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8717700Z -        logger.info(f"Récupération de la progression des défis pour l'utilisateur {user_id}")
2026-02-20T22:09:17.8717765Z -        
2026-02-20T22:09:17.8717822Z +
2026-02-20T22:09:17.8717910Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8717985Z +        logger.info(
2026-02-20T22:09:17.8718225Z +            f"Récupération de la progression des défis pour l'utilisateur {user_id}"
2026-02-20T22:09:17.8718284Z +        )
2026-02-20T22:09:17.8718342Z +
2026-02-20T22:09:17.8718436Z          async with db_session() as db:
2026-02-20T22:09:17.8718647Z              from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.8718706Z -            
2026-02-20T22:09:17.8718768Z +
2026-02-20T22:09:17.8718930Z              # Nombre total de défis actifs dans le système
2026-02-20T22:09:17.8719058Z -            total_challenges = db.query(LogicChallenge).filter(
2026-02-20T22:09:17.8719155Z -                LogicChallenge.is_active == True,
2026-02-20T22:09:17.8719260Z -                LogicChallenge.is_archived == False
2026-02-20T22:09:17.8719324Z -            ).count()
2026-02-20T22:09:17.8719382Z -            
2026-02-20T22:09:17.8719610Z +            total_challenges = (
2026-02-20T22:09:17.8719693Z +                db.query(LogicChallenge)
2026-02-20T22:09:17.8719762Z +                .filter(
2026-02-20T22:09:17.8719870Z +                    LogicChallenge.is_active == True,
2026-02-20T22:09:17.8720079Z +                    LogicChallenge.is_archived == False,
2026-02-20T22:09:17.8720142Z +                )
2026-02-20T22:09:17.8720209Z +                .count()
2026-02-20T22:09:17.8720272Z +            )
2026-02-20T22:09:17.8720329Z +
2026-02-20T22:09:17.8720507Z              # Récupérer toutes les tentatives de l'utilisateur
2026-02-20T22:09:17.8720653Z -            all_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8720761Z -                LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8720825Z -            ).all()
2026-02-20T22:09:17.8720884Z -            
2026-02-20T22:09:17.8720962Z +            all_attempts = (
2026-02-20T22:09:17.8721059Z +                db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8721197Z +                .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:17.8721266Z +                .all()
2026-02-20T22:09:17.8721326Z +            )
2026-02-20T22:09:17.8721382Z +
2026-02-20T22:09:17.8721455Z              if not all_attempts:
2026-02-20T22:09:17.8721549Z -                return JSONResponse({
2026-02-20T22:09:17.8721639Z -                    "completed_challenges": 0,
2026-02-20T22:09:17.8721740Z -                    "total_challenges": total_challenges,
2026-02-20T22:09:17.8721823Z -                    "success_rate": 0.0,
2026-02-20T22:09:17.8721896Z -                    "average_time": 0.0,
2026-02-20T22:09:17.8721971Z -                    "challenges": []
2026-02-20T22:09:17.8722050Z -                }, status_code=200)
2026-02-20T22:09:17.8722110Z -            
2026-02-20T22:09:17.8722187Z +                return JSONResponse(
2026-02-20T22:09:17.8722248Z +                    {
2026-02-20T22:09:17.8722344Z +                        "completed_challenges": 0,
2026-02-20T22:09:17.8722456Z +                        "total_challenges": total_challenges,
2026-02-20T22:09:17.8722536Z +                        "success_rate": 0.0,
2026-02-20T22:09:17.8722618Z +                        "average_time": 0.0,
2026-02-20T22:09:17.8722694Z +                        "challenges": [],
2026-02-20T22:09:17.8722761Z +                    },
2026-02-20T22:09:17.8722834Z +                    status_code=200,
2026-02-20T22:09:17.8722899Z +                )
2026-02-20T22:09:17.8723148Z +
2026-02-20T22:09:17.8723313Z              # Identifier les défis complétés
2026-02-20T22:09:17.8723411Z              completed_challenge_ids = set()
2026-02-20T22:09:17.8723486Z              challenge_stats = {}
2026-02-20T22:09:17.8723546Z -            
2026-02-20T22:09:17.8723608Z +
2026-02-20T22:09:17.8723689Z              for attempt in all_attempts:
2026-02-20T22:09:17.8723789Z                  challenge_id = attempt.challenge_id
2026-02-20T22:09:17.8723850Z -                
2026-02-20T22:09:17.8723919Z +
2026-02-20T22:09:17.8724025Z                  if challenge_id not in challenge_stats:
2026-02-20T22:09:17.8724123Z                      challenge_stats[challenge_id] = {
2026-02-20T22:09:17.8724203Z                          "attempts": 0,
2026-02-20T22:09:17.8724294Z                          "correct_attempts": 0,
2026-02-20T22:09:17.8724372Z                          "best_time": None,
2026-02-20T22:09:17.8724444Z -                        "times": []
2026-02-20T22:09:17.8724520Z +                        "times": [],
2026-02-20T22:09:17.8724584Z                      }
2026-02-20T22:09:17.8724645Z -                
2026-02-20T22:09:17.8724708Z +
2026-02-20T22:09:17.8724830Z                  challenge_stats[challenge_id]["attempts"] += 1
2026-02-20T22:09:17.8724889Z -                
2026-02-20T22:09:17.8724946Z +
2026-02-20T22:09:17.8725031Z                  if attempt.is_correct:
2026-02-20T22:09:17.8725174Z                      challenge_stats[challenge_id]["correct_attempts"] += 1
2026-02-20T22:09:17.8725414Z                      completed_challenge_ids.add(challenge_id)
2026-02-20T22:09:17.8725486Z -                    
2026-02-20T22:09:17.8725544Z +
2026-02-20T22:09:17.8725628Z                      if attempt.time_spent:
2026-02-20T22:09:17.8725870Z                          if challenge_stats[challenge_id]["best_time"] is None:
2026-02-20T22:09:17.8726054Z -                            challenge_stats[challenge_id]["best_time"] = attempt.time_spent
2026-02-20T22:09:17.8726157Z +                            challenge_stats[challenge_id][
2026-02-20T22:09:17.8726233Z +                                "best_time"
2026-02-20T22:09:17.8726329Z +                            ] = attempt.time_spent
2026-02-20T22:09:17.8726398Z                          else:
2026-02-20T22:09:17.8726530Z                              challenge_stats[challenge_id]["best_time"] = min(
2026-02-20T22:09:17.8726659Z                                  challenge_stats[challenge_id]["best_time"],
2026-02-20T22:09:17.8726746Z -                                attempt.time_spent
2026-02-20T22:09:17.8726839Z +                                attempt.time_spent,
2026-02-20T22:09:17.8726911Z                              )
2026-02-20T22:09:17.8726968Z -                
2026-02-20T22:09:17.8727024Z +
2026-02-20T22:09:17.8727100Z                  if attempt.time_spent:
2026-02-20T22:09:17.8727286Z                      challenge_stats[challenge_id]["times"].append(attempt.time_spent)
2026-02-20T22:09:17.8727346Z -            
2026-02-20T22:09:17.8727403Z +
2026-02-20T22:09:17.8727496Z              # Calculer le success_rate global
2026-02-20T22:09:17.8727585Z              total_attempts = len(all_attempts)
2026-02-20T22:09:17.8727736Z              correct_attempts = sum(1 for a in all_attempts if a.is_correct)
2026-02-20T22:09:17.8727946Z -            success_rate = correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8728003Z -            
2026-02-20T22:09:17.8728074Z +            success_rate = (
2026-02-20T22:09:17.8728243Z +                correct_attempts / total_attempts if total_attempts > 0 else 0.0
2026-02-20T22:09:17.8728307Z +            )
2026-02-20T22:09:17.8728363Z +
2026-02-20T22:09:17.8728442Z              # Calculer le temps moyen
2026-02-20T22:09:17.8728603Z              all_times = [a.time_spent for a in all_attempts if a.time_spent]
2026-02-20T22:09:17.8728766Z              average_time = sum(all_times) / len(all_times) if all_times else 0.0
2026-02-20T22:09:17.8728825Z -            
2026-02-20T22:09:17.8728880Z +
2026-02-20T22:09:17.8729081Z              # Construire la liste des défis complétés avec détails
2026-02-20T22:09:17.8729156Z              challenges_list = []
2026-02-20T22:09:17.8729239Z              if completed_challenge_ids:
2026-02-20T22:09:17.8729390Z -                completed_challenges = db.query(LogicChallenge).filter(
2026-02-20T22:09:17.8729512Z -                    LogicChallenge.id.in_(completed_challenge_ids)
2026-02-20T22:09:17.8729578Z -                ).all()
2026-02-20T22:09:17.8729648Z -                
2026-02-20T22:09:17.8729730Z +                completed_challenges = (
2026-02-20T22:09:17.8729815Z +                    db.query(LogicChallenge)
2026-02-20T22:09:17.8729958Z +                    .filter(LogicChallenge.id.in_(completed_challenge_ids))
2026-02-20T22:09:17.8730038Z +                    .all()
2026-02-20T22:09:17.8730099Z +                )
2026-02-20T22:09:17.8730158Z +
2026-02-20T22:09:17.8730266Z                  for challenge in completed_challenges:
2026-02-20T22:09:17.8730386Z                      stats = challenge_stats.get(challenge.id, {})
2026-02-20T22:09:17.8730472Z -                    challenges_list.append({
2026-02-20T22:09:17.8730554Z -                        "id": challenge.id,
2026-02-20T22:09:17.8730644Z -                        "title": challenge.title,
2026-02-20T22:09:17.8730726Z -                        "is_completed": True,
2026-02-20T22:09:17.8730833Z -                        "attempts": stats.get("attempts", 0),
2026-02-20T22:09:17.8731063Z -                        "best_time": round(stats.get("best_time", 0), 2) if stats.get("best_time") else None
2026-02-20T22:09:17.8731215Z -                    })
2026-02-20T22:09:17.8731274Z -            
2026-02-20T22:09:17.8731361Z -            return JSONResponse({
2026-02-20T22:09:17.8731576Z -                "completed_challenges": len(completed_challenge_ids),
2026-02-20T22:09:17.8731678Z -                "total_challenges": total_challenges,
2026-02-20T22:09:17.8731785Z -                "success_rate": round(success_rate, 2),
2026-02-20T22:09:17.8731880Z -                "average_time": round(average_time, 1),
2026-02-20T22:09:17.8731965Z -                "challenges": challenges_list
2026-02-20T22:09:17.8732042Z -            }, status_code=200)
2026-02-20T22:09:17.8732105Z -            
2026-02-20T22:09:17.8732191Z +                    challenges_list.append(
2026-02-20T22:09:17.8732258Z +                        {
2026-02-20T22:09:17.8732350Z +                            "id": challenge.id,
2026-02-20T22:09:17.8732445Z +                            "title": challenge.title,
2026-02-20T22:09:17.8732532Z +                            "is_completed": True,
2026-02-20T22:09:17.8732648Z +                            "attempts": stats.get("attempts", 0),
2026-02-20T22:09:17.8732722Z +                            "best_time": (
2026-02-20T22:09:17.8732835Z +                                round(stats.get("best_time", 0), 2)
2026-02-20T22:09:17.8732931Z +                                if stats.get("best_time")
2026-02-20T22:09:17.8733217Z +                                else None
2026-02-20T22:09:17.8733311Z +                            ),
2026-02-20T22:09:17.8733378Z +                        }
2026-02-20T22:09:17.8733446Z +                    )
2026-02-20T22:09:17.8733504Z +
2026-02-20T22:09:17.8733585Z +            return JSONResponse(
2026-02-20T22:09:17.8733645Z +                {
2026-02-20T22:09:17.8733794Z +                    "completed_challenges": len(completed_challenge_ids),
2026-02-20T22:09:17.8733900Z +                    "total_challenges": total_challenges,
2026-02-20T22:09:17.8734003Z +                    "success_rate": round(success_rate, 2),
2026-02-20T22:09:17.8734110Z +                    "average_time": round(average_time, 1),
2026-02-20T22:09:17.8734201Z +                    "challenges": challenges_list,
2026-02-20T22:09:17.8734271Z +                },
2026-02-20T22:09:17.8734348Z +                status_code=200,
2026-02-20T22:09:17.8734408Z +            )
2026-02-20T22:09:17.8734466Z +
2026-02-20T22:09:17.8734541Z      except Exception as e:
2026-02-20T22:09:17.8734842Z          logger.error(f"Erreur lors de la récupération de la progression des défis: {e}")
2026-02-20T22:09:17.8734921Z          traceback.print_exc()
2026-02-20T22:09:17.8735109Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8735172Z  
2026-02-20T22:09:17.8735237Z @@ -768,11 +940,11 @@
2026-02-20T22:09:17.8735302Z  @require_auth
2026-02-20T22:09:17.8735397Z  async def update_user_me(request: Request):
2026-02-20T22:09:17.8735474Z      """
2026-02-20T22:09:17.8735707Z      Handler pour mettre à jour les informations de l'utilisateur actuel.
2026-02-20T22:09:17.8735786Z      Route: PUT /api/users/me
2026-02-20T22:09:17.8735852Z -    
2026-02-20T22:09:17.8735909Z +
2026-02-20T22:09:17.8735993Z      Champs modifiables :
2026-02-20T22:09:17.8736121Z      - email (avec vérification unicité)
2026-02-20T22:09:17.8736195Z      - full_name
2026-02-20T22:09:17.8736261Z      - grade_level
2026-02-20T22:09:17.8736331Z      - learning_style
2026-02-20T22:09:17.8736406Z @@ -780,137 +952,168 @@
2026-02-20T22:09:17.8736477Z      - preferred_theme
2026-02-20T22:09:17.8736564Z      - accessibility_settings (JSON)
2026-02-20T22:09:17.8736623Z      """
2026-02-20T22:09:17.8736689Z      try:
2026-02-20T22:09:17.8736780Z          from app.models.user import User
2026-02-20T22:09:17.8736840Z -        
2026-02-20T22:09:17.8736901Z +
2026-02-20T22:09:17.8736986Z          current_user = request.state.user
2026-02-20T22:09:17.8737180Z -        
2026-02-20T22:09:17.8737267Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8737333Z +
2026-02-20T22:09:17.8737411Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8737491Z          data = await request.json()
2026-02-20T22:09:17.8737812Z          logger.info(f"Mise à jour profil utilisateur {user_id}")
2026-02-20T22:09:17.8737875Z -        
2026-02-20T22:09:17.8737932Z +
2026-02-20T22:09:17.8738060Z          # Champs autorisés à modifier
2026-02-20T22:09:17.8738134Z          ALLOWED_FIELDS = {
2026-02-20T22:09:17.8738263Z -            'email', 'full_name', 'grade_level', 'learning_style',
2026-02-20T22:09:17.8738439Z -            'preferred_difficulty', 'preferred_theme', 'accessibility_settings'
2026-02-20T22:09:17.8738509Z +            "email",
2026-02-20T22:09:17.8738577Z +            "full_name",
2026-02-20T22:09:17.8738643Z +            "grade_level",
2026-02-20T22:09:17.8738717Z +            "learning_style",
2026-02-20T22:09:17.8738801Z +            "preferred_difficulty",
2026-02-20T22:09:17.8738871Z +            "preferred_theme",
2026-02-20T22:09:17.8738950Z +            "accessibility_settings",
2026-02-20T22:09:17.8739016Z          }
2026-02-20T22:09:17.8739073Z -        
2026-02-20T22:09:17.8739132Z +
2026-02-20T22:09:17.8739386Z          # Gérer les champs de confidentialité : regrouper sous privacy_settings
2026-02-20T22:09:17.8739617Z -        privacy_fields = ['is_public_profile', 'allow_friend_requests', 'show_in_leaderboards', 
2026-02-20T22:09:17.8739740Z -                          'data_retention_consent', 'marketing_consent']
2026-02-20T22:09:17.8739817Z +        privacy_fields = [
2026-02-20T22:09:17.8739893Z +            "is_public_profile",
2026-02-20T22:09:17.8739972Z +            "allow_friend_requests",
2026-02-20T22:09:17.8740047Z +            "show_in_leaderboards",
2026-02-20T22:09:17.8740128Z +            "data_retention_consent",
2026-02-20T22:09:17.8740200Z +            "marketing_consent",
2026-02-20T22:09:17.8740267Z +        ]
2026-02-20T22:09:17.8740343Z          privacy_data = {}
2026-02-20T22:09:17.8740423Z          for field in privacy_fields:
2026-02-20T22:09:17.8740493Z              if field in data:
2026-02-20T22:09:17.8740597Z                  privacy_data[field] = data.pop(field)
2026-02-20T22:09:17.8740681Z          if privacy_data:
2026-02-20T22:09:17.8740783Z -            data['privacy_settings'] = privacy_data
2026-02-20T22:09:17.8740844Z -        
2026-02-20T22:09:17.8740948Z +            data["privacy_settings"] = privacy_data
2026-02-20T22:09:17.8741005Z +
2026-02-20T22:09:17.8741206Z          # Gérer les champs stockés dans accessibility_settings (JSON)
2026-02-20T22:09:17.8741416Z          # notification_preferences, language_preference, timezone, privacy_settings
2026-02-20T22:09:17.8741679Z -        json_fields = ['notification_preferences', 'language_preference', 'timezone', 'privacy_settings']
2026-02-20T22:09:17.8741750Z +        json_fields = [
2026-02-20T22:09:17.8741834Z +            "notification_preferences",
2026-02-20T22:09:17.8742005Z +            "language_preference",
2026-02-20T22:09:17.8742073Z +            "timezone",
2026-02-20T22:09:17.8742147Z +            "privacy_settings",
2026-02-20T22:09:17.8742212Z +        ]
2026-02-20T22:09:17.8742289Z          json_overrides = {}
2026-02-20T22:09:17.8742373Z          for field in json_fields:
2026-02-20T22:09:17.8742445Z              if field in data:
2026-02-20T22:09:17.8742557Z                  json_overrides[field] = data.pop(field)
2026-02-20T22:09:17.8742615Z -        
2026-02-20T22:09:17.8742673Z +
2026-02-20T22:09:17.8742749Z          if json_overrides:
2026-02-20T22:09:17.8742852Z -            if 'accessibility_settings' not in data:
2026-02-20T22:09:17.8742945Z -                data['accessibility_settings'] = {}
2026-02-20T22:09:17.8743328Z -            if isinstance(data['accessibility_settings'], dict):
2026-02-20T22:09:17.8743472Z -                data['accessibility_settings'].update(json_overrides)
2026-02-20T22:09:17.8743579Z +            if "accessibility_settings" not in data:
2026-02-20T22:09:17.8743671Z +                data["accessibility_settings"] = {}
2026-02-20T22:09:17.8743801Z +            if isinstance(data["accessibility_settings"], dict):
2026-02-20T22:09:17.8744091Z +                data["accessibility_settings"].update(json_overrides)
2026-02-20T22:09:17.8744160Z              else:
2026-02-20T22:09:17.8744288Z -                data['accessibility_settings'] = json_overrides
2026-02-20T22:09:17.8744348Z -        
2026-02-20T22:09:17.8744461Z +                data["accessibility_settings"] = json_overrides
2026-02-20T22:09:17.8744524Z +
2026-02-20T22:09:17.8744672Z          # Filtrer les champs non autorisés
2026-02-20T22:09:17.8744835Z          update_data = {k: v for k, v in data.items() if k in ALLOWED_FIELDS}
2026-02-20T22:09:17.8744893Z -        
2026-02-20T22:09:17.8744956Z +
2026-02-20T22:09:17.8745028Z          if not update_data:
2026-02-20T22:09:17.8745106Z              return JSONResponse(
2026-02-20T22:09:17.8745295Z -                {"error": "Aucun champ valide à mettre à jour."},
2026-02-20T22:09:17.8745367Z -                status_code=400
2026-02-20T22:09:17.8745428Z -            )
2026-02-20T22:09:17.8745487Z -        
2026-02-20T22:09:17.8745720Z +                {"error": "Aucun champ valide à mettre à jour."}, status_code=400
2026-02-20T22:09:17.8745780Z +            )
2026-02-20T22:09:17.8745837Z +
2026-02-20T22:09:17.8745924Z          # Validation email si fourni
2026-02-20T22:09:17.8746003Z -        if 'email' in update_data:
2026-02-20T22:09:17.8746112Z -            email = update_data['email'].strip().lower()
2026-02-20T22:09:17.8746274Z -            if not email or not re.match(r'^[^\s@]+@[^\s@]+\.[^\s@]+$', email):
2026-02-20T22:09:17.8746348Z +        if "email" in update_data:
2026-02-20T22:09:17.8746453Z +            email = update_data["email"].strip().lower()
2026-02-20T22:09:17.8746603Z +            if not email or not re.match(r"^[^\s@]+@[^\s@]+\.[^\s@]+$", email):
2026-02-20T22:09:17.8746695Z                  return JSONResponse(
2026-02-20T22:09:17.8746799Z -                    {"error": "Adresse email invalide."},
2026-02-20T22:09:17.8746871Z -                    status_code=400
2026-02-20T22:09:17.8746939Z -                )
2026-02-20T22:09:17.8747028Z -            update_data['email'] = email
2026-02-20T22:09:17.8747086Z -        
2026-02-20T22:09:17.8747212Z +                    {"error": "Adresse email invalide."}, status_code=400
2026-02-20T22:09:17.8747278Z +                )
2026-02-20T22:09:17.8747357Z +            update_data["email"] = email
2026-02-20T22:09:17.8747413Z +
2026-02-20T22:09:17.8747493Z          # Validation full_name
2026-02-20T22:09:17.8747575Z -        if 'full_name' in update_data:
2026-02-20T22:09:17.8747788Z -            full_name = update_data['full_name'].strip() if update_data['full_name'] else None
2026-02-20T22:09:17.8747873Z +        if "full_name" in update_data:
2026-02-20T22:09:17.8747943Z +            full_name = (
2026-02-20T22:09:17.8748241Z +                update_data["full_name"].strip() if update_data["full_name"] else None
2026-02-20T22:09:17.8748303Z +            )
2026-02-20T22:09:17.8748403Z              if full_name and len(full_name) > 100:
2026-02-20T22:09:17.8748482Z                  return JSONResponse(
2026-02-20T22:09:17.8748721Z                      {"error": "Le nom complet ne peut pas dépasser 100 caractères."},
2026-02-20T22:09:17.8748799Z -                    status_code=400
2026-02-20T22:09:17.8748859Z -                )
2026-02-20T22:09:17.8748951Z -            update_data['full_name'] = full_name
2026-02-20T22:09:17.8749014Z -        
2026-02-20T22:09:17.8749084Z +                    status_code=400,
2026-02-20T22:09:17.8749143Z +                )
2026-02-20T22:09:17.8749232Z +            update_data["full_name"] = full_name
2026-02-20T22:09:17.8749293Z +
2026-02-20T22:09:17.8749371Z          # Validation grade_level
2026-02-20T22:09:17.8749452Z -        if 'grade_level' in update_data:
2026-02-20T22:09:17.8749557Z -            grade = update_data['grade_level']
2026-02-20T22:09:17.8749635Z +        if "grade_level" in update_data:
2026-02-20T22:09:17.8749720Z +            grade = update_data["grade_level"]
2026-02-20T22:09:17.8749793Z              if grade is not None:
2026-02-20T22:09:17.8749863Z                  try:
2026-02-20T22:09:17.8750014Z                      grade = int(grade)
2026-02-20T22:09:17.8750102Z                      if grade < 1 or grade > 12:
2026-02-20T22:09:17.8750193Z                          return JSONResponse(
2026-02-20T22:09:17.8750401Z                              {"error": "Le niveau scolaire doit être entre 1 et 12."},
2026-02-20T22:09:17.8750481Z -                            status_code=400
2026-02-20T22:09:17.8750561Z +                            status_code=400,
2026-02-20T22:09:17.8750625Z                          )
2026-02-20T22:09:17.8750724Z -                    update_data['grade_level'] = grade
2026-02-20T22:09:17.8750815Z +                    update_data["grade_level"] = grade
2026-02-20T22:09:17.8750920Z                  except (ValueError, TypeError):
2026-02-20T22:09:17.8750999Z                      return JSONResponse(
2026-02-20T22:09:17.8751189Z                          {"error": "Le niveau scolaire doit être un nombre."},
2026-02-20T22:09:17.8751278Z -                        status_code=400
2026-02-20T22:09:17.8751351Z +                        status_code=400,
2026-02-20T22:09:17.8751415Z                      )
2026-02-20T22:09:17.8751478Z -        
2026-02-20T22:09:17.8751535Z +
2026-02-20T22:09:17.8751610Z          # Validation learning_style
2026-02-20T22:09:17.8751818Z -        VALID_STYLES = {'visuel', 'auditif', 'kinesthésique', 'lecture'}
2026-02-20T22:09:17.8751912Z -        if 'learning_style' in update_data:
2026-02-20T22:09:17.8752007Z -            style = update_data['learning_style']
2026-02-20T22:09:17.8752206Z +        VALID_STYLES = {"visuel", "auditif", "kinesthésique", "lecture"}
2026-02-20T22:09:17.8752297Z +        if "learning_style" in update_data:
2026-02-20T22:09:17.8752395Z +            style = update_data["learning_style"]
2026-02-20T22:09:17.8752493Z              if style and style not in VALID_STYLES:
2026-02-20T22:09:17.8752573Z                  return JSONResponse(
2026-02-20T22:09:17.8752928Z -                    {"error": f"Style d'apprentissage invalide. Valeurs acceptées : {', '.join(VALID_STYLES)}"},
2026-02-20T22:09:17.8753206Z -                    status_code=400
2026-02-20T22:09:17.8753272Z -                )
2026-02-20T22:09:17.8753339Z -        
2026-02-20T22:09:17.8753402Z +                    {
2026-02-20T22:09:17.8753747Z +                        "error": f"Style d'apprentissage invalide. Valeurs acceptées : {', '.join(VALID_STYLES)}"
2026-02-20T22:09:17.8753821Z +                    },
2026-02-20T22:09:17.8753896Z +                    status_code=400,
2026-02-20T22:09:17.8753957Z +                )
2026-02-20T22:09:17.8754015Z +
2026-02-20T22:09:17.8754103Z          # Validation preferred_theme
2026-02-20T22:09:17.8754341Z -        VALID_THEMES = {'spatial', 'minimalist', 'ocean', 'dune', 'forest', 'peach', 'dino', 'neutral'}
2026-02-20T22:09:17.8754572Z -        if 'preferred_theme' in update_data:
2026-02-20T22:09:17.8754678Z -            theme = update_data['preferred_theme']
2026-02-20T22:09:17.8754752Z +        VALID_THEMES = {
2026-02-20T22:09:17.8754828Z +            "spatial",
2026-02-20T22:09:17.8754906Z +            "minimalist",
2026-02-20T22:09:17.8754969Z +            "ocean",
2026-02-20T22:09:17.8755032Z +            "dune",
2026-02-20T22:09:17.8755096Z +            "forest",
2026-02-20T22:09:17.8755166Z +            "peach",
2026-02-20T22:09:17.8755230Z +            "dino",
2026-02-20T22:09:17.8755295Z +            "neutral",
2026-02-20T22:09:17.8755359Z +        }
2026-02-20T22:09:17.8755456Z +        if "preferred_theme" in update_data:
2026-02-20T22:09:17.8755552Z +            theme = update_data["preferred_theme"]
2026-02-20T22:09:17.8755649Z              if theme and theme not in VALID_THEMES:
2026-02-20T22:09:17.8755744Z                  return JSONResponse(
2026-02-20T22:09:17.8756025Z -                    {"error": f"Thème invalide. Valeurs acceptées : {', '.join(VALID_THEMES)}"},
2026-02-20T22:09:17.8756099Z -                    status_code=400
2026-02-20T22:09:17.8756169Z -                )
2026-02-20T22:09:17.8756230Z -        
2026-02-20T22:09:17.8756437Z +                    {
2026-02-20T22:09:17.8756714Z +                        "error": f"Thème invalide. Valeurs acceptées : {', '.join(VALID_THEMES)}"
2026-02-20T22:09:17.8756778Z +                    },
2026-02-20T22:09:17.8756852Z +                    status_code=400,
2026-02-20T22:09:17.8756914Z +                )
2026-02-20T22:09:17.8756980Z +
2026-02-20T22:09:17.8757088Z          # Mise à jour en base
2026-02-20T22:09:17.8757171Z          async with db_session() as db:
2026-02-20T22:09:17.8757317Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8757388Z              if not user:
2026-02-20T22:09:17.8757594Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8757664Z -            
2026-02-20T22:09:17.8757749Z +                return JSONResponse(
2026-02-20T22:09:17.8757886Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8757953Z +                )
2026-02-20T22:09:17.8758018Z +
2026-02-20T22:09:17.8758158Z              # Vérifier unicité email si modifié
2026-02-20T22:09:17.8758314Z -            if 'email' in update_data and update_data['email'] != user.email:
2026-02-20T22:09:17.8758409Z -                existing = db.query(User).filter(
2026-02-20T22:09:17.8758512Z -                    User.email == update_data['email'],
2026-02-20T22:09:17.8758586Z -                    User.id != user_id
2026-02-20T22:09:17.8758650Z -                ).first()
2026-02-20T22:09:17.8758802Z +            if "email" in update_data and update_data["email"] != user.email:
2026-02-20T22:09:17.8758873Z +                existing = (
2026-02-20T22:09:17.8758951Z +                    db.query(User)
2026-02-20T22:09:17.8759116Z +                    .filter(User.email == update_data["email"], User.id != user_id)
2026-02-20T22:09:17.8759181Z +                    .first()
2026-02-20T22:09:17.8759240Z +                )
2026-02-20T22:09:17.8759315Z                  if existing:
2026-02-20T22:09:17.8759402Z                      return JSONResponse(
2026-02-20T22:09:17.8759588Z                          {"error": "Cette adresse email est déjà utilisée."},
2026-02-20T22:09:17.8759665Z -                        status_code=400
2026-02-20T22:09:17.8759743Z +                        status_code=400,
2026-02-20T22:09:17.8759806Z                      )
2026-02-20T22:09:17.8759864Z -            
2026-02-20T22:09:17.8759926Z +
2026-02-20T22:09:17.8760009Z              # Appliquer les modifications
2026-02-20T22:09:17.8760109Z              for field, value in update_data.items():
2026-02-20T22:09:17.8760209Z -                if field == 'accessibility_settings':
2026-02-20T22:09:17.8760401Z +                if field == "accessibility_settings":
2026-02-20T22:09:17.8760600Z                      # Merger avec les settings existants pour ne pas écraser
2026-02-20T22:09:17.8760873Z                      # IMPORTANT: créer un NOUVEAU dict pour que SQLAlchemy détecte le changement
2026-02-20T22:09:17.8761087Z                      # (les mutations in-place sur JSON ne sont pas trackées)
2026-02-20T22:09:17.8761246Z                      existing_settings = dict(user.accessibility_settings or {})
2026-02-20T22:09:17.8761336Z                      if isinstance(value, dict):
2026-02-20T22:09:17.8761408Z @@ -918,14 +1121,14 @@
2026-02-20T22:09:17.8761518Z                          setattr(user, field, existing_settings)
2026-02-20T22:09:17.8761585Z                      else:
2026-02-20T22:09:17.8761675Z                          setattr(user, field, value)
2026-02-20T22:09:17.8761747Z                  else:
2026-02-20T22:09:17.8761834Z                      setattr(user, field, value)
2026-02-20T22:09:17.8761904Z -            
2026-02-20T22:09:17.8761968Z +
2026-02-20T22:09:17.8762039Z              db.commit()
2026-02-20T22:09:17.8762111Z              db.refresh(user)
2026-02-20T22:09:17.8762174Z -            
2026-02-20T22:09:17.8762231Z +
2026-02-20T22:09:17.8762486Z              # Construire la réponse
2026-02-20T22:09:17.8762563Z              response_data = {
2026-02-20T22:09:17.8762638Z                  "id": user.id,
2026-02-20T22:09:17.8762723Z                  "username": user.username,
2026-02-20T22:09:17.8762800Z                  "email": user.email,
2026-02-20T22:09:17.8762869Z @@ -941,14 +1144,16 @@
2026-02-20T22:09:17.8763248Z                  "updated_at": user.updated_at.isoformat() if user.updated_at else None,
2026-02-20T22:09:17.8763347Z                  "total_points": user.total_points,
2026-02-20T22:09:17.8763445Z                  "current_level": user.current_level,
2026-02-20T22:09:17.8763537Z                  "jedi_rank": user.jedi_rank,
2026-02-20T22:09:17.8763604Z              }
2026-02-20T22:09:17.8763663Z -            
2026-02-20T22:09:17.8763979Z -            logger.info(f"Profil utilisateur {user_id} mis à jour : {list(update_data.keys())}")
2026-02-20T22:09:17.8764037Z +
2026-02-20T22:09:17.8764107Z +            logger.info(
2026-02-20T22:09:17.8764367Z +                f"Profil utilisateur {user_id} mis à jour : {list(update_data.keys())}"
2026-02-20T22:09:17.8764427Z +            )
2026-02-20T22:09:17.8764523Z              return JSONResponse(response_data)
2026-02-20T22:09:17.8764581Z -            
2026-02-20T22:09:17.8764645Z +
2026-02-20T22:09:17.8764730Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8764982Z          return JSONResponse({"error": "Données JSON invalides."}, status_code=400)
2026-02-20T22:09:17.8765067Z      except Exception as e:
2026-02-20T22:09:17.8765290Z          logger.error(f"Erreur lors de la mise à jour de l'utilisateur: {e}")
2026-02-20T22:09:17.8765370Z          traceback.print_exc()
2026-02-20T22:09:17.8765436Z @@ -959,75 +1164,77 @@
2026-02-20T22:09:17.8765573Z  async def update_user_password_me(request: Request):
2026-02-20T22:09:17.8765634Z      """
2026-02-20T22:09:17.8765854Z      Handler pour mettre à jour le mot de passe de l'utilisateur actuel.
2026-02-20T22:09:17.8765951Z      Route: PUT /api/users/me/password
2026-02-20T22:09:17.8766071Z      Protégé CSRF (audit 3.2).
2026-02-20T22:09:17.8766132Z -    
2026-02-20T22:09:17.8766190Z +
2026-02-20T22:09:17.8766263Z      Body attendu :
2026-02-20T22:09:17.8766360Z      - current_password: mot de passe actuel
2026-02-20T22:09:17.8766540Z      - new_password: nouveau mot de passe (min 8 caractères)
2026-02-20T22:09:17.8766607Z      """
2026-02-20T22:09:17.8766697Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:17.8766760Z      if csrf_err:
2026-02-20T22:09:17.8766838Z          return csrf_err
2026-02-20T22:09:17.8766899Z      try:
2026-02-20T22:09:17.8766986Z          from app.models.user import User
2026-02-20T22:09:17.8767149Z          from app.core.security import verify_password, get_password_hash
2026-02-20T22:09:17.8767355Z -        
2026-02-20T22:09:17.8767414Z +
2026-02-20T22:09:17.8767501Z          current_user = request.state.user
2026-02-20T22:09:17.8767571Z -        
2026-02-20T22:09:17.8767652Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8767719Z +
2026-02-20T22:09:17.8767798Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8767885Z          data = await request.json()
2026-02-20T22:09:17.8767945Z -        
2026-02-20T22:09:17.8768091Z -        current_password = data.get('current_password', '').strip()
2026-02-20T22:09:17.8768219Z -        new_password = data.get('new_password', '').strip()
2026-02-20T22:09:17.8768276Z -        
2026-02-20T22:09:17.8768334Z +
2026-02-20T22:09:17.8768475Z +        current_password = data.get("current_password", "").strip()
2026-02-20T22:09:17.8768594Z +        new_password = data.get("new_password", "").strip()
2026-02-20T22:09:17.8768650Z +
2026-02-20T22:09:17.8768715Z          # Validation
2026-02-20T22:09:17.8768807Z          if not current_password:
2026-02-20T22:09:17.8768883Z              return JSONResponse(
2026-02-20T22:09:17.8769004Z -                {"error": "Le mot de passe actuel est requis."},
2026-02-20T22:09:17.8769083Z -                status_code=400
2026-02-20T22:09:17.8769341Z +                {"error": "Le mot de passe actuel est requis."}, status_code=400
2026-02-20T22:09:17.8769405Z              )
2026-02-20T22:09:17.8769480Z          if not new_password:
2026-02-20T22:09:17.8769559Z              return JSONResponse(
2026-02-20T22:09:17.8769683Z -                {"error": "Le nouveau mot de passe est requis."},
2026-02-20T22:09:17.8769754Z -                status_code=400
2026-02-20T22:09:17.8769909Z +                {"error": "Le nouveau mot de passe est requis."}, status_code=400
2026-02-20T22:09:17.8769967Z              )
2026-02-20T22:09:17.8770043Z          if len(new_password) < 8:
2026-02-20T22:09:17.8770116Z              return JSONResponse(
2026-02-20T22:09:17.8770390Z -                {"error": "Le nouveau mot de passe doit contenir au moins 8 caractères."},
2026-02-20T22:09:17.8770464Z -                status_code=400
2026-02-20T22:09:17.8770524Z +                {
2026-02-20T22:09:17.8770781Z +                    "error": "Le nouveau mot de passe doit contenir au moins 8 caractères."
2026-02-20T22:09:17.8770843Z +                },
2026-02-20T22:09:17.8770912Z +                status_code=400,
2026-02-20T22:09:17.8770976Z              )
2026-02-20T22:09:17.8771068Z          if current_password == new_password:
2026-02-20T22:09:17.8771140Z              return JSONResponse(
2026-02-20T22:09:17.8771368Z                  {"error": "Le nouveau mot de passe doit être différent de l'ancien."},
2026-02-20T22:09:17.8771445Z -                status_code=400
2026-02-20T22:09:17.8771503Z -            )
2026-02-20T22:09:17.8771562Z -        
2026-02-20T22:09:17.8771639Z +                status_code=400,
2026-02-20T22:09:17.8771699Z +            )
2026-02-20T22:09:17.8771762Z +
2026-02-20T22:09:17.8771894Z          # Vérification et mise à jour en base
2026-02-20T22:09:17.8771980Z          async with db_session() as db:
2026-02-20T22:09:17.8772115Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8772186Z              if not user:
2026-02-20T22:09:17.8772401Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8772459Z -            
2026-02-20T22:09:17.8772536Z +                return JSONResponse(
2026-02-20T22:09:17.8772673Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8772733Z +                )
2026-02-20T22:09:17.8772791Z +
2026-02-20T22:09:17.8772918Z              # Vérifier le mot de passe actuel
2026-02-20T22:09:17.8773272Z              if not verify_password(current_password, user.hashed_password):
2026-02-20T22:09:17.8773354Z                  return JSONResponse(
2026-02-20T22:09:17.8773480Z -                    {"error": "Le mot de passe actuel est incorrect."},
2026-02-20T22:09:17.8773697Z -                    status_code=401
2026-02-20T22:09:17.8773758Z -                )
2026-02-20T22:09:17.8773815Z -            
2026-02-20T22:09:17.8773985Z +                    {"error": "Le mot de passe actuel est incorrect."}, status_code=401
2026-02-20T22:09:17.8774045Z +                )
2026-02-20T22:09:17.8774102Z +
2026-02-20T22:09:17.8774215Z              # Hasher et sauvegarder le nouveau mot de passe
2026-02-20T22:09:17.8774356Z              user.hashed_password = get_password_hash(new_password)
2026-02-20T22:09:17.8774425Z              db.commit()
2026-02-20T22:09:17.8774484Z -            
2026-02-20T22:09:17.8774762Z -            logger.info(f"Mot de passe de l'utilisateur {user_id} mis à jour avec succès")
2026-02-20T22:09:17.8774840Z -            return JSONResponse({
2026-02-20T22:09:17.8774913Z -                "success": True,
2026-02-20T22:09:17.8775084Z -                "message": "Mot de passe mis à jour avec succès."
2026-02-20T22:09:17.8775158Z -            })
2026-02-20T22:09:17.8775217Z -            
2026-02-20T22:09:17.8775274Z +
2026-02-20T22:09:17.8775351Z +            logger.info(
2026-02-20T22:09:17.8775578Z +                f"Mot de passe de l'utilisateur {user_id} mis à jour avec succès"
2026-02-20T22:09:17.8775751Z +            )
2026-02-20T22:09:17.8775840Z +            return JSONResponse(
2026-02-20T22:09:17.8776073Z +                {"success": True, "message": "Mot de passe mis à jour avec succès."}
2026-02-20T22:09:17.8776134Z +            )
2026-02-20T22:09:17.8776196Z +
2026-02-20T22:09:17.8776285Z      except json.JSONDecodeError:
2026-02-20T22:09:17.8776538Z          return JSONResponse({"error": "Données JSON invalides."}, status_code=400)
2026-02-20T22:09:17.8776617Z      except Exception as e:
2026-02-20T22:09:17.8776845Z          logger.error(f"Erreur lors de la mise à jour du mot de passe: {e}")
2026-02-20T22:09:17.8776926Z          traceback.print_exc()
2026-02-20T22:09:17.8777002Z @@ -1038,44 +1245,45 @@
2026-02-20T22:09:17.8777100Z  async def delete_user_me(request: Request):
2026-02-20T22:09:17.8777167Z      """
2026-02-20T22:09:17.8777366Z      Handler pour supprimer le compte de l'utilisateur connecté.
2026-02-20T22:09:17.8777444Z      Route: DELETE /api/users/me
2026-02-20T22:09:17.8777571Z      Protégé CSRF (audit 3.2).
2026-02-20T22:09:17.8777631Z -    
2026-02-20T22:09:17.8777690Z +
2026-02-20T22:09:17.8777915Z      Supprime l'utilisateur et toutes ses données associées (cascade).
2026-02-20T22:09:17.8777975Z      """
2026-02-20T22:09:17.8778064Z      csrf_err = validate_csrf_token(request)
2026-02-20T22:09:17.8778129Z      if csrf_err:
2026-02-20T22:09:17.8778206Z          return csrf_err
2026-02-20T22:09:17.8778266Z      try:
2026-02-20T22:09:17.8778355Z          from app.models.user import User
2026-02-20T22:09:17.8778419Z -        
2026-02-20T22:09:17.8778478Z +
2026-02-20T22:09:17.8778563Z          current_user = request.state.user
2026-02-20T22:09:17.8778622Z -        
2026-02-20T22:09:17.8778717Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8778815Z -        username = current_user.get('username')
2026-02-20T22:09:17.8778872Z -        
2026-02-20T22:09:17.8778934Z +
2026-02-20T22:09:17.8779012Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8779108Z +        username = current_user.get("username")
2026-02-20T22:09:17.8779165Z +
2026-02-20T22:09:17.8779250Z          async with db_session() as db:
2026-02-20T22:09:17.8779382Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8779452Z              if not user:
2026-02-20T22:09:17.8779659Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8779718Z -            
2026-02-20T22:09:17.8779797Z +                return JSONResponse(
2026-02-20T22:09:17.8779929Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8779994Z +                )
2026-02-20T22:09:17.8780138Z +
2026-02-20T22:09:17.8780372Z              # Suppression (les relations cascade suppriment les données liées)
2026-02-20T22:09:17.8780450Z              db.delete(user)
2026-02-20T22:09:17.8780517Z              db.commit()
2026-02-20T22:09:17.8780575Z -            
2026-02-20T22:09:17.8780636Z +
2026-02-20T22:09:17.8780885Z              logger.info(f"Compte utilisateur supprimé : {username} (ID: {user_id})")
2026-02-20T22:09:17.8780944Z -            
2026-02-20T22:09:17.8781000Z +
2026-02-20T22:09:17.8781167Z              # Créer la réponse avec suppression du cookie
2026-02-20T22:09:17.8781251Z -            response = JSONResponse({
2026-02-20T22:09:17.8781326Z -                "success": True,
2026-02-20T22:09:17.8781519Z -                "message": "Votre compte a été supprimé avec succès."
2026-02-20T22:09:17.8781579Z -            })
2026-02-20T22:09:17.8781657Z +            response = JSONResponse(
2026-02-20T22:09:17.8781897Z +                {"success": True, "message": "Votre compte a été supprimé avec succès."}
2026-02-20T22:09:17.8781971Z +            )
2026-02-20T22:09:17.8782072Z              response.delete_cookie("access_token")
2026-02-20T22:09:17.8782173Z              response.delete_cookie("refresh_token")
2026-02-20T22:09:17.8782250Z              return response
2026-02-20T22:09:17.8782391Z -            
2026-02-20T22:09:17.8782452Z +
2026-02-20T22:09:17.8782536Z      except Exception as e:
2026-02-20T22:09:17.8782688Z          logger.error(f"Erreur lors de la suppression du compte: {e}")
2026-02-20T22:09:17.8782767Z          traceback.print_exc()
2026-02-20T22:09:17.8782951Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8783221Z  
2026-02-20T22:09:17.8783360Z @@ -1086,21 +1294,25 @@
2026-02-20T22:09:17.8783504Z      Handler pour supprimer un utilisateur par ID (admin).
2026-02-20T22:09:17.8783595Z      Route: DELETE /api/users/{user_id}
2026-02-20T22:09:17.8783656Z      """
2026-02-20T22:09:17.8783715Z      try:
2026-02-20T22:09:17.8783811Z          current_user = request.state.user
2026-02-20T22:09:17.8783876Z -        
2026-02-20T22:09:17.8784022Z -        user_to_delete_id = int(request.path_params.get('user_id'))
2026-02-20T22:09:17.8784120Z -        current_user_id = current_user.get('id')
2026-02-20T22:09:17.8784186Z -        
2026-02-20T22:09:17.8784249Z +
2026-02-20T22:09:17.8784389Z +        user_to_delete_id = int(request.path_params.get("user_id"))
2026-02-20T22:09:17.8784487Z +        current_user_id = current_user.get("id")
2026-02-20T22:09:17.8784544Z +
2026-02-20T22:09:17.8784635Z          if user_to_delete_id != current_user_id:
2026-02-20T22:09:17.8784989Z -            return JSONResponse({"error": "Non autorisé à supprimer cet utilisateur"}, status_code=403)
2026-02-20T22:09:17.8785059Z -            
2026-02-20T22:09:17.8785489Z -        logger.info(f"Tentative de suppression de l'utilisateur {user_to_delete_id} - Redirigé vers DELETE /api/users/me")
2026-02-20T22:09:17.8785568Z +            return JSONResponse(
2026-02-20T22:09:17.8785819Z +                {"error": "Non autorisé à supprimer cet utilisateur"}, status_code=403
2026-02-20T22:09:17.8785879Z +            )
2026-02-20T22:09:17.8785935Z +
2026-02-20T22:09:17.8786003Z +        logger.info(
2026-02-20T22:09:17.8786371Z +            f"Tentative de suppression de l'utilisateur {user_to_delete_id} - Redirigé vers DELETE /api/users/me"
2026-02-20T22:09:17.8786431Z +        )
2026-02-20T22:09:17.8786511Z          return JSONResponse(
2026-02-20T22:09:17.8786702Z              {"message": "Utilisez DELETE /api/users/me pour supprimer votre compte."},
2026-02-20T22:09:17.8786775Z -            status_code=400
2026-02-20T22:09:17.8786845Z +            status_code=400,
2026-02-20T22:09:17.8786908Z          )
2026-02-20T22:09:17.8786981Z      except ValueError:
2026-02-20T22:09:17.8787165Z          return JSONResponse({"error": "ID utilisateur invalide"}, status_code=400)
2026-02-20T22:09:17.8787240Z      except Exception as e:
2026-02-20T22:09:17.8787421Z          logger.error(f"Erreur lors de la suppression de l'utilisateur: {e}")
2026-02-20T22:09:17.8787626Z @@ -1111,31 +1323,33 @@
2026-02-20T22:09:17.8787693Z  @require_auth
2026-02-20T22:09:17.8787802Z  async def export_user_data(request: Request):
2026-02-20T22:09:17.8787862Z      """
2026-02-20T22:09:17.8788078Z      Exporte toutes les données de l'utilisateur connecté (RGPD).
2026-02-20T22:09:17.8788168Z      Route: GET /api/users/me/export
2026-02-20T22:09:17.8788226Z -    
2026-02-20T22:09:17.8788283Z +
2026-02-20T22:09:17.8788560Z      Retourne un JSON avec : profil, exercices tentés, défis tentés, badges, progression.
2026-02-20T22:09:17.8788626Z      """
2026-02-20T22:09:17.8788686Z      try:
2026-02-20T22:09:17.8788772Z          from app.models.user import User
2026-02-20T22:09:17.8788879Z          from app.models.attempt import Attempt
2026-02-20T22:09:17.8788978Z          from app.models.exercise import Exercise
2026-02-20T22:09:17.8789179Z          from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:17.8789318Z          from app.models.achievement import UserAchievement
2026-02-20T22:09:17.8789421Z          from app.models.progress import Progress
2026-02-20T22:09:17.8789556Z          from app.models.recommendation import Recommendation
2026-02-20T22:09:17.8789616Z -        
2026-02-20T22:09:17.8789793Z +
2026-02-20T22:09:17.8789883Z          current_user = request.state.user
2026-02-20T22:09:17.8789941Z -        
2026-02-20T22:09:17.8790031Z -        user_id = current_user.get('id')
2026-02-20T22:09:17.8790089Z -        
2026-02-20T22:09:17.8790149Z +
2026-02-20T22:09:17.8790227Z +        user_id = current_user.get("id")
2026-02-20T22:09:17.8790292Z +
2026-02-20T22:09:17.8790372Z          async with db_session() as db:
2026-02-20T22:09:17.8790504Z              user = db.query(User).filter(User.id == user_id).first()
2026-02-20T22:09:17.8790578Z              if not user:
2026-02-20T22:09:17.8790781Z -                return JSONResponse({"error": "Utilisateur introuvable."}, status_code=404)
2026-02-20T22:09:17.8790844Z -            
2026-02-20T22:09:17.8790923Z +                return JSONResponse(
2026-02-20T22:09:17.8791061Z +                    {"error": "Utilisateur introuvable."}, status_code=404
2026-02-20T22:09:17.8791121Z +                )
2026-02-20T22:09:17.8791177Z +
2026-02-20T22:09:17.8791283Z              # Profil utilisateur (tous les champs)
2026-02-20T22:09:17.8791353Z              profile = {
2026-02-20T22:09:17.8791425Z                  "id": user.id,
2026-02-20T22:09:17.8791506Z                  "username": user.username,
2026-02-20T22:09:17.8791586Z                  "email": user.email,
2026-02-20T22:09:17.8791650Z @@ -1147,84 +1361,138 @@
2026-02-20T22:09:17.8791781Z                  "preferred_difficulty": user.preferred_difficulty,
2026-02-20T22:09:17.8791893Z                  "preferred_theme": user.preferred_theme,
2026-02-20T22:09:17.8792032Z                  "accessibility_settings": user.accessibility_settings,
2026-02-20T22:09:17.8792122Z                  "total_points": user.total_points,
2026-02-20T22:09:17.8792231Z                  "current_level": user.current_level,
2026-02-20T22:09:17.8792483Z -                "experience_points": user.experience_points if hasattr(user, 'experience_points') else 0,
2026-02-20T22:09:17.8792570Z +                "experience_points": (
2026-02-20T22:09:17.8792754Z +                    user.experience_points if hasattr(user, "experience_points") else 0
2026-02-20T22:09:17.8792817Z +                ),
2026-02-20T22:09:17.8792902Z                  "jedi_rank": user.jedi_rank,
2026-02-20T22:09:17.8793325Z -                "avatar_url": user.avatar_url if hasattr(user, 'avatar_url') else None,
2026-02-20T22:09:17.8793507Z +                "avatar_url": user.avatar_url if hasattr(user, "avatar_url") else None,
2026-02-20T22:09:17.8793684Z                  "created_at": user.created_at.isoformat() if user.created_at else None,
2026-02-20T22:09:17.8793859Z                  "updated_at": user.updated_at.isoformat() if user.updated_at else None,
2026-02-20T22:09:17.8794052Z              }
2026-02-20T22:09:17.8794114Z -            
2026-02-20T22:09:17.8794171Z +
2026-02-20T22:09:17.8794258Z              # Tentatives d'exercices
2026-02-20T22:09:17.8794438Z              attempts = db.query(Attempt).filter(Attempt.user_id == user_id).all()
2026-02-20T22:09:17.8794523Z              exercises_data = []
2026-02-20T22:09:17.8794600Z              for a in attempts:
2026-02-20T22:09:17.8794694Z -                exercises_data.append({
2026-02-20T22:09:17.8794787Z -                    "exercise_id": a.exercise_id,
2026-02-20T22:09:17.8794944Z -                    "answer": a.user_answer if hasattr(a, 'user_answer') else None,
2026-02-20T22:09:17.8795034Z -                    "is_correct": a.is_correct,
2026-02-20T22:09:17.8795194Z -                    "time_spent": a.time_spent if hasattr(a, 'time_spent') else None,
2026-02-20T22:09:17.8795404Z -                    "attempt_number": a.attempt_number if hasattr(a, 'attempt_number') else None,
2026-02-20T22:09:17.8795568Z -                    "hints_used": a.hints_used if hasattr(a, 'hints_used') else 0,
2026-02-20T22:09:17.8795727Z -                    "created_at": a.created_at.isoformat() if a.created_at else None,
2026-02-20T22:09:17.8795790Z -                })
2026-02-20T22:09:17.8795952Z -            
2026-02-20T22:09:17.8796044Z +                exercises_data.append(
2026-02-20T22:09:17.8796111Z +                    {
2026-02-20T22:09:17.8796207Z +                        "exercise_id": a.exercise_id,
2026-02-20T22:09:17.8796374Z +                        "answer": a.user_answer if hasattr(a, "user_answer") else None,
2026-02-20T22:09:17.8796465Z +                        "is_correct": a.is_correct,
2026-02-20T22:09:17.8796541Z +                        "time_spent": (
2026-02-20T22:09:17.8796678Z +                            a.time_spent if hasattr(a, "time_spent") else None
2026-02-20T22:09:17.8796744Z +                        ),
2026-02-20T22:09:17.8796826Z +                        "attempt_number": (
2026-02-20T22:09:17.8796984Z +                            a.attempt_number if hasattr(a, "attempt_number") else None
2026-02-20T22:09:17.8797055Z +                        ),
2026-02-20T22:09:17.8797209Z +                        "hints_used": a.hints_used if hasattr(a, "hints_used") else 0,
2026-02-20T22:09:17.8797286Z +                        "created_at": (
2026-02-20T22:09:17.8797427Z +                            a.created_at.isoformat() if a.created_at else None
2026-02-20T22:09:17.8797494Z +                        ),
2026-02-20T22:09:17.8797556Z +                    }
2026-02-20T22:09:17.8797622Z +                )
2026-02-20T22:09:17.8797679Z +
2026-02-20T22:09:17.8797820Z              # Tentatives de défis logiques
2026-02-20T22:09:17.8797982Z -            challenge_attempts = db.query(LogicChallengeAttempt).filter(
2026-02-20T22:09:17.8798102Z -                LogicChallengeAttempt.user_id == user_id
2026-02-20T22:09:17.8798168Z -            ).all()
2026-02-20T22:09:17.8798248Z +            challenge_attempts = (
2026-02-20T22:09:17.8798355Z +                db.query(LogicChallengeAttempt)
2026-02-20T22:09:17.8798489Z +                .filter(LogicChallengeAttempt.user_id == user_id)
2026-02-20T22:09:17.8798554Z +                .all()
2026-02-20T22:09:17.8798619Z +            )
2026-02-20T22:09:17.8798700Z              challenges_data = []
2026-02-20T22:09:17.8798794Z              for ca in challenge_attempts:
2026-02-20T22:09:17.8798879Z -                challenges_data.append({
2026-02-20T22:09:17.8798990Z -                    "challenge_id": ca.challenge_id,
2026-02-20T22:09:17.8799088Z -                    "user_solution": ca.user_solution,
2026-02-20T22:09:17.8799177Z -                    "is_correct": ca.is_correct,
2026-02-20T22:09:17.8799270Z -                    "time_spent": ca.time_spent,
2026-02-20T22:09:17.8799353Z -                    "hints_used": ca.hints_used,
2026-02-20T22:09:17.8799520Z -                    "created_at": ca.created_at.isoformat() if ca.created_at else None,
2026-02-20T22:09:17.8799672Z -                })
2026-02-20T22:09:17.8799733Z -            
2026-02-20T22:09:17.8799815Z +                challenges_data.append(
2026-02-20T22:09:17.8799879Z +                    {
2026-02-20T22:09:17.8799988Z +                        "challenge_id": ca.challenge_id,
2026-02-20T22:09:17.8800094Z +                        "user_solution": ca.user_solution,
2026-02-20T22:09:17.8800186Z +                        "is_correct": ca.is_correct,
2026-02-20T22:09:17.8800281Z +                        "time_spent": ca.time_spent,
2026-02-20T22:09:17.8800367Z +                        "hints_used": ca.hints_used,
2026-02-20T22:09:17.8800439Z +                        "created_at": (
2026-02-20T22:09:17.8800578Z +                            ca.created_at.isoformat() if ca.created_at else None
2026-02-20T22:09:17.8800647Z +                        ),
2026-02-20T22:09:17.8800710Z +                    }
2026-02-20T22:09:17.8800769Z +                )
2026-02-20T22:09:17.8800834Z +
2026-02-20T22:09:17.8800912Z              # Badges obtenus
2026-02-20T22:09:17.8801036Z -            achievements = db.query(UserAchievement).filter(
2026-02-20T22:09:17.8801137Z -                UserAchievement.user_id == user_id
2026-02-20T22:09:17.8801200Z -            ).all()
2026-02-20T22:09:17.8801349Z +            achievements = (
2026-02-20T22:09:17.8801434Z +                db.query(UserAchievement)
2026-02-20T22:09:17.8801553Z +                .filter(UserAchievement.user_id == user_id)
2026-02-20T22:09:17.8801617Z +                .all()
2026-02-20T22:09:17.8801676Z +            )
2026-02-20T22:09:17.8801752Z              badges_data = []
2026-02-20T22:09:17.8801833Z              for ach in achievements:
2026-02-20T22:09:17.8801910Z -                badges_data.append({
2026-02-20T22:09:17.8802148Z -                    "achievement_id": ach.achievement_id if hasattr(ach, 'achievement_id') else ach.id,
2026-02-20T22:09:17.8802419Z -                    "earned_at": ach.earned_at.isoformat() if hasattr(ach, 'earned_at') and ach.earned_at else None,
2026-02-20T22:09:17.8802637Z -                    "progress_data": ach.progress_data if hasattr(ach, 'progress_data') else None,
2026-02-20T22:09:17.8802833Z -                    "is_displayed": ach.is_displayed if hasattr(ach, 'is_displayed') else True,
2026-02-20T22:09:17.8802904Z -                })
2026-02-20T22:09:17.8803127Z -            
2026-02-20T22:09:17.8803247Z +                badges_data.append(
2026-02-20T22:09:17.8803318Z +                    {
2026-02-20T22:09:17.8803407Z +                        "achievement_id": (
2026-02-20T22:09:17.8803496Z +                            ach.achievement_id
2026-02-20T22:09:17.8803609Z +                            if hasattr(ach, "achievement_id")
2026-02-20T22:09:17.8803684Z +                            else ach.id
2026-02-20T22:09:17.8803750Z +                        ),
2026-02-20T22:09:17.8803823Z +                        "earned_at": (
2026-02-20T22:09:17.8803923Z +                            ach.earned_at.isoformat()
2026-02-20T22:09:17.8804054Z +                            if hasattr(ach, "earned_at") and ach.earned_at
2026-02-20T22:09:17.8804126Z +                            else None
2026-02-20T22:09:17.8804196Z +                        ),
2026-02-20T22:09:17.8804275Z +                        "progress_data": (
2026-02-20T22:09:17.8804452Z +                            ach.progress_data if hasattr(ach, "progress_data") else None
2026-02-20T22:09:17.8804520Z +                        ),
2026-02-20T22:09:17.8804597Z +                        "is_displayed": (
2026-02-20T22:09:17.8804749Z +                            ach.is_displayed if hasattr(ach, "is_displayed") else True
2026-02-20T22:09:17.8804812Z +                        ),
2026-02-20T22:09:17.8804882Z +                    }
2026-02-20T22:09:17.8804941Z +                )
2026-02-20T22:09:17.8804998Z +
2026-02-20T22:09:17.8805097Z              # Progression par type d'exercice
2026-02-20T22:09:17.8805307Z -            progress_records = db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:17.8805513Z +            progress_records = (
2026-02-20T22:09:17.8805665Z +                db.query(Progress).filter(Progress.user_id == user_id).all()
2026-02-20T22:09:17.8805730Z +            )
2026-02-20T22:09:17.8805804Z              progress_data = []
2026-02-20T22:09:17.8805889Z              for p in progress_records:
2026-02-20T22:09:17.8805972Z -                progress_data.append({
2026-02-20T22:09:17.8806070Z -                    "exercise_type": p.exercise_type,
2026-02-20T22:09:17.8806162Z -                    "difficulty": p.difficulty,
2026-02-20T22:09:17.8806267Z -                    "total_attempts": p.total_attempts,
2026-02-20T22:09:17.8806374Z -                    "correct_attempts": p.correct_attempts,
2026-02-20T22:09:17.8806570Z -                    "success_rate": p.success_rate if hasattr(p, 'success_rate') else None,
2026-02-20T22:09:17.8806902Z -                    "last_attempt_at": p.last_attempt_at.isoformat() if hasattr(p, 'last_attempt_at') and p.last_attempt_at else None,
2026-02-20T22:09:17.8806971Z -                })
2026-02-20T22:09:17.8807030Z -            
2026-02-20T22:09:17.8807113Z +                progress_data.append(
2026-02-20T22:09:17.8807181Z +                    {
2026-02-20T22:09:17.8807452Z +                        "exercise_type": p.exercise_type,
2026-02-20T22:09:17.8807554Z +                        "difficulty": p.difficulty,
2026-02-20T22:09:17.8807663Z +                        "total_attempts": p.total_attempts,
2026-02-20T22:09:17.8807774Z +                        "correct_attempts": p.correct_attempts,
2026-02-20T22:09:17.8807852Z +                        "success_rate": (
2026-02-20T22:09:17.8808001Z +                            p.success_rate if hasattr(p, "success_rate") else None
2026-02-20T22:09:17.8808073Z +                        ),
2026-02-20T22:09:17.8808155Z +                        "last_attempt_at": (
2026-02-20T22:09:17.8808254Z +                            p.last_attempt_at.isoformat()
2026-02-20T22:09:17.8808402Z +                            if hasattr(p, "last_attempt_at") and p.last_attempt_at
2026-02-20T22:09:17.8808473Z +                            else None
2026-02-20T22:09:17.8808535Z +                        ),
2026-02-20T22:09:17.8808603Z +                    }
2026-02-20T22:09:17.8808670Z +                )
2026-02-20T22:09:17.8808728Z +
2026-02-20T22:09:17.8808878Z              # Recommandations personnalisées
2026-02-20T22:09:17.8809149Z -            recommendations = db.query(Recommendation).filter(Recommendation.user_id == user_id).all()
2026-02-20T22:09:17.8809227Z +            recommendations = (
2026-02-20T22:09:17.8809422Z +                db.query(Recommendation).filter(Recommendation.user_id == user_id).all()
2026-02-20T22:09:17.8809489Z +            )
2026-02-20T22:09:17.8809569Z              recommendations_data = []
2026-02-20T22:09:17.8809650Z              for r in recommendations:
2026-02-20T22:09:17.8809750Z -                recommendations_data.append({
2026-02-20T22:09:17.8809951Z -                    "exercise_type": r.exercise_type if hasattr(r, 'exercise_type') else None,
2026-02-20T22:09:17.8810104Z -                    "priority": r.priority if hasattr(r, 'priority') else None,
2026-02-20T22:09:17.8810296Z -                    "is_completed": r.is_completed if hasattr(r, 'is_completed') else False,
2026-02-20T22:09:17.8810435Z -                    "reason": r.reason if hasattr(r, 'reason') else None,
2026-02-20T22:09:17.8810693Z -                    "created_at": r.created_at.isoformat() if hasattr(r, 'created_at') and r.created_at else None,
2026-02-20T22:09:17.8810753Z -                })
2026-02-20T22:09:17.8810818Z -            
2026-02-20T22:09:17.8810906Z +                recommendations_data.append(
2026-02-20T22:09:17.8810969Z +                    {
2026-02-20T22:09:17.8811055Z +                        "exercise_type": (
2026-02-20T22:09:17.8811203Z +                            r.exercise_type if hasattr(r, "exercise_type") else None
2026-02-20T22:09:17.8811351Z +                        ),
2026-02-20T22:09:17.8811508Z +                        "priority": r.priority if hasattr(r, "priority") else None,
2026-02-20T22:09:17.8811591Z +                        "is_completed": (
2026-02-20T22:09:17.8811733Z +                            r.is_completed if hasattr(r, "is_completed") else False
2026-02-20T22:09:17.8811797Z +                        ),
2026-02-20T22:09:17.8811936Z +                        "reason": r.reason if hasattr(r, "reason") else None,
2026-02-20T22:09:17.8812010Z +                        "created_at": (
2026-02-20T22:09:17.8812104Z +                            r.created_at.isoformat()
2026-02-20T22:09:17.8812226Z +                            if hasattr(r, "created_at") and r.created_at
2026-02-20T22:09:17.8812296Z +                            else None
2026-02-20T22:09:17.8812359Z +                        ),
2026-02-20T22:09:17.8812427Z +                    }
2026-02-20T22:09:17.8812488Z +                )
2026-02-20T22:09:17.8812545Z +
2026-02-20T22:09:17.8812617Z              export = {
2026-02-20T22:09:17.8812760Z                  "export_date": datetime.now(timezone.utc).isoformat(),
2026-02-20T22:09:17.8812839Z                  "format_version": "1.1",
2026-02-20T22:09:17.8812915Z                  "profile": profile,
2026-02-20T22:09:17.8813249Z                  "exercise_attempts": exercises_data,
2026-02-20T22:09:17.8813323Z @@ -1236,16 +1504,18 @@
2026-02-20T22:09:17.8813449Z                      "total_exercise_attempts": len(exercises_data),
2026-02-20T22:09:17.8813575Z                      "total_challenge_attempts": len(challenges_data),
2026-02-20T22:09:17.8813674Z                      "total_badges": len(badges_data),
2026-02-20T22:09:17.8813792Z                      "total_progress_records": len(progress_data),
2026-02-20T22:09:17.8813922Z                      "total_recommendations": len(recommendations_data),
2026-02-20T22:09:17.8813994Z -                }
2026-02-20T22:09:17.8814053Z +                },
2026-02-20T22:09:17.8814114Z              }
2026-02-20T22:09:17.8814182Z -            
2026-02-20T22:09:17.8814760Z -            logger.info(f"Export de données pour l'utilisateur {user_id} : {len(exercises_data)} exercices, {len(challenges_data)} défis, {len(badges_data)} badges")
2026-02-20T22:09:17.8814817Z +
2026-02-20T22:09:17.8814896Z +            logger.info(
2026-02-20T22:09:17.8815399Z +                f"Export de données pour l'utilisateur {user_id} : {len(exercises_data)} exercices, {len(challenges_data)} défis, {len(badges_data)} badges"
2026-02-20T22:09:17.8815460Z +            )
2026-02-20T22:09:17.8815543Z              return JSONResponse(export)
2026-02-20T22:09:17.8815606Z -            
2026-02-20T22:09:17.8815663Z +
2026-02-20T22:09:17.8815737Z      except Exception as e:
2026-02-20T22:09:17.8815935Z          logger.error(f"Erreur lors de l'export des données: {e}")
2026-02-20T22:09:17.8816015Z          traceback.print_exc()
2026-02-20T22:09:17.8816202Z          return JSONResponse({"error": get_safe_error_message(e)}, status_code=500)
2026-02-20T22:09:17.8816268Z  
2026-02-20T22:09:17.8816342Z @@ -1256,96 +1526,114 @@
2026-02-20T22:09:17.8816543Z      Handler pour récupérer les sessions actives de l'utilisateur.
2026-02-20T22:09:17.8816624Z      Route: GET /api/users/me/sessions
2026-02-20T22:09:17.8816689Z      """
2026-02-20T22:09:17.8816757Z      try:
2026-02-20T22:09:17.8816842Z          current_user = request.state.user
2026-02-20T22:09:17.8816901Z -        
2026-02-20T22:09:17.8816964Z +
2026-02-20T22:09:17.8817044Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8817103Z -        
2026-02-20T22:09:17.8817166Z +
2026-02-20T22:09:17.8817281Z          # Récupérer la session DB
2026-02-20T22:09:17.8817361Z          async with db_session() as db:
2026-02-20T22:09:17.8817484Z              from app.models.user_session import UserSession
2026-02-20T22:09:17.8817572Z              from sqlalchemy import and_
2026-02-20T22:09:17.8817632Z -            
2026-02-20T22:09:17.8817691Z +
2026-02-20T22:09:17.8817880Z              # Récupérer toutes les sessions actives non expirées
2026-02-20T22:09:17.8818107Z -            sessions = db.query(UserSession).filter(
2026-02-20T22:09:17.8818172Z -                and_(
2026-02-20T22:09:17.8818275Z -                    UserSession.user_id == user_id,
2026-02-20T22:09:17.8818385Z -                    UserSession.is_active == True,
2026-02-20T22:09:17.8818529Z -                    UserSession.expires_at > datetime.now(timezone.utc)
2026-02-20T22:09:17.8818591Z -                )
2026-02-20T22:09:17.8818724Z -            ).order_by(UserSession.last_activity.desc()).all()
2026-02-20T22:09:17.8818783Z -            
2026-02-20T22:09:17.8819094Z -            logger.debug(f"Récupération de {len(sessions)} sessions actives pour user_id={user_id}")
2026-02-20T22:09:17.8819161Z -            
2026-02-20T22:09:17.8819232Z +            sessions = (
2026-02-20T22:09:17.8819310Z +                db.query(UserSession)
2026-02-20T22:09:17.8819376Z +                .filter(
2026-02-20T22:09:17.8819448Z +                    and_(
2026-02-20T22:09:17.8819558Z +                        UserSession.user_id == user_id,
2026-02-20T22:09:17.8819656Z +                        UserSession.is_active == True,
2026-02-20T22:09:17.8819806Z +                        UserSession.expires_at > datetime.now(timezone.utc),
2026-02-20T22:09:17.8819948Z +                    )
2026-02-20T22:09:17.8820011Z +                )
2026-02-20T22:09:17.8820130Z +                .order_by(UserSession.last_activity.desc())
2026-02-20T22:09:17.8820193Z +                .all()
2026-02-20T22:09:17.8820253Z +            )
2026-02-20T22:09:17.8820311Z +
2026-02-20T22:09:17.8820388Z +            logger.debug(
2026-02-20T22:09:17.8820643Z +                f"Récupération de {len(sessions)} sessions actives pour user_id={user_id}"
2026-02-20T22:09:17.8820705Z +            )
2026-02-20T22:09:17.8820772Z +
2026-02-20T22:09:17.8821072Z              # Session la plus récente = probablement la session actuelle (requête depuis celle-ci)
2026-02-20T22:09:17.8821207Z              most_recent_id = sessions[0].id if sessions else None
2026-02-20T22:09:17.8821288Z              session_list = []
2026-02-20T22:09:17.8821368Z              for session in sessions:
2026-02-20T22:09:17.8821441Z                  session_dict = {
2026-02-20T22:09:17.8821525Z                      "id": session.id,
2026-02-20T22:09:17.8821636Z                      "device_info": session.device_info,
2026-02-20T22:09:17.8821823Z -                    "ip_address": str(session.ip_address) if session.ip_address else None,
2026-02-20T22:09:17.8821896Z +                    "ip_address": (
2026-02-20T22:09:17.8822046Z +                        str(session.ip_address) if session.ip_address else None
2026-02-20T22:09:17.8822112Z +                    ),
2026-02-20T22:09:17.8822210Z                      "user_agent": session.user_agent,
2026-02-20T22:09:17.8822321Z                      "location_data": session.location_data,
2026-02-20T22:09:17.8822412Z                      "is_active": session.is_active,
2026-02-20T22:09:17.8822548Z                      "last_activity": session.last_activity.isoformat(),
2026-02-20T22:09:17.8822666Z                      "created_at": session.created_at.isoformat(),
2026-02-20T22:09:17.8822786Z                      "expires_at": session.expires_at.isoformat(),
2026-02-20T22:09:17.8822899Z                      "is_current": session.id == most_recent_id,
2026-02-20T22:09:17.8823148Z                  }
2026-02-20T22:09:17.8823307Z                  session_list.append(session_dict)
2026-02-20T22:09:17.8823370Z -            
2026-02-20T22:09:17.8823428Z +
2026-02-20T22:09:17.8823555Z              return JSONResponse(session_list, status_code=200)
2026-02-20T22:09:17.8823619Z -    
2026-02-20T22:09:17.8823677Z +
2026-02-20T22:09:17.8823752Z      except Exception as e:
2026-02-20T22:09:17.8823990Z          logger.error(f"Erreur lors de la récupération des sessions: {e}")
2026-02-20T22:09:17.8824071Z          traceback.print_exc()
2026-02-20T22:09:17.8824407Z -        return JSONResponse({"error": "Erreur lors de la récupération des sessions"}, status_code=500)
2026-02-20T22:09:17.8824633Z +        return JSONResponse(
2026-02-20T22:09:17.8824879Z +            {"error": "Erreur lors de la récupération des sessions"}, status_code=500
2026-02-20T22:09:17.8824941Z +        )
2026-02-20T22:09:17.8824998Z  
2026-02-20T22:09:17.8825070Z  
2026-02-20T22:09:17.8825137Z  @require_auth
2026-02-20T22:09:17.8825251Z  async def revoke_user_session(request: Request):
2026-02-20T22:09:17.8825319Z      """
2026-02-20T22:09:17.8825513Z      Handler pour révoquer une session utilisateur spécifique.
2026-02-20T22:09:17.8825624Z      Route: DELETE /api/users/me/sessions/{session_id}
2026-02-20T22:09:17.8825683Z      """
2026-02-20T22:09:17.8825750Z      try:
2026-02-20T22:09:17.8825838Z          current_user = request.state.user
2026-02-20T22:09:17.8825900Z -        
2026-02-20T22:09:17.8825965Z +
2026-02-20T22:09:17.8826046Z          user_id = current_user.get("id")
2026-02-20T22:09:17.8826181Z -        session_id = int(request.path_params.get('session_id'))
2026-02-20T22:09:17.8826251Z -        
2026-02-20T22:09:17.8826384Z +        session_id = int(request.path_params.get("session_id"))
2026-02-20T22:09:17.8826442Z +
2026-02-20T22:09:17.8826557Z          # Récupérer la session DB
2026-02-20T22:09:17.8826753Z          async with db_session() as db:
2026-02-20T22:09:17.8826880Z              from app.models.user_session import UserSession
2026-02-20T22:09:17.8826941Z -            
2026-02-20T22:09:17.8827005Z +
2026-02-20T22:09:17.8827118Z              # Récupérer la session
2026-02-20T22:09:17.8827219Z -            session = db.query(UserSession).filter(
2026-02-20T22:09:17.8827312Z -                UserSession.id == session_id,
2026-02-20T22:09:17.8827408Z -                UserSession.user_id == user_id
2026-02-20T22:09:17.8827476Z -            ).first()
2026-02-20T22:09:17.8827536Z -            
2026-02-20T22:09:17.8827610Z +            session = (
2026-02-20T22:09:17.8827689Z +                db.query(UserSession)
2026-02-20T22:09:17.8827879Z +                .filter(UserSession.id == session_id, UserSession.user_id == user_id)
2026-02-20T22:09:17.8827946Z +                .first()
2026-02-20T22:09:17.8828014Z +            )
2026-02-20T22:09:17.8828072Z +
2026-02-20T22:09:17.8828146Z              if not session:
2026-02-20T22:09:17.8828643Z -                logger.warning(f"Tentative de révocation d'une session inexistante ou non autorisée: session_id={session_id}, user_id={user_id}")
2026-02-20T22:09:17.8828720Z +                logger.warning(
2026-02-20T22:09:17.8829144Z +                    f"Tentative de révocation d'une session inexistante ou non autorisée: session_id={session_id}, user_id={user_id}"
2026-02-20T22:09:17.8829210Z +                )
2026-02-20T22:09:17.8829294Z                  return JSONResponse(
2026-02-20T22:09:17.8829594Z -                    {"error": "Session non trouvée ou vous n'avez pas l'autorisation de la révoquer"},
2026-02-20T22:09:17.8829670Z -                    status_code=404
2026-02-20T22:09:17.8829745Z -                )
2026-02-20T22:09:17.8829806Z -            
2026-02-20T22:09:17.8829869Z +                    {
2026-02-20T22:09:17.8830164Z +                        "error": "Session non trouvée ou vous n'avez pas l'autorisation de la révoquer"
2026-02-20T22:09:17.8830239Z +                    },
2026-02-20T22:09:17.8830315Z +                    status_code=404,
2026-02-20T22:09:17.8830381Z +                )
2026-02-20T22:09:17.8830439Z +
2026-02-20T22:09:17.8830533Z              # Marquer la session comme inactive
2026-02-20T22:09:17.8830614Z              session.is_active = False
2026-02-20T22:09:17.8830689Z              db.commit()
2026-02-20T22:09:17.8830748Z -            
2026-02-20T22:09:17.8830805Z +
2026-02-20T22:09:17.8831046Z              logger.info(f"Session {session_id} révoquée pour user_id={user_id}")
2026-02-20T22:09:17.8831105Z -            
2026-02-20T22:09:17.8831187Z -            return JSONResponse({
2026-02-20T22:09:17.8831260Z -                "success": True,
2026-02-20T22:09:17.8831513Z -                "message": "Session révoquée avec succès"
2026-02-20T22:09:17.8831587Z -            }, status_code=200)
2026-02-20T22:09:17.8831646Z -    
2026-02-20T22:09:17.8831713Z +
2026-02-20T22:09:17.8831787Z +            return JSONResponse(
2026-02-20T22:09:17.8832002Z +                {"success": True, "message": "Session révoquée avec succès"},
2026-02-20T22:09:17.8832074Z +                status_code=200,
2026-02-20T22:09:17.8832140Z +            )
2026-02-20T22:09:17.8832198Z +
2026-02-20T22:09:17.8832273Z      except ValueError:
2026-02-20T22:09:17.8832463Z          return JSONResponse({"error": "ID de session invalide"}, status_code=400)
2026-02-20T22:09:17.8832540Z      except Exception as e:
2026-02-20T22:09:17.8832757Z          logger.error(f"Erreur lors de la révocation de la session: {e}")
2026-02-20T22:09:17.8832845Z          traceback.print_exc()
2026-02-20T22:09:17.8833391Z -        return JSONResponse({"error": "Erreur lors de la révocation de la session"}, status_code=500)
2026-02-20T22:09:17.8833486Z \ No newline at end of file
2026-02-20T22:09:17.8833564Z +        return JSONResponse(
2026-02-20T22:09:17.8833813Z +            {"error": "Erreur lors de la révocation de la session"}, status_code=500
2026-02-20T22:09:17.8833874Z +        )
2026-02-20T22:09:17.8834043Z 
2026-02-20T22:09:17.8834163Z Oh no! 💥 💔 💥
2026-02-20T22:09:17.8834330Z 81 files would be reformatted, 6 files would be left unchanged.
2026-02-20T22:09:17.8942788Z ##[error]Process completed with exit code 1.
2026-02-20T22:09:17.8987102Z ##[group]Run isort app/ server/ --check-only --diff
2026-02-20T22:09:17.8987275Z [36;1misort app/ server/ --check-only --diff[0m
2026-02-20T22:09:17.9019593Z shell: /usr/bin/bash -e {0}
2026-02-20T22:09:17.9019670Z env:
2026-02-20T22:09:17.9019832Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:17.9020017Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib/pkgconfig
2026-02-20T22:09:17.9020161Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:17.9020325Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:17.9020455Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.12/x64
2026-02-20T22:09:17.9020606Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.12/x64/lib
2026-02-20T22:09:17.9020675Z ##[endgroup]
2026-02-20T22:09:18.0154932Z ERROR: /home/runner/work/mathakine/mathakine/app/models/recommendation.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0172318Z ERROR: /home/runner/work/mathakine/mathakine/app/models/attempt.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0232895Z ERROR: /home/runner/work/mathakine/mathakine/app/models/all_models.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0278825Z ERROR: /home/runner/work/mathakine/mathakine/app/models/user.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0389625Z ERROR: /home/runner/work/mathakine/mathakine/app/utils/csrf.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0515734Z ERROR: /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0535724Z ERROR: /home/runner/work/mathakine/mathakine/app/utils/email_templates.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0684778Z ERROR: /home/runner/work/mathakine/mathakine/app/services/challenge_service.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0781879Z ERROR: /home/runner/work/mathakine/mathakine/app/services/email_service.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.0870590Z ERROR: /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.1017216Z ERROR: /home/runner/work/mathakine/mathakine/app/services/badge_service.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.1237807Z ERROR: /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.1612710Z ERROR: /home/runner/work/mathakine/mathakine/app/core/monitoring.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.1630639Z --- /home/runner/work/mathakine/mathakine/app/models/recommendation.py:before	2026-02-20 22:09:02.809965
2026-02-20T22:09:18.1632154Z +++ /home/runner/work/mathakine/mathakine/app/models/recommendation.py:after	2026-02-20 22:09:18.016020
2026-02-20T22:09:18.1632766Z @@ -1,5 +1,5 @@
2026-02-20T22:09:18.1633313Z -from sqlalchemy import (Boolean, Column, DateTime, ForeignKey, Index, Integer, String,
2026-02-20T22:09:18.1633847Z -                        Text)
2026-02-20T22:09:18.1634282Z +from sqlalchemy import (Boolean, Column, DateTime, ForeignKey, Index, Integer,
2026-02-20T22:09:18.1634768Z +                        String, Text)
2026-02-20T22:09:18.1635087Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:18.1635430Z  from sqlalchemy.sql import func
2026-02-20T22:09:18.1635704Z  
2026-02-20T22:09:18.1636155Z --- /home/runner/work/mathakine/mathakine/app/models/attempt.py:before	2026-02-20 22:09:02.809965
2026-02-20T22:09:18.1636954Z +++ /home/runner/work/mathakine/mathakine/app/models/attempt.py:after	2026-02-20 22:09:18.017728
2026-02-20T22:09:18.1637539Z @@ -1,5 +1,5 @@
2026-02-20T22:09:18.1637950Z -from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Index, Integer,
2026-02-20T22:09:18.1638760Z -                        String)
2026-02-20T22:09:18.1639190Z +from sqlalchemy import (Boolean, Column, DateTime, Float, ForeignKey, Index,
2026-02-20T22:09:18.1639677Z +                        Integer, String)
2026-02-20T22:09:18.1639996Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:18.1640325Z  from sqlalchemy.sql import func
2026-02-20T22:09:18.1640594Z  
2026-02-20T22:09:18.1641042Z --- /home/runner/work/mathakine/mathakine/app/models/all_models.py:before	2026-02-20 22:09:02.809965
2026-02-20T22:09:18.1641871Z +++ /home/runner/work/mathakine/mathakine/app/models/all_models.py:after	2026-02-20 22:09:18.023915
2026-02-20T22:09:18.1642424Z @@ -3,8 +3,8 @@
2026-02-20T22:09:18.1643106Z  À importer pour réaliser les opérations de base de données.
2026-02-20T22:09:18.1643502Z  """
2026-02-20T22:09:18.1643685Z  
2026-02-20T22:09:18.1643999Z +from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:18.1644498Z  from app.models.admin_audit_log import AdminAuditLog
2026-02-20T22:09:18.1645005Z -from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:18.1645457Z  from app.models.attempt import Attempt
2026-02-20T22:09:18.1645924Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:18.1646498Z  from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:18.1647162Z --- /home/runner/work/mathakine/mathakine/app/models/user.py:before	2026-02-20 22:09:02.809965
2026-02-20T22:09:18.1647935Z +++ /home/runner/work/mathakine/mathakine/app/models/user.py:after	2026-02-20 22:09:18.028857
2026-02-20T22:09:18.1648473Z @@ -5,7 +5,8 @@
2026-02-20T22:09:18.1648720Z  from datetime import datetime, timezone
2026-02-20T22:09:18.1649048Z  from enum import Enum as PyEnum
2026-02-20T22:09:18.1649323Z  
2026-02-20T22:09:18.1649738Z -from sqlalchemy import Boolean, Column, Date, DateTime, Enum, Index, Integer, String, Text
2026-02-20T22:09:18.1650445Z +from sqlalchemy import (Boolean, Column, Date, DateTime, Enum, Index, Integer,
2026-02-20T22:09:18.1650930Z +                        String, Text)
2026-02-20T22:09:18.1651286Z  from sqlalchemy.dialects.postgresql import JSONB
2026-02-20T22:09:18.1651679Z  from sqlalchemy.orm import relationship
2026-02-20T22:09:18.1652010Z  from sqlalchemy.sql import func
2026-02-20T22:09:18.1652528Z --- /home/runner/work/mathakine/mathakine/app/utils/csrf.py:before	2026-02-20 22:09:02.811965
2026-02-20T22:09:18.1653517Z +++ /home/runner/work/mathakine/mathakine/app/utils/csrf.py:after	2026-02-20 22:09:18.039440
2026-02-20T22:09:18.1654078Z @@ -8,9 +8,10 @@
2026-02-20T22:09:18.1654243Z  import os
2026-02-20T22:09:18.1654400Z  import secrets
2026-02-20T22:09:18.1654552Z  
2026-02-20T22:09:18.1654736Z -from app.core.logging_config import get_logger
2026-02-20T22:09:18.1655023Z  from starlette.requests import Request
2026-02-20T22:09:18.1655304Z  from starlette.responses import JSONResponse
2026-02-20T22:09:18.1655554Z +
2026-02-20T22:09:18.1655736Z +from app.core.logging_config import get_logger
2026-02-20T22:09:18.1655988Z  
2026-02-20T22:09:18.1656138Z  logger = get_logger(__name__)
2026-02-20T22:09:18.1656334Z  
2026-02-20T22:09:18.1656663Z --- /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py:before	2026-02-20 22:09:02.812965
2026-02-20T22:09:18.1657266Z +++ /home/runner/work/mathakine/mathakine/app/utils/sse_utils.py:after	2026-02-20 22:09:18.051889
2026-02-20T22:09:18.1657669Z @@ -5,7 +5,6 @@
2026-02-20T22:09:18.1657845Z  from typing import AsyncGenerator
2026-02-20T22:09:18.1658066Z  
2026-02-20T22:09:18.1658257Z  from starlette.responses import StreamingResponse
2026-02-20T22:09:18.1658520Z -
2026-02-20T22:09:18.1658655Z  
2026-02-20T22:09:18.1658795Z  SSE_HEADERS = {
2026-02-20T22:09:18.1658970Z      "Cache-Control": "no-cache",
2026-02-20T22:09:18.1659404Z --- /home/runner/work/mathakine/mathakine/app/utils/email_templates.py:before	2026-02-20 22:09:02.811965
2026-02-20T22:09:18.1660046Z +++ /home/runner/work/mathakine/mathakine/app/utils/email_templates.py:after	2026-02-20 22:09:18.054646
2026-02-20T22:09:18.1660608Z @@ -3,7 +3,6 @@
2026-02-20T22:09:18.1660973Z  Design unifié, ergonomique et accessible pour tous les clients email.
2026-02-20T22:09:18.1661290Z  """
2026-02-20T22:09:18.1661457Z  from typing import Optional
2026-02-20T22:09:18.1661649Z -
2026-02-20T22:09:18.1661788Z  
2026-02-20T22:09:18.1662041Z  # Couleurs du thème Jedi/Space (compatible clients email)
2026-02-20T22:09:18.1662324Z  THEME = {
2026-02-20T22:09:18.1662711Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_service.py:before	2026-02-20 22:09:02.810965
2026-02-20T22:09:18.1663530Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_service.py:after	2026-02-20 22:09:18.070643
2026-02-20T22:09:18.1663979Z @@ -12,13 +12,12 @@
2026-02-20T22:09:18.1664187Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.1664435Z  
2026-02-20T22:09:18.1664583Z  logger = get_logger(__name__)
2026-02-20T22:09:18.1664818Z -from sqlalchemy import and_, or_, func, case
2026-02-20T22:09:18.1665091Z +from sqlalchemy import and_, case, func, or_
2026-02-20T22:09:18.1665351Z  from sqlalchemy.orm import Session
2026-02-20T22:09:18.1665559Z  
2026-02-20T22:09:18.1665798Z  from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:18.1666158Z                                          LogicChallengeAttempt,
2026-02-20T22:09:18.1666449Z                                          LogicChallengeType)
2026-02-20T22:09:18.1666693Z -
2026-02-20T22:09:18.1666822Z  
2026-02-20T22:09:18.1667005Z  # ============================================================================
2026-02-20T22:09:18.1667367Z  # MAPPING DES GROUPES D'ÂGE (après migration ENUM)
2026-02-20T22:09:18.1667853Z --- /home/runner/work/mathakine/mathakine/app/services/email_service.py:before	2026-02-20 22:09:02.811965
2026-02-20T22:09:18.1668502Z +++ /home/runner/work/mathakine/mathakine/app/services/email_service.py:after	2026-02-20 22:09:18.080400
2026-02-20T22:09:18.1668928Z @@ -13,24 +13,16 @@
2026-02-20T22:09:18.1669114Z  logger = get_logger(__name__)
2026-02-20T22:09:18.1669303Z  
2026-02-20T22:09:18.1669471Z  from app.core.config import settings
2026-02-20T22:09:18.1669722Z -from app.utils.email_templates import (
2026-02-20T22:09:18.1669978Z -    password_reset_email_html,
2026-02-20T22:09:18.1670192Z -    password_reset_email_text,
2026-02-20T22:09:18.1670407Z -    verification_email_html,
2026-02-20T22:09:18.1670624Z -    verification_email_text,
2026-02-20T22:09:18.1670811Z -)
2026-02-20T22:09:18.1671055Z +from app.utils.email_templates import (password_reset_email_html,
2026-02-20T22:09:18.1671535Z +                                       password_reset_email_text,
2026-02-20T22:09:18.1671827Z +                                       verification_email_html,
2026-02-20T22:09:18.1672111Z +                                       verification_email_text)
2026-02-20T22:09:18.1672357Z  
2026-02-20T22:09:18.1672546Z  # Optionnel : Support SendGrid si API key disponible
2026-02-20T22:09:18.1672808Z  try:
2026-02-20T22:09:18.1673064Z      import sendgrid
2026-02-20T22:09:18.1673275Z -    from sendgrid.helpers.mail import (
2026-02-20T22:09:18.1673522Z -        Content,
2026-02-20T22:09:18.1673681Z -        Email,
2026-02-20T22:09:18.1673839Z -        Mail,
2026-02-20T22:09:18.1673987Z -        To,
2026-02-20T22:09:18.1674154Z -        TrackingSettings,
2026-02-20T22:09:18.1674348Z -        ClickTracking,
2026-02-20T22:09:18.1674525Z -    )
2026-02-20T22:09:18.1674804Z +    from sendgrid.helpers.mail import (ClickTracking, Content, Email, Mail, To,
2026-02-20T22:09:18.1675199Z +                                       TrackingSettings)
2026-02-20T22:09:18.1675460Z      SENDGRID_AVAILABLE = True
2026-02-20T22:09:18.1675667Z  except ImportError:
2026-02-20T22:09:18.1675861Z      SENDGRID_AVAILABLE = False
2026-02-20T22:09:18.1676323Z --- /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py:before	2026-02-20 22:09:02.811965
2026-02-20T22:09:18.1677192Z +++ /home/runner/work/mathakine/mathakine/app/services/recommendation_service.py:after	2026-02-20 22:09:18.089415
2026-02-20T22:09:18.1677679Z @@ -1,11 +1,10 @@
2026-02-20T22:09:18.1677850Z  import random
2026-02-20T22:09:18.1678002Z -
2026-02-20T22:09:18.1678195Z -from app.core.logging_config import get_logger
2026-02-20T22:09:18.1678507Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:18.1678761Z  
2026-02-20T22:09:18.1678933Z  from sqlalchemy import and_, exists, or_
2026-02-20T22:09:18.1679186Z  from sqlalchemy.sql import func
2026-02-20T22:09:18.1679396Z  
2026-02-20T22:09:18.1679571Z +from app.core.logging_config import get_logger
2026-02-20T22:09:18.1679851Z  from app.models.attempt import Attempt
2026-02-20T22:09:18.1680194Z  from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:18.1680662Z  from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:18.1681239Z --- /home/runner/work/mathakine/mathakine/app/services/badge_service.py:before	2026-02-20 22:09:02.810965
2026-02-20T22:09:18.1681893Z +++ /home/runner/work/mathakine/mathakine/app/services/badge_service.py:after	2026-02-20 22:09:18.106336
2026-02-20T22:09:18.1682331Z @@ -17,7 +17,8 @@
2026-02-20T22:09:18.1682518Z  from app.models.attempt import Attempt
2026-02-20T22:09:18.1682781Z  from app.models.progress import Progress
2026-02-20T22:09:18.1683148Z  from app.models.user import User
2026-02-20T22:09:18.1683565Z -from app.services.badge_requirement_engine import check_requirements, get_requirement_progress
2026-02-20T22:09:18.1684108Z +from app.services.badge_requirement_engine import (check_requirements,
2026-02-20T22:09:18.1684483Z +                                                   get_requirement_progress)
2026-02-20T22:09:18.1684755Z  
2026-02-20T22:09:18.1684907Z  logger = get_logger(__name__)
2026-02-20T22:09:18.1685106Z  
2026-02-20T22:09:18.1685484Z --- /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py:before	2026-02-20 22:09:02.810965
2026-02-20T22:09:18.1686194Z +++ /home/runner/work/mathakine/mathakine/app/services/challenge_ai_service.py:after	2026-02-20 22:09:18.131211
2026-02-20T22:09:18.1686647Z @@ -8,23 +8,17 @@
2026-02-20T22:09:18.1686867Z  from typing import Any, AsyncGenerator, Dict, Optional
2026-02-20T22:09:18.1687135Z  
2026-02-20T22:09:18.1687391Z  from openai import APIError, APITimeoutError, AsyncOpenAI, RateLimitError
2026-02-20T22:09:18.1687742Z -from tenacity import (
2026-02-20T22:09:18.1687918Z -    retry,
2026-02-20T22:09:18.1688084Z -    retry_if_exception_type,
2026-02-20T22:09:18.1688416Z -    stop_after_attempt,
2026-02-20T22:09:18.1688613Z -    wait_exponential,
2026-02-20T22:09:18.1688780Z -)
2026-02-20T22:09:18.1689043Z +from tenacity import (retry, retry_if_exception_type, stop_after_attempt,
2026-02-20T22:09:18.1689391Z +                      wait_exponential)
2026-02-20T22:09:18.1689602Z  
2026-02-20T22:09:18.1689768Z  from app.core.ai_config import AIConfig
2026-02-20T22:09:18.1690014Z  from app.core.config import settings
2026-02-20T22:09:18.1690340Z  from app.core.constants import calculate_difficulty_for_age_group
2026-02-20T22:09:18.1690688Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.1690971Z  from app.services import challenge_service
2026-02-20T22:09:18.1691251Z -from app.services.challenge_validator import (
2026-02-20T22:09:18.1691520Z -    auto_correct_challenge,
2026-02-20T22:09:18.1691734Z -    validate_challenge_logic,
2026-02-20T22:09:18.1691926Z -)
2026-02-20T22:09:18.1692197Z  from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:18.1692652Z +from app.services.challenge_validator import (auto_correct_challenge,
2026-02-20T22:09:18.1693216Z +                                              validate_challenge_logic)
2026-02-20T22:09:18.1693527Z  from app.utils.db_utils import db_session
2026-02-20T22:09:18.1693838Z  from app.utils.generation_metrics import generation_metrics
2026-02-20T22:09:18.1694196Z  from app.utils.json_utils import extract_json_from_text
2026-02-20T22:09:18.1694785Z --- /home/runner/work/mathakine/mathakine/app/core/monitoring.py:before	2026-02-20 22:09:02.808965
2026-02-20T22:09:18.1914254Z ERROR: /home/runner/work/mathakine/mathakine/server/exercise_generator.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2138828Z ERROR: /home/runner/work/mathakine/mathakine/server/database.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2243422Z ERROR: /home/runner/work/mathakine/mathakine/server/app.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2335227Z ERROR: /home/runner/work/mathakine/mathakine/server/routes.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2373386Z +++ /home/runner/work/mathakine/mathakine/app/core/monitoring.py:after	2026-02-20 22:09:18.162676
2026-02-20T22:09:18.2374433Z @@ -17,13 +17,8 @@
2026-02-20T22:09:18.2375313Z  # Prometheus (optionnel, évite import si désactivé)
2026-02-20T22:09:18.2375868Z  _prometheus_available = False
2026-02-20T22:09:18.2376231Z  try:
2026-02-20T22:09:18.2376558Z -    from prometheus_client import (
2026-02-20T22:09:18.2376978Z -        CONTENT_TYPE_LATEST,
2026-02-20T22:09:18.2377343Z -        Counter,
2026-02-20T22:09:18.2377652Z -        Histogram,
2026-02-20T22:09:18.2377931Z -        REGISTRY,
2026-02-20T22:09:18.2378205Z -        generate_latest,
2026-02-20T22:09:18.2378494Z -    )
2026-02-20T22:09:18.2378984Z +    from prometheus_client import (CONTENT_TYPE_LATEST, REGISTRY, Counter,
2026-02-20T22:09:18.2379657Z +                                   Histogram, generate_latest)
2026-02-20T22:09:18.2380175Z      _prometheus_available = True
2026-02-20T22:09:18.2380575Z  except ImportError:
2026-02-20T22:09:18.2380902Z      pass
2026-02-20T22:09:18.2381593Z --- /home/runner/work/mathakine/mathakine/server/exercise_generator.py:before	2026-02-20 22:09:02.837965
2026-02-20T22:09:18.2382817Z +++ /home/runner/work/mathakine/mathakine/server/exercise_generator.py:after	2026-02-20 22:09:18.204943
2026-02-20T22:09:18.2383826Z @@ -6,8 +6,10 @@
2026-02-20T22:09:18.2384140Z  import random
2026-02-20T22:09:18.2384493Z  from typing import Any, Dict, List, Optional
2026-02-20T22:09:18.2385070Z  
2026-02-20T22:09:18.2385758Z +from app.core.constants import (DIFFICULTY_LIMITS, AgeGroups, DifficultyLevels,
2026-02-20T22:09:18.2386604Z +                                ExerciseTypes, Messages, Tags,
2026-02-20T22:09:18.2387462Z +                                normalize_age_group)
2026-02-20T22:09:18.2388094Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.2389659Z -from app.core.constants import (DIFFICULTY_LIMITS, DifficultyLevels, ExerciseTypes, Messages, Tags, AgeGroups, normalize_age_group)
2026-02-20T22:09:18.2390898Z  
2026-02-20T22:09:18.2391330Z  logger = get_logger(__name__)
2026-02-20T22:09:18.2391989Z  from app.core.messages import ExerciseMessages, StarWarsNarratives
2026-02-20T22:09:18.2392795Z @@ -74,7 +76,7 @@
2026-02-20T22:09:18.2393958Z      Normalise et valide les paramètres d'exercice (type et groupe d'âge).
2026-02-20T22:09:18.2395131Z      Retourne le type, le groupe d'âge, et la difficulté dérivée.
2026-02-20T22:09:18.2395916Z      """
2026-02-20T22:09:18.2396416Z -    from app.core.constants import ExerciseTypes, AgeGroups
2026-02-20T22:09:18.2397223Z +    from app.core.constants import AgeGroups, ExerciseTypes
2026-02-20T22:09:18.2397875Z  
2026-02-20T22:09:18.2398402Z      # Normaliser les paramètres
2026-02-20T22:09:18.2399101Z      exercise_type = normalize_exercise_type(exercise_type_raw)
2026-02-20T22:09:18.2400151Z --- /home/runner/work/mathakine/mathakine/server/database.py:before	2026-02-20 22:09:02.836965
2026-02-20T22:09:18.2401395Z +++ /home/runner/work/mathakine/mathakine/server/database.py:after	2026-02-20 22:09:18.214976
2026-02-20T22:09:18.2402197Z @@ -10,6 +10,7 @@
2026-02-20T22:09:18.2402658Z  
2026-02-20T22:09:18.2403212Z  import psycopg2
2026-02-20T22:09:18.2403759Z  from dotenv import load_dotenv
2026-02-20T22:09:18.2404337Z +
2026-02-20T22:09:18.2404799Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.2405641Z  
2026-02-20T22:09:18.2406010Z  logger = get_logger(__name__)
2026-02-20T22:09:18.2406946Z --- /home/runner/work/mathakine/mathakine/server/app.py:before	2026-02-20 22:09:02.836965
2026-02-20T22:09:18.2408105Z +++ /home/runner/work/mathakine/mathakine/server/app.py:after	2026-02-20 22:09:18.225060
2026-02-20T22:09:18.2408910Z @@ -7,6 +7,7 @@
2026-02-20T22:09:18.2409509Z  import os
2026-02-20T22:09:18.2409853Z  
2026-02-20T22:09:18.2410200Z  import uvicorn
2026-02-20T22:09:18.2410655Z +
2026-02-20T22:09:18.2411148Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.2411848Z  from app.core.monitoring import init_monitoring
2026-02-20T22:09:18.2412597Z  
2026-02-20T22:09:18.2413559Z --- /home/runner/work/mathakine/mathakine/server/routes.py:before	2026-02-20 22:09:02.838965
2026-02-20T22:09:18.2414855Z +++ /home/runner/work/mathakine/mathakine/server/routes.py:after	2026-02-20 22:09:18.236785
2026-02-20T22:09:18.2415924Z @@ -10,63 +10,54 @@
2026-02-20T22:09:18.2416500Z  from starlette.routing import Mount, Route
2026-02-20T22:09:18.2417171Z  
2026-02-20T22:09:18.2417698Z  # Imports API handlers - Admin
2026-02-20T22:09:18.2418461Z -from server.handlers.admin_handlers import (
2026-02-20T22:09:18.2419158Z -    admin_badge_get,
2026-02-20T22:09:18.2419846Z -    admin_badges,
2026-02-20T22:09:18.2420408Z -    admin_badges_delete,
2026-02-20T22:09:18.2420988Z -    admin_badges_post,
2026-02-20T22:09:18.2421571Z -    admin_badges_put,
2026-02-20T22:09:18.2422076Z -    admin_challenge_get,
2026-02-20T22:09:18.2422597Z -    admin_challenges,
2026-02-20T22:09:18.2423252Z -    admin_challenges_duplicate,
2026-02-20T22:09:18.2424021Z -    admin_challenges_patch,
2026-02-20T22:09:18.2424526Z -    admin_challenges_post,
2026-02-20T22:09:18.2425049Z -    admin_challenges_put,
2026-02-20T22:09:18.2425673Z -    admin_exercise_get,
2026-02-20T22:09:18.2426220Z -    admin_exercises,
2026-02-20T22:09:18.2426730Z -    admin_exercises_duplicate,
2026-02-20T22:09:18.2427436Z -    admin_exercises_patch,
2026-02-20T22:09:18.2428005Z -    admin_exercises_post,
2026-02-20T22:09:18.2428489Z -    admin_exercises_put,
2026-02-20T22:09:18.2429158Z -    admin_audit_log,
2026-02-20T22:09:18.2429626Z -    admin_config_get,
2026-02-20T22:09:18.2430135Z -    admin_config_put,
2026-02-20T22:09:18.2430652Z -    admin_export,
2026-02-20T22:09:18.2431195Z -    admin_health,
2026-02-20T22:09:18.2431672Z -    admin_moderation,
2026-02-20T22:09:18.2432242Z -    admin_overview,
2026-02-20T22:09:18.2433259Z -    admin_reports,
2026-02-20T22:09:18.2433718Z -    admin_users,
2026-02-20T22:09:18.2434397Z -    admin_users_patch,
2026-02-20T22:09:18.2434950Z -    admin_users_resend_verification,
2026-02-20T22:09:18.2435600Z -    admin_users_send_reset_password,
2026-02-20T22:09:18.2436099Z -)
2026-02-20T22:09:18.2436966Z +from server.handlers.admin_handlers import (admin_audit_log, admin_badge_get,
2026-02-20T22:09:18.2437968Z +                                            admin_badges, admin_badges_delete,
2026-02-20T22:09:18.2438720Z +                                            admin_badges_post,
2026-02-20T22:09:18.2439554Z +                                            admin_badges_put,
2026-02-20T22:09:18.2440188Z +                                            admin_challenge_get,
2026-02-20T22:09:18.2440836Z +                                            admin_challenges,
2026-02-20T22:09:18.2441615Z +                                            admin_challenges_duplicate,
2026-02-20T22:09:18.2442326Z +                                            admin_challenges_patch,
2026-02-20T22:09:18.2443281Z +                                            admin_challenges_post,
2026-02-20T22:09:18.2444070Z +                                            admin_challenges_put,
2026-02-20T22:09:18.2444802Z +                                            admin_config_get, admin_config_put,
2026-02-20T22:09:18.2445484Z +                                            admin_exercise_get,
2026-02-20T22:09:18.2446490Z +                                            admin_exercises,
2026-02-20T22:09:18.2447270Z +                                            admin_exercises_duplicate,
2026-02-20T22:09:18.2448045Z +                                            admin_exercises_patch,
2026-02-20T22:09:18.2448892Z +                                            admin_exercises_post,
2026-02-20T22:09:18.2449572Z +                                            admin_exercises_put, admin_export,
2026-02-20T22:09:18.2450350Z +                                            admin_health, admin_moderation,
2026-02-20T22:09:18.2451207Z +                                            admin_overview, admin_reports,
2026-02-20T22:09:18.2451902Z +                                            admin_users, admin_users_patch,
2026-02-20T22:09:18.2452793Z +                                            admin_users_resend_verification,
2026-02-20T22:09:18.2453785Z +                                            admin_users_send_reset_password)
2026-02-20T22:09:18.2454581Z  # Imports API handlers - Auth
2026-02-20T22:09:18.2455361Z -from server.handlers.auth_handlers import (api_get_current_user, api_login,
2026-02-20T22:09:18.2456426Z -                                           api_refresh_token, api_validate_token,
2026-02-20T22:09:18.2457376Z +from server.handlers.auth_handlers import (api_forgot_password,
2026-02-20T22:09:18.2458276Z                                             api_get_csrf_token,
2026-02-20T22:09:18.2459148Z -                                           api_logout, api_forgot_password,
2026-02-20T22:09:18.2459920Z +                                           api_get_current_user, api_login,
2026-02-20T22:09:18.2460669Z +                                           api_logout, api_refresh_token,
2026-02-20T22:09:18.2461476Z                                             api_reset_password,
2026-02-20T22:09:18.2462148Z +                                           api_validate_token,
2026-02-20T22:09:18.2462934Z                                             resend_verification_email,
2026-02-20T22:09:18.2463800Z                                             verify_email)
2026-02-20T22:09:18.2464696Z  # Imports API handlers - Badges
2026-02-20T22:09:18.2465369Z  from server.handlers.badge_handlers import (check_user_badges,
2026-02-20T22:09:18.2466173Z                                              get_available_badges,
2026-02-20T22:09:18.2467005Z -                                            get_badges_rarity,
2026-02-20T22:09:18.2467664Z -                                            get_user_badges,
2026-02-20T22:09:18.2468263Z +                                            get_badges_rarity, get_user_badges,
2026-02-20T22:09:18.2468754Z +                                            get_user_badges_progress,
2026-02-20T22:09:18.2469168Z                                              get_user_gamification_stats,
2026-02-20T22:09:18.2469559Z -                                            get_user_badges_progress,
2026-02-20T22:09:18.2470030Z                                              patch_pinned_badges)
2026-02-20T22:09:18.2470420Z  # Imports API handlers - Challenges
2026-02-20T22:09:18.2470851Z  from server.handlers.challenge_handlers import (generate_ai_challenge_stream,
2026-02-20T22:09:18.2471407Z                                                  get_challenge,
2026-02-20T22:09:18.2471801Z                                                  get_challenge_hint,
2026-02-20T22:09:18.2472169Z +                                                get_challenge_progress,
2026-02-20T22:09:18.2472652Z +                                                get_challenge_rewards,
2026-02-20T22:09:18.2473309Z                                                  get_challenges_list,
2026-02-20T22:09:18.2473749Z                                                  get_completed_challenges_ids,
2026-02-20T22:09:18.2474187Z -                                                submit_challenge_answer,
2026-02-20T22:09:18.2474622Z                                                  start_challenge,
2026-02-20T22:09:18.2475153Z -                                                get_challenge_progress,
2026-02-20T22:09:18.2475616Z -                                                get_challenge_rewards)
2026-02-20T22:09:18.2476038Z +                                                submit_challenge_answer)
2026-02-20T22:09:18.2476386Z  # Imports API handlers - Chat
2026-02-20T22:09:18.2476837Z  from server.handlers.chat_handlers import chat_api, chat_api_stream
2026-02-20T22:09:18.2477296Z  # Imports API handlers - Exercises
2026-02-20T22:09:18.2477577Z @@ -74,27 +65,25 @@
2026-02-20T22:09:18.2477958Z                                                 generate_exercise,
2026-02-20T22:09:18.2478341Z                                                 generate_exercise_api,
2026-02-20T22:09:18.2478757Z                                                 get_completed_exercises_ids,
2026-02-20T22:09:18.2479135Z -                                               get_exercise, submit_answer,
2026-02-20T22:09:18.2479612Z +                                               get_exercise,
2026-02-20T22:09:18.2480005Z                                                 get_exercises_list,
2026-02-20T22:09:18.2480383Z -                                               get_exercises_stats)
2026-02-20T22:09:18.2480833Z +                                               get_exercises_stats,
2026-02-20T22:09:18.2481173Z +                                               submit_answer)
2026-02-20T22:09:18.2481532Z  # Imports API handlers - Recommendations
2026-02-20T22:09:18.2527968Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2734007Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.2819895Z -from server.handlers.recommendation_handlers import (generate_recommendations,
2026-02-20T22:09:18.2820960Z -                                                     get_recommendations,
2026-02-20T22:09:18.2821717Z -                                                     handle_recommendation_complete)
2026-02-20T22:09:18.2822338Z +from server.handlers.recommendation_handlers import (
2026-02-20T22:09:18.2822846Z +    generate_recommendations, get_recommendations,
2026-02-20T22:09:18.2823713Z +    handle_recommendation_complete)
2026-02-20T22:09:18.2824133Z  # Imports API handlers - Users
2026-02-20T22:09:18.2824674Z -from server.handlers.user_handlers import (create_user_account, get_all_users,
2026-02-20T22:09:18.2825292Z -                                           get_user_stats,
2026-02-20T22:09:18.2826074Z +from server.handlers.user_handlers import (create_user_account, delete_user,
2026-02-20T22:09:18.2826676Z +                                           delete_user_me, export_user_data,
2026-02-20T22:09:18.2827118Z +                                           get_all_user_progress,
2026-02-20T22:09:18.2827463Z +                                           get_all_users,
2026-02-20T22:09:18.2827817Z +                                           get_challenges_progress,
2026-02-20T22:09:18.2828203Z +                                           get_user_progress_by_exercise_type,
2026-02-20T22:09:18.2828647Z +                                           get_user_sessions, get_user_stats,
2026-02-20T22:09:18.2829030Z                                             get_users_leaderboard,
2026-02-20T22:09:18.2829389Z -                                           get_all_user_progress,
2026-02-20T22:09:18.2829761Z -                                           get_user_progress_by_exercise_type,
2026-02-20T22:09:18.2830162Z -                                           get_challenges_progress,
2026-02-20T22:09:18.2830522Z -                                           update_user_me,
2026-02-20T22:09:18.2830866Z -                                           update_user_password_me,
2026-02-20T22:09:18.2831216Z -                                           delete_user,
2026-02-20T22:09:18.2831539Z -                                           delete_user_me,
2026-02-20T22:09:18.2831993Z -                                           export_user_data,
2026-02-20T22:09:18.2832337Z -                                           get_user_sessions,
2026-02-20T22:09:18.2832688Z -                                           revoke_user_session)
2026-02-20T22:09:18.2833192Z +                                           revoke_user_session, update_user_me,
2026-02-20T22:09:18.2833579Z +                                           update_user_password_me)
2026-02-20T22:09:18.2833905Z  
2026-02-20T22:09:18.2834080Z  
2026-02-20T22:09:18.2834281Z  async def health_handler(request):
2026-02-20T22:09:18.2834843Z --- /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py:before	2026-02-20 22:09:02.837965
2026-02-20T22:09:18.2835584Z +++ /home/runner/work/mathakine/mathakine/server/handlers/challenge_handlers.py:after	2026-02-20 22:09:18.261889
2026-02-20T22:09:18.2836068Z @@ -11,19 +11,21 @@
2026-02-20T22:09:18.2836266Z  from starlette.requests import Request
2026-02-20T22:09:18.2836611Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:18.2836919Z  
2026-02-20T22:09:18.2837171Z -from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:18.2837533Z +import app.core.constants as constants
2026-02-20T22:09:18.2837799Z  from app.core.config import settings
2026-02-20T22:09:18.2838262Z  # Importer les constantes et fonctions centralisées
2026-02-20T22:09:18.2838848Z -from app.core.constants import (CHALLENGE_TYPES_API, CHALLENGE_TYPES_DB, normalize_age_group, calculate_difficulty_for_age_group)
2026-02-20T22:09:18.2839416Z -import app.core.constants as constants
2026-02-20T22:09:18.2839772Z +from app.core.constants import (CHALLENGE_TYPES_API, CHALLENGE_TYPES_DB,
2026-02-20T22:09:18.2840164Z +                                calculate_difficulty_for_age_group,
2026-02-20T22:09:18.2840458Z +                                normalize_age_group)
2026-02-20T22:09:18.2840744Z  from app.core.messages import SystemMessages
2026-02-20T22:09:18.2841310Z  # NOTE: challenge_service_translations_adapter archivé - utiliser fonctions de challenge_service.py
2026-02-20T22:09:18.2841805Z  from app.services import challenge_service
2026-02-20T22:09:18.2842090Z -from app.utils.db_utils import db_session
2026-02-20T22:09:18.2842450Z  from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.2842907Z  from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:18.2843375Z +from app.utils.db_utils import db_session
2026-02-20T22:09:18.2843913Z  from app.utils.error_handler import ErrorHandler, get_safe_error_message
2026-02-20T22:09:18.2844318Z  from app.utils.translation import parse_accept_language
2026-02-20T22:09:18.2844710Z +from server.auth import optional_auth, require_auth, require_auth_sse
2026-02-20T22:09:18.2845032Z  
2026-02-20T22:09:18.2845167Z  
2026-02-20T22:09:18.2845312Z  @require_auth
2026-02-20T22:09:18.2845476Z @@ -94,7 +96,8 @@
2026-02-20T22:09:18.2845719Z                  exclude_ids=exclude_ids if exclude_ids else None
2026-02-20T22:09:18.2845991Z              )
2026-02-20T22:09:18.2846277Z              # Convertir les objets en dicts avec normalisation age_group pour frontend
2026-02-20T22:09:18.2846773Z -            from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:18.2847201Z +            from app.services.challenge_service import \
2026-02-20T22:09:18.2847499Z +                normalize_age_group_for_frontend
2026-02-20T22:09:18.2847762Z              challenges_list = [
2026-02-20T22:09:18.2847973Z                  {
2026-02-20T22:09:18.2848146Z                      "id": c.id,
2026-02-20T22:09:18.2848349Z @@ -179,10 +182,10 @@
2026-02-20T22:09:18.2848597Z              from app.models.logic_challenge import LogicChallenge
2026-02-20T22:09:18.2849067Z              challenge = db.query(LogicChallenge).filter(LogicChallenge.id == challenge_id).first()
2026-02-20T22:09:18.2849487Z              if challenge:
2026-02-20T22:09:18.2849836Z +                # Normaliser age_group pour le frontend
2026-02-20T22:09:18.2850156Z +                from app.services.challenge_service import \
2026-02-20T22:09:18.2850455Z +                    normalize_age_group_for_frontend
2026-02-20T22:09:18.2850761Z                  from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:18.2851028Z -
2026-02-20T22:09:18.2851219Z -                # Normaliser age_group pour le frontend
2026-02-20T22:09:18.2851616Z -                from app.services.challenge_service import normalize_age_group_for_frontend
2026-02-20T22:09:18.2851996Z                  
2026-02-20T22:09:18.2852174Z                  challenge_dict = {
2026-02-20T22:09:18.2852401Z                      "id": challenge.id,
2026-02-20T22:09:18.2852626Z @@ -860,9 +863,11 @@
2026-02-20T22:09:18.2852885Z          age_group_raw = request.query_params.get('age_group', '10-12')
2026-02-20T22:09:18.2853366Z          prompt_raw = request.query_params.get('prompt', '')
2026-02-20T22:09:18.2853632Z  
2026-02-20T22:09:18.2853945Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:18.2854401Z +        from app.services.challenge_ai_service import \
2026-02-20T22:09:18.2854722Z +            generate_challenge_stream as svc_generate_stream
2026-02-20T22:09:18.2855089Z +        from app.utils.prompt_sanitizer import (sanitize_user_prompt,
2026-02-20T22:09:18.2855445Z +                                                validate_prompt_safety)
2026-02-20T22:09:18.2855804Z          from app.utils.sse_utils import SSE_HEADERS, sse_error_response
2026-02-20T22:09:18.2856310Z -        from app.services.challenge_ai_service import generate_challenge_stream as svc_generate_stream
2026-02-20T22:09:18.2856739Z  
2026-02-20T22:09:18.2856966Z          is_safe, safety_reason = validate_prompt_safety(prompt_raw)
2026-02-20T22:09:18.2857268Z          if not is_safe:
2026-02-20T22:09:18.2857687Z --- /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py:before	2026-02-20 22:09:02.837965
2026-02-20T22:09:18.2858371Z +++ /home/runner/work/mathakine/mathakine/server/handlers/auth_handlers.py:after	2026-02-20 22:09:18.280743
2026-02-20T22:09:18.2858820Z @@ -12,21 +12,19 @@
2026-02-20T22:09:18.2859015Z  from starlette.requests import Request
2026-02-20T22:09:18.2859347Z  from starlette.responses import JSONResponse, RedirectResponse
2026-02-20T22:09:18.2859650Z  
2026-02-20T22:09:18.2859829Z -from app.core.security import decode_token
2026-02-20T22:09:18.2860164Z +from app.core.security import decode_token, get_password_hash
2026-02-20T22:09:18.2860726Z  from app.services.auth_service import (authenticate_user, create_user_token,
2026-02-20T22:09:18.2861139Z                                         get_user_by_email, refresh_access_token)
2026-02-20T22:09:18.2861555Z -from app.utils.rate_limit import rate_limit_auth, rate_limit_resend_verification
2026-02-20T22:09:18.2861979Z +from app.services.email_service import EmailService
2026-02-20T22:09:18.2862370Z +from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.2862754Z  from app.utils.csrf import validate_csrf_token
2026-02-20T22:09:18.2863146Z +from app.utils.db_utils import db_session
2026-02-20T22:09:18.2863593Z +from app.utils.email_verification import (generate_verification_token,
2026-02-20T22:09:18.2863989Z +                                          is_password_reset_token_expired,
2026-02-20T22:09:18.2864311Z +                                          is_verification_token_expired)
2026-02-20T22:09:18.2864637Z +from app.utils.rate_limit import (rate_limit_auth,
2026-02-20T22:09:18.2864944Z +                                  rate_limit_resend_verification)
2026-02-20T22:09:18.2865237Z  from server.auth import require_auth
2026-02-20T22:09:18.2865519Z -from app.services.email_service import EmailService
2026-02-20T22:09:18.2865814Z -from app.utils.db_utils import db_session
2026-02-20T22:09:18.2866166Z -from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.2866662Z -from app.core.security import get_password_hash
2026-02-20T22:09:18.2866962Z -from app.utils.email_verification import (
2026-02-20T22:09:18.2867219Z -    generate_verification_token,
2026-02-20T22:09:18.2867452Z -    is_password_reset_token_expired,
2026-02-20T22:09:18.2867696Z -    is_verification_token_expired,
2026-02-20T22:09:18.2867903Z -)
2026-02-20T22:09:18.2868048Z  
2026-02-20T22:09:18.2868182Z  
2026-02-20T22:09:18.2868365Z  async def api_get_csrf_token(request: Request):
2026-02-20T22:09:18.2868619Z @@ -264,8 +262,8 @@
2026-02-20T22:09:18.2869018Z              logger.info(f"Connexion réussie pour l'utilisateur: {user.username}")
2026-02-20T22:09:18.2869078Z  
2026-02-20T22:09:18.2869357Z              # Créer une entrée UserSession pour /api/users/me/sessions (sessions actives)
2026-02-20T22:09:18.2869464Z +            from app.core.config import settings
2026-02-20T22:09:18.2869589Z              from app.models.user_session import UserSession
2026-02-20T22:09:18.2869692Z -            from app.core.config import settings
2026-02-20T22:09:18.2869831Z              ip = request.client.host if request.client else None
2026-02-20T22:09:18.2869966Z              user_agent = request.headers.get("user-agent") or ""
2026-02-20T22:09:18.2870136Z              device_info = {"user_agent": user_agent[:500]} if user_agent else None
2026-02-20T22:09:18.2870204Z @@ -429,6 +427,7 @@
2026-02-20T22:09:18.2870430Z                  # Essayer de décoder l'access_token pour vérifier s'il est valide
2026-02-20T22:09:18.2870504Z                  try:
2026-02-20T22:09:18.2870579Z                      import jwt
2026-02-20T22:09:18.2870642Z +
2026-02-20T22:09:18.2870751Z                      from app.core.config import settings
2026-02-20T22:09:18.2870837Z                      payload = jwt.decode(
2026-02-20T22:09:18.2870933Z                          access_token_fallback,
2026-02-20T22:09:18.2870997Z @@ -441,7 +440,8 @@
2026-02-20T22:09:18.2871070Z                      if username:
2026-02-20T22:09:18.2871468Z                          logger.info(f"Fallback: Création d'un nouveau refresh_token pour l'utilisateur existant: {username}")
2026-02-20T22:09:18.2875680Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.3052929Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.3293294Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.3431288Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.3451294Z                          async with db_session() as db_fallback:
2026-02-20T22:09:18.3452204Z -                            from app.services.auth_service import get_user_by_username, create_user_token
2026-02-20T22:09:18.3452887Z +                            from app.services.auth_service import (
2026-02-20T22:09:18.3453520Z +                                create_user_token, get_user_by_username)
2026-02-20T22:09:18.3453983Z                              user_fallback = get_user_by_username(db_fallback, username)
2026-02-20T22:09:18.3454404Z                              if user_fallback:
2026-02-20T22:09:18.3454966Z                                  # Créer un nouveau refresh_token pour cet utilisateur
2026-02-20T22:09:18.3455667Z --- /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py:before	2026-02-20 22:09:02.838965
2026-02-20T22:09:18.3456521Z +++ /home/runner/work/mathakine/mathakine/server/handlers/chat_handlers.py:after	2026-02-20 22:09:18.292703
2026-02-20T22:09:18.3457080Z @@ -168,7 +168,8 @@
2026-02-20T22:09:18.3457437Z          conversation_history = data_or_err.get("conversation_history", [])[:20]
2026-02-20T22:09:18.3457855Z  
2026-02-20T22:09:18.3458198Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:18.3458945Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:18.3459556Z +        from app.utils.prompt_sanitizer import (sanitize_user_prompt,
2026-02-20T22:09:18.3459990Z +                                                validate_prompt_safety)
2026-02-20T22:09:18.3460416Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:18.3460798Z          if not is_safe:
2026-02-20T22:09:18.3461050Z              return JSONResponse(
2026-02-20T22:09:18.3461308Z @@ -368,7 +369,8 @@
2026-02-20T22:09:18.3461507Z              )
2026-02-20T22:09:18.3461697Z  
2026-02-20T22:09:18.3462031Z          # Sanitization du message pour éviter l'injection de prompt
2026-02-20T22:09:18.3462603Z -        from app.utils.prompt_sanitizer import sanitize_user_prompt, validate_prompt_safety
2026-02-20T22:09:18.3463313Z +        from app.utils.prompt_sanitizer import (sanitize_user_prompt,
2026-02-20T22:09:18.3463759Z +                                                validate_prompt_safety)
2026-02-20T22:09:18.3464183Z          is_safe, safety_reason = validate_prompt_safety(message_raw)
2026-02-20T22:09:18.3464550Z          if not is_safe:
2026-02-20T22:09:18.3464798Z              async def error_generator():
2026-02-20T22:09:18.3465374Z --- /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py:before	2026-02-20 22:09:02.838965
2026-02-20T22:09:18.3466191Z +++ /home/runner/work/mathakine/mathakine/server/handlers/user_handlers.py:after	2026-02-20 22:09:18.316887
2026-02-20T22:09:18.3466649Z @@ -7,6 +7,7 @@
2026-02-20T22:09:18.3466878Z  from datetime import datetime, timedelta, timezone
2026-02-20T22:09:18.3467152Z  
2026-02-20T22:09:18.3467328Z  from fastapi import HTTPException, status
2026-02-20T22:09:18.3467572Z +
2026-02-20T22:09:18.3467750Z  from app.core.logging_config import get_logger
2026-02-20T22:09:18.3467999Z  
2026-02-20T22:09:18.3468148Z  logger = get_logger(__name__)
2026-02-20T22:09:18.3468357Z @@ -16,12 +17,12 @@
2026-02-20T22:09:18.3468559Z  from app.core.messages import SystemMessages
2026-02-20T22:09:18.3468840Z  from app.schemas.user import UserCreate
2026-02-20T22:09:18.3469171Z  from app.services.auth_service import create_user, get_user_by_email
2026-02-20T22:09:18.3469622Z +from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.3470007Z +from app.utils.csrf import validate_csrf_token
2026-02-20T22:09:18.3470281Z +from app.utils.db_utils import db_session
2026-02-20T22:09:18.3470731Z  from app.utils.error_handler import get_safe_error_message
2026-02-20T22:09:18.3471081Z  from app.utils.rate_limit import rate_limit_register
2026-02-20T22:09:18.3471398Z -from app.utils.csrf import validate_csrf_token
2026-02-20T22:09:18.3471676Z -from app.utils.db_utils import db_session
2026-02-20T22:09:18.3471978Z  from app.utils.settings_reader import get_setting_bool
2026-02-20T22:09:18.3472387Z -from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.3472755Z  from server.auth import require_auth
2026-02-20T22:09:18.3473074Z  
2026-02-20T22:09:18.3473222Z  
2026-02-20T22:09:18.3473358Z @@ -548,7 +549,7 @@
2026-02-20T22:09:18.3473551Z          async with db_session() as db:
2026-02-20T22:09:18.3473813Z              from app.models.attempt import Attempt
2026-02-20T22:09:18.3474106Z              from app.models.exercise import Exercise
2026-02-20T22:09:18.3474358Z -            
2026-02-20T22:09:18.3474513Z +
2026-02-20T22:09:18.3474822Z              # Récupérer toutes les tentatives avec jointure sur exercises
2026-02-20T22:09:18.3475189Z              attempts_query = db.query(Attempt, Exercise).join(
2026-02-20T22:09:18.3475532Z                  Exercise, Attempt.exercise_id == Exercise.id
2026-02-20T22:09:18.3475799Z @@ -670,8 +671,9 @@
2026-02-20T22:09:18.3476211Z          logger.info(f"Récupération de la progression des défis pour l'utilisateur {user_id}")
2026-02-20T22:09:18.3476595Z          
2026-02-20T22:09:18.3476885Z          async with db_session() as db:
2026-02-20T22:09:18.3477271Z -            from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:18.3477645Z -            
2026-02-20T22:09:18.3477882Z +            from app.models.logic_challenge import (LogicChallenge,
2026-02-20T22:09:18.3478229Z +                                                    LogicChallengeAttempt)
2026-02-20T22:09:18.3478499Z +
2026-02-20T22:09:18.3478747Z              # Nombre total de défis actifs dans le système
2026-02-20T22:09:18.3479080Z              total_challenges = db.query(LogicChallenge).filter(
2026-02-20T22:09:18.3479394Z                  LogicChallenge.is_active == True,
2026-02-20T22:09:18.3479636Z @@ -970,8 +972,8 @@
2026-02-20T22:09:18.3479806Z      if csrf_err:
2026-02-20T22:09:18.3479975Z          return csrf_err
2026-02-20T22:09:18.3480161Z      try:
2026-02-20T22:09:18.3480407Z +        from app.core.security import get_password_hash, verify_password
2026-02-20T22:09:18.3480755Z          from app.models.user import User
2026-02-20T22:09:18.3481078Z -        from app.core.security import verify_password, get_password_hash
2026-02-20T22:09:18.3481384Z          
2026-02-20T22:09:18.3481557Z          current_user = request.state.user
2026-02-20T22:09:18.3481779Z          
2026-02-20T22:09:18.3481930Z @@ -1117,13 +1119,14 @@
2026-02-20T22:09:18.3482323Z      Retourne un JSON avec : profil, exercices tentés, défis tentés, badges, progression.
2026-02-20T22:09:18.3482698Z      """
2026-02-20T22:09:18.3482845Z      try:
2026-02-20T22:09:18.3483135Z -        from app.models.user import User
2026-02-20T22:09:18.3483433Z +        from app.models.achievement import UserAchievement
2026-02-20T22:09:18.3483743Z          from app.models.attempt import Attempt
2026-02-20T22:09:18.3484025Z          from app.models.exercise import Exercise
2026-02-20T22:09:18.3484411Z -        from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:18.3484865Z -        from app.models.achievement import UserAchievement
2026-02-20T22:09:18.3485216Z +        from app.models.logic_challenge import (LogicChallenge,
2026-02-20T22:09:18.3485558Z +                                                LogicChallengeAttempt)
2026-02-20T22:09:18.3485871Z          from app.models.progress import Progress
2026-02-20T22:09:18.3486190Z          from app.models.recommendation import Recommendation
2026-02-20T22:09:18.3486496Z +        from app.models.user import User
2026-02-20T22:09:18.3486716Z          
2026-02-20T22:09:18.3487020Z          current_user = request.state.user
2026-02-20T22:09:18.3487248Z          
2026-02-20T22:09:18.3487398Z @@ -1263,9 +1266,10 @@
2026-02-20T22:09:18.3487565Z          
2026-02-20T22:09:18.3487774Z          # Récupérer la session DB
2026-02-20T22:09:18.3488000Z          async with db_session() as db:
2026-02-20T22:09:18.3488243Z +            from sqlalchemy import and_
2026-02-20T22:09:18.3488464Z +
2026-02-20T22:09:18.3488663Z              from app.models.user_session import UserSession
2026-02-20T22:09:18.3488955Z -            from sqlalchemy import and_
2026-02-20T22:09:18.3489175Z -            
2026-02-20T22:09:18.3489329Z +
2026-02-20T22:09:18.3489584Z              # Récupérer toutes les sessions actives non expirées
2026-02-20T22:09:18.3489906Z              sessions = db.query(UserSession).filter(
2026-02-20T22:09:18.3490153Z                  and_(
2026-02-20T22:09:18.3490326Z @@ -1318,7 +1322,7 @@
2026-02-20T22:09:18.3490542Z          # Récupérer la session DB
2026-02-20T22:09:18.3490770Z          async with db_session() as db:
2026-02-20T22:09:18.3491044Z              from app.models.user_session import UserSession
2026-02-20T22:09:18.3491305Z -            
2026-02-20T22:09:18.3491456Z +
2026-02-20T22:09:18.3491638Z              # Récupérer la session
2026-02-20T22:09:18.3491886Z              session = db.query(UserSession).filter(
2026-02-20T22:09:18.3492158Z                  UserSession.id == session_id,
2026-02-20T22:09:18.3492760Z --- /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py:before	2026-02-20 22:09:02.837965
2026-02-20T22:09:18.3493721Z +++ /home/runner/work/mathakine/mathakine/server/handlers/admin_handlers.py:after	2026-02-20 22:09:18.338760
2026-02-20T22:09:18.3494167Z @@ -9,26 +9,22 @@
2026-02-20T22:09:18.3494326Z  
2026-02-20T22:09:18.3494479Z  from sqlalchemy import case, func
2026-02-20T22:09:18.3494719Z  from sqlalchemy.orm import Session
2026-02-20T22:09:18.3494925Z -
2026-02-20T22:09:18.3495095Z  from starlette.requests import Request
2026-02-20T22:09:18.3495430Z  from starlette.responses import JSONResponse, StreamingResponse
2026-02-20T22:09:18.3495739Z  
2026-02-20T22:09:18.3495965Z +from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:18.3496327Z  from app.models.admin_audit_log import AdminAuditLog
2026-02-20T22:09:18.3496688Z -from app.models.achievement import Achievement, UserAchievement
2026-02-20T22:09:18.3497015Z  from app.models.attempt import Attempt
2026-02-20T22:09:18.3497284Z +from app.models.exercise import Exercise
2026-02-20T22:09:18.3497609Z +from app.models.logic_challenge import (AgeGroup, LogicChallenge,
2026-02-20T22:09:18.3497966Z +                                        LogicChallengeAttempt,
2026-02-20T22:09:18.3498256Z +                                        LogicChallengeType)
2026-02-20T22:09:18.3498533Z  from app.models.setting import Setting
2026-02-20T22:09:18.3498791Z -from app.models.exercise import Exercise
2026-02-20T22:09:18.3499054Z -from app.models.logic_challenge import (
2026-02-20T22:09:18.3499295Z -    AgeGroup,
2026-02-20T22:09:18.3499460Z -    LogicChallenge,
2026-02-20T22:09:18.3499657Z -    LogicChallengeAttempt,
2026-02-20T22:09:18.3499866Z -    LogicChallengeType,
2026-02-20T22:09:18.3500056Z -)
2026-02-20T22:09:18.3500233Z  from app.models.user import User, UserRole
2026-02-20T22:09:18.3500534Z  from app.services.email_service import EmailService
2026-02-20T22:09:18.3500835Z  from app.utils.db_utils import db_session
2026-02-20T22:09:18.3501175Z  from app.utils.email_verification import generate_verification_token
2026-02-20T22:09:18.3501552Z -from server.auth import require_auth, require_admin
2026-02-20T22:09:18.3501860Z +from server.auth import require_admin, require_auth
2026-02-20T22:09:18.3502116Z  
2026-02-20T22:09:18.3502247Z  
2026-02-20T22:09:18.3502401Z  def _log_admin_action(
2026-02-20T22:09:18.3502855Z --- /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py:before	2026-02-20 22:09:02.838965
2026-02-20T22:09:18.3503887Z +++ /home/runner/work/mathakine/mathakine/server/handlers/recommendation_handlers.py:after	2026-02-20 22:09:18.344785
2026-02-20T22:09:18.3504383Z @@ -72,7 +72,8 @@
2026-02-20T22:09:18.3504594Z                      rec_data["exercise_id"] = rec.exercise_id
2026-02-20T22:09:18.3505044Z                      # Optionnel: récupérer le titre et la question de l'exercice
2026-02-20T22:09:18.3505360Z                      try:
2026-02-20T22:09:18.3505645Z -                        from app.services.exercise_service import ExerciseService
2026-02-20T22:09:18.3506033Z +                        from app.services.exercise_service import \
2026-02-20T22:09:18.3506336Z +                            ExerciseService
2026-02-20T22:09:18.3506666Z                          exercise = ExerciseService.get_exercise(db, rec.exercise_id)
2026-02-20T22:09:18.3506996Z                          if exercise:
2026-02-20T22:09:18.3507269Z                              rec_data["exercise_title"] = exercise.title
2026-02-20T22:09:18.3507554Z @@ -84,7 +85,8 @@
2026-02-20T22:09:18.3507758Z                  if getattr(rec, "challenge_id", None):
2026-02-20T22:09:18.3508053Z                      rec_data["challenge_id"] = rec.challenge_id
2026-02-20T22:09:18.3508322Z                      try:
2026-02-20T22:09:18.3599390Z ERROR: /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py Imports are incorrectly sorted and/or formatted.
2026-02-20T22:09:18.3760115Z -                        from app.services.logic_challenge_service import LogicChallengeService
2026-02-20T22:09:18.3761426Z +                        from app.services.logic_challenge_service import \
2026-02-20T22:09:18.3761943Z +                            LogicChallengeService
2026-02-20T22:09:18.3762525Z                          challenge = LogicChallengeService.get_challenge(db, rec.challenge_id)
2026-02-20T22:09:18.3763406Z                          if challenge:
2026-02-20T22:09:18.3763899Z                              rec_data["challenge_title"] = getattr(challenge, "title", None)
2026-02-20T22:09:18.3764800Z --- /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py:before	2026-02-20 22:09:02.838965
2026-02-20T22:09:18.3765809Z +++ /home/runner/work/mathakine/mathakine/server/handlers/exercise_handlers.py:after	2026-02-20 22:09:18.374412
2026-02-20T22:09:18.3766384Z @@ -11,16 +11,16 @@
2026-02-20T22:09:18.3766707Z  from starlette.responses import (JSONResponse, RedirectResponse,
2026-02-20T22:09:18.3767126Z                                   StreamingResponse)
2026-02-20T22:09:18.3767426Z  
2026-02-20T22:09:18.3767628Z +from app.core.ai_config import AIConfig
2026-02-20T22:09:18.3767941Z  from app.core.config import settings
2026-02-20T22:09:18.3768243Z -from app.core.ai_config import AIConfig
2026-02-20T22:09:18.3768574Z  from app.core.messages import SystemMessages
2026-02-20T22:09:18.3768920Z  from app.models.exercise import ExerciseType
2026-02-20T22:09:18.3769234Z  # Import du service de badges
2026-02-20T22:09:18.3769546Z  from app.services.badge_service import BadgeService
2026-02-20T22:09:18.3770015Z +from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.3770462Z  from app.utils.db_utils import db_session
2026-02-20T22:09:18.3770882Z -from app.services.enhanced_server_adapter import EnhancedServerAdapter
2026-02-20T22:09:18.3771438Z  from app.utils.error_handler import ErrorHandler, get_safe_error_message
2026-02-20T22:09:18.3771970Z -from server.auth import require_auth, optional_auth, require_auth_sse
2026-02-20T22:09:18.3772498Z +from server.auth import optional_auth, require_auth, require_auth_sse
2026-02-20T22:09:18.3773089Z  from server.exercise_generator import (ensure_explanation,
2026-02-20T22:09:18.3773488Z                                         generate_ai_exercise,
2026-02-20T22:09:18.3773842Z                                         generate_simple_exercise)
2026-02-20T22:09:18.3774154Z @@ -106,9 +106,10 @@
2026-02-20T22:09:18.3774358Z          
2026-02-20T22:09:18.3774572Z          # Utiliser le service ORM ExerciseService
2026-02-20T22:09:18.3775046Z          async with db_session() as db:
2026-02-20T22:09:18.3775354Z +            from sqlalchemy import String, cast
2026-02-20T22:09:18.3775648Z +
2026-02-20T22:09:18.3775879Z              from app.models.exercise import Exercise
2026-02-20T22:09:18.3776257Z              from app.utils.json_utils import safe_parse_json
2026-02-20T22:09:18.3776605Z -            from sqlalchemy import String, cast
2026-02-20T22:09:18.3776840Z  
2026-02-20T22:09:18.3777328Z              # IMPORTANT: Charger les enums en tant que strings pour éviter les erreurs de conversion
2026-02-20T22:09:18.3777998Z              # SQLAlchemy essaie de convertir automatiquement et échoue si la DB contient des minuscules
2026-02-20T22:09:18.3778428Z @@ -935,10 +936,12 @@
2026-02-20T22:09:18.3778652Z      logger.info("=== DEBUT get_exercises_stats ===")
2026-02-20T22:09:18.3778949Z      try:
2026-02-20T22:09:18.3779139Z          logger.debug("Import des modules...")
2026-02-20T22:09:18.3779414Z -        from sqlalchemy import func, case
2026-02-20T22:09:18.3779776Z -        from app.models.exercise import Exercise, ExerciseType, DifficultyLevel
2026-02-20T22:09:18.3780141Z +        from sqlalchemy import case, func
2026-02-20T22:09:18.3780365Z +
2026-02-20T22:09:18.3780545Z          from app.models.attempt import Attempt
2026-02-20T22:09:18.3780925Z -        from app.models.logic_challenge import LogicChallenge, LogicChallengeAttempt
2026-02-20T22:09:18.3781532Z +        from app.models.exercise import DifficultyLevel, Exercise, ExerciseType
2026-02-20T22:09:18.3781961Z +        from app.models.logic_challenge import (LogicChallenge,
2026-02-20T22:09:18.3782313Z +                                                LogicChallengeAttempt)
2026-02-20T22:09:18.3782603Z          logger.debug("Imports OK")
2026-02-20T22:09:18.3782821Z          
2026-02-20T22:09:18.3783088Z          async with db_session() as db:
2026-02-20T22:09:18.3901060Z ##[error]Process completed with exit code 1.
2026-02-20T22:09:18.3983334Z Post job cleanup.
2026-02-20T22:09:18.5218334Z Post job cleanup.
2026-02-20T22:09:18.6027156Z [command]/usr/bin/git version
2026-02-20T22:09:18.6065567Z git version 2.52.0
2026-02-20T22:09:18.6136862Z Temporarily overriding HOME='/home/runner/work/_temp/48a51b96-ee0f-4ae6-b711-9fba29dee483' before making global git config changes
2026-02-20T22:09:18.6138225Z Adding repository directory to the temporary git global config as a safe directory
2026-02-20T22:09:18.6142516Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/mathakine/mathakine
2026-02-20T22:09:18.6173311Z Removing SSH command configuration
2026-02-20T22:09:18.6179843Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2026-02-20T22:09:18.6213349Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2026-02-20T22:09:18.6442502Z Removing HTTP extra header
2026-02-20T22:09:18.6447206Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2026-02-20T22:09:18.6478687Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2026-02-20T22:09:18.6698335Z Removing includeIf entries pointing to credentials config files
2026-02-20T22:09:18.6704548Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2026-02-20T22:09:18.6726669Z includeif.gitdir:/home/runner/work/mathakine/mathakine/.git.path
2026-02-20T22:09:18.6727711Z includeif.gitdir:/home/runner/work/mathakine/mathakine/.git/worktrees/*.path
2026-02-20T22:09:18.6728482Z includeif.gitdir:/github/workspace/.git.path
2026-02-20T22:09:18.6729111Z includeif.gitdir:/github/workspace/.git/worktrees/*.path
2026-02-20T22:09:18.6737226Z [command]/usr/bin/git config --local --get-all includeif.gitdir:/home/runner/work/mathakine/mathakine/.git.path
2026-02-20T22:09:18.6758560Z /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6769061Z [command]/usr/bin/git config --local --unset includeif.gitdir:/home/runner/work/mathakine/mathakine/.git.path /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6802162Z [command]/usr/bin/git config --local --get-all includeif.gitdir:/home/runner/work/mathakine/mathakine/.git/worktrees/*.path
2026-02-20T22:09:18.6823572Z /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6832539Z [command]/usr/bin/git config --local --unset includeif.gitdir:/home/runner/work/mathakine/mathakine/.git/worktrees/*.path /home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6864548Z [command]/usr/bin/git config --local --get-all includeif.gitdir:/github/workspace/.git.path
2026-02-20T22:09:18.6884791Z /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6893259Z [command]/usr/bin/git config --local --unset includeif.gitdir:/github/workspace/.git.path /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6927352Z [command]/usr/bin/git config --local --get-all includeif.gitdir:/github/workspace/.git/worktrees/*.path
2026-02-20T22:09:18.6952415Z /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6964961Z [command]/usr/bin/git config --local --unset includeif.gitdir:/github/workspace/.git/worktrees/*.path /github/runner_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config
2026-02-20T22:09:18.6998966Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2026-02-20T22:09:18.7226666Z Removing credentials config '/home/runner/work/_temp/git-credentials-80bda56a-4d93-4286-b5bb-0b28af6f56f9.config'
2026-02-20T22:09:18.7351171Z Cleaning up orphan processes
