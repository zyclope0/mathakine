{% extends "base.html" %}

{% block title %}Exercices - Mathakine{% endblock %}

{% block head %}
<style>
    .exercise-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .exercise-card {
        border-radius: 10px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .exercise-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    
    .exercise-card .difficulty {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-bottom: 10px;
    }
    
    .difficulty.initie { background-color: #d4edda; color: #155724; }
    .difficulty.padawan { background-color: #fff3cd; color: #856404; }
    .difficulty.chevalier { background-color: #f8d7da; color: #721c24; }
    .difficulty.maitre { background-color: #cce5ff; color: #004085; }
    
    .exercise-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--sw-accent);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Exercices Mathématiques</h2>
    <p>Testez vos compétences avec ces défis mathématiques intergalactiques</p>
</div>

<div class="filters-section card">
    <div class="filter-row">
        <div class="filter-group">
            <label for="type-filter">Type d'exercice:</label>
            <select id="type-filter" class="filter-select">
                <option value="all">Tous les types</option>
                <option value="addition">Addition</option>
                <option value="soustraction">Soustraction</option>
                <option value="multiplication">Multiplication</option>
                <option value="division">Division</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="difficulty-filter">Niveau de difficulté:</label>
            <select id="difficulty-filter" class="filter-select">
                <option value="all">Tous les niveaux</option>
                <option value="initie">Initié</option>
                <option value="padawan">Padawan</option>
                <option value="chevalier">Chevalier</option>
                <option value="maitre">Maître</option>
            </select>
        </div>
        
        <button id="generate-exercise" class="btn primary-btn">
            <i class="fas fa-plus-circle"></i> Générer un nouvel exercice
        </button>
    </div>
</div>

<div id="exercise-container">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chargement des exercices
    document.addEventListener('DOMContentLoaded', function() {
        const exerciseContainer = document.getElementById('exercise-container');
        const typeFilter = document.getElementById('type-filter');
        const difficultyFilter = document.getElementById('difficulty-filter');
        const generateButton = document.getElementById('generate-exercise');
        
        // Charger les exercices
        loadExercises();
        
        // Écouteurs d'événements
        typeFilter.addEventListener('change', loadExercises);
        difficultyFilter.addEventListener('change', loadExercises);
        generateButton.addEventListener('click', generateNewExercise);
        
        // Fonction pour charger les exercices
        function loadExercises() {
            // Afficher le spinner
            exerciseContainer.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';
            
            // Récupérer les valeurs des filtres
            const typeValue = typeFilter.value;
            const difficultyValue = difficultyFilter.value;
            
            // Construire l'URL avec les filtres
            let url = '/api/v1/exercises';
            const params = [];
            
            if (typeValue !== 'all') {
                params.push(`type=${typeValue}`);
            }
            
            if (difficultyValue !== 'all') {
                params.push(`difficulty=${difficultyValue}`);
            }
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // Récupérer les exercices
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.exercises && data.exercises.length > 0) {
                        renderExercises(data.exercises);
                    } else {
                        exerciseContainer.innerHTML = `
                            <div class="card">
                                <h3>Aucun exercice trouvé</h3>
                                <p>Aucun exercice ne correspond à vos critères de recherche. Essayez de modifier vos filtres ou générez un nouvel exercice.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des exercices:', error);
                    exerciseContainer.innerHTML = `
                        <div class="card error-card">
                            <h3>Erreur de chargement</h3>
                            <p>Une erreur s'est produite lors du chargement des exercices. Veuillez réessayer plus tard.</p>
                        </div>
                    `;
                });
        }
        
        // Fonction pour afficher les exercices
        function renderExercises(exercises) {
            const html = `
                <div class="exercise-list">
                    ${exercises.map(exercise => `
                        <div class="card exercise-card" data-id="${exercise.id}">
                            <span class="difficulty ${exercise.difficulty.toLowerCase()}">${exercise.difficulty}</span>
                            <h3>${exercise.title}</h3>
                            <p class="exercise-type">${getExerciseTypeLabel(exercise.exercise_type)}</p>
                            <div class="exercise-actions">
                                <button class="btn start-exercise" data-id="${exercise.id}">
                                    <i class="fas fa-play"></i> Commencer
                                </button>
                                <button class="btn btn-secondary view-details" data-id="${exercise.id}">
                                    <i class="fas fa-info-circle"></i> Détails
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            exerciseContainer.innerHTML = html;
            
            // Ajouter les écouteurs d'événements pour les boutons
            document.querySelectorAll('.start-exercise').forEach(button => {
                button.addEventListener('click', function() {
                    const exerciseId = this.getAttribute('data-id');
                    startExercise(exerciseId);
                });
            });
            
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const exerciseId = this.getAttribute('data-id');
                    viewExerciseDetails(exerciseId);
                });
            });
        }
        
        // Fonction pour générer un nouvel exercice
        function generateNewExercise() {
            // Redirection vers l'API de génération d'exercice
            window.location.href = '/api/v1/exercises/generate';
        }
        
        // Fonction pour commencer un exercice
        function startExercise(exerciseId) {
            // Redirection vers la page de l'exercice
            window.location.href = `/exercise/${exerciseId}`;
        }
        
        // Fonction pour voir les détails d'un exercice
        function viewExerciseDetails(exerciseId) {
            // Implémentation à venir
            alert(`Détails de l'exercice ${exerciseId}`);
        }
        
        // Fonction utilitaire pour obtenir le libellé du type d'exercice
        function getExerciseTypeLabel(type) {
            const types = {
                'addition': 'Addition',
                'subtraction': 'Soustraction',
                'multiplication': 'Multiplication',
                'division': 'Division',
                'fractions': 'Fractions',
                'equations': 'Équations',
                'geometry': 'Géométrie'
            };
            
            return types[type] || type;
        }
    });
</script>
{% endblock %}
        
        